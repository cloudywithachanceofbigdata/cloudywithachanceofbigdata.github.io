<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Full Stack Chronicles | Full Stack Chronicles</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://fullstackchronicles.io/img/fullstackchronicles-cover-image.png"><meta data-rh="true" name="twitter:image" content="https://fullstackchronicles.io/img/fullstackchronicles-cover-image.png"><meta data-rh="true" property="og:url" content="https://fullstackchronicles.io/page/4"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="robots" content="index,follow"><meta data-rh="true" name="twitter:site" content="@fschronicles1"><meta data-rh="true" name="twitter:creator" content="@fschronicles1"><meta data-rh="true" name="og:type" content="website"><meta data-rh="true" name="og:locale" content="en_US"><meta data-rh="true" name="og:site_name" content="Full Stack Chronicles"><meta data-rh="true" name="msapplication-TileColor" content="#2d89ef"><meta data-rh="true" name="theme-color" content="#ffffff"><meta data-rh="true" property="og:title" content="Full Stack Chronicles | Full Stack Chronicles"><meta data-rh="true" name="description" content="Full stack design patterns and random musings"><meta data-rh="true" property="og:description" content="Full stack design patterns and random musings"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://fullstackchronicles.io/page/4"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/page/4" hreflang="en"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/page/4" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://MZCGVO503N-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Full Stack Chronicles Blog Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Full Stack Chronicles Blog Feed Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Full Stack Chronicles Blog Feed JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0FVDC1E8G6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0FVDC1E8G6",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Full Stack Chronicles" href="/opensearch.xml">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0f4c81"><link rel="stylesheet" href="/assets/css/styles.308152d6.css">
<link rel="preload" href="/assets/js/runtime~main.f5afdae2.js" as="script">
<link rel="preload" href="/assets/js/main.e830d5cb.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#A9BCD0;color:#1A4E82" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><b>If you find our content useful, follow us on <a target="_blank" rel="noopener noreferrer" href="https://github.com/stackql">GitHub</a>, if you have some content to share, reach out</b></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Full Stack Chronicles</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/tags">Topics</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/snowflake">Snowflake</a></li><li><a class="dropdown__link" href="/tags/okta">Okta</a></li><li><a class="dropdown__link" href="/tags/openapi">OpenAPI</a></li><li><a class="dropdown__link" href="/tags/spark">Spark</a></li><li><a class="dropdown__link" href="/tags/kafka">Kafka</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/netlify-logging-to-sumologic-without-log-drains">Netlify logging to SumoLogic Without Log Drains</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/enhancing-dbt-snapshots-with-operational-metadata">Enhancing dbt Snapshots with Operational Metadata</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/json-ld-structured-data-for-docusaurus">Yoast (like) JSON-LD Structured Data for Docusaurus</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/gitver-an-alternative-versioning-scheme-to-semver-or-calver">Introducing GitVer - an alternative versioning scheme</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/use-deno-deploy-to-serve-non-traditional-artifacts">Use Deno Deploy to Serve Non-Traditional Artifacts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/apache-beam-in-five-minutes">Apache Beam in Five Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/aws-iam-vs-google-iam">AWS IAM vs Google IAM</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/create-and-use-custom-magic-commands-in-jupyter">Create and use Custom Magic Commands in Jupyter</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/deno-in-five-minutes">Deno in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/dbt-in-five-minutes">DBT in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/loading-parquet-files-into-snowflake">Loading Parquet Files into Snowflake</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/analyze-developer-activity-with-stackql-jupyter-bigquery">Analyze Developer Activity with StackQL, Jupyter and BigQuery</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/converting-google-discovery-docs-to-openapi3-specs">Converting Google Discovery Docs to OpenAPI3 Specs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/recurse-javascript-object-to-get-values-for-a-given-key-the-easy-way">Recurse JavaScript Object to Get Values for a Given Key the Easy Way</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/dataops-with-container-images-and-multi-stage-builds">DataOps with Container Images and Multi-Stage Builds</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/snowflake-sql-api-featured-image.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/using-the-snowflake-sql-api-with-typescript">Using the Snowflake SQL API with TypeScript</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-05-19T00:00:00.000Z" itemprop="datePublished">May 19, 2022</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/yuncheng-fabio-yang/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://en.gravatar.com/userimage/195643035/72fc562ee87d0c67847c8989d2808129.jpg?size=80" alt="Yuncheng Yang"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/yuncheng-fabio-yang/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Yuncheng Yang</span></a></div><small class="avatar__subtitle" itemprop="description">Full Stack Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This article demonstrates how to use the Snowflake REST API to retrieve data for a web application using TypeScript, in this case we are using keypair authentication with Snowflake.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2><p>Snowflake’s SQL API allows you to access snowflake objects using SQL via a REST API request, this allows for easy integration with your applications and deployment pipelines. You can use the API to execute most DDL and DML statements.  </p><p>There are some limitations you need to be aware of however, for example interactions with stages (using PUT and GET aren’t supported via the Snowflake API) or stored procedure operations (using CALL), you can read more on this <a href="https://docs.snowflake.com/en/developer-guide/sql-api/intro.html#limitations-of-the-sql-api" target="_blank" rel="noopener noreferrer">here</a>.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="endpoints">Endpoints<a href="#endpoints" class="hash-link" aria-label="Direct link to Endpoints" title="Direct link to Endpoints">​</a></h2><p>There are three endpoints provided:  </p><ul><li><code>/api/v2/statements/</code></li><li><code>/api/v2/statement/&lt;statementHandle&gt;</code></li><li><code>/api/v2/statements/&lt;statementHandle/cancel</code></li></ul><p>We will be looking at the first two in this article.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="authentication-methods">Authentication Methods<a href="#authentication-methods" class="hash-link" aria-label="Direct link to Authentication Methods" title="Direct link to Authentication Methods">​</a></h2><p>There are two types of Authentication methods for the API, <strong>OAuth</strong> and <strong>Key Pair</strong>. For OAuth method, you can choose to use <code>X-Snowflake-Authorization-Token-Type</code> header, if this header is not present, Snowflake assumes that the token in the <code>Authorization</code> header is an OAuth token. For Key Pair method, the JWT token will be in the <code>Authorization</code> header as <code>Bearer &lt;your token&gt;</code>.  </p><p>Let’s walk through how to generate and use the JWT.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="generating-the-jwt">Generating the JWT<a href="#generating-the-jwt" class="hash-link" aria-label="Direct link to Generating the JWT" title="Direct link to Generating the JWT">​</a></h2><p>Here&#x27;s whats needed:  </p><p><a target="_blank" href="/assets/files/snowflake-jwt-d8c78351e349e02c9d6b86cbacc7fac1.png"><img loading="lazy" alt="Snowflake JWT" src="/assets/images/snowflake-jwt-d8c78351e349e02c9d6b86cbacc7fac1.png" width="2730" height="1442" class="img_ev3q"></a></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="the-code">the Code<a href="#the-code" class="hash-link" aria-label="Direct link to the Code" title="Direct link to the Code">​</a></h3><iframe width="100%" frameborder="0" id="gist-6fbe63cace2ad993ac06b324954b7daa"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="request-body">Request Body<a href="#request-body" class="hash-link" aria-label="Direct link to Request Body" title="Direct link to Request Body">​</a></h2><p>Now we need a request body:  </p><iframe width="100%" frameborder="0" id="gist-ae0ebbedf51f232e7147e72f11007b68"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="submitting-the-request">Submitting the Request<a href="#submitting-the-request" class="hash-link" aria-label="Direct link to Submitting the Request" title="Direct link to Submitting the Request">​</a></h2><p>We will need to include the <strong>region</strong> and <strong>account identifier</strong>, for instance if your account identifier includes a region (e.g. xy12345.us-east2.aws.snowflakecomputing.com).  </p><iframe width="100%" frameborder="0" id="gist-535123dda1536b5a48c6213470e83d6f"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="response-handling">Response Handling<a href="#response-handling" class="hash-link" aria-label="Direct link to Response Handling" title="Direct link to Response Handling">​</a></h2><p>When making a <code>SELECT</code> query, there are three things worth noting:  </p><ol><li><code>rowType</code> fields in the <code>resultSetMetaData</code> represent the columns</li><li>data without column names is in the format of <code>string[][]</code></li><li><code>partitionInfo</code> is an array of object representing different partitions</li></ol><p>For more information see <a href="https://docs.snowflake.com/en/developer-guide/sql-api/handling-responses.html" target="_blank" rel="noopener noreferrer">Handling Responses from the SQL API - Snowflake Documentation</a>.  </p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="parsing-data">Parsing data<a href="#parsing-data" class="hash-link" aria-label="Direct link to Parsing data" title="Direct link to Parsing data">​</a></h3><p>Here is a Typescript code snippet demonstrating parsing return data:  </p><iframe width="100%" frameborder="0" id="gist-d397621879b063ea0761233984aafe69"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="handling-multiple-partitions">Handling multiple partitions<a href="#handling-multiple-partitions" class="hash-link" aria-label="Direct link to Handling multiple partitions" title="Direct link to Handling multiple partitions">​</a></h3><p>Large result sets are paginated into <em>partitions</em>, each partition is a set of rows.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Note that the pages (referred to as partitions) are <strong>NOT</strong> based on row count, instead they are based on the compressed batch size, so they will not be uniform in terms of the number of rows.</p></div></div><p>To get a partition, send a <code>GET</code> request with Url <code>https://&lt;accountIdentifier&gt;.snowflakecomputing.com/api/v2/statements/?partition=&lt;partitionId&gt;</code>.  </p><iframe width="100%" frameborder="0" id="gist-7f2b0443a9ca5e8284b987a9e84ca301"></iframe><p>Thanks!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/snowflake">snowflake</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/sql">sql</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/typescript">typescript</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/react">react</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/jamstack">jamstack</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/split-up-large-openapi-docs.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/split-a-large-swagger-openapi-specification-into-smaller-documents">Split a large Open API or Swagger Specification into smaller documents</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-05-02T00:00:00.000Z" itemprop="datePublished">May 2, 2022</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Open API specifications can get quite large, especially for providers with upwards of 500 routes or operations.  </p><p>The challenge is to create standalone documents scoped by a service or path within the parent API specification and include only the components (schemas, responses, etc.) that pertain to operations included in the child document.  </p><p>When I went looking for library or utility to do this, I couldn’t find one... so I have developed one myself.  </p><p>It&#x27;s a simple command (nodejs based but can be run in a bash terminal or from the Windows command line) which requires a few options, including:  </p><ul><li>the <strong><em>provider name</em></strong> (e.g. <code>github</code>)</li><li>a <strong><em>provider version</em></strong> which is a version you set - allowing you to make minor modifications to the output documents (e.g. <code>v0.1.0</code>)</li><li>a <strong><em>service discriminator</em></strong> which is a JSONPath expression to identify a service name within each route in the parent file, this is used to assign operations to services in separate documents (e.g. <code>&#x27;$[&quot;x-github&quot;].category&#x27;</code>)</li><li>an <strong><em>output directory</em></strong> (e.g. <code>./dev</code>)</li></ul><p>and of course, the <strong><em>openapi spec document</em></strong> you are splitting up.</p><p>an example is shown here:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openapi-doc-util split \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-n github \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-v v0.1.0 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-s &#x27;$[&quot;x-github&quot;].category&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-o ./dev \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ref/github/api.github.com.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Help for the command is available using <code>openapi-doc-util split</code>.  </p><p>The net result is 59 self-contained, service scoped documents, containing only the components referenced by routes in the service document.</p><p>You can access this utility via <a href="https://www.npmjs.com/package/@stackql/openapi-doc-util" target="_blank" rel="noopener noreferrer"><strong>NPMJS</strong></a> or via <a href="https://github.com/stackql/openapi-doc-util" target="_blank" rel="noopener noreferrer"><strong>GitHub</strong></a>.  </p><p>Splitting up a large open API spec document, is the first stage in developing a <a href="https://github.com/stackql/stackql" target="_blank" rel="noopener noreferrer"><strong>StackQL</strong></a> provider which we will discuss next time!</p><blockquote><p>if you have enjoyed this post, please consider <a href="https://www.buymeacoffee.com/jeffreyaven" target="_blank" rel="noopener noreferrer"><strong>buying me a coffee ☕</strong></a> to help me keep writing!</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/openapi">openapi</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/swagger">swagger</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/api">api</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/stackql">stackql</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/kafka-spark-snowflake.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/stream-processing-with-spark-structured-streaming-kafka-and-snowflake-using-python">Stream Processing with Spark Structured Streaming, Kafka and Snowflake using Python</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-04-28T00:00:00.000Z" itemprop="datePublished">April 28, 2022</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Structured Streaming in Spark provides a powerful framework for stream processing an analysis, such as streaming transformations, stateful streaming or sliding window operations.  </p><p>Kafka is a common streaming source and sink for Spark Streaming and Structured Streaming operations.  However, there may be situations where a data warehouse (such as Snowflake) is a more appropriate target for streaming operations, especially where there is a reporting or long-term storage requirement on the data derived from the streaming source.  </p><p>This article will demonstrate just how easy this is to implement using Python.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="design">Design<a href="#design" class="hash-link" aria-label="Direct link to Design" title="Direct link to Design">​</a></h2><p>The following diagram illustrates the ingestion design for this example:  </p><p><a target="_blank" href="/assets/files/spark-streaming-kafka-snowflake-5b6babb75a8da1443183fabc68c704a1.png"><img loading="lazy" alt="Spark Structured Streaming using Kafka and Snowflake" src="/assets/images/spark-streaming-kafka-snowflake-5b6babb75a8da1443183fabc68c704a1.png" width="948" height="390" class="img_ev3q"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="snowflake-setup">Snowflake Setup<a href="#snowflake-setup" class="hash-link" aria-label="Direct link to Snowflake Setup" title="Direct link to Snowflake Setup">​</a></h2><p>Some prerequisites for Snowflake:  </p><ol><li>You will need to create a user (or use an existing user), in either case the user will need to be identified by a private key.  You will need to generate a key pair as follows:  </li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">openssl genrsa </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> openssl pkcs8 -topk8 -inform PEM -out rsa_key.p8 -nocrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openssl rsa -in rsa_key.p8 -pubout -out rsa_key.pub</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>copy the contents of the <code>rsa_key.pub</code> file, remove the <code>-----BEGIN PUBLIC KEY-----</code> and <code>-----END PUBLIC KEY-----</code> strings, then remove the line breaks to form one string, use this string as the <code>RSA_PUBLIC_KEY</code> in a <code>CREATE USER</code> or <code>ALTER USER</code> statement in Snowflake, like:  </p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">USER</span><span class="token plain"> youruser </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> RSA_PUBLIC_KEY</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;MIIBI...&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Now setup the target database, schema and table you will use to write out your stream data (the schema for the table must match the schema for the Data Stream you will use the <code>DataStreamWriter</code> to emit records to Snowflake  </li></ol><p>The user you will be using (that you setup the key pair authentication for) will need to be assigned a default role to which the appropriate write permissions are granted to the target objects in Snowflake.  You will also need to designate a virtual warehouse (which your user must have <code>USAGE</code> permissions to.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="the-code">The Code<a href="#the-code" class="hash-link" aria-label="Direct link to The Code" title="Direct link to The Code">​</a></h2><p>Now that we have the objects and user setup in Snowflake, we can construct our Spark application.  </p><p>First, you will need to start your Spark session (either using <code>pyspark</code> or <code>spark-submit</code>) including the packages that Spark will need to connect to Kafka and to Snowflake.  </p><p>The Snowflake packages include a JDBC driver and the Snowflake Connector for Spark, see <a href="https://docs.snowflake.com/en/user-guide/spark-connector.html" target="_blank" rel="noopener noreferrer">Snowflake Connector for Spark</a>.  </p><p>An example is shown here (package versions may vary depending upon the version of Spark you are using):  </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pyspark </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--packages </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.snowflake:snowflake-jdbc:3.13.14,</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net.snowflake:spark-snowflake_2.12:2.10.0-spark_3.1,</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">org.apache.spark:spark-sql-kafka-0-10_2.12:3.2.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now that we have a spark session with the necessary packages, lets go...  </p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># import any required functions, set the checkpoint directory, and log level (optional)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pyspark</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sql</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">functions </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> split</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sparkContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ERROR&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;spark.sql.streaming.checkpointLocation&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;file:///tmp&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>setup connection options for Snowflake by creating an <code>sfOptions</code> dictionary  </p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sfOptions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;sfURL&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sfUrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;sfUser&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;avensolutions&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;pem_private_key&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> private_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;sfDatabase&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SPARK_SNOWFLAKE_DEMO&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;sfSchema&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;PUBLIC&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;sfWarehouse&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;COMPUTE_WH&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;streaming_stage&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;mystage&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>set a variable for the Snowflake Spark connector  </p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SNOWFLAKE_SOURCE_NAME </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;net.snowflake.spark.snowflake&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>read messages from Kafka:    </p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">lines </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> spark \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">readStream \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kafka&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kafka.bootstrap.servers&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kafkabroker:9092&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;subscribe&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;weblogs&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>perform necessary transformations (the fields and data types in the resultant data structure must match the target table you created in Snowflake:  </p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">log_recs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lines</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;string&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alias</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;data&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> log_recs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">selectExpr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[0] as string) as date&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[1] as string) as time&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[2] as string) as c_ip&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[3] as string) as cs_username&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[4] as string) as s_sitename&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[5] as string) as s_computername&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[6] as string) as s_ip&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[7] as int) as s_port&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[8] as string) as cs_method&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[9] as string) as cs_uri_stem&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[10] as string) as cs_uri_query&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[11] as int) as sc_status&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[12] as int) as time_taken&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[13] as string) as cs_version&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[14] as string) as cs_host&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[15] as string) as User_Agent&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CAST(data[16] as string) as Referer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>write to Snowflake!  </p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> log_data\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">writeStream\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SNOWFLAKE_SOURCE_NAME</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">sfOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;dbtable&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;WEB_LOGS&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">trigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">processingTime</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;30 seconds&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">awaitTermination</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Note that I have included the <code>processingTime</code> trigger of <code>30 seconds</code> (this is akin to the <code>batchInterval</code> in the DStream API), you should tune this to get a balance between batch sizes to ingest into Snowflake (which will benefit from larger batches) and latency.</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="the-results">The Results<a href="#the-results" class="hash-link" aria-label="Direct link to The Results" title="Direct link to The Results">​</a></h2><p><a target="_blank" href="/assets/files/snowflake-screenshot-97a035bab5f113d5139441dde516099d.png"><img loading="lazy" alt="Spark Structured Streaming into Snowflake" src="/assets/images/snowflake-screenshot-97a035bab5f113d5139441dde516099d.png" width="1920" height="1040" class="img_ev3q"></a></p><p>Enjoy!  </p><blockquote><p>if you have enjoyed this post, please consider <a href="https://www.buymeacoffee.com/jeffreyaven" target="_blank" rel="noopener noreferrer"><strong>buying me a coffee ☕</strong></a> to help me keep writing!</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/snowflake">snowflake</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/kafka">kafka</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/spark">spark</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/sql">sql</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/streaming">streaming</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/okta-pkce-cli-blog-image.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/simple-cli-pkce-auth-using-okta">Simple CLI Application to Login to Okta using PKCE</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-04-17T00:00:00.000Z" itemprop="datePublished">April 17, 2022</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This article demonstrates a simple command line utility to login to an authorization server (Okta in this case) using a PKCE (Proof Key for Code Exchange) flow.  This is the preferred flow for public clients (such as Single Page Applications).  </p><blockquote><p>The code for this article is available on <a href="https://github.com/stackql/okta-pkce-login" target="_blank" rel="noopener noreferrer"><strong>GitHub</strong></a></p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="example">Example<a href="#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h2><p><a target="_blank" href="/assets/files/okta-pkce-cli-login-984bdced01ccc0963b19556d1800450d.png"><img loading="lazy" alt="Okta PKCE cli login example" src="/assets/images/okta-pkce-cli-login-984bdced01ccc0963b19556d1800450d.png" width="982" height="479" class="img_ev3q"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2><p>This application can be used to illustrate the authorization/authentication flow discussed in <a href="https://fullstackchronicles.io/simple-sso-with-an-external-idp-using-active-directory-and-okta" target="_blank" rel="noopener noreferrer">Simple SSO with an external IdP using Active Directory and Okta</a>.  A flow which is pictured here:  </p><p><a target="_blank" href="/assets/files/seqdiagram-405ae2f7d8f54f113c5190e8d5799117.png"><img loading="lazy" alt="PKCE Authorization t Okta using an AD IdP" src="/assets/images/seqdiagram-405ae2f7d8f54f113c5190e8d5799117.png" width="904" height="738" class="img_ev3q"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="steps">Steps<a href="#steps" class="hash-link" aria-label="Direct link to Steps" title="Direct link to Steps">​</a></h2><p>The steps involved in the implementation of a PKCE login flow are as follows:</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="generate-a-code_challenge">Generate a <code>code_challenge</code><a href="#generate-a-code_challenge" class="hash-link" aria-label="Direct link to generate-a-code_challenge" title="Direct link to generate-a-code_challenge">​</a></h3><p>To implement a PKCE flow, you first need to generate a <em>Code Verifier</em> (which is a random value you create), the <em>Code Verifier</em> is then hashed using a SHA256 algorithm.  The hash is then used as the <em>Code Challenge</em>.  An example function to generate a code challenge is shown below:  </p><iframe width="100%" frameborder="0" id="gist-9a2a162813d77b83821d821b6a4a390a"></iframe><p>For more information see <a href="https://developer.okta.com/blog/2019/08/22/okta-authjs-pkce#:~:text=PKCE%20works%20by%20having%20the,is%20called%20the%20Code%20Challenge" target="_blank" rel="noopener noreferrer">Use PKCE to Make Your Apps More Secure</a>. </p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="build-the-authorize-url">Build the <code>authorize</code> url<a href="#build-the-authorize-url" class="hash-link" aria-label="Direct link to build-the-authorize-url" title="Direct link to build-the-authorize-url">​</a></h3><p>The <code>authorize</code> url is used to initiate the authorization flow with the authorization server.  An example function to construct the <code>authorize</code> url is shown below:  </p><iframe width="100%" frameborder="0" id="gist-9e628b905a532e5bd59f022a4adca340"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="get-the-authorization-code-via-redirect-uri">Get the authorization code via redirect uri<a href="#get-the-authorization-code-via-redirect-uri" class="hash-link" aria-label="Direct link to Get the authorization code via redirect uri" title="Direct link to Get the authorization code via redirect uri">​</a></h3><p>The <code>redirecturi</code> parameter supplied in the <code>authorize</code> url is used to retrieve the authorization code from the authorization server.  In order to get this code using a front end flow, you need to define a handler that will get the authorization code, call the token endpoint, and close the HTTP server, as shown here:  </p><iframe width="100%" frameborder="0" id="gist-617417bdcc54efcea9d37d27228f7f2a"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="exchange-the-code-for-an-access-token">Exchange the code for an access token<a href="#exchange-the-code-for-an-access-token" class="hash-link" aria-label="Direct link to Exchange the code for an access token" title="Direct link to Exchange the code for an access token">​</a></h3><p>The access token is what you ultimatly want, as this is the token that will be used to access protected resources.  An example function to exchange the authorization code for an access token is shown below:  </p><iframe width="100%" frameborder="0" id="gist-0a990674d8bde2baffc0b0231f52ed52"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="optional-get-the-user-profile">(Optional) Get the user profile<a href="#optional-get-the-user-profile" class="hash-link" aria-label="Direct link to (Optional) Get the user profile" title="Direct link to (Optional) Get the user profile">​</a></h3><p>The access token can be used to get the user profile, this is done by calling the <code>userinfo</code> endpoint using the token.  An example function to get the user profile is shown below:  </p><iframe width="100%" frameborder="0" id="gist-f04e8b018417a73986d3696c58f735cb"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="with-inspiration-from">with inspiration from...<a href="#with-inspiration-from" class="hash-link" aria-label="Direct link to with inspiration from..." title="Direct link to with inspiration from...">​</a></h2><ul><li><a href="https://gist.github.com/ogazitt/f749dad9cca8d0ac6607f93a42adf322" target="_blank" rel="noopener noreferrer">Auth0 PKCE flow for a CLI built in golang</a></li><li><a href="https://community.auth0.com/t/golang-sample-for-a-cli-obtaining-an-access-token-using-the-pkce-flow/40922" target="_blank" rel="noopener noreferrer">Golang sample for a CLI obtaining an access token using the PKCE flow</a></li><li><a href="https://github.com/oktadev/okta-node-cli-example" target="_blank" rel="noopener noreferrer">oktadev/okta-node-cli-example</a></li><li><a href="https://developer.okta.com/blog/2019/06/18/command-line-app-with-nodejs" target="_blank" rel="noopener noreferrer">Build a Command Line Application with Node.js</a></li><li><a href="https://developer.okta.com/docs/guides/implement-grant-type/authcodepkce/main/#about-the-authorization-code-grant-with-pkce" target="_blank" rel="noopener noreferrer">About the Authorization Code grant with PKCE</a></li></ul><blockquote><p>if you have enjoyed this post, please consider <a href="https://www.buymeacoffee.com/jeffreyaven" target="_blank" rel="noopener noreferrer"><strong>buying me a coffee ☕</strong></a> to help me keep writing!</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/okta">okta</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/oauth-2">oauth2</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/cli">cli</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/golang">golang</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/pkce">pkce</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/scaling-up-prefect-with-gitstorage-featured-image.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/scaling-up-prefect-with-gitstorage">Scaling up Prefect with GitStorage</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-02-28T00:00:00.000Z" itemprop="datePublished">February 28, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/datwiz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="http://0.gravatar.com/avatar/f9af9c3fae755ac170c5798c53c5267d?s=80" alt="Chris Ottinger"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/datwiz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Chris Ottinger</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Technologist</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://prefect.io" target="_blank" rel="noopener noreferrer">Prefect.io</a> is a python based Data Engineering toolbox for building and
operating Data Pipelines.  Out of the box, Prefect provides an initial workflow for managing data
pipelines that results in a container image per data pipeline job.</p><p>The one-to-one relationship between data pipeline jobs and container images enables data engineers to
craft pipelines that are loosely coupled and don&#x27;t require a shared runtime environment configuration.
However, as the number of data pipeline jobs grow the default container per job approach starts to
introduce workflow bottlenecks and lifecycle management overheads.  For example, in order
to update software components used by flows, such as upgrading the version of Prefect, all the data
pipeline job images have to be rebuilt and redeployed.  Additionally the container image per job workflow
introduces a wait time for data engineers to re-build data pipeline container images and test flows
centrally on Prefect Server or Prefect Cloud environment.</p><p>Fortunately, Prefect comes to its own rescue with the ability to open up the box, exposing the flexibility
in the underlying framework.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="out-of-the-box---prefect-dockerstorage">Out of the box - Prefect DockerStorage<a href="#out-of-the-box---prefect-dockerstorage" class="hash-link" aria-label="Direct link to Out of the box - Prefect DockerStorage" title="Direct link to Out of the box - Prefect DockerStorage">​</a></h2><p>Out of the box, Prefect provides a simple workflow for defining and deploying data pipelines as container images.
After getting a first data pipeline running in a local environment, the attention turns to scaling up development
and deploying flows into a managed environment, using either the Prefect Cloud service or a Prefect Server.</p><p>Combining Prefect Cloud or Prefect Server with Kubernetes provides a flexible and scalable platform
solution for moving data pipelines into production.  There are a number of options for packaging
data pipeline flow code for execution on kubernetes clusters.  The Docker Storage option provides
the workflow for bundling the data pipeline job code into container images, enabling a common
controlled execution environment and well understood distribution mechanism.  The data pipeline runs as
a pod using the flow container image.</p><p>Prefect Docker Storage workflow steps for building and deploying data pipeline flows include:</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Steps</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PlantUML</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p><a target="_blank" href="/assets/files/image1-3eb8a74efcfb6b3a329f69dd9b89ca34.png"><img loading="lazy" alt="Workflow Steps" src="/assets/images/image1-3eb8a74efcfb6b3a329f69dd9b89ca34.png" width="253" height="435" class="img_ev3q"></a> </p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml &quot;docker-storage-workflow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(*) --&gt; &quot;package flow code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">into a container image&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;register Prefect flow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using image reference&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;push image to container registry&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;run flow in Prefect Server or Cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(new image pulled from registry)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; (*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div><ul><li>packaging a flow (python code) as a serialised/pickled object into a container image</li><li>registering the flow using the container image name</li><li>pushing the container image to a container repository accessible from the kubernetes cluster</li><li>running the flow by running an instance of the named container image as a kubernetes pod</li></ul><p>This is relatively simple immutable workflow.  Each data pipeline flow version is effectively a unique and
self contained &#x27;point-in-time&#x27; container image.  This initial workflow can also be extended to package
multiple related flows into a single container image, reducing the number of resulting container images.
But, as the number of data pipeline jobs grow, there issues of container image explosion and data engineering
productivity remain.</p><p>Using Prefect GitStorage for flows addresses both container image proliferation as well as development
bottlenecks.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="prefect-git-storage">Prefect Git Storage<a href="#prefect-git-storage" class="hash-link" aria-label="Direct link to Prefect Git Storage" title="Direct link to Prefect Git Storage">​</a></h2><p>Prefect <a href="https://docs.prefect.io/orchestration/flow_config/storage.html#git" target="_blank" rel="noopener noreferrer">Git Storage</a> provides a workflow for developing and deploying data pipelines directly from git repositories,
such as Gitlab or Github.  The data pipeline code (python) is pulled from the git repository on each invocation
with the ability to reference git branches and git tags.  This approach enables:</p><ul><li>reducing the number of container images to the number of different runtime configurations to be supported.</li><li>improving the data engineering development cycle time by removing the need to build and push container images
on each code change.</li><li>when combined with kubernetes Prefect Run Configs and Job templates, enables selection of specific runtime environment images</li></ul><p>Note that the GitStorage option does required access from the runtime kubernetes cluster to the central git storage
service, e.g. gitlab, github, etc.</p><p>Prefect Git Storage workflow steps for &#x27;building&#x27; and deploying data pipeline flows include:</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Steps</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PlantUML</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p><a target="_blank" href="/assets/files/image2-d57463bea4147ef77047e87d3b7a49a7.png"><img loading="lazy" alt="Workflow Steps" src="/assets/images/image2-d57463bea4147ef77047e87d3b7a49a7.png" width="253" height="361" class="img_ev3q"></a> </p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml &quot;git-storage-workflow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(*) --&gt; &quot;push commited flow code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changes to git service&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;register PrefectFlow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using branch or tag reference&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;run flow in Prefect Server or Cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(code pulled from git service)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; (*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div><ul><li>pushing the committed code to the central git service</li><li>registering the flow using the git repository url and branch or tag reference</li><li>running the flow by pulling the reference code from the git service in a kubernetes pod</li></ul><p>The container image build and push steps are removed from the developer feedback cycle time.
Depending on network bandwidth and image build times, this can save remove 5 to 10 minutes from each deployment iteration.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="pushing-the-flow-code">Pushing the flow code<a href="#pushing-the-flow-code" class="hash-link" aria-label="Direct link to Pushing the flow code" title="Direct link to Pushing the flow code">​</a></h3><p>Once a set of changes to the data pipeline code has been committed, push to the central git service.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> push</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="registering-the-flow">Registering the flow<a href="#registering-the-flow" class="hash-link" aria-label="Direct link to Registering the flow" title="Direct link to Registering the flow">​</a></h3><p>The flow can be registered with Prefect using either a branch (HEAD or latest) or tag reference.  Assuming
a workflow with feature branches:</p><ul><li>feature branches: register the flow code using the feature branch.  This enables the latest version (HEAD)
of the pushed flow code to be used for execution.  It also enables skipping re-registration of the flow on new
changes as the HEAD of the branch is pulled on each flow run</li><li>main line branches: register pinned versions of the flow using git tags.  This enables the use of a
specific version of the flow code to be pulled on each flow run, regardless of future changes.</li></ul><p>Determining the which reference to use:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># using gitpython module to work with repo info</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> git </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># presidence for identifing where to find the flow code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># BUILD_TAG =&gt; GIT_BRANCH =&gt; active_branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build_tag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> branch_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build_tag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;BUILD_TAG&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> build_tag </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  branch_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;GIT_BRANCH&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> branch_name </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    branch_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Repo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getcwd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">active_branch</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Configuring Prefect Git storage:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> prefect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> my_flows</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hello_flow </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> flow </span><span class="token comment" style="color:#999988;font-style:italic"># assuming flow is defined in ./my_flows/flow.py</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># example using Gitlab</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># either branch_name or tag must be empty string &quot;&quot; or None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">storage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Git</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repo_host</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">git_hostname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repo</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">repo_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">flow</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">__name__</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">replace</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">,</span><span class="token string-interpolation interpolation string" style="color:#e3116c">&#x27;/&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.py&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    branch_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">branch_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tag</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">build_tag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git_token_secret_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">git_token_secret_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git_token_username</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">git_token_username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_flow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">regsiter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">build</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once registered, the flow storage details can be viewed in the Prefect Server or Prefect Cloud UI.  In this example, Prefect will use the <code>HEAD</code> version of the <code>main</code> branch on each flow run.</p><p><a target="_blank" href="/assets/files/flow-storage-details-e2be96914a590e405cacb47ffc0eceaa.png"><img loading="lazy" alt="hello flow storage details" src="/assets/images/flow-storage-details-e2be96914a590e405cacb47ffc0eceaa.png" width="678" height="339" class="img_ev3q"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="next-steps---run-config">Next Steps - Run Config<a href="#next-steps---run-config" class="hash-link" aria-label="Direct link to Next Steps - Run Config" title="Direct link to Next Steps - Run Config">​</a></h2><p>With Prefect Git Storage the runtime configuration and environment management is decoupled from the
data pipeline development workflow.  Unlike with Docker Storage, with Git Storage, the runtime
execution environment and data pipeline development workflows are defined and managed separately.
As an added benefit, the developer feedback loop cycle time is also reduced.</p><p>With the data engineering workflow addressed, the next step in scaling out the Prefect solution
turns to configuration and lifecycle management of the runtime environment for data pipelines.
Prefect Run Configs and Job templates provide the tools retaining the flexibility on container
image based runtime environments with improved manageability.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/prefect">prefect</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitlab">gitlab</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/docker">docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/etl">etl</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/page/3"><div class="pagination-nav__label">Newer Entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/page/5"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">StackQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.windrate.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">WindRate<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.f5afdae2.js"></script>
<script src="/assets/js/main.e830d5cb.js"></script>
</body>
</html>