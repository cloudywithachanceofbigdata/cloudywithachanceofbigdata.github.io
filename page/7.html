<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Cloudy with a chance of Big Data Blog Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Cloudy with a chance of Big Data Blog Feed Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Cloudy with a chance of Big Data Blog Feed JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4N6KSJ2G0P"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4N6KSJ2G0P",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloudy with a chance of Big Data" href="/opensearch.xml"><title data-react-helmet="true">Cloudy with a chance of Big Data | Cloudy with a chance of Big Data</title><meta data-react-helmet="true" property="og:title" content="Cloudy with a chance of Big Data | Cloudy with a chance of Big Data"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="Cloud and data design patterns and random musings"><meta data-react-helmet="true" property="og:description" content="Cloud and data design patterns and random musings"><meta data-react-helmet="true" property="og:url" content="https://cloudywithachanceofbigdata.com/page/7"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cloudywithachanceofbigdata.com/page/7"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.com/page/7" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.com/page/7" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.fe05d8b3.css">
<link rel="preload" href="/assets/js/runtime~main.1c3362fe.js" as="script">
<link rel="preload" href="/assets/js/main.13e3577b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" style="background-color:#A9BCD0;color:#1A4E82" role="banner"><div class="announcementBarContent_KsVm"><b>If you find our content useful, give it a ‚≠êÔ∏è on <a target="_blank" rel="noopener noreferrer" href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io">GitHub</a>, if you want to contribute and become an author, submit a PR</b></div></div><nav class="navbar navbar--fixed-top navbarHideable_aKYr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title">Cloudy with a chance of Big Data</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/tags">Topics</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/snowflake">Snowflake</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">üåú</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">üåû</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/scaling-up-prefect-with-gitstorage">Scaling up Prefect with GitStorage</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/implementing-a-serverless-sftp-gateway-using-the-aws-transfer-family">Implementing a Serverless SFTP Gateway using the AWS Transfer Family</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/simple-sso-with-an-external-idp-using-active-directory-and-okta">Simple SSO with an external IdP using Active Directory and Okta</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/converting-to-local-time-in-aws-lambda-using-nodejs">Converting to local time in AWS Lambda using Node.js</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/automating-snowflake-role-based-storage-integration-for-aws">Automating Snowflake Role Based Storage Integration for AWS</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/simplifying-large-cloudformation-templates-using-jsonnet">Simplifying Large CloudFormation Templates using Jsonnet</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/aws-deployments-with-cloudformation-and-gitlab-ci">Simplified AWS Deployments with CloudFormation and GitLab CI</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/from-wordpress-to-jamstack">From Wordpress to Jamstack</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/using-jsonnet-to-configure-multiple-environments">Using Jsonnet to Configure Multiple Environments</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/use-bigquery-to-trigger-cloud-run">Use BigQuery to trigger Cloud Run</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/query-cloud-sql-through-big-query">Query Cloud SQL through Big Query</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-02-08T00:00:00.000Z" itemprop="datePublished">February 8, 2020</time> ¬∑ <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cloud-sql-federated-queries.png"><div class="markdown" itemprop="articleBody"><p>This article demonstrates Cloud SQL federated queries for Big Query, a neat and simple to use feature.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="connecting-to-cloud-sql">Connecting to Cloud SQL<a class="hash-link" href="#connecting-to-cloud-sql" title="Direct link to heading">‚Äã</a></h2><p>One of the challenges presented when using Cloud SQL on a private network (VPC) is providing access to users. There are several ways to accomplish this which include:</p><ul><li>open the database port on the VPC Firewall (5432 for example for Postgres) and let users access the database using a command line or locally installed GUI tool <em>(may not be allowed in your environment)</em></li><li>provide a web based interface deployed on your VPC such as PGAdmin deployed on a GCE instance or GKE pod <em>(adds security and management overhead)</em></li><li>use the Cloud SQL proxy <em>(requires additional software to be installed and configured)</em></li></ul><p>In additional, all of the above solutions require direct IP connectivity to the instance which may not always be available. Furthermore each of these operations requires the user to present some form of authentication ‚Äì in many cases the database user and password which then must be managed at an individual level.</p><p>Enter Cloud SQL federated queries for Big Query‚Ä¶</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="big-query-federated-queries-for-cloud-sql">Big Query Federated Queries for Cloud SQL<a class="hash-link" href="#big-query-federated-queries-for-cloud-sql" title="Direct link to heading">‚Äã</a></h2><p>Big Query allows you to query tables and views in Cloud SQL (currently MySQL and Postgres) using the Federated Queries feature. The queries could be authorized views in Big Query datasets for example.</p><p>This has the following advantages:</p><ul><li>Allows users to authenticate and use the GCP console to query Cloud SQL</li><li>Does not require direct IP connectivity to the user or additional routes or firewall rules</li><li>Leverages Cloud IAM as the authorization mechanism ‚Äì rather that unmanaged db user accounts and object level permissions</li><li>External queries can be executed against a read replica of the Cloud SQL instance to offload query IO from the master instance</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="setting-it-up">Setting it up<a class="hash-link" href="#setting-it-up" title="Direct link to heading">‚Äã</a></h2><p>Setting up big query federated queries for Cloud SQL is exceptionally straightforward, a summary of the steps are provided below:</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-1-enable-a-public-ip-on-the-cloud-sql-instance">Step 1. Enable a Public IP on the Cloud SQL instance<a class="hash-link" href="#step-1-enable-a-public-ip-on-the-cloud-sql-instance" title="Direct link to heading">‚Äã</a></h3><p>This sounds bad, but it isn‚Äôt really that bad. You need to enable a public interface for Big Query to be able to establish a connection to Cloud SQL, however this is not accessed through the actual public internet ‚Äì rather it is accessed through the Google network using the back end of the front end if you will.</p><p>Furthermore, you configure an empty list of authorized networks which effectively shields the instance from the public network, this can be configured in Terraform as shown here:</p><iframe width="100%" frameborder="0" id="gist-81c57a80a7e588b98ea7d294dbaee242"></iframe><p>This configuration change can be made to a running instance as well as during the initial provisioning of the instance.</p><p>As shown below you will get a warning dialog in the console saying that you have no authorized networks - this is by design.</p><p><a target="_blank" href="/assets/files/cloud-sql-publicip-screenshot-53f21feadbfaf3be93f69de3ce771c2f.png"><img alt="Cloud SQL Public IP Enabled with No Authorized Networks" src="/assets/images/cloud-sql-publicip-screenshot-53f21feadbfaf3be93f69de3ce771c2f.png" width="1139" height="775"></a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-2-create-a-big-query-dataset-which-will-be-used-to-execute-the-queries-to-cloud-sql">Step 2. Create a Big Query dataset which will be used to execute the queries to Cloud SQL<a class="hash-link" href="#step-2-create-a-big-query-dataset-which-will-be-used-to-execute-the-queries-to-cloud-sql" title="Direct link to heading">‚Äã</a></h3><p>Connections to Cloud SQL are defined in a Big Query dataset, this can also be use to control access to Cloud SQL using authorized views controlled by IAM roles.</p><iframe width="100%" frameborder="0" id="gist-8a4beaab134a1c72613347b5822d1724"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-3-create-a-connection-to-cloud-sql">Step 3. Create a connection to Cloud SQL<a class="hash-link" href="#step-3-create-a-connection-to-cloud-sql" title="Direct link to heading">‚Äã</a></h3><p>To create a connection to Cloud SQL from Big Query you must first enable the BigQuery Connection API, this is done at a project level.</p><p>As this is a fairly recent feature there isn&#x27;t great coverage with either the <strong><code>bq</code></strong> tool or any of the Big Query client libraries to do this so we will need to use the console for now...</p><p>Under the <em><strong>Resources</strong></em> -&gt; <strong><em>Add Data</em></strong> link in the left hand panel of the Big Query console UI, select <strong><em>Create Connection</em></strong>. You will see a side info panel with a form to enter connection details for your Cloud SQL instance.</p><p>In this example I will setup a connection to a Cloud SQL read replica instance I have created:</p><p><a target="_blank" href="/assets/files/big-query-add-connection-67a0236996204c84c7608a8e6b8f4875.png"><img src="/assets/images/big-query-add-connection-67a0236996204c84c7608a8e6b8f4875.png" width="959" height="775"></a></p><p>Creating a Big Query Connection to Cloud SQL</p><p>More information on the Big Query Connections API can be found at: <a href="https://cloud.google.com/bigquery/docs/reference/bigqueryconnection/rest" target="_blank" rel="noopener noreferrer">https://cloud.google.com/bigquery/docs/reference/bigqueryconnection/rest</a></p><p>The following permissions are associated with connections in Big Query:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.create  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.get  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.list  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.use  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.update  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.delete</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>These permissions are conveniently combined into the following predefined roles:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">roles/bigquery.connectionAdmin    (BigQuery Connection Admin)         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roles/bigquery.connectionUser     (BigQuery Connection User)          </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-4-query-away">Step 4. Query away!<a class="hash-link" href="#step-4-query-away" title="Direct link to heading">‚Äã</a></h3><p>Now the connection to Cloud SQL can be accessed using the <strong><code>EXTERNAL_QUERY</code></strong> function in Big Query, as shown here:</p><p><a target="_blank" href="/assets/files/cloud-sql-federated-queries-screenshot-34e49ac369753d8551095e92b7fc6264.png"><img alt="Querying Cloud SQL from Big Query" src="/assets/images/cloud-sql-federated-queries-screenshot-34e49ac369753d8551095e92b7fc6264.png" width="1373" height="730"></a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/big-query">big-query</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/bigquery">bigquery</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloudsql">cloudsql</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/google-cloud-sql-availability-for-postgresql-read-replicas">Google Cloud SQL ‚Äì Availability for PostgreSQL ‚Äì Part II (Read Replicas)</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-24T00:00:00.000Z" itemprop="datePublished">January 24, 2020</time> ¬∑ <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cloudsql-featured-image.png"><div class="markdown" itemprop="articleBody"><p>In this post we will look at read replicas as an additional method to achieve multi zone availability for Cloud SQL, which gives us - in turn - the ability to offload (potentially expensive) IO operations such as user created backups or read operations without adding load to the master instance.</p><p>In the previous post in this series we looked at Regional availability for PostgreSQL HA using Cloud SQL:</p><p><a href="https://cloudywithachanceofbigdata.com/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql-part-i/" target="_blank" rel="noopener noreferrer"><strong>Google Cloud SQL ‚Äì Availability, Replication, Failover for PostgreSQL ‚Äì Part I</strong></a></p><p>Recall that this option was simple to implement and worked relatively seamlessly and transparently with respect to zonal failover.</p><p>Now let&#x27;s look at read replicas in Cloud SQL as an additional measure for availability.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deploying-read-replicas">Deploying Read Replica(s)<a class="hash-link" href="#deploying-read-replicas" title="Direct link to heading">‚Äã</a></h2><p>Deploying read replicas is slightly more involved than simple regional (high) availability, as you will need to define each replica or replicas as a separate Cloud SQL instance which is a slave to the primary instance (the master instance).</p><p>An example using Terraform is provided here, starting by creating the master instance:</p><iframe width="100%" frameborder="0" id="gist-34371a3c7edab140e70208cd7710c25a"></iframe><p>Next you would specify one or more read replicas (typically in a zone other than the zone the master is in):</p><iframe width="100%" frameborder="0" id="gist-980f2d6461db0613b4090413041b5ec5"></iframe><p>Note that several of the options supplied are omitted when creating a read replica database instance, such as the backup and maintenance options - as these operations cannot be performed on a read replica as we will see later.</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-1-212da608bf5ba2aa73198627a0cfe3e1.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-1-212da608bf5ba2aa73198627a0cfe3e1.png" alt="Cloud SQL Instances - showing master and replica"></a><figcaption class="figure-caption">Cloud SQL Instances - showing master and replica</figcaption></figure><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-2-ec13f6b5f93493f369db3f4c11987507.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-2-ec13f6b5f93493f369db3f4c11987507.png" alt="Cloud SQL Master Instance"></a><figcaption class="figure-caption">Cloud SQL Master Instance</figcaption></figure><p>Voila! You have just set up a master instance (the primary instance your application and/or users will connect to) along with a read replica in a different zone which will be asynchronously updated as changes occur on the master instance.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="read-replicas-in-action">Read Replicas in Action<a class="hash-link" href="#read-replicas-in-action" title="Direct link to heading">‚Äã</a></h2><p>Now that we have created a read replica, lets see it in action. After connecting to the read replica (like you would any other instance), attempt to access a table that has <strong><em>not</em></strong> been created on the master as shown here:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-3-8d16fdd58297948424c733b59cb58ff5.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-3-8d16fdd58297948424c733b59cb58ff5.png" alt="SELECT operation from the replica instance"></a><figcaption class="figure-caption">SELECT operation from the replica instance</figcaption></figure><p>Now create the table and insert some data on the <strong><em>master</em></strong> instance:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-4-c207e904d4880b5f799bcfdabf7de36a.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-4-c207e904d4880b5f799bcfdabf7de36a.png" alt="Create a table and insert a record on the master instance"></a><figcaption class="figure-caption">Create a table and insert a record on the master instance</figcaption></figure><p>Now try the select operation on the <strong><em>replica</em></strong> instance:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-5-a9412ef5afba9855221998e5551cb19e.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-5-a9412ef5afba9855221998e5551cb19e.png" alt="SELECT operation from the replica instance (after changes have been made on the master)"></a><figcaption class="figure-caption">SELECT operation from the replica instance (after changes have been made on the master)</figcaption></figure><p>It works!</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="some-points-to-note-about-cloud-sql-read-replicas">Some Points to Note about Cloud SQL Read Replicas<a class="hash-link" href="#some-points-to-note-about-cloud-sql-read-replicas" title="Direct link to heading">‚Äã</a></h2><ul><li>Users connect to a read replica as a normal database connection (as shown above)</li><li>Google managed backups (using the console or <code>gcloud sql backups create ..</code> ) can <strong><em>NOT</em></strong> be performed against replica instances</li><li>Read replicas can be used to offload IO intensive operations from the the master instance - such as user managed backup operations (e.g. <code>pg_dump</code>)</li></ul><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-6-c367a62c5d3e480fa25ea4d0ea2669cf.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-6-c367a62c5d3e480fa25ea4d0ea2669cf.png" alt="pg_dump operation against a replica instance"></a><figcaption class="figure-caption">pg_dump operation against a replica instance</figcaption></figure><ul><li><strong>BE CAREFUL</strong> Despite their name, read replicas are <strong>NOT</strong> read only, updates can be made which will NOT propagate back to the master instance - you could get yourself in an awful mess if you allow users to perform <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>CREATE</code> or <code>DROP</code> operations against replica instances.</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="promoting-a-read-replica">Promoting a Read Replica<a class="hash-link" href="#promoting-a-read-replica" title="Direct link to heading">‚Äã</a></h2><p>If required a read replica can be promoted to a standalone Cloud SQL instance, which is another DR option. Keep in mind however as the read replica is updated in an asynchronous manner, promotion of a read replica may result in a loss of data (hopefully not much but a loss nonetheless). Your application RPO will dictate if this is acceptable or not.</p><p>Promotion of a read replica is reasonably straightforward as demonstrated here using the console:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-7-a4ec8a31ed6601a9e7253ce408893a90.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-7-a4ec8a31ed6601a9e7253ce408893a90.png" alt="Promoting a read replica using the console"></a><figcaption class="figure-caption">Promoting a read replica using the console</figcaption></figure><p>You can also use the following <code>gcloud</code> command:</p><p> gcloud sql instances promote-replica  &lt;replica<!-- -->_<!-- -->instance<!-- -->_<!-- -->name&gt;</p><p>Once you click on the <em>Promote Replica</em> button you will see the following warning:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-8-310006339cb5a3d3c491dfb00fc86c88.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-8-310006339cb5a3d3c491dfb00fc86c88.png" alt=""></a><figcaption class="figure-caption"></figcaption></figure><p><em>Promoting a read replica using the console</em></p><p>This simply states that once you promote the replica instance your instance will become an independent instance with no further relationship with the master instance. Once accepted and the promotion process is complete, you can see that you now have two independent Cloud SQL instances (as advertised!):</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-9-5cbdcea2c489b064bbbc1bad3617fbce.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-9-5cbdcea2c489b064bbbc1bad3617fbce.png" alt="Promoted Cloud SQL instance"></a><figcaption class="figure-caption">Promoted Cloud SQL instance</figcaption></figure><p>Some of the options you would normally configure with a master instance would need to be configured on the promoted replica instance - such as high availability, maintenance and scheduled backups - but in the event of a zonal failure you would be back up and running with virtually no data loss!</p><blockquote><p>Full source code for this article is available at: <a href="https://github.com/gamma-data/cloud-sql-postgres-availability-tutorial" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/cloud-sql-postgres-availability-tutorial</a></p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloudsql">cloudsql</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ha">ha</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/highavailability">highavailability</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/postgresql">postgresql</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/introducing-service-mesh-part-ii">Introducing Service Mesh Part II</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-21T00:00:00.000Z" itemprop="datePublished">January 21, 2020</time> ¬∑ <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="http://2.gravatar.com/avatar/58faa98ad68138dd1997f828f00a882e?s=80" alt="Tom Klimovski"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Tom Klimovski</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Cloud Engineer</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/service-mesh-1.png"><div class="markdown" itemprop="articleBody"><p>This is a follow up to the previous post:</p><p><a href="https://cloudywithachanceofbigdata.com/sick-of-hearing-about-service-mesh-heres-what-you-need-to-know/" target="_blank" rel="noopener noreferrer"><strong>Sick of hearing about Service Mesh? Here‚Äôs what you need to know...</strong></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="refresher">Refresher<a class="hash-link" href="#refresher" title="Direct link to heading">‚Äã</a></h2><p>A refresher on the data plane, and what the userspace proxy can perform:</p><ul><li><strong>Routing:</strong> Given a REST request for <code>/hello</code> from the local service instance, where should that request be sent?</li><li><strong>Load Balancing:</strong> Once routing has done its job, to which upstream service instance should the request be sent? With what timeout? If the request fails, should it be retried?</li><li><strong>Authorisation and Authentication:</strong> For requests that are incoming, can cryptographic functions determine the authenticity of that requests? Is the called allowed to invoke the requested endpoint?</li><li><strong>Observability:</strong> Detailed logging, statistics, distributed tracing data so that operators can understand the traffic flow and debug problems as they occur</li><li><strong>Service Discovery:</strong> What backend/upstream service instances are available?</li><li><strong>Health Checking:</strong> Are upstream service instances healthy and ready to accept traffic?</li></ul><p>The control plane is slightly less complex. For the data plane to act in a coordinated fashion, the control plane gives you the machinery to make that happen. This is the magical part of the service mesh; the control plane takes a set of isolated sidecar proxies and turns them into a distributed system. The control plane in turn provides an API to allow the user to modify and inspect the behaviour of the data plane.</p><p>You can see from the diagram below the proxies are right next to the service in the same node. We usually call those &#x27;sidecar&#x27; containers.</p><p><a target="_blank" href="/assets/files/control-data-plane-5cd2a8598fa552440a65343abd9e762c.png"><img src="/assets/images/control-data-plane-5cd2a8598fa552440a65343abd9e762c.png" width="1068" height="689"></a></p><p>The diagram above gives you a high level indication of what the service mesh would look like. What if I don&#x27;t have many services? Then the service mesh probably isn&#x27;t for you. That&#x27;s a whole lot of machinery to run a single proxy! Having said this, if your solution is running hundreds or thousands of services, then you&#x27;re going to require a whole heap of proxies.</p><p>So there you have it. The service mesh with its control and data plane. To put it simply, the goal of the control plane is to monitor and set a policy that will eventually be enacted by the data plane.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="why">Why?<a class="hash-link" href="#why" title="Direct link to heading">‚Äã</a></h2><p>You&#x27;ve taken over a project, and the security team have mandated the use of the service mesh. You&#x27;ve never used it yourself before, and the confusion as to why we need another thing is getting you down. An additional thing next to my container that will add latency? And consume resources? And I have to maintain it?! Why would anyone need or want this?</p><p>While there are a few answers to this, the most important answer is something I alluded to in an example in part 1 of this series: this design is a great way to add additional logic into the system. Not only can you add additional logic (to containers possibly outside of your control) but you can do this uniformly across the entire mesh! <em>The service mesh gives you features that are critical for running software that&#x27;s uniform across your whole stack</em></p><p>The set of features that the service mesh can provide include reliability features (Retries, timeouts etc), observability features (latencies, volume etc) and security features (mTLS, access control etc).</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="lets-break-it-down">Let&#x27;s break it down<a class="hash-link" href="#lets-break-it-down" title="Direct link to heading">‚Äã</a></h2><p><strong>Server-side software relies on these critical features</strong> If you&#x27;re building any type of modern server-side software that&#x27;s predicated on multiple services, think API&#x27;s and web-apps, and if you&#x27;re continually adding features to this in a short timeframe, then all the features listed above become critical for you. Your applications must be reliable, observable and most importantly secure. This is exactly what the service mesh helps you with.</p><p><strong>One view to rule them all</strong> The features mentioned above are language-agnostic, don&#x27;t care about your framework, who wrote it or any part of your development life cycle. They give you, your team and your company a consistent way to deploy changes across your service landscape</p><p><strong>Decoupled from application code</strong> It&#x27;s important to have a single place to include application and business logic, and not have the nightmare of managing that in multiple components of your system. The core stewardship of the functionality that the service mesh provides lies at the <em>platform level</em>. This includes maintenance, deployments, operation etc. The application can be updated and deployed by developers maintaining the application, and the service mesh can change without the application being involved.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="in-short">In short<a class="hash-link" href="#in-short" title="Direct link to heading">‚Äã</a></h2><p>Yes, while the features of the service mesh could be implemented as application code, this solution would not help in driving uniform features sets across the whole system, which is the value proposition for the service mesh.</p><p><em>If you&#x27;re a business-logic developer</em>, you probably don&#x27;t need to worry about the service mesh. Keep pumping out that new fangled business logic that makes the software oh-so-usable</p><p><em>If you&#x27;re in a platform role</em> and most likely using <em>Kubernetes</em>, then you should be right on top of the service mesh! That is unless your architecture dictates a monolith. You&#x27;re going to have a lot of services talking to one another, all tied together with an overarching dependency.</p><p><em>If you&#x27;re in a platform role with no Kubernetes</em> but a bunch of microservices, you should maybe care a little bit about the service mesh, but without the power of Kubernetes and the ease of deployment it brings, you&#x27;ll have to weigh up how you intend to manage all those proxies.</p><p>I hope you enjoyed this article, please feel free to reach out to me at:</p><p>Tom Klimovski<br>
<!-- -->Principal Consultant, Gamma Data<br>
<a href="mailto:tom.klimovski@gammadata.io" target="_blank" rel="noopener noreferrer">tom.klimovski@gammadata.io</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/k-8-s">k8s</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/service-mesh">service-mesh</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/servicemesh">servicemesh</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql">Google Cloud SQL ‚Äì Availability, Replication, Failover for PostgreSQL ‚Äì Part I</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-17T00:00:00.000Z" itemprop="datePublished">January 17, 2020</time> ¬∑ <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cloudsql-featured-image.png"><div class="markdown" itemprop="articleBody"><p>In this multi part blog we will explore the features available in Google Cloud SQL for High Availability, Backup and Recovery, Replication and Failover and Security (at rest and in transit) for the PostgreSQL DBMS engine. Some of these features are relatively hot of the press and in Beta ‚Äì which still makes them available for general use.</p><p>We will start by looking at the High Availability (HA) options available to you when using the PostgreSQL engine in Google Cloud SQL.</p><p>Most of you would be familiar with the concepts of High Availability, Redundancy, Fault Tolerance, etc but let‚Äôs start with a definition of HA anyway:</p><blockquote><p>High availability (HA) is a characteristic of a system, which aims to ensure an agreed level of operational performance, usually uptime, for a higher than normal period.</p><p>Wikipedia</p></blockquote><p>Higher than a normal period is quite subjective, typically this is quantified by a percentage represented by a number of ‚Äú9s‚Äù, that is 99.99% (which would be quoted as ‚Äúfour nines‚Äù), this would allot you 52.60 minutes of downtime over a one-year period.</p><p>Essentially the number of 9‚Äôs required will drive your bias towards the options available to you for Cloud SQL HA.</p><p>We will start with Cloud SQL HA in its simplest form, Regional Availability.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="regional-availability">Regional Availability<a class="hash-link" href="#regional-availability" title="Direct link to heading">‚Äã</a></h2><p>Knowing what we know about the Google Cloud Platform, regional availability means that our application or service (in this case Cloud SQL) should be resilient to a failure of any one zone in our region. In fact, as all GCP regions have at least 3 zones ‚Äì two zones could fail, and our application would still be available.</p><p>Regional availability for Cloud SQL (which Google refers to as High Availability), creates a standby instance in addition to the primary instance and uses a regional Persistent Disk resource to store the database instance data, transaction log and other state files, which is synchronously replicated to a Persistent Disk resource local to the zones that the primary and standby instances are located in.</p><p>A shared IP address (like a Virtual IP) is used to serve traffic to the healthy (normally primary) Cloud SQL instance.</p><p>An overview of Cloud SQL HA is shown here:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-9f997d42db7d02fc6391cb507e81bc6c.png"><img alt="Cloud SQL High Availability" src="/assets/images/cloud-sql-ha-9f997d42db7d02fc6391cb507e81bc6c.png" width="716" height="541"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="implementing-high-availability-for-cloud-sql">Implementing High Availability for Cloud SQL<a class="hash-link" href="#implementing-high-availability-for-cloud-sql" title="Direct link to heading">‚Äã</a></h2><p>Implementing Regional Availability for Cloud SQL is dead simple, it is one argument:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">availability_type = &quot;REGIONAL&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Using the <code>gcloud</code> command line utility, this would be:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud sql instances create postgresql-instance-1234 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --availability-type=REGIONAL \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --database-version= POSTGRES_9_6</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Using Terraform (with a complete set of options) it would look like:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_sql_database_instance&quot; &quot;postgres_ha&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider = google-beta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project = var.project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;postgresql-instance-${random_id.instance_suffix.hex}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  database_version = &quot;POSTGRES_9_6&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  settings {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   tier = var.tier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_size = var.disk_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   activation_policy = &quot;ALWAYS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_autoresize = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_type = &quot;PD_SSD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   **availability_type = &quot;REGIONAL&quot;**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   backup_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     enabled = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     start_time = &quot;00:00&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ip_configuration  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ipv4_enabled = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     private_network = google_compute_network.private_network.self_link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   maintenance_window  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     day = 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     hour = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     update_track = &quot;stable&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> } </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Once deployed you will notice a few different items in the console, first from the instance overview page you can see that the High Availability option is <code>ENABLED</code> for your instance.</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-1-12d875328c3d6743bab7c41038d7e382.png"><img src="/assets/images/cloud-sql-ha-1-12d875328c3d6743bab7c41038d7e382.png" width="1310" height="446"></a></p><p>Second, you will see a Failover button enabled on the detailed management view for this instance.</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-2-39a03f8c41a267780563cbb20bafd2d4.png"><img src="/assets/images/cloud-sql-ha-2-39a03f8c41a267780563cbb20bafd2d4.png" width="1310" height="612"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="failover">Failover<a class="hash-link" href="#failover" title="Direct link to heading">‚Äã</a></h2><p>Failovers and failbacks can be initiated manually or automatically (should the primary be unresponsive). A manual failover can be invoked by executing the command:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud sql instances failover postgresql-instance-1234</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There is an <code>--async</code> option which will return immediately, invoking the failover operation asynchronously.</p><p>Failover can also be invoked from the Cloud Console using the Failover button shown previously. As an example I have created a connection to a regionally available Cloud SQL instance and started a command which runs a loop and prints out a counter:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-3-6710a724106c4048213b24a2082b64cb.png"><img src="/assets/images/cloud-sql-ha-3-6710a724106c4048213b24a2082b64cb.png" width="1920" height="1040"></a></p><p>Now using the <code>gcloud</code> command shown earlier, I have invoked a manual failover of the Cloud SQL instance.</p><p>Once the failover is initiated, the client connection is dropped (as the server is momentarily unavailable):</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-4-bb4bcf4f70179371b1b26d96a92a4dff.png"><img src="/assets/images/cloud-sql-ha-4-bb4bcf4f70179371b1b26d96a92a4dff.png" width="1920" height="1040"></a></p><p>The connection can be immediately re-established afterwards, the state of the running query is lost - <strong><em>importantly no data is lost</em></strong> however. If your application clients had retry logic in their code and they weren&#x27;t executing a long running query, chances are no one would notice! Once reconnecting normal database activities can be resumed:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-5-6f8c7134a54b7a38444f5ddbdbcf960e.png"><img src="/assets/images/cloud-sql-ha-5-6f8c7134a54b7a38444f5ddbdbcf960e.png" width="1920" height="1040"></a></p><p>A quick check of the instance logs will show that the failover event has occured:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-6-a4ab88ef121dbc8842347478cf0811d0.png"><img src="/assets/images/cloud-sql-ha-6-a4ab88ef121dbc8842347478cf0811d0.png" width="1310" height="568"></a></p><p>Now when you return to the instance page in the console you will see a Failback button, which indicates that your instance is being served by the standby:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-7-25ae1613611767eea9c101c3a24f0632.png"><img src="/assets/images/cloud-sql-ha-7-25ae1613611767eea9c101c3a24f0632.png" width="1239" height="641"></a></p><p>Note that there may be a slight delay in the availability of this option as the replica is still being synched.</p><p>It is worth noting that nothing comes for free! When you run in REGIONAL or High Availability mode - you are effectively paying double the costs as compared to running in ZONAL mode. However availability and cost have always been trade-offs against one another - you get what you pay for...</p><blockquote><p>More information can be found at: <a href="https://cloud.google.com/sql/docs/postgres/high-availability" target="_blank" rel="noopener noreferrer">https://cloud.google.com/sql/docs/postgres/high-availability</a></p></blockquote><p>Next up we will look at read replicas (and their ability to be promoted) as another high availability alternative in Cloud SQL.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloudsql">cloudsql</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ha">ha</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/highavailability">highavailability</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/postgresql">postgresql</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/sick-of-hearing-about-service-mesh-heres-what-you-need-to-know">Sick of hearing about Service Mesh? Here‚Äôs what you need to know...</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-09T00:00:00.000Z" itemprop="datePublished">January 9, 2020</time> ¬∑ <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="http://2.gravatar.com/avatar/58faa98ad68138dd1997f828f00a882e?s=80" alt="Tom Klimovski"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Tom Klimovski</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Cloud Engineer</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/service-mesh-1.png"><div class="markdown" itemprop="articleBody"><p>So you‚Äôve started delivering a new project and it‚Äôs all about this ‚ÄúCloud Native‚Äù or ‚ÄúMicroservices‚Äù thing. You‚Äôre a Delivery Manager or Software Engineer at some type of company and someone has lightly peppered a meeting with a term, ‚ÄòMesh‚Äô.</p><p>They possibly said event mesh. Or better yet, they mentioned a service mesh. As time went on you kept hearing more and more about the service mesh. You‚Äôve attempted to read up about it, digested a whole bunch of new terms and still didn‚Äôt completely understand what the Mesh even does, why you would need it or why the hype train around this technology shows no sign of stopping. This article is an attempt to provide a focused guide to the service mesh, and why it is so interesting.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ok-so-what-is-this-thing">Ok, so what is this thing?<a class="hash-link" href="#ok-so-what-is-this-thing" title="Direct link to heading">‚Äã</a></h2><p>Truth be told, the service mesh is actually pretty simple. It‚Äôs built around the idea of small, repeatable bits of software, in this case userspace proxies, stuck very close to your services. This is called the <strong><em>data plane</em></strong>. In addition to the userspace proxies, you also get a bunch of management processes, which is referred to as the <strong><em>control plane</em></strong>. Simply put, the data plane (userspace proxies) intercepts all calls between services and the control plane (management processes) coordinates the wholesale behaviour of those proxies. This allows you to perform sweeping changes across your service landscape via the control planes API‚Äôs, operators and provides the capability to measure your mesh as a whole.</p><p>Before we get into the engineering of what the proxies are, let‚Äôs go with an example.</p><ul><li>The business has bought some software.</li><li>The engineers are tasked with deploying this software in their Kubernetes cluster.</li><li>The engineers first task is to containerise this application, expose its functionality to downstream applications and deploy it to the cluster in a repeatable, continuous fashion.</li><li>There‚Äôs a requirement in your organisation that says ‚ÄòI need all communications to this vendors software as TLS1.3‚Äô. Or, ‚ÄòI would like to measure all API latency from this application‚Äô.</li></ul><p>The engineer replies ‚ÄòI can‚Äôt make changes to a third party application! What do I do?‚Äô. Service mesh to the rescue.</p><p>Using a service mesh, you can deploy a proxy right next to your vendor container and in effect, abstract away the complexities of measurement and data transport mechanisms, and allow the vendor software to concentrate on it‚Äôs business logic.</p><p>This vendor container is now part of the <strong><em>service mesh</em></strong>.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="proxies">Proxies<a class="hash-link" href="#proxies" title="Direct link to heading">‚Äã</a></h2><p>When we talk about proxies, we usually discuss things in OSI model terminology, that is to say Layers 1 through 7. Most of the time when it comes to proxies, you‚Äôre comparing Layer 4 to Layer 7. Here‚Äôs a quick run-down:</p><p>Layer 4 (L4) -&gt; operates with the delivery of messages with no regard to the content of the messages. They would simply forward network packets to and from the server without inspecting any part of the packets.</p><p>Layer 7 (L7) -&gt; this is a higher level, application layer. This deals with the actual content of the message. If you were routing network traffic, you could do this at L7 in a much more sophisticated way because you can now make decisions based on the packets messages within.</p><p>Why pick between L4 and L7? <em>Speed</em>.</p><p>Back to the service mesh, these userspace proxies are L7-aware TCP proxies. Think <em><strong>NGINX</strong></em> or <em><strong>haproxy</strong></em>. There are different proxies; <a href="https://linkerd.io/" target="_blank" rel="noopener noreferrer">Linkerd</a> is an ultralight service mesh for Kubernetes. The most popular is <a href="https://www.envoyproxy.io/" target="_blank" rel="noopener noreferrer">Envoy</a>, which was created by the ride-share company Lyft. Above, I also mentioned NGINX and haproxy which are also quite popular. So what differentiates NGINX proxies from the service mesh? Their <em>focus</em>. You would implement NGINX as an Ingress proxy (traffic entering your network), but when it comes to proxies that focus on traffic between services, that‚Äôs when the service mesh proxy comes in to play.</p><p>Ok, probably time for a diagram now that we‚Äôve explained the Data Plane.</p><p><a target="_blank" href="/assets/files/service-mesh-74fe164528e1f23a50f21eb48aeeb2c0.png"><img src="/assets/images/service-mesh-74fe164528e1f23a50f21eb48aeeb2c0.png" width="871" height="562"></a></p><p>Tune in for part 2 for when we discuss the Control Plane!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/k-8-s">k8s</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/service-mesh">service-mesh</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/servicemesh">servicemesh</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/page/6"><div class="pagination-nav__label">Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/8"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a href="https://stackql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>StackQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.windrate.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>WindRate<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"></div></div></footer></div>
<script src="/assets/js/runtime~main.1c3362fe.js"></script>
<script src="/assets/js/main.13e3577b.js"></script>
</body>
</html>