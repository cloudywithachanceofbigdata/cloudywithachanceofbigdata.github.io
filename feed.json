{
    "version": "https://jsonfeed.org/version/1",
    "title": "Full Stack Chronicles Blog Feed",
    "home_page_url": "https://fullstackchronicles.io/",
    "description": "Full stack design patterns",
    "items": [
        {
            "id": "create-and-use-custom-magic-commands-in-jupyter",
            "content_html": "<p>We were looking to implement a variant of the <code>%sql</code> magic command in Jupyter without using the default <code>sqlalchemy</code> module (in our case, just using <code>psycopg2</code> to connect to a local server - a StackQL postrges wire protocol server).  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-the-extension-module\">Create the extension module<a class=\"hash-link\" href=\"#create-the-extension-module\" title=\"Direct link to heading\">​</a></h2><p>We named our extension and cell magic command <code>stackql</code>, so start by creating a file named <code>stackql.py</code>.  We made this file in a directory name <code>ext</code> in the Jupyter working directory.    </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"write-the-magic-extension\">Write the magic extension<a class=\"hash-link\" href=\"#write-the-magic-extension\" title=\"Direct link to heading\">​</a></h2><p>Magic commands can be <strong>line-based</strong> or <strong>cell-based</strong> or <strong>line-or-cell-based</strong>; in this example, we will use line-or-cell-based magic, meaning the decorator <code>%stackql</code> will be used to evaluate a line of code and the <code>%%stackql</code> decorator will be used to evaluate the entire contents of the cell it is used in.    </p><p>The bare-bones class and function definitions required for this extension are described below:  </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-a-magic-class\">Create a Magic Class<a class=\"hash-link\" href=\"#create-a-magic-class\" title=\"Direct link to heading\">​</a></h3><p>We will need to define a <strong>magics class</strong>, which we will use to define the magic commands.  The class name is arbitrary, but it must be a subclass of <code>IPython.core.magic.Magics</code>.  An example is below:  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> IPython</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">core</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">magic </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Magics</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> magics_class</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> line_cell_magic</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">@magics_class</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">StackqlMagic</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Magics</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">@line_cell_magic</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">stackql</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> line</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> cell</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> cell </span><span class=\"token keyword\" style=\"color:#00009f\">is</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># do something with line</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">else</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># do something with cell</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> results</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"load-and-register-the-extension\">Load and register the extension<a class=\"hash-link\" href=\"#load-and-register-the-extension\" title=\"Direct link to heading\">​</a></h3><p>To register the magic functions in the <code>StackqlMagic</code> class we created above, use a function named <code>load_ipython_extension</code>, like the following:  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">load_ipython_extension</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">ipython</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    ipython</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">register_magics</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">StackqlMagic</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"complete-extension-code\">Complete extension code<a class=\"hash-link\" href=\"#complete-extension-code\" title=\"Direct link to heading\">​</a></h3><p>The complete code for our extension is shown here:  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> __future__ </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> print_function</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> pandas </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> pd</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> psycopg2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> json</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> psycopg2</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">extras </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> RealDictCursor</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> IPython</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">core</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">magic </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Magics</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> magics_class</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> line_cell_magic</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> io </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> StringIO</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> string </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Template</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">conn </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> psycopg2</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">connect</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"dbname=stackql user=stackql host=localhost port=5444\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">@magics_class</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">StackqlMagic</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Magics</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">get_rendered_query</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> data</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        t </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> Template</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">StringIO</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">data</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">read</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        rendered </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> t</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">substitute</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">shell</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">user_ns</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> rendered</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">run_query</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> query</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        cur </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> conn</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">cursor</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">cursor_factory</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">RealDictCursor</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        cur</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">execute</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">query</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        rows </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> cur</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">fetchall</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        cur</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">close</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> pd</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">read_json</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">json</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">dumps</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">rows</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">@line_cell_magic</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">stackql</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> line</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> cell</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> cell </span><span class=\"token keyword\" style=\"color:#00009f\">is</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            results </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run_query</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_rendered_query</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">line</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">else</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            results </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run_query</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get_rendered_query</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">cell</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> results            </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">load_ipython_extension</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">ipython</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    ipython</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">register_magics</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">StackqlMagic</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"load-the-magic-extension\">Load the magic extension<a class=\"hash-link\" href=\"#load-the-magic-extension\" title=\"Direct link to heading\">​</a></h2><p>To use our extension, we need to use the <code>%load_ext magic</code> command referencing the extension we created.  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\">load_ext ext</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">stackql</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Note that since our extension was a file named <code>stackql.py</code> in a directory named <code>ext</code> we reference it using <code>ext.stackql</code>.   </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"use-the-magic-function-in-a-cell\">Use the magic function in a cell<a class=\"hash-link\" href=\"#use-the-magic-function-in-a-cell\" title=\"Direct link to heading\">​</a></h2><p>To use the magic function in a cell (operating on all contents of the cell), we use the <code>%%</code> decorator, like:</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\">stackql</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">SHOW SERVICES IN azure</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"use-the-magic-function-on-a-line\">Use the magic function on a line<a class=\"hash-link\" href=\"#use-the-magic-function-on-a-line\" title=\"Direct link to heading\">​</a></h2><p>To use the magic function on a line, we use the <code>%</code> decorator, like:</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\">stackql DESCRIBE aws</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">ec2</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">instances</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><div class=\"theme-admonition theme-admonition-tip alert alert--success admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 12 16\"><path fill-rule=\"evenodd\" d=\"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z\"></path></svg></span>Using Variable Expansion</div><div class=\"admonitionContent_S0QG\"><p>In our example, we implemented variable expansion using the \"batteries included\" String templating capabilities in Python3.  This allows for variables to be set globally in our notebooks and then used in our queries.  For example, we can set a variable in a cell like:</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">project </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'stackql-demo'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">zone </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'australia-southeast1-a'</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Then use those variables in our queries like:  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\">stackql</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">SELECT status</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> count</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> num_instances</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">FROM google</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">compute</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">instances</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">WHERE project </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'$project'</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">AND zone </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'$zone'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">GROUP BY status</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div><p>An example is shown here:  </p><p><a target=\"_blank\" href=\"/assets/files/custom-jupyter-magic-command-6da8188974fc536fcf306c7e98aec312.png\"><img loading=\"lazy\" alt=\"Using a Custom Jupyter Magic Command\" src=\"/assets/images/custom-jupyter-magic-command-6da8188974fc536fcf306c7e98aec312.png\" width=\"1920\" height=\"1040\" class=\"img_ev3q\"></a></p><p>The complete code can be found at <a href=\"https://github.com/stackql/stackql-jupyter-demo\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>stackql/stackql-jupyter-demo</strong></a>.</p>",
            "url": "https://fullstackchronicles.io/create-and-use-custom-magic-commands-in-jupyter",
            "title": "Create and use Custom Magic Commands in Jupyter",
            "summary": "Quick example of creating and using a custom Jupyter magic command.",
            "date_modified": "2022-11-18T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "jupyter",
                "magic",
                "python",
                "ipython",
                "pandas",
                "postgresql",
                "sql",
                "postgres"
            ]
        },
        {
            "id": "deno-in-five-minutes",
            "content_html": "<p>Those who have built projects (front end or back end) with JavaScript or TypeScript would have no doubt felt pain or been frustrated with some aspect of package management - <code>package.json</code>, <code>package-lock.json</code>, <code>node_modules</code>, <code>npm</code>, <code>npmjs</code>, <code>yarn</code> etc.  </p><p>Enter <a href=\"https://deno.land/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Deno</strong></a>, a <em>\"package manager-less\"</em> runtime for JavaScript and TypeScript.  That's right, no <code>package.json</code>, no <code>node_modules</code> folder, no <code>npm</code> or <code>yarn</code>.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"background\">Background<a class=\"hash-link\" href=\"#background\" title=\"Direct link to heading\">​</a></h2><p>Deno was created by Ryan Dahl, the creator of Node.js, who realised the monster that was created with package management and managers, dependencies, and dependency management, which in many cases is more complex than the frameworks or projects that are being implemented.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"packages\">Packages<a class=\"hash-link\" href=\"#packages\" title=\"Direct link to heading\">​</a></h2><p>I said deno was <em>\"package manager-less\"</em>; however it is not <em>\"package-less\"</em>.  Deno does not use <code>npmjs</code>; instead, packages (js or ts) can be hosted at any reachable URL.  Local imports and exports are supported too.  </p><p>Deno's standard library packages (\"batteries included\" modules) are hosted at <a href=\"https://deno.land/std@0.153.0\" target=\"_blank\" rel=\"noopener noreferrer\">deno.land/std@LATEST_VERSION</a>, a third-party hosted library is available at <a href=\"https://deno.land/x\" target=\"_blank\" rel=\"noopener noreferrer\">deno.land/x</a>.  </p><p>With <code>deno</code> installed, you can run something like this:  </p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">deno run https://deno.land/std@0.154.0/examples/welcome.ts</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"imports\">Imports<a class=\"hash-link\" href=\"#imports\" title=\"Direct link to heading\">​</a></h2><p>Using the Deno runtime, developers specify modules to use in their program using this import syntax:  </p><div class=\"language-js codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-js codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword module\" style=\"color:#00009f\">import</span><span class=\"token plain\"> </span><span class=\"token imports punctuation\" style=\"color:#393A34\">{</span><span class=\"token imports\"> </span><span class=\"token imports maybe-class-name\">Application</span><span class=\"token imports punctuation\" style=\"color:#393A34\">,</span><span class=\"token imports\"> </span><span class=\"token imports maybe-class-name\">Router</span><span class=\"token imports\"> </span><span class=\"token imports punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"> </span><span class=\"token keyword module\" style=\"color:#00009f\">from</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"https://deno.land/x/oak/mod.ts\"</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>You can specify a version if desired in the URL, such as:</p><div class=\"language-js codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-js codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword module\" style=\"color:#00009f\">import</span><span class=\"token plain\"> </span><span class=\"token imports punctuation\" style=\"color:#393A34\">{</span><span class=\"token imports\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token imports\">  </span><span class=\"token imports maybe-class-name\">Bson</span><span class=\"token imports punctuation\" style=\"color:#393A34\">,</span><span class=\"token imports\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token imports\">  </span><span class=\"token imports maybe-class-name\">MongoClient</span><span class=\"token imports punctuation\" style=\"color:#393A34\">,</span><span class=\"token imports\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token imports\"></span><span class=\"token imports punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"> </span><span class=\"token keyword module\" style=\"color:#00009f\">from</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"https://deno.land/x/mongo@v0.31.0/mod.ts\"</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Packages <strong>do not</strong> have to be downloaded or installed before running your code.  </p><p>The first time your code is run, all packages are downloaded to a local cache and any Typescript modules are transpiled to JavaScript.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"publishing-with-deno-deploy\">Publishing with Deno Deploy<a class=\"hash-link\" href=\"#publishing-with-deno-deploy\" title=\"Direct link to heading\">​</a></h2><p>Deno deploy is a package publishing framework that directly integrates with GitHub (no separate npm publish step).  Deno deploy is backed by a CDN and a network of edge servers to make deno packages available.  Packages can be published by a push to a branch, reviewed via a deployed preview, and merged to release to production.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"quickstart\">Quickstart<a class=\"hash-link\" href=\"#quickstart\" title=\"Direct link to heading\">​</a></h2><p>To get going, you first need to download and install <code>deno</code>, which will vary based upon your operating system, but there are all the usual suspect installers available (homebrew, chocolatey, etc); see <a href=\"https://deno.land/#installation\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>here</strong></a>.  </p><p>Once you have installed <code>deno</code> on your system, you can create a project folder (<strong>no</strong> <code>npm init</code> or <code>package.json</code> required), and create the following file (as <code>server.ts</code>), which will run a very simple middleware server using a third-party module, <code>oak</code>.  </p><div class=\"language-js codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-js codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword module\" style=\"color:#00009f\">import</span><span class=\"token plain\"> </span><span class=\"token imports punctuation\" style=\"color:#393A34\">{</span><span class=\"token imports\"> </span><span class=\"token imports maybe-class-name\">Application</span><span class=\"token imports punctuation\" style=\"color:#393A34\">,</span><span class=\"token imports\"> </span><span class=\"token imports maybe-class-name\">Router</span><span class=\"token imports\"> </span><span class=\"token imports punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"> </span><span class=\"token keyword module\" style=\"color:#00009f\">from</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"https://deno.land/x/oak/mod.ts\"</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">const</span><span class=\"token plain\"> router </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Router</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">router</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">get</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"/ping\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token parameter\">context</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token arrow operator\" style=\"color:#393A34\">=&gt;</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    context</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token property-access\">response</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token property-access\">body</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"pong\"</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">const</span><span class=\"token plain\"> app </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Application</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">app</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">use</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">router</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">routes</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">app</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">use</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">router</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">allowedMethods</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword control-flow\" style=\"color:#00009f\">await</span><span class=\"token plain\"> app</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">listen</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"> </span><span class=\"token literal-property property\" style=\"color:#36acaa\">port</span><span class=\"token operator\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">8080</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>now run your server using the following command:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">deno run --allow-net server.ts</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>now:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">curl -XGET http://localhost:8080/ping</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>should return:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">pong</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>easy!</p>",
            "url": "https://fullstackchronicles.io/deno-in-five-minutes",
            "title": "Deno in 5 Minutes",
            "summary": "A five minute introduction to Deno, a \"package manager-less\" runtime for TypeScript and JavaScript.",
            "date_modified": "2022-09-05T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "deno",
                "javascript",
                "typescript",
                "nodejs"
            ]
        },
        {
            "id": "dbt-in-five-minutes",
            "content_html": "<p><a href=\"https://docs.getdbt.com/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>DBT (or Data Build Tool)</strong></a> is a modern data transformation tool born in the cloud/DevOps era. It's a great project which much has been written about; I will try to give as brief an overview as possible.  </p><details class=\"details_lb9f alert alert--info details_b_Ee\" data-collapsed=\"true\"><summary>ETL vs ELT Refresher</summary><div><div class=\"collapsibleContent_i85q\"><p>A quick refresher on ELT vs ETL before we discuss DBT. I have created an infographic for this...</p><a target=\"_blank\" href=\"/img/blog/dbt-in-five-minutes/etl-vs-elt.png\"><img loading=\"lazy\" alt=\"ETL vs ELT\" src=\"/img/blog/dbt-in-five-minutes/etl-vs-elt.png\" width=\"595\" height=\"410\" class=\"img_node_modules-@docusaurus-theme-classic-lib-theme-MDXComponents-Img-styles-module\"></a></div></div></details><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"summary\">Summary<a class=\"hash-link\" href=\"#summary\" title=\"Direct link to heading\">​</a></h2><p>DBT is an open-source command line tool written in Python from DBT Labs (formerly Fishtown Analytics).  </p><p>DBT is designed to manage data transformations while applying software engineering best practices (including version control, automated testing, reviews, approvals, etc).  Its modern software engineering and cloud-first design goals separate it from its old-school ETL/ELT predecessors.  </p><p>DBT is an <strong>ELT</strong> tool focusing on the <strong>T</strong>(ransform) only, the E(xtract) and L(oad) are up to you (there are plenty of tools that specialize in this).  </p><p>At its core DBT is a templating engine using Jinja (Python templating engine); it generates templates that represent SQL commands to create, replace or update objects in your database (the <strong>“T”</strong> in ELT), then oversees the execution of the templated commands.  The work is \"pushed down\" to the underlying database containing the source and target objects and data.   </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"models\">Models<a class=\"hash-link\" href=\"#models\" title=\"Direct link to heading\">​</a></h2><p>The concept most integral to DBT is the <a href=\"https://docs.getdbt.com/docs/building-a-dbt-project/building-models\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Model</strong></a>.  A Model is simply a representation of a transform (or set of transforms) to a dataset, resulting in a target object (which could be a table or tables in a datamart).  A model is expressed as a <code>SELECT</code> statement stored in a <code>.sql</code> file in your <code>dbt</code> project (well get to that in a minute).  </p><p>Suppose we want to create a denormalized fact table for commits to store in a datamart in BigQuery.  This is what a model file might look like (using the BigQuery SQL dialect and referencing objects that should exist and be accessible at runtime when we execute the model).  </p><div class=\"language-sql codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sql codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">{{ config</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">materialized</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">'table'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> }}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">with</span><span class=\"token plain\"> commits </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">SELECT</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    SUBSTR</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">commit</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">13</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> commit_short_sha</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    committer</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">name </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> commiter_name</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    committer</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token keyword\" style=\"color:#00009f\">date</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> commit_date</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    message</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    repo_name</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">FROM</span><span class=\"token plain\"> </span><span class=\"token identifier punctuation\" style=\"color:#393A34\">`</span><span class=\"token identifier\">bigquery-public-data.github_repos.sample_commits</span><span class=\"token identifier punctuation\" style=\"color:#393A34\">`</span><span class=\"token plain\"> c</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">select</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> commits</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Models are created as views by default, but you can materialize these as tables where needed.  </p><p>You configure connectivity to the target database using <a href=\"https://docs.getdbt.com/docs/available-adapters\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>adapters</strong></a> (software libraries provided by dbt in the case of most mainstream databases) and <a href=\"https://docs.getdbt.com/dbt-cli/configure-your-profile\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>profiles</strong></a> (which contain details around authentication, databases/datasets, schemas etc).  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"dbt-project\">DBT Project<a class=\"hash-link\" href=\"#dbt-project\" title=\"Direct link to heading\">​</a></h2><p>A DBT project is simply a folder containing your models and some other configuration data.  You can initialize this by running <a href=\"https://docs.getdbt.com/reference/commands/init\" target=\"_blank\" rel=\"noopener noreferrer\"><strong><code>dbt init</code></strong></a> from your desired project directory.  In its most basic form, the structure looks like this:  </p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">models/</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">├─ your_model.sql</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">├─ schema.yml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">dbt_project.yml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Your models can be created under subfolders for organization.  <a href=\"https://docs.getdbt.com/reference/resource-configs/schema\" target=\"_blank\" rel=\"noopener noreferrer\"><strong><code>schema.yml</code></strong></a> is an optional file that  contains tests for columns, can also include descriptions for documentation.  The <a href=\"https://docs.getdbt.com/reference/dbt_project.yml\" target=\"_blank\" rel=\"noopener noreferrer\"><strong><code>dbt_project.yml</code></strong></a> file is the main entry point for the <code>dbt</code> program, it contains the configuration for the project, including which <code>profile</code> to use.  Profiles (stored in a file called <a href=\"https://docs.getdbt.com/reference/profiles.yml\" target=\"_blank\" rel=\"noopener noreferrer\"><strong><code>profiles.yml</code></strong></a> store all of the necessary connectivity information for your target database platform.  By default <code>dbt init</code> creates this file a <code>.dbt</code> folder under your home directory.  </p><div class=\"theme-admonition theme-admonition-info alert alert--info admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_S0QG\"><p>You could store this with your project (be careful not to commit secrets like database credentials to source control).  If you store it in any other directory than the default, you will need to tell <code>dbt</code> where it can find this file using the <code>--profiles-dir</code> argument of any <code>dbt</code> command, see <a href=\"https://docs.getdbt.com/dbt-cli/configure-your-profile#advanced-customizing-a-profile-directory\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>here</strong></a> for more information.</p></div></div><p>To confirm your project is ship shape, run <a href=\"https://docs.getdbt.com/reference/commands/parse\" target=\"_blank\" rel=\"noopener noreferrer\"><strong><code>dbt parse</code></strong></a>; if there are no errors, you are good to proceed running and testing your models.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"running-dbt-models\">Running DBT Models<a class=\"hash-link\" href=\"#running-dbt-models\" title=\"Direct link to heading\">​</a></h2><p>To run your models, simply run the following command from the directory containing your <code>dbt_project.yml</code> file (typically the root of your project folder):  </p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Command</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">Output</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><pre tabindex=\"0\" class=\"codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><b><a href=\"https://docs.getdbt.com/reference/commands/run\" target=\"_blank\" rel=\"noopener noreferrer\">dbt run</a></b></code></pre></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><pre tabindex=\"0\" class=\"codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\">06:56:36  Running with dbt=1.2.0<br>06:56:36  Found 1 model, 2 tests, 0 snapshots, 0 analyses, 285 macros, 0 operations, 0 seed files, 0 sources, 0 exposures, 0 metrics<br>06:56:36<br>06:56:37  Concurrency: 1 threads (target='dev')<br>06:56:37<br>06:56:37  1 of 1 START table model dbt_dataset.fct_commits ............................... [RUN]<br>06:56:50  1 of 1 OK created table model dbt_dataset.fct_commits .......................... [CREATE TABLE (672.3k rows, 396.7 MB processed) in 13.28s]<br>06:56:50<br>06:56:50  Finished running 1 table model in 0 hours 0 minutes and 14.01 seconds (14.01s).<br>06:56:50<br>06:56:50  Completed successfully<br>06:56:50<br>06:56:50  Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1</code></pre></div></div></div><p>Model deployed!  Let's test it:   </p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Command</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">Output</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><pre tabindex=\"0\" class=\"codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\"><b><a href=\"https://docs.getdbt.com/reference/commands/test\" target=\"_blank\" rel=\"noopener noreferrer\">dbt test</a></b></code></pre></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><pre tabindex=\"0\" class=\"codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\">06:57:19  Running with dbt=1.2.0<br>06:57:19  Found 1 model, 2 tests, 0 snapshots, 0 analyses, 285 macros, 0 operations, 0 seed files, 0 sources, 0 exposures, 0 metrics<br>06:57:19<br>06:57:19  Concurrency: 1 threads (target='dev')<br>06:57:19<br>06:57:19  1 of 2 START test not_null_fct_commits_commit_short_sha ........................ [RUN]<br>06:57:21  1 of 2 PASS not_null_fct_commits_commit_short_sha .............................. [PASS in 1.88s]<br>06:57:21  2 of 2 START test unique_fct_commits_commit_short_sha .......................... [RUN]<br>06:57:24  2 of 2 PASS unique_fct_commits_commit_short_sha ................................ [PASS in 3.14s]<br>06:57:24<br>06:57:24  Finished running 2 tests in 0 hours 0 minutes and 5.41 seconds (5.41s).<br>06:57:24<br>06:57:24  Completed successfully<br>06:57:24<br>06:57:24  Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2</code></pre></div></div></div><p>This will run all of the tests associated with your model(s) - in this case, <code>not null</code> and <code>unique</code> tests defined in the <code>schema.yml</code> file.  That's it, deployed and tested.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"other-stuff\">Other Stuff<a class=\"hash-link\" href=\"#other-stuff\" title=\"Direct link to heading\">​</a></h2><p>There is some other stuff in DBT you should be aware of, like <code>seeds</code>, <code>snapshots</code>, <code>analyses</code>, <code>macros</code>, and more but our five minutes is up 😃.  We can discuss these next time; you are up and running with the basics of DBT now, get transforming!</p>",
            "url": "https://fullstackchronicles.io/dbt-in-five-minutes",
            "title": "DBT in 5 Minutes",
            "summary": "This article gives a quick and straightforward introduction to dbt - the Data Build Tool - with examples using BigQuery.",
            "date_modified": "2022-08-05T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "dbt",
                "elt",
                "etl",
                "sql",
                "snowflake",
                "bigquery"
            ]
        },
        {
            "id": "loading-parquet-files-into-snowflake",
            "content_html": "<p>Loading Parquet format files into BigQuery is straightforward, you just need to specify the file location (local, Google Cloud Storage, Drive, Amazon S3 or Azure Blob storage) and thats pretty much it, BigQuery works the rest out from there.  </p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">bq load \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--location=australia-southeast2 \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--project_id=parquet-demo \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--source_format=PARQUET \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">parquet_test.dim_calendar \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">.\\Calendar.gzip</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>In Snowflake, however, it is not as simple, I'll share my approach to automating this here.  </p><div class=\"theme-admonition theme-admonition-info alert alert--info admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_S0QG\"><p>Parquet is a self-describing, column-oriented storage format commonly used in distributed systems for input and output.  Data in Parquet files is serialised for optimised consumption from Parquet client libraries and packages such as <code>pandas</code>, <code>pyarrow</code>, <code>fastparquet</code>, <code>dask</code>, and <code>pyspark</code>.</p></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"background\">Background<a class=\"hash-link\" href=\"#background\" title=\"Direct link to heading\">​</a></h2><p>Data in a Parquet file is stored in a single column for a self-contained dataset.  If you were to ingest this into Snowflake without knowing the schema you could do something like this...   </p><div class=\"language-sql codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sql codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">CREATE</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">OR</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">REPLACE</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">TABLE</span><span class=\"token plain\"> PARQUET_TEST</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token keyword\" style=\"color:#00009f\">PUBLIC</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">DIM_CALENDAR </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token keyword\" style=\"color:#00009f\">Data</span><span class=\"token plain\"> variant</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">COPY </span><span class=\"token keyword\" style=\"color:#00009f\">INTO</span><span class=\"token plain\"> PARQUET_TEST</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token keyword\" style=\"color:#00009f\">PUBLIC</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">DIM_CALENDAR </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token keyword\" style=\"color:#00009f\">Data</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">FROM</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">SELECT</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">FROM</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:#36acaa\">@PARQUET_TEST.PUBLIC.DIM_CALENDAR_STAGE</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  file_format </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">TYPE</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> parquet</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>You would end up with something like...   </p><table><thead><tr><th><code>Row</code></th><th><code>Data</code></th></tr></thead><tbody><tr><td><code>1</code></td><td><code>{\"CalMonthOfYearNo\": 6, \"CalYear\": 2020, ... }</code></td></tr><tr><td><code>2</code></td><td><code>{\"CalMonthOfYearNo\": 6, \"CalYear\": 2020, ... }</code></td></tr><tr><td><code>...</code></td><td><code>...</code></td></tr></tbody></table><p>You could then have a second stage of processing to convert this into a normal relational structure.  </p><p>Or you could do this in one step, with a little prep work ahead of time.  In my scenario I was given several parquet files from a client for a one-off load into Snowflake, several files for a fact table and multiple single files representing different dimension tables.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"streamlined-ingestion-for-parquet-files-into-snowflake\">Streamlined Ingestion for Parquet Files into Snowflake<a class=\"hash-link\" href=\"#streamlined-ingestion-for-parquet-files-into-snowflake\" title=\"Direct link to heading\">​</a></h2><p>To collapse the formatting and uploading of Parquet files into a materialized table into one step, we need to do a couple of things:  </p><ol><li>Create the target table with the correct schema (column names and data types); and</li><li>perform a projection in our <code>COPY</code> command from the single column containing all of the data (represented by <code>$1</code> in Snowflake) into columns defined in step 1</li></ol><p>Since this is technically a transformation and only named stages are supported for <code>COPY</code> transformations, we need to create a stage for the copy.  In my case there is a pre-existing Storage Integration in place that can be used by the stage.  </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"generate-table-ddl\">Generate Table DDL<a class=\"hash-link\" href=\"#generate-table-ddl\" title=\"Direct link to heading\">​</a></h3><p>To automate the generation of the DDL to create the table and stage and the <code>COPY</code> command, I used Python and Spark (which has first class support for Parquet files).  Parquet datatypes are largely the same as Snowflake, but if we needed to, we could create a map and modify the target types during the DDL generation.  </p><p>First copy specimen Parquet formatted files to a local directory, the script we are creating can then iterate through the parquet files and generate all of the commands we will need saved to a <code>.sql</code> file.  </p><p>With some setup information provided (not shown for brevity), we will first go through each file in the directory, capture metadata along with the schema (column name and data type) as shown here:  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> </span><span class=\"token builtin\">file</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> files</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tableMap </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    table </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token builtin\">file</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">stem</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    spark </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> launch_spark_session</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    parquetFile </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> spark</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">read</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">parquet</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"%s/%s\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">BASE_DIR</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">file</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    data_types </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> parquetFile</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">dtypes</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    stop_spark_session</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">spark</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tableMap</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> table</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tableMap</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'file'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token builtin\">file</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tableMap</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'data_types'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> data_types</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    allTables</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">append</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">tableMap</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>The <code>allTables</code> list looks something like this...  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'Calendar'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'file'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> PosixPath</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'data/dim/Calendar.gzip'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'data_types'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'Time_ID'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'bigint'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'CalYear'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'bigint'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'CalMonthOfYearNo'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'bigint'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'FinYear'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'bigint'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'FinWeekOfYearNo'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'bigint'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Next we generate the <code>CREATE TABLE</code> statement using the <code>allTables</code> list:  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># create output file for all sql</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">with</span><span class=\"token plain\"> </span><span class=\"token builtin\">open</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'all_tables.sql'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'w'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> f</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> table </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> allTables</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"processing %s...\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"/*** Create %s Table***/\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">upper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">\"\"\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">CREATE OR REPLACE TABLE %s.%s.%s (</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">\"\"\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">database</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> schema</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">upper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> column </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'data_types'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            sql </span><span class=\"token operator\" style=\"color:#393A34\">+=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"  %s %s,\\n\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">column</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> column</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> sql</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"\\n);\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">sql</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"\\n\\n\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"generate-named-stage-ddl\">Generate Named Stage DDL<a class=\"hash-link\" href=\"#generate-named-stage-ddl\" title=\"Direct link to heading\">​</a></h3><p>Then we generate the stage in S3 from which the files will be loaded:  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"/*** Create %s Stage***/\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">upper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">\"\"\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">CREATE OR REPLACE STAGE %s.%s.%s_STAGE </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">  url='%s/%s'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">  storage_integration = %s</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">  encryption=(type='AWS_SSE_KMS' kms_key_id = '%s');</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">\"\"\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">database</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> schema</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">upper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> s3_prefix</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'file'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> storage_int</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> kms_key_id</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">sql</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"\\n\\n\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"generate-copy-commands\">Generate <code>COPY</code> commands<a class=\"hash-link\" href=\"#generate-copy-commands\" title=\"Direct link to heading\">​</a></h3><p>Then we generate the <code>COPY</code> commands...  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"/*** Copying Data into %s ***/\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">upper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">\"\"\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">COPY INTO %s.%s.%s </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">(\\n\"\"\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">database</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> schema</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">upper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> column </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'data_types'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            sql </span><span class=\"token operator\" style=\"color:#393A34\">+=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"  %s,\\n\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> column</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> sql</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"\\n)\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql </span><span class=\"token operator\" style=\"color:#393A34\">+=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\" FROM (\\nSELECT\\n\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> column </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'data_types'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            sql </span><span class=\"token operator\" style=\"color:#393A34\">+=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"  $1:%s::%s,\\n\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">column</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> column</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> sql</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"\\nFROM\\n\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql </span><span class=\"token operator\" style=\"color:#393A34\">+=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"@%s.%s.%s_STAGE)\\n\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">database</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> schema</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">upper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql </span><span class=\"token operator\" style=\"color:#393A34\">+=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"  file_format = (TYPE = parquet);\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">sql</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"\\n\\n\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Since this is a one off load, we will go ahead and drop the stage we created as it is no longer needed (this step is optional)..</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"/*** Dropping stage for %s ***/\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">upper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">\"\"\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">DROP STAGE %s.%s.%s_STAGE; </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">\"\"\"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">%</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">database</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> schema</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> table</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">upper</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">sql</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">write</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"\\n\\n\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>The resultant file created looks like this..</p><div class=\"language-sql codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sql codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\">/*** Create CALENDAR Table***/</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">CREATE</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">OR</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">REPLACE</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">TABLE</span><span class=\"token plain\"> PARQUET_TEST</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token keyword\" style=\"color:#00009f\">PUBLIC</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">DIM_CALENDAR </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  Time_ID </span><span class=\"token keyword\" style=\"color:#00009f\">bigint</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  CalYear </span><span class=\"token keyword\" style=\"color:#00009f\">bigint</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  CalMonthOfYearNo </span><span class=\"token keyword\" style=\"color:#00009f\">bigint</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  FinYear </span><span class=\"token keyword\" style=\"color:#00009f\">bigint</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  FinWeekOfYearNo </span><span class=\"token keyword\" style=\"color:#00009f\">bigint</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">/*** Create DIM_CALENDAR Stage***/</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">CREATE</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">OR</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">REPLACE</span><span class=\"token plain\"> STAGE PARQUET_TEST</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token keyword\" style=\"color:#00009f\">PUBLIC</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">DIM_CALENDAR_STAGE </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  url</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">'s3://my-bucket/data/dim/Calendar.gzip'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  storage_integration </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> my_storage_int</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  encryption</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">type</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">'AWS_SSE_KMS'</span><span class=\"token plain\"> kms_key_id </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'4f715ec9-ee8e-44ab-b35d-8daf36c05f19'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">/*** Copying Data into DIM_CALENDAR ***/</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">COPY </span><span class=\"token keyword\" style=\"color:#00009f\">INTO</span><span class=\"token plain\"> PARQUET_TEST</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token keyword\" style=\"color:#00009f\">PUBLIC</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">DIM_CALENDAR </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  Time_ID</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  CalYear</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  CalMonthOfYearNo</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  FinYear</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  FinWeekOfYearNo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">FROM</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">SELECT</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  $</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\">:Time_ID::</span><span class=\"token keyword\" style=\"color:#00009f\">bigint</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  $</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\">:CalYear::</span><span class=\"token keyword\" style=\"color:#00009f\">bigint</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  $</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\">:CalMonthOfYearNo::</span><span class=\"token keyword\" style=\"color:#00009f\">bigint</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  $</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\">:FinYear::</span><span class=\"token keyword\" style=\"color:#00009f\">bigint</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  $</span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\">:FinWeekOfYearNo::</span><span class=\"token keyword\" style=\"color:#00009f\">bigint</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">FROM</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:#36acaa\">@PARQUET_TEST.PUBLIC.DIM_CALENDAR_STAGE</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  file_format </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">TYPE</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> parquet</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">/*** Dropping stage for DIM_CALENDAR ***/</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">DROP</span><span class=\"token plain\"> STAGE PARQUET_TEST</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token keyword\" style=\"color:#00009f\">PUBLIC</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">DIM_CALENDAR_STAGE</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"> </span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"load-your-data\">Load your data<a class=\"hash-link\" href=\"#load-your-data\" title=\"Direct link to heading\">​</a></h3><p>You can then run this along with all of the other dimension and fact table DDL and COPY commands generated to perform the one-off load from parquet files. You can find the complete code below, enjoy!  </p><details class=\"details_lb9f alert alert--info details_b_Ee\" data-collapsed=\"true\"><summary>Complete Code</summary><div><div class=\"collapsibleContent_i85q\"><pre tabindex=\"0\" class=\"codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><code class=\"codeBlockLines_e6Vv\">from pathlib import Path<br>from pyspark.sql import SparkSession</code></pre><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">def launch_spark_session():</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    return SparkSession \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        .builder \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        .appName(\"Parquet DDL Generation\") \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        .getOrCreate()</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">def stop_spark_session(spark):</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    spark.stop()</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">allTables = []</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">database = \"PARQUET_TEST\" </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">schema = \"PUBLIC\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">s3_prefix = 's3://my-bucket'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">storage_int = 'my_storage_int'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">kms_key_id = '4f715ec9-ee8e-44ab-b35d-8daf36c05f19'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">BASE_DIR = Path(__file__).resolve().parent</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">directory = 'data/dim'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">files = Path(directory).glob('*.gzip')</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">for file in files:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tableMap = {}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    table = file.stem</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    spark = launch_spark_session()</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    parquetFile = spark.read.parquet(\"%s/%s\" %(BASE_DIR, file))</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    data_types = parquetFile.dtypes</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    stop_spark_session(spark)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tableMap['name'] = table</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tableMap['file'] = file</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tableMap['data_types'] = data_types</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    allTables.append(tableMap)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create output file for all sql</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">with open('all_tables.sql', 'w') as f:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    for table in allTables:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        print(\"processing %s...\" % table['name'])</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(\"/*** Create %s Table***/\" % table['name'].upper())</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql = \"\"\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">CREATE OR REPLACE TABLE %s.%s.%s (</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\"\"\" % (database, schema, table['name'].upper())</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        for column in table['data_types']:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            sql += \"  %s %s,\\n\" % (column[0], column[1])</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql = sql[:-2] + \"\\n);\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(sql)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(\"\\n\\n\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(\"/*** Create %s Stage***/\" % table['name'].upper())</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql = \"\"\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">CREATE OR REPLACE STAGE %s.%s.%s_STAGE </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  url='%s/%s'</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  storage_integration = %s</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  encryption=(type='AWS_SSE_KMS' kms_key_id = '%s');</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\"\"\" % (database, schema, table['name'].upper(), s3_prefix, table['file'], storage_int, kms_key_id)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(sql)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(\"\\n\\n\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(\"/*** Copying Data into %s ***/\" % table['name'].upper())</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql = \"\"\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">COPY INTO %s.%s.%s </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">(\\n\"\"\" % (database, schema, table['name'].upper())</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        for column in table['data_types']:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            sql += \"  %s,\\n\" % column[0]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql = sql[:-2] + \"\\n)\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql += \" FROM (\\nSELECT\\n\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        for column in table['data_types']:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            sql += \"  $1:%s::%s,\\n\" % (column[0], column[1])</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql = sql[:-2] + \"\\nFROM\\n\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql += \"@%s.%s.%s_STAGE)\\n\" % (database, schema, table['name'].upper()) </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql += \"  file_format = (TYPE = parquet);\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(sql)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(\"\\n\\n\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(\"/*** Dropping stage for %s ***/\" % table['name'].upper())</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        sql = \"\"\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">DROP STAGE %s.%s.%s_STAGE; </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">\"\"\" % (database, schema, table['name'].upper())</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(sql)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        f.write(\"\\n\\n\")</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></details>",
            "url": "https://fullstackchronicles.io/loading-parquet-files-into-snowflake",
            "title": "Loading Parquet Files into Snowflake",
            "summary": "This article demonstrates how to automate and streamline the ingestion of Parquet formatted files into Snowflake.",
            "date_modified": "2022-07-30T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "snowflake",
                "parquet",
                "python",
                "spark",
                "pyspark",
                "bigquery"
            ]
        },
        {
            "id": "analyze-developer-activity-with-stackql-jupyter-bigquery",
            "content_html": "<p>It is common to have a remote and dispersed team these days. As face to face meetings are less common and with geographically dispersed development teams not possible, it is challenging to have a clear picture of where your team is.  </p><p>GitHub provides useful data to help us understand your development team's workload and progress.  StackQL has an official GitHub provider which allows you to access this data using SQL. </p><div class=\"theme-admonition theme-admonition-info alert alert--info admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_S0QG\"><p>StackQL is an open source project which enables you to query, analyze and interact with cloud and SaaS provider resources using SQL, see <a href=\"https://stackql.io/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>stackql.io</strong></a> </p></div></div><p>In this example we will use the <a href=\"https://github.com/stackql/pystackql\" target=\"_blank\" rel=\"noopener noreferrer\"><code>pystackql</code></a> Python package (Python wrapper for StackQL) along with a Jupyter Notebook to retrieve data from GitHub using SQL, then sink the data into a cloud native data warehouse for long term storage and analytics at scale, in this example we have used <a href=\"https://cloud.google.com/bigquery\" target=\"_blank\" rel=\"noopener noreferrer\">BigQuery</a>.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-by-step-guide\">Step by Step Guide<a class=\"hash-link\" href=\"#step-by-step-guide\" title=\"Direct link to heading\">​</a></h2><p>This guide will walk you through the steps involved in capturing and analyzing developer data using StackQL, Python, Jupyter and BigQuery.  </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"1-create-github-personal-access-token\">1. Create GitHub Personal Access Token<a class=\"hash-link\" href=\"#1-create-github-personal-access-token\" title=\"Direct link to heading\">​</a></h3><p>You will need to create a Personal Access Token in GitHub for a user which has access to the org or orgs in GitHub you will be analyzing.  Follow <a href=\"https://docs.github.com/en/enterprise-server@3.4/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token\" target=\"_blank\" rel=\"noopener noreferrer\">this guide</a> to create your GitHub token and store it somewhere safe.  </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"2-setup-your-jupyter-notebook\">2. Setup your Jupyter Notebook<a class=\"hash-link\" href=\"#2-setup-your-jupyter-notebook\" title=\"Direct link to heading\">​</a></h3><p>You need to set up your Jupyter environment, you can either use the Docker, see <a href=\"https://github.com/stackql/stackql-jupyter-demo\" target=\"_blank\" rel=\"noopener noreferrer\">stackql/stackql-jupyter-demo</a> or:  </p><ol><li><a href=\"https://jupyter.org/try\" target=\"_blank\" rel=\"noopener noreferrer\">Create your Jupyter project</a></li><li><a href=\"https://stackql.io/downloads\" target=\"_blank\" rel=\"noopener noreferrer\">Download and install StackQL</a></li><li><a href=\"https://github.com/stackql/pystackql\" target=\"_blank\" rel=\"noopener noreferrer\">Clone the pystackql repo</a></li></ol><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"3-setup-stackql-authentication-to-github\">3. Setup StackQL Authentication to GitHub<a class=\"hash-link\" href=\"#3-setup-stackql-authentication-to-github\" title=\"Direct link to heading\">​</a></h3><p>You can find instructions on how to use your personal access token to authenticate to GitHub <a href=\"https://registry.stackql.io/providers/github/#authentication\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.  The following example shows how to do this in a Jupyter notebook cell using <code>pystackql</code>.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-18e9de9c1a184a5d3e7d623d4681ceb3\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"4-retrieve-data\">4. Retrieve data<a class=\"hash-link\" href=\"#4-retrieve-data\" title=\"Direct link to heading\">​</a></h3><p>Next, we will use StackQL SQL queries to get commits, pull requests and pull request reviews, then we will aggregate by usernames of contributors. You can use <code>JOIN</code> semantics in StackQL to do this as well.  </p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"get-contributors-commits-pull-requests-and-reviews\">Get Contributors, Commits, Pull Requests and Reviews<a class=\"hash-link\" href=\"#get-contributors-commits-pull-requests-and-reviews\" title=\"Direct link to heading\">​</a></h4><p>In the following cell we will query data from GitHub using StackQL:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-29da46f9428ea7c2dcb53fdded019785\"></iframe><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"aggregate-data-by-username\">Aggregate Data By Username<a class=\"hash-link\" href=\"#aggregate-data-by-username\" title=\"Direct link to heading\">​</a></h4><p>Now we will aggregate the data by each contributor, see the following example:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-4414fcf6bdd6aff4d227c07b461887e6\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"5-store-the-data-in-bigquery\">5. Store the Data in BigQuery<a class=\"hash-link\" href=\"#5-store-the-data-in-bigquery\" title=\"Direct link to heading\">​</a></h3><p>After the transformation of data, we will then upload it to BigQuery.  First, we will store the data as a new line delimited <code>json</code> file, making the uploading process much easier and handling the nested schema better, as shown in the following cell:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-34ac71d46030693bbaa3c7c4309855f5\"></iframe><p>Now we can see the table on BigQuery as shown here:  </p><p><a target=\"_blank\" href=\"/assets/files/bq-user-activity-e0f591dad575e7c819b89c1e0024fdf7.png\"><img loading=\"lazy\" alt=\"BigQuery User Activity Table\" src=\"/assets/images/bq-user-activity-e0f591dad575e7c819b89c1e0024fdf7.png\" width=\"1612\" height=\"1202\" class=\"img_ev3q\"></a></p><p>From here you can use the same process to append data to the table and use BigQuery to perform analytics at scale on the data.</p><div class=\"theme-admonition theme-admonition-info alert alert--info admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_S0QG\"><p>The complete notebook for this article can be accessed at <a href=\"https://github.com/FabioYyc/stackql-github-notebook-bq\" target=\"_blank\" rel=\"noopener noreferrer\">FabioYyc/stackql-github-notebook-bq</a> </p></div></div>",
            "url": "https://fullstackchronicles.io/analyze-developer-activity-with-stackql-jupyter-bigquery",
            "title": "Analyze Developer Activity with StackQL, Jupyter and BigQuery",
            "summary": "This article demonstrates how to use StackQL, Jupyter and BigQuery to analyze developer data from GitHub.",
            "date_modified": "2022-07-24T00:00:00.000Z",
            "author": {
                "name": "Yuncheng Yang",
                "url": "https://www.linkedin.com/in/yuncheng-fabio-yang/"
            },
            "tags": [
                "stackql",
                "github",
                "sql",
                "jupyter",
                "bigquery"
            ]
        },
        {
            "id": "converting-google-discovery-docs-to-openapi3-specs",
            "content_html": "<p>This article walks through the process of converting service specific OpenAPI specifications from Google Discovery REST URLs using Python.  </p><blockquote><p>Full code for this article can be found at <a href=\"https://github.com/stackql/google-discovery-to-openapi\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>stackql/google-discovery-to-openapi</strong></a>  </p></blockquote><p>Google publishes JSON specifications for all of their APIs (including GCP services as well as other APIs associated with other products - like analytics or workspace).  These specifications can be accessed without authentication starting with the root document (<a href=\"https://discovery.googleapis.com/discovery/v1/apis\" target=\"_blank\" rel=\"noopener noreferrer\">https://discovery.googleapis.com/discovery/v1/apis</a>) which contains metadata and the URL for each service specific document (for services like <code>compute</code> or <code>storage</code>).</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"code-overview\">Code Overview<a class=\"hash-link\" href=\"#code-overview\" title=\"Direct link to heading\">​</a></h2><p>The program fetches the service document for each service that is included and not explicitly excluded (configured through variables in the program).  Non preferred services (beta or alpha versions) can be included by setting the variable <code>get_preferred_only</code> to <code>False</code>.  </p><p>An OpenAPI spec is constructed for each service based upon the data in the service discovery doc.  In many cases this is a straightforward one to one mapping, such as to top level <code>info</code>, <code>title</code> and <code>description</code> values, it gets more complicated with parameters and schemas where some extra logic is required to keep the json pointers (<code>$ref</code>) valid.  </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"extracting-paths-and-verbs\">Extracting Paths and Verbs<a class=\"hash-link\" href=\"#extracting-paths-and-verbs\" title=\"Direct link to heading\">​</a></h3><p>The real magic is in extracting paths and verbs in a compliant OpenAPI format, as Google nests this data (potentially multiple levels deep) under resources.  </p><p>The first step is to identify <code>methods</code> nested under a <code>resources</code> object (which can be mapped to operations - with a path and HTTP verb required to populate an OpenAPI spec), this function does this:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-11ee413049cdcd81a433d4df8925c016\"></iframe><p>Now each method can be processed yielding an operation (combination of <code>path</code> and <code>verb</code>), this is done using this function:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-2ffd64aa8ba07a8f9ccd441ed9709ef3\"></iframe><p>Full source code can be found at <a href=\"https://github.com/stackql/google-discovery-to-openapi\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>stackql/google-discovery-to-openapi</strong></a>.</p>",
            "url": "https://fullstackchronicles.io/converting-google-discovery-docs-to-openapi3-specs",
            "title": "Converting Google Discovery Docs to OpenAPI3 Specs",
            "date_modified": "2022-06-24T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "openapi",
                "openapi3",
                "googlecloud",
                "gcp",
                "swagger"
            ]
        },
        {
            "id": "recurse-javascript-object-to-get-values-for-a-given-key-the-easy-way",
            "content_html": "<p>I had a scenario where I needed to find values for a key in a complex JavaScript object which could be nested <strong><em>n</em></strong> levels deep.  </p><p>I found numerous approaches to doing this, most were overly complicated, so I thought I would share the most straightforward, concise process.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-code\">the Code<a class=\"hash-link\" href=\"#the-code\" title=\"Direct link to heading\">​</a></h2><p>You can do this in a straightforward function implementing the <strong><em>\"tail call recursion\"</em></strong> pattern to search for a key (<code>key</code>) from the root of an object (<code>obj</code>), excluding any keys in <code>excludeKeys</code>.  </p><p>This will return a list of values for the given key, searching all levels in all branches of the object.   </p><div class=\"language-javascript codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-javascript codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">function</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getAllValuesForKey</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token parameter\">obj</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">,</span><span class=\"token parameter\"> key</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">,</span><span class=\"token parameter\"> excludeKeys</span><span class=\"token parameter operator\" style=\"color:#393A34\">=</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">[</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">]</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">,</span><span class=\"token parameter\"> values</span><span class=\"token parameter operator\" style=\"color:#393A34\">=</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">[</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">for</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> k </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> obj</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">typeof</span><span class=\"token plain\"> obj</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">k</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">===</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"object\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">if</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">!</span><span class=\"token plain\">excludeKeys</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">includes</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">k</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                </span><span class=\"token function\" style=\"color:#d73a49\">getAllValuesForKey</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">obj</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">k</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> key</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> excludeKeys</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> values</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"> </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">else</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">k </span><span class=\"token operator\" style=\"color:#393A34\">===</span><span class=\"token plain\"> key</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                values</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">push</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">obj</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">k</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">return</span><span class=\"token plain\"> values</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"example\">Example<a class=\"hash-link\" href=\"#example\" title=\"Direct link to heading\">​</a></h2><p>In parsing an OpenAPI or Swagger specification, I am looking for all of the schema <code>refs</code> in a successful response body, for example:  </p><div class=\"language-yaml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-yaml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token key atrule\" style=\"color:#00a4db\">paths</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">'/orgs/{org}/actions/permissions/selected-actions'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token key atrule\" style=\"color:#00a4db\">get</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:#393A34\">...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token key atrule\" style=\"color:#00a4db\">responses</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token key atrule\" style=\"color:#00a4db\">'200'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'...'</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>however these refs can present in various different ways depending upon the response type, such as:  </p><div class=\"language-yaml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-yaml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token key atrule\" style=\"color:#00a4db\">'200'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">$ref</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'#/components/responses/actions_runner_labels'</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>or  </p><div class=\"language-yaml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-yaml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token key atrule\" style=\"color:#00a4db\">'200'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\">      </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">content</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token key atrule\" style=\"color:#00a4db\">application/json</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token key atrule\" style=\"color:#00a4db\">schema</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token key atrule\" style=\"color:#00a4db\">$ref</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'#/components/schemas/runner'</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>or  </p><div class=\"language-yaml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-yaml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token key atrule\" style=\"color:#00a4db\">'200'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token key atrule\" style=\"color:#00a4db\">content</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">application/json</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token key atrule\" style=\"color:#00a4db\">schema</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token key atrule\" style=\"color:#00a4db\">anyOf</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">$ref</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'#/components/schemas/interaction-limit-response'</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>or</p><div class=\"language-yaml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-yaml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token key atrule\" style=\"color:#00a4db\">'200'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token key atrule\" style=\"color:#00a4db\">content</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">application/json</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token key atrule\" style=\"color:#00a4db\">schema</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token key atrule\" style=\"color:#00a4db\">type</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> object</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token key atrule\" style=\"color:#00a4db\">required</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> total_count</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> runners</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token key atrule\" style=\"color:#00a4db\">properties</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token key atrule\" style=\"color:#00a4db\">total_count</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token key atrule\" style=\"color:#00a4db\">type</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> integer</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">          </span><span class=\"token key atrule\" style=\"color:#00a4db\">runners</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token key atrule\" style=\"color:#00a4db\">type</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> array</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token key atrule\" style=\"color:#00a4db\">items</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">              </span><span class=\"token key atrule\" style=\"color:#00a4db\">$ref</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'#/components/schemas/runner'</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>To find all of the schema refs without knowing the response type or structure I used the above function as follows (excluding refs for <code>examples</code>):  </p><div class=\"language-javascript codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-javascript codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">function</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getRespSchemaName</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token parameter\">op</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">for</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> respCode </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> op</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token property-access\">responses</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">if</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">respCode</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">startsWith</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'2'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getAllValuesForKey</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">op</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token property-access\">responses</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">respCode</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"$ref\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'examples'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>You can find this implementation in <a href=\"https://github.com/stackql/openapi-doc-util\" target=\"_blank\" rel=\"noopener noreferrer\"><strong><code>openapi-doc-util</code></strong></a> and <a href=\"https://www.npmjs.com/package/@stackql/openapi-doc-util\" target=\"_blank\" rel=\"noopener noreferrer\"><strong><code>@stackql/openapi-doc-util</code></strong></a>.  </p><p>simple!</p>",
            "url": "https://fullstackchronicles.io/recurse-javascript-object-to-get-values-for-a-given-key-the-easy-way",
            "title": "Recurse JavaScript Object to Get Values for a Given Key the Easy Way",
            "summary": "I had a scenario where I needed to find values for a key in a complex JavaScript object which could be nested *n* levels deep.",
            "date_modified": "2022-06-06T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "nodejs",
                "javascript",
                "openapi",
                "swagger"
            ]
        },
        {
            "id": "dataops-with-container-images-and-multi-stage-builds",
            "content_html": "<p>Container images provide an ideal software packaging solution for DataOps and python based data pipeline workloads.  Containers enable Data Scientists and Data Engineers to incorporate the latest packages and libraries without the issues associated with introducing breaking changes into shared environments.  A Data Engineer or Data Scienctist can quickly release new functionality with the best tools available.  </p><p>Container images provide safer developer environments but as the number of container images used for production workloads grow, a maintenance challenge can emerge.  Whether using <a href=\"https://pypi.org/project/pip\" target=\"_blank\" rel=\"noopener noreferrer\">pip</a> or <a href=\"https://python-poetry.org/\" target=\"_blank\" rel=\"noopener noreferrer\">poetry</a> to manage python packages and dependencies, updating a container definition requires edits to the explicit package versions as well as to the pinned or locked versions of the package dependencies. This process can be error prone without automation and a repeatable CICD workflow.  </p><p>A workflow pattern based on <a href=\"https://docs.docker.com/develop/develop-images/build_enhancements/\" target=\"_blank\" rel=\"noopener noreferrer\">docker buildkit</a> / <a href=\"https://github.com/moby/buildkit\" target=\"_blank\" rel=\"noopener noreferrer\">moby buildkit</a> multi-stage builds provides an approach that maintains all the build specifications in a single <code>Dockerfile</code>, while build tools like <code>make</code> provide a simple and consistent interface into the container build stages.  The data pipeline challenges addresses with a multi-stage build pattern include:  </p><ul><li>automating lifecycle management of the Python packages used by data pipelines</li><li>integrating smoke testing of container images to weed out compatibility issues early</li><li>simplifying the developer experience with tools like <code>make</code> that can be used both locally and in CI/CD pipelines</li></ul><p>The <code>Dockerfile</code> contains the definitions of the different target build stages and order of execution from one stage to the next.  The <code>Makefile</code> wraps the Dockerfile build targets into a standard set of workflow activities, following a similar to <code>$ config &amp;&amp; make &amp;&amp; make install</code> </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-dataops-container-lifecycle-workflow\">The DataOps Container Lifecycle Workflow<a class=\"hash-link\" href=\"#the-dataops-container-lifecycle-workflow\" title=\"Direct link to heading\">​</a></h2><p>A typical dataops/gitops style workflow for maintaining container images includes actions in the local environment to define the required packages and produce the pinned dependency <code>poetry.lock</code> file or <code>requirements.txt</code> packages list containing the full set of pinned dependent packages.  </p><p>Given and existing project in a remote git repository with a CI/CD pipeline defined, the following workflow would be used to update package versions and dependencies:  </p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Workflow</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">PlantUML</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><p><a target=\"_blank\" href=\"/assets/files/multi-stage-build-workflow-87a8fcc972f27832eb913441f9382786.png\"><img loading=\"lazy\" alt=\"Multi-stage build workflow\" src=\"/assets/images/multi-stage-build-workflow-87a8fcc972f27832eb913441f9382786.png\" width=\"540\" height=\"749\" class=\"img_ev3q\"></a> </p></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"language-plantuml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-plantuml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@startuml Multi-stage build workflow</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">|Local Maintainer|</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">start</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">:Clone git repository and</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">create a feature branch;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">:Update declared</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">dependencies;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">:Run build with</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">refresh option;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">:Update new pinned</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">packages file in the</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">git repository;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">:Commit changes and push</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">to remote repository;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">|Remote Git Service|</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">:Validate feature branch</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">changes;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">:Merge changes into</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">main branch;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">:build target image and</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">push to package registry;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">|Package Registry|</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">:publish new image;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">stop</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@enduml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><p>The image maintainer selects the packages to update or refresh using a local development environment, working from a feature branch.  This includes performing an image smoke-test to validate the changes within the container image.  </p><p>Once refreshed image has been validated, the lock file or full pinned package list is commited back to the repository and pushed to the remote repository.  The CI/CD pipeline performs a trial build and conducts smoke testing.  On merge into the main branch, the target image is built, re-validated, and pushed to the container image registry.  </p><p>The multi-stage build pattern can support both defining both the declared packages for an environment as well as the dependent packages, but <code>poetry</code> splits the two into distinct files, a <code>pyproject.toml</code> file containing the declated packages and a <code>poetry.lock</code> file that contains the full set of declared and dependent packages, including pinned versions.  <code>pip</code> supports loading packages from different files, but requires a convention for which requirements file contains the declared packages and while contains the full set of pinned package versions produced by <code>pip freeze</code>.  The example code repo contains examples using both <code>pip</code> and <code>poetry</code>.  </p><p>The following example uses <a href=\"https://python-poetry.org/\" target=\"_blank\" rel=\"noopener noreferrer\">poetry</a> in a <code>python:3.8</code> base image to illustrate managing the dependencies and version pinning of python packages.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"multi-stage-dockerfile\">Multi-stage Dockerfile<a class=\"hash-link\" href=\"#multi-stage-dockerfile\" title=\"Direct link to heading\">​</a></h2><p>The <code>Dockerfile</code> defines the build stages used for both local refresh and by the CICD pipelines to build the target image.  </p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Stages</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">PlantUML</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><p><a target=\"_blank\" href=\"/assets/files/Dockerfile-stages-097c44de43a3057961052ec16b2848cf.png\"><img loading=\"lazy\" alt=\"Dockerfile Stages\" src=\"/assets/images/Dockerfile-stages-097c44de43a3057961052ec16b2848cf.png\" width=\"380\" height=\"425\" class=\"img_ev3q\"></a> </p></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"language-plantuml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-plantuml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@startuml Dockerfile stages</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!define C4_PLANTUML https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!include C4_PLANTUML/C4_Component.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">HIDE_STEREOTYPE()</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">UpdateElementStyle(Container, $bgColor=green)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Title: Docker build stages</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Container(pre, base-pre-pkg,)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Container(refresh, python-pkg-refresh,)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Container(pinned, python-pkg-pinned,)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Container(post, base-post-pkg,)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Container(smoke, smoke-test,)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Container(target, target-image,)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(pre, refresh, \"refresh\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(pre, pinned, \"pinned\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(refresh, post, \" \")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(pinned, post, \" \")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(post, smoke, \"QA\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(post, target, \"artefact\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@enduml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><p>The Dockerfile makes use of the docker build arguments feature to pass in whether the build should refresh package versions or build the image from pinned packages.  </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"build-stage-base-pre-pkg\">Build Stage: base-pre-pkg<a class=\"hash-link\" href=\"#build-stage-base-pre-pkg\" title=\"Direct link to heading\">​</a></h3><p>Any image setup and pre-python package installation steps.  For <code>poetry</code>, this includes setting the config option to skip the creation of a virtual environment as the container already provides the required isolation.  </p><div class=\"language-Dockerfile codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ARG PYTHON_PKG_VERSIONS=pinned</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">FROM python:3.8 as base-pre-pkg</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">RUN install -d /src &amp;&amp; \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    pip install --no-cache-dir poetry==1.1.13 &amp;&amp; \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    poetry config virtualenvs.create false</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">WORKDIR /src</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"build-stage-python-pkg-refresh\">Build Stage: python-pkg-refresh<a class=\"hash-link\" href=\"#build-stage-python-pkg-refresh\" title=\"Direct link to heading\">​</a></h3><p>The steps to generate a <code>poetry.lock</code> file containing the pinned package versions.  </p><div class=\"language-Dockerfile codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">FROM base-pre-pkg as python-pkg-refresh</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">COPY pyproject.toml poetry.lock /src/</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">RUN poetry update &amp;&amp; \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    poetry install </span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"build-stage-python-pkg-pinned\">Build Stage: python-pkg-pinned<a class=\"hash-link\" href=\"#build-stage-python-pkg-pinned\" title=\"Direct link to heading\">​</a></h3><p>The steps to install packages using the pinned package versions.</p><div class=\"language-Dockerfile codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">FROM base-pre-pkg as python-pkg-pinned</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">COPY pyproject.toml poetry.lock /src/</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">RUN poetry install </span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"build-stage-base-post-pkg\">Build Stage: base-post-pkg<a class=\"hash-link\" href=\"#build-stage-base-post-pkg\" title=\"Direct link to heading\">​</a></h3><p>A consolidation build target that can refer to either the python-pkg-refresh or the python-pkg-pinned stages, depending on the docker build argument and includes any post-package installation steps.  </p><div class=\"language-Dockerfile codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">FROM python-pkg-${PYTHON_PKG_VERSIONS} as base-post-pkg</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"build-stage-smoke-test\">Build Stage: smoke-test<a class=\"hash-link\" href=\"#build-stage-smoke-test\" title=\"Direct link to heading\">​</a></h3><p>Simple smoke tests and validation commands to validate the built image.  </p><div class=\"language-Dockerfile codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">FROM base-post-pkg as smoke-test</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">WORKDIR /src</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">COPY tests/ ./tests</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">RUN poetry --version &amp;&amp; \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    python ./tests/module_smoke_test.py</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"build-stage-target-image\">Build Stage: target-image<a class=\"hash-link\" href=\"#build-stage-target-image\" title=\"Direct link to heading\">​</a></h3><p>The final build target container image.  Listing the <code>target-image</code> as the last stage in the <code>Dockerfile</code> has the effect of also making this the default build target.  </p><div class=\"language-Dockerfile codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-Dockerfile codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">FROM base-post-pkg as target-image</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"multi-stage-makefile\">Multi-stage Makefile<a class=\"hash-link\" href=\"#multi-stage-makefile\" title=\"Direct link to heading\">​</a></h2><p>The Makefile provides a workflow oriented wrapper over the Dockerfile build stage targets.  The Makefile targets can be executed both in a local development environment as well as via a CICD pipeline.  The <code>Makefile</code> includes several variables that can either be run using default values, or overridden by the CI/CD pipeline.  </p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Targets</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">PlantUML</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><p><a target=\"_blank\" href=\"/assets/files/Makefile-targets-777beb960ef5b7b68e396310bd409f3c.png\"><img loading=\"lazy\" alt=\"Makefile targets\" src=\"/assets/images/Makefile-targets-777beb960ef5b7b68e396310bd409f3c.png\" width=\"389\" height=\"338\" class=\"img_ev3q\"></a> </p></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"language-plantuml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-plantuml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@startuml Makefile targets</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!define C4_PLANTUML https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!include C4_PLANTUML/C4_Component.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">HIDE_STEREOTYPE()</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Title: Makefile targets</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Container(style, style-check,)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Container(refresh, python-pkg-refresh, \"docker target=smoke-test\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Container(smoke, smoke-test, \"docker target=smoke-test\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Container(build, build, \"docker target=target-image\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(style, refresh, \" \")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(style, build, \" \")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(build, smoke, \" \")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@enduml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"make-target-style-check\">Make Target: style-check<a class=\"hash-link\" href=\"#make-target-style-check\" title=\"Direct link to heading\">​</a></h2><p>Linting and style checking of source code.  Can include both application code as well as the Dockerfile itself using tools such as <a href=\"https://github.com/hadolint/hadolint\" target=\"_blank\" rel=\"noopener noreferrer\">hadolint</a>.  </p><div class=\"language-Makefile codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-Makefile codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">style-check:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    hadolint ./Dockerfile</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"make-target-python-pkg-refresh\">Make Target: python-pkg-refresh<a class=\"hash-link\" href=\"#make-target-python-pkg-refresh\" title=\"Direct link to heading\">​</a></h2><p>The <code>python-pkg-refresh</code> target builds a version of the target image with refreshed package versions. A temporary container instance is created from the target image and the <code>poetry.lock</code> file is copied into the local file system. The <code>smoke-test</code> docker build target is used to ensure image validation is also performed.\nThe temporary container as well as the package refresh image are removed after the build.  </p><div class=\"language-Makefile codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-Makefile codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">python-pkg-refresh:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    @echo \"&gt;&gt; Update python packages in container image\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    docker build ${DOCKER_BUILD_ARGS} \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">           --target smoke-test \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">           --build-arg PYTHON_PKG_VERSIONS=refresh \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">           --tag ${TARGET_IMAGE_NAME}:$@ .</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    @echo \"&gt;&gt; Copy the new poetry.lock file with updated package versions\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    docker create --name ${TARGET_IMAGE_NAME}-$@ ${TARGET_IMAGE_NAME}:$@</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    docker cp ${TARGET_IMAGE_NAME}-$@:/src/poetry.lock .</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    @echo \"&gt;&gt; Clean working container and refresh image\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    docker rm ${TARGET_IMAGE_NAME}-$@</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    docker rmi ${TARGET_IMAGE_NAME}:$@</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"make-target-build\">Make Target: build<a class=\"hash-link\" href=\"#make-target-build\" title=\"Direct link to heading\">​</a></h3><p>The standard build target using pinned python package versions.  </p><div class=\"language-Makefile codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-Makefile codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">build:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    docker build ${DOCKER_BUILD_ARGS} \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">           --target target-image \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">           --tag ${TARGET_IMAGE_NAME}:${BUILD_TAG} .</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"make-target-smoke-test\">Make Target: smoke-test<a class=\"hash-link\" href=\"#make-target-smoke-test\" title=\"Direct link to heading\">​</a></h3><p>Builds an image and peforms smoke testing.  The smoke-testing image is removed after the build.  </p><div class=\"language-Makefile codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-Makefile codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">smoke-test:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    docker build ${DOCKER_BUILD_ARGS} \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">           --target smoke-test \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">           --tag ${TARGET_IMAGE_NAME}:$@ .</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    docker rmi ${TARGET_IMAGE_NAME}:$@</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"conclusion\">Conclusion<a class=\"hash-link\" href=\"#conclusion\" title=\"Direct link to heading\">​</a></h2><p>The toolchain combination of multi-stage container image builds with <code>make</code> provides a codified method for the lifecycle management of the containers used in data science and data engineering workloads.  </p><p>The maintainer:  </p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token function\" style=\"color:#d73a49\">git</span><span class=\"token plain\"> checkout -b my-refresh-feature</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">make</span><span class=\"token plain\"> python-pkg-refresh</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">make</span><span class=\"token plain\"> smoke-test</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">git</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">add</span><span class=\"token plain\"> pyproject.toml poetry.lock</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">git</span><span class=\"token plain\"> commit -m </span><span class=\"token string\" style=\"color:#e3116c\">\"python package versions updated\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">git</span><span class=\"token plain\"> push</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>The CICD pipeline:  </p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token function\" style=\"color:#d73a49\">make</span><span class=\"token plain\"> build</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">make</span><span class=\"token plain\"> smoke-test</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">docker</span><span class=\"token plain\"> push </span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token plain\">target-image</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\">:</span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token plain\">build-tag</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><div class=\"theme-admonition theme-admonition-info alert alert--info admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_S0QG\"><p>You can find the complete source code for this article at <a href=\"https://gitlab.com/datwiz/multistage-pipeline-image-builds\" target=\"_blank\" rel=\"noopener noreferrer\">https://gitlab.com/datwiz/multistage-pipeline-image-builds</a></p></div></div>",
            "url": "https://fullstackchronicles.io/dataops-with-container-images-and-multi-stage-builds",
            "title": "DataOps with Container Images and Multi-Stage Builds",
            "date_modified": "2022-05-28T00:00:00.000Z",
            "author": {
                "name": "Chris Ottinger",
                "url": "https://github.com/datwiz"
            },
            "tags": [
                "python",
                "docker",
                "ci-cd",
                "data engineering",
                "poetry"
            ]
        },
        {
            "id": "using-the-snowflake-sql-api-with-typescript",
            "content_html": "<p>This article demonstrates how to use the Snowflake REST API to retrieve data for a web application using TypeScript, in this case we are using keypair authentication with Snowflake.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"overview\">Overview<a class=\"hash-link\" href=\"#overview\" title=\"Direct link to heading\">​</a></h2><p>Snowflake’s SQL API allows you to access snowflake objects using SQL via a REST API request, this allows for easy integration with your applications and deployment pipelines. You can use the API to execute most DDL and DML statements.  </p><p>There are some limitations you need to be aware of however, for example interactions with stages (using PUT and GET aren’t supported via the Snowflake API) or stored procedure operations (using CALL), you can read more on this <a href=\"https://docs.snowflake.com/en/developer-guide/sql-api/intro.html#limitations-of-the-sql-api\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"endpoints\">Endpoints<a class=\"hash-link\" href=\"#endpoints\" title=\"Direct link to heading\">​</a></h2><p>There are three endpoints provided:  </p><ul><li><code>/api/v2/statements/</code></li><li><code>/api/v2/statement/&lt;statementHandle&gt;</code></li><li><code>/api/v2/statements/&lt;statementHandle/cancel</code></li></ul><p>We will be looking at the first two in this article.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"authentication-methods\">Authentication Methods<a class=\"hash-link\" href=\"#authentication-methods\" title=\"Direct link to heading\">​</a></h2><p>There are two types of Authentication methods for the API, <strong>OAuth</strong> and <strong>Key Pair</strong>. For OAuth method, you can choose to use <code>X-Snowflake-Authorization-Token-Type</code> header, if this header is not present, Snowflake assumes that the token in the <code>Authorization</code> header is an OAuth token. For Key Pair method, the JWT token will be in the <code>Authorization</code> header as <code>Bearer &lt;your token&gt;</code>.  </p><p>Let’s walk through how to generate and use the JWT.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"generating-the-jwt\">Generating the JWT<a class=\"hash-link\" href=\"#generating-the-jwt\" title=\"Direct link to heading\">​</a></h2><p>Here's whats needed:  </p><p><a target=\"_blank\" href=\"/assets/files/snowflake-jwt-d8c78351e349e02c9d6b86cbacc7fac1.png\"><img loading=\"lazy\" alt=\"Snowflake JWT\" src=\"/assets/images/snowflake-jwt-d8c78351e349e02c9d6b86cbacc7fac1.png\" width=\"2730\" height=\"1442\" class=\"img_ev3q\"></a></p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-code\">the Code<a class=\"hash-link\" href=\"#the-code\" title=\"Direct link to heading\">​</a></h3><iframe width=\"100%\" frameborder=\"0\" id=\"gist-6fbe63cace2ad993ac06b324954b7daa\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"request-body\">Request Body<a class=\"hash-link\" href=\"#request-body\" title=\"Direct link to heading\">​</a></h2><p>Now we need a request body:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-ae0ebbedf51f232e7147e72f11007b68\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"submitting-the-request\">Submitting the Request<a class=\"hash-link\" href=\"#submitting-the-request\" title=\"Direct link to heading\">​</a></h2><p>We will need to include the <strong>region</strong> and <strong>account identifier</strong>, for instance if your account identifier includes a region (e.g. xy12345.us-east2.aws.snowflakecomputing.com).  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-535123dda1536b5a48c6213470e83d6f\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"response-handling\">Response Handling<a class=\"hash-link\" href=\"#response-handling\" title=\"Direct link to heading\">​</a></h2><p>When making a <code>SELECT</code> query, there are three things worth noting:  </p><ol><li><code>rowType</code> fields in the <code>resultSetMetaData</code> represent the columns</li><li>data without column names is in the format of <code>string[][]</code></li><li><code>partitionInfo</code> is an array of object representing different partitions</li></ol><p>For more information see <a href=\"https://docs.snowflake.com/en/developer-guide/sql-api/handling-responses.html\" target=\"_blank\" rel=\"noopener noreferrer\">Handling Responses from the SQL API - Snowflake Documentation</a>.  </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"parsing-data\">Parsing data<a class=\"hash-link\" href=\"#parsing-data\" title=\"Direct link to heading\">​</a></h3><p>Here is a Typescript code snippet demonstrating parsing return data:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-d397621879b063ea0761233984aafe69\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"handling-multiple-partitions\">Handling multiple partitions<a class=\"hash-link\" href=\"#handling-multiple-partitions\" title=\"Direct link to heading\">​</a></h3><p>Large result sets are paginated into <em>partitions</em>, each partition is a set of rows.</p><div class=\"theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z\"></path></svg></span>note</div><div class=\"admonitionContent_S0QG\"><p>Note that the pages (referred to as partitions) are <strong>NOT</strong> based on row count, instead they are based on the compressed batch size, so they will not be uniform in terms of the number of rows.</p></div></div><p>To get a partition, send a <code>GET</code> request with Url <code>https://&lt;accountIdentifier&gt;.snowflakecomputing.com/api/v2/statements/?partition=&lt;partitionId&gt;</code>.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-7f2b0443a9ca5e8284b987a9e84ca301\"></iframe><p>Thanks!</p>",
            "url": "https://fullstackchronicles.io/using-the-snowflake-sql-api-with-typescript",
            "title": "Using the Snowflake SQL API with TypeScript",
            "summary": "This article demonstrates how to use the Snowflake REST API to retrieve data for a web application using TypeScript",
            "date_modified": "2022-05-19T00:00:00.000Z",
            "author": {
                "name": "Yuncheng Yang",
                "url": "https://www.linkedin.com/in/yuncheng-fabio-yang/"
            },
            "tags": [
                "snowflake",
                "sql",
                "typescript",
                "react",
                "jamstack"
            ]
        },
        {
            "id": "split-a-large-swagger-openapi-specification-into-smaller-documents",
            "content_html": "<p>Open API specifications can get quite large, especially for providers with upwards of 500 routes or operations.  </p><p>The challenge is to create standalone documents scoped by a service or path within the parent API specification and include only the components (schemas, responses, etc.) that pertain to operations included in the child document.  </p><p>When I went looking for library or utility to do this, I couldn’t find one... so I have developed one myself.  </p><p>It's a simple command (nodejs based but can be run in a bash terminal or from the Windows command line) which requires a few options, including:  </p><ul><li>the <strong><em>provider name</em></strong> (e.g. <code>github</code>)</li><li>a <strong><em>provider version</em></strong> which is a version you set - allowing you to make minor modifications to the output documents (e.g. <code>v0.1.0</code>)</li><li>a <strong><em>service discriminator</em></strong> which is a JSONPath expression to identify a service name within each route in the parent file, this is used to assign operations to services in separate documents (e.g. <code>'$[\"x-github\"].category'</code>)</li><li>an <strong><em>output directory</em></strong> (e.g. <code>./dev</code>)</li></ul><p>and of course, the <strong><em>openapi spec document</em></strong> you are splitting up.</p><p>an example is shown here:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">openapi-doc-util split \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-n github \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-v v0.1.0 \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-s '$[\"x-github\"].category' \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">-o ./dev \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ref/github/api.github.com.yaml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Help for the command is available using <code>openapi-doc-util split</code>.  </p><p>The net result is 59 self-contained, service scoped documents, containing only the components referenced by routes in the service document.</p><p>You can access this utility via <a href=\"https://www.npmjs.com/package/@stackql/openapi-doc-util\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>NPMJS</strong></a> or via <a href=\"https://github.com/stackql/openapi-doc-util\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>GitHub</strong></a>.  </p><p>Splitting up a large open API spec document, is the first stage in developing a <a href=\"https://github.com/stackql/stackql\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>StackQL</strong></a> provider which we will discuss next time!</p>",
            "url": "https://fullstackchronicles.io/split-a-large-swagger-openapi-specification-into-smaller-documents",
            "title": "Split a large Open API or Swagger Specification into smaller documents",
            "summary": "Simple utility to split a large Open API or Swagger specification into smaller documents.",
            "date_modified": "2022-05-02T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "openapi",
                "swagger",
                "api",
                "stackql"
            ]
        },
        {
            "id": "stream-processing-with-spark-structured-streaming-kafka-and-snowflake-using-python",
            "content_html": "<p>Structured Streaming in Spark provides a powerful framework for stream processing an analysis, such as streaming transformations, stateful streaming or sliding window operations.  </p><p>Kafka is a common streaming source and sink for Spark Streaming and Structured Streaming operations.  However, there may be situations where a data warehouse (such as Snowflake) is a more appropriate target for streaming operations, especially where there is a reporting or long-term storage requirement on the data derived from the streaming source.  </p><p>This article will demonstrate just how easy this is to implement using Python.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"design\">Design<a class=\"hash-link\" href=\"#design\" title=\"Direct link to heading\">​</a></h2><p>The following diagram illustrates the ingestion design for this example:  </p><p><a target=\"_blank\" href=\"/assets/files/spark-streaming-kafka-snowflake-5b6babb75a8da1443183fabc68c704a1.png\"><img loading=\"lazy\" alt=\"Spark Structured Streaming using Kafka and Snowflake\" src=\"/assets/images/spark-streaming-kafka-snowflake-5b6babb75a8da1443183fabc68c704a1.png\" width=\"948\" height=\"390\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"snowflake-setup\">Snowflake Setup<a class=\"hash-link\" href=\"#snowflake-setup\" title=\"Direct link to heading\">​</a></h2><p>Some prerequisites for Snowflake:  </p><ol><li>You will need to create a user (or use an existing user), in either case the user will need to be identified by a private key.  You will need to generate a key pair as follows:  </li></ol><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">openssl genrsa </span><span class=\"token number\" style=\"color:#36acaa\">2048</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">|</span><span class=\"token plain\"> openssl pkcs8 -topk8 -inform PEM -out rsa_key.p8 -nocrypt</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">openssl rsa -in rsa_key.p8 -pubout -out rsa_key.pub</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>copy the contents of the <code>rsa_key.pub</code> file, remove the <code>-----BEGIN PUBLIC KEY-----</code> and <code>-----END PUBLIC KEY-----</code> strings, then remove the line breaks to form one string, use this string as the <code>RSA_PUBLIC_KEY</code> in a <code>CREATE USER</code> or <code>ALTER USER</code> statement in Snowflake, like:  </p><div class=\"language-sql codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sql codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">ALTER</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">USER</span><span class=\"token plain\"> youruser </span><span class=\"token keyword\" style=\"color:#00009f\">SET</span><span class=\"token plain\"> RSA_PUBLIC_KEY</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">'MIIBI...'</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><ol start=\"2\"><li>Now setup the target database, schema and table you will use to write out your stream data (the schema for the table must match the schema for the Data Stream you will use the <code>DataStreamWriter</code> to emit records to Snowflake  </li></ol><p>The user you will be using (that you setup the key pair authentication for) will need to be assigned a default role to which the appropriate write permissions are granted to the target objects in Snowflake.  You will also need to designate a virtual warehouse (which your user must have <code>USAGE</code> permissions to.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-code\">The Code<a class=\"hash-link\" href=\"#the-code\" title=\"Direct link to heading\">​</a></h2><p>Now that we have the objects and user setup in Snowflake, we can construct our Spark application.  </p><p>First, you will need to start your Spark session (either using <code>pyspark</code> or <code>spark-submit</code>) including the packages that Spark will need to connect to Kafka and to Snowflake.  </p><p>The Snowflake packages include a JDBC driver and the Snowflake Connector for Spark, see <a href=\"https://docs.snowflake.com/en/user-guide/spark-connector.html\" target=\"_blank\" rel=\"noopener noreferrer\">Snowflake Connector for Spark</a>.  </p><p>An example is shown here (package versions may vary depending upon the version of Spark you are using):  </p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">pyspark </span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--packages </span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">net.snowflake:snowflake-jdbc:3.13.14,</span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">net.snowflake:spark-snowflake_2.12:2.10.0-spark_3.1,</span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">org.apache.spark:spark-sql-kafka-0-10_2.12:3.2.1</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Now that we have a spark session with the necessary packages, lets go...  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># import any required functions, set the checkpoint directory, and log level (optional)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> pyspark</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">sql</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">functions </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> split</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">spark</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">sparkContext</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">setLogLevel</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"ERROR\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">spark</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">conf</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"spark.sql.streaming.checkpointLocation\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"file:///tmp\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>setup connection options for Snowflake by creating an <code>sfOptions</code> dictionary  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">sfOptions </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:#e3116c\">\"sfURL\"</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> sfUrl</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:#e3116c\">\"sfUser\"</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"avensolutions\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:#e3116c\">\"pem_private_key\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> private_key</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:#e3116c\">\"sfDatabase\"</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"SPARK_SNOWFLAKE_DEMO\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:#e3116c\">\"sfSchema\"</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"PUBLIC\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:#e3116c\">\"sfWarehouse\"</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"COMPUTE_WH\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token string\" style=\"color:#e3116c\">\"streaming_stage\"</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"mystage\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>set a variable for the Snowflake Spark connector  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">SNOWFLAKE_SOURCE_NAME </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"net.snowflake.spark.snowflake\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>read messages from Kafka:    </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">lines </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> spark \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">readStream \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"kafka\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">option</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"kafka.bootstrap.servers\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"kafkabroker:9092\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">option</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"subscribe\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"weblogs\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">load</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>perform necessary transformations (the fields and data types in the resultant data structure must match the target table you created in Snowflake:  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">log_recs </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> lines</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">select</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    split</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">lines</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">value</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">cast</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"string\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\" \"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">alias</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"data\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">log_data </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> log_recs</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">selectExpr</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[0] as string) as date\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[1] as string) as time\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[2] as string) as c_ip\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[3] as string) as cs_username\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[4] as string) as s_sitename\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[5] as string) as s_computername\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[6] as string) as s_ip\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\">    </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[7] as int) as s_port\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[8] as string) as cs_method\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\">    </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[9] as string) as cs_uri_stem\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[10] as string) as cs_uri_query\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[11] as int) as sc_status\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[12] as int) as time_taken\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\">    </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[13] as string) as cs_version\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\">    </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[14] as string) as cs_host\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[15] as string) as User_Agent\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token string\" style=\"color:#e3116c\">\"CAST(data[16] as string) as Referer\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\">    </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>write to Snowflake!  </p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">query </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> log_data\\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">writeStream\\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">SNOWFLAKE_SOURCE_NAME</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">options</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">**</span><span class=\"token plain\">sfOptions</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">option</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"dbtable\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"WEB_LOGS\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">trigger</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">processingTime</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">'30 seconds'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">start</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">query</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">awaitTermination</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><div class=\"theme-admonition theme-admonition-info alert alert--info admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_S0QG\"><p>Note that I have included the <code>processingTime</code> trigger of <code>30 seconds</code> (this is akin to the <code>batchInterval</code> in the DStream API), you should tune this to get a balance between batch sizes to ingest into Snowflake (which will benefit from larger batches) and latency.</p></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-results\">The Results<a class=\"hash-link\" href=\"#the-results\" title=\"Direct link to heading\">​</a></h2><p><a target=\"_blank\" href=\"/assets/files/snowflake-screenshot-97a035bab5f113d5139441dde516099d.png\"><img loading=\"lazy\" alt=\"Spark Structured Streaming into Snowflake\" src=\"/assets/images/snowflake-screenshot-97a035bab5f113d5139441dde516099d.png\" width=\"1920\" height=\"1040\" class=\"img_ev3q\"></a></p><p>Enjoy!</p>",
            "url": "https://fullstackchronicles.io/stream-processing-with-spark-structured-streaming-kafka-and-snowflake-using-python",
            "title": "Stream Processing with Spark Structured Streaming, Kafka and Snowflake using Python",
            "summary": "Simple demonstration of stream processing with Spark Structured Streaming, Kafka and Snowflake using Python",
            "date_modified": "2022-04-28T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "snowflake",
                "kafka",
                "spark",
                "sql",
                "streaming"
            ]
        },
        {
            "id": "simple-cli-pkce-auth-using-okta",
            "content_html": "<p>This article demonstrates a simple command line utility to login to an authorization server (Okta in this case) using a PKCE (Proof Key for Code Exchange) flow.  This is the preferred flow for public clients (such as Single Page Applications).  </p><blockquote><p>The code for this article is available on <a href=\"https://github.com/stackql/okta-pkce-login\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>GitHub</strong></a></p></blockquote><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"example\">Example<a class=\"hash-link\" href=\"#example\" title=\"Direct link to heading\">​</a></h2><p><a target=\"_blank\" href=\"/assets/files/okta-pkce-cli-login-984bdced01ccc0963b19556d1800450d.png\"><img loading=\"lazy\" alt=\"Okta PKCE cli login example\" src=\"/assets/images/okta-pkce-cli-login-984bdced01ccc0963b19556d1800450d.png\" width=\"982\" height=\"479\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"overview\">Overview<a class=\"hash-link\" href=\"#overview\" title=\"Direct link to heading\">​</a></h2><p>This application can be used to illustrate the authorization/authentication flow discussed in <a href=\"https://fullstackchronicles.io/simple-sso-with-an-external-idp-using-active-directory-and-okta\" target=\"_blank\" rel=\"noopener noreferrer\">Simple SSO with an external IdP using Active Directory and Okta</a>.  A flow which is pictured here:  </p><p><a target=\"_blank\" href=\"/assets/files/seqdiagram-405ae2f7d8f54f113c5190e8d5799117.png\"><img loading=\"lazy\" alt=\"PKCE Authorization t Okta using an AD IdP\" src=\"/assets/images/seqdiagram-405ae2f7d8f54f113c5190e8d5799117.png\" width=\"904\" height=\"738\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"steps\">Steps<a class=\"hash-link\" href=\"#steps\" title=\"Direct link to heading\">​</a></h2><p>The steps involved in the implementation of a PKCE login flow are as follows:</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"generate-a-code_challenge\">Generate a <code>code_challenge</code><a class=\"hash-link\" href=\"#generate-a-code_challenge\" title=\"Direct link to heading\">​</a></h3><p>To implement a PKCE flow, you first need to generate a <em>Code Verifier</em> (which is a random value you create), the <em>Code Verifier</em> is then hashed using a SHA256 algorithm.  The hash is then used as the <em>Code Challenge</em>.  An example function to generate a code challenge is shown below:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-9a2a162813d77b83821d821b6a4a390a\"></iframe><p>For more information see <a href=\"https://developer.okta.com/blog/2019/08/22/okta-authjs-pkce#:~:text=PKCE%20works%20by%20having%20the,is%20called%20the%20Code%20Challenge\" target=\"_blank\" rel=\"noopener noreferrer\">Use PKCE to Make Your Apps More Secure</a>. </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"build-the-authorize-url\">Build the <code>authorize</code> url<a class=\"hash-link\" href=\"#build-the-authorize-url\" title=\"Direct link to heading\">​</a></h3><p>The <code>authorize</code> url is used to initiate the authorization flow with the authorization server.  An example function to construct the <code>authorize</code> url is shown below:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-9e628b905a532e5bd59f022a4adca340\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"get-the-authorization-code-via-redirect-uri\">Get the authorization code via redirect uri<a class=\"hash-link\" href=\"#get-the-authorization-code-via-redirect-uri\" title=\"Direct link to heading\">​</a></h3><p>The <code>redirecturi</code> parameter supplied in the <code>authorize</code> url is used to retrieve the authorization code from the authorization server.  In order to get this code using a front end flow, you need to define a handler that will get the authorization code, call the token endpoint, and close the HTTP server, as shown here:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-617417bdcc54efcea9d37d27228f7f2a\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"exchange-the-code-for-an-access-token\">Exchange the code for an access token<a class=\"hash-link\" href=\"#exchange-the-code-for-an-access-token\" title=\"Direct link to heading\">​</a></h3><p>The access token is what you ultimatly want, as this is the token that will be used to access protected resources.  An example function to exchange the authorization code for an access token is shown below:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-0a990674d8bde2baffc0b0231f52ed52\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"optional-get-the-user-profile\">(Optional) Get the user profile<a class=\"hash-link\" href=\"#optional-get-the-user-profile\" title=\"Direct link to heading\">​</a></h3><p>The access token can be used to get the user profile, this is done by calling the <code>userinfo</code> endpoint using the token.  An example function to get the user profile is shown below:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-f04e8b018417a73986d3696c58f735cb\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"with-inspiration-from\">with inspiration from...<a class=\"hash-link\" href=\"#with-inspiration-from\" title=\"Direct link to heading\">​</a></h2><ul><li><a href=\"https://gist.github.com/ogazitt/f749dad9cca8d0ac6607f93a42adf322\" target=\"_blank\" rel=\"noopener noreferrer\">Auth0 PKCE flow for a CLI built in golang</a></li><li><a href=\"https://community.auth0.com/t/golang-sample-for-a-cli-obtaining-an-access-token-using-the-pkce-flow/40922\" target=\"_blank\" rel=\"noopener noreferrer\">Golang sample for a CLI obtaining an access token using the PKCE flow</a></li><li><a href=\"https://github.com/oktadev/okta-node-cli-example\" target=\"_blank\" rel=\"noopener noreferrer\">oktadev/okta-node-cli-example</a></li><li><a href=\"https://developer.okta.com/blog/2019/06/18/command-line-app-with-nodejs\" target=\"_blank\" rel=\"noopener noreferrer\">Build a Command Line Application with Node.js</a></li><li><a href=\"https://developer.okta.com/docs/guides/implement-grant-type/authcodepkce/main/#about-the-authorization-code-grant-with-pkce\" target=\"_blank\" rel=\"noopener noreferrer\">About the Authorization Code grant with PKCE</a></li></ul>",
            "url": "https://fullstackchronicles.io/simple-cli-pkce-auth-using-okta",
            "title": "Simple CLI Application to Login to Okta using PKCE",
            "summary": "Simple command line application to login to an Okta authorization server using a PKCE flow.",
            "date_modified": "2022-04-17T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "okta",
                "oauth2",
                "cli",
                "golang",
                "pkce"
            ]
        },
        {
            "id": "cloudy-with-a-chance-of-big-data-has-moved",
            "content_html": "<blockquote><p>Our blog has moved to <a href=\"https://fullstackchronicles.io/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>fullstackchronicles.io</strong></a>, same content with a new home!  Much more content to come, enjoy!</p></blockquote>",
            "url": "https://fullstackchronicles.io/cloudy-with-a-chance-of-big-data-has-moved",
            "title": "Cloudy with a Chance of Big Data has Moved",
            "summary": "Cloudy with a chance of Big Data is now Full Stack Chronicles.",
            "date_modified": "2022-04-08T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "blog",
                "cloudywithachanceofbigdata.com",
                "fullstackchronicles.io"
            ]
        },
        {
            "id": "scaling-up-prefect-with-gitstorage",
            "content_html": "<p><a href=\"https://prefect.io\" target=\"_blank\" rel=\"noopener noreferrer\">Prefect.io</a> is a python based Data Engineering toolbox for building and\noperating Data Pipelines.  Out of the box, Prefect provides an initial workflow for managing data\npipelines that results in a container image per data pipeline job.</p><p>The one-to-one relationship between data pipeline jobs and container images enables data engineers to\ncraft pipelines that are loosely coupled and don't require a shared runtime environment configuration.\nHowever, as the number of data pipeline jobs grow the default container per job approach starts to\nintroduce workflow bottlenecks and lifecycle management overheads.  For example, in order\nto update software components used by flows, such as upgrading the version of Prefect, all the data\npipeline job images have to be rebuilt and redeployed.  Additionally the container image per job workflow\nintroduces a wait time for data engineers to re-build data pipeline container images and test flows\ncentrally on Prefect Server or Prefect Cloud environment.</p><p>Fortunately, Prefect comes to its own rescue with the ability to open up the box, exposing the flexibility\nin the underlying framework.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"out-of-the-box---prefect-dockerstorage\">Out of the box - Prefect DockerStorage<a class=\"hash-link\" href=\"#out-of-the-box---prefect-dockerstorage\" title=\"Direct link to heading\">​</a></h2><p>Out of the box, Prefect provides a simple workflow for defining and deploying data pipelines as container images.\nAfter getting a first data pipeline running in a local environment, the attention turns to scaling up development\nand deploying flows into a managed environment, using either the Prefect Cloud service or a Prefect Server.</p><p>Combining Prefect Cloud or Prefect Server with Kubernetes provides a flexible and scalable platform\nsolution for moving data pipelines into production.  There are a number of options for packaging\ndata pipeline flow code for execution on kubernetes clusters.  The Docker Storage option provides\nthe workflow for bundling the data pipeline job code into container images, enabling a common\ncontrolled execution environment and well understood distribution mechanism.  The data pipeline runs as\na pod using the flow container image.</p><p>Prefect Docker Storage workflow steps for building and deploying data pipeline flows include:</p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Steps</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">PlantUML</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><p><a target=\"_blank\" href=\"/assets/files/image1-3eb8a74efcfb6b3a329f69dd9b89ca34.png\"><img loading=\"lazy\" alt=\"Workflow Steps\" src=\"/assets/images/image1-3eb8a74efcfb6b3a329f69dd9b89ca34.png\" width=\"253\" height=\"435\" class=\"img_ev3q\"></a> </p></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@startuml \"docker-storage-workflow\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">(*) --&gt; \"package flow code</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">into a container image\" </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--&gt; \"register Prefect flow</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">using image reference\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--&gt; \"push image to container registry\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--&gt; \"run flow in Prefect Server or Cloud</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">(new image pulled from registry)\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--&gt; (*)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@enduml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><ul><li>packaging a flow (python code) as a serialised/pickled object into a container image</li><li>registering the flow using the container image name</li><li>pushing the container image to a container repository accessible from the kubernetes cluster</li><li>running the flow by running an instance of the named container image as a kubernetes pod</li></ul><p>This is relatively simple immutable workflow.  Each data pipeline flow version is effectively a unique and\nself contained 'point-in-time' container image.  This initial workflow can also be extended to package\nmultiple related flows into a single container image, reducing the number of resulting container images.\nBut, as the number of data pipeline jobs grow, there issues of container image explosion and data engineering\nproductivity remain.</p><p>Using Prefect GitStorage for flows addresses both container image proliferation as well as development\nbottlenecks.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"prefect-git-storage\">Prefect Git Storage<a class=\"hash-link\" href=\"#prefect-git-storage\" title=\"Direct link to heading\">​</a></h2><p>Prefect <a href=\"https://docs.prefect.io/orchestration/flow_config/storage.html#git\" target=\"_blank\" rel=\"noopener noreferrer\">Git Storage</a> provides a workflow for developing and deploying data pipelines directly from git repositories,\nsuch as Gitlab or Github.  The data pipeline code (python) is pulled from the git repository on each invocation\nwith the ability to reference git branches and git tags.  This approach enables:</p><ul><li>reducing the number of container images to the number of different runtime configurations to be supported.</li><li>improving the data engineering development cycle time by removing the need to build and push container images\non each code change.</li><li>when combined with kubernetes Prefect Run Configs and Job templates, enables selection of specific runtime environment images</li></ul><p>Note that the GitStorage option does required access from the runtime kubernetes cluster to the central git storage\nservice, e.g. gitlab, github, etc.</p><p>Prefect Git Storage workflow steps for 'building' and deploying data pipeline flows include:</p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Steps</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">PlantUML</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><p><a target=\"_blank\" href=\"/assets/files/image2-d57463bea4147ef77047e87d3b7a49a7.png\"><img loading=\"lazy\" alt=\"Workflow Steps\" src=\"/assets/images/image2-d57463bea4147ef77047e87d3b7a49a7.png\" width=\"253\" height=\"361\" class=\"img_ev3q\"></a> </p></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@startuml \"git-storage-workflow\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">(*) --&gt; \"push commited flow code</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">changes to git service\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--&gt; \"register PrefectFlow</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">using branch or tag reference\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--&gt; \"run flow in Prefect Server or Cloud</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">(code pulled from git service)\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--&gt; (*)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@enduml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><ul><li>pushing the committed code to the central git service</li><li>registering the flow using the git repository url and branch or tag reference</li><li>running the flow by pulling the reference code from the git service in a kubernetes pod</li></ul><p>The container image build and push steps are removed from the developer feedback cycle time.\nDepending on network bandwidth and image build times, this can save remove 5 to 10 minutes from each deployment iteration.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"pushing-the-flow-code\">Pushing the flow code<a class=\"hash-link\" href=\"#pushing-the-flow-code\" title=\"Direct link to heading\">​</a></h3><p>Once a set of changes to the data pipeline code has been committed, push to the central git service.</p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ </span><span class=\"token function\" style=\"color:#d73a49\">git</span><span class=\"token plain\"> commit</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ </span><span class=\"token function\" style=\"color:#d73a49\">git</span><span class=\"token plain\"> push</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"registering-the-flow\">Registering the flow<a class=\"hash-link\" href=\"#registering-the-flow\" title=\"Direct link to heading\">​</a></h3><p>The flow can be registered with Prefect using either a branch (HEAD or latest) or tag reference.  Assuming\na workflow with feature branches:</p><ul><li>feature branches: register the flow code using the feature branch.  This enables the latest version (HEAD)\nof the pushed flow code to be used for execution.  It also enables skipping re-registration of the flow on new\nchanges as the HEAD of the branch is pulled on each flow run</li><li>main line branches: register pinned versions of the flow using git tags.  This enables the use of a\nspecific version of the flow code to be pulled on each flow run, regardless of future changes.</li></ul><p>Determining the which reference to use:</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># using gitpython module to work with repo info</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> git </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Repo</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># presidence for identifing where to find the flow code</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># BUILD_TAG =&gt; GIT_BRANCH =&gt; active_branch</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">build_tag </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> branch_name </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">build_tag </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> os</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">getenv</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"BUILD_TAG\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> build_tag </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  branch_name </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> os</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">getenv</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"GIT_BRANCH\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> branch_name </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    branch_name </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Repo</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">os</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">getcwd</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">active_branch</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Configuring Prefect Git storage:</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> prefect</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">storage </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Git</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> my_flows</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">hello_flow </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> flow </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># assuming flow is defined in ./my_flows/flow.py</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># example using Gitlab</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># either branch_name or tag must be empty string \"\" or None</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">storage </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> Git</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    repo_host</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">git_hostname</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    repo</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">repo_path</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    flow_path</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">flow</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">.</span><span class=\"token string-interpolation interpolation\">__name__</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">.</span><span class=\"token string-interpolation interpolation\">replace</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation string\" style=\"color:#e3116c\">'.'</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">,</span><span class=\"token string-interpolation interpolation string\" style=\"color:#e3116c\">'/'</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">.py\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    flow_name</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">flow</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">flow</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    branch_name</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">branch_name</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tag</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">build_tag</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    git_token_secret_name</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">git_token_secret_name</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    git_token_username</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">git_token_username</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">storage</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">add_flow</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">flow</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">flow</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">flow</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">flow</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">storage </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> storage</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">flow</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">flow</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">regsiter</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">build</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Once registered, the flow storage details can be viewed in the Prefect Server or Prefect Cloud UI.  In this example, Prefect will use the <code>HEAD</code> version of the <code>main</code> branch on each flow run.</p><p><a target=\"_blank\" href=\"/assets/files/flow-storage-details-e2be96914a590e405cacb47ffc0eceaa.png\"><img loading=\"lazy\" alt=\"hello flow storage details\" src=\"/assets/images/flow-storage-details-e2be96914a590e405cacb47ffc0eceaa.png\" width=\"678\" height=\"339\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"next-steps---run-config\">Next Steps - Run Config<a class=\"hash-link\" href=\"#next-steps---run-config\" title=\"Direct link to heading\">​</a></h2><p>With Prefect Git Storage the runtime configuration and environment management is decoupled from the\ndata pipeline development workflow.  Unlike with Docker Storage, with Git Storage, the runtime\nexecution environment and data pipeline development workflows are defined and managed separately.\nAs an added benefit, the developer feedback loop cycle time is also reduced.</p><p>With the data engineering workflow addressed, the next step in scaling out the Prefect solution\nturns to configuration and lifecycle management of the runtime environment for data pipelines.\nPrefect Run Configs and Job templates provide the tools retaining the flexibility on container\nimage based runtime environments with improved manageability.</p>",
            "url": "https://fullstackchronicles.io/scaling-up-prefect-with-gitstorage",
            "title": "Scaling up Prefect with GitStorage",
            "summary": "Prefect.io is a python based Data Engineering toolbox for building and",
            "date_modified": "2022-02-28T00:00:00.000Z",
            "author": {
                "name": "Chris Ottinger",
                "url": "https://github.com/datwiz"
            },
            "tags": [
                "prefect",
                "gitlab",
                "docker",
                "etl"
            ]
        },
        {
            "id": "implementing-a-serverless-sftp-gateway-using-the-aws-transfer-family",
            "content_html": "<blockquote><p>When you want the SFTP service without the SFTP Server.  </p></blockquote><p>In implementing data platforms with external data providers, it is common to use a managed file transfer platform or an SFTP gateway as an entry point for providers to supply data to your system.  </p><p>Often in past implementations this would involve deploying a sever (typically a Linux VM) and provisioning and configuring an SFTP service.  If you wanted the data sent by clients to be copied to another storage medium (such as S3 or EFS) you would need to roll your own code or subscribe to a marketplace offering to do so.  </p><p>I recently trialled the <a href=\"https://docs.aws.amazon.com/transfer/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Transfer Family SFTP gateway</a> offering from AWS and sharing my adventures here.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"architecture\">Architecture<a class=\"hash-link\" href=\"#architecture\" title=\"Direct link to heading\">​</a></h2><p>In this reference architecture, we are deploying an SFTP service which uses a path in an S3 bucket as a user’s home directory.  Objects in the bucket are encrypted with a customer managed KMS key.  The SFTP server front end address is mapped to a vanity URL using Route53.  The bucket and path are integrated with a <code>STORAGE INTEGRATION</code>, <code>STAGE</code> and <code>PIPE</code> definition in Snowflake.  The Snowflake bits are covered in more detail in this blog: <strong><a href=\"/automating-snowflake-role-based-storage-integration-for-aws\">Automating Snowflake Role Based Storage Integration for AWS</a></strong>.  This article just details the AWS Transfer Family SFTP setup.</p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Architecture</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">PlantUML</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><p><a target=\"_blank\" href=\"/assets/files/aws-transfer-sftp-architecture-7964e0e7ee271b7c690605e7cfa8a72d.png\"><img loading=\"lazy\" alt=\"AWS Transfer SFTP Architecture\" src=\"/assets/images/aws-transfer-sftp-architecture-7964e0e7ee271b7c690605e7cfa8a72d.png\" width=\"1014\" height=\"725\" class=\"img_ev3q\"></a> </p></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@startuml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">skinparam rectangle&lt;&lt;boundary&gt;&gt; {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    Shadowing false</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    StereotypeFontSize 0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    FontColor #444444</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    BorderColor #444444</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    BorderStyle dashed</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">skinparam defaultTextAlignment center</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!$imgroot = \"https://github.com/avensolutions/plantuml-cloud-image-library/raw/main/images\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $AwsS3($alias, $label, $techn, $descr=\"\", $stereo=\"AWS S3\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/aws/Storage/S3.png&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $Kms($alias, $label, $techn, $descr=\"\", $stereo=\"AWS KMS\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/aws/SecurityIdentityCompliance/kms.png{scale=0.80}&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $Route53($alias, $label, $techn, $descr=\"\", $stereo=\"AWS Route53\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/aws/Networking/route53.png{scale=0.80}&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $AwsTransferFamily($alias, $label, $techn, $descr=\"\", $stereo=\"AWS Transfer Family\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/aws/MigrationTransfer/TransferFamily.png&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $Data($alias, $label, $techn, $descr=\"\", $stereo=\"Data\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/general/documents.png&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $Snowpipe($alias, $label, $techn, $descr=\"\", $stereo=\"Snowpipe\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/snowflake/snowpipe.png{scale=0.60}&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $SnowflakeDb($alias, $label, $techn, $descr=\"\", $stereo=\"Snowflake DB\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/snowflake/snowflakeDB.png{scale=0.70}&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$Data(supplier, Data Supplier, External Client)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">rectangle \"AWS Environment\" &lt;&lt;boundary&gt;&gt; {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $AwsTransferFamily(sftpgw, SFTP/FTPS Gateway, AWS Transfer Family)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $AwsS3(s3staging, Staging Bucket, AWS S3 Bucket)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $Kms(kms, KMS Key, Customer Managed Key)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $Route53(r53, CNAME Record, Route53 Record)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">rectangle \"Snowflake Environment\" &lt;&lt;boundary&gt;&gt; {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $Snowpipe(snowpipe, Snowpipe, Snowpipe)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $SnowflakeDb(db, Snowflake DB, Snowflake DB)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">r53 -[hidden]D- sftpgw</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">supplier -&gt; r53 : resolves name</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">r53 -&gt; supplier : gets address</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">supplier -RIGHT-&gt; sftpgw : SFTP</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">sftpgw -DOWN-&gt; kms : uses</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">sftpgw -RIGHT-&gt; s3staging: writes to</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">s3staging -RIGHT-&gt; snowpipe: writes to</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">snowpipe -DOWN-&gt; kms: uses</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">snowpipe -RIGHT-&gt; db: writes to</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@enduml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"setup\">Setup<a class=\"hash-link\" href=\"#setup\" title=\"Direct link to heading\">​</a></h2><p>The steps to set up this pattern are detailed below.  </p><div class=\"theme-admonition theme-admonition-info alert alert--info admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_S0QG\"><p>This example uses the Jsonnet/CloudFormation pattern described in this article: <strong><a href=\"/simplifying-large-cloudformation-templates-using-jsonnet\">Simplifying Large CloudFormation Templates using Jsonnet</a></strong>.  This is a useful pattern for breaking up a monolithic CloudFormation template at design time to more manageable resource scoped documents, then pre-processing these in a CI routine (GitLab CI, GitHub Actions, etc) to create a complete template.</p></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"setup-the-service\">Setup the Service<a class=\"hash-link\" href=\"#setup-the-service\" title=\"Direct link to heading\">​</a></h2><p>To setup the SFTP transfer service use the <code>AWS::Transfer::Server</code> resource type as shown below:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-c8b4ce8ab478715753aab73d478f4fcd\"></iframe><div class=\"theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z\"></path></svg></span>note</div><div class=\"admonitionContent_S0QG\"><p>Use the <code>tags</code> shown to display the custom hostname (used as a vanity url) in the Transfer UI in the AWS console.</p></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-the-s3-bucket\">Create the S3 Bucket<a class=\"hash-link\" href=\"#create-the-s3-bucket\" title=\"Direct link to heading\">​</a></h2><p>Create a bucket which will be used to store incoming files sent via SFTP.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-82eb106bc13f1a888f823cc71a7ff933\"></iframe><div class=\"theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z\"></path></svg></span>note</div><div class=\"admonitionContent_S0QG\"><p>This example logs to a logging bucket, not shown for brevity.</p></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-a-customer-managed-kms-key\">Create a Customer Managed KMS Key<a class=\"hash-link\" href=\"#create-a-customer-managed-kms-key\" title=\"Direct link to heading\">​</a></h2><p>Create a customer managed KMS key which will be used to encrypt data stored in the S3 bucket created in the previous step.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-2c563411442c4541584815389de8a3b5\"></iframe><h1>Create an IAM role to access the bucket</h1><p>Create an IAM role which will be assumed by the AWS Transfer Service to read and write to the S3 staging bucket.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-57e23a5c99c22f5550e99b086db5f9f1\"></iframe><div class=\"theme-admonition theme-admonition-important alert alert--info admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_S0QG\"><p>You must assign permissions to use the KMS key created previously, failure to do so will result in errors such as:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">remote readdir(): Permission denied</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"user-directory-mappings\">User Directory Mappings<a class=\"hash-link\" href=\"#user-directory-mappings\" title=\"Direct link to heading\">​</a></h2><p>An SFTP users home directory is mapped to a path in your S3 bucket.  It is recommended to use the <code>LOGICAL</code> <code>HomeDirectoryType</code>.  This will prevent SFTP users from:</p><ul><li>seeing or being able to access other users home directories</li><li>seeing the bucket name or paths in the bucket above their home directory</li></ul><p>There are some trade offs for this which can make deployment a little more challenging but we will cover off the steps from here.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-a-scoped-down-policy\">Create a Scoped Down Policy<a class=\"hash-link\" href=\"#create-a-scoped-down-policy\" title=\"Direct link to heading\">​</a></h3><p>A \"scoped down\" policy prevents users from seeing or accessing objects in other users home directories.  This is a text file that will be sourced as a string into the <code>Policy</code> parameter of each SFTP user you create.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-5e876bbf95b1b36355fa8af868572a26\"></iframe><div class=\"theme-admonition theme-admonition-important alert alert--info admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z\"></path></svg></span>info</div><div class=\"admonitionContent_S0QG\"><p>Using the <code>LOGICAL</code> <code>HomeDirectoryType</code> you don't have access to variables which represent the bucket, so this needs to be hard coded in the <code>policy.txt</code> document.  </p><p>Also if you are using a customer managed KMS key to encrypt the data in the bucket (which you should be), you need to add permissions to the key - which again cannot be represented by a variable.  </p><p>Failure to do so will result in errors when trying to <code>ls</code>, <code>put</code>, etc into the user's home directory such as:  </p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Couldn't read directory: Permission denied</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Couldn't close file: Permission denied</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Since these properties are unlikely to change for the lifetime of your service this should not be an issue.  </p></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-a-user\">Create a user<a class=\"hash-link\" href=\"#create-a-user\" title=\"Direct link to heading\">​</a></h3><p>Users are identified by a username and an SSH key, providing the public key to the server.  A sample user is shown here:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-1b946b07374b78e0aca380317729bfa9\"></iframe><div class=\"theme-admonition theme-admonition-tip alert alert--success admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 12 16\"><path fill-rule=\"evenodd\" d=\"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z\"></path></svg></span>tip</div><div class=\"admonitionContent_S0QG\"><p>As discussed previously, it is recommended to use <code>LOGICAL</code> home directory mappings, which prevents users from seeing information about the bucket or other directories on the SFTP server (including other users directories).</p></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-a-route-53-cname-record\">Create a Route 53 CNAME record<a class=\"hash-link\" href=\"#create-a-route-53-cname-record\" title=\"Direct link to heading\">​</a></h2><p>Ideally you want to use a vanity url for users to access your SFTP service, such as <code>sftp.yourcompany.com</code>.  This can be accomplished by using a Route 53 CNAME record as shown here:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-0098851edc8d60b45534f6b1134be8cd\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-some-shared-tags\">Create some shared Tags<a class=\"hash-link\" href=\"#create-some-shared-tags\" title=\"Direct link to heading\">​</a></h2><p>You would have noticed a shared <code>Tags</code> definition in many of the <code>libsonnet</code> files shown, an example <code>Tags</code> source file is shown here:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-8323d49f1045d2cd8c874d5a00e82a5e\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"pull-it-all-together\">Pull it all together!<a class=\"hash-link\" href=\"#pull-it-all-together\" title=\"Direct link to heading\">​</a></h2><p>Now that we have all of the input files, lets pull them all together in a <code>jsonnet</code> file, which will be preprocessed in a CI process to create a template we can deploy with AWS CloudFormation.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-f56065c075af9cc33853b0624f6ef636\"></iframe><p>Your customers would now connect to your service using they private key which corresponds to the public key they supplied to you in one of the previous steps, for example:    </p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token function\" style=\"color:#d73a49\">sftp</span><span class=\"token plain\"> -i mysftpkey jeffrey_aven@sftp.yourdomain.com</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Add more users and enjoy!</p>",
            "url": "https://fullstackchronicles.io/implementing-a-serverless-sftp-gateway-using-the-aws-transfer-family",
            "title": "Implementing a Serverless SFTP Gateway using the AWS Transfer Family",
            "summary": "An example implementation of an SFTP gateway using the AWS Transfer Family service, to store client data in an encrypted S3 bucket.",
            "date_modified": "2022-02-23T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "aws",
                "aws transfer family",
                "serverless",
                "snowflake",
                "snowpipe",
                "sftp",
                "managed file transfer"
            ]
        },
        {
            "id": "simple-sso-with-an-external-idp-using-active-directory-and-okta",
            "content_html": "<p>This article describes a simple SSO pattern for authenticating and authorizing users from an external AD and to your application without requiring federation.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-challenge\">the Challenge<a class=\"hash-link\" href=\"#the-challenge\" title=\"Direct link to heading\">​</a></h2><p>You need to authenticate external users to use your application, these users belong to an organization using Azure Active Directory with specific login policies (such as password strength and expiry, multi factor authentication, etc).  Your requirements (if you choose to accept them) are:</p><ol><li>You are required to provide SSO to these users using their home AD tenant and policies</li><li>The solution does not include SAML based federation between directories (yours and theirs)</li><li>The solution does not require any changes on the external AD tenant (no new AAD applications, client secrets, etc)</li></ol><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-solution\">the Solution<a class=\"hash-link\" href=\"#the-solution\" title=\"Direct link to heading\">​</a></h2><p>Using an IDAM/IDaaS platform (such as Okta in this case), along with an AAD application (in your AD tenant in your Azure subscription), you can create a local AD app using this magic property to accomplish all of the above requirements (requiring zero changes on the third-party AD).  </p><p><a target=\"_blank\" href=\"/assets/files/azure-ad-app-registration-9857aa65a9e76e9710d04eb12cf875c2.png\"><img loading=\"lazy\" alt=\"Azure AD App Registration\" src=\"/assets/images/azure-ad-app-registration-9857aa65a9e76e9710d04eb12cf875c2.png\" width=\"849\" height=\"900\" class=\"img_ev3q\"></a> </p><p>This is what it looks like using the <code>az</code> cli:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-8b70fbe242da02ca844bf2fe53355743\"></iframe><p>the <code>--available-to-other-tenants</code> property is Microsoft's way of allowing you to implicitly trust other AAD/Office 365 tenants, meaning the authentication request is passed to the target AD tenant from your application.  </p><p>Here is a context diagram which explains the interactions in the context of a Jamstack application (using a library such as Auth.js).  </p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Overview</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">PlantUML</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><p><a target=\"_blank\" href=\"/assets/files/okta-ad-sso-context-diagram-080a3ead154d3ab5f7a1ebb43259f3ed.png\"><img loading=\"lazy\" alt=\"Okta AD SSO Context Diagram\" src=\"/assets/images/okta-ad-sso-context-diagram-080a3ead154d3ab5f7a1ebb43259f3ed.png\" width=\"662\" height=\"571\" class=\"img_ev3q\"></a> </p></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"language-plantuml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-plantuml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@startuml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!define C4Puml https://raw.githubusercontent.com/RicardoNiepel/C4-PlantUML/master</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl C4Puml/C4_Context.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl C4Puml/C4_Component.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl C4Puml/C4_Container.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">'left to right direction</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!define Rel_NoRank(e_from,e_to, e_label=\" \") Rel_(e_from,e_to, e_label, \"-[norank]-&gt;\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!$imgroot = \"https://github.com/avensolutions/plantuml-cloud-image-library/raw/main/images\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $AzureActiveDirectory($alias, $label, $techn, $descr=\"\", $stereo=\"Azure Active Directory\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/azure/AzureActiveDirectory.png{scale=0.75}&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $Okta($alias, $label, $techn, $descr=\"\", $stereo=\"Okta\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/okta/okta.png{scale=1}&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Person(user, User\\n&lt;i&gt;UserAgent (Browser) )</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Person(admin, Application Admin)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">note right</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Create users in the Okta org with the same email as the users email address in their AD (external AD)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">end note</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">rectangle \"Application Environment\" &lt;&lt;boundary&gt;&gt; as app{</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $AzureActiveDirectory(localad, Local AD Tenant, Azure Active Directory)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $Okta(okta, Local Okta Org, Okta)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$AzureActiveDirectory(otherad, Azure AD Tenant\\n&lt;i&gt;(External AD), Azure Active Directory)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Lay_D(user, okta)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Lay_R(okta, localad)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Lay_R(localad, otherad)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Lay_D(okta, admin)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel_U(okta, user, access code)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel_D(user, okta, authorize request)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel_R(okta, localad, routes to)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel_R(localad, otherad, forwards to)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel_U(admin, okta, creates users)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@enduml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"setup-and-configuration\">Setup and Configuration<a class=\"hash-link\" href=\"#setup-and-configuration\" title=\"Direct link to heading\">​</a></h2><p>The following flowchart explains the steps involved in setting this up.  The highlighted nodes are part of normal application lifecycle operations as users get created and deactivated.  </p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Flowchart</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">Mermaid</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><p><a target=\"_blank\" href=\"/assets/files/okta-ad-sso-setup-flowchart-ae59463b7d2de2881cb11b6b9520f198.svg\"><img loading=\"lazy\" alt=\"Okta AD SSO Setup Flowchart\" src=\"/assets/images/okta-ad-sso-setup-flowchart-ae59463b7d2de2881cb11b6b9520f198.svg\" width=\"749\" height=\"810\" class=\"img_ev3q\"></a> </p></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"language-mermaid codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-mermaid codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">flowchart TD;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  subgraph Local Azure AD;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    a1(1. Create AD App);</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  end;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  subgraph Okta;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    b1(2. Create IdP)--&gt;b2(3. Create Application);</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    b2--&gt;b3(4. Create IdP\\nRouting Rule\\nfor Application);</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    b3--&gt;b4(5. Create Group);</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    b4--&gt;b5(6. Assign Group\\nto Application);</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    b5--&gt;c1(7. Create User);</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    c1--&gt;c2(8. Add User to Group);</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    style c1 fill:#f9f,stroke:#333,stroke-width:4px;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    style c2 fill:#f9f,stroke:#333,stroke-width:4px;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  end;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  subgraph Application;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    d1(9. Configure ISSUER\\nand CLIENTID);      </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  end;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  a1--&gt;Okta;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  b3--&gt;Application;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"authorisation-flow\">Authorisation flow<a class=\"hash-link\" href=\"#authorisation-flow\" title=\"Direct link to heading\">​</a></h2><p>The authorization flow for a public client (SPA) using PKCE (Proof Key for Code Exchange) is shown here:    </p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Sequence</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">Mermaid</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><p><a target=\"_blank\" href=\"/assets/files/okta-ad-sso-authorization-flow-760ab053c2fea594de308cd833cf8975.svg\"><img loading=\"lazy\" alt=\"Okta AD SSO Authorization Flow\" src=\"/assets/images/okta-ad-sso-authorization-flow-760ab053c2fea594de308cd833cf8975.svg\" width=\"1501\" height=\"785\" class=\"img_ev3q\"></a></p></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"language-mermaid codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-mermaid codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">sequenceDiagram;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  %%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#AACCFF', 'primaryBorderColor': '#999000', 'actorLineColor': '#000000' }}}%%;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  participant user as User;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  participant spa as User Agent (SPA);</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  participant be as Back End APIs;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  participant okta as Okta;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  participant msft as Microsoft Login;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  user-&gt;&gt;spa: ;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  spa-&gt;&gt;okta: local.okta.com/../authorize;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  Note over spa,okta: includes client_id (okta), code_challenge (PKCE), redirect_uri (to app), response_type, scope</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  okta--&gt;&gt;spa: 302 REDIRECT; </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  spa-&gt;&gt;msft: login.microsoftonline.com/../authorize;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  Note over spa,msft: includes client_id (msft app id), state, redirect_uri (to okta), response_type, scope</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  msft-&gt;&gt;msft: authenticate;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  msft--&gt;&gt;okta: local.okta.com/../authorize/callback;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  okta--&gt;&gt;msft:  302 REDIRECT;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  msft--&gt;&gt;spa: app/callback?code=xxx;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  spa-&gt;&gt;okta: exchange code for an access token;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  okta-&gt;&gt;spa: token;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  spa-&gt;&gt;be: present token to access resources;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"next-up\">Next up<a class=\"hash-link\" href=\"#next-up\" title=\"Direct link to heading\">​</a></h2><p><code>Code!</code>  Stay tuned...</p>",
            "url": "https://fullstackchronicles.io/simple-sso-with-an-external-idp-using-active-directory-and-okta",
            "title": "Simple SSO with an external IdP using Active Directory and Okta",
            "summary": "A simple SSO pattern for authenticating and authorizing users from an external AD and to your application without requiring federation.",
            "date_modified": "2022-02-04T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "okta",
                "azure",
                "active directory",
                "azure active directory",
                "sso",
                "single sign on",
                "identity"
            ]
        },
        {
            "id": "converting-to-local-time-in-aws-lambda-using-nodejs",
            "content_html": "<h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"background\">Background<a class=\"hash-link\" href=\"#background\" title=\"Direct link to heading\">​</a></h2><p>AWS Lambda instances will return UTC/GMT time for any date time object created using the <code>Date.now()</code> function in JavaScript as shown here:  </p><div class=\"language-javascript codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-javascript codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> now </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">const</span><span class=\"token plain\"> tzOffset </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> now</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getTimezoneOffset</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token console class-name\">console</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">log</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token template-string string\" style=\"color:#e3116c\">Default Timezone Offset: </span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">${</span><span class=\"token template-string interpolation\">tzOffset</span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">}</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// results in ...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// Default Timezone Offset: 0</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Moreover, Lambda instances are stateless and have no concept of local time.  This can make dealing with dates more challenging.  </p><p>This is compounded for localities which have legislated Daylight Savings Time during part of the year.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"solution\">Solution<a class=\"hash-link\" href=\"#solution\" title=\"Direct link to heading\">​</a></h2><p>A simple (vanilla JavaScript - no third party libraries or external API calls) to adjust the time to local time adjusted for Daylight Savings Time is provided here:  </p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Commented</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">Uncommented</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><div class=\"language-javascript codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-javascript codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">function</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getGmtDstTransitionDate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token parameter\">year</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">,</span><span class=\"token parameter\"> month</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">,</span><span class=\"token parameter\"> transitionDay</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">,</span><span class=\"token parameter\"> hour</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">const</span><span class=\"token plain\"> firstDayOfTheMonth </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">year</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> month</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> transitionDate </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">firstDayOfTheMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// find the first transition day of the month if the first day of the month is not a transition day</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">firstDayOfTheMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getDay</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">!==</span><span class=\"token plain\"> transitionDay</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        transitionDate </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">firstDayOfTheMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">setDate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">firstDayOfTheMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getDate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">transitionDay </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\"> firstDayOfTheMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getDay</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// return the transition date and time</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">transitionDate</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getTime</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">hour </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">60</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">60000</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">function</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getLocalDateTime</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token parameter\">date</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// default to GMT+11 for AEDT</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> offsetInHours </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">11</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// if month is between April and October check further, if not return AEDT offset</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// remeber getMonth is zero based!</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">date</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&gt;=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&amp;&amp;</span><span class=\"token plain\"> date</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&lt;=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">9</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// DST starts at 0200 on the First Sunday in October, which is 1600 (16) on the First Saturday (6) in October (9) GMT</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">const</span><span class=\"token plain\"> dstStartDate </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getGmtDstTransitionDate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">date</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getFullYear</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">9</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">6</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">16</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// DST ends at 0300 on the First Sunday in April, which is 1600 (16) on the First Saturday (6) in April (3) GMT</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">const</span><span class=\"token plain\"> dstEndDate </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getGmtDstTransitionDate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">date</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getFullYear</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">6</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">16</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">date </span><span class=\"token operator\" style=\"color:#393A34\">&gt;=</span><span class=\"token plain\"> dstEndDate </span><span class=\"token operator\" style=\"color:#393A34\">&amp;&amp;</span><span class=\"token plain\"> date </span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token plain\"> dstStartDate</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            offsetInHours </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">10</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// return the date and time in local time</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">date</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getTime</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">offsetInHours </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">60</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">60000</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// get current timestamp</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> now </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token console class-name\">console</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">log</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token template-string string\" style=\"color:#e3116c\">UTC Date: </span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">${</span><span class=\"token template-string interpolation\">now</span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">}</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">now </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getLocalDateTime</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">now</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token console class-name\">console</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">log</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token template-string string\" style=\"color:#e3116c\">Local toLocaleString: </span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">${</span><span class=\"token template-string interpolation\">now</span><span class=\"token template-string interpolation punctuation\" style=\"color:#393A34\">.</span><span class=\"token template-string interpolation method function property-access\" style=\"color:#d73a49\">toLocaleString</span><span class=\"token template-string interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token template-string interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">}</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"language-javascript codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-javascript codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">function</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getGmtDstTransitionDate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token parameter\">year</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">,</span><span class=\"token parameter\"> month</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">,</span><span class=\"token parameter\"> transitionDay</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">,</span><span class=\"token parameter\"> hour</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">const</span><span class=\"token plain\"> firstDayOfTheMonth </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">year</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> month</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> transitionDate </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">firstDayOfTheMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">firstDayOfTheMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getDay</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">!==</span><span class=\"token plain\"> transitionDay</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        transitionDate </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">firstDayOfTheMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">setDate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">firstDayOfTheMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getDate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">transitionDay </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token plain\"> firstDayOfTheMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getDay</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">transitionDate</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getTime</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">hour </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">60</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">60000</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">function</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getLocalDateTime</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token parameter\">date</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> offsetInHours </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">11</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">date</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&gt;=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&amp;&amp;</span><span class=\"token plain\"> date</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getMonth</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&lt;=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">9</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">const</span><span class=\"token plain\"> dstStartDate </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getGmtDstTransitionDate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">date</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getFullYear</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">9</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">6</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">16</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">const</span><span class=\"token plain\"> dstEndDate </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getGmtDstTransitionDate</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">date</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getFullYear</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">6</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">16</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">date </span><span class=\"token operator\" style=\"color:#393A34\">&gt;=</span><span class=\"token plain\"> dstEndDate </span><span class=\"token operator\" style=\"color:#393A34\">&amp;&amp;</span><span class=\"token plain\"> date </span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token plain\"> dstStartDate</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            offsetInHours </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">10</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">date</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">getTime</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">offsetInHours </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">60</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">60000</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">let</span><span class=\"token plain\"> now </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token console class-name\">console</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">log</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token template-string string\" style=\"color:#e3116c\">UTC Date: </span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">${</span><span class=\"token template-string interpolation\">now</span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">}</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">now </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">getLocalDateTime</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">now</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token console class-name\">console</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">log</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token template-string string\" style=\"color:#e3116c\">Local toLocaleString: </span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">${</span><span class=\"token template-string interpolation\">now</span><span class=\"token template-string interpolation punctuation\" style=\"color:#393A34\">.</span><span class=\"token template-string interpolation method function property-access\" style=\"color:#d73a49\">toLocaleString</span><span class=\"token template-string interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token template-string interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">}</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"breaking-it-down\">Breaking it down<a class=\"hash-link\" href=\"#breaking-it-down\" title=\"Direct link to heading\">​</a></h3><p>This solution is comprised of two functions for DRY purposes.  </p><p>The main function <code>getLocalDateTime</code> takes a date object representing the current time in UTC and returns a date object representing the local (DST adjusted) time.  </p><p>The <code>getLocalDateTime</code> function sets a default DST adjusted offset in hours (11 in the case of AEDT), if the month is between April and October the <code>getGmtDstTransitionDate</code> is used to determine the exact boundaries between Standard Time and Daylight Savings Time.  </p><p>In the case of AEST/AEDT this is the first Sunday in October at 0200 to enter Daylight Savings Time and the first Sunday in April at 0300 to end Daylight Savings Time (both dates and times are adjusted to their equivalent GMT times) and return to Standard Time (10 hours in the cases of AEST).  </p><p>The <code>offsetInHours</code> variable and the arguments for <code>getGmtDstTransitionDate</code> can be easily modified for other timezones.  </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"tests\">Tests<a class=\"hash-link\" href=\"#tests\" title=\"Direct link to heading\">​</a></h3><p>Some simple tests to run to check if the code is working correctly, to help with this I have set up the following unit test function:  </p><div class=\"language-javascript codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-javascript codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">function</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">unitTest</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token parameter\">inputDate</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">,</span><span class=\"token parameter\"> expOutputDate</span><span class=\"token parameter punctuation\" style=\"color:#393A34\">,</span><span class=\"token parameter\"> testCase</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token function\" style=\"color:#d73a49\">getLocalDateTime</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">inputDate</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">toUTCString</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">===</span><span class=\"token plain\"> expOutputDate</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">toUTCString</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token console class-name\">console</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">log</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token template-string string\" style=\"color:#e3116c\">TEST PASSED </span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">${</span><span class=\"token template-string interpolation\">testCase</span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">}</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"> </span><span class=\"token keyword control-flow\" style=\"color:#00009f\">else</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token console class-name\">console</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token method function property-access\" style=\"color:#d73a49\">log</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token template-string string\" style=\"color:#e3116c\">TEST FAILED </span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">${</span><span class=\"token template-string interpolation\">testCase</span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">}</span><span class=\"token template-string string\" style=\"color:#e3116c\"> : input date in GMT </span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">${</span><span class=\"token template-string interpolation\">inputDate</span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">}</span><span class=\"token template-string string\" style=\"color:#e3116c\"> should equal </span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">${</span><span class=\"token template-string interpolation\">expOutputDate</span><span class=\"token template-string interpolation interpolation-punctuation punctuation\" style=\"color:#393A34\">}</span><span class=\"token template-string template-punctuation string\" style=\"color:#e3116c\">`</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>first create dates representing the beginning of Daylight Savings Time (immediately before the beginning, at the beginning and immediately after the beginning):  </p><div class=\"language-javascript codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-javascript codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token function\" style=\"color:#d73a49\">unitTest</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">9</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">15</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">59</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">59</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">999</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">9</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">59</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">59</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">999</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"one ms before dst start\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// returns...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// ...  INFO    TEST PASSED one ms before dst start</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">unitTest</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">9</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">16</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">9</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"dst start\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// returns...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// ...  INFO    TEST PASSED dst start    </span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">unitTest</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">9</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">16</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">9</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"one ms after dst start\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// returns...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// ...  INFO    TEST PASSED one ms after dst start</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>next create dates similar tests representing the end of Daylight Savings Time (or beginning of Standard Time):  </p><div class=\"language-javascript codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-javascript codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token function\" style=\"color:#d73a49\">unitTest</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">15</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">59</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">59</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">999</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">59</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">59</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">999</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"one ms before dst end\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// returns...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// ...  INFO    TEST PASSED one ms before dst end    </span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">unitTest</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">16</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"dst end\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// returns...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// ...  INFO    TEST PASSED dst end    </span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token function\" style=\"color:#d73a49\">unitTest</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">16</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">new</span><span class=\"token plain\"> </span><span class=\"token class-name\">Date</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token number\" style=\"color:#36acaa\">2022</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">2</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"one ms after dst end\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// returns...</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">// ...  INFO    TEST PASSED one ms after dst end</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Enjoy</p>",
            "url": "https://fullstackchronicles.io/converting-to-local-time-in-aws-lambda-using-nodejs",
            "title": "Converting to local time in AWS Lambda using Node.js",
            "summary": "A simple pattern for converting dates in AWS Lambda using a Node.js runtime from GMT/UTC (the default) to a local time observing daylight savings time.",
            "date_modified": "2022-01-29T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "aws",
                "lambda",
                "nodejs",
                "javascript"
            ]
        },
        {
            "id": "automating-snowflake-role-based-storage-integration-for-aws",
            "content_html": "<p>I have used the instructions <a href=\"https://docs.snowflake.com/en/user-guide/data-load-snowpipe-auto-s3.html\" target=\"_blank\" rel=\"noopener noreferrer\">here</a> to configure Snowpipe for several projects.  </p><p>Although it is accurate, it is entirely click-ops oriented.  I like to automate (and script) everything, so I have created a fully automated implementation using PowerShell, the <code>aws</code> and <code>snowsql</code> CLIs.  </p><p>The challenge is that you need to go back and forth between AWS and Snowflake, exchanging information from each platform with the other.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"overview\">Overview<a class=\"hash-link\" href=\"#overview\" title=\"Direct link to heading\">​</a></h2><p>A Role Based Storage Integration in Snowflake allows a user (an AWS user arn) in your Snowflake account to use a role in your AWS account, which in turns enables access to S3 and KMS resources used by Snowflake for an external stage.  </p><p>The following diagram explains this (along with the PlantUML code used to create the diagram..):  </p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Overview</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">PlantUML</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><p><a target=\"_blank\" href=\"/assets/files/snowflake-aws-storage-integration-73b391aee0770e6c9f9f8c3ac06d5d8a.png\"><img loading=\"lazy\" alt=\"Snowflake S3 Storage Integration\" src=\"/assets/images/snowflake-aws-storage-integration-73b391aee0770e6c9f9f8c3ac06d5d8a.png\" width=\"966\" height=\"468\" class=\"img_ev3q\"></a> </p></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"language-plantuml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-plantuml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@startuml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">skinparam rectangle&lt;&lt;boundary&gt;&gt; {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    Shadowing false</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    StereotypeFontSize 0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    FontColor #444444</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    BorderColor #444444</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    BorderStyle dashed</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">skinparam defaultTextAlignment center</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!$imgroot = \"https://github.com/avensolutions/plantuml-cloud-image-library/raw/main/images\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $AwsIam($alias, $label, $techn, $descr=\"\", $stereo=\"AWS IAM\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/aws/SecurityIdentityCompliance/Iam.png&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $AwsS3($alias, $label, $techn, $descr=\"\", $stereo=\"AWS S3\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/aws/Storage/S3.png&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!unquoted procedure $Snowflake($alias, $label, $techn, $descr=\"\", $stereo=\"Snowflake\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    rectangle \"==$label\\n\\n&lt;img:$imgroot/snowflake/snowflakeDB.png{scale=0.70}&gt;\\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//\" &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!endprocedure</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">rectangle \"Snowflake\" &lt;&lt;boundary&gt;&gt; {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $AwsIam(user, Snowflake IAM User, AWS IAM User)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $Snowflake(int, Storage Integration, Storage Integration)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $Snowflake(stage, External Stage, Stage)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">rectangle \"AWS\" &lt;&lt;boundary&gt;&gt; {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $AwsS3(bucket, Stage Bucket, AWS S3 Bucket)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $AwsIam(role, Snowflake Access Role, IAM Role)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    $AwsIam(policy, Snowflake Access Policy, IAM Policy)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">stage -UP-&gt; int : uses</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">int -RIGHT-&gt; user : uses</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">user -RIGHT-&gt; role : uses</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">policy -UP-&gt; role : attached to</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">role -RIGHT-&gt; bucket : allows access to</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@enduml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"setup\">Setup<a class=\"hash-link\" href=\"#setup\" title=\"Direct link to heading\">​</a></h2><p>Some prerequisites (removed for brevity):  </p><ol><li>set the following variables in your script:  </li></ol><ul><li><code>$accountid</code> – your AWS account ID</li><li><code>$bucketname</code> – the bucket you are letting Snowflake use as an External Stage</li><li><code>$bucketarn</code> – used in policy statements (you could easily derive this from the bucket name)</li><li><code>$kmskeyarn</code> – assuming you are used customer managed encryption keys, your Snowflake storage integration will need to use these to decrypt data in the stage</li><li><code>$prefix</code> – if you want to set up granular access (on a key/path basis)</li></ul><ol start=\"2\"><li>Configure Snowflake access credentials using environment variables or using the <code>~/.snowsql/config</code> file (you should definitely use the <code>SNOWSQL_PWD</code> env var for your password however)</li><li>Configure access to AWS using <code>aws configure</code></li></ol><div class=\"theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z\"></path></svg></span>note</div><div class=\"admonitionContent_S0QG\"><p>The actions performed in both AWS and Snowflake required privileged access on both platforms.</p></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-code\">The Code<a class=\"hash-link\" href=\"#the-code\" title=\"Direct link to heading\">​</a></h2><p>I have broken this into steps, the complete code is included at the end of the article.  </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-policy-documents\">Create Policy Documents<a class=\"hash-link\" href=\"#create-policy-documents\" title=\"Direct link to heading\">​</a></h3><p>You will need to create the policy documents to allow the role you will create to access objects in the target S3 bucket, you will also need an initial “Assume Role” policy document which will be used to create the role and then updated with information you will get from Snowflake later.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-73d507126c114e6ee7398226cf004f55\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-snowflake-access-policy\">Create Snowflake Access Policy<a class=\"hash-link\" href=\"#create-snowflake-access-policy\" title=\"Direct link to heading\">​</a></h3><p>Use the <code>snowflake_policy_doc.json</code> policy document created in the previous step to create a managed policy, you will need the <code>arn</code> returned in a subsequent statement.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-65be4f7c104f92fa3dbf9342813b3fd2\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-snowflake-iam-role\">Create Snowflake IAM Role<a class=\"hash-link\" href=\"#create-snowflake-iam-role\" title=\"Direct link to heading\">​</a></h3><p>Use the initial <code>assume_role_policy_doc.json</code> created to create a new Snowflake access role, you will need the <code>arn</code> for this resource when you configure the Storage Integration in Snowflake.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-e1bdd5316fe7cb106de1edcff77d8e2b\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"attach-s3-access-policy-to-the-role\">Attach S3 Access Policy to the Role<a class=\"hash-link\" href=\"#attach-s3-access-policy-to-the-role\" title=\"Direct link to heading\">​</a></h3><p>Now you will attach the <code>snowflake-access-policy</code> to the <code>snowflake-access-role</code> using the <code>$policyarn</code> captured from the policy creation statement.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-d2d54b43e379a26bd264a4c97939250c\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-storage-integration-in-snowflake\">Create Storage Integration in Snowflake<a class=\"hash-link\" href=\"#create-storage-integration-in-snowflake\" title=\"Direct link to heading\">​</a></h3><p>Use the <code>snowsql</code> CLI to create a Storage Integration in Snowflake supplying the <code>$rolearn</code> captured from the role creation statement.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-8e4617227bcd68be74c2a5d694c85f91\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"get-storage_aws_iam_user_arn-and-storage_aws_external_id\">Get <code>STORAGE_AWS_IAM_USER_ARN</code> and <code>STORAGE_AWS_EXTERNAL_ID</code><a class=\"hash-link\" href=\"#get-storage_aws_iam_user_arn-and-storage_aws_external_id\" title=\"Direct link to heading\">​</a></h3><p>You will need the <code>STORAGE_AWS_IAM_USER_ARN</code> and <code>STORAGE_AWS_EXTERNAL_ID</code> values for the storage integration you created in the previous statement, these will be used to updated the assume role policy in your <code>snowflake-access-role</code>.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-14dbf570030cad1a46d88d2e87006c8e\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"update-snowflake-access-policy\">Update Snowflake Access Policy<a class=\"hash-link\" href=\"#update-snowflake-access-policy\" title=\"Direct link to heading\">​</a></h3><p>Using the <code>STORAGE_AWS_IAM_USER_ARN</code> and <code>STORAGE_AWS_EXTERNAL_ID</code> values retrieved in the previous statements, you will update the <code>assume-role-policy</code> for the <code>snowflake-access-role</code>.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-944c39205e142de9a76266f7f3cd260b\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"test-the-storage-integration\">Test the Storage Integration<a class=\"hash-link\" href=\"#test-the-storage-integration\" title=\"Direct link to heading\">​</a></h3><p>To test the connectivity between your Snowflake account and your AWS external stage using the Storage Integartion just created, create a stage as shown here:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-99c24e8c80c6556fe381cf64c841f739\"></iframe><p>Now list objects in the stage (assuming there are any).  </p><div class=\"language-js codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-js codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">list @my_stage</span><span class=\"token punctuation\" style=\"color:#393A34\">;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>This should just work!  You can use your storage integration to create different stages for different paths in your External Stage bucket and use both of these objects to create Snowpipes for automated ingestion.  Enjoy!  </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"complete-code\">Complete Code<a class=\"hash-link\" href=\"#complete-code\" title=\"Direct link to heading\">​</a></h3><p>The complete code for this example is shown here:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-5f4cba25f4eac380d63f5829c56d0306\"></iframe>",
            "url": "https://fullstackchronicles.io/automating-snowflake-role-based-storage-integration-for-aws",
            "title": "Automating Snowflake Role Based Storage Integration for AWS",
            "summary": "Automate the creation of a Storage Integration in Snowflake which allows a Snowflake External Stage to access objects in your AWS S3 bucket.",
            "date_modified": "2021-12-18T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "aws",
                "snowflake",
                "snowpipe",
                "powershell",
                "snowsql",
                "infrastructureascode",
                "iac",
                "cloudautomation"
            ]
        },
        {
            "id": "simplifying-large-cloudformation-templates-using-jsonnet",
            "content_html": "<p>CloudFormation templates in large environments can grow beyond a manageable point.  This article provides one approach to breaking up CloudFormation templates into modules which can be imported and used to create a larger template to deploy a complex AWS stack – using Jsonnet.  </p><p>Jsonnet is a json pre-processing and templating library which includes features including user defined and built-in functions, objects, and inheritance amongst others.  If you are not familiar with Jsonnet, here are some good resources to start with:  </p><ul><li><a href=\"https://jsonnet.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Jsonnet</a></li><li><a href=\"https://cloudywithachanceofbigdata.com/using-jsonnet-to-configure-multiple-environments\" target=\"_blank\" rel=\"noopener noreferrer\">Blog Article: Using Jsonnet to Configure Multiple Environments</a></li><li><a href=\"https://docs.infraql.io/blog/using-the-jsonnet-map-function\" target=\"_blank\" rel=\"noopener noreferrer\">Blog Article: Using the Jsonnet Map Function</a></li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"advantages\">Advantages<a class=\"hash-link\" href=\"#advantages\" title=\"Direct link to heading\">​</a></h2><p>Using Jsonnet you can use imports to break up large stacks into smaller files scoped for each resource.  This approach makes CloudFormation template easier to read and write and allows you to apply the DRY (Do Not Repeat Yourself) coding principle (not possible with native CloudFormation templates.  </p><p>Additionally, although as the template fragments are in Jsonnet format, you can add annotations or comments to your code similar to YAML (not possible with a JSON template alone), although the rendered template is in legal CloudFormation Json format.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"process-overview\">Process Overview<a class=\"hash-link\" href=\"#process-overview\" title=\"Direct link to heading\">​</a></h2><p>The process is summarised here: </p><p><a target=\"_blank\" href=\"/assets/files/cloudformation-jsonnet-851900d3fb0edfa2930e846dd92c0b31.png\"><img loading=\"lazy\" alt=\"CloudFormation and Jsonnet\" src=\"/assets/images/cloudformation-jsonnet-851900d3fb0edfa2930e846dd92c0b31.png\" width=\"919\" height=\"439\" class=\"img_ev3q\"></a> </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"code\">Code<a class=\"hash-link\" href=\"#code\" title=\"Direct link to heading\">​</a></h2><p>This example will deploy a stack with a VPC and an S3 bucket with logging.  The project directory structure would look like this:  </p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">templates/</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">├─ includes/</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">│  ├─ vpc.libsonnet</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">│  ├─ s3landingbucket.libsonnet</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">│  ├─ s3loggingbucket.libsonnet</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">│  ├─ tags.libsonnet</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">├─ template.jsonnet</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Lets look at all of the constituent files:  </p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"templatejsonnet\"><code>template.jsonnet</code><a class=\"hash-link\" href=\"#templatejsonnet\" title=\"Direct link to heading\">​</a></h3><p>This is the root document which will be processed by Jsonnet to render a legal CloudFormation JSON template.  It will import the other files in the includes directory.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-8f2cc0c464de762f73b3f81c75a13832\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"includestagslibsonnet\"><code>includes/tags.libsonnet</code><a class=\"hash-link\" href=\"#includestagslibsonnet\" title=\"Direct link to heading\">​</a></h3><p>This code module is used to generate re-usable tags for other resources (DRY).  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-82e21743e845355ba0ef7240f1f7327a\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"includesvpclibsonnet\"><code>includes/vpc.libsonnet</code><a class=\"hash-link\" href=\"#includesvpclibsonnet\" title=\"Direct link to heading\">​</a></h3><p>This code module defines a VPC resource to be created with CloudFormation.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-e79189bbc1cfb8b72bd860c6381f6130\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"includess3loggingbucketlibsonnet\"><code>includes/s3loggingbucket.libsonnet</code><a class=\"hash-link\" href=\"#includess3loggingbucketlibsonnet\" title=\"Direct link to heading\">​</a></h3><p>This code module defines an S3 bucket resource to be created in the stack which will be used for logging for other buckets.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-187c97deca224617b064c4028ebbbee2\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"includess3landingbucketlibsonnet\"><code>includes/s3landingbucket.libsonnet</code><a class=\"hash-link\" href=\"#includess3landingbucketlibsonnet\" title=\"Direct link to heading\">​</a></h3><p>This code module defines an S3 landing bucket resource to be created in the stack.  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-c0dc5d868809f98ef672aca738bb1e5e\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"testing\">Testing<a class=\"hash-link\" href=\"#testing\" title=\"Direct link to heading\">​</a></h2><p>To test the pre-processing, you will need a Jsonnet binary/executable for your environment.  You can find Docker images which include this for you, or you could build it yourself.  </p><p>Once you have a compiled binary, you can run the following to generate a rendered CloudFormation template.  </p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">jsonnet template.jsonnet -o template.json</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>You can validate this template using the AWS CLI as shown here:  </p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">aws cloudformation validate-template --template-body file://template.json</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"deployment\">Deployment<a class=\"hash-link\" href=\"#deployment\" title=\"Direct link to heading\">​</a></h2><p>In a previous article, <a href=\"https://cloudywithachanceofbigdata.com/aws-deployments-with-cloudformation-and-gitlab-ci\" target=\"_blank\" rel=\"noopener noreferrer\">Simplified AWS Deployments with CloudFormation and GitLab CI</a>, I demonstrated an end-to-end deployment pipeline using GitLab CI.  Jsonnet pre-processing can be added to this pipeline as an initial ‘preprocess’ stage and job.  A snippet from the <code>.gitlab-ci.yml</code> file is included here:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-14c4c2fdccb27884c69c31f7b3a17a99\"></iframe><p>Enjoy!</p>",
            "url": "https://fullstackchronicles.io/simplifying-large-cloudformation-templates-using-jsonnet",
            "title": "Simplifying Large CloudFormation Templates using Jsonnet",
            "summary": "A simple pattern to break up large CloudFormation templates into smaller, more manageable modules using Jsonnet and GitLab CI.",
            "date_modified": "2021-11-21T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "aws",
                "awscloudformation",
                "jsonnet",
                "gitlab",
                "gitlabci",
                "infrastructureascode",
                "iac",
                "cloudautomation"
            ]
        },
        {
            "id": "aws-deployments-with-cloudformation-and-gitlab-ci",
            "content_html": "<p>Managing cloud deployments and IaC pipelines can be challenging.  I’ve put together a simple pattern for deploying stacks in AWS using CloudFormation templates using GitLab CI.  </p><p>This deployment framework enables you to target different environments based upon refs (branches or tags) for instance deploy to a dev environment for a push or merge into develop and deploy to prod on a push or merge into main, otherwise just lint/validate (e.g., for a push to a non-protected feature branch).  Templates are uploaded to a designated S3 bucket and staged for use in the pipeline and can be retained as an additional audit trail (in addition to the GitLab project history).  </p><p>Furthermore, you can review changes (by inspecting change set contents) before deploying, saving you from fat finger deployments 😊.  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"how-it-works\">How it works<a class=\"hash-link\" href=\"#how-it-works\" title=\"Direct link to heading\">​</a></h2><p>The logic is described here:  </p><div class=\"tabs-container tabList__CuJ\"><ul role=\"tablist\" aria-orientation=\"horizontal\" class=\"tabs\"><li role=\"tab\" tabindex=\"0\" aria-selected=\"true\" class=\"tabs__item tabItem_LNqP tabs__item--active\">Flow</li><li role=\"tab\" tabindex=\"-1\" aria-selected=\"false\" class=\"tabs__item tabItem_LNqP\">PlantUML</li></ul><div class=\"margin-top--md\"><div role=\"tabpanel\" class=\"tabItem_Ymn6\"><p><a target=\"_blank\" href=\"/assets/files/gitlabci-cloudformation-flow-27282ec6781a04b2c32d1ac1d5fa01a5.png\"><img loading=\"lazy\" alt=\"GitLab CI\" src=\"/assets/images/gitlabci-cloudformation-flow-27282ec6781a04b2c32d1ac1d5fa01a5.png\" width=\"449\" height=\"774\" class=\"img_ev3q\"></a> </p></div><div role=\"tabpanel\" class=\"tabItem_Ymn6\" hidden=\"\"><div class=\"language-plantuml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-plantuml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@startuml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">partition prepare {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  (*) --&gt; === S1 ===</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  === S1 === --&gt; \"Validate Template\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --&gt; === S2 ===</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  === S1 === --&gt; \"Check Stack State\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --&gt; === S2 ===</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">partition publish {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --&gt; \"Publish Template to S3\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">partition plan {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --&gt; \"Stack Exists?\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --&gt; === S3 ===</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  === S3 === --&gt; [Yes] \"Create Change Set\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  === S3 === --&gt; [No] === S4 ===</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  \"Create Change Set\" --&gt; === S4 ===</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">partition deploy {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --&gt; \"MANUAL: Review Changes\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --&gt; \"Deploy Change Set\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">--&gt;(*)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@enduml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div></div></div></div><p>The pipleline looks like this in GitLab:  </p><p><a target=\"_blank\" href=\"/assets/files/gitlab-ci-0f1e6af130941985838f49a568c723d4.png\"><img loading=\"lazy\" alt=\"GitLab CI\" src=\"/assets/images/gitlab-ci-0f1e6af130941985838f49a568c723d4.png\" width=\"1264\" height=\"859\" class=\"img_ev3q\"></a>  </p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"prerequisites\">Prerequisites<a class=\"hash-link\" href=\"#prerequisites\" title=\"Direct link to heading\">​</a></h2><p>You will need to set up GitLab CI variables for <code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code> and optionally <code>AWS_DEFAULT_REGION</code>.  You can do this via <strong>Settings -&gt; CI/CD -&gt; Variables</strong> in your GitLab project.   As <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> are secrets, they should be configured as <code>protected</code> (as they are only required for protected branches) and <code>masked</code> so they are not printed in job logs.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"gitlab-ciyml-code\"><code>.gitlab-ci.yml</code> code<a class=\"hash-link\" href=\"#gitlab-ciyml-code\" title=\"Direct link to heading\">​</a></h2><p>The GitLab CI code is shown here:  </p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-d561e9f002048b4e4be4043cf185d1bd\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"reviewing-change-sets-plans-and-applying\">Reviewing change sets (plans) and applying<a class=\"hash-link\" href=\"#reviewing-change-sets-plans-and-applying\" title=\"Direct link to heading\">​</a></h2><p>Once a pipeline is triggered for an existing stack it will run hands off until a change set (plan) is created.  You can inspect the plan by clicking on the Plan GitLab CI job where you would see output like this:  </p><p><a target=\"_blank\" href=\"/assets/files/gitlab-ci-cloudformation-plan-fab980e936956a28a98a13ec4f20d48d.png\"><img loading=\"lazy\" alt=\"Change Set\" src=\"/assets/images/gitlab-ci-cloudformation-plan-fab980e936956a28a98a13ec4f20d48d.png\" width=\"1264\" height=\"879\" class=\"img_ev3q\"></a>  </p><p>If you are OK with the changes proposed, you can simply hit the play button on the last stage of the pipeline (Deploy).  Voilà, stack deployed, enjoy!</p>",
            "url": "https://fullstackchronicles.io/aws-deployments-with-cloudformation-and-gitlab-ci",
            "title": "Simplified AWS Deployments with CloudFormation and GitLab CI",
            "summary": "A simple pattern for deploying stacks in AWS using CloudFormation templates using GitLab CI which allows you to review changes before deploying.",
            "date_modified": "2021-11-11T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "gitlab",
                "gitlabci",
                "aws",
                "awscloudformation",
                "infrastructureascode",
                "iac",
                "cloudautomation"
            ]
        },
        {
            "id": "from-wordpress-to-jamstack",
            "content_html": "<p>I started this blog a few years back to chronicle my journeys through building cloud data platforms, along the way I gathered some friends to share their experiences as well.  The easiest platform to start this blog on was Wordpress.  This worked, but wasnt really aligned with the way myself and my collegues worked,and didnt really align with the types of things we were writing about in blog articles or embracing as general principles... e.g. 'everything-as-code', 'gitops', etc.  </p><p>Enter Static Site Generators and Jamstack architecture.  Not only does a Jamstack, SSG architecture for a blog site (or docs site or any other site), allow you to manage every aspect of your web property as code, but as a static site has several other benefits inlcuding increased performance, easier distribution (using CDNs), better security (no origin server required), all this as well as being SEO friendly (and optimised in many cases).  </p><p>But moving the site from Wordpress to a SSG must be an onerous task.. wrong.  </p><p>I moved this blog over a weekend which was quite simple in the end, here are the steps:  </p><ol><li><p>Export your Wordpress site (Tools-&gt;Export), make sure to select <em>All Content</em>.  </p></li><li><p>Use <a href=\"https://github.com/lonekorean/wordpress-export-to-markdown\" target=\"_blank\" rel=\"noopener noreferrer\">wordpress-export-to-markdown</a> to convert your posts to a basic Markdown format with frontmatter, does a pretty good job</p></li><li><p>Choose and deploy a Static Site Generator (I chose <a href=\"https://docusaurus.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Docusaurus</a>, but there are several other alternatives available such as VuePress, Jekyll, etc)  </p></li><li><p>Drop your Markdown docs into your SSG content (blogs) directory (converted in step 2)  </p></li><li><p>You will probably need to do some fine tuning as some things may not export cleanly, but 99% of the content will be fine  </p></li><li><p>Deploy your new blog site, I am using GitHub Pages, but you could use anything similar - Netlify, Vercel, Digital Ocean, Azure Static Web Apps, etc or implement your own custom CI routine to build your project and push it to an object storage bucket configured to serve a static web site (such as Google Cloud Storage and AWS S3)  </p></li></ol><p>Thats it!</p>",
            "url": "https://fullstackchronicles.io/from-wordpress-to-jamstack",
            "title": "From Wordpress to Jamstack",
            "summary": "I started this blog a few years back to chronicle my journeys through building cloud data platforms, along the way I gathered some friends to share their experiences as well.  The easiest platform to start this blog on was Wordpress.  This worked, but wasnt really aligned with the way myself and my collegues worked,and didnt really align with the types of things we were writing about in blog articles or embracing as general principles... e.g. 'everything-as-code', 'gitops', etc.",
            "date_modified": "2021-09-26T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "wordpress",
                "jamstack",
                "web development",
                "github pages",
                "docusaurus"
            ]
        },
        {
            "id": "using-jsonnet-to-configure-multiple-environments",
            "content_html": "<p>Everytime I start a new project I try and optimise how the application can work across multiple envronments. For those who don't have the luxury of developing everything in docker containers or isolated spaces, you will know my pain. How do I write code that can run on my local <code>dev</code> environment, migrate to the shared <code>test</code> and <code>ci</code> environment and ultimately still work in <code>production</code>.</p><p>In the past I tried exotic options like dynamically generating <code>YAML</code> or <code>JSON</code> using Jinja. I then graduated to <code>HOCON</code> which made my life so much easier. This was until I stumbled across <a href=\"https://jsonnet.org/\" target=\"_blank\" rel=\"noopener noreferrer\">Jsonnet</a>. For those who have not seen this in action, think JSON meets Jinja meets HOCON (a Frankenstein creation that I have actually built in the past)</p><p>To get a feel for how it looks, below is a contrived example where I require 3 environments (dev, test and production) that have different paths, databases and vault configuration.</p><p>Essentially, when this config is run through the Jsonnet templating engine, it will expect a variable '<code>ENV</code>' to ultimately refine the <code>environment</code> entry to the one we specifically want to use.</p><p>A helpful thing I like to do with my programs is give users a bit of information as to what environments can be used. For me, running a cli that requires args should be as informative as possible - so listing out all the environments is mandatory. I achieve this with a little trickery and a lot of help from the <a href=\"https://click.palletsprojects.com/\" target=\"_blank\" rel=\"noopener noreferrer\">click</a> package!</p><div class=\"language-jsonnet codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-jsonnet codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">local exe = \"application.exe\";</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">local Environment(prefix) = {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  root: \"/usr/\" + prefix + \"/app\",</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  path: self.root + \"/bin/\" + exe,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  database: std.asciiUpper(prefix) + \"_DB\",</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  tmp_dir: \"/tmp/\" + prefix</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">};</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">local Vault = {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  local uri = \"http://127.0.0.1:8200/v1/secret/app\",</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  _: {},</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  dev: {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      secrets_uri: uri,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      approle: \"local\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  },</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  tst: {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      secrets_uri: uri,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      approle: \"local\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  },</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  prd: {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      secrets_uri: \"https://vsrvr:8200/v1/secret/app\",</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      approle: \"sa_user\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">};</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">{</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  environments: {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    _: {},</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    dev: Environment(\"dev\") + Vault[std.extVar(\"ENV\")],</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    tst: Environment(\"tst\") + Vault[std.extVar(\"ENV\")],</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    prd: Environment(\"prd\") + Vault[std.extVar(\"ENV\")]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  },</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  environment: $[\"environments\"][std.extVar(\"ENV\")],</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>The trick I perform is to have a placeholder entry '<code>_</code>' that I use to initially render the template. I then use the generated JSON file and get all the environment keys so I can feed that directly into click.</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> typing </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> Any</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Dict</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> click</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> json</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> _jsonnet</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> pprint </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> pprint</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ENV_JSONNET </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'environment.jsonnet'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ENV_PFX_PLACEHOLDER </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'_'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">parse_environment</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">prefix</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> Dict</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> Any</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    _json_str </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> _jsonnet</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">evaluate_file</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">ENV_JSONNET</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> ext_vars</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">'ENV'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> prefix</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> json</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">loads</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_json_str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">_config </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> parse_environment</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">prefix</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">ENV_PFX_PLACEHOLDER</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">_env_prefixes </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">k </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> k </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> _config</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'environments'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">keys</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> k </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> ENV_PFX_PLACEHOLDER</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">@click</span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">.</span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">command</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">name</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"EnvMgr\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">@click</span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">.</span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">option</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">\"-e\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">\"--environment\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    required</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">True</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token builtin\">type</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">click</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">Choice</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">_env_prefixes</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> case_sensitive</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token builtin\">help</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"Which environment this is executing on\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">cli</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">environment</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    config </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> parse_environment</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">environment</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    pprint</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">config</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'environment'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> __name__ </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"__main__\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    cli</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>This now allows me to execute the application with both list checking (has the user selected an allowed environment?) and the autogenerated help that click provides.</p><p>Below shows running the cli with no arguments:</p><div class=\"language-shell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-shell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> python cli.py</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Usage: cli.py </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">OPTIONS</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Try </span><span class=\"token string\" style=\"color:#e3116c\">'cli.py --help'</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> help.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Error: Missing option </span><span class=\"token string\" style=\"color:#e3116c\">'-e'</span><span class=\"token plain\"> / </span><span class=\"token string\" style=\"color:#e3116c\">'--environment'</span><span class=\"token builtin class-name\">.</span><span class=\"token plain\"> Choose from:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        dev,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        prd,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        tst</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Executing the application with a valid environment:</p><div class=\"language-shell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-shell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> python cli.py -e dev</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">'approle'</span><span class=\"token builtin class-name\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'local'</span><span class=\"token plain\">,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'database'</span><span class=\"token builtin class-name\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'DEV_DB'</span><span class=\"token plain\">,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'path'</span><span class=\"token builtin class-name\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'/usr/dev/app/bin/application.exe'</span><span class=\"token plain\">,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'root'</span><span class=\"token builtin class-name\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'/usr/dev/app'</span><span class=\"token plain\">,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'secrets_uri'</span><span class=\"token builtin class-name\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'http://127.0.0.1:8200/v1/secret/app'</span><span class=\"token plain\">,</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'tmp_dir'</span><span class=\"token builtin class-name\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'/tmp/dev'</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Executing the application with an invalid environment:</p><div class=\"language-shell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-shell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> python cli.py -e prd3</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Usage: cli.py </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">OPTIONS</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Try </span><span class=\"token string\" style=\"color:#e3116c\">'cli.py --help'</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> help.</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Error: Invalid value </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'-e'</span><span class=\"token plain\"> / </span><span class=\"token string\" style=\"color:#e3116c\">'--environment'</span><span class=\"token builtin class-name\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'prd3'</span><span class=\"token plain\"> is not one of </span><span class=\"token string\" style=\"color:#e3116c\">'dev'</span><span class=\"token plain\">, </span><span class=\"token string\" style=\"color:#e3116c\">'prd'</span><span class=\"token plain\">, </span><span class=\"token string\" style=\"color:#e3116c\">'tst'</span><span class=\"token builtin class-name\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>This is only the tip of what Jsonnet can provide, I am continually learning more about the templating engine and the tool.</p>",
            "url": "https://fullstackchronicles.io/using-jsonnet-to-configure-multiple-environments",
            "title": "Using Jsonnet to Configure Multiple Environments",
            "summary": "Everytime I start a new project I try and optimise how the application can work across multiple envronments. For those who don't have the luxury of developing everything in docker containers or isolated spaces, you will know my pain. How do I write code that can run on my local dev environment, migrate to the shared test and ci environment and ultimately still work in production.",
            "date_modified": "2021-06-24T00:00:00.000Z",
            "author": {
                "name": "Mark Stella",
                "url": "https://github.com/mpstella"
            },
            "tags": [
                "ci-cd",
                "configuration",
                "envconfig",
                "environments",
                "hocon",
                "json",
                "jsonnet"
            ]
        },
        {
            "id": "use-bigquery-to-trigger-cloud-run",
            "content_html": "<p>So you're using BigQuery (BQ). It's all set up and humming perfectly. Maybe now, you want to run an ELT job whenever a new table partition is created, or maybe you want to retrain your ML model whenever new rows are inserted into the BQ table.</p><p>In my previous article on <a href=\"https://cloudywithachanceofbigdata.com/eventarc-the-state-of-eventing-in-google-cloud/\" target=\"_blank\" rel=\"noopener noreferrer\">EventArc</a>, we went through how Logging can help us create eventing-type functionality in your application. Let's take it a step further and walk through how we can couple BigQuery and Cloud Run.</p><p>In this article you will learn how to</p><ul><li>Tie together BigQuery and Cloud Run</li><li>Use BigQuery's audit log to trigger Cloud Run</li><li>With those triggers, run your required code</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"lets-go\">Let's go!<a class=\"hash-link\" href=\"#lets-go\" title=\"Direct link to heading\">​</a></h2><p>Let's create a temporary dataset within BigQuery named <code>tmp_bq_to_cr</code>.</p><p>In that same dataset, let's create a table in which we will insert some rows to test our BQ audit log. Let's grab some rows from a BQ public dataset to create this table:</p><div class=\"language-sql codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sql codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">CREATE</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">OR</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">REPLACE</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">TABLE</span><span class=\"token plain\"> tmp_bq_to_cr</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">cloud_run_trigger </span><span class=\"token keyword\" style=\"color:#00009f\">AS</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">SELECT</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">date</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> country_name</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> new_persons_vaccinated</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> population</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> </span><span class=\"token identifier punctuation\" style=\"color:#393A34\">`</span><span class=\"token identifier\">bigquery-public-data.covid19_open_data.covid19_open_data</span><span class=\"token identifier punctuation\" style=\"color:#393A34\">`</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">where</span><span class=\"token plain\"> country_name</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">'Australia'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">AND</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">date</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'2021-05-31'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">LIMIT</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">100</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Following this, let's run an insert query that will help us build our mock database trigger:</p><div class=\"language-sql codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sql codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">INSERT</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">INTO</span><span class=\"token plain\"> tmp_bq_to_cr</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">cloud_run_trigger</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">VALUES</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'2021-06-18'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'Australia'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1000</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Now, in another browser tab let's navigate to <a href=\"https://console.cloud.google.com/logs/query;query=bigquery.v2?_ga=2.187390252.-505923201.1592376029\" target=\"_blank\" rel=\"noopener noreferrer\">BQ Audit Events</a> and look for our <code>INSERT INTO</code> event:</p><p><a target=\"_blank\" href=\"/assets/files/bq-insert-event-69f31456522fd0a5d613b44c3a7171a9.png\"><img loading=\"lazy\" alt=\"BQ-insert-event\" src=\"/assets/images/bq-insert-event-69f31456522fd0a5d613b44c3a7171a9.png\" width=\"767\" height=\"641\" class=\"img_ev3q\"></a></p><p>There will be several audit logs for any given BQ action. Only after a query is parsed does BQ know which table we want to interact with, so the initial log will, for e.g., not have the table name.</p><p>We don't want any old audit log, so we need to ensure we look for a unique set of attributes that clearly identify our action, such as in the diagram above.</p><p>In the case of inserting rows, the attributes are a combination of</p><ul><li>The method is <code>google.cloud.bigquery.v2.JobService.InsertJob</code></li><li>The name of the table being inserted to is the <code>protoPayload.resourceName</code></li><li>The dataset id is available as <code>resource.labels.dataset_id</code></li><li>The number of inserted rows is <code>protoPayload.metadata.tableDataChanged.insertedRowsCount</code></li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"time-for-some-code\">Time for some code<a class=\"hash-link\" href=\"#time-for-some-code\" title=\"Direct link to heading\">​</a></h2><p>Now that we've identified the payload that we're looking for, we can write the action for Cloud Run. We've picked Python and Flask to help us in this instance. (<a href=\"https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/blogs/cloud_run/main.py\" target=\"_blank\" rel=\"noopener noreferrer\">full code is on GitHub</a>).</p><p>First, let's filter out the noise and find the event we want to process</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">@app</span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">.</span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">route</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'/'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> methods</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'POST'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">index</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Gets the Payload data from the Audit Log</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    content </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> request</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">json</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        ds </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> content</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'resource'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'labels'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'dataset_id'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        proj </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> content</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'resource'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'labels'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'project_id'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        tbl </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> content</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'protoPayload'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'resourceName'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        rows </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token builtin\">int</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">content</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'protoPayload'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'metadata'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                   </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'tableDataChange'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'insertedRowsCount'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> ds </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'cloud_run_tmp'</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">and</span><span class=\"token plain\"> \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">           tbl</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">endswith</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'tables/cloud_run_trigger'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">and</span><span class=\"token plain\"> rows </span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            query </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> create_agg</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"table created\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">200</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># if these fields are not in the JSON, ignore</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">pass</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"ok\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">200</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Now that we've found the event we want, let's execute the action we need. In this example, we'll aggregate and write out to a new table <code>created_by_trigger</code>:</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">create_agg</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    client </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> bigquery</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">Client</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    query </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">\"\"\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">    CREATE OR REPLACE TABLE tmp_bq_to_cr.created_by_trigger AS</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">    SELECT</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">      count_name, SUM(new_persons_vaccinated) AS n</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">    FROM tmp_bq_to_cr.cloud_run_trigger</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token triple-quoted-string string\" style=\"color:#e3116c\">    \"\"\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">query</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">query</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> query</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>The Dockerfile for the container is simply a basic Python container into which we install Flask and the BigQuery client library:</p><div class=\"language-docker codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-docker codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">FROM python:3.9-slim</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">RUN pip install Flask==1.1.2 gunicorn==20.0.4 google-cloud-bigquery</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">ENV APP_HOME /app</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">WORKDIR $APP_HOME</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">COPY *.py ./</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">CMD exec gunicorn --bind :$PORT main:app</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"now-we-cloud-run\">Now we Cloud Run<a class=\"hash-link\" href=\"#now-we-cloud-run\" title=\"Direct link to heading\">​</a></h2><p>Build the container and deploy it using a couple of gcloud commands:</p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token assign-left variable\" style=\"color:#36acaa\">SERVICE</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">bq-cloud-run</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token assign-left variable\" style=\"color:#36acaa\">PROJECT</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token variable\" style=\"color:#36acaa\">$(</span><span class=\"token variable\" style=\"color:#36acaa\">gcloud config get-value project</span><span class=\"token variable\" style=\"color:#36acaa\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token assign-left variable\" style=\"color:#36acaa\">CONTAINER</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"gcr.io/</span><span class=\"token string variable\" style=\"color:#36acaa\">${PROJECT}</span><span class=\"token string\" style=\"color:#e3116c\">/</span><span class=\"token string variable\" style=\"color:#36acaa\">${SERVICE}</span><span class=\"token string\" style=\"color:#e3116c\">\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud builds submit --tag </span><span class=\"token variable\" style=\"color:#36acaa\">${CONTAINER}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud run deploy </span><span class=\"token variable\" style=\"color:#36acaa\">${SERVICE}</span><span class=\"token plain\"> --image </span><span class=\"token variable\" style=\"color:#36acaa\">$CONTAINER</span><span class=\"token plain\"> --platform managed</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"i-always-forget-about-the-permissions\">I always forget about the permissions<a class=\"hash-link\" href=\"#i-always-forget-about-the-permissions\" title=\"Direct link to heading\">​</a></h2><p>In order for the trigger to work, the Cloud Run service account will need the following permissions:</p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud projects add-iam-policy-binding </span><span class=\"token variable\" style=\"color:#36acaa\">$PROJECT</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    --member</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"serviceAccount:service-</span><span class=\"token string variable\" style=\"color:#36acaa\">${PROJECT_NO}</span><span class=\"token string\" style=\"color:#e3116c\">@gcp-sa-pubsub.iam.gserviceaccount.com\"</span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    --role</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">'roles/iam.serviceAccountTokenCreator'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud projects add-iam-policy-binding </span><span class=\"token variable\" style=\"color:#36acaa\">$PROJECT</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    --member</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">serviceAccount:</span><span class=\"token variable\" style=\"color:#36acaa\">${SVC_ACCOUNT}</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    --role</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">'roles/eventarc.admin'</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"finally-the-event-trigger\">Finally, the event trigger<a class=\"hash-link\" href=\"#finally-the-event-trigger\" title=\"Direct link to heading\">​</a></h3><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud eventarc triggers create </span><span class=\"token variable\" style=\"color:#36acaa\">${SERVICE}</span><span class=\"token plain\">-trigger </span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --location </span><span class=\"token variable\" style=\"color:#36acaa\">${REGION}</span><span class=\"token plain\"> --service-account </span><span class=\"token variable\" style=\"color:#36acaa\">${SVC_ACCOUNT}</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --destination-run-service </span><span class=\"token variable\" style=\"color:#36acaa\">${SERVICE}</span><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --event-filters </span><span class=\"token assign-left variable\" style=\"color:#36acaa\">type</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">google.cloud.audit.log.v1.written </span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --event-filters </span><span class=\"token assign-left variable\" style=\"color:#36acaa\">methodName</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">google.cloud.bigquery.v2.JobService.InsertJob </span><span class=\"token punctuation\" style=\"color:#393A34\">\\</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --event-filters </span><span class=\"token assign-left variable\" style=\"color:#36acaa\">serviceName</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">bigquery.googleapis.com</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Important to note here is that we're triggering on <em>any</em> Insert log created by BQ That's why in this action we had to filter these events based on the payload.</p><h1>Take it for a spin</h1><p>Now, try out the BigQuery -&gt; Cloud Run trigger and action. Go to the BigQuery console and insert a row or two:</p><div class=\"language-sql codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-sql codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">INSERT</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">INTO</span><span class=\"token plain\"> tmp_bq_to_cr</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">cloud_run_trigger</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">VALUES</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'2021-06-18'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'Australia'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">5</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">25000</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Watch as a new table called <code>created_by_trigger</code> gets created! You have successfully triggered a Cloud Run action on a database event in BigQuery.</p><p>Enjoy!</p>",
            "url": "https://fullstackchronicles.io/use-bigquery-to-trigger-cloud-run",
            "title": "Use BigQuery to trigger Cloud Run",
            "summary": "So you're using BigQuery (BQ). It's all set up and humming perfectly. Maybe now, you want to run an ELT job whenever a new table partition is created, or maybe you want to retrain your ML model whenever new rows are inserted into the BQ table.",
            "date_modified": "2021-06-19T00:00:00.000Z",
            "author": {
                "name": "Tom Klimovski",
                "url": "https://github.com/tomklimovskigamma"
            },
            "tags": [
                "big-query",
                "bigquery",
                "gcp",
                "google-cloud-platform",
                "googlecloudplatform"
            ]
        },
        {
            "id": "azure-static-web-app-review",
            "content_html": "<p><img loading=\"lazy\" alt=\"Azure Static WebApp\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEYAAABGCAYAAABxLuKEAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAMWSURBVHhe7Zu/i9RQEIBfzhUOUbmDa9zWE8HGRhAFxULQYkUsrQTF0kbRwj9BsbexsLKyEAUtrlE4r7bxB7etp8KBhx7Lya0bM2bCzr19k7wk773k2PkgyySXhLwvM5OES6I4QQkTRMkUH3rwMp0T1Pf7V1Q8HKookSIZo/Ht3iU1g7FAgAoSMQwihqFQTP92T63d7anugVlcMsnzmxf+r/P2Vg+XmIF1YNoN5DZf0yC6D19hlGKzDog7NbcX51L0ddoGmzF1zuyji8cxStGlAG3PHOkxDKyYOql+580HjHhOPF7CqJ3kZowuxySryjqrW0kp/U5+Wozc+TJIj2EQMQwihiE6s/JVeowByRgGEcMgYhiMPebaYhej6eBpfw2jMZIxDCKGoZVibiykU5O0OmOalCOlxNA6MTRLnqxj0ABBxLjoGS72UQbvYuhgqg7MxT7K4lWMPoii0ji7H4MEuq6+XQg53sSUlQIc4f91FVyOFzFVpNgQUo5zMVWl0O1ebGBgIJQcp2JcZcr6EAOGEHKciXElxRbfcpyIqSuFXo2KsoXiU05tMS4yhV6N8vqLCV9yaouhA4GzTc9+CC7P7cyylY1tjOpRWwwcFMjJDm6+kx6sLcc644EM/mJgiV6CIOXjcPLNiio46TGZHIqtHPqKyLOfGFgAUuAkZCxvKmdSACdiMuDgKGUypwy6FICWkwucioGD0+Xk9RwqDt6AsMGUKWUbtg1OxQB6WcEgrs7jjMYCGeA7TagJkxTXmZLhXEwGlTOI65dVSCmANzGAXlb0CkSzpQjYLqQUwKsYvefQqwbNoKKbQrrd6ua2dymAVzEADALKqm6DzPbh8pKch3cxu5VGxNDnmSrPViFoRAzIgMn23qUJGi0lm3uXppAew2B8P2bx4D6MpoP+rwFGY+TlRAYpJQOjP1tqBn6EnSyfO5x+Xhx1Our00pd06ZTz/vzR9PNiFe2J1cnrSs0mj6+jEf55CoEUiZLO8uOzUp9eK/lSn0GaL4OIYRAxDCKGQcQwiBgGEcMgYhhEDIOIYRAxRpT6Bzu/BUCZFYmdAAAAAElFTkSuQmCC\" width=\"70\" height=\"70\" class=\"img_ev3q\"></p><p>The Azure Static Web App feature is relatively new in the Azure estate which has recently become generally available, I thought I would take it for a test drive and discuss my findings.</p><p>I am a proponent of the JAMStack architecture for front end applications and a user of CD enabled CDN services like Netlify, so this Azure feature was naturally appealing to me.</p><p>Azure SWAs allow you to serve static assets (like JavaScript) without a origin server, meaning you don’t need a web server, are able to streamline content distribution and web app performance, and reduce the attack surface area of your application.</p><p>The major advantage to using is simplicity, no scaffolding or infra requirements and it is seamlessly integrated into your CI/CD processes (natively if you are using GitHub).</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"deploying-static-web-apps-in-azure\">Deploying Static Web Apps in Azure<a class=\"hash-link\" href=\"#deploying-static-web-apps-in-azure\" title=\"Direct link to heading\">​</a></h2><p>Pretty simple to setup, aside from a name and a resource group, you just need to supply:</p><ul><li>a <strong>location</strong> (Azure region to be used for serverless back end APIs via Azure Function Apps) note that this is not a location where the static web is necessarily running</li><li>a GitHub or GitLab <strong>repo URL</strong></li><li>the <strong>branch</strong> you wish to use to trigger production deployments (e.g. <code>main</code>)</li><li>a <strong>path</strong> to your code within your app (e.g. where your <code>package.json</code> file is located)</li><li>an <strong>output folder</strong> (e.g. <code>dist</code>) this should not exist in your repo</li><li>a project or personal access <strong>token</strong> for your GitHub account (alternatively you can perform an interactive OAuth2.0 consent if using the portal)</li></ul><p>An example is shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-eef5a25ed01327a180711fd64370c457\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"github-actions\">GitHub Actions<a class=\"hash-link\" href=\"#github-actions\" title=\"Direct link to heading\">​</a></h2><p>Using the consent provided (either using the OAuth flow or by providing a token), Azure Static Web Apps will automagically create the GitHub Actions workflow to deploy your application on a push or merge event to your repo. This includes providing scoped API credentials to Azure to allow access to the Static Web App resource using secrets in GitHub (which are created automagically as well). An example workflow is shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-8e7ad2bdd9ba351368c5aedad289e972\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"preview-or-staging-releases\">Preview or Staging Releases<a class=\"hash-link\" href=\"#preview-or-staging-releases\" title=\"Direct link to heading\">​</a></h2><p>Similar to the functionality in analogous services like Netlify, you can configure preview releases of your application to be deployed from specified branches on pull request events.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"routes-and-authorization\">Routes and Authorization<a class=\"hash-link\" href=\"#routes-and-authorization\" title=\"Direct link to heading\">​</a></h2><p>Routes (for SPAs) need to be provided to Azure by using a file named <code>staticwebapp.config.json</code> located in the application root of your repo (same level as you <code>package.json</code> file). You can also specify response codes and whether the rout requires authentication as shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-7dd3bcf05474da551b3d311ae0729e18\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"pros\">Pros<a class=\"hash-link\" href=\"#pros\" title=\"Direct link to heading\">​</a></h2><ul><li>Globally distributed CDN</li><li>Increased security posture, reduced attack surface area</li><li>Simplified architecture and deployment</li><li>No App Service Plan required – cost reduction</li><li>Enables Continuous Deployment – incl preview/staging environments</li><li>TLS and DNS can be easily configured for your app</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"cons\">Cons<a class=\"hash-link\" href=\"#cons\" title=\"Direct link to heading\">​</a></h2><ul><li>Serverless API locations are limited</li><li>Integration with other VCS/CI/CD systems like GitLab would need to be custom built (GitHub and Azure DevOps is integrated)</li></ul><p>Overall, this is a good feature for deploying SPAs or PWAs in Azure.</p>",
            "url": "https://fullstackchronicles.io/azure-static-web-app-review",
            "title": "Azure Static Web App Review",
            "summary": "Azure Static WebApp",
            "date_modified": "2021-06-18T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "azure",
                "jamstack",
                "microsoft-azure",
                "netlify",
                "progressive-web-application",
                "pwa",
                "react",
                "single-page-application",
                "spa",
                "vercel",
                "vue-js"
            ]
        },
        {
            "id": "introducing-the-metadata-hub-mdh",
            "content_html": "<p>Metadata Hub (MDH) is intended to be the source of truth for metadata around the Company’s platform. It has the ability to load metadata configuration from yaml, and serve that information up via API. It will also be the store of information for pipeline information while ingesting files into the platform.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"key-philosophies\">Key philosophies:<a class=\"hash-link\" href=\"#key-philosophies\" title=\"Direct link to heading\">​</a></h2><blockquote><p><strong>Config-Driven</strong>. Anyone who has been authorized to do so, should be able to add another ‘table-info.yaml’ in to MDH without the need to update any code in the system</p></blockquote><p>Here’s how table information makes its way into MDH:  </p><figure><a href=\"/assets/images/mdhoverview-f1928d2566e120de80d74538c4e8a0bc.png\"><img src=\"/assets/images/mdhoverview-f1928d2566e120de80d74538c4e8a0bc.png\" alt=\"Metadata Hub\"></a><figcaption class=\"figure-caption\">Metadata Hub</figcaption></figure><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"paths\">Paths<a class=\"hash-link\" href=\"#paths\" title=\"Direct link to heading\">​</a></h3><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>/tables</td><td>get:</td><td>summary: All tables in MDH</td><td>description: get the title of all tables that exist in MDH</td></tr><tr><td></td><td>post:</td><td>summary: Creates a new table in MDH</td><td>description: Creates a new table in MDH</td></tr><tr><td>/tables/{id}</td><td>get</td><td>summary: Obtain information about specific table</td><td></td></tr><tr><td>/tables/{id}/columns</td><td>get</td><td>summary: All columns for a particular table</td><td>description: Obtain information on columns for a particular table</td></tr><tr><td>/run</td><td>get</td><td>summary: All information about a particular end-to-end batch run of file ingestion</td><td></td></tr><tr><td></td><td>post</td><td>summary: Update metadata on a batch load</td><td>description: Update metadata on a batch load</td></tr><tr><td>/calendar</td><td>get</td><td>summary: Use this to save on calculation of business days.</td><td>description: This base response gives you today's date in a string</td></tr><tr><td>/calendar/previousBusinessDay</td><td>get</td><td>summary: Will return a string of the previous business day</td><td>description: Will return a string of the previous business day, based on the date on when it's called</td></tr><tr><td>/calendar/nextBusinessDay</td><td>get</td><td>summary: Will return a string of the next business day</td><td>description: Will return a string of the next business day, based on the date on when it's called</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><h1>Yaml to Datastore - Entity/Kind design</h1><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"datastore-primer\">Datastore Primer<a class=\"hash-link\" href=\"#datastore-primer\" title=\"Direct link to heading\">​</a></h3><p>Before we jump right into Entity Groups in Datastore, it is important to first go over the basics and establish a common vocabulary. Datastore holds entities, which are objects, that can contain various key/value pairs, called properties. Each entity must contain a unique identifier, known as a key. When creating an entity, a user can choose to specify a custom key or let Datastore create a key. If a user decides to specify a custom key, it will contain two fields: a kind, which represents a category such as ‘Toy’ or ‘Marital Status’, and a name, which is the identifying value. If a user decides to only specify a kind when creating a key, and does not specify a unique identifier, Datastore automatically generates an ID behind the scenes. Below is an example of a Python3 script which illustrates this identifier concept.</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> google</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">cloud </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> datastore</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">client </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">Client</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#Custom key- specify my kind=item and a unique_id of broker</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">custom_key_entry </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">Entity</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"table\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token string\" style=\"color:#e3116c\">\"broker\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">put</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">custom_key_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\">#Only specify kind=item, let datastore generate unique_id</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">datastore_gen_key_entry </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">Entity</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"table\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">put</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">datastore_gen_key_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>In your GCP Console under Datastore, you will then see your two entities of kind “table”. One will contain your custom key and one will contain the automatically generated key.</p><p>Ancestors and Entity Groups</p><p>For highly related or hierarchical data, Datastore allows entities to be stored in a parent/child relationship. This is known as an entity group or ancestor/descendent relationship.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"entity-group\">Entity Group<a class=\"hash-link\" href=\"#entity-group\" title=\"Direct link to heading\">​</a></h3><p><a target=\"_blank\" href=\"/assets/files/erd-cce67b2304769e80a2dffce456462194.png\"><img loading=\"lazy\" alt=\"erd\" src=\"/assets/images/erd-cce67b2304769e80a2dffce456462194.png\" width=\"2910\" height=\"1526\" class=\"img_ev3q\"></a></p><p><em>This is an example of an entity group with kinds of types: table, column, and classification. The ‘Grandparent’ in this relationship is the ‘table’. In order to configure this, one must first create the table entity. Then, a user can create a column, and specify that the parent is a table key. In order to create the grandchild, a user then creates a classification and sets its parent to be a column key. To further add customizable attributes, a user can specify additional key-value pairs such as pii and data_type. These key-value pairs are stored as properties. We model this diagram in Datastore in our working example below.</em></p><p>One can create entity groups by setting the ‘parent’ parameter while creating an entity key for a child. This command adds the parent key to be part of the child entity key. The child’s key is represented as a tuple (‘parent_key’, ‘child_key’), such that the parents’ key is the prefix of the key, which is followed by its own unique identifier. For example, follow the diagram above:</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">table_key </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore_client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"table\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token string\" style=\"color:#e3116c\">\"broker\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">column_key </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore_client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"column\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token string\" style=\"color:#e3116c\">\"broker_legal_name\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> parent</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">table_key</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Printing the variable <code>table_key</code> will display: <code>(\"table\", \"broker\",\"column\", \"broker_legal_name\")</code></p><p>Datastore also supports chaining of parents, which can lead to very large keys for descendants with a long lineage of ancestors. Additionally, parents can have multiple children (representing a one-to-many relationship). However, there is no native support for entities to have multiple parents (representing a many-to-many relationship). Once you have configured this ancestral hierarchy, it is easy to retrieve all descendants for a given parent. You can do this by querying on the parent key by using the ‘ancestor’ parameter. For example, given the entity table_key created above, I can query for all of the tables</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">columns</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> my_query </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">query</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">kind</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"table\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> ancestor </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> column_key</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h1>A Full Working Example for MDH</h1><p>As per our Key Philosophies - <strong><em>Config-Driven</em></strong> - anyone should be able to add a new <code>table</code> to be processed and landed in a target-table somewhere within MDH with our yaml syntax. Below is a full working python3 example of the table/column/classification hierarchical model described above.</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> google</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">cloud </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> datastore</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">datastore_client </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">Client</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Entities with kinds- table, column, classification</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">my_entities </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"kind\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"table\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"table_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"table_type\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"snapshot\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">\"notes\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"describes mortgage brokers\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"kind\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"column\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"column_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker_legal_name\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"table_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">\"data_type\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"string\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"size\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">20</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"nullable\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"kind\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"column\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"column_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker_short_code\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"table_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">\"data_type\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"string\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"size\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">3</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"nullable\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"kind\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"classification\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"classification_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token string\" style=\"color:#e3116c\">\"classif_id_REQ_01\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">\"restriction_level\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"public\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"pii\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"if\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"greater than 90 days\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">\"column_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker_legal_name\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"table_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"kind\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"classification\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"classification_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token string\" style=\"color:#e3116c\">\"classif_id_REQ_03\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">\"restriction_level\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"restricted\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"pii\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"if\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"less than 90 days\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">\"column_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker_legal_name\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"table_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token string\" style=\"color:#e3116c\">\"kind\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"classification\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"classification_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token string\" style=\"color:#e3116c\">\"classif_id_REQ_214\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">\"restriction_level\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"public\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"pii\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"column_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker_short_code\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">\"table_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker\"</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># traverse my_entities, set parents and add those to datastore</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> entity </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> my_entities</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    kind </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> entity</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'kind'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    parent_key </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> kind </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"column\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        parent_key </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore_client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"table\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> entity</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"table_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">elif</span><span class=\"token plain\"> kind </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"classification\"</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        parent_key </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore_client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"table\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> entity</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"table_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                                          </span><span class=\"token string\" style=\"color:#e3116c\">\"column\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> entity</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"column_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    key </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore_client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">kind</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> entity</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">kind</span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token string\" style=\"color:#e3116c\">\"_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        parent</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">parent_key</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    datastore_entry </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">Entity</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    datastore_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">update</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">entity</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"Saving: {}\"</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">entity</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    datastore_client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">put</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">datastore_entry</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>The code above assumes that you’ve set yourself up with a working Service Account or authorised yourself in, and that your GCP project has been set.</p><p>Now let’s do some digging around our newly minted Datastore model. Let’s grab the column ‘broker_legal_name’</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">query1 </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore_client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">query</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">kind</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"column\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">query1</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">add_filter</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"column_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"=\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"broker_legal_name\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Now that we have the column entity, let’s locate it’s parent id.</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">column </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">query1</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">fetch</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"This column belongs to: \"</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">+</span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">column</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">parent</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">id_or_name</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Further to this, we can also get all data classification elements attributed to a single column using the ancestor clause query.</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">query2 </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore_client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">query</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">kind</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"classification\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> ancestor</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">column</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> classification </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">query2</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">fetch</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">classification</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">classification</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"restriction_level\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>For more complex queries, Datastore has the concept of indexes being set, usually via it’s index.yaml configuration. The following is an example of an <code>index.yaml</code> file:</p><div class=\"language-yaml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-yaml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token key atrule\" style=\"color:#00a4db\">indexes</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">kind</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Cat</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">ancestor</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> no</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">properties</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> name</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> age</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token key atrule\" style=\"color:#00a4db\">direction</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> desc</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">kind</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Cat</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">properties</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> name</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token key atrule\" style=\"color:#00a4db\">direction</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> asc</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> whiskers</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token key atrule\" style=\"color:#00a4db\">direction</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> desc</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">kind</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Store</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">ancestor</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> yes</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">properties</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> business</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token key atrule\" style=\"color:#00a4db\">direction</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> asc</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> owner</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token key atrule\" style=\"color:#00a4db\">direction</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> asc</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Indexes are important when attempting to add filters on more than one particular attribute within a Datastore entity. For example, the following code will fail:</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># Adding a '&gt;' filter will cause this to fail. Sidenote; it will work</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># without an index if you add another '=' filter.</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">query2 </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore_client</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">query</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">kind</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token string\" style=\"color:#e3116c\">\"classification\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> ancestor</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">column</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">query2</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">add_filter</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"pii\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"&gt;\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> classification </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> </span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">query2</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">fetch</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">classification</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">key</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">classification</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"classification_id\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>To rectify this issue, you need to create an index.yaml that looks like the following:</p><div class=\"language-yaml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-yaml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token key atrule\" style=\"color:#00a4db\">indexes</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">kind</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> classification</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">ancestor</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> yes</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">properties</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> </span><span class=\"token key atrule\" style=\"color:#00a4db\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> pii</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>You would usually upload the yaml file using the gcloud commands:</p><p><code>gcloud datastore indexes create path/to/index.yaml.</code></p><p>However, let’s do this programmatically.</p><p>The official pypi package for google-cloud-datastore can be found here: <a href=\"https://pypi.org/project/google-cloud-datastore/\" target=\"_blank\" rel=\"noopener noreferrer\">https://pypi.org/project/google-cloud-datastore/</a>. At the time of writing, Firestore in Datastore-mode will be the way forward, as per the release note from January 31, 2019.</p><blockquote><p>Cloud Firestore is now Generally Available. Cloud Firestore is the new version of Cloud Datastore and includes a backwards-compatible Datastore mode.</p></blockquote><blockquote><p>If you intend to use the Cloud Datastore API in a new project, use Cloud Firestore in Datastore mode. Existing Cloud Datastore databases will be automatically upgraded to Cloud Firestore in Datastore mode.</p></blockquote><blockquote><p>Except where noted, the Cloud Datastore documentation now describes behavior for Cloud Firestore in Datastore mode.</p></blockquote><p>We’ve purposefully created MDH in Datastore to show you how it was done originally, and we’ll be migrating the Datastore code to Firestore in an upcoming post.</p><p>Creating and deleting indexes within Datastore will need to be done through the REST API via googleapiclient.discovery, as this function doesn’t exist via the google-cloud-datastore API. Working with the discovery api client can be a bit daunting for a first-time user, so here’s the code to add an index on Datastore:</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> os</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> google</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">oauth2 </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> service_account</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> googleapiclient</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">discovery </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> build</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">from</span><span class=\"token plain\"> google</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">cloud </span><span class=\"token keyword\" style=\"color:#00009f\">import</span><span class=\"token plain\"> datastore</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">SCOPES </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">'https://www.googleapis.com/auth/cloud-platform'</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">SERVICE_ACCOUNT_FILE </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> os</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">getenv</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'GOOGLE_APPLICATION_CREDENTIALS'</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">PROJECT_ID </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> os</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">getenv</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"PROJECT_ID\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">credentials </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> service_account</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">             </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">Credentials</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">         </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">from_service_account_file</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">SERVICE_ACCOUNT_FILE</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> scopes</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">SCOPES</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">datastore_api </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> build</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">'datastore'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'v1'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> credentials</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">credentials</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">body </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">'ancestor'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'ALL_ANCESTORS'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">'kind'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'classification'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token string\" style=\"color:#e3116c\">'properties'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token string\" style=\"color:#e3116c\">'name'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'pii'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token string\" style=\"color:#e3116c\">'direction'</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'DESCENDING'</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">response </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> datastore_api</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">projects</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">           </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">indexes</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">           </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">projectId</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">PROJECT_ID</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> body</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">body</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">           </span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">execute</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>How did we craft this API request? We can use the Google API Discovery Service to build client libraries, IDE plugins, and other tools that interact with Google APIs. The Discovery API provides a list of Google APIs and a machine-readable \"Discovery Document\" for each API. Features of the Discovery API:</p><ul><li>A directory of supported APIs schemas based on JSON Schema.</li><li>A machine-readable \"Discovery Document\" for each of the supported APIs. Each document contains:</li><li>A list of API methods and available parameters for each method.</li><li>A list of available OAuth 2.0 scopes.</li><li>Inline documentation of methods, parameters, and available parameter values.</li></ul><p>Navigating to the API reference page for Datastore and going to the ‘Datastore Admin’ API page, we can see references to the Indexes and RESTful endpoints we can hit for those Indexes. Therefore, looking at the link for the Discovery document for Datastore:</p><blockquote><p><a href=\"https://datastore.googleapis.com/$discovery/rest?version=v1\" target=\"_blank\" rel=\"noopener noreferrer\">https://datastore.googleapis.com/$discovery/rest?version=v1</a></p></blockquote><p>From this, we can build out our instantiation for the google api discovery object build('datastore', 'v1', credentials=credentials)</p><p>With respect to building out the body aspect of the request, I’ve found crafting that part within the ‘Try this API’ section of <code>https://cloud.google.com/datastore/docs/reference/admin/rest/v1/projects.indexes/create</code> pretty valuable.</p><p>With this code, your index should show up in your Datastore console! You can also retrieve them within gcloud with gcloud datastore indexes list if you’d like to verify the indexes outside our python code. So there you have it: a working example of entity groups, ancestors, indexes and Metadata within Datastore. Have fun coding!</p>",
            "url": "https://fullstackchronicles.io/introducing-the-metadata-hub-mdh",
            "title": "Introducing the Metadata Hub (MDH)",
            "summary": "Metadata Hub (MDH) is intended to be the source of truth for metadata around the Company’s platform. It has the ability to load metadata configuration from yaml, and serve that information up via API. It will also be the store of information for pipeline information while ingesting files into the platform.",
            "date_modified": "2021-06-15T00:00:00.000Z",
            "author": {
                "name": "Tom Klimovski",
                "url": "https://github.com/tomklimovskigamma"
            },
            "tags": [
                "gcp",
                "google-cloud-platform",
                "metadata"
            ]
        },
        {
            "id": "masking-private-keys-in-ci-cd-pipelines-in-gitlab",
            "content_html": "<p>Big fan of GitLab (and GitLab CI in particular). I had a recent requirement to push changes to a wiki repo associated with a GitLab project through a GitLab CI pipeline (using the SaaS version of GitLab) and ran into a conundrum…</p><p>Using the GitLab SaaS version - deploy tokens can’t have write api access, so the next best solution is to use deploy keys, adding your public key as a deploy key and granting this key write access to repositories is relatively straightforward.</p><p>This issue is when you attempt to create a masked GitLab CI variable using the private key from your keypair, you get this…</p><p><a target=\"_blank\" href=\"/assets/files/masked-variable-a71bee3c260fb07842a2cf68e9f8b37e.png\"><img loading=\"lazy\" src=\"/assets/images/masked-variable-a71bee3c260fb07842a2cf68e9f8b37e.png\" width=\"1920\" height=\"1040\" class=\"img_ev3q\"></a></p><p>I was a bit astonished to see this to be honest… Looks like it has been raised as an issue several times over the last few years but never resolved (the root cause of which is something to do with newline characters or base64 encoding or the overall length of the string).</p><p>I came up with a solution! Not pretty but effective, masks the variable so that it cannot be printed in CI logs as shown here:</p><p><a target=\"_blank\" href=\"/assets/files/ci-ssh-key-21fa947e5812357fc909715776d842dd.png\"><img loading=\"lazy\" src=\"data:image/png;base64,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\" width=\"402\" height=\"189\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"setup\">Setup<a class=\"hash-link\" href=\"#setup\" title=\"Direct link to heading\">​</a></h2><p>Add a masked and protected GitLab variable for each line in the private key, for example:</p><p><a target=\"_blank\" href=\"/assets/files/masked-vars-ab75ab02f93f5937aaffe559407d3cff.png\"><img loading=\"lazy\" src=\"/assets/images/masked-vars-ab75ab02f93f5937aaffe559407d3cff.png\" width=\"1920\" height=\"1040\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-code\">The Code<a class=\"hash-link\" href=\"#the-code\" title=\"Direct link to heading\">​</a></h2><p>Add the following block to your <code>.gitlab-ci.yml</code> file:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-b5260f14ecc0bf0d080c80297d0b475c\"></iframe><p>now within Jobs in your pipeline you can simply do this to clone, push or pull from a remote GitLab repo:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-c96e211544f7cb4ef3ca4e90dc8e36e3\"></iframe><p>as mentioned not pretty, but effective and no other cleaner options as I could see…</p>",
            "url": "https://fullstackchronicles.io/masking-private-keys-in-ci-cd-pipelines-in-gitlab",
            "title": "Masking Private Keys in CI/CD Pipelines in GitLab",
            "summary": "Big fan of GitLab (and GitLab CI in particular). I had a recent requirement to push changes to a wiki repo associated with a GitLab project through a GitLab CI pipeline (using the SaaS version of GitLab) and ran into a conundrum…",
            "date_modified": "2021-06-15T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "ci",
                "gitlab",
                "gitlab-ci",
                "private-keys",
                "secrets"
            ]
        },
        {
            "id": "simple-tasker-configuration-driven-orchestration",
            "content_html": "<p>Recently I found myself at a client that were using a third party tool to scan all their enterprise applications in order to collate their data lineage. They had spent two years onboarding applications to the tool, resulting in a large technical mess that was hard to debug and impossible to extend. As new applications were integrated onto the platform, developers were forced to think of new ways of connecting and tranforming the data so it could be consumed.</p><p>The general approach was: <code>setup scanner</code> -&gt; <code>scan application</code> -&gt; <code>modify results</code> -&gt; <code>upload results</code> -&gt; <code>backup results</code> -&gt; <code>cleanup workspace</code> -&gt; <code>delete anything older than 'X' days</code></p><p>Each developer had their own style of doing this - involving shell scripts, python scripts, SQL and everything in between. Worse, there was slabs of code replicated across the entire repository, with variables and paths changed depending on the use case.</p><p>My tasks was to create a framework that could orchestrate the scanning and adhered to the following philosophies:</p><ul><li>DRY (Don't Repeat Yourself)</li><li>Config driven</li><li>Version controlled</li><li>Simple to extend</li><li>Idempotent</li></ul><p>It also had to be written in Python as that was all the client was skilled in.</p><p>After looking at what was on the market (Airflow and Prefect being the main contenders) I decided to roll my own simplified orchestrator that required as little actual coding as possible and could be setup by configuration.</p><p>In choosing a configuration format, I settled on <a href=\"https://github.com/lightbend/config/blob/master/HOCON.md\" target=\"_blank\" rel=\"noopener noreferrer\">HOCON</a> as it closely resembled JSON but has advanced features such as interpolation, substitions and the ability to include other hocon files - this would drastically reduce the amount of boilerplate configuration required.</p><p>Because I had focused so heavily on being configuration driven, I also needed the following charecteristics to be delivered:</p><ul><li>Self discovery of task types (more on this later)</li><li>Configuration validation at startup</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"tasks-and-self-discovery\">Tasks and self discovery<a class=\"hash-link\" href=\"#tasks-and-self-discovery\" title=\"Direct link to heading\">​</a></h2><p>As I wanted anyone to be able to rapidly extend the framework by adding tasks, I needed to reduce as much repetition and boilerplate as possible. Ideally, I wanted a developer to just have to think about writing code and not have to deal with how to integrate this.</p><p>To achieve this, we needed a way of registering new 'tasks' that would become available to the framework. I wanted a developer to simply have to subclass the main Task class and implement a run function - the rest would be taken care of.</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">TaskRegistry</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_registry </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">register</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> cls</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">type</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        n </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token builtin\">getattr</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">cls</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">'task_name'</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> cls</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">__name__</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">lower</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_registry</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">n</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> cls</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">registered</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> List</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token builtin\">list</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_registry</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">keys</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">has</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">bool</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> name </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_registry</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">get</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">type</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_registry</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">create</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> name</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">args</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">**</span><span class=\"token plain\">kwargs</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">object</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_registry</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">*</span><span class=\"token plain\">args</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">**</span><span class=\"token plain\">kwargs</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> KeyError</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> ClassNotRegisteredException</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">registry </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> TaskRegistry</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Once the registry was instantiated, any new Tasks that inherited from 'Task' would automatically be added to the registry. We could then use the <code>create(name)</code> function to instantiate any class - essentially a pythonic <a href=\"https://en.wikipedia.org/wiki/Factory_method_pattern\" target=\"_blank\" rel=\"noopener noreferrer\">Factory Method</a></p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Task</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">ABC</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">logger </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> logging</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">getLogger</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">__class__</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">__name__</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__init_subclass__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">cls</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        registry</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">register</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">cls</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token decorator annotation punctuation\" style=\"color:#393A34\">@abstractmethod</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">**</span><span class=\"token plain\">kwargs</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">bool</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">raise</span><span class=\"token plain\"> NotImplementedError</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>For the framework to automatically register the classes, it was important to follow the project structure. As long as the task resided in the 'tasks' module, we could scan this at runtime and register each task.</p><div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">└── simple_tasker</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    ├── __init__.py</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    ├── cli.py</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    └── tasks</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        ├── __init__.py</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        ├── archive.py</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        └── shell_script.py</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>This was achieved with a simple dynamic module importer</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">modules </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> glob</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">glob</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">join</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">dirname</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">__file__</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"*.py\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> f </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> modules</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> isfile</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">f</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">and</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">not</span><span class=\"token plain\"> f</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">endswith</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"__init__.py\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token builtin\">__import__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">Task</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">.</span><span class=\"token string-interpolation interpolation\">__module__</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">.</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">basename</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation interpolation\">f</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">)</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">[</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">:</span><span class=\"token string-interpolation interpolation format-spec\">-3]</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-configuration\">The configuration<a class=\"hash-link\" href=\"#the-configuration\" title=\"Direct link to heading\">​</a></h2><p>In designing how the configuration would bind to the task, I needed to capture the <code>name</code> (what object to instanticate) and what <code>args</code> to pass to the instantiated run function. I decided to model it as below with everything under a 'tasks' array</p><div class=\"language-text codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">tasks: [</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        name: shell_script</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        args: {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            script_path: uname</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            script_args: -a</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    },</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        name: shell_script</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        args: {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            script_path: find</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            script_args: [${CWD}/simple_tasker/tasks, -name, \"*.py\"]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    },</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        name: archive</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        args: {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            input_directory_path: ${CWD}/simple_tasker/tasks</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            target_file_path: /tmp/${PLATFORM}_${TODAY}.tar.gz</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"orchestration-and-validation\">Orchestration and validation<a class=\"hash-link\" href=\"#orchestration-and-validation\" title=\"Direct link to heading\">​</a></h2><p>As mentioned previously, one of the goals was to ensure the configuration was valid prior to any execution. This meant that the framework needed to validate whether tha task <code>name</code> referred to a registered task, and that all mandatory <code>arguments</code> were addressed in the configuration. Determining whether the task was registered was just a simple key check, however to validate the arguments to the run required some inspection - I needed to get all args for the run function and filter out 'self' and any asterisk args (<!-- -->*<!-- -->args, <!-- -->*<!-- -->*<!-- -->kwargs)</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">get_mandatory_args</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">func</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> List</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    mandatory_args </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> k</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> v </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> inspect</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">signature</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">func</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">parameters</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">items</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            k </span><span class=\"token operator\" style=\"color:#393A34\">!=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"self\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">and</span><span class=\"token plain\"> v</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">default </span><span class=\"token keyword\" style=\"color:#00009f\">is</span><span class=\"token plain\"> inspect</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">Parameter</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">empty</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">and</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">not</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">v</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">startswith</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"*\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            mandatory_args</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">append</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">k</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> mandatory_args</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>And finally onto the actual execution bit. The main functionality required here is to validate that the config was defined correctly, then loop through all tasks and execute them - passing in any args.</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Tasker</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> path</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Path</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> env</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Dict</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">logger </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> logging</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">getLogger</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">__class__</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">__name__</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_tasks </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">with</span><span class=\"token plain\"> wrap_environment</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">env</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_config </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> ConfigFactory</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">parse_file</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">path</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__validate_config</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">bool</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        error_count </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> task </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_config</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"tasks\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            name</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> args </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> task</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"name\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">lower</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> task</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"args\"</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">{</span><span class=\"token punctuation\" style=\"color:#393A34\">}</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> registry</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">has</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> arg </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> get_mandatory_args</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">registry</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">get</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                    </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> arg </span><span class=\"token keyword\" style=\"color:#00009f\">not</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> args</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                        </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"Missing arg '</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">arg</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">' for task '</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">name</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">'\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                        error_count </span><span class=\"token operator\" style=\"color:#393A34\">+=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">else</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                </span><span class=\"token keyword\" style=\"color:#00009f\">print</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"Unknown tasks '</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">name</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">'\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                error_count </span><span class=\"token operator\" style=\"color:#393A34\">+=</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">1</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">append</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> args</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> error_count </span><span class=\"token operator\" style=\"color:#393A34\">==</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">0</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">bool</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">__validate_config</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> name</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> args </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">_tasks</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                exe </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> registry</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">create</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">name</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">logger</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">info</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"About to execute: '</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">name</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">'\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">not</span><span class=\"token plain\"> exe</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token operator\" style=\"color:#393A34\">**</span><span class=\"token plain\">args</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                    self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">logger</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">error</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"Failed tasks '</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">name</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">'\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                    </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">True</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"putting-it-together---sample-tasks\">Putting it together - sample tasks<a class=\"hash-link\" href=\"#putting-it-together---sample-tasks\" title=\"Direct link to heading\">​</a></h2><p>Below are two examples of how easy it is to configure the framework. We have a simple folder archiver that will tar/gz a directory based on 2 input parameters.</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">Archive</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Task</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token builtin\">super</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> input_directory_path</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> target_file_path</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">bool</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">logger</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">info</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">f\"Archiving '</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">input_directory_path</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">' to '</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">{</span><span class=\"token string-interpolation interpolation\">target_file_path</span><span class=\"token string-interpolation interpolation punctuation\" style=\"color:#393A34\">}</span><span class=\"token string-interpolation string\" style=\"color:#e3116c\">'\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">with</span><span class=\"token plain\"> tarfile</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">target_file_path</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"w:gz\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> tar</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            tar</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">add</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                input_directory_path</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                arcname</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">os</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">path</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">basename</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">input_directory_path</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">True</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>A more complex example would be the ability to execute shell scripts (or os functions) by passing in some optional variables and variables that can either be a string or list.</p><div class=\"language-python codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-python codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token keyword\" style=\"color:#00009f\">class</span><span class=\"token plain\"> </span><span class=\"token class-name\">ShellScript</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">Task</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    task_name </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"shell_script\"</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">self</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token builtin\">super</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">__init__</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token keyword\" style=\"color:#00009f\">def</span><span class=\"token plain\"> </span><span class=\"token function\" style=\"color:#d73a49\">run</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        self</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        script_path</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        script_args</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> Union</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> List</span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        working_directory_path</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">None</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">-</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> </span><span class=\"token builtin\">bool</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        cmd </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token plain\">script_path</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">if</span><span class=\"token plain\"> </span><span class=\"token builtin\">isinstance</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">script_args</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> </span><span class=\"token builtin\">str</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            cmd</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">append</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">script_args</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">else</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            cmd </span><span class=\"token operator\" style=\"color:#393A34\">+=</span><span class=\"token plain\"> script_args</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">try</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            result </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> subprocess</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">check_output</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                cmd</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                stderr</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">subprocess</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">STDOUT</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                cwd</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">working_directory_path</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">decode</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token string\" style=\"color:#e3116c\">\"utf-8\"</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">splitlines</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">for</span><span class=\"token plain\"> o </span><span class=\"token keyword\" style=\"color:#00009f\">in</span><span class=\"token plain\"> result</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">                self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">logger</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">info</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">o</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">except</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">subprocess</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">CalledProcessError</span><span class=\"token punctuation\" style=\"color:#393A34\">,</span><span class=\"token plain\"> FileNotFoundError</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"> </span><span class=\"token keyword\" style=\"color:#00009f\">as</span><span class=\"token plain\"> e</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            self</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">logger</span><span class=\"token punctuation\" style=\"color:#393A34\">.</span><span class=\"token plain\">error</span><span class=\"token punctuation\" style=\"color:#393A34\">(</span><span class=\"token plain\">e</span><span class=\"token punctuation\" style=\"color:#393A34\">)</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">            </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">False</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">        </span><span class=\"token keyword\" style=\"color:#00009f\">return</span><span class=\"token plain\"> </span><span class=\"token boolean\" style=\"color:#36acaa\">True</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>You can view the entire implementation <a href=\"https://github.com/mpstella/simple_tasker\" target=\"_blank\" rel=\"noopener noreferrer\">here</a></p>",
            "url": "https://fullstackchronicles.io/simple-tasker-configuration-driven-orchestration",
            "title": "Simple Tasker: Configuration driven orchestration",
            "summary": "Recently I found myself at a client that were using a third party tool to scan all their enterprise applications in order to collate their data lineage. They had spent two years onboarding applications to the tool, resulting in a large technical mess that was hard to debug and impossible to extend. As new applications were integrated onto the platform, developers were forced to think of new ways of connecting and tranforming the data so it could be consumed.",
            "date_modified": "2021-06-15T00:00:00.000Z",
            "author": {
                "name": "Mark Stella",
                "url": "https://github.com/mpstella"
            },
            "tags": [
                "data-lineage",
                "orchestration",
                "python"
            ]
        },
        {
            "id": "okta-admin-command-line-interface",
            "content_html": "<p><img loading=\"lazy\" alt=\"Okta Admin CLI\" src=\"data:image/png;base64,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\" width=\"96\" height=\"96\" class=\"img_ev3q\"></p><p>Identity and Access Management is a critical component of any application or SaaS architecture. I’m currently doing a spike of the Okta solution for an application development project I am on. Okta is a comprehensive solution built on the open OAuth2 and OIDC protocols, as well as supporting more conventional identity federation approaches such as SAML.</p><p>Okta has a clean and easy to use web-based Admin interface which can be used to create applications, users, claims, identity providers and more.</p><p>During my spike, which was done in a crash and burn test Okta organisation, I had associated my user account with a Microsoft Identity Provider for SSO, and subsequently had issues accessing the Microsoft Account my user was associated with, as a result I managed to lock myself (the super admin) out of the Okta Admin Console.</p><p>Fortunately, prior to doing this I had created an API token for my user. So, I went about looking at ways I could interact with Okta programmatically. My first inclination was to use a simple CLI for Okta to get me out of jail… but I found there wasn’t one that suited. There are, however, a wealth of SDKs for Okta across multiple front-end and back-end oriented programming languages (such as JavaScript, Golang, Python and more).</p><p>Being in lockdown and having some free time on my hands, I decided to create a simple open source command line tool which could be used to administer an Okta organisation. The result of this weekend lockdown is <code>okta-admin</code>…</p><p><a target=\"_blank\" href=\"/assets/files/okta-admin-screenshot-0b64c7a4ed3137543c265761574f5879.png\"><img loading=\"lazy\" alt=\"okta-admin cli\" src=\"/assets/images/okta-admin-screenshot-0b64c7a4ed3137543c265761574f5879.png\" width=\"1339\" height=\"622\" class=\"img_ev3q\"></a></p><p>For this project I used the <a href=\"https://github.com/okta/okta-sdk-golang\" target=\"_blank\" rel=\"noopener noreferrer\">Golang SDK for Okta</a>, along with the <a href=\"https://github.com/spf13/cobra\" target=\"_blank\" rel=\"noopener noreferrer\">Cobra</a> and <a href=\"https://github.com/spf13/viper\" target=\"_blank\" rel=\"noopener noreferrer\">Viper</a> Golang packages (used by <code>docker</code>, <code>kubectl</code> and other popular command line utilities). To provide a query interface to JSON response payloads I use <a href=\"https://github.com/tidwall/gjson\" target=\"_blank\" rel=\"noopener noreferrer\">GJson</a>.</p><p>Will keep adding to this so stay tuned...</p><blockquote><p>Complete source code for this project is available at <a href=\"https://github.com/gammastudios/okta-admin\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/gammastudios/okta-admin</a></p></blockquote>",
            "url": "https://fullstackchronicles.io/okta-admin-command-line-interface",
            "title": "Okta Admin Command Line Interface",
            "summary": "Okta Admin CLI",
            "date_modified": "2021-05-30T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "cli",
                "command-line",
                "golang",
                "identity",
                "oauth-2-0",
                "oidc",
                "okta"
            ]
        },
        {
            "id": "enumerating-all-roles-for-a-user-in-snowflake",
            "content_html": "<p><img loading=\"lazy\" alt=\"Snowflake\" src=\"data:image/png;base64,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\" width=\"82\" height=\"75\" class=\"img_ev3q\"></p><p>Snowflake allows roles to be assigned to other roles, so when a user is assigned to a role, they may inherit the ability to use countless other roles.</p><p><strong>Challenge:</strong> recursively enumerate all roles for a given user</p><p>One solution would be to create a complex query on the <code>“SNOWFLAKE\".\"ACCOUNT_USAGE\".\"GRANTS_TO_ROLES\"</code> object.</p><p>An easier solution is to use a stored procedure to recurse through grants for a given user and return an <code>ARRAY</code> of roles for that user.</p><p>This is a good programming exercise in tail call recursion (sort of) in JavaScript. Here is the code:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-9b9985dbf8163ade22b71f2ccf20cb51\"></iframe><p>To call the stored proc, execute:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-fbbfaa3b67af828e4d905411567cd031\"></iframe><p>One drawback of stored procedures in Snowflake is that they can only have scalar or array return types and cannot be used directly in a SQL query, however you can use the <code>table(result_scan(last_query_id()))</code> trick to get around this, as shown below where we will pivot the <code>ARRAY</code> into a record set with the array elements as rows:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-6a7e8bc552b87ab1e039f22bacf1b65f\"></iframe><p><strong>IMPORTANT</strong></p><p>This query <strong>must</strong> be the next statement run immediately after the <code>CALL</code> statement and cannot be run again until you run another <code>CALL</code> statement.</p><p>More adventures with Snowflake soon!</p>",
            "url": "https://fullstackchronicles.io/enumerating-all-roles-for-a-user-in-snowflake",
            "title": "Enumerating all roles for a user in Snowflake",
            "summary": "Snowflake",
            "date_modified": "2021-03-23T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "javascript",
                "rbac",
                "roles",
                "snowflake",
                "sql",
                "stored-procedure",
                "tail-call-recursion",
                "tailcall"
            ]
        },
        {
            "id": "eventarc-the-state-of-eventing-in-google-cloud",
            "content_html": "<p>When defining event-driven architectures, it's always good to keep up with how the landscape is changing. How do you connect microservices in your architecture? Is Pub/Sub the end-game for all events? To dive a bit deeper, let's talk through the benefits of having a single&nbsp;<em>orchestrator</em>, or perhaps a choreographer is better?</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"orchestration-versus-choreography-refresher\">Orchestration versus choreography refresher<a class=\"hash-link\" href=\"#orchestration-versus-choreography-refresher\" title=\"Direct link to heading\">​</a></h2><p>My colleague <a href=\"https://www.linkedin.com/in/jeffreyaven/\" target=\"_blank\" rel=\"noopener noreferrer\">@jeffreyaven</a> did a recent post explaining this concept in simple terms, which is worth reviewing, see:</p><p><a href=\"https://cloudywithachanceofbigdata.com/microservices-concepts-orchestration-versus-choreography/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Microservices Concepts: Orchestration versus Choreography</strong></a></p><p>Should there really be a central orchestrator controlling all interactions between services.....or, should each service work independently and only interact through events?</p><ul><li><strong>Orchestration</strong>&nbsp;is usually viewed as a domain-wide central service that defines the flow and control of communication between services. In this paradigm, in becomes easier to change and ultimately monitor policies across your org.</li><li><strong>Choreography</strong>&nbsp;has each service registering and emitting events as they need to. It doesn't direct or define the flow of communication, but using this method usually has a central broker passing around messages and allows services to be truly independent.</li></ul><p>Enter&nbsp;<a href=\"https://cloud.google.com/workflows\" target=\"_blank\" rel=\"noopener noreferrer\">Workflows</a>, which is suited for centrally orchestrated services. Not only Google Cloud service such as Cloud Functions and Cloud Run, but also external services.</p><p>How about choreography?&nbsp;<a href=\"https://cloud.google.com/pubsub\" target=\"_blank\" rel=\"noopener noreferrer\">Pub/Sub</a>&nbsp;and&nbsp;<a href=\"https://cloud.google.com/blog/products/serverless/build-event-driven-applications-in-cloud-run\" target=\"_blank\" rel=\"noopener noreferrer\">Eventarc</a>&nbsp;are both suited for this. We all know and love Pub/Sub,&nbsp;<em>but how do I use EventArc?</em></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"what-is-eventarc\">What is Eventarc?<a class=\"hash-link\" href=\"#what-is-eventarc\" title=\"Direct link to heading\">​</a></h2><p>Announced in October-2020, it was introduced as eventing functionality that enables you, the developer, to send events&nbsp;<em>to</em>&nbsp;Cloud Run from more than 60 Google Cloud sources.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"but-how-does-it-work\">But how does it work?<a class=\"hash-link\" href=\"#but-how-does-it-work\" title=\"Direct link to heading\">​</a></h3><p>Eventing is done by reading those sweet sweet Audit Logs, from various sources, and sending them to Cloud Run services as events in&nbsp;<a href=\"https://cloudevents.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Cloud Events</a>&nbsp;format. Quick primer on Cloud Events: its a specification for describing event data in a common way. The specification is now under the&nbsp;<a href=\"https://cncf.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Cloud Native Computing Foundation</a>. Hooray! It can also read events from Pub/Sub topics for custom applications. Here's a diagram I graciously ripped from&nbsp;<a href=\"https://cloud.google.com/blog/topics/developers-practitioners/eventarc-unified-eventing-experience-google-cloud\" target=\"_blank\" rel=\"noopener noreferrer\">Google Cloud Blog</a>:</p><p><a target=\"_blank\" href=\"/assets/files/CloudEvents_fig1-4783f065699c51da51533f449993da71.png\"><img loading=\"lazy\" alt=\"Eventarc\" src=\"/assets/images/CloudEvents_fig1-4783f065699c51da51533f449993da71.png\" width=\"1000\" height=\"484\" class=\"img_ev3q\"></a></p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"why-do-i-need-eventarc-i-have-the-pubsub\">Why do I need Eventarc? I have the Pub/Sub<a class=\"hash-link\" href=\"#why-do-i-need-eventarc-i-have-the-pubsub\" title=\"Direct link to heading\">​</a></h3><p>Good question. Eventarc provides and easier path to receive events not only from Pub/Sub topics but from a number of Google Cloud sources with its Audit Log and Pub/Sub integration. Actually,&nbsp;<em>any</em>&nbsp;service that has Audit Log integration can be an event source for Eventarc. Beyond easy integration, it provides consistency and structure to how events are generated, routed and consumed. Things like:</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"triggers\"><strong>Triggers</strong><a class=\"hash-link\" href=\"#triggers\" title=\"Direct link to heading\">​</a></h4><p>They specify routing rules from events sources, to event sinks. Listen for new object creation in GCS and route that event to a service in Cloud Run by creating an Audit-Log-Trigger. Create triggers that also listen to Pub/Sub. Then list&nbsp;<strong>all</strong>&nbsp;triggers in one, central place in Eventarc:</p><p><code>gcloud beta eventarc triggers list</code></p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"consistency-with-eventing-format-and-libraries\"><strong>Consistency with eventing format and libraries</strong><a class=\"hash-link\" href=\"#consistency-with-eventing-format-and-libraries\" title=\"Direct link to heading\">​</a></h4><p>Using the CloudEvent-compliant specification will allow for event data in a common way, increasing the movement towards the goal of consistency, accessibility and portability. Makes it easier for different languages to read the event and Google Events Libraries to parse fields.</p><p>This means that the long-term vision of Eventarc to be the&nbsp;<strong>hub</strong>&nbsp;of events, enabling a unified eventing story for Google Cloud and beyond.</p><p><a target=\"_blank\" href=\"/assets/files/CloudEvents_fig2-5aa5db31489216065557e5f35995b461.png\"><img loading=\"lazy\" alt=\"Eventarc producers and consumers\" src=\"/assets/images/CloudEvents_fig2-5aa5db31489216065557e5f35995b461.png\" width=\"900\" height=\"612\" class=\"img_ev3q\"></a></p><p>In the future, you can excpect to forego Audit Log and read these events directly and send these out to even more sinks within GCP and any HTTP target.</p><hr><p>This article written on inspiration from&nbsp;<a href=\"https://cloud.google.com/blog/topics/developers-practitioners/eventarc-unified-eventing-experience-google-cloud\" target=\"_blank\" rel=\"noopener noreferrer\">https://cloud.google.com/blog/topics/developers-practitioners/eventarc-unified-eventing-experience-google-cloud</a>. Thanks Mete Atamel!</p>",
            "url": "https://fullstackchronicles.io/eventarc-the-state-of-eventing-in-google-cloud",
            "title": "EventArc: The state of eventing in Google Cloud",
            "summary": "When defining event-driven architectures, it's always good to keep up with how the landscape is changing. How do you connect microservices in your architecture? Is Pub/Sub the end-game for all events? To dive a bit deeper, let's talk through the benefits of having a single orchestrator, or perhaps a choreographer is better?",
            "date_modified": "2021-02-28T00:00:00.000Z",
            "author": {
                "name": "Tom Klimovski",
                "url": "https://github.com/tomklimovskigamma"
            },
            "tags": [
                "eventarc",
                "google-cloud-platform",
                "microservices",
                "gcp"
            ]
        },
        {
            "id": "microservices-concepts-orchestration-versus-choreography",
            "content_html": "<p><img loading=\"lazy\" alt=\"Orchestration versus Choreography\" src=\"/assets/images/service-mesh-1-d7868fc724132b5e947edad350e8e1ed.png\" width=\"151\" height=\"106\" class=\"img_ev3q\"></p><p>One of the foundational concepts in microservices architecture and design patterns is the concept of Orchestration versus Choreography. Before we look at a reference implementation of each of these patterns, it is worthwhile starting with an analogy.</p><p>This is often likened to a Jazz band versus a Symphony Orchestra.</p><p>A modern symphony orchestra is normally comprised of sections such as strings, brass, woodwind and percussion sections. The sections are orchestrated by a conductor, usually placed at a central point with respect to each of the sections. The conductor instructs each section to perform their components of the overall symphony.</p><p>By contrast, a Jazz band does not have a conductor and also features improvisation, with different musicians improvising based upon each other. Choreography, although more aligned to dance, can involve improvisation. In both cases there is still an intended output and a general framework as to how the composition will be executed, however unlike a symphony orchestra there is a degree of spontaneity.</p><p><em>Now back to technology and microservices…</em></p><p>In the Orchestration model, there is a central orchestration service which controls the interactions between other services, in other words the flow and control of communication and/or message passing between services is controlled by an orchestrator (much like the conductor in a symphony orchestra). On the plus side, this model enables easier monitoring and policy enforcement across the system. A generalisation of the Orchestration model is shown below:</p><p><a target=\"_blank\" href=\"/assets/files/orchestration-0e429940458bccdec2326a71306eb3b5.png\"><img loading=\"lazy\" alt=\"Orchestration model\" src=\"/assets/images/orchestration-0e429940458bccdec2326a71306eb3b5.png\" width=\"479\" height=\"340\" class=\"img_ev3q\"></a></p><p>By contrast, in the Choreography model, each service works independently and interacts with other services through events. In this model each service registers and emits events as they need to. The flow (of communication between services) is not predefined, much like a Jazz band. This model often includes a central broker for message passing between services, but the services operate independently of each other and are not controlled by a central service (an orchestrator). A generalisation of the Choreography model is shown below:</p><p><a target=\"_blank\" href=\"/assets/files/choreography-4b44bc368786770d5db22f7ccfa41ae9.png\"><img loading=\"lazy\" alt=\"Choreography model\" src=\"/assets/images/choreography-4b44bc368786770d5db22f7ccfa41ae9.png\" width=\"541\" height=\"340\" class=\"img_ev3q\"></a></p><p>We will post subsequent articles with implementations of these patterns, but it is worthwhile getting a foundational understanding first.</p>",
            "url": "https://fullstackchronicles.io/microservices-concepts-orchestration-versus-choreography",
            "title": "Microservices Concepts: Orchestration versus Choreography",
            "summary": "Orchestration versus Choreography",
            "date_modified": "2021-02-26T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "microservices"
            ]
        },
        {
            "id": "using-the-azure-cli-to-create-an-api-using-a-function-app-within-api-management",
            "content_html": "<p><img loading=\"lazy\" alt=\"API Management Function App\" src=\"data:image/png;base64,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\" width=\"101\" height=\"115\" class=\"img_ev3q\"></p><p>Function Apps, Logic Apps and App Services can be used to expose APIs within Azure API Management which is an easy way to deploy serverless microservices. You can see this capability in the Azure portal below within API Management:</p><p><a target=\"_blank\" href=\"/assets/files/apimamanagement-add-fnapp-a479fd5e902fc785cebfdce4e32d60d8.png\"><img loading=\"lazy\" alt=\"Add a new API using a Function App as a back end\" src=\"/assets/images/apimamanagement-add-fnapp-a479fd5e902fc785cebfdce4e32d60d8.png\" width=\"1920\" height=\"1040\" class=\"img_ev3q\"></a></p><p>Like most readers, I like to script everything, so I was initially frustrated when I couldn’t replicate this operation in the Azure cli, REST, PowerShell, or any of the other SDKs or IaC tools. Others shared my frustration as seen <a href=\"https://feedback.azure.com/forums/248703-api-management/suggestions/36832033-programmatically-import-azure-function-into-apim\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p><p>I was nearly resigned to using click ops in the portal (arrrgh) before I worked out this workaround.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-solution\">The Solution<a class=\"hash-link\" href=\"#the-solution\" title=\"Direct link to heading\">​</a></h2><p>There is a bit more prep work required to automate this process, but it is well worth it.</p><ol><li>Create an OpenApi (or Swagger spec or WADL) specification document, as seen below (use the absolute URL for your Function App in the <code>url</code> parameter):</li></ol><iframe width=\"100%\" frameborder=\"0\" id=\"gist-077e8f313e6f44393df71057c8af7850\"></iframe><ol start=\"2\"><li>Use the <code>az apim api import</code> function (not the <code>az apim api create</code> function), as shown here:</li></ol><iframe width=\"100%\" frameborder=\"0\" id=\"gist-1f5eec542bd5ec01dbb9a06472e8e59b\"></iframe><ol start=\"3\"><li>Associate the API with a product (which is how you can rate limit APIs)</li></ol><iframe width=\"100%\" frameborder=\"0\" id=\"gist-4ad9c81b97ee97fb2cb6f794c2ae820f\"></iframe><p>That’s it! You can now access your function via the API gateway using the gateway url or via the developer portal as seen below:</p><p><a target=\"_blank\" href=\"/assets/files/apimamanagement-test-api-52e41024ea9942790e112d030d65965f.png\"><img loading=\"lazy\" alt=\"Function App API in API Management in the Azure Portal\" src=\"/assets/images/apimamanagement-test-api-52e41024ea9942790e112d030d65965f.png\" width=\"1920\" height=\"1040\" class=\"img_ev3q\"></a></p><p><a target=\"_blank\" href=\"/assets/files/apimamanagement-dev-portal-5cb59bd69af224f871a17852fcffb30e.png\"><img loading=\"lazy\" alt=\"Function App API in the Dev Portal\" src=\"/assets/images/apimamanagement-dev-portal-5cb59bd69af224f871a17852fcffb30e.png\" width=\"1920\" height=\"1040\" class=\"img_ev3q\"></a></p>",
            "url": "https://fullstackchronicles.io/using-the-azure-cli-to-create-an-api-using-a-function-app-within-api-management",
            "title": "Using the Azure CLI to Create an API using a Function App within API Management",
            "summary": "API Management Function App",
            "date_modified": "2021-01-06T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "api-management",
                "apis",
                "azure",
                "function-app",
                "microservices",
                "microsoft-azure",
                "serverless"
            ]
        },
        {
            "id": "great-expectations-for-your-data",
            "content_html": "<p><img loading=\"lazy\" alt=\"Great Expectations\" src=\"/assets/images/great-expectations-f9bde762a58323b62e2c19c514c74ba8.png\" width=\"165\" height=\"184\" class=\"img_ev3q\"></p><p>This article provides an introduction to the Great Expectations Python library for data quality management (<a href=\"https://github.com/great-expectations/great_expectations\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/great-expectations/great<!-- -->_<!-- -->expectations</a>).</p><p>So what are expectations when it comes to data (and data quality)...</p><p>An expectation is a falsifiable, verifiable statement about data. Expectations provide a language to talk about data characteristics and data quality - humans to humans, humans to machines and machines to machines.</p><p>The <strong>great expectations</strong> project includes predefined, codified expectations such as:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">expect_column_to_exist </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">expect_table_row_count_to_be_between </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">expect_column_values_to_be_unique </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">expect_column_values_to_not_be_null </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">expect_column_values_to_be_between </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">expect_column_values_to_match_regex </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">expect_column_mean_to_be_between </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">expect_column_kl_divergence_to_be_less_than</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>… and many more</p><p>Expectations are both data tests and docs! Expectations can be presented in a machine-friendly JSON, for example:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-317fa68cc27e4e364ab238a93f6ed361\"></iframe><p>Great Expectations provides validation results of defined expectations, which can dramatically shorten your development cycle.</p><p>[<img loading=\"lazy\" alt=\"validation results in great expectations\" src=\"/assets/images/validation_failed_unexpected_values-a2b73285ee54843380f035441f0c49e0.gif\" width=\"1445\" height=\"851\" class=\"img_ev3q\">](validation results in great expectations)</p><p>Nearly 50 built in expectations allow you to express how you understand your data, and you can add custom expectations if you need a new one. A machine can test if a dataset conforms to the expectation.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"ok-enough-talk-lets-go\">OK, enough talk, let's go!<a class=\"hash-link\" href=\"#ok-enough-talk-lets-go\" title=\"Direct link to heading\">​</a></h2><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">pyenv virtualenv </span><span class=\"token number\" style=\"color:#36acaa\">3.8</span><span class=\"token plain\">.2 ge38</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">pip </span><span class=\"token function\" style=\"color:#d73a49\">install</span><span class=\"token plain\"> great-expectations</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>tried with Python 3.7.2, but had issues with library <code>lgzm</code> on my local machine</p><p>once installed, run the following in the python repl shell:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-78211408899d5d0d4b1a088d039fe1d3\"></iframe><p>showing the data in the dataframe should give you the following:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-fbdeda83bfe9af7ceb33a36a3f4a29e0\"></iframe><p>as can be seen, a collection of random integers in each column for our initial testing. Let's pipe this data in to great-expectations...</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-0bf00ff1bfad316f83f1b458aa2ad01b\"></iframe><p>yields the following output...</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-83264e645d220ebb0f0a529a2a139be9\"></iframe><p>this shows that there are 0 unexpected items in the data we are testing. Great!</p><p>Now let's have a look at a negative test. Since we've picked the values at random, there are bound to be duplicates. Let's test that:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-0a75fe9700677d0329d96da44c54dca5\"></iframe><p>yields...</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-0c714a928064124ec15c9733d9e5ff29\"></iframe><p>The JSON schema has metadata information about the result, of note is the result section which is specific to our query, and shows the percentage that failed the expectation.</p><p>Let's progress to something more real-world, namely creating exceptions that are run on databases. Armed with our basic understanding of great-expectations, let's...</p><ul><li>set up a postgres database</li><li>initiate a new Data Context within great-expectations</li><li>write test-cases for the data</li><li>group those test-cases and</li><li>run it</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"setting-up-a-database\">Setting up a Database<a class=\"hash-link\" href=\"#setting-up-a-database\" title=\"Direct link to heading\">​</a></h2><iframe width=\"100%\" frameborder=\"0\" id=\"gist-30dc4a230656f36c4c9b7b208b792329\"></iframe><p>if you don't have it installed,</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-b127a57c499e63c003ac6c8bb4408768\"></iframe><p>wait 15 minutes for download the internet. Verify postgres running with&nbsp;<code>docker ps</code>, then connect with</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-d33c81448fcfddb608f79a69a75202a1\"></iframe><p>Create some data</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-13069c3111039ac60281f291dc1e6bd8\"></iframe><p>Take data for a spin</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-f62857c6dbaaaf1d784aa94c5914c9f5\"></iframe><p>should yield</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-52e11ea7319f8344674999ec1b36ab0e\"></iframe><p>Now time for&nbsp;<code>great-expectations</code></p><p>Great Expectations relies on the library&nbsp;<code>sqlalchemy</code>&nbsp;and&nbsp;<code>psycopg2</code>&nbsp;to connect to your data.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-6bd28c03b4013f4301b1af2c74dcd947\"></iframe><p>once done, let's set up&nbsp;<code>great-expectations</code></p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-4210011daa1fb3c738875f917ebafbf3\"></iframe><p>should look like below:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-1f1a698cf6a6785598db1133212f30fe\"></iframe><p>let's set up a few other goodies while we're here</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-51f684d6db8149950f28cc32afa2f461\"></iframe><p><strong>Congratulations! Great Expectations is now set up</strong></p><p>You should see a file structure as follows:</p><p><a target=\"_blank\" href=\"/assets/files/ge_tree_structure-f4723cba7eb3bfd4504919b2f45f2b8f.png\"><img loading=\"lazy\" alt=\"great expectations tree structure\" src=\"/assets/images/ge_tree_structure-f4723cba7eb3bfd4504919b2f45f2b8f.png\" width=\"643\" height=\"379\" class=\"img_ev3q\"></a></p><p>If you didn't generate a suite during the set up based on <code>app.order</code>, you can do so now with</p><p><code>great_expectations suite new</code></p><p>when created, looking at&nbsp;<code>great_expectations/expectations/app/order/warning.json</code>&nbsp;should yield the following:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-24d105be1cacacbd89b9e4cbac6f4d21\"></iframe><p>as noted in the content section, this expectation config is created by the tool by looking at 1000 rows of the data. We also have access to the data-doc site which we can open in the browser at&nbsp;<code>great_expectations/uncommitted/data_docs/local_site/index.html</code></p><p><a target=\"_blank\" href=\"/assets/files/index-page-b171b0a598aad39f638405c0a644224a.png\"><img loading=\"lazy\" alt=\"great expectations index page\" src=\"/assets/images/index-page-b171b0a598aad39f638405c0a644224a.png\" width=\"3548\" height=\"898\" class=\"img_ev3q\"></a></p><p>Clicking on&nbsp;<code>app.order.warning</code>, you'll see the sample expectation shown in the UI</p><p><a target=\"_blank\" href=\"/assets/files/ge-app.order-screen-627a827e75a8c9079908c3d78ff40ff4.png\"><img loading=\"lazy\" alt=\"great expectations app order screen\" src=\"/assets/images/ge-app.order-screen-627a827e75a8c9079908c3d78ff40ff4.png\" width=\"3394\" height=\"1842\" class=\"img_ev3q\"></a></p><p>Now, let's create our own&nbsp;<code>expectation</code>&nbsp;file and take it for a spin. We'll call this one&nbsp;<code>error</code>.</p><p><a target=\"_blank\" href=\"/assets/files/ge_suite_new-ce1fbc3a1ce68a91829faa2da0a12a9b.png\"><img loading=\"lazy\" alt=\"great expectations new suite\" src=\"/assets/images/ge_suite_new-ce1fbc3a1ce68a91829faa2da0a12a9b.png\" width=\"900\" height=\"258\" class=\"img_ev3q\"></a></p><p>This should also start a&nbsp;<code>jupyter notebook</code>. If for some reason you need to start it back up again, you can do so with</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-b4c9fed39b89d939127e4b381c49f274\"></iframe><p>Go ahead and hit&nbsp;<code>run</code>&nbsp;on your first cell.</p><p><a target=\"_blank\" href=\"/assets/files/jupyter-edit-suite-3f4a6d5cb8e7078a22430b54b9ddce83.png\"><img loading=\"lazy\" alt=\"Editing a suite with Jupyter\" src=\"/assets/images/jupyter-edit-suite-3f4a6d5cb8e7078a22430b54b9ddce83.png\" width=\"1141\" height=\"811\" class=\"img_ev3q\"></a></p><p>Let's keep it simple and test the&nbsp;<code>customer_order_id</code>&nbsp;column is in a set with the values below:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-fea43e4e566795213fc1c5bbcda317ad\"></iframe><p>using the following expectations function in your Table Expectation(s). You may need to click the&nbsp;<code>+</code>&nbsp;sign in the toolbar to insert a new cell, as below:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-38be05ccb27c21da2b4213d6a63afd83\"></iframe><p><a target=\"_blank\" href=\"/assets/files/add-table-expectation-6512aa26bc021be3ba9b53841686cc42.png\"><img loading=\"lazy\" alt=\"Adding table expectation\" src=\"/assets/images/add-table-expectation-6512aa26bc021be3ba9b53841686cc42.png\" width=\"1173\" height=\"527\" class=\"img_ev3q\"></a></p><p>As we can see, appropriate json output that describes the output of our expectation. Go ahead and run the final cell, which will save our work and open a newly minted data documentation UI page, where you'll see the expectations you defined in human readable form.</p><p><a target=\"_blank\" href=\"/assets/files/saved-suite-c6cd9523f14fe9505ebb099b946f6b11.png\"><img loading=\"lazy\" alt=\"Saved suite\" src=\"/assets/images/saved-suite-c6cd9523f14fe9505ebb099b946f6b11.png\" width=\"1836\" height=\"679\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"running-the-test-cases\">Running the test cases<a class=\"hash-link\" href=\"#running-the-test-cases\" title=\"Direct link to heading\">​</a></h2><p>In Great Expectations, running a set of expectations (test cases) is called a&nbsp;<code>checkpoint</code>. Let's create a new checkpoint called&nbsp;<code>first_checkpoint</code>&nbsp;for our&nbsp;<code>app.order.error</code>&nbsp;expectation as shown below:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-322483724633e8a4513c5d6ae67298ae\"></iframe><p>Let's take a look at our checkpoint definition.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-08594ad6420d46fe60be41d9d949605c\"></iframe><iframe width=\"100%\" frameborder=\"0\" id=\"gist-9cdd4da31f9fdef1246092fa5b65e90c\"></iframe><p>Above you can see the&nbsp;<code>validation_operator_name</code>&nbsp;which points to a definition in&nbsp;<code>great_expectations.yml</code>, and the&nbsp;<code>batches</code>&nbsp;where we defined the data source and what expectations to run against.</p><p>Let's have a look at&nbsp;<code>great_expectations.yml</code>. We can see the&nbsp;<code>action_list_operator</code>&nbsp;defined and all the actions it contains:</p><p><a target=\"_blank\" href=\"/assets/files/ge_action_list_operator-6915235227abad5c1de8f90c65c039aa.png\"><img loading=\"lazy\" alt=\"List operators\" src=\"/assets/images/ge_action_list_operator-6915235227abad5c1de8f90c65c039aa.png\" width=\"948\" height=\"317\" class=\"img_ev3q\"></a></p><p>Let's run our checkpoint using</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-050501513ee0f5fa13ab522ea7b9242e\"></iframe><p><a target=\"_blank\" href=\"/assets/files/validate-checkpoint-48062ec26f50cc84657b7accf4fe387d.png\"><img loading=\"lazy\" alt=\"Validate checkpoint\" src=\"/assets/images/validate-checkpoint-48062ec26f50cc84657b7accf4fe387d.png\" width=\"887\" height=\"117\" class=\"img_ev3q\"></a></p><p>Okay cool, we've set up an expectation, a checkpoint and shown a successful status! But what does a failure look like? We can introduce a failure by logging in to postgres and inserting a&nbsp;<code>customer_11</code>&nbsp;that we'll know will fail, as we've specific our expectation that&nbsp;<code>customer_id</code>&nbsp;should only have two values..</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-5bce4ba20ab8bfae5910db5cd6cc66f4\"></iframe><p>Here are the commands to make that happen, as well as the command to re-run our checkpoint:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-4ad6f1753d65a4f099467bd9fd760067\"></iframe><iframe width=\"100%\" frameborder=\"0\" id=\"gist-fa94ded27b212e099177bee9d6a2cd36\"></iframe><p>Run checkpoint again, this time it should fail</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-12fb3e62a5bbcd205ee84ff7445e2657\"></iframe><p><a target=\"_blank\" href=\"/assets/files/failed-checkpoint-9b060fe10a72c97ae28a0e2ea11ff76e.png\"><img loading=\"lazy\" alt=\"Failed checkpoint\" src=\"/assets/images/failed-checkpoint-9b060fe10a72c97ae28a0e2ea11ff76e.png\" width=\"883\" height=\"123\" class=\"img_ev3q\"></a></p><p><strong>As expected, it failed.</strong></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"supported-databases\">Supported Databases<a class=\"hash-link\" href=\"#supported-databases\" title=\"Direct link to heading\">​</a></h2><p>In it's current implementation&nbsp;<code>version 0.12.9</code>, the supported databases our of the box are:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-4816fb9a621d2d660f746b62ab54ba59\"></iframe><p>It's great to be BigQuery supported out of the box, but what about Google Spanner and Google BigTable? Short-answer; currently not supported. See tickets&nbsp;<a href=\"https://github.com/googleapis/google-cloud-python/issues/3022\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/googleapis/google-cloud-python/issues/3022</a>.</p><p>With respect to BigTable, it may not be possible as SQLAlchemy can only manage SQL-based RDBSM-type systems, while BigTable (and HBase) are NoSQL non-relational systems.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"scheduling\">Scheduling<a class=\"hash-link\" href=\"#scheduling\" title=\"Direct link to heading\">​</a></h2><p>Now that we have seen how to run tests on our data, we can run our checkpoints from bash or a python script(generated using great_expectations checkpoint script first_checkpoint). This lends itself to easy integration with scheduling tools like airflow, cron, prefect, etc.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"production-deployment\">Production deployment<a class=\"hash-link\" href=\"#production-deployment\" title=\"Direct link to heading\">​</a></h2><p>When deploying in production, you can store any sensitive information(credentials, validation results, etc) which are part of the uncommitted folder in cloud storage systems or databases or data stores depending on your infratructure setup. Great Expectations has a lot of options</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"when-not-to-use-a-data-quality-framework\">When not to use a data quality framework<a class=\"hash-link\" href=\"#when-not-to-use-a-data-quality-framework\" title=\"Direct link to heading\">​</a></h2><p>This tool is great and provides a lot of advanced data quality validation functions, but it adds another layer of complexity to your infrastructure that you will have to maintain and trouble shoot in case of errors. It would be wise to use it only when needed.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"in-general\">In general<a class=\"hash-link\" href=\"#in-general\" title=\"Direct link to heading\">​</a></h2><p>Do not use a data quality framework, if simple SQL based tests at post load time works for your use case. Do not use a data quality framework, if you only have a few (usually &lt; 5) simple data pipelines.</p><p>Do use it when you have data that needs to be tested in an automated and a repeatable fashion. As shown in this article, Great Expectations has a number of options that can be toggled to suit your particular use-case.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"conclusion\">Conclusion<a class=\"hash-link\" href=\"#conclusion\" title=\"Direct link to heading\">​</a></h2><p>Great Expectations shows a lot of promise, and it's an active project so expect to see features roll out frequently. It's been quite easy to use, but I'd like to see all it's features work in a locked-down enterprise environment.</p><p>Tom Klimovski<br>\n<!-- -->Principal Consultant, Gamma Data<br>\n<a href=\"mailto:tom.klimovski@gammadata.io\" target=\"_blank\" rel=\"noopener noreferrer\">tom.klimovski@gammadata.io</a></p>",
            "url": "https://fullstackchronicles.io/great-expectations-for-your-data",
            "title": "Great Expectations (for your data...)",
            "summary": "Great Expectations",
            "date_modified": "2020-11-27T00:00:00.000Z",
            "author": {
                "name": "Tom Klimovski",
                "url": "https://github.com/tomklimovskigamma"
            },
            "tags": [
                "data",
                "data-quality",
                "data-quality-management"
            ]
        },
        {
            "id": "multi-cloud-diagramming-with-plantuml",
            "content_html": "<p><img loading=\"lazy\" alt=\"Mulitcloud Diagramming\" src=\"/assets/images/multicloud-a32d180e26bba79580f5d8936b1b63dc.png\" width=\"152\" height=\"122\" class=\"img_ev3q\"></p><p>Following on from the recent post <a href=\"https://cloudywithachanceofbigdata.com/gcp-templates-for-c4-diagrams-using-plantuml/\" target=\"_blank\" rel=\"noopener noreferrer\">GCP Templates for C4 Diagrams using PlantUML</a>, cloud architects are often challenged with producing diagrams for architectures spanning multiple cloud providers, particularly as you elevate to enterprise level diagrams.</p><p>In this post, with the magic of <code>!includeurl</code> we have brought PlantUML template libraries together for AWS, Azure and GCP icon sets, allowing us to produce multi cloud C4 diagrams using PlantUML like this one:</p><p><a target=\"_blank\" href=\"/assets/files/Example-Multi-Cloud-PlantUML-C4-Diagram-8695466addda79c4432fca63824ab2eb.png\"><img loading=\"lazy\" alt=\"Multi Cloud Architecture Diagram using PlantUML\" src=\"/assets/images/Example-Multi-Cloud-PlantUML-C4-Diagram-8695466addda79c4432fca63824ab2eb.png\" width=\"1224\" height=\"760\" class=\"img_ev3q\"></a></p><p>Creating a multi cloud diagram is simple, start by adding the following <code>include</code> statements after the <code>@startuml</code> label in a new PlantUML C4 diagram:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-5319b6b041f8b8f54c922a9a5b9b6e7c\"></iframe><p>Then add references to the required services from different providers…</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-6ed55cd1b4e3b2e7027f8236af4aa112\"></iframe><p>Then include the predefined resources from your different cloud providers in your diagram as shown here (describing a client server application over a cloud to cloud VPN between Azure and GCP)...</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-600aecff7094d7843771770b7048cb2c\"></iframe><p>Happy multi-cloud diagramming!</p><blockquote><p>Full source code is available at:</p><p><a href=\"https://github.com/gamma-data/plantuml-multi-cloud-diagrams\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/gamma-data/plantuml-multi-cloud-diagrams</a></p></blockquote>",
            "url": "https://fullstackchronicles.io/multi-cloud-diagramming-with-plantuml",
            "title": "Multi Cloud Diagramming with PlantUML",
            "summary": "Mulitcloud Diagramming",
            "date_modified": "2020-10-26T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "amazonwebservices",
                "aws",
                "azure",
                "c4model",
                "diagramming",
                "gcp",
                "google-cloud-platform",
                "googlecloudplatform",
                "microsoft-azure",
                "multi-cloud",
                "plantuml",
                "software-architecture"
            ]
        },
        {
            "id": "cloud-bigtable-primer-part-ii-row-key-selection-and-schema-design",
            "content_html": "<p><img loading=\"lazy\" alt=\"Cloud BigTable\" src=\"/assets/images/cbt-featured-image-24d6cccb361d66b89ca92944ff955de9.png\" width=\"151\" height=\"121\" class=\"img_ev3q\"></p><p>This is a follow up to the original Cloud Bigtable primer where we discussed the basics of Cloud Bigtable:</p><p><a href=\"https://cloudywithachanceofbigdata.com/cloud-bigtable-primer-part-i/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Cloud Bigtable Primer - Part I</strong></a></p><p>In this article we will cover schema design and row key selection in Bigtable – arguably the most critical design decision to make when employing Bigtable in a cloud data architecture.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"quick-review\">Quick Review<a class=\"hash-link\" href=\"#quick-review\" title=\"Direct link to heading\">​</a></h2><p>Recall from the previous post where the Bigtable data model was introduced that tables in Bigtable are comprised of rows and columns - much like a table in any other RDBMS. Every row is uniquely identified by a rowkey – again akin to a primary key in a table in an RDBMS. But this is where the similarities end.</p><p>Unlike a table in an RDBMS, columns only ever exist when they are inserted, and <code>NULLs</code> are not stored. See the illustration below:</p><p><a target=\"_blank\" href=\"/assets/files/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png\"><img loading=\"lazy\" src=\"/assets/images/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png\" width=\"1024\" height=\"297\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"row-key-selection\">Row Key Selection<a class=\"hash-link\" href=\"#row-key-selection\" title=\"Direct link to heading\">​</a></h2><p>Data in Bigtable is distributed by row keys. Row keys are physically stored in tablets in lexographic order. Recall that row keys are your ONLY indexes to data in Bigtable.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"selection-considerations\">Selection Considerations<a class=\"hash-link\" href=\"#selection-considerations\" title=\"Direct link to heading\">​</a></h3><p>As row keys are your only indexes to retrieve or update rows in Bigtable, row key design must take the access patterns for the data to be stored and served via Bigtable into consideration, specifically the following must be considered when designing a Bigtable application:</p><ul><li>Search patterns (returning data for a specific entity)</li><li>Scan patterns (returning batches of data)</li></ul><p>Queries that use the row key, a row prefix, or a row range are the most efficient. Queries that do not include a row key will typically scan GB or TB of data and would not be suitable for operational use cases.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"row-key-performance\">Row Key Performance<a class=\"hash-link\" href=\"#row-key-performance\" title=\"Direct link to heading\">​</a></h3><p>Row key performance will be biased towards your specific access patterns and application functional requirements. For example if you are performing sequential reads or scan operations then sequential keys will perform the best, however their write performance will not be optimal. Conversely, random keys (such as a <code>uuid</code>) will perform best for writes but poor for scan or sequential read operations.</p><p>Adding salts to keys (or additional data), similar to the use of salts in cryptography as well as promoting other field keys to be part of a composite row key can help achieve a “Goldilocks” scenario for both reads and writes, see the diagram below:</p><p><a target=\"_blank\" href=\"/assets/files/keys-418e33748532e78f24865d6aad4c8ac4.png\"><img loading=\"lazy\" src=\"/assets/images/keys-418e33748532e78f24865d6aad4c8ac4.png\" width=\"684\" height=\"551\" class=\"img_ev3q\"></a></p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"using-reverse-timestamps\">Using Reverse Timestamps<a class=\"hash-link\" href=\"#using-reverse-timestamps\" title=\"Direct link to heading\">​</a></h3><p>Use reverse timestamps when your most common query is for the latest values. Typically you would append the reverse timestamp to the key, this will ensure that the same related records are grouped together, for instance if you are storing events for a customer using the customer id along with an appended reverse timestamp (for example <code>&lt;customer_id&gt;#&lt;reverse_ts&gt;</code>) would allow you to quickly serve the latest events for a customer in descending order as within each group (<code>customer_id</code>), rows will be sorted so most recent insert will be located at the top.<br>\n<!-- -->A reverse timestamp can be generalised as:</p><p><code>Long.MAX_VALUE - System.currentTimeMillis()</code></p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"schema-design-tips\">Schema Design Tips<a class=\"hash-link\" href=\"#schema-design-tips\" title=\"Direct link to heading\">​</a></h3><p>Some general tips for good schema design using Bigtable are summarised below:</p><ul><li>Group related data for more efficient reads using column families</li><li>Distribute data evenly for more efficient writes</li><li>Place identical values in the adjoining rows for more efficient compression using row keys</li></ul><p>Following these tips will give you the best possible performance using Bigtable.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"use-the-key-visualizer-to-profile-performance\">Use the Key Visualizer to profile performance<a class=\"hash-link\" href=\"#use-the-key-visualizer-to-profile-performance\" title=\"Direct link to heading\">​</a></h3><p>Google provides a neat tool to visualize your row key distribution in Cloud Bigtable. You need to have at least 30 GB of data in your table to enable this feature.</p><p>The Key Visualizer is shown here:</p><p><a target=\"_blank\" href=\"/assets/files/image-d2e2037eaf05cfcfebc613b7821d624d.png\"><img loading=\"lazy\" alt=\"Bigtable Key Visualizer\" src=\"/assets/images/image-d2e2037eaf05cfcfebc613b7821d624d.png\" width=\"733\" height=\"403\" class=\"img_ev3q\"></a></p><p>The Key Visualizer will help you find and prevent hotspots, find rows with too much data and show if your key schema is balanced.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"summary\">Summary<a class=\"hash-link\" href=\"#summary\" title=\"Direct link to heading\">​</a></h3><p>Bigtable is one of the original and best (massively) distributed NoSQL platforms available. Schema and moreover row key design play a massive part in ensuring low latency and query performance. Go forth and conquer with Cloud Bigtable!</p>",
            "url": "https://fullstackchronicles.io/cloud-bigtable-primer-part-ii-row-key-selection-and-schema-design",
            "title": "Cloud Bigtable Primer Part II – Row Key Selection and Schema Design",
            "summary": "Cloud BigTable",
            "date_modified": "2020-09-13T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "bigtable",
                "cloud-bigtable",
                "gcp",
                "google-cloud-platform",
                "googlecloudplatform",
                "nosql"
            ]
        },
        {
            "id": "gcp-templates-for-c4-diagrams-using-plantuml",
            "content_html": "<p><img loading=\"lazy\" alt=\"GCP C4 Diagramming\" src=\"/assets/images/gcp-c4-2dfa642388856ec47d841196e16f1e0f.png\" width=\"150\" height=\"120\" class=\"img_ev3q\"></p><p>I am a believer in the mantra of <em><strong>“Everything-as-Code”</strong></em>, this includes diagrams and other architectural artefacts. Enter PlantUML…</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"plantuml\">PlantUML<a class=\"hash-link\" href=\"#plantuml\" title=\"Direct link to heading\">​</a></h2><p><a href=\"https://plantuml.com/\" target=\"_blank\" rel=\"noopener noreferrer\">PlantUML</a> is an open-source tool which allows users to create UML diagrams from an intuitive DSL (Domain Specific Language). PlantUML is built on top of Graphviz and enables software architects and designers to use code to create Sequence Diagrams, Use Case Diagrams, Class Diagrams, State and Activity Diagrams and much more.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"c4-diagrams\">C4 Diagrams<a class=\"hash-link\" href=\"#c4-diagrams\" title=\"Direct link to heading\">​</a></h2><p>PlantUML can be extended to support the <a href=\"https://c4model.com/\" target=\"_blank\" rel=\"noopener noreferrer\">C4 model</a> for visualising software architecture. Which describes software in different layers including Context, Container, Component and Code diagrams.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"gcp-architecture-diagramming-using-c4\">GCP Architecture Diagramming using C4<a class=\"hash-link\" href=\"#gcp-architecture-diagramming-using-c4\" title=\"Direct link to heading\">​</a></h2><p>PlantUML and C4 can be used to produce cloud architectures, there are official libraries available through PlantUML for Azure and AWS service icons, however these do not exist for GCP yet. There are several open source libraries available, however I have made an attempt to simplify the implementation.</p><p>The code below can be used to generate a C4 diagram describing a GCP architecture including official GCP service icons:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@startuml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!define GCPPuml https://raw.githubusercontent.com/gamma-data/GCP-C4-PlantUML/master/templates</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/C4\\_Context.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/C4\\_Component.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/C4\\_Container.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/GCPC4Integration.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/GCPCommon.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/Networking/CloudDNS.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/Networking/CloudLoadBalancing.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/Compute/ComputeEngine.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/Storage/CloudStorage.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/Databases/CloudSQL.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">title Sample C4 Diagram with GCP Icons</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Person(publisher, \"Publisher\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">System\\_Ext(device, \"User\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Boundary(gcp,\"gcp-project\") {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  CloudDNS(dns, \"Managed Zone\", \"Cloud DNS\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  CloudLoadBalancing(lb, \"L7 Load Balancer\", \"Cloud Load Balancing\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  CloudStorage(bucket, \"Static Content Bucket\", \"Cloud Storage\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  Boundary(region, \"gcp-region\") {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    Boundary(zonea, \"zone a\") {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      ComputeEngine(gcea, \"Content Server\", \"Compute Engine\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      CloudSQL(csqla, \"Dynamic Content\", \"Cloud SQL\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    Boundary(zoneb, \"zone b\") {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      ComputeEngine(gceb, \"Content Server\", \"Compute Engine\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      CloudSQL(csqlb, \"Dynamic Content\\\\n(Read Replica)\", \"Cloud SQL\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(device, dns, \"resolves name\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(device, lb, \"makes request\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(lb, gcea, \"routes request\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(lb, gceb, \"routes request\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(gcea, bucket, \"get static content\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(gceb, bucket, \"get static content\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(gcea, csqla, \"get dynamic content\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(gceb, csqla, \"get dynamic content\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(csqla, csqlb, \"replication\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Rel(publisher,bucket,\"publish static content\")</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">@enduml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>The preceding code generates the diagram below:</p><p><a target=\"_blank\" href=\"/assets/files/Sample-C4-Diagram-with-GCP-Icons-291a0d7d898c0130b13e980e6752ec79.png\"><img loading=\"lazy\" src=\"/assets/images/Sample-C4-Diagram-with-GCP-Icons-291a0d7d898c0130b13e980e6752ec79.png\" width=\"662\" height=\"1437\" class=\"img_ev3q\"></a></p><p>Additional services can be added and used in your diagrams by adding them to your includes, such as:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/DataAnalytics/BigQuery.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/DataAnalytics/CloudDataflow.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/AIandMachineLearning/AIHub.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/AIandMachineLearning/CloudAutoML.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/DeveloperTools/CloudBuild.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/HybridandMultiCloud/Stackdriver.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/InternetofThings/CloudIoTCore.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/Migration/TransferAppliance.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">!includeurl GCPPuml/Security/CloudIAM.puml</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">' and more…</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><blockquote><p>The complete template library is available at:</p><p><a href=\"https://github.com/gamma-data/GCP-C4-PlantUML\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/gamma-data/GCP-C4-PlantUML</a></p></blockquote>",
            "url": "https://fullstackchronicles.io/gcp-templates-for-c4-diagrams-using-plantuml",
            "title": "GCP Templates for C4 Diagrams using PlantUML",
            "summary": "GCP C4 Diagramming",
            "date_modified": "2020-08-14T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "c4model",
                "diagramming",
                "gcp",
                "google-cloud-platform",
                "googlecloudplatform",
                "plantuml",
                "software-architecture"
            ]
        },
        {
            "id": "cloud-bigtable-primer-part-i",
            "content_html": "<p><img loading=\"lazy\" alt=\"Cloud BigTable\" src=\"/assets/images/cbt-featured-image-24d6cccb361d66b89ca92944ff955de9.png\" width=\"151\" height=\"121\" class=\"img_ev3q\"></p><p>Bigtable is one of the foundational services in the Google Cloud Platform and to this day one of the greatest contributions to the big data ecosystem at large. It is also one of the least known services available, with all the headlines and attention going to more widely used services such as BigQuery.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"background\">Background<a class=\"hash-link\" href=\"#background\" title=\"Direct link to heading\">​</a></h2><p>In 2006 (pre Google Cloud Platform), Google released a white paper called <em><strong>“Bigtable: A Distributed Storage System for Structured Data”</strong></em>, this paper set out the reference architecture for what was to become Cloud Bigtable. This followed several other whitepapers including the GoogleFS and MapReduce whitepapers released in 2003 and 2004 which provided abstract reference architectures for the Google File System (now known as <strong><em>Colossus</em></strong>) and the MapReduce algorithm. These whitepapers inspired a generation of open source distributed processing systems including Hadoop. Google has long had a pattern of publicising a generalized overview of their approach to solving different storage and processing challenges at scale through white papers.</p><p><a target=\"_blank\" href=\"/assets/files/bigtable-osdi06-16d141802d2310614e01534fb1c82a11.pdf\"><img loading=\"lazy\" alt=\"Bigtable Whitepaper 2006\" src=\"/assets/images/bigtable-whitepaper-09803ad0c30b5dc4fa560e006ce33021.png\" width=\"699\" height=\"903\" class=\"img_ev3q\"></a></p><p>The Bigtable white paper inspired a wave of open source distributed key/value oriented NoSQL data stores including Apache HBase and Apache Cassandra.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"what-is-bigtable\">What is Bigtable?<a class=\"hash-link\" href=\"#what-is-bigtable\" title=\"Direct link to heading\">​</a></h2><p>Bigtable is a distributed, petabyte scale NoSQL database. More specifically, Bigtable is…</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"a-map\">a map<a class=\"hash-link\" href=\"#a-map\" title=\"Direct link to heading\">​</a></h3><p>At its core Bigtable is a distributed map or an associative array indexed by a row key, with values in columns which are created only when they are referenced. Each value is an uninterpreted byte array.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"sorted\">sorted<a class=\"hash-link\" href=\"#sorted\" title=\"Direct link to heading\">​</a></h3><p>Row keys are stored in lexographic order akin to a clustered index in a relational database.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"sparse\">sparse<a class=\"hash-link\" href=\"#sparse\" title=\"Direct link to heading\">​</a></h3><p>A given row can have any number of columns, not all columns must have values and NULLs are not stored. There may also be gaps between keys.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"multi-dimensional\">multi-dimensional<a class=\"hash-link\" href=\"#multi-dimensional\" title=\"Direct link to heading\">​</a></h3><p>All values are versioned with a timestamp (or configurable integer). Data is not updated in place, it is instead superseded with another version.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"when-and-when-not-to-use-bigtable\">When (and when not) to use Bigtable<a class=\"hash-link\" href=\"#when-and-when-not-to-use-bigtable\" title=\"Direct link to heading\">​</a></h2><ul><li>You need to do many thousands of operations per second on TB+ scale data</li><li>Your access patterns are well known and simple</li><li>You need to support random write or random read operations (or sequential reads) - each using a row key as the primary identifier</li></ul><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"dont-use-bigtable-if\">Don’t use Bigtable if…<a class=\"hash-link\" href=\"#dont-use-bigtable-if\" title=\"Direct link to heading\">​</a></h3><ul><li>You need explicit JOIN capability, that is joining one or more tables</li><li>You need to do ad-hoc analytics</li><li>Your access patterns are unknown or not well defined</li></ul><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"bigtable-vs-relational-database-systems\">Bigtable vs Relational Database Systems<a class=\"hash-link\" href=\"#bigtable-vs-relational-database-systems\" title=\"Direct link to heading\">​</a></h3><p>The following table compares and contrasts Bigtable against relational databases (both transaction oriented and analytic oriented databases):</p><table><thead><tr><th>&nbsp;</th><th>Bigtable</th><th>RDBMS (OLTP)</th><th>RDBMS (DSS/MPP)</th></tr></thead><tbody><tr><td>Data Layout</td><td>Column Family Oriented</td><td>Row Oriented</td><td>Column Oriented</td></tr><tr><td>Transaction Support</td><td>Single Row Only</td><td>Yes</td><td>Depends (but usually no)</td></tr><tr><td>Query DSL</td><td>get/put/scan/delete</td><td>SQL</td><td>SQL</td></tr><tr><td>Indexes</td><td>Row Key Only</td><td>Yes</td><td>Yes (typically PI based)</td></tr><tr><td>Max Data Size</td><td>PB+</td><td>'00s GB  to TB</td><td>TB+</td></tr><tr><td>Read/Write Throughput</td><td>\"'000</td><td>000s queries/s\"</td><td>'000s queries/s</td></tr></tbody></table><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"bigtable-data-model\">Bigtable Data Model<a class=\"hash-link\" href=\"#bigtable-data-model\" title=\"Direct link to heading\">​</a></h2><p><strong><em>Tables</em></strong> in Bigtable are comprised of rows and columns (sounds familiar so far..). Every row is uniquely identified by a <strong><em>rowkey</em></strong> (like a primary key..again sounds familiar so far).</p><p><strong><em>Columns</em></strong> belong to <strong><em>Column Families</em></strong> and only exist when inserted, NULLs are not stored - this is where it starts to differ from a traditional RDBMS. The following image demonstrates the data model for a fictitious table in Bigtable.</p><p><a target=\"_blank\" href=\"/assets/files/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png\"><img loading=\"lazy\" alt=\"Bigtable Data Model\" src=\"/assets/images/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png\" width=\"1024\" height=\"297\" class=\"img_ev3q\"></a></p><p>In the previous example, we created two Column Families (<strong><em>cf1</em></strong> and <strong><em>cf2</em></strong>). These are created during table definition or update operations (akin to DDL operations in the relational world). In this case, we have chosen to store primary attributes, like name, etc in cf1 and features (or derived attributes) in cf2 like indicators.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"cell-versioning\">Cell versioning<a class=\"hash-link\" href=\"#cell-versioning\" title=\"Direct link to heading\">​</a></h3><p>Each cell has a timestamp/version associated with it, multiple versions of a row can exist. Versions are naturally stored in descending order.</p><p>Properties such as the max age for a cell or the maximum number of versions to be stored for any given cell are set on the Column Family. Versions are compacted through a process called <strong><em>Garbage Collection</em></strong> - not to be confused with Java Garbage Collection (albeit same idea).</p><table><thead><tr><th>Row Key</th><th>Column</th><th>Value</th><th>Timestamp</th></tr></thead><tbody><tr><td>123</td><td>cf1:status</td><td>ACTIVE</td><td>2020-06-30T08.58.27.560</td></tr><tr><td>123</td><td>cf1:status</td><td>PENDING</td><td>2020-06-28T06.20.18.330</td></tr><tr><td>123</td><td>cf1:status</td><td>INACTIVE</td><td>2020-06-27T07.59.20.460</td></tr></tbody></table><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"bigtable-instances-clusters-nodes-and-tables\">Bigtable Instances, Clusters, Nodes and Tables<a class=\"hash-link\" href=\"#bigtable-instances-clusters-nodes-and-tables\" title=\"Direct link to heading\">​</a></h2><p>Bigtable is a \"no-ops\" service, meaning you do not need to configure machine types or details about the underlying infrastructure, save a few sizing or performance options - such as the number of nodes in a cluster or whether to use solid state hard drives (SSD) or the magnetic alternative (HDD). The following diagram shows the relationships and cardinality for Cloud Bigtable.</p><p><a target=\"_blank\" href=\"/assets/files/bigtable-instances-and-nodes-b2d9e98ce7a8bf66600d284bafb5d3a9.png\"><img loading=\"lazy\" alt=\"Bigtable Instances, Clusters and Nodes\" src=\"/assets/images/bigtable-instances-and-nodes-b2d9e98ce7a8bf66600d284bafb5d3a9.png\" width=\"964\" height=\"487\" class=\"img_ev3q\"></a></p><p><strong><em>Clusters</em></strong> and <strong><em>nodes</em></strong> are the physical compute layer for Bigtable, these are zonal assets, zonal and regional availability can be achieved through replication which we will discuss later in this article.</p><p><strong><em>Instances</em></strong> are a virtual abstraction for clusters, Tables belong to instances (not clusters). This is due to Bigtables underlying architecture which is based upon a separation of storage and compute as shown below.</p><p><a target=\"_blank\" href=\"/assets/files/bigtable-storage-and-compute-b0c9a76792b16e425ee5d623d4339368.png\"><img loading=\"lazy\" alt=\"Bigtable Separation of Storage and Compute\" src=\"/assets/images/bigtable-storage-and-compute-b0c9a76792b16e425ee5d623d4339368.png\" width=\"472\" height=\"482\" class=\"img_ev3q\"></a></p><p>Bigtables separation of storage and compute allow it to scale horizontally, as nodes are stateless they can be increased to increase query performance. The underlying storage system in inherently scalable.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"physical-storage--column-families\">Physical Storage &amp; Column Families<a class=\"hash-link\" href=\"#physical-storage--column-families\" title=\"Direct link to heading\">​</a></h3><p>Data (Columns) for Bigtable is stored in <strong><em>Tablets</em></strong> (as shown in the previous diagram), which store \"regions\" of row keys for a particular Column Family. Columns consist of a column family prefix and qualifier, for instance:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">cf1:col1</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>A table can have one or more Column Families. Column families must be declared at schema definition time (could be a create or alter operation). A cell is an intersection of a row key and a version of a column within a column family.</p><p>Storage settings (such as the compaction/garbage collection properties mentioned before) can be specified for each Column Family - which can differ from other column families in the same table.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"bigtable-availability-and-replication\">Bigtable Availability and Replication<a class=\"hash-link\" href=\"#bigtable-availability-and-replication\" title=\"Direct link to heading\">​</a></h3><p><strong><em>Replication</em></strong> is used to increase availability and durability for Cloud Bigtable – this can also be used to segregate read and write operations for the same table.</p><p>Data and changes to tables are replicated across multiple regions or multiple zones within the same region, this replication can be blocking (single row transactions) or non blocking (eventually consistent). However all clusters within a Bigtable instance are considered primary (writable).</p><p>Requests are routed using <strong><em>Application Profiles</em></strong>, a <strong><em>single-cluster routing</em></strong> policy can be used for manual failover, whereas a <strong><em>multi-cluster routing</em></strong> is used for automatic failover.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"backup-and-export-options-for-bigtable\">Backup and Export Options for Bigtable<a class=\"hash-link\" href=\"#backup-and-export-options-for-bigtable\" title=\"Direct link to heading\">​</a></h3><p>Managed backups can be taken at a table level, new tables can be created from backups. The backups cannot be exported, however table level export and import operations are available via pre-baked Dataflow templates for data stored in GCS in the following formats:</p><ul><li>SequenceFiles</li><li>Avro Files</li><li>Parquet Files</li><li>CSV Files</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"accessing-bigtable\">Accessing Bigtable<a class=\"hash-link\" href=\"#accessing-bigtable\" title=\"Direct link to heading\">​</a></h2><p>Bigtable data and admin functions are available via:</p><ul><li><code>cbt</code> (optional component of the Google SDK)</li><li><code>hbase shell</code> (REPL shell)</li><li>Happybase API (Python API for Hbase)</li><li>SDK libraries for:<ul><li>Golang</li><li>Python</li><li>Java</li><li>Node.js</li><li>Ruby</li><li>C#, C++, PHP, and more</li></ul></li></ul><p>As Bigtable is not a cheap service, there is a local emulator available which is great for application development. This is part of the Cloud SDK, and can be started using the following command:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud beta emulators bigtable start</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>In the next article in this series we will demonstrate admin and data functions as well as the local emulator.</p><blockquote><p>Next Up : Part II - Row Key Selection and Schema Design in Bigtable</p></blockquote>",
            "url": "https://fullstackchronicles.io/cloud-bigtable-primer-part-i",
            "title": "Cloud Bigtable Primer - Part I",
            "summary": "Cloud BigTable",
            "date_modified": "2020-08-04T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "bigtable",
                "cloud-bigtable",
                "gcp",
                "google-cloud-platform",
                "googlecloudplatform",
                "nosql"
            ]
        },
        {
            "id": "automated-gcs-object-scanning-using-dlp-with-notifications-using-slack",
            "content_html": "<p><img loading=\"lazy\" alt=\"Slack GCS DLP\" src=\"/assets/images/Slack-GCS-DLP-Image-e1591007165488-a1e3004dff60d0f7309e0ddab0804e7f.png\" width=\"150\" height=\"144\" class=\"img_ev3q\"></p><p>This is a follow up to a previous blog, <a href=\"https://cloudywithachanceofbigdata.com/google-cloud-storage-object-notifications-using-slack/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Google Cloud Storage Object Notifications using Slack</strong></a> in which we used Slack to notify us of new objects being uploaded to GCS.</p><p>In this article we will take things a step further, where uploading an object to a GCS bucket will trigger a DLP inspection of the object and if any preconfigured info types (such as credit card numbers or API credentials) are present in the object, a Slack notification will be generated.</p><p>As DLP scans are “jobs”, meaning they run asynchronously, we will need to trigger scans and inspect results using two separate Cloud Functions (one for triggering a scan <!-- -->[<code>gcs-dlp-scan-trigger</code>]<!-- --> and one for inspecting the results of the scan <!-- -->[<code>gcs-dlp-evaluate-results</code>]<!-- -->) and a Cloud PubSub topic <!-- -->[<code>dlp-scan-topic</code>]<!-- --> which is used to hold the reference to the DLP job.</p><p>The process is described using the sequence diagram below:</p><p><a target=\"_blank\" href=\"/assets/files/dlp-notifications-using-slack-d58f8548ccf305103d24c181be50ecda.png\"><img loading=\"lazy\" src=\"/assets/images/dlp-notifications-using-slack-d58f8548ccf305103d24c181be50ecda.png\" width=\"1584\" height=\"597\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-code\">The Code<a class=\"hash-link\" href=\"#the-code\" title=\"Direct link to heading\">​</a></h2><p>The <code>gcs-dlp-scan-trigger</code> Cloud Function fires when a new object is created in a specified GCS bucket. This function configures the DLP scan to be executed, including the DLP info types (for instance <code>CREDIT_CARD_NUMBER</code>, <code>EMAIL_ADDRESS</code>, <code>ETHNIC_GROUP</code>, <code>PHONE_NUMBER</code>, etc) a and likelihood of that info type existing (for instance <code>LIKELY</code>). DLP scans determine the probability of an info type occurring in the data, they do not scan every object in its entirety as this would be too expensive.</p><p>The primary function executed in the <code>gcs-dlp-scan-trigger</code> Cloud Function is named <code>inspect_gcs_file</code>. This function configures and submits the DLP job, supplying a PubSub topic to which the DLP Job Name will be written, the code for the <code>inspect_gcs_file</code> is shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-913a4457f43bc7b80e4405dd01f7b64d\"></iframe><p>At this stage the DLP job is created an running asynchronously, the next Cloud Function, <code>gcs-dlp-evaluate-results</code>, fires when a message is sent to the PubSub topic defined in the DLP job. The <code>gcs-dlp-evaluate-results</code> reads the DLP Job Name from the PubSub topic, connects to the DLP service and queries the job status, when the job is complete, this function checks the results of the scan, if the <code>min_likliehood</code> threshold is met for any of the specified info types, a Slack message is generated. The code for the main method in the <code>gcs-dlp-evaluate-results</code> function is shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-ab377f6c3e448ae7c623d057239e05ed\"></iframe><p>Finally, a Slack webhook is used to send the message to a specified Slack channel in a workspace, this is done using the <code>send_slack_notification</code> function shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-15d9e7c0922c26b680bed81abfcbadff\"></iframe><p>An example Slack message is shown here:</p><p><a target=\"_blank\" href=\"/assets/files/gcs-dlp-results-slack-notification-b8be26df34031f7e12c152c85781f4b4.png\"><img loading=\"lazy\" alt=\"Slack Notification for Sensitive Data Detected in a Newly Created GCS Object\" src=\"/assets/images/gcs-dlp-results-slack-notification-b8be26df34031f7e12c152c85781f4b4.png\" width=\"934\" height=\"324\" class=\"img_ev3q\"></a></p><blockquote><p>Full source code can be found at: <a href=\"https://github.com/gamma-data/automated-gcs-object-scanning-using-dlp-with-notifications-using-slack\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/gamma-data/automated-gcs-object-scanning-using-dlp-with-notifications-using-slack</a></p></blockquote>",
            "url": "https://fullstackchronicles.io/automated-gcs-object-scanning-using-dlp-with-notifications-using-slack",
            "title": "Automated GCS Object Scanning Using DLP with Notifications Using Slack",
            "summary": "Slack GCS DLP",
            "date_modified": "2020-06-01T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "cloud-dlp",
                "cloud-functions",
                "cloud-storage",
                "dlp",
                "gcp",
                "gcs",
                "google-cloud-platform",
                "googlecloudplatform",
                "python",
                "slack",
                "terraform"
            ]
        },
        {
            "id": "json-wrangling-with-go",
            "content_html": "<p><img loading=\"lazy\" alt=\"JSON Golang\" src=\"data:image/png;base64,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\" width=\"214\" height=\"92\" class=\"img_ev3q\"></p><p>Golang is a fantastic language but at first glance it is a bit clumsy when it comes to JSON in contrast to other languages such as Python or Javascript. Having said that once you master the concepts involved with JSON wrangling using Go it is equally as functional – with added type safety and performance.</p><p>In this article we will build a program in Golang to parse a JSON file containing a collection held in a named key – without knowing the structure of this object, we will expose the schema for the object including data types and recurse the object for its values.</p><p>This example uses a great Go package called <code>tablewriter</code> to render the output of these operations using a table style result set.</p><p>The program has <code>describe</code> and <code>select</code> verbs as operation types; describe shows the column names in the collection and their respective data types, select prints the keys and values as a tabular result set with column headers for the keys and rows containing their corresponding values.</p><p>Starting with this:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-cceeb5b667ccfe8a9e20437d3f1dde42\"></iframe><p>We will end up with this when performing a <code>describe</code> operation:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-fbd04c220a70d439df3a14d4a4f48a3e\"></iframe><p>And this when performing a <code>select</code> operation:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-0b795b13b160cfbcd6796243c0fbb238\"></iframe><p>Now let’s talk about how we got there…</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-json-package\">The JSON package<a class=\"hash-link\" href=\"#the-json-package\" title=\"Direct link to heading\">​</a></h2><p>Support for JSON in Go is provided using the <code>encoding/json</code> package, this needs to be imported in your program of course… You will also need to import the <code>reflect</code> package – more on this later. <code>io/ioutil</code> is required to read the data from a file input, there are other packages included in the program that are removed for brevity:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-def7e02eac07ded8b80ff807cf023989\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"reading-the-data\">Reading the data…<a class=\"hash-link\" href=\"#reading-the-data\" title=\"Direct link to heading\">​</a></h2><p>We will read the data from the JSON file into a variable called <code>body</code>, note that we are not attempting to deserialize the data at this point. This is also a good opportunity to handle any runtime or IO errors that occur here as well.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-74a2c2c839a30ed8cc66d83d3ddde3b4\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-interface\">The interface…<a class=\"hash-link\" href=\"#the-interface\" title=\"Direct link to heading\">​</a></h2><p>We will declare an empty interface called <code>data</code> which will be used to decode the json object (of which the structure is not known), we will also create an abstract interface called <code>colldata</code> to hold the contents of the collection contained inside the JSON object that we are specifically looking for:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-32555f65af4be1fc2504f2d11e15aa19\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"validating\">Validating…<a class=\"hash-link\" href=\"#validating\" title=\"Direct link to heading\">​</a></h2><p>Next we need to validate that the input is a valid JSON object, we can use the <code>json.Valid(body)</code> method to do this:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-c7afe41fcca4ba1e3ed009044cea76de\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"unmarshalling\">Unmarshalling…<a class=\"hash-link\" href=\"#unmarshalling\" title=\"Direct link to heading\">​</a></h2><p>Now the interesting bits, we will deserialize the JSON object to the empty data interface we created earlier using the <code>json.Unmarshal()</code> method:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-2579ec79be915fb89e91ea0977bfbff6\"></iframe><p>Note that this operation is another opportunity to catch unexpected errors and handle them accordingly.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"checking-the-type-of-the-object-using-reflection\">Checking the type of the object using reflection…<a class=\"hash-link\" href=\"#checking-the-type-of-the-object-using-reflection\" title=\"Direct link to heading\">​</a></h2><p>Now that we have serialized the JSON object into the data interface, there are several ways we can inspect the type of the object (which could be a map or an array). One such way is to use reflection. Reflection is the ability of a program to inspect itself at runtime. An example is shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-1ccd077de0fdee8973e25ac79719cbf5\"></iframe><p>This instruction would produce the following output for our <code>zones.json</code> file:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-04c1b3ae79e969e4be32ef7fa1c07736\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-type-switch\">The type switch…<a class=\"hash-link\" href=\"#the-type-switch\" title=\"Direct link to heading\">​</a></h2><p>Another method to decode the type of the data object (and any objects nested as elements or keys within the data object), is to use the type switch, an example of a type switch function is shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-2e7a3d62ec6f7c71a9c01bfa8d360e4e\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"finding-the-nested-collection-and-recursing-it\">Finding the nested collection and recursing it…<a class=\"hash-link\" href=\"#finding-the-nested-collection-and-recursing-it\" title=\"Direct link to heading\">​</a></h2><p>The aim of the program is to find a collection (an array of maps) nested in a JSON object. The maps with each element of the array are unknown at runtime and are discovered through recursion.</p><p>If we are performing a describe operation, we only need to parse the first element of the collection to get the key names and the data type of the values (for which we will use the same <code>getObjectType</code> function to perform a type switch.</p><p>If we are performing a select operation, we need to parse the first element to get the column names (the keys in the map) and then we need to recurse each element to get the values for each key.</p><p>If the element contains a key named id or name, we will place this at the beginning of the resultant record, as maps are unordered by definition.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-output\">The output…<a class=\"hash-link\" href=\"#the-output\" title=\"Direct link to heading\">​</a></h2><p>As mentioned, we are using the <code>tablewriter</code> package to render the output of the collection as a pretty printed table in our terminal. As wrap around can get pretty ugly an additional <code>maxfieldlen</code> argument is provided to truncate the values if needed.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"in-summary\">In summary…<a class=\"hash-link\" href=\"#in-summary\" title=\"Direct link to heading\">​</a></h2><p>Although it is a bit more involved than some other languages, once you get your head around processing JSON in Go, the possibilities are endless!</p><blockquote><p>Full source code can be found at: <a href=\"https://github.com/gamma-data/json-wrangling-with-golang\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/gamma-data/json-wrangling-with-golang</a></p></blockquote>",
            "url": "https://fullstackchronicles.io/json-wrangling-with-go",
            "title": "JSON Wrangling with Go",
            "summary": "JSON Golang",
            "date_modified": "2020-04-22T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "golang",
                "json"
            ]
        },
        {
            "id": "forseti-terraform-validator-enforcing-resource-policy-compliance-in-your-ci-pipeline",
            "content_html": "<p><img loading=\"lazy\" alt=\"Forseti Terraform\" src=\"/assets/images/Forseti-Terraform-e1587291818418-f9a051569d3bcc250fa9d5e5b379ae4f.png\" width=\"213\" height=\"218\" class=\"img_ev3q\"></p><p>Terraform is a powerful tool for managing your Infrastructure as Code. Declare your resources once, define their variables per environment and sleep easy knowing your CI pipeline will take care of the rest.</p><p>But… one night you wake up in a sweat. The details are fuzzy but you were browsing your favourite cloud provider’s console - probably GCP ;) - and thought you saw a bucket had been created outside of your allowed locations! Maybe it even had risky access controls.</p><p>You go brush it off and try to fall back to sleep, but you can’t quite push the thought from your mind that somewhere in all that Terraform code, someone <em>could</em> be declaring resources in unapproved locations, and your CICD pipeline would do nothing to stop it. Oh the regulatory implications.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"enter-terraform-validator-by-forseti\">Enter Terraform Validator by Forseti<a class=\"hash-link\" href=\"#enter-terraform-validator-by-forseti\" title=\"Direct link to heading\">​</a></h2><p>Terraform Validator by Forseti allows you to declare your Policy as Code, check compliance of your Terraform plans against said Policy, and automatically fail violating plans in a CI step. All without setting up servers or agents.</p><p>You’re going to learn how to enforce policy on GCP resources like BigQuery, IAM, networks, MySQL, Google Kubernetes Engine (GKE) and more. If you’re particularly crafty, you may be able to go beyond GCP.</p><p>Forseti’s suite of solutions are GCP focused and allow a wide range of live config validation, monitoring and more using the Policy Library we’re going to set up. These additional capabilities require additional infrastructure. But we’re going one step at a time, starting with enforcing policy during deployment.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"getting-started\">Getting Started<a class=\"hash-link\" href=\"#getting-started\" title=\"Direct link to heading\">​</a></h2><p>Let’s assume you already have an established CICD pipeline that uses Terraform, or that you are content to validate your Terraform plans locally for now. In that case, we need just two things:</p><ol><li>A Policy Library</li><li>Terraform Validator</li></ol><p>It’s that simple! No new servers, agents, firewall rules, extra service accounts or other nonsense. Just add Policy Library, the Validator tool and you can enforce policy on your Terraform deployments.</p><p>We’re going to tinker with some existing GCP-focused sample policies (aka Constraints) that Forseti makes available. These samples cover a wide range of resources and use cases, so it is easy to adjust what’s provided to define your own Constraints.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"policy-library\">Policy Library<a class=\"hash-link\" href=\"#policy-library\" title=\"Direct link to heading\">​</a></h2><p>First let's open up some of Forseti's pre-defined constraints. We’ll copy them into our own Git repository and adjust to create policies that match our needs. Repeatable and configurable - that’s Policy as Code at work.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"concepts\">Concepts<a class=\"hash-link\" href=\"#concepts\" title=\"Direct link to heading\">​</a></h3><p>In the world of Forseti and in particular Terraform Validator, Policies are defined and understood via easy to read YAML files known as Constraints</p><p>There is just enough information in a Constraint file for to make clear its purpose and effect, and by tinkering lightly with a pre-written Constraint you can achieve a lot without looking too deeply into the inner workings . But there’s more happening than meets the eye.</p><p>Constraints are built on Templates - which are like forms with some extra bits waiting to be completed to make a Constraint. Except there’s a lot more hidden away that’s pretty cool if you want to understand it.</p><p>Think of a Template as a ‘Class’ in the OOP sense, and of a Constraint as an instantiated Template with all the key attributes defined.</p><p>E.g. A generic Template for policy on bucket locations and a Constraint to specify which locations are relevant in a given instance. Again, buckets and locations are just the basic example - the potential applications are far greater.</p><p>Now the real magic is that just like a ‘Class’, a Template contains logic that makes everything abstracted away in the Constraint possible. Templates contain inline Rego (ray-go), borrowed lovingly by Forseti from the Open Policy Agent (OPA) team.</p><p>Learn more about Rego and OPA <a href=\"https://www.openpolicyagent.org/docs/latest/policy-language/\" target=\"_blank\" rel=\"noopener noreferrer\">here</a> to understand the relationship to our Terraform Validator.</p><p>But let’s begin.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"set-up-your-policies\">Set up your Policies<a class=\"hash-link\" href=\"#set-up-your-policies\" title=\"Direct link to heading\">​</a></h3><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-your-policy-library-repository\">Create your Policy Library repository<a class=\"hash-link\" href=\"#create-your-policy-library-repository\" title=\"Direct link to heading\">​</a></h4><p>Create your Policy Library repository by cloning <a href=\"https://github.com/forseti-security/policy-library\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/forseti-security/policy-library</a> into your own VCS.</p><p>This repo contains templates and sample constraints which will form the basis of your policies. So get it into your Git environment and clone it to local for the next step.</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"customise-sample-constraints-to-fit-your-needs\">Customise sample constraints to fit your needs<a class=\"hash-link\" href=\"#customise-sample-constraints-to-fit-your-needs\" title=\"Direct link to heading\">​</a></h4><p>As discussed in Concepts, Constraints are defined Templates, which make use of Rego policy language. Nice. So let’s take a sample Constraint, put it in our Policy Library and set the values to what we need. It’s that easy - no need to write new templates or learn Rego if your use case is covered.</p><p>In a new branch…</p><ol><li>Copy the sample Constraint <code>storage_location.yaml</code> to your Constraints folder.  </li></ol><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ </span><span class=\"token function\" style=\"color:#d73a49\">cp</span><span class=\"token plain\"> policy-library/samples/storage_location.yaml policy-library/policies/constraints/storage_location.yaml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><ol start=\"2\"><li>Replace the sample location (<code>asia-southeast1</code>) in <code>storage_location.yaml</code> with <code>australia-southeast1</code>.  </li></ol><div class=\"language-yaml codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-yaml codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  </span><span class=\"token key atrule\" style=\"color:#00a4db\">spec</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">severity</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> high  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">match</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token key atrule\" style=\"color:#00a4db\">target</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token string\" style=\"color:#e3116c\">\"organization/*\"</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    </span><span class=\"token key atrule\" style=\"color:#00a4db\">parameters</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token key atrule\" style=\"color:#00a4db\">mode</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token string\" style=\"color:#e3116c\">\"allowlist\"</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token key atrule\" style=\"color:#00a4db\">locations</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\">  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\"> australia</span><span class=\"token punctuation\" style=\"color:#393A34\">-</span><span class=\"token plain\">southeast1  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">      </span><span class=\"token key atrule\" style=\"color:#00a4db\">exemptions</span><span class=\"token punctuation\" style=\"color:#393A34\">:</span><span class=\"token plain\"> </span><span class=\"token punctuation\" style=\"color:#393A34\">[</span><span class=\"token punctuation\" style=\"color:#393A34\">]</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><ol start=\"3\"><li>Push back to your repo - not Forseti’s!  </li></ol><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ </span><span class=\"token function\" style=\"color:#d73a49\">git</span><span class=\"token plain\"> push https://github.com/</span><span class=\"token operator\" style=\"color:#393A34\">&lt;</span><span class=\"token plain\">your-repository</span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\">/policy-library.git</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"policy-review\">Policy review<a class=\"hash-link\" href=\"#policy-review\" title=\"Direct link to heading\">​</a></h4><p>There you go - you’ve customised a sample Constraint. Now you have your own instance of version controlled Policy-as-Code and are ready to apply the power of OPA’s Rego policy language that lies within the parent Template. Impressively easy right?</p><p>That’s a pretty simple example. You can browse the rest of Forseti’s Policy Library to view other sample Constraints, Templates and the Rego logic that makes all of this work. These can be adjusted to cover all kinds of use cases across GCP resources.</p><p>I suggest working with and editing the <a href=\"https://github.com/forseti-security/policy-library/tree/master/samples\" target=\"_blank\" rel=\"noopener noreferrer\">sample Constraints</a> before making any changes to Templates.</p><p>If you were to write Rego and Templates from scratch, you might even be able to enforce Policy as Code against non-GCP Terraform code.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"terraform-validator\">Terraform Validator<a class=\"hash-link\" href=\"#terraform-validator\" title=\"Direct link to heading\">​</a></h2><p>Now, let’s set up the Terraform Validator tool and have it compare a sample piece of Terraform code against the Constraint we configured above. Keep in mind you’ll want to translate what’s done here into steps in your CICD pipeline.</p><p>Once the tool is in place, we really just run <code>terraform plan</code> and feed the output into Terraform Validator. The Validator compares it to our Constraints, runs all the abstracted logic we don’t need to worry about and returns 0 or 2 when done for pass / fail respectively. Easy.</p><p>So using Terraform if I try to make a bucket in <code>australia-southeast1</code> it should pass, if I try to make one in the US it should fail. Let’s set up the tool, write some basic Terraform and see how we go.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"setup-terraform-validator\">Setup Terraform Validator<a class=\"hash-link\" href=\"#setup-terraform-validator\" title=\"Direct link to heading\">​</a></h3><p>Check for the latest version of <code>terraform-validator</code> from the official terraform-validator GCS bucket.</p><p>Very important when using tf version 0.12 or greater. This is the easy way - you can pull from the <a href=\"https://github.com/GoogleCloudPlatform/terraform-validator\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform Validator Github</a> and make it yourself too.</p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gsutil </span><span class=\"token function\" style=\"color:#d73a49\">ls</span><span class=\"token plain\"> -r gs://terraform-validator/releases</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Copy the latest version to the working dir</p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ gsutil </span><span class=\"token function\" style=\"color:#d73a49\">cp</span><span class=\"token plain\"> gs://terraform-validator/releases/2020-03-05/terraform-validator-linux-amd64 </span><span class=\"token builtin class-name\">.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Make it executable</p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ </span><span class=\"token function\" style=\"color:#d73a49\">chmod</span><span class=\"token plain\"> </span><span class=\"token number\" style=\"color:#36acaa\">755</span><span class=\"token plain\"> terraform-validator-linux-amd64</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Ready to go!</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"review-your-terraform-code\">Review your Terraform code<a class=\"hash-link\" href=\"#review-your-terraform-code\" title=\"Direct link to heading\">​</a></h3><p>We’re going to make a ridiculously simple piece of Terraform that tries to create one bucket in our project to keep things simple.</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># main.tf</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">resource \"google_storage_bucket\" \"tf-validator-demo-bucket\" {&nbsp;&nbsp;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  name&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = \"tf-validator-demo-bucket\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">&nbsp;&nbsp;location&nbsp; &nbsp; &nbsp; = \"US\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">&nbsp;&nbsp;force_destroy = true</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">&nbsp;&nbsp;lifecycle_rule {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">&nbsp;&nbsp;&nbsp;&nbsp;condition {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;age = \"3\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">&nbsp;&nbsp;&nbsp;&nbsp;}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">&nbsp;&nbsp;&nbsp;&nbsp;action {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type = \"Delete\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">&nbsp;&nbsp;&nbsp;&nbsp;}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">&nbsp;&nbsp;}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>This is a pretty standard bit of Terraform for a GCS bucket, but made very simple with all the values defined directly in <code>main.tf</code>. Note the location of the bucket - it violates our Constraint that was set to the <code>australia-southeast1</code> region.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"make-the-terraform-plan\">Make the Terraform plan<a class=\"hash-link\" href=\"#make-the-terraform-plan\" title=\"Direct link to heading\">​</a></h3><p>Warm up Terraform.<br>\n<!-- -->Double check your Terraform code if there are any hiccups.</p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ terraform init</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Make the Terraform plan and store output to file.</p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ terraform plan --out</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\">terraform.tfplan</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Convert the plan to JSON</p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ terraform show -json ./terraform.tfplan </span><span class=\"token operator\" style=\"color:#393A34\">&gt;</span><span class=\"token plain\"> ./terraform.tfplan.json</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"validate-the-non-compliant-terraform-plan-against-your-constraints-for-example\">Validate the non-compliant Terraform plan against your Constraints, for example<a class=\"hash-link\" href=\"#validate-the-non-compliant-terraform-plan-against-your-constraints-for-example\" title=\"Direct link to heading\">​</a></h3><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ./terraform-validator-linux-amd64 validate ./tfplan.tfplan.json --policy-path</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token punctuation\" style=\"color:#393A34\">..</span><span class=\"token plain\">/repos/policy-library/</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>TA-DA!</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Found Violations:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Constraint allow_some_storage_location on resource //storage.googleapis.com/tf-validator-demo-bucket: //storage.googleapis.com/tf-validator-demo-bucket is in a disallowed location.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"validate-the-compliant-terraform-plan-against-your-constraints\">Validate the compliant Terraform plan against your Constraints<a class=\"hash-link\" href=\"#validate-the-compliant-terraform-plan-against-your-constraints\" title=\"Direct link to heading\">​</a></h3><p>Let’s see what happens if we repeat the above, changing the location of our GCS bucket to <code>australia-southeast1</code>.</p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ ./terraform-validator-linux-amd64 validate ./tfplan.tfplan.json --policy-path</span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token punctuation\" style=\"color:#393A34\">..</span><span class=\"token plain\">/repos/policy-library/</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Results in..</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">No violations found.</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Success!!!</p><p>Now all that’s left to do for your Policy as Code CICD pipeline is to configure the rest of your Constraints and run this check before you go ahead and <code>terraform apply</code>. Be sure to make the <code>apply</code> step dependent on the outcome of the Validator.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"wrap-up\">Wrap Up<a class=\"hash-link\" href=\"#wrap-up\" title=\"Direct link to heading\">​</a></h2><p>We’ve looked at how to apply Policy as Code to validate our Infrastructure as Code. Sounds pretty modern and DevOpsy doesn’t it.</p><p>To recap, we learned about Constraints, which are fully defined instances of Policy as Code. They’re based on YAML Templates that refer to the OPA policy language Rego, but we didn’t have to learn it :)</p><p>We created our own version controlled Policy Library.</p><p>Using the above learning and some handy pre-existing samples, we wrote policies (Constraints) for GCP infrastructure, specifying a whitelist for locations in which GCS buckets could be deployed.</p><p>As mentioned there are <a href=\"https://github.com/forseti-security/policy-library/tree/master/samples\" target=\"_blank\" rel=\"noopener noreferrer\">dozens upon dozens of samples</a> across BigQuery, IAM, networks, MySQL, Google Kubernetes Engine (GKE) and more to work with.</p><p>Of course, we stored these configured Constraints in our version-controlled Policy Library.</p><ul><li>We looked at a simple set of Terraform code to define a GCS bucket, and stored the Terraform plan to a file before applying it.</li><li>We ran Forseti’s Terraform Validator against the Terraform plan file, and had the Validator compare the plan to our Policy Library.</li><li>We saw that the results matched our expectations! Compliance with the location specified in our Constraint passed the Validator’s checks, and non-compliance triggered a violation.</li></ul><p>Awesome. And the best part is that all this required no special permissions, no infrastructure for servers or agents and no networking.</p><p>All of that comes with the full Forseti suite of Inventory taking Config Validation of already deployed resources. We might get to that next time.</p><p>References:</p><p><a href=\"https://github.com/GoogleCloudPlatform/terraform-validator\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/GoogleCloudPlatform/terraform-validator</a> <a href=\"https://github.com/forseti-security/policy-library\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/forseti-security/policy-library</a> <a href=\"https://www.openpolicyagent.org/docs/latest/policy-language/\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.openpolicyagent.org/docs/latest/policy-language/</a> <a href=\"https://cloud.google.com/blog/products/identity-security/using-forseti-config-validator-with-terraform-validator\" target=\"_blank\" rel=\"noopener noreferrer\">https://cloud.google.com/blog/products/identity-security/using-forseti-config-validator-with-terraform-validator</a> <a href=\"https://forsetisecurity.org/docs/latest/concepts/\" target=\"_blank\" rel=\"noopener noreferrer\">https://forsetisecurity.org/docs/latest/concepts/</a></p>",
            "url": "https://fullstackchronicles.io/forseti-terraform-validator-enforcing-resource-policy-compliance-in-your-ci-pipeline",
            "title": "Forseti Terraform Validator: Enforcing resource policy compliance in your CI pipeline",
            "summary": "Forseti Terraform",
            "date_modified": "2020-04-18T00:00:00.000Z",
            "author": {
                "name": "Daniel Hussey",
                "url": "https://www.linkedin.com/in/daniel-hussey/"
            },
            "tags": [
                "devops",
                "forseti",
                "gcp",
                "google-cloud-platform",
                "googlecloudplatform",
                "policyascode",
                "terraform"
            ]
        },
        {
            "id": "creating-a-site-to-site-vpn-connection-between-gcp-and-azure-with-google-private-access",
            "content_html": "<p>This article demonstrates creating a site to site IPSEC VPN connection between a GCP VPC network and an Azure Virtual Network, enabling private RFC1918 network connectivity between virtual networks in both clouds. This is done using a single PowerShell script leveraging Azure PowerShell and gcloud commands in the Google SDK.</p><p>Additionally, we will use Azure Private DNS to enable private access between Azure hosts and GCP APIs (such as Cloud Storage or Big Query).</p><p>An overview of the solution is provided here:</p><p><a target=\"_blank\" href=\"/assets/files/gcp-to-azure-vpn-design-f59e466042c5e6fdf12abc497dde73bd.png\"><img loading=\"lazy\" alt=\"Azure to GCP VPN Design\" src=\"/assets/images/gcp-to-azure-vpn-design-f59e466042c5e6fdf12abc497dde73bd.png\" width=\"3572\" height=\"2407\" class=\"img_ev3q\"></a></p><p>One note before starting - site to site VPN connections between GCP and Azure currently do not support dynamic routing using BGP, however creating some simple routes on either end of the connection will be enough to get going.</p><p>Let’s go through this step by step:</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-1--authenticate-to-azure\">Step 1 : Authenticate to Azure<a class=\"hash-link\" href=\"#step-1--authenticate-to-azure\" title=\"Direct link to heading\">​</a></h2><p>Azure’s account equivalent is a subscription, the following command from Azure Powershell is used to authenticate a user to one or more subscriptions.</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">Connect-AzAccount</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>This command will open a browser window prompting you for Microsoft credentials, once authenticated you will be returned to the command line.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-2--create-a-resource-group-azure\">Step 2 : Create a Resource Group (Azure)<a class=\"hash-link\" href=\"#step-2--create-a-resource-group-azure\" title=\"Direct link to heading\">​</a></h2><p>A resource group is roughly equivalent to a project in GCP. You will need to supply a Location (equivalent to a GCP region):</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">New-AzResourceGroup `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Location \"Australia Southeast\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-3--create-a-virtual-network-with-subnets-and-routes-azure\">Step 3 : Create a Virtual Network with Subnets and Routes (Azure)<a class=\"hash-link\" href=\"#step-3--create-a-virtual-network-with-subnets-and-routes-azure\" title=\"Direct link to heading\">​</a></h2><p>An Azure Virtual Network is the equivalent of a VPC network in GCP (or AWS), you must define subnets before creating a Virtual Network. In this example we will create two subnets, one Gateway subnet (which needs to be named accordingly) where the VPN gateway will reside, and one subnet named ‘default’ where we will host VMs which will connect to GCP services over the private VPN connection.</p><p>Before defining the default subnet we must create and attach a Route Table (equivalent of a Route in GCP), this particular route will be used to route ‘private’ requests to services in GCP (such as Big Query).</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># define route table and route to GCP private access</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$azroutecfg = New-AzRouteConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"google-private\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -AddressPrefix \"199.36.153.4/30\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -NextHopType \"VirtualNetworkGateway\" </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$azrttbl = New-AzRouteTable `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"google-private\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Location \"Australia Southeast\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Route $azroutecfg</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># define gateway subnet</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$gatewaySubnet = New-AzVirtualNetworkSubnetConfig  `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"GatewaySubnet\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -AddressPrefix \"10.1.2.0/24\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># define default subnet</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$defaultSubnet  = New-AzVirtualNetworkSubnetConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"default\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -AddressPrefix \"10.1.1.0/24\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -RouteTable $azrttbl</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create virtual network and subnets</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$vnet = New-AzVirtualNetwork  `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"azure-to-gcp-vnet\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Location \"Australia Southeast\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -AddressPrefix \"10.1.0.0/16\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Subnet $gatewaySubnet,$defaultSubnet</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-4--create-network-security-groups-azure\">Step 4 : Create Network Security Groups (Azure)<a class=\"hash-link\" href=\"#step-4--create-network-security-groups-azure\" title=\"Direct link to heading\">​</a></h2><p>Network Security Groups in Azure are stateful firewalls much like Firewall Rules in VPC networks in GCP. Like GCP, the lower priority overrides higher priority rules.</p><p>In the example we will create several rules to allow inbound ICMP, TCP and UDP traffic from our Google VPC and RDP traffic from the Internet (which we will use to logon to a VM in Azure to test private connectivity between the two clouds):</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create network security group</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$rule1 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name rdp-rule `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Description \"Allow RDP\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Access Allow `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Protocol Tcp `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Direction Inbound `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Priority 100 `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -SourceAddressPrefix Internet `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -SourcePortRange * `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -DestinationAddressPrefix * `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -DestinationPortRange 3389</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$rule2 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name icmp-rule `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Description \"Allow ICMP\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Access Allow `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Protocol Icmp `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Direction Inbound `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Priority 101 `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -SourceAddressPrefix * `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -SourcePortRange * `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -DestinationAddressPrefix * `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -DestinationPortRange *</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$rule3 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name gcp-rule `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Description \"Allow GCP\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Access Allow `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Protocol Tcp `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Direction Inbound `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Priority 102 `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -SourceAddressPrefix \"10.2.0.0/16\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -SourcePortRange * `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -DestinationAddressPrefix * `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -DestinationPortRange *</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$nsg = New-AzNetworkSecurityGroup `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Location \"Australia Southeast\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"nsg-vm\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -SecurityRules $rule1,$rule2,$rule3</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-5--create-public-ip-addresses-azure\">Step 5 : Create Public IP Addresses (Azure)<a class=\"hash-link\" href=\"#step-5--create-public-ip-addresses-azure\" title=\"Direct link to heading\">​</a></h2><p>We need to create two Public IP Address (equivalent of an External IP in GCP) which will be used for our VPN gateway and for the VM we will create:</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create public IP address for VM</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$vmpip = New-AzPublicIpAddress `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"vm-ip\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Location \"Australia Southeast\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -AllocationMethod Dynamic</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create public IP address for NW gateway </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ngwpip = New-AzPublicIpAddress `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"ngw-ip\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Location \"Australia Southeast\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -AllocationMethod Dynamic</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-6--create-virtual-network-gateway-azure\">Step 6 : Create Virtual Network Gateway (Azure)<a class=\"hash-link\" href=\"#step-6--create-virtual-network-gateway-azure\" title=\"Direct link to heading\">​</a></h2><p>The Virtual Network Gateway in Azure is the VPN Gateway equivalent in Azure which will be used to create a VPN tunnel between Azure and a GCP VPN Gateway. This gateway will be placed in the Gateway subnet created previously and one of the Public IP addresses created in the previous step will be assigned to this gateway.</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create virtual network gateway</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ngwipconfig = New-AzVirtualNetworkGatewayIpConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"ngw-ipconfig\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -SubnetId $gatewaySubnet.Id `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -PublicIpAddressId $ngwpip.Id</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># use the AsJob switch as this is a long running process</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$job = New-AzVirtualNetworkGateway -Name \"vnet-gateway\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Location \"Australia Southeast\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -IpConfigurations $ngwipconfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -GatewayType \"Vpn\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -VpnType \"RouteBased\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -GatewaySku \"VpnGw1\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -VpnGatewayGeneration \"Generation1\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -AsJob</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$vnetgw = Get-AzVirtualNetworkGateway `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"vnet-gateway\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-7--create-a-vpc-network-and-subnetworks-gcp\">Step 7 : Create a VPC Network and Subnetwork(s) (GCP)<a class=\"hash-link\" href=\"#step-7--create-a-vpc-network-and-subnetworks-gcp\" title=\"Direct link to heading\">​</a></h2><p>A VPC network and subnet need to be created in GCP, the subnet defines the VPC address space. This address space must not overlap with the Azure Virtual Network CIDR. For all GCP steps it is assumed that the project is set for client config (e.g. gcloud config set project <strong>your_project</strong>) so it does not need to be specified for each operation. Private Google access should be enabled on all subnets created.</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># creating VPC network and subnets</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute networks create \"azure-to-gcp-vpc\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --subnet-mode=custom `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --bgp-routing-mode=regional</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute networks subnets create \"aus-subnet\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --network  \"azure-to-gcp-vpc\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --range \"10.2.1.0/24\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --region \"australia-southeast1\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --enable-private-ip-google-access</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-8--create-an-external-ip-gcp\">Step 8 : Create an External IP (GCP)<a class=\"hash-link\" href=\"#step-8--create-an-external-ip-gcp\" title=\"Direct link to heading\">​</a></h2><p>An external IP address will need to be created in GCP which will be used for the external facing interface of the VPN Gateway.</p><div class=\"language-bash codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-bash codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token comment\" style=\"color:#999988;font-style:italic\"># create external IP</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute addresses create </span><span class=\"token string\" style=\"color:#e3116c\">\"ext-gw-ip\"</span><span class=\"token plain\"> </span><span class=\"token variable\" style=\"color:#36acaa\">`</span><span class=\"token variable\" style=\"color:#36acaa\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token variable\" style=\"color:#36acaa\">  --region </span><span class=\"token variable string\" style=\"color:#e3116c\">\"australia-southeast1\"</span><span class=\"token variable\" style=\"color:#36acaa\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token variable\" style=\"display:inline-block;color:#36acaa\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token variable\" style=\"color:#36acaa\">$gcp_ipaddr_obj </span><span class=\"token variable operator\" style=\"color:#393A34\">=</span><span class=\"token variable\" style=\"color:#36acaa\"> gcloud compute addresses describe </span><span class=\"token variable string\" style=\"color:#e3116c\">\"ext-gw-ip\"</span><span class=\"token variable\" style=\"color:#36acaa\"> </span><span class=\"token variable\" style=\"color:#36acaa\">`</span><span class=\"token plain\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --region </span><span class=\"token string\" style=\"color:#e3116c\">\"australia-southeast1\"</span><span class=\"token plain\"> `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --format json </span><span class=\"token operator\" style=\"color:#393A34\">|</span><span class=\"token plain\"> ConvertFrom-Json</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"></span><span class=\"token variable\" style=\"color:#36acaa\">$gcp_ipaddr</span><span class=\"token plain\"> </span><span class=\"token operator\" style=\"color:#393A34\">=</span><span class=\"token plain\"> </span><span class=\"token variable\" style=\"color:#36acaa\">$gcp_ipaddr_obj</span><span class=\"token plain\">.address</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-9--create-firewall-rules-gcp\">Step 9 : Create Firewall Rules (GCP)<a class=\"hash-link\" href=\"#step-9--create-firewall-rules-gcp\" title=\"Direct link to heading\">​</a></h2><p>VPC firewall rules will need to be created in GCP to allow VPN traffic as well as SSH traffic from the internet (which allows you to SSH into VM instances using Cloud Shell).</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create VPN firewall rules</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute firewall-rules create \"vpn-rule1\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --network \"azure-to-gcp-vpc\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --allow tcp,udp,icmp `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --source-ranges \"10.1.0.0/16\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute firewall-rules create \"ssh-rule1\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --network \"azure-to-gcp-vpc\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --allow tcp:22</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-10--create-vpn-gateway-and-forwarding-rules-gcp\">Step 10 : Create VPN Gateway and Forwarding Rules (GCP)<a class=\"hash-link\" href=\"#step-10--create-vpn-gateway-and-forwarding-rules-gcp\" title=\"Direct link to heading\">​</a></h2><p>Create a VPN Gateway and Forwarding Rules in GCP which will be used to create a tunnel between GCP and Azure.</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create cloud VPN </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute target-vpn-gateways create \"vpn-gw\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --network \"azure-to-gcp-vpc\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --region \"australia-southeast1\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --project \"azure-to-gcp-project\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create forwarding rule ESP</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute forwarding-rules create \"fr-gw-name-esp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --ip-protocol ESP `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --address \"ext-gw-ip\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --target-vpn-gateway \"vpn-gw\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --region \"australia-southeast1\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --project \"azure-to-gcp-project\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># creating forwarding rule UDP500</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute forwarding-rules create \"fr-gw-name-udp500\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --ip-protocol UDP `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --ports 500 `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --address \"ext-gw-ip\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --target-vpn-gateway \"vpn-gw\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --region \"australia-southeast1\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --project \"azure-to-gcp-project\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># creating forwarding rule UDP4500</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute forwarding-rules create \"fr-gw-name-udp4500\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --ip-protocol UDP `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --ports 4500 `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --address \"ext-gw-ip\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --target-vpn-gateway \"vpn-gw\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --region \"australia-southeast1\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --project \"azure-to-gcp-project\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-10--create-vpn-tunnel-gcp-side\">Step 10 : Create VPN Tunnel (GCP Side)<a class=\"hash-link\" href=\"#step-10--create-vpn-tunnel-gcp-side\" title=\"Direct link to heading\">​</a></h2><p>Now we will create the GCP side of our VPN tunnel using the Public IP Address of the Azure Virtual Network Gateway created in a previous step. As this example uses a route based VPN the traffic selector values need to be set at 0.0.0.0/0. A PSK (Pre Shared Key) needs to be supplied which will be the same key used when we configure a VPN Connection on the Azure side of the tunnel.</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># get peer public IP address of Azure gateway</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$azpubip = Get-AzPublicIpAddress `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"ngw-ip\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create VPN tunnel </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute vpn-tunnels create \"vpn-tunnel-to-azure\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --peer-address $azpubip.IpAddress `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --local-traffic-selector \"0.0.0.0/0\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --remote-traffic-selector \"0.0.0.0/0\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --ike-version 2 `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --shared-secret &lt;&lt; Pre-Shared Key &gt;&gt; `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --target-vpn-gateway \"vpn-gw\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --region  \"australia-southeast1\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --project \"azure-to-gcp-project\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-11--create-static-routes-gcp-side\">Step 11 : Create Static Routes (GCP Side)<a class=\"hash-link\" href=\"#step-11--create-static-routes-gcp-side\" title=\"Direct link to heading\">​</a></h2><p>As we are using static routing (as opposed to dynamic routing) we will need to define all of the specific routes on the GCP side. We will need to setup routes for both outgoing traffic to the Azure network as well as incoming traffic for the restricted Google API range (199.36.153.4/30).</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create static route (VPN)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute routes create \"route-to-azure\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --destination-range \"10.1.0.0/16\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --next-hop-vpn-tunnel \"vpn-tunnel-to-azure\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --network \"azure-to-gcp-vpc\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --next-hop-vpn-tunnel-region \"australia-southeast1\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --project \"azure-to-gcp-project\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create static route (Restricted APIs)</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute routes create apis `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --network  \"azure-to-gcp-vpc\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --destination-range \"199.36.153.4/30\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --next-hop-gateway default-internet-gateway `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --project \"azure-to-gcp-project\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-12--create-a-local-gateway-azure\">Step 12 : Create a Local Gateway (Azure)<a class=\"hash-link\" href=\"#step-12--create-a-local-gateway-azure\" title=\"Direct link to heading\">​</a></h2><p>A Local Gateway in Azure is an object that represents the remote gateway (GCP VPN gateway).</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create local gateway</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$azlocalgw = New-AzLocalNetworkGateway `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"local-gateway\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Location \"Australia Southeast\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -GatewayIpAddress $gcp_ipaddr `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -AddressPrefix \"10.2.0.0/16\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-13--create-a-vpn-connection-azure\">Step 13 : Create a VPN Connection (Azure)<a class=\"hash-link\" href=\"#step-13--create-a-vpn-connection-azure\" title=\"Direct link to heading\">​</a></h2><p>Now we can setup the Azure side of the VPN Connection which is accomplished by associating the Azure Virtual Network Gateway with the Local Network Gateway. A PSK (Pre Shared Key) needs to be supplied which is the same key used for the GCP VPN Tunnel in step 10.</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create connection</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$azvpnconn = New-AzVirtualNetworkGatewayConnection `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"vpn-connection\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -VirtualNetworkGateway1 $vnetgw `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -LocalNetworkGateway2 $azlocalgw `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Location \"Australia Southeast\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ConnectionType IPsec `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -SharedKey  &lt;&lt; Pre-Shared Key &gt;&gt;  `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ConnectionProtocol \"IKEv2\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>VPN Tunnel Established!</p><p>At this stage we have created an end to end connection between the virtual networks in both clouds. You should see this reflected in the respective consoles in each provider.</p><figure><a href=\"/assets/images/gcp-vpn-to-azure-d627caa8febd797b530e1471bd5c9aff.png\"><img src=\"/assets/images/gcp-vpn-to-azure-d627caa8febd797b530e1471bd5c9aff.png\" alt=\"GCP VPN Tunnel to a Azure Virtual Network\"></a><figcaption class=\"figure-caption\">GCP VPN Tunnel to a Azure Virtual Network</figcaption></figure><figure><a href=\"/assets/images/azure-vpn-to-gcp-4716124e93f2cbc8a7e5ef5cd98d23df.png\"><img src=\"/assets/images/azure-vpn-to-gcp-4716124e93f2cbc8a7e5ef5cd98d23df.png\" alt=\"Azure VPN Connection to a GCP VPC Network\"></a><figcaption class=\"figure-caption\">Azure VPN Connection to a GCP VPC Network</figcaption></figure><p>Congratulations! You have just setup a multi cloud environment using private networking. Now let’s setup Google Private Access for Azure hosts and create VMs on each side to test our setup.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-14--create-a-private-dns-zone-for-googleapiscom-azure\">Step 14 : Create a Private DNS Zone for googleapis.com (Azure)<a class=\"hash-link\" href=\"#step-14--create-a-private-dns-zone-for-googleapiscom-azure\" title=\"Direct link to heading\">​</a></h2><p>We will now need to create a Private DNS zone in Azure for the googleapis.com domain which will host records to redirect Google API requests to the Restricted API range.</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create private DNS zone</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">New-AzPrivateDnsZone `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"googleapis.com\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># Add A Records   </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$Records = @()</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -IPv4Address 199.36.153.4</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -IPv4Address 199.36.153.5</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -IPv4Address 199.36.153.6</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -IPv4Address 199.36.153.7</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">New-AzPrivateDnsRecordSet `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"restricted\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -RecordType A `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -TTL 300 `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ZoneName \"googleapis.com\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -PrivateDnsRecords $Records</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># Add CNAME Records   </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$Records = @()</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Cname \"restricted.googleapis.com.\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">New-AzPrivateDnsRecordSet `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"*\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -RecordType CNAME `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -TTL 300 `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ZoneName \"googleapis.com\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -PrivateDnsRecords $Records</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># Create VNet Link</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">New-AzPrivateDnsVirtualNetworkLink `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ZoneName \"googleapis.com\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"dns-zone-link\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -VirtualNetworkId $vnet.Id</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-15--create-a-virtual-machine-azure\">Step 15 : Create a Virtual Machine (Azure)<a class=\"hash-link\" href=\"#step-15--create-a-virtual-machine-azure\" title=\"Direct link to heading\">​</a></h2><p>We will create a VM in Azure which we can use to test the VPN tunnel as well as to test Private Google Access over our VPN tunnel.</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create VM</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$az_vmlocaladminpwd = ConvertTo-SecureString &lt;&lt; Password Param &gt;&gt; `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -AsPlainText -Force</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$Credential = New-Object System.Management.Automation.PSCredential  (\"LocalAdminUser\", $az_vmlocaladminpwd);</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$nic = New-AzNetworkInterface `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Name \"vm-nic\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Location \"Australia Southeast\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -SubnetId $defaultSubnet.Id `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -NetworkSecurityGroupId $nsg.Id `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -PublicIpAddressId $vmpip.Id `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -EnableAcceleratedNetworking `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Force</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$VirtualMachine = New-AzVMConfig `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -VMName \"windows-desktop\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -VMSize \"Standard_D4_v3\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$VirtualMachine = Set-AzVMOperatingSystem `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -VM $VirtualMachine `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Windows `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ComputerName  \"windows-desktop\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Credential $Credential `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ProvisionVMAgent `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -EnableAutoUpdate</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$VirtualMachine = Add-AzVMNetworkInterface `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -VM $VirtualMachine `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Id $nic.Id</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$VirtualMachine = Set-AzVMSourceImage `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -VM $VirtualMachine `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -PublisherName 'MicrosoftWindowsDesktop' `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Offer 'Windows-10' `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Skus 'rs5-pro' `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Version latest</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">New-AzVM `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -ResourceGroupName \"azure-to-gcp\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Location \"Australia Southeast\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -VM $VirtualMachine `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  -Verbose</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-16--create-a-vm-instance-gcp\">Step 16 : Create a VM Instance (GCP)<a class=\"hash-link\" href=\"#step-16--create-a-vm-instance-gcp\" title=\"Direct link to heading\">​</a></h2><p>We will create a Linux VM in GCP to test connectivity to hosts in Azure using the VPN tunnel we have established.</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># create VM instance</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud compute instances create \"gcp-instance\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --zone \"australia-southeast1-b\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --machine-type \"f1-micro\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --subnet \"aus-subnet\" `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --network-tier PREMIUM `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --maintenance-policy MIGRATE `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --image=debian-9-stretch-v20200309 `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --image-project=debian-cloud `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --boot-disk-size 10GB `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --boot-disk-type pd-standard `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --boot-disk-device-name instance-1 `</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --reservation-affinity any</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"test-connectivity\">Test Connectivity<a class=\"hash-link\" href=\"#test-connectivity\" title=\"Direct link to heading\">​</a></h2><p>Now we are ready to test connectivity from both sides of the tunnel.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"azure-to-gcp\">Azure to GCP<a class=\"hash-link\" href=\"#azure-to-gcp\" title=\"Direct link to heading\">​</a></h3><p>Establish a remote desktop (RDP) connection to the Azure VM created in Step 15. Ping the GCP VM instance using its private IP address.</p><p><a target=\"_blank\" href=\"/assets/files/azure-ping-to-gcp-14a9b0e446b7c868ffa27ba3435460be.png\"><img loading=\"lazy\" alt=\"Test Private IP Connectivity from Azure to GCP\" src=\"/assets/images/azure-ping-to-gcp-14a9b0e446b7c868ffa27ba3435460be.png\" width=\"1635\" height=\"967\" class=\"img_ev3q\"></a></p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"gcp-to-azure\">GCP to Azure<a class=\"hash-link\" href=\"#gcp-to-azure\" title=\"Direct link to heading\">​</a></h3><p>Now SSH into the GCP Linux VM instance and ping the Azure host using its private IP address.</p><p><a target=\"_blank\" href=\"/assets/files/gcp-ping-to-azure-94b9a33840b54870af540853cda825e9.png\"><img loading=\"lazy\" alt=\"Test Private IP Connectivity from GCP to Azure\" src=\"/assets/images/gcp-ping-to-azure-94b9a33840b54870af540853cda825e9.png\" width=\"902\" height=\"710\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"test-private-google-access-from-azure\">Test Private Google Access from Azure<a class=\"hash-link\" href=\"#test-private-google-access-from-azure\" title=\"Direct link to heading\">​</a></h2><p>Now that we have established bi-directional connectivity between the two clouds, we can test private access to Google APIs from our Azure host. Follow the steps below to test private access:</p><ol><li>RDP into the Azure VM</li><li>Install the Google Cloud SDK ( <a href=\"https://cloud.google.com/sdk/\" target=\"_blank\" rel=\"noopener noreferrer\">https://cloud.google.com/sdk/</a>)</li><li>Perform an <code>nslookup</code> to ensure that calls to googleapis.com resolve to the restricted API range (e.g. <code>nslookup storage.googleapis.com</code>). You should see a response showing the A records from the googleapis.com Private DNS Zone created in step 14.</li><li>Now test connectivity to Google APIs, for example to test access to Google Cloud Storage using <code>gsutil</code>, or test access to Big Query using the <code>bq</code> command</li></ol><p>Congratulations! You are now a multi cloud ninja!</p>",
            "url": "https://fullstackchronicles.io/creating-a-site-to-site-vpn-connection-between-gcp-and-azure-with-google-private-access",
            "title": "Creating a Site to Site VPN Connection Between GCP and Azure with Google Private Access",
            "summary": "This article demonstrates creating a site to site IPSEC VPN connection between a GCP VPC network and an Azure Virtual Network, enabling private RFC1918 network connectivity between virtual networks in both clouds. This is done using a single PowerShell script leveraging Azure PowerShell and gcloud commands in the Google SDK.",
            "date_modified": "2020-03-27T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "azure",
                "gcp",
                "google-cloud-platform",
                "googlecloudplatform",
                "hybrid-cloud",
                "microsoft",
                "microsoft-azure",
                "multi-cloud",
                "private-networking",
                "vpn"
            ]
        },
        {
            "id": "spark-in-the-google-cloud-platform-part-2",
            "content_html": "<p><img loading=\"lazy\" alt=\"Apache Spark in GCP\" src=\"/assets/images/spark-gcp-featured-image-86e0bfd36db759253fff66591b594d8b.png\" width=\"213\" height=\"155\" class=\"img_ev3q\"></p><p>In the previous post in this series <a href=\"https://cloudywithachanceofbigdata.com/spark-in-the-google-cloud-platform-part-1/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Spark in the Google Cloud Platform Part 1</strong></a>, we started to explore the various ways in which we could deploy Apache Spark applications in GCP. The first option we looked at was deploying Spark using Cloud DataProc, a managed Hadoop cluster with various ecosystem components included.</p><div class=\"theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z\"></path></svg></span>Spark Training Courses</div><div class=\"admonitionContent_S0QG\"><p><a href=\"https://academy.alphazetta.ai/data-transformation-and-analysis-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Data Transformation and Analysis Using Apache Spark</a><br>\n<a href=\"https://academy.alphazetta.ai/stream-and-event-processing-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Stream and Event Processing using Apache Spark</a><br>\n<a href=\"https://academy.alphazetta.ai/advanced-analytics-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Advanced Analytics Using Apache Spark</a></p></div></div><p>In this post, we will look at another option for deploying Spark in GCP – <em>a Spark Standalone cluster running on GKE</em>.</p><p>Spark Standalone refers to the in-built cluster manager provided with each Spark release. Standalone can be a bit of a misnomer as it sounds like a single instance – which it is not, standalone simply refers to the fact that it is not dependent upon any other projects or components – such as Apache YARN, Mesos, etc.</p><p>A Spark Standalone cluster consists of a Master node or instance and one of more Worker nodes. The Master node serves as both a master and a cluster manager in the Spark runtime architecture.</p><p>The Master process is responsible for marshalling resource requests on behalf of applications and monitoring cluster resources.</p><p>The Worker nodes host one or many Executor instances which are responsible for carrying out tasks.</p><p>Deploying a Spark Standalone cluster on GKE is reasonably straightforward. In the example provided in this post we will set up a private network (VPC), create a GKE cluster, and deploy a Spark Master pod and two Spark Worker pods (in a real scenario you would typically have many Worker pods).</p><p>Once the network and GKE cluster have been deployed, the first step is to create Docker images for both the Master and Workers.</p><p>The <code>Dockerfile</code> below can be used to create an image capable or running either the Worker or Master daemons:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-a2828409021205b3f6587c824c59928d\"></iframe><p>Note the shell scripts included in the <code>Dockerfile</code>: <code>spark-master</code> and <code>spark-worker</code>. These will be used later on by K8S deployments to start the relative Master and Worker daemon processes in each of the pods.</p><p>Next, we will use Cloud Build to build an image using the <code>Dockerfile</code> are store this in GCR (Google Container Registry), from the Cloud Build directory in our project we will run:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud builds submit --tag gcr.io/spark-demo-266309/spark-standalone</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Next, we will create Kubernetes deployments for our Master and Worker pods.</p><p>Firstly, we need to get cluster credentials for our GKE cluster named ‘spark-cluster’:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud container clusters get-credentials spark-cluster --zone australia-southeast1-a --project spark-demo-266309</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Now from within the <code>k8s-deployments\\deploy</code> folder of our project we will use the <code>kubectl</code> command to deploy the Master pod, service and the Worker pods</p><p>Starting with the Master deployment, this will deploy our Spark Standalone image into a container running the Master daemon process:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-31bca11627167e0cd963103e4c7f11d2\"></iframe><p>To deploy the Master, run the following:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">kubectl create -f spark-master-deployment.yaml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>The Master will expose a web UI on port 8080 and an RPC service on port 7077, we will need to deploy a K8S service for this, the YAML required to do this is shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-a72d3c38d7a3f94e88c7affd28a3034b\"></iframe><p>To deploy the Master service, run the following:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">kubectl create -f spark-master-service.yaml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Now that we have a Master pod and service up and running, we need to deploy our Workers which are preconfigured to communicate with the Master service.</p><p>The YAML required to deploy the two Worker pods is shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-97ceb93ed35959c41d80fb8c025a7ba1\"></iframe><p>To deploy the Worker pods, run the following:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">kubectl create -f spark-worker-deployment.yaml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>You can now inspect the Spark processes running on your GKE cluster.</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">kubectl get deployments</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Shows...</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> spark-master   1/1     1            1           7m45s</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> spark-worker   2/2     2            2           9s</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">kubectl get pods</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Shows...</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">NAME                            READY   STATUS    RESTARTS   AGE</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> spark-master-f69d7d9bc-7jgmj    1/1     Running   0          8m</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> spark-worker-55965f669c-rm59p   1/1     Running   0          24s</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> spark-worker-55965f669c-wsb2f   1/1     Running   0          24s</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Next, as we need to expose the Web UI for the Master process we will create a <em>LoadBalancer</em> resource. The YAML used to do this is provided here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-56ee86f50f329f99679ff243bb00fb07\"></iframe><p>To deploy the LB, you would run the following:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">kubectl create -f spark-ui-lb.yaml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p><strong>NOTE</strong> This is just an example, for simplicity we are creating an external <em>LoadBalancer</em> with a public IP, this configuration is likely not be appropriate in most real scenarios, alternatives would include an internal <em>LoadBalancer</em>, retraction of Authorized Networks, a jump host, SSH tunnelling or IAP.</p><p>Now you’re up and running!</p><p>You can access the Master web UI from the Google Console link shown here:</p><p><a target=\"_blank\" href=\"/assets/files/master-ui-link-c9d78a7032459c01291494b1c26e34ff.png\"><img loading=\"lazy\" alt=\"Accessing the Spark Master UI from the Google Cloud Console\" src=\"/assets/images/master-ui-link-c9d78a7032459c01291494b1c26e34ff.png\" width=\"1070\" height=\"611\" class=\"img_ev3q\"></a></p><p>The Spark Master UI should look like this:</p><p><a target=\"_blank\" href=\"/assets/files/spark-master-ui-fa6eecc91847995dea15601166516004.png\"><img loading=\"lazy\" alt=\"Spark Master UI\" src=\"/assets/images/spark-master-ui-fa6eecc91847995dea15601166516004.png\" width=\"1070\" height=\"668\" class=\"img_ev3q\"></a></p><p>Next we will exec into a Worker pod, get a shell:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">kubectl exec -it spark-worker-55965f669c-rm59p -- sh</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Now from within the shell environment of a Worker – which includes all of the Spark client libraries, we will submit a simple Spark application:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">spark-submit --class org.apache.spark.examples.SparkPi \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> --master spark://10.11.250.98:7077 \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">/opt/spark/examples/jars/spark-examples*.jar 10000</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>You can see the results in the shell, as shown here:</p><p><a target=\"_blank\" href=\"/assets/files/spark-application-example-0f11e071394077ac8c678ed7d3e93791.png\"><img loading=\"lazy\" alt=\"Spark Pi Estimator Example\" src=\"/assets/images/spark-application-example-0f11e071394077ac8c678ed7d3e93791.png\" width=\"1022\" height=\"932\" class=\"img_ev3q\"></a></p><p>Additionally, as all of the container logs go to Stackdriver, you can view the application logs there as well:</p><p><a target=\"_blank\" href=\"/assets/files/container-logs-in-stackdriver-350797a4dd5cceab0b4aa12445adeed4.png\"><img loading=\"lazy\" alt=\"Container Logs in StackDriver\" src=\"/assets/images/container-logs-in-stackdriver-350797a4dd5cceab0b4aa12445adeed4.png\" width=\"1070\" height=\"668\" class=\"img_ev3q\"></a></p><p>This is a simple way to get a Spark cluster running, it is not without its downsides and shortcomings however, which include the limited security mechanisms available (SASL, network security, shared secrets).</p><p>In the final post in this series we will look at Spark on Kubernetes, using Kubernetes as the Spark cluster manager and interacting with Spark using the Kubernetes API and control plane, see you then.</p><blockquote><p>Full source code for this article is available at: <a href=\"https://github.com/gamma-data/spark-on-gcp\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/gamma-data/spark-on-gcp</a></p></blockquote><p>The infrastructure coding for this example uses Powershell and Terraform, and is deployed as follows:</p><div class=\"language-powershell codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-powershell codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">PS &gt; .\\run.ps1 private-network apply &lt;gcp-project&gt; &lt;region&gt;</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">PS &gt; .\\run.ps1 gke apply &lt;gcp-project&gt; &lt;region&gt;</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div>",
            "url": "https://fullstackchronicles.io/spark-in-the-google-cloud-platform-part-2",
            "title": "Spark in the Google Cloud Platform Part 2",
            "summary": "Apache Spark in GCP",
            "date_modified": "2020-02-29T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "apache-spark",
                "cloud-dataproc",
                "dataproc",
                "gcp",
                "gke",
                "google-cloud-platform",
                "googlecloudplatform",
                "kubernetes",
                "spark"
            ]
        },
        {
            "id": "spark-in-the-google-cloud-platform-part-1",
            "content_html": "<p><img loading=\"lazy\" alt=\"Apache Spark in GCP\" src=\"/assets/images/spark-gcp-featured-image-86e0bfd36db759253fff66591b594d8b.png\" width=\"213\" height=\"155\" class=\"img_ev3q\"></p><p>I have been an avid Spark enthusiast since 2014 (the early days..). Spark has featured heavily in every project I have been involved with from data warehousing, ETL, feature extraction, advanced analytics to event processing and IoT applications. I like to think of it as a Swiss army knife for distributed processing.</p><div class=\"theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z\"></path></svg></span>Spark Training Courses</div><div class=\"admonitionContent_S0QG\"><p><a href=\"https://academy.alphazetta.ai/data-transformation-and-analysis-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Data Transformation and Analysis Using Apache Spark</a><br>\n<a href=\"https://academy.alphazetta.ai/stream-and-event-processing-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Stream and Event Processing using Apache Spark</a><br>\n<a href=\"https://academy.alphazetta.ai/advanced-analytics-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Advanced Analytics Using Apache Spark</a></p></div></div><p>Curiously enough, the first project I had been involved with for some years that did not feature the Apache Spark project was a green field GCP project which got me thinking… where does Spark fit into the GCP landscape?</p><p>Unlike the other major providers who use Spark as the backbone of their managed distributed ETL services with examples such as AWS Glue or the Spark integration runtime option in Azure Data Factory, Google’s managed ETL solution is Cloud DataFlow. Cloud DataFlow which is a managed Apache Beam service does not use a Spark runtime (there is a Spark Runner however this is not an option when using CDF). So where does this leave Spark?</p><p>My summation is that although Spark is not a first-class citizen in GCP (as far as managed ETL), it is not a second-class citizen either. This article will discuss the various ways Spark clusters and applications can be deployed within the GCP ecosystem.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"quick-primer-on-spark\">Quick Primer on Spark<a class=\"hash-link\" href=\"#quick-primer-on-spark\" title=\"Direct link to heading\">​</a></h2><p>Every Spark application contains several components regardless of deployment mode, the components in the Spark runtime architecture are:</p><ul><li>the Driver</li><li>the Master</li><li>the Cluster Manager</li><li>the Executor(s), which run on worker nodes or Workers</li></ul><p>Each component has a specific role in executing a Spark program and all of the Spark components run in Java virtual machines (JVMs).</p><p><a target=\"_blank\" href=\"/assets/files/spark-runtime-0b55b3d8793bab097b517603866abe16.png\"><img loading=\"lazy\" alt=\"Spark Runtime Architecture\" src=\"/assets/images/spark-runtime-0b55b3d8793bab097b517603866abe16.png\" width=\"752\" height=\"420\" class=\"img_ev3q\"></a></p><p>Cluster Managers schedule and manage distributed resources (compute and memory) across the nodes of the cluster. Cluster Managers available for Spark include:</p><ul><li>Standalone</li><li>YARN (Hadoop)</li><li>Mesos</li><li>Kubernetes</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"spark-on-dataproc\">Spark on DataProc<a class=\"hash-link\" href=\"#spark-on-dataproc\" title=\"Direct link to heading\">​</a></h2><p>This is perhaps the simplest and most integrated approach to using Spark in the GCP ecosystem.</p><p>DataProc is GCP’s managed Hadoop Service (akin to AWS EMR or HDInsight on Azure). DataProc uses Hadoop/YARN as the Cluster Manager. DataProc clusters can be deployed on a private network (VPC using RFC1918 address space), supports encryption at Rest using Google Managed or Customer Managed Keys in KMS, supports autoscaling and the use of Preemptible Workers, and can be deployed in a HA config.</p><p>Furthermore, DataProc clusters can enforce strong authentication using Kerberos which can be integrated into other directory services such as Active Directory through the use of cross realm trusts.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"deployment\">Deployment<a class=\"hash-link\" href=\"#deployment\" title=\"Direct link to heading\">​</a></h3><p>DataProc clusters can be deployed using the <code>gcloud dataproc clusters create</code> command or using IaC solutions such as Terraform. For this article I have included an example in the source code using the <code>gcloud</code> command to deploy a DataProc cluster on a private network which was created using Terraform.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"integration\">Integration<a class=\"hash-link\" href=\"#integration\" title=\"Direct link to heading\">​</a></h3><p>The beauty of DataProc is its native integration into IAM and the GCP service plane. Having been a long-time user of AWS EMR, I have found that the usability and integration are in many ways superior in GCP DataProc. Let’s look at some examples...</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"iam-and-iap-tcp-forwarding\">IAM and IAP (TCP Forwarding)<a class=\"hash-link\" href=\"#iam-and-iap-tcp-forwarding\" title=\"Direct link to heading\">​</a></h4><p>DataProc is integrated into Cloud IAM using various coarse grained permissions use as <code>dataproc.clusters.use</code> and simplified IAM Roles such as <code>dataproc.editor</code> or <code>dataproc.admin</code>. Members with bindings to the these roles can perform tasks such as submitting jobs and creating workflow templates (which we will discuss shortly), as well as accessing instances such as the master node instance or instances in the cluster using IAP (TCP Forwarding) without requiring a public IP address or a bastion host.</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"dataproc-jobs-and-workflows\">DataProc Jobs and Workflows<a class=\"hash-link\" href=\"#dataproc-jobs-and-workflows\" title=\"Direct link to heading\">​</a></h4><p>Spark jobs can be submitted using the console or via <code>gcloud dataproc jobs submit</code> as shown here:</p><p><a target=\"_blank\" href=\"/assets/files/dataproc-spark-job-953a699ceef00b9e3b0f05068a844a56.png\"><img loading=\"lazy\" alt=\"Submitting a Spark Job using gcloud dataproc jobs submit\" src=\"/assets/images/dataproc-spark-job-953a699ceef00b9e3b0f05068a844a56.png\" width=\"1097\" height=\"499\" class=\"img_ev3q\"></a></p><p>Cluster logs are natively available in StackDriver and standard out from the Spark Driver is visible from the console as well as via <code>gcloud</code> commands.</p><p>Complex Workflows can be created by adding Jobs as Steps in Workflow Templates using the following command:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud dataproc workflow-templates add-job spark</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"optional-components-and-the-component-gateway\">Optional Components and the Component Gateway<a class=\"hash-link\" href=\"#optional-components-and-the-component-gateway\" title=\"Direct link to heading\">​</a></h4><p>DataProc provides you with a Hadoop cluster including YARN and HDFS, a Spark runtine – which includes Spark SQL and SparkR. DataProc also supports several optional components including Anaconda, Jupyter, Zeppelin, Druid, Presto, and more.</p><p>Web interfaces to some of these components as well as the management interfaces such as the Resource Manager UI or the Spark History Server UI can be accessed through the Component Gateway.</p><p>This is a Cloud IAM integrated gateway (much like IAP) which can allow access through an authenticated and authorized console session to web UIs in the cluster – without the need for SSH tunnels, additional firewall rules, bastion hosts, or public IPs. Very cool.</p><p>Links to the component UIs as well as built in UIs like the YARN Resource Manager UI are available directly from through the console.</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"jupyter\">Jupyter<a class=\"hash-link\" href=\"#jupyter\" title=\"Direct link to heading\">​</a></h4><p>Jupyter is a popular notebook application in the data science and analytics communities used for reproducible research. DataProc’s Jupyter component provides a ready-made Spark application vector using PySpark. If you have also installed the Anaconda component you will have access to the full complement of scientific and mathematic Python packages such as Pandas and NumPy which can be used in Jupyter notebooks as well. Using the Component Gateway, Jupyer notebooks can be accessed directly from the Google console as shown here:</p><p><a target=\"_blank\" href=\"/assets/files/dataproc-jupyter-notebook-14d165b5563c903961beb68bef757a82.png\"><img loading=\"lazy\" alt=\"Jupyter Notebooks using DataProc\" src=\"/assets/images/dataproc-jupyter-notebook-14d165b5563c903961beb68bef757a82.png\" width=\"1359\" height=\"924\" class=\"img_ev3q\"></a></p><p>From this example you can see that I accessed source data from a GCS bucket and used HDFS as local scratch space.</p><p>Furthermore, notebooks are automagically saved in your integrated Cloud Storage DataProc staging bucket and can be shared amongst analysts or accessed at a later time. These notebooks also persist beyond the lifespan of the cluster.</p><p>Next up we will look at deploying a Spark Standalone cluster on a GKE cluster, see you then!</p>",
            "url": "https://fullstackchronicles.io/spark-in-the-google-cloud-platform-part-1",
            "title": "Spark in the Google Cloud Platform Part 1",
            "summary": "Apache Spark in GCP",
            "date_modified": "2020-02-14T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "apache-spark",
                "gcp",
                "google-cloud-platform",
                "googlecloudplatform",
                "spark"
            ]
        },
        {
            "id": "query-cloud-sql-through-big-query",
            "content_html": "<p><img loading=\"lazy\" alt=\"cloudsql federated queries\" src=\"/assets/images/cloud-sql-federated-queries-8af6a8b8a2536a9c78de7d33b3a5c626.png\" width=\"150\" height=\"157\" class=\"img_ev3q\"></p><p>This article demonstrates Cloud SQL federated queries for Big Query, a neat and simple to use feature.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"connecting-to-cloud-sql\">Connecting to Cloud SQL<a class=\"hash-link\" href=\"#connecting-to-cloud-sql\" title=\"Direct link to heading\">​</a></h2><p>One of the challenges presented when using Cloud SQL on a private network (VPC) is providing access to users. There are several ways to accomplish this which include:</p><ul><li>open the database port on the VPC Firewall (5432 for example for Postgres) and let users access the database using a command line or locally installed GUI tool <em>(may not be allowed in your environment)</em></li><li>provide a web based interface deployed on your VPC such as PGAdmin deployed on a GCE instance or GKE pod <em>(adds security and management overhead)</em></li><li>use the Cloud SQL proxy <em>(requires additional software to be installed and configured)</em></li></ul><p>In additional, all of the above solutions require direct IP connectivity to the instance which may not always be available. Furthermore each of these operations requires the user to present some form of authentication – in many cases the database user and password which then must be managed at an individual level.</p><p>Enter Cloud SQL federated queries for Big Query…</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"big-query-federated-queries-for-cloud-sql\">Big Query Federated Queries for Cloud SQL<a class=\"hash-link\" href=\"#big-query-federated-queries-for-cloud-sql\" title=\"Direct link to heading\">​</a></h2><p>Big Query allows you to query tables and views in Cloud SQL (currently MySQL and Postgres) using the Federated Queries feature. The queries could be authorized views in Big Query datasets for example.</p><p>This has the following advantages:</p><ul><li>Allows users to authenticate and use the GCP console to query Cloud SQL</li><li>Does not require direct IP connectivity to the user or additional routes or firewall rules</li><li>Leverages Cloud IAM as the authorization mechanism – rather that unmanaged db user accounts and object level permissions</li><li>External queries can be executed against a read replica of the Cloud SQL instance to offload query IO from the master instance</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"setting-it-up\">Setting it up<a class=\"hash-link\" href=\"#setting-it-up\" title=\"Direct link to heading\">​</a></h2><p>Setting up big query federated queries for Cloud SQL is exceptionally straightforward, a summary of the steps are provided below:</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-1-enable-a-public-ip-on-the-cloud-sql-instance\">Step 1. Enable a Public IP on the Cloud SQL instance<a class=\"hash-link\" href=\"#step-1-enable-a-public-ip-on-the-cloud-sql-instance\" title=\"Direct link to heading\">​</a></h3><p>This sounds bad, but it isn’t really that bad. You need to enable a public interface for Big Query to be able to establish a connection to Cloud SQL, however this is not accessed through the actual public internet – rather it is accessed through the Google network using the back end of the front end if you will.</p><p>Furthermore, you configure an empty list of authorized networks which effectively shields the instance from the public network, this can be configured in Terraform as shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-81c57a80a7e588b98ea7d294dbaee242\"></iframe><p>This configuration change can be made to a running instance as well as during the initial provisioning of the instance.</p><p>As shown below you will get a warning dialog in the console saying that you have no authorized networks - this is by design.</p><p><a target=\"_blank\" href=\"/assets/files/cloud-sql-publicip-screenshot-53f21feadbfaf3be93f69de3ce771c2f.png\"><img loading=\"lazy\" alt=\"Cloud SQL Public IP Enabled with No Authorized Networks\" src=\"/assets/images/cloud-sql-publicip-screenshot-53f21feadbfaf3be93f69de3ce771c2f.png\" width=\"1139\" height=\"775\" class=\"img_ev3q\"></a></p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-2-create-a-big-query-dataset-which-will-be-used-to-execute-the-queries-to-cloud-sql\">Step 2. Create a Big Query dataset which will be used to execute the queries to Cloud SQL<a class=\"hash-link\" href=\"#step-2-create-a-big-query-dataset-which-will-be-used-to-execute-the-queries-to-cloud-sql\" title=\"Direct link to heading\">​</a></h3><p>Connections to Cloud SQL are defined in a Big Query dataset, this can also be use to control access to Cloud SQL using authorized views controlled by IAM roles.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-8a4beaab134a1c72613347b5822d1724\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-3-create-a-connection-to-cloud-sql\">Step 3. Create a connection to Cloud SQL<a class=\"hash-link\" href=\"#step-3-create-a-connection-to-cloud-sql\" title=\"Direct link to heading\">​</a></h3><p>To create a connection to Cloud SQL from Big Query you must first enable the BigQuery Connection API, this is done at a project level.</p><p>As this is a fairly recent feature there isn't great coverage with either the <strong><code>bq</code></strong> tool or any of the Big Query client libraries to do this so we will need to use the console for now...</p><p>Under the <em><strong>Resources</strong></em> -&gt; <strong><em>Add Data</em></strong> link in the left hand panel of the Big Query console UI, select <strong><em>Create Connection</em></strong>. You will see a side info panel with a form to enter connection details for your Cloud SQL instance.</p><p>In this example I will setup a connection to a Cloud SQL read replica instance I have created:</p><p><a target=\"_blank\" href=\"/assets/files/big-query-add-connection-67a0236996204c84c7608a8e6b8f4875.png\"><img loading=\"lazy\" src=\"/assets/images/big-query-add-connection-67a0236996204c84c7608a8e6b8f4875.png\" width=\"959\" height=\"775\" class=\"img_ev3q\"></a></p><p>Creating a Big Query Connection to Cloud SQL</p><p>More information on the Big Query Connections API can be found at: <a href=\"https://cloud.google.com/bigquery/docs/reference/bigqueryconnection/rest\" target=\"_blank\" rel=\"noopener noreferrer\">https://cloud.google.com/bigquery/docs/reference/bigqueryconnection/rest</a></p><p>The following permissions are associated with connections in Big Query:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">bigquery.connections.create  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">bigquery.connections.get  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">bigquery.connections.list  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">bigquery.connections.use  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">bigquery.connections.update  </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">bigquery.connections.delete</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>These permissions are conveniently combined into the following predefined roles:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">roles/bigquery.connectionAdmin    (BigQuery Connection Admin)         </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">roles/bigquery.connectionUser     (BigQuery Connection User)          </span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"step-4-query-away\">Step 4. Query away!<a class=\"hash-link\" href=\"#step-4-query-away\" title=\"Direct link to heading\">​</a></h3><p>Now the connection to Cloud SQL can be accessed using the <strong><code>EXTERNAL_QUERY</code></strong> function in Big Query, as shown here:</p><p><a target=\"_blank\" href=\"/assets/files/cloud-sql-federated-queries-screenshot-34e49ac369753d8551095e92b7fc6264.png\"><img loading=\"lazy\" alt=\"Querying Cloud SQL from Big Query\" src=\"/assets/images/cloud-sql-federated-queries-screenshot-34e49ac369753d8551095e92b7fc6264.png\" width=\"1373\" height=\"730\" class=\"img_ev3q\"></a></p>",
            "url": "https://fullstackchronicles.io/query-cloud-sql-through-big-query",
            "title": "Query Cloud SQL through Big Query",
            "summary": "cloudsql federated queries",
            "date_modified": "2020-02-08T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "big-query",
                "bigquery",
                "cloudsql",
                "gcp",
                "google-cloud-platform",
                "googlecloudplatform"
            ]
        },
        {
            "id": "google-cloud-sql-availability-for-postgresql-read-replicas",
            "content_html": "<p><img loading=\"lazy\" alt=\"CloudSQL HA\" src=\"/assets/images/cloudsql-featured-image-896f0c764d7310d88c5cc9461f3feb6c.png\" width=\"151\" height=\"151\" class=\"img_ev3q\"></p><p>In this post we will look at read replicas as an additional method to achieve multi zone availability for Cloud SQL, which gives us - in turn - the ability to offload (potentially expensive) IO operations such as user created backups or read operations without adding load to the master instance.</p><p>In the previous post in this series we looked at Regional availability for PostgreSQL HA using Cloud SQL:</p><p><a href=\"https://cloudywithachanceofbigdata.com/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql-part-i/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Google Cloud SQL – Availability, Replication, Failover for PostgreSQL – Part I</strong></a></p><p>Recall that this option was simple to implement and worked relatively seamlessly and transparently with respect to zonal failover.</p><p>Now let's look at read replicas in Cloud SQL as an additional measure for availability.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"deploying-read-replicas\">Deploying Read Replica(s)<a class=\"hash-link\" href=\"#deploying-read-replicas\" title=\"Direct link to heading\">​</a></h2><p>Deploying read replicas is slightly more involved than simple regional (high) availability, as you will need to define each replica or replicas as a separate Cloud SQL instance which is a slave to the primary instance (the master instance).</p><p>An example using Terraform is provided here, starting by creating the master instance:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-34371a3c7edab140e70208cd7710c25a\"></iframe><p>Next you would specify one or more read replicas (typically in a zone other than the zone the master is in):</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-980f2d6461db0613b4090413041b5ec5\"></iframe><p>Note that several of the options supplied are omitted when creating a read replica database instance, such as the backup and maintenance options - as these operations cannot be performed on a read replica as we will see later.</p><figure><a href=\"/assets/images/cloud-sql-postgres-read-replicas-1-212da608bf5ba2aa73198627a0cfe3e1.png\"><img src=\"/assets/images/cloud-sql-postgres-read-replicas-1-212da608bf5ba2aa73198627a0cfe3e1.png\" alt=\"Cloud SQL Instances - showing master and replica\"></a><figcaption class=\"figure-caption\">Cloud SQL Instances - showing master and replica</figcaption></figure><figure><a href=\"/assets/images/cloud-sql-postgres-read-replicas-2-ec13f6b5f93493f369db3f4c11987507.png\"><img src=\"/assets/images/cloud-sql-postgres-read-replicas-2-ec13f6b5f93493f369db3f4c11987507.png\" alt=\"Cloud SQL Master Instance\"></a><figcaption class=\"figure-caption\">Cloud SQL Master Instance</figcaption></figure><p>Voila! You have just set up a master instance (the primary instance your application and/or users will connect to) along with a read replica in a different zone which will be asynchronously updated as changes occur on the master instance.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"read-replicas-in-action\">Read Replicas in Action<a class=\"hash-link\" href=\"#read-replicas-in-action\" title=\"Direct link to heading\">​</a></h2><p>Now that we have created a read replica, lets see it in action. After connecting to the read replica (like you would any other instance), attempt to access a table that has <strong><em>not</em></strong> been created on the master as shown here:</p><figure><a href=\"/assets/images/cloud-sql-postgres-read-replicas-3-8d16fdd58297948424c733b59cb58ff5.png\"><img src=\"/assets/images/cloud-sql-postgres-read-replicas-3-8d16fdd58297948424c733b59cb58ff5.png\" alt=\"SELECT operation from the replica instance\"></a><figcaption class=\"figure-caption\">SELECT operation from the replica instance</figcaption></figure><p>Now create the table and insert some data on the <strong><em>master</em></strong> instance:</p><figure><a href=\"/assets/images/cloud-sql-postgres-read-replicas-4-c207e904d4880b5f799bcfdabf7de36a.png\"><img src=\"/assets/images/cloud-sql-postgres-read-replicas-4-c207e904d4880b5f799bcfdabf7de36a.png\" alt=\"Create a table and insert a record on the master instance\"></a><figcaption class=\"figure-caption\">Create a table and insert a record on the master instance</figcaption></figure><p>Now try the select operation on the <strong><em>replica</em></strong> instance:</p><figure><a href=\"/assets/images/cloud-sql-postgres-read-replicas-5-a9412ef5afba9855221998e5551cb19e.png\"><img src=\"/assets/images/cloud-sql-postgres-read-replicas-5-a9412ef5afba9855221998e5551cb19e.png\" alt=\"SELECT operation from the replica instance (after changes have been made on the master)\"></a><figcaption class=\"figure-caption\">SELECT operation from the replica instance (after changes have been made on the master)</figcaption></figure><p>It works!</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"some-points-to-note-about-cloud-sql-read-replicas\">Some Points to Note about Cloud SQL Read Replicas<a class=\"hash-link\" href=\"#some-points-to-note-about-cloud-sql-read-replicas\" title=\"Direct link to heading\">​</a></h2><ul><li>Users connect to a read replica as a normal database connection (as shown above)</li><li>Google managed backups (using the console or <code>gcloud sql backups create ..</code> ) can <strong><em>NOT</em></strong> be performed against replica instances</li><li>Read replicas can be used to offload IO intensive operations from the the master instance - such as user managed backup operations (e.g. <code>pg_dump</code>)</li></ul><figure><a href=\"/assets/images/cloud-sql-postgres-read-replicas-6-c367a62c5d3e480fa25ea4d0ea2669cf.png\"><img src=\"/assets/images/cloud-sql-postgres-read-replicas-6-c367a62c5d3e480fa25ea4d0ea2669cf.png\" alt=\"pg_dump operation against a replica instance\"></a><figcaption class=\"figure-caption\">pg_dump operation against a replica instance</figcaption></figure><ul><li><strong>BE CAREFUL</strong> Despite their name, read replicas are <strong>NOT</strong> read only, updates can be made which will NOT propagate back to the master instance - you could get yourself in an awful mess if you allow users to perform <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>CREATE</code> or <code>DROP</code> operations against replica instances.</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"promoting-a-read-replica\">Promoting a Read Replica<a class=\"hash-link\" href=\"#promoting-a-read-replica\" title=\"Direct link to heading\">​</a></h2><p>If required a read replica can be promoted to a standalone Cloud SQL instance, which is another DR option. Keep in mind however as the read replica is updated in an asynchronous manner, promotion of a read replica may result in a loss of data (hopefully not much but a loss nonetheless). Your application RPO will dictate if this is acceptable or not.</p><p>Promotion of a read replica is reasonably straightforward as demonstrated here using the console:</p><figure><a href=\"/assets/images/cloud-sql-postgres-read-replicas-7-a4ec8a31ed6601a9e7253ce408893a90.png\"><img src=\"/assets/images/cloud-sql-postgres-read-replicas-7-a4ec8a31ed6601a9e7253ce408893a90.png\" alt=\"Promoting a read replica using the console\"></a><figcaption class=\"figure-caption\">Promoting a read replica using the console</figcaption></figure><p>You can also use the following <code>gcloud</code> command:</p><p> gcloud sql instances promote-replica  &lt;replica<!-- -->_<!-- -->instance<!-- -->_<!-- -->name&gt;</p><p>Once you click on the <em>Promote Replica</em> button you will see the following warning:</p><figure><a href=\"/assets/images/cloud-sql-postgres-read-replicas-8-310006339cb5a3d3c491dfb00fc86c88.png\"><img src=\"/assets/images/cloud-sql-postgres-read-replicas-8-310006339cb5a3d3c491dfb00fc86c88.png\" alt=\"\"></a><figcaption class=\"figure-caption\"></figcaption></figure><p><em>Promoting a read replica using the console</em></p><p>This simply states that once you promote the replica instance your instance will become an independent instance with no further relationship with the master instance. Once accepted and the promotion process is complete, you can see that you now have two independent Cloud SQL instances (as advertised!):</p><figure><a href=\"/assets/images/cloud-sql-postgres-read-replicas-9-5cbdcea2c489b064bbbc1bad3617fbce.png\"><img src=\"/assets/images/cloud-sql-postgres-read-replicas-9-5cbdcea2c489b064bbbc1bad3617fbce.png\" alt=\"Promoted Cloud SQL instance\"></a><figcaption class=\"figure-caption\">Promoted Cloud SQL instance</figcaption></figure><p>Some of the options you would normally configure with a master instance would need to be configured on the promoted replica instance - such as high availability, maintenance and scheduled backups - but in the event of a zonal failure you would be back up and running with virtually no data loss!</p><blockquote><p>Full source code for this article is available at: <a href=\"https://github.com/gamma-data/cloud-sql-postgres-availability-tutorial\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/gamma-data/cloud-sql-postgres-availability-tutorial</a></p></blockquote>",
            "url": "https://fullstackchronicles.io/google-cloud-sql-availability-for-postgresql-read-replicas",
            "title": "Google Cloud SQL – Availability for PostgreSQL – Part II (Read Replicas)",
            "summary": "CloudSQL HA",
            "date_modified": "2020-01-24T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "cloudsql",
                "gcp",
                "google-cloud-platform",
                "googlecloudplatform",
                "ha",
                "highavailability",
                "postgresql"
            ]
        },
        {
            "id": "introducing-service-mesh-part-ii",
            "content_html": "<p><img loading=\"lazy\" alt=\"Service Mesh\" src=\"/assets/images/service-mesh-1-d7868fc724132b5e947edad350e8e1ed.png\" width=\"151\" height=\"106\" class=\"img_ev3q\"></p><p>This is a follow up to the previous post:</p><p><a href=\"https://cloudywithachanceofbigdata.com/sick-of-hearing-about-service-mesh-heres-what-you-need-to-know/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>Sick of hearing about Service Mesh? Here’s what you need to know...</strong></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"refresher\">Refresher<a class=\"hash-link\" href=\"#refresher\" title=\"Direct link to heading\">​</a></h2><p>A refresher on the data plane, and what the userspace proxy can perform:</p><ul><li><strong>Routing:</strong> Given a REST request for <code>/hello</code> from the local service instance, where should that request be sent?</li><li><strong>Load Balancing:</strong> Once routing has done its job, to which upstream service instance should the request be sent? With what timeout? If the request fails, should it be retried?</li><li><strong>Authorisation and Authentication:</strong> For requests that are incoming, can cryptographic functions determine the authenticity of that requests? Is the called allowed to invoke the requested endpoint?</li><li><strong>Observability:</strong> Detailed logging, statistics, distributed tracing data so that operators can understand the traffic flow and debug problems as they occur</li><li><strong>Service Discovery:</strong> What backend/upstream service instances are available?</li><li><strong>Health Checking:</strong> Are upstream service instances healthy and ready to accept traffic?</li></ul><p>The control plane is slightly less complex. For the data plane to act in a coordinated fashion, the control plane gives you the machinery to make that happen. This is the magical part of the service mesh; the control plane takes a set of isolated sidecar proxies and turns them into a distributed system. The control plane in turn provides an API to allow the user to modify and inspect the behaviour of the data plane.</p><p>You can see from the diagram below the proxies are right next to the service in the same node. We usually call those 'sidecar' containers.</p><p><a target=\"_blank\" href=\"/assets/files/control-data-plane-5cd2a8598fa552440a65343abd9e762c.png\"><img loading=\"lazy\" src=\"/assets/images/control-data-plane-5cd2a8598fa552440a65343abd9e762c.png\" width=\"1068\" height=\"689\" class=\"img_ev3q\"></a></p><p>The diagram above gives you a high level indication of what the service mesh would look like. What if I don't have many services? Then the service mesh probably isn't for you. That's a whole lot of machinery to run a single proxy! Having said this, if your solution is running hundreds or thousands of services, then you're going to require a whole heap of proxies.</p><p>So there you have it. The service mesh with its control and data plane. To put it simply, the goal of the control plane is to monitor and set a policy that will eventually be enacted by the data plane.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"why\">Why?<a class=\"hash-link\" href=\"#why\" title=\"Direct link to heading\">​</a></h2><p>You've taken over a project, and the security team have mandated the use of the service mesh. You've never used it yourself before, and the confusion as to why we need another thing is getting you down. An additional thing next to my container that will add latency? And consume resources? And I have to maintain it?! Why would anyone need or want this?</p><p>While there are a few answers to this, the most important answer is something I alluded to in an example in part 1 of this series: this design is a great way to add additional logic into the system. Not only can you add additional logic (to containers possibly outside of your control) but you can do this uniformly across the entire mesh! <em>The service mesh gives you features that are critical for running software that's uniform across your whole stack</em></p><p>The set of features that the service mesh can provide include reliability features (Retries, timeouts etc), observability features (latencies, volume etc) and security features (mTLS, access control etc).</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"lets-break-it-down\">Let's break it down<a class=\"hash-link\" href=\"#lets-break-it-down\" title=\"Direct link to heading\">​</a></h2><p><strong>Server-side software relies on these critical features</strong> If you're building any type of modern server-side software that's predicated on multiple services, think API's and web-apps, and if you're continually adding features to this in a short timeframe, then all the features listed above become critical for you. Your applications must be reliable, observable and most importantly secure. This is exactly what the service mesh helps you with.</p><p><strong>One view to rule them all</strong> The features mentioned above are language-agnostic, don't care about your framework, who wrote it or any part of your development life cycle. They give you, your team and your company a consistent way to deploy changes across your service landscape</p><p><strong>Decoupled from application code</strong> It's important to have a single place to include application and business logic, and not have the nightmare of managing that in multiple components of your system. The core stewardship of the functionality that the service mesh provides lies at the <em>platform level</em>. This includes maintenance, deployments, operation etc. The application can be updated and deployed by developers maintaining the application, and the service mesh can change without the application being involved.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"in-short\">In short<a class=\"hash-link\" href=\"#in-short\" title=\"Direct link to heading\">​</a></h2><p>Yes, while the features of the service mesh could be implemented as application code, this solution would not help in driving uniform features sets across the whole system, which is the value proposition for the service mesh.</p><p><em>If you're a business-logic developer</em>, you probably don't need to worry about the service mesh. Keep pumping out that new fangled business logic that makes the software oh-so-usable</p><p><em>If you're in a platform role</em> and most likely using <em>Kubernetes</em>, then you should be right on top of the service mesh! That is unless your architecture dictates a monolith. You're going to have a lot of services talking to one another, all tied together with an overarching dependency.</p><p><em>If you're in a platform role with no Kubernetes</em> but a bunch of microservices, you should maybe care a little bit about the service mesh, but without the power of Kubernetes and the ease of deployment it brings, you'll have to weigh up how you intend to manage all those proxies.</p><p>I hope you enjoyed this article, please feel free to reach out to me at:</p><p>Tom Klimovski<br>\n<!-- -->Principal Consultant, Gamma Data<br>\n<a href=\"mailto:tom.klimovski@gammadata.io\" target=\"_blank\" rel=\"noopener noreferrer\">tom.klimovski@gammadata.io</a></p>",
            "url": "https://fullstackchronicles.io/introducing-service-mesh-part-ii",
            "title": "Introducing Service Mesh Part II",
            "summary": "Service Mesh",
            "date_modified": "2020-01-21T00:00:00.000Z",
            "author": {
                "name": "Tom Klimovski",
                "url": "https://github.com/tomklimovskigamma"
            },
            "tags": [
                "k8s",
                "kubernetes",
                "service-mesh",
                "servicemesh"
            ]
        },
        {
            "id": "google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql",
            "content_html": "<p><img loading=\"lazy\" alt=\"CloudSQL HA\" src=\"/assets/images/cloudsql-featured-image-896f0c764d7310d88c5cc9461f3feb6c.png\" width=\"151\" height=\"151\" class=\"img_ev3q\"></p><p>In this multi part blog we will explore the features available in Google Cloud SQL for High Availability, Backup and Recovery, Replication and Failover and Security (at rest and in transit) for the PostgreSQL DBMS engine. Some of these features are relatively hot of the press and in Beta – which still makes them available for general use.</p><p>We will start by looking at the High Availability (HA) options available to you when using the PostgreSQL engine in Google Cloud SQL.</p><p>Most of you would be familiar with the concepts of High Availability, Redundancy, Fault Tolerance, etc but let’s start with a definition of HA anyway:</p><blockquote><p>High availability (HA) is a characteristic of a system, which aims to ensure an agreed level of operational performance, usually uptime, for a higher than normal period.</p><p>Wikipedia</p></blockquote><p>Higher than a normal period is quite subjective, typically this is quantified by a percentage represented by a number of “9s”, that is 99.99% (which would be quoted as “four nines”), this would allot you 52.60 minutes of downtime over a one-year period.</p><p>Essentially the number of 9’s required will drive your bias towards the options available to you for Cloud SQL HA.</p><p>We will start with Cloud SQL HA in its simplest form, Regional Availability.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"regional-availability\">Regional Availability<a class=\"hash-link\" href=\"#regional-availability\" title=\"Direct link to heading\">​</a></h2><p>Knowing what we know about the Google Cloud Platform, regional availability means that our application or service (in this case Cloud SQL) should be resilient to a failure of any one zone in our region. In fact, as all GCP regions have at least 3 zones – two zones could fail, and our application would still be available.</p><p>Regional availability for Cloud SQL (which Google refers to as High Availability), creates a standby instance in addition to the primary instance and uses a regional Persistent Disk resource to store the database instance data, transaction log and other state files, which is synchronously replicated to a Persistent Disk resource local to the zones that the primary and standby instances are located in.</p><p>A shared IP address (like a Virtual IP) is used to serve traffic to the healthy (normally primary) Cloud SQL instance.</p><p>An overview of Cloud SQL HA is shown here:</p><p><a target=\"_blank\" href=\"/assets/files/cloud-sql-ha-9f997d42db7d02fc6391cb507e81bc6c.png\"><img loading=\"lazy\" alt=\"Cloud SQL High Availability\" src=\"/assets/images/cloud-sql-ha-9f997d42db7d02fc6391cb507e81bc6c.png\" width=\"716\" height=\"541\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"implementing-high-availability-for-cloud-sql\">Implementing High Availability for Cloud SQL<a class=\"hash-link\" href=\"#implementing-high-availability-for-cloud-sql\" title=\"Direct link to heading\">​</a></h2><p>Implementing Regional Availability for Cloud SQL is dead simple, it is one argument:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">availability_type = \"REGIONAL\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Using the <code>gcloud</code> command line utility, this would be:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud sql instances create postgresql-instance-1234 \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --availability-type=REGIONAL \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  --database-version= POSTGRES_9_6</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Using Terraform (with a complete set of options) it would look like:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">resource \"google_sql_database_instance\" \"postgres_ha\" {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  provider = google-beta</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  region = var.region</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  project = var.project</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  name = \"postgresql-instance-${random_id.instance_suffix.hex}\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  database_version = \"POSTGRES_9_6\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  settings {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   tier = var.tier</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   disk_size = var.disk_size</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   activation_policy = \"ALWAYS\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   disk_autoresize = true</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   disk_type = \"PD_SSD\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   **availability_type = \"REGIONAL\"**</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   backup_configuration {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">     enabled = true</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">     start_time = \"00:00\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   ip_configuration  {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">     ipv4_enabled = false</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">     private_network = google_compute_network.private_network.self_link</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   maintenance_window  {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">     day = 7</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">     hour = 0</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">     update_track = \"stable\"</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">   }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">  }</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"> } </span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Once deployed you will notice a few different items in the console, first from the instance overview page you can see that the High Availability option is <code>ENABLED</code> for your instance.</p><p><a target=\"_blank\" href=\"/assets/files/cloud-sql-ha-1-12d875328c3d6743bab7c41038d7e382.png\"><img loading=\"lazy\" src=\"/assets/images/cloud-sql-ha-1-12d875328c3d6743bab7c41038d7e382.png\" width=\"1310\" height=\"446\" class=\"img_ev3q\"></a></p><p>Second, you will see a Failover button enabled on the detailed management view for this instance.</p><p><a target=\"_blank\" href=\"/assets/files/cloud-sql-ha-2-39a03f8c41a267780563cbb20bafd2d4.png\"><img loading=\"lazy\" src=\"/assets/images/cloud-sql-ha-2-39a03f8c41a267780563cbb20bafd2d4.png\" width=\"1310\" height=\"612\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"failover\">Failover<a class=\"hash-link\" href=\"#failover\" title=\"Direct link to heading\">​</a></h2><p>Failovers and failbacks can be initiated manually or automatically (should the primary be unresponsive). A manual failover can be invoked by executing the command:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">gcloud sql instances failover postgresql-instance-1234</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>There is an <code>--async</code> option which will return immediately, invoking the failover operation asynchronously.</p><p>Failover can also be invoked from the Cloud Console using the Failover button shown previously. As an example I have created a connection to a regionally available Cloud SQL instance and started a command which runs a loop and prints out a counter:</p><p><a target=\"_blank\" href=\"/assets/files/cloud-sql-ha-3-6710a724106c4048213b24a2082b64cb.png\"><img loading=\"lazy\" src=\"/assets/images/cloud-sql-ha-3-6710a724106c4048213b24a2082b64cb.png\" width=\"1920\" height=\"1040\" class=\"img_ev3q\"></a></p><p>Now using the <code>gcloud</code> command shown earlier, I have invoked a manual failover of the Cloud SQL instance.</p><p>Once the failover is initiated, the client connection is dropped (as the server is momentarily unavailable):</p><p><a target=\"_blank\" href=\"/assets/files/cloud-sql-ha-4-bb4bcf4f70179371b1b26d96a92a4dff.png\"><img loading=\"lazy\" src=\"/assets/images/cloud-sql-ha-4-bb4bcf4f70179371b1b26d96a92a4dff.png\" width=\"1920\" height=\"1040\" class=\"img_ev3q\"></a></p><p>The connection can be immediately re-established afterwards, the state of the running query is lost - <strong><em>importantly no data is lost</em></strong> however. If your application clients had retry logic in their code and they weren't executing a long running query, chances are no one would notice! Once reconnecting normal database activities can be resumed:</p><p><a target=\"_blank\" href=\"/assets/files/cloud-sql-ha-5-6f8c7134a54b7a38444f5ddbdbcf960e.png\"><img loading=\"lazy\" src=\"/assets/images/cloud-sql-ha-5-6f8c7134a54b7a38444f5ddbdbcf960e.png\" width=\"1920\" height=\"1040\" class=\"img_ev3q\"></a></p><p>A quick check of the instance logs will show that the failover event has occured:</p><p><a target=\"_blank\" href=\"/assets/files/cloud-sql-ha-6-a4ab88ef121dbc8842347478cf0811d0.png\"><img loading=\"lazy\" src=\"/assets/images/cloud-sql-ha-6-a4ab88ef121dbc8842347478cf0811d0.png\" width=\"1310\" height=\"568\" class=\"img_ev3q\"></a></p><p>Now when you return to the instance page in the console you will see a Failback button, which indicates that your instance is being served by the standby:</p><p><a target=\"_blank\" href=\"/assets/files/cloud-sql-ha-7-25ae1613611767eea9c101c3a24f0632.png\"><img loading=\"lazy\" src=\"/assets/images/cloud-sql-ha-7-25ae1613611767eea9c101c3a24f0632.png\" width=\"1239\" height=\"641\" class=\"img_ev3q\"></a></p><p>Note that there may be a slight delay in the availability of this option as the replica is still being synched.</p><p>It is worth noting that nothing comes for free! When you run in REGIONAL or High Availability mode - you are effectively paying double the costs as compared to running in ZONAL mode. However availability and cost have always been trade-offs against one another - you get what you pay for...</p><blockquote><p>More information can be found at: <a href=\"https://cloud.google.com/sql/docs/postgres/high-availability\" target=\"_blank\" rel=\"noopener noreferrer\">https://cloud.google.com/sql/docs/postgres/high-availability</a></p></blockquote><p>Next up we will look at read replicas (and their ability to be promoted) as another high availability alternative in Cloud SQL.</p>",
            "url": "https://fullstackchronicles.io/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql",
            "title": "Google Cloud SQL – Availability, Replication, Failover for PostgreSQL – Part I",
            "summary": "CloudSQL HA",
            "date_modified": "2020-01-17T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "cloudsql",
                "gcp",
                "google-cloud-platform",
                "googlecloudplatform",
                "ha",
                "highavailability",
                "postgresql"
            ]
        },
        {
            "id": "sick-of-hearing-about-service-mesh-heres-what-you-need-to-know",
            "content_html": "<p><img loading=\"lazy\" alt=\"Service Mesh\" src=\"/assets/images/service-mesh-1-d7868fc724132b5e947edad350e8e1ed.png\" width=\"151\" height=\"106\" class=\"img_ev3q\"></p><p>So you’ve started delivering a new project and it’s all about this “Cloud Native” or “Microservices” thing. You’re a Delivery Manager or Software Engineer at some type of company and someone has lightly peppered a meeting with a term, ‘Mesh’.</p><p>They possibly said event mesh. Or better yet, they mentioned a service mesh. As time went on you kept hearing more and more about the service mesh. You’ve attempted to read up about it, digested a whole bunch of new terms and still didn’t completely understand what the Mesh even does, why you would need it or why the hype train around this technology shows no sign of stopping. This article is an attempt to provide a focused guide to the service mesh, and why it is so interesting.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"ok-so-what-is-this-thing\">Ok, so what is this thing?<a class=\"hash-link\" href=\"#ok-so-what-is-this-thing\" title=\"Direct link to heading\">​</a></h2><p>Truth be told, the service mesh is actually pretty simple. It’s built around the idea of small, repeatable bits of software, in this case userspace proxies, stuck very close to your services. This is called the <strong><em>data plane</em></strong>. In addition to the userspace proxies, you also get a bunch of management processes, which is referred to as the <strong><em>control plane</em></strong>. Simply put, the data plane (userspace proxies) intercepts all calls between services and the control plane (management processes) coordinates the wholesale behaviour of those proxies. This allows you to perform sweeping changes across your service landscape via the control planes API’s, operators and provides the capability to measure your mesh as a whole.</p><p>Before we get into the engineering of what the proxies are, let’s go with an example.</p><ul><li>The business has bought some software.</li><li>The engineers are tasked with deploying this software in their Kubernetes cluster.</li><li>The engineers first task is to containerise this application, expose its functionality to downstream applications and deploy it to the cluster in a repeatable, continuous fashion.</li><li>There’s a requirement in your organisation that says ‘I need all communications to this vendors software as TLS1.3’. Or, ‘I would like to measure all API latency from this application’.</li></ul><p>The engineer replies ‘I can’t make changes to a third party application! What do I do?’. Service mesh to the rescue.</p><p>Using a service mesh, you can deploy a proxy right next to your vendor container and in effect, abstract away the complexities of measurement and data transport mechanisms, and allow the vendor software to concentrate on it’s business logic.</p><p>This vendor container is now part of the <strong><em>service mesh</em></strong>.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"proxies\">Proxies<a class=\"hash-link\" href=\"#proxies\" title=\"Direct link to heading\">​</a></h2><p>When we talk about proxies, we usually discuss things in OSI model terminology, that is to say Layers 1 through 7. Most of the time when it comes to proxies, you’re comparing Layer 4 to Layer 7. Here’s a quick run-down:</p><p>Layer 4 (L4) -&gt; operates with the delivery of messages with no regard to the content of the messages. They would simply forward network packets to and from the server without inspecting any part of the packets.</p><p>Layer 7 (L7) -&gt; this is a higher level, application layer. This deals with the actual content of the message. If you were routing network traffic, you could do this at L7 in a much more sophisticated way because you can now make decisions based on the packets messages within.</p><p>Why pick between L4 and L7? <em>Speed</em>.</p><p>Back to the service mesh, these userspace proxies are L7-aware TCP proxies. Think <em><strong>NGINX</strong></em> or <em><strong>haproxy</strong></em>. There are different proxies; <a href=\"https://linkerd.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Linkerd</a> is an ultralight service mesh for Kubernetes. The most popular is <a href=\"https://www.envoyproxy.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Envoy</a>, which was created by the ride-share company Lyft. Above, I also mentioned NGINX and haproxy which are also quite popular. So what differentiates NGINX proxies from the service mesh? Their <em>focus</em>. You would implement NGINX as an Ingress proxy (traffic entering your network), but when it comes to proxies that focus on traffic between services, that’s when the service mesh proxy comes in to play.</p><p>Ok, probably time for a diagram now that we’ve explained the Data Plane.</p><p><a target=\"_blank\" href=\"/assets/files/service-mesh-74fe164528e1f23a50f21eb48aeeb2c0.png\"><img loading=\"lazy\" src=\"/assets/images/service-mesh-74fe164528e1f23a50f21eb48aeeb2c0.png\" width=\"871\" height=\"562\" class=\"img_ev3q\"></a></p><p>Tune in for part 2 for when we discuss the Control Plane!</p>",
            "url": "https://fullstackchronicles.io/sick-of-hearing-about-service-mesh-heres-what-you-need-to-know",
            "title": "Sick of hearing about Service Mesh? Here’s what you need to know...",
            "summary": "Service Mesh",
            "date_modified": "2020-01-09T00:00:00.000Z",
            "author": {
                "name": "Tom Klimovski",
                "url": "https://github.com/tomklimovskigamma"
            },
            "tags": [
                "k8s",
                "kubernetes",
                "service-mesh",
                "servicemesh"
            ]
        },
        {
            "id": "ultimate-aws-to-gcp-thesaurus",
            "content_html": "<p><img loading=\"lazy\" alt=\"aws to gcp thesauraus\" src=\"/assets/images/aws-to-gcp-thesauraus-70222c00b6dfca3fe72b0cebd609acf4.png\" width=\"250\" height=\"110\" class=\"img_ev3q\"></p><p>There are many posts available which map analogous services between the different cloud providers, but this post attempts to go a step further and map additional concepts, terms, and configuration options to be the definitive thesaurus for cloud practitioners familiar with AWS looking to fast track their familiarisation with GCP.</p><p>It should be noted that AWS and GCP are fundamentally different platforms, nowhere is this more apparent than in the way networking is implemented between the two providers, see: <a href=\"https://cloudywithachanceofbigdata.com/gcp-networking-for-aws-professionals/\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>GCP Networking for AWS Professionals</strong></a></p><p>This post is focused on the core infrastructure, networking and security services offered by the two major cloud providers, I will do a future post on higher level services such as the ML/AI offerings from the respective providers.</p><p>Furthermore this will be a living post which I will continue to update, I encourage comments from readers on additional mappings which I will incorporate into the post as well.</p><p>I have broken this down into sections based upon the layout of the AWS Console.</p><ul><li><a href=\"#compute\"><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAVFBMVEUAAACAgIBVVVVmZmZZWWZVWmNVWWZSWmNVXWRTW2NUWmRUW2VTW2RUXGNUW2RUXGVUW2VUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2RUW2RUW2T///8m/aZOAAAAGnRSTlMAAgMFFDY8PkJfhYaHiI+qtMLg5Obo6uv5/jprlmMAAAABYktHRBsCYNSkAAAAp0lEQVQ4y92U2w6CMBBEKyggKspF1Pn/D/VBKGWnuzGGpInzwENzEnZOunXuE8D6BtkabGGkO+UTtm9eMFNP4A3Px/WYOSUVej/fYeeMzNOCmhEI4Hsw5ir669/ANuqPQPJZK62FT++PWkufy7loLUvReSpwVUYDqbUF/mvrO4qQKzEorS/KmtKM+XkMsVG9uBvtTNq9Fv5kvE/2pz17wp+M95nqsX8DRM8xpWml3B0AAAAASUVORK5CYII=\" width=\"40\" height=\"40\" class=\"img_ev3q\"> <strong>Compute</strong></a></li><li><a href=\"#storage\"><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAn1BMVEUAAACAgIBmZmZJSW1OYmJbW1taWmlRXWhVXmZTWmdSW2VTXWZTWWNVW2VUWmRUWmNUXGRTW2NTW2VVWmRTWmRUW2RTWmNUWmVUWmVUXGRUXGNUXGVVXGRUW2RVXGRUXGRUW2RUW2RUW2RUXGRTWmRUW2RUW2RUW2RUW2VUW2RUW2RUW2RUWmRUW2RVW2RUW2RUW2RUW2RUWmRUW2T///9nDNUkAAAAMnRSTlMAAgUHDQ4RFh4lNTdNUVJVYWJlaW5wcXd8fYiOsrO1vcLFxtHZ5+7w8fL19/j5+vv8/cnWIDMAAAABYktHRDSpsen9AAAA8ElEQVQ4y+2SVxOCMBCEUewdFXsvWLHt//9vEg+UkFxwfHafMpdvkt2btaxQ9ZGihqVR4QRVrsq1jsF8M+zHdXtoyC2mbjkx074JqL8A7TsGGlCKU3/NVFKAh3iOPc0UUgxr8SS10E4P6KZ7FB7muKSBfmQjLUxoRQWTYbSf6cKwIKNfwCAFrUKr4KpT4hsma1dlGpbQBCumYQnZOJtzyIEkMNd0KULonwMza9k/CxZwGsf9s2DWv9p0yuNg9LjEjDxOsDCCFS/y6FWMoFV0yKNTNK/n6z3+wZ9BH3YaRw1/94AXNeTTA17UkKgHvERDnvUIWGgOKx/VAAAAAElFTkSuQmCC\" width=\"40\" height=\"40\" class=\"img_ev3q\"> <strong>Storage</strong></a></li><li><a href=\"#database\"><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAgVBMVEUAAABNZmZdXV1VVWZQYGBVVWNRXl5VWWVUXGRVXWRTWmVTWmVUW2VVXGNTXGNVXGVUW2RTWmNVXGRUWmVVW2RUW2NUXGRUWmRUW2NTW2RUWmRVW2VUW2RVW2RUW2RUXGNUW2RUW2VUW2RUW2RUW2RUW2RUW2RUW2RUW2RUW2T////mzGsFAAAAKXRSTlMACgsPEBITP0BCREdJS1BvcHF1d3h5eoKDhL2+v8HCw+7x8vP3+fr9/kFW+eoAAAABYktHRCpTvtSeAAAAqklEQVQ4y+2VRw7CMBBFH6H3FmpwCKR57n9BFiESIHkCEt7lb+zF8zR9jcGLJiYRpxKzqLmDFV2nihvbIuy40wXLohwCYGSrV7aXCIBUesDl7AT7cgNABOBq3CEroj74J9gsAOJmLv6IreX1An5Ro/mtax8DRzfFO9iaojXFC5hKVzfFQO4ARLLWM2+eS2oueRgoa2+Vy6y67kp9NvZYPxrFmRvLzNTPh/AAAUNTBbU39TMAAAAASUVORK5CYII=\" width=\"40\" height=\"40\" class=\"img_ev3q\"> <strong>Database</strong></a></li><li><a href=\"#networking\"><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAACK1BMVEUAAAAAAACAgIBVVVVAQIBVVVVJSW1gYGBVVXFdXV1VVWpOYmJbW1tQYGBaWmlVVWNRXl5ZWWZVVWFRXWhZWWRVYGBSXGZYWGJVXmhYWGFVXmZSWmNYWGhVXWRXV2ZVXGNTWmdXXmVVXGJTWWZXXWRVW2FRXWNVW2ZVWmVSXGZVWmRTXWJSW2VSW2RSWmNVWWVUXGRSWmJVXWRTWmVVXGRUW2JTWmVVXGNTWmRTWWNTXGNVW2VTXGVVW2RUWmVTXGRVW2NTW2RVWmNUXGRTW2NVWmVUXGRTW2NUXGNTW2VVWmRUXGNVWmRUW2VTW2RUW2VTWmRVXGVTWmNVXGVUW2RVW2RUWmRUXGRUW2NTW2RUWmRUW2VTW2RUXGVUW2RTWmNUXGVTWmNUW2RTWmVUW2RUW2NTXGRTXGRUW2NTXGRTW2NUW2RUWmRTW2VUXGRUW2RUXGNTW2RUXGVUW2RUW2RUW2RVWmVUW2RUW2NVXGRUW2NUWmRVW2RUW2RUWmRVW2VUW2RUXGNVW2RUW2NUW2RVW2RUWmRUW2RTW2VVW2RUXGRUW2RVW2VUXGRUW2RTW2RVW2NVW2RTW2RUW2RUW2RTWmRUW2RTXGRUW2RUW2RTW2RUW2RUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2RUW2RUW2RUW2RUW2VUW2RUW2RUW2RUW2RUW2RUW2RVW2RUWmRUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2T////+WQQnAAAAt3RSTlMAAQIDBAYHCAkLDA0OEBESExQVFhcYGRobHR4fICEjJCUmJygpKiwtMDIzNDU4Pj9AQUJERUZHSEpNUFFTV1hZWlxdXl9gYWJkZWZnaWprbW5vcXJze3+Ag4SFhoqLjI2OkJGTlJWWmZqcn6ChoqSmp6iqq62ur7Cxsra6u7y9vsLDx8jJysvMzc3Oz9DR0tPT09bX2Nnb3ODh4uPk5efo6err7O7v8PHy8/T19vf3+Pn6+/z9/f4Rdgt0AAAAAWJLR0S4Tb8m9gAAAlRJREFUGBmFwQdDjAEAx+HfddknDaOUQkSRsioNq8hOVvamZJYIpZLRsGcZJ5yMlOM67//rebvWyY3n4R+pRxs+fv7cUb8njkDi6jXIVR6GX4mf9OHQsmlhYbFZZ5x6OQU/xrXrRjgDZrToJn7s1p0xDIl4r/TkwpwY/vdWi/CyT78luc6OZYRZslvwkiu1nbvqVI2Ff61UJd4mlBdaIf6NsvBmnX9cJ/GhWKUMSyj9ImkPPmSriiFbe2Q8qiyLxofdup0+in4bpfMz8OOipHcb6DO1S9vxa87eU6+kA5j2qpqALGtdRjLQqqUEcVBlwBdNJIj5egE4NZogxqsLeK14ghinLqBCxQSRoufACtnDCeykTgCWW7o9mUAKen8lYprWrs6j2QtTfJo3d32DVIxHZJWhQDoLGZS8v6ZpQHOHTB3NTf3aWi5tseFD0kM5JaceJBGItcSlpkQpsUmuEit+JTSqtyQUidCSXjUm8D9bWkYUm77qVSogAalt+rqJqMw0G8MsO7sk92OpchImCdOky9ITt/R9B0MKZdRc79bPXDwkPHJ/qvt6raECBnUoHxY4/0TjIeERY/SkwDrZGTBdrzFVKxtTbLEUS58cXcH0VjH0i9QnK1Cn5cCqb5K+5WHKVC0Q6lAEA57pcAj5xo8wmN2jiqIr6p4JhHcba7Ae0VMGLTbksEs7gGM6DZTqCKZdkt0hdxpD0u+71Z5vAeq1GFiiOkyWde1yt6bhzRaBxwVtBrboPP0ibfi2Wo6M0ZkO5RGE5Zr6XCWokKJ7PXe3hTDSX044BELj8dR3AAAAAElFTkSuQmCC\" width=\"40\" height=\"40\" class=\"img_ev3q\"> <strong>Networking &amp; Content Delivery</strong></a></li><li><a href=\"#security\"><img loading=\"lazy\" src=\"data:image/png;base64,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\" width=\"40\" height=\"40\" class=\"img_ev3q\"> <strong>Security, Identity, &amp; Compliance</strong></a></li></ul><a name=\"compute\"></a><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"-compute\"><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAVFBMVEUAAACAgIBVVVVmZmZZWWZVWmNVWWZSWmNVXWRTW2NUWmRUW2VTW2RUXGNUW2RUXGVUW2VUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2RUW2RUW2T///8m/aZOAAAAGnRSTlMAAgMFFDY8PkJfhYaHiI+qtMLg5Obo6uv5/jprlmMAAAABYktHRBsCYNSkAAAAp0lEQVQ4y92U2w6CMBBEKyggKspF1Pn/D/VBKGWnuzGGpInzwENzEnZOunXuE8D6BtkabGGkO+UTtm9eMFNP4A3Px/WYOSUVej/fYeeMzNOCmhEI4Hsw5ir669/ANuqPQPJZK62FT++PWkufy7loLUvReSpwVUYDqbUF/mvrO4qQKzEorS/KmtKM+XkMsVG9uBvtTNq9Fv5kvE/2pz17wp+M95nqsX8DRM8xpWml3B0AAAAASUVORK5CYII=\" width=\"40\" height=\"40\" class=\"img_ev3q\"> Compute<a class=\"hash-link\" href=\"#-compute\" title=\"Direct link to heading\">​</a></h2><table><thead><tr><th><img loading=\"lazy\" src=\"data:image/png;base64,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\" width=\"84\" height=\"50\" class=\"img_ev3q\"></th><th><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAAyCAYAAAAEA2g/AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAATZSURBVHjaYmSgMXjtYmYPpByA2ACIFaA0OvgAxBeA+AGU3iC659RDWroLIIAYaejZBCAOAGIBMo0BBcICEKZFIAAEECMNPNwAjWFqAlAANFAzAAACiJFKHpaHOs6BxjlnAjQAPlJqEEAAMVLB0/lQB9ELgLJAANDzFykxBCCAGCnwMD/UwwkMAwMSgJ5fSK5mgABiosDTBwbQ0wwLlUMXhNTun0+ufoAAYqTA0wYD6GmGE2Im8IJvTbNjIqlmAAQQOTG+YRB5GpzkgTFfT6o5AAHESGJs9wOpgkHkaWQQAIz5jcSaBRBAjCR42h6axAejp2GtPwWg54mq6gACiIWEfL2AQrdvgOIL6FURNFANoIWlARmeZoC2EEFuDCTGMQABxEikx+uhLTKat7rQW39EehoZOABj/SAhRQABxEhkbD8go839AdrQOEhOaAHtjV+qFDThiLg5qfYeAHrckZAigAAiplQvwOdpZrnvcIwEQD0sBXI9DQKgxgnQ0wZQs0iKcWApb09IEUAAERPj96HdSQYmsZ8MrGpfGViAnmSR+4FV/f8fTAz//zFcYOL6B0riG9hc3lLUsQB6gpwUR7BuBwggRgKe9gc5nkX1KwO76QecniWU9EB5FhgABynwPDk1igC+Eh4ggPAmdVaNLw7cUU8ZuINfkOtpBmghdeDXHuH9QCxPjgHQwmoBGfbiBAABhNPjQEfGcwW8TKDAw9gccgFkLpn6SW04gdryOO0CCCAmHJ7uh4awAAN1AbiuBZpfT0asfyQx1gWgnu/HJgkQQEw4PE3rZmkDOZ6HNoBITinYPA8QQEzoyZuObXGQ5/3JKCgZyPQ8SrIHCCAmJE/L03kk5QKpHoEm9wfkDlsBPQ8vXAECiAmtaSlAR087AKs4csbOHlBSvsA4AAHEBI1tewbaDxRSw9MU1yywVh1AAMFivIECwx5Ak+wDOnn6AaVlC4gACCBGaN4m1bAP0PJgAXKTFGpWAwP2sTiqxjQ05kAFcQAZ2hUAAgjkcVKHhz9APXART+PHH63MoFnyhpbWpLbqCgACiInEECPoaRAAym9EinWa5mlgSb+QjCrYASCAmBhIGzicQMjTaJ6fQI+CDOj5iSRWjQYAAcRCanePFAcBPVxIxxJ7AQk1kwJAAJEyvPyA0r41jQFJjSGAACLJ44PY06DkTlKkAAQQKR43GMweR26OEgMAAogUjwsAqyn9Qex3klqeAAHERGISLhjEHiel9fkAIICYGEgbxUygYASFlskc1LdXIKW/ABBATGT0cRcMJs8DPZ1PRl/jAEAAkdtWZzj3W+BAzidDUAPlwJnwNR/p7Fl+aIszgcxepQJAADFC29brSWm63vrDw5DzyYDhy39WijygcCV7IBLJBmDVFwgQQLBSfQK9PT2AAOxXgABigjYtQePWG0aApzfAJhQBAogJrar6MIw9/QG5OgYIICakDsVDHAMIw8HT4KoYuVkLEEBMePrRw83TKMtEAAKICUtXciHM88PI0xjr4QACiAlHP3rh/T9cCbmfDD4M8TwdgM3TIAAQQDg7Keoejxd+/s9qwEDetM2Al96g3iS+VVAAAUTUGhiTlSGUjGjSswED8vAEYtbAAAQQSevcgAEAayo6QDsFDgPs8QcMiKmoDaQMRgAEGADHTLziPW4o6AAAAABJRU5ErkJggg==\" width=\"62\" height=\"50\" class=\"img_ev3q\"></th></tr></thead><tbody><tr><td>EC2 (Elastic Compute Cloud)</td><td>GCE (Google Compute Engine)</td></tr><tr><td>Availability Zone</td><td>Zone</td></tr><tr><td>Instance</td><td>VM Instance</td></tr><tr><td>Instance Family</td><td>Machine Family</td></tr><tr><td>Instance Type</td><td>Machine Type</td></tr><tr><td>Amazon Machine Image (AMI)</td><td>Image</td></tr><tr><td>IAM Role (for an EC2 Instance)</td><td>Service Account</td></tr><tr><td>Security Groups</td><td>VPC Firewall Rules (ALLOW)</td></tr><tr><td>Tag</td><td>Label</td></tr><tr><td>Termination Protection</td><td>Deletion Protection</td></tr><tr><td>Reserved Instances</td><td>Committed Use Discounts</td></tr><tr><td>Capacity Reservation</td><td>Reservation</td></tr><tr><td>User Data</td><td>Startup Script</td></tr><tr><td>Spot Instances</td><td>Preemptible VMs</td></tr><tr><td>Dedicated Instances</td><td>Sole Tenancy</td></tr><tr><td>EBS Volume</td><td>Persistent Disk</td></tr><tr><td>Auto Scaling Group</td><td>Managed Instance Group</td></tr><tr><td>Launch Configuration</td><td>Instance Template</td></tr><tr><td>ELB Listener</td><td>URL Map (Load Balancer)</td></tr><tr><td>ELB Target Group</td><td>Backend/ Instance Group</td></tr><tr><td>Instance Storage (ephemeral)</td><td>Local SSDs</td></tr><tr><td>EBS Snapshots</td><td>Snapshots</td></tr><tr><td>Keypair</td><td>SSH Keys</td></tr><tr><td>Elastic IP</td><td>External IP</td></tr><tr><td>Lambda</td><td>Google Cloud Functions</td></tr><tr><td>Elastic Beanstalk</td><td>Google App Engine</td></tr><tr><td>Elastic Container Registry (ECR)</td><td>Google Container Registry (GCR)</td></tr><tr><td>Elastic Container Service (ECS)</td><td>Google Kubernetes Engine (GKE)</td></tr><tr><td>Elastic Kubernetes Service (EKS)</td><td>Google Kubernetes Engine (GKE)</td></tr><tr><td>AWS Fargate</td><td>Cloud Run</td></tr><tr><td>AWS Service Quotas</td><td>Allocation Quotas</td></tr><tr><td>Account (within an Organisation)<!-- -->†</td><td>Project</td></tr><tr><td>Region</td><td>Region</td></tr><tr><td>AWS Cloud​Formation</td><td>Cloud Deployment Manager</td></tr></tbody></table><a name=\"storage\"></a><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"-storage\"><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAn1BMVEUAAACAgIBmZmZJSW1OYmJbW1taWmlRXWhVXmZTWmdSW2VTXWZTWWNVW2VUWmRUWmNUXGRTW2NTW2VVWmRTWmRUW2RTWmNUWmVUWmVUXGRUXGNUXGVVXGRUW2RVXGRUXGRUW2RUW2RUW2RUXGRTWmRUW2RUW2RUW2RUW2VUW2RUW2RUW2RUWmRUW2RVW2RUW2RUW2RUW2RUWmRUW2T///9nDNUkAAAAMnRSTlMAAgUHDQ4RFh4lNTdNUVJVYWJlaW5wcXd8fYiOsrO1vcLFxtHZ5+7w8fL19/j5+vv8/cnWIDMAAAABYktHRDSpsen9AAAA8ElEQVQ4y+2SVxOCMBCEUewdFXsvWLHt//9vEg+UkFxwfHafMpdvkt2btaxQ9ZGihqVR4QRVrsq1jsF8M+zHdXtoyC2mbjkx074JqL8A7TsGGlCKU3/NVFKAh3iOPc0UUgxr8SS10E4P6KZ7FB7muKSBfmQjLUxoRQWTYbSf6cKwIKNfwCAFrUKr4KpT4hsma1dlGpbQBCumYQnZOJtzyIEkMNd0KULonwMza9k/CxZwGsf9s2DWv9p0yuNg9LjEjDxOsDCCFS/y6FWMoFV0yKNTNK/n6z3+wZ9BH3YaRw1/94AXNeTTA17UkKgHvERDnvUIWGgOKx/VAAAAAElFTkSuQmCC\" width=\"40\" height=\"40\" class=\"img_ev3q\"> Storage<a class=\"hash-link\" href=\"#-storage\" title=\"Direct link to heading\">​</a></h2><table><thead><tr><th><img loading=\"lazy\" src=\"data:image/png;base64,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\" width=\"84\" height=\"50\" class=\"img_ev3q\"></th><th><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAAyCAYAAAAEA2g/AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAATZSURBVHjaYmSgMXjtYmYPpByA2ACIFaA0OvgAxBeA+AGU3iC659RDWroLIIAYaejZBCAOAGIBMo0BBcICEKZFIAAEECMNPNwAjWFqAlAANFAzAAACiJFKHpaHOs6BxjlnAjQAPlJqEEAAMVLB0/lQB9ELgLJAANDzFykxBCCAGCnwMD/UwwkMAwMSgJ5fSK5mgABiosDTBwbQ0wwLlUMXhNTun0+ufoAAYqTA0wYD6GmGE2Im8IJvTbNjIqlmAAQQOTG+YRB5GpzkgTFfT6o5AAHESGJs9wOpgkHkaWQQAIz5jcSaBRBAjCR42h6axAejp2GtPwWg54mq6gACiIWEfL2AQrdvgOIL6FURNFANoIWlARmeZoC2EEFuDCTGMQABxEikx+uhLTKat7rQW39EehoZOABj/SAhRQABxEhkbD8go839AdrQOEhOaAHtjV+qFDThiLg5qfYeAHrckZAigAAiplQvwOdpZrnvcIwEQD0sBXI9DQKgxgnQ0wZQs0iKcWApb09IEUAAERPj96HdSQYmsZ8MrGpfGViAnmSR+4FV/f8fTAz//zFcYOL6B0riG9hc3lLUsQB6gpwUR7BuBwggRgKe9gc5nkX1KwO76QecniWU9EB5FhgABynwPDk1igC+Eh4ggPAmdVaNLw7cUU8ZuINfkOtpBmghdeDXHuH9QCxPjgHQwmoBGfbiBAABhNPjQEfGcwW8TKDAw9gccgFkLpn6SW04gdryOO0CCCAmHJ7uh4awAAN1AbiuBZpfT0asfyQx1gWgnu/HJgkQQEw4PE3rZmkDOZ6HNoBITinYPA8QQEzoyZuObXGQ5/3JKCgZyPQ8SrIHCCAmJE/L03kk5QKpHoEm9wfkDlsBPQ8vXAECiAmtaSlAR087AKs4csbOHlBSvsA4AAHEBI1tewbaDxRSw9MU1yywVh1AAMFivIECwx5Ak+wDOnn6AaVlC4gACCBGaN4m1bAP0PJgAXKTFGpWAwP2sTiqxjQ05kAFcQAZ2hUAAgjkcVKHhz9APXART+PHH63MoFnyhpbWpLbqCgACiInEECPoaRAAym9EinWa5mlgSb+QjCrYASCAmBhIGzicQMjTaJ6fQI+CDOj5iSRWjQYAAcRCanePFAcBPVxIxxJ7AQk1kwJAAJEyvPyA0r41jQFJjSGAACLJ44PY06DkTlKkAAQQKR43GMweR26OEgMAAogUjwsAqyn9Qex3klqeAAHERGISLhjEHiel9fkAIICYGEgbxUygYASFlskc1LdXIKW/ABBATGT0cRcMJs8DPZ1PRl/jAEAAkdtWZzj3W+BAzidDUAPlwJnwNR/p7Fl+aIszgcxepQJAADFC29brSWm63vrDw5DzyYDhy39WijygcCV7IBLJBmDVFwgQQLBSfQK9PT2AAOxXgABigjYtQePWG0aApzfAJhQBAogJrar6MIw9/QG5OgYIICakDsVDHAMIw8HT4KoYuVkLEEBMePrRw83TKMtEAAKICUtXciHM88PI0xjr4QACiAlHP3rh/T9cCbmfDD4M8TwdgM3TIAAQQDg7Keoejxd+/s9qwEDetM2Al96g3iS+VVAAAUTUGhiTlSGUjGjSswED8vAEYtbAAAQQSevcgAEAayo6QDsFDgPs8QcMiKmoDaQMRgAEGADHTLziPW4o6AAAAABJRU5ErkJggg==\" width=\"62\" height=\"50\" class=\"img_ev3q\"></th></tr></thead><tbody><tr><td>Simple Storage Service (S3)</td><td>Google Cloud Storage (GCS)</td></tr><tr><td>Standard Storage Class</td><td>Standard Storage Class</td></tr><tr><td>Infrequent Access Storage Class</td><td>Nearline Storage Class</td></tr><tr><td>Amazon Glacier</td><td>Coldline Storage Class</td></tr><tr><td>Lifecycle Policy</td><td>Retention Policy</td></tr><tr><td>Tags</td><td>Labels</td></tr><tr><td>Snowball</td><td>Transfer Appliance</td></tr><tr><td>Requester Pays</td><td>Requester Pays</td></tr><tr><td>Region</td><td>Location Type/Location</td></tr><tr><td>Object Lock</td><td>Hold</td></tr><tr><td>Vault Lock (Glacier)</td><td>Bucket Lock</td></tr><tr><td>Multi Part Upload</td><td>Parallel Composite Transfer</td></tr><tr><td>Cross-Origin Resource Sharing (CORS)</td><td>Cross-Origin Resource Sharing (CORS)</td></tr><tr><td>Static Website Hosting</td><td>Bucket Website Configuration</td></tr><tr><td>S3 Access Points</td><td>VPC Service Controls</td></tr><tr><td>Object Notifications</td><td>Pub/Sub Notifications for Cloud Storage</td></tr><tr><td>Presigned URL</td><td>Signed URL</td></tr><tr><td>Transfer Acceleration</td><td>Storage Transfer Service</td></tr><tr><td>Elastic File System (EFS)</td><td>Cloud Filestore</td></tr><tr><td>AWS DataSync</td><td>Transfer Service for on-premises data</td></tr><tr><td>ETag</td><td>ETag</td></tr><tr><td>Bucket</td><td>Bucket</td></tr><tr><td><code>aws s3</code></td><td><code>gsutil</code></td></tr></tbody></table><a name=\"database\"></a><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"-database\"><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAgVBMVEUAAABNZmZdXV1VVWZQYGBVVWNRXl5VWWVUXGRVXWRTWmVTWmVUW2VVXGNTXGNVXGVUW2RTWmNVXGRUWmVVW2RUW2NUXGRUWmRUW2NTW2RUWmRVW2VUW2RVW2RUW2RUXGNUW2RUW2VUW2RUW2RUW2RUW2RUW2RUW2RUW2RUW2T////mzGsFAAAAKXRSTlMACgsPEBITP0BCREdJS1BvcHF1d3h5eoKDhL2+v8HCw+7x8vP3+fr9/kFW+eoAAAABYktHRCpTvtSeAAAAqklEQVQ4y+2VRw7CMBBFH6H3FmpwCKR57n9BFiESIHkCEt7lb+zF8zR9jcGLJiYRpxKzqLmDFV2nihvbIuy40wXLohwCYGSrV7aXCIBUesDl7AT7cgNABOBq3CEroj74J9gsAOJmLv6IreX1An5Ro/mtax8DRzfFO9iaojXFC5hKVzfFQO4ARLLWM2+eS2oueRgoa2+Vy6y67kp9NvZYPxrFmRvLzNTPh/AAAUNTBbU39TMAAAAASUVORK5CYII=\" width=\"40\" height=\"40\" class=\"img_ev3q\"> Database<a class=\"hash-link\" href=\"#-database\" title=\"Direct link to heading\">​</a></h2><table><thead><tr><th><img loading=\"lazy\" src=\"data:image/png;base64,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\" width=\"84\" height=\"50\" class=\"img_ev3q\"></th><th><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAAyCAYAAAAEA2g/AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAATZSURBVHjaYmSgMXjtYmYPpByA2ACIFaA0OvgAxBeA+AGU3iC659RDWroLIIAYaejZBCAOAGIBMo0BBcICEKZFIAAEECMNPNwAjWFqAlAANFAzAAACiJFKHpaHOs6BxjlnAjQAPlJqEEAAMVLB0/lQB9ELgLJAANDzFykxBCCAGCnwMD/UwwkMAwMSgJ5fSK5mgABiosDTBwbQ0wwLlUMXhNTun0+ufoAAYqTA0wYD6GmGE2Im8IJvTbNjIqlmAAQQOTG+YRB5GpzkgTFfT6o5AAHESGJs9wOpgkHkaWQQAIz5jcSaBRBAjCR42h6axAejp2GtPwWg54mq6gACiIWEfL2AQrdvgOIL6FURNFANoIWlARmeZoC2EEFuDCTGMQABxEikx+uhLTKat7rQW39EehoZOABj/SAhRQABxEhkbD8go839AdrQOEhOaAHtjV+qFDThiLg5qfYeAHrckZAigAAiplQvwOdpZrnvcIwEQD0sBXI9DQKgxgnQ0wZQs0iKcWApb09IEUAAERPj96HdSQYmsZ8MrGpfGViAnmSR+4FV/f8fTAz//zFcYOL6B0riG9hc3lLUsQB6gpwUR7BuBwggRgKe9gc5nkX1KwO76QecniWU9EB5FhgABynwPDk1igC+Eh4ggPAmdVaNLw7cUU8ZuINfkOtpBmghdeDXHuH9QCxPjgHQwmoBGfbiBAABhNPjQEfGcwW8TKDAw9gccgFkLpn6SW04gdryOO0CCCAmHJ7uh4awAAN1AbiuBZpfT0asfyQx1gWgnu/HJgkQQEw4PE3rZmkDOZ6HNoBITinYPA8QQEzoyZuObXGQ5/3JKCgZyPQ8SrIHCCAmJE/L03kk5QKpHoEm9wfkDlsBPQ8vXAECiAmtaSlAR087AKs4csbOHlBSvsA4AAHEBI1tewbaDxRSw9MU1yywVh1AAMFivIECwx5Ak+wDOnn6AaVlC4gACCBGaN4m1bAP0PJgAXKTFGpWAwP2sTiqxjQ05kAFcQAZ2hUAAgjkcVKHhz9APXART+PHH63MoFnyhpbWpLbqCgACiInEECPoaRAAym9EinWa5mlgSb+QjCrYASCAmBhIGzicQMjTaJ6fQI+CDOj5iSRWjQYAAcRCanePFAcBPVxIxxJ7AQk1kwJAAJEyvPyA0r41jQFJjSGAACLJ44PY06DkTlKkAAQQKR43GMweR26OEgMAAogUjwsAqyn9Qex3klqeAAHERGISLhjEHiel9fkAIICYGEgbxUygYASFlskc1LdXIKW/ABBATGT0cRcMJs8DPZ1PRl/jAEAAkdtWZzj3W+BAzidDUAPlwJnwNR/p7Fl+aIszgcxepQJAADFC29brSWm63vrDw5DzyYDhy39WijygcCV7IBLJBmDVFwgQQLBSfQK9PT2AAOxXgABigjYtQePWG0aApzfAJhQBAogJrar6MIw9/QG5OgYIICakDsVDHAMIw8HT4KoYuVkLEEBMePrRw83TKMtEAAKICUtXciHM88PI0xjr4QACiAlHP3rh/T9cCbmfDD4M8TwdgM3TIAAQQDg7Keoejxd+/s9qwEDetM2Al96g3iS+VVAAAUTUGhiTlSGUjGjSswED8vAEYtbAAAQQSevcgAEAayo6QDsFDgPs8QcMiKmoDaQMRgAEGADHTLziPW4o6AAAAABJRU5ErkJggg==\" width=\"62\" height=\"50\" class=\"img_ev3q\"></th></tr></thead><tbody><tr><td>Relational Database Service (RDS)</td><td>Cloud SQL</td></tr><tr><td>DynamoDB</td><td>Cloud Datastore</td></tr><tr><td>ElastiCache</td><td>Cloud Memorystore</td></tr><tr><td>Table (DynamoDB)</td><td>Kind (Cloud Datastore)</td></tr><tr><td>Item (DynamoDB)</td><td>Entity (Cloud Datastore)</td></tr><tr><td>Partition Key (DynamoDB)</td><td>Key (Cloud Datastore)</td></tr><tr><td>Attributes (DynamoDB)</td><td>Properties (Cloud Datastore)</td></tr><tr><td>Local Secondary Index (DynamoDB)</td><td>Composite Index (Cloud Datastore)</td></tr><tr><td>Elastic Map Reduce (EMR)</td><td>Cloud DataProc</td></tr><tr><td>Athena</td><td>Big Query</td></tr><tr><td>AWS Glue</td><td>Cloud DataFlow</td></tr><tr><td>Glue Catalog</td><td>Data Catalog</td></tr><tr><td>Amazon Simple Notification Service (SNS)</td><td>Cloud PubSub (push subscription)</td></tr><tr><td>Amazon Kinesis</td><td>Cloud PubSub</td></tr><tr><td>Amazon Simple Queue Service (SQS)</td><td>Cloud PubSub (poll and pull mode)</td></tr></tbody></table><a name=\"networking\"></a><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"-networking--content-delivery\"><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAACK1BMVEUAAAAAAACAgIBVVVVAQIBVVVVJSW1gYGBVVXFdXV1VVWpOYmJbW1tQYGBaWmlVVWNRXl5ZWWZVVWFRXWhZWWRVYGBSXGZYWGJVXmhYWGFVXmZSWmNYWGhVXWRXV2ZVXGNTWmdXXmVVXGJTWWZXXWRVW2FRXWNVW2ZVWmVSXGZVWmRTXWJSW2VSW2RSWmNVWWVUXGRSWmJVXWRTWmVVXGRUW2JTWmVVXGNTWmRTWWNTXGNVW2VTXGVVW2RUWmVTXGRVW2NTW2RVWmNUXGRTW2NVWmVUXGRTW2NUXGNTW2VVWmRUXGNVWmRUW2VTW2RUW2VTWmRVXGVTWmNVXGVUW2RVW2RUWmRUXGRUW2NTW2RUWmRUW2VTW2RUXGVUW2RTWmNUXGVTWmNUW2RTWmVUW2RUW2NTXGRTXGRUW2NTXGRTW2NUW2RUWmRTW2VUXGRUW2RUXGNTW2RUXGVUW2RUW2RUW2RVWmVUW2RUW2NVXGRUW2NUWmRVW2RUW2RUWmRVW2VUW2RUXGNVW2RUW2NUW2RVW2RUWmRUW2RTW2VVW2RUXGRUW2RVW2VUXGRUW2RTW2RVW2NVW2RTW2RUW2RUW2RTWmRUW2RTXGRUW2RUW2RTW2RUW2RUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2RUW2RUW2RUW2RUW2VUW2RUW2RUW2RUW2RUW2RUW2RVW2RUWmRUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2T////+WQQnAAAAt3RSTlMAAQIDBAYHCAkLDA0OEBESExQVFhcYGRobHR4fICEjJCUmJygpKiwtMDIzNDU4Pj9AQUJERUZHSEpNUFFTV1hZWlxdXl9gYWJkZWZnaWprbW5vcXJze3+Ag4SFhoqLjI2OkJGTlJWWmZqcn6ChoqSmp6iqq62ur7Cxsra6u7y9vsLDx8jJysvMzc3Oz9DR0tPT09bX2Nnb3ODh4uPk5efo6err7O7v8PHy8/T19vf3+Pn6+/z9/f4Rdgt0AAAAAWJLR0S4Tb8m9gAAAlRJREFUGBmFwQdDjAEAx+HfddknDaOUQkSRsioNq8hOVvamZJYIpZLRsGcZJ5yMlOM67//rebvWyY3n4R+pRxs+fv7cUb8njkDi6jXIVR6GX4mf9OHQsmlhYbFZZ5x6OQU/xrXrRjgDZrToJn7s1p0xDIl4r/TkwpwY/vdWi/CyT78luc6OZYRZslvwkiu1nbvqVI2Ff61UJd4mlBdaIf6NsvBmnX9cJ/GhWKUMSyj9ImkPPmSriiFbe2Q8qiyLxofdup0+in4bpfMz8OOipHcb6DO1S9vxa87eU6+kA5j2qpqALGtdRjLQqqUEcVBlwBdNJIj5egE4NZogxqsLeK14ghinLqBCxQSRoufACtnDCeykTgCWW7o9mUAKen8lYprWrs6j2QtTfJo3d32DVIxHZJWhQDoLGZS8v6ZpQHOHTB3NTf3aWi5tseFD0kM5JaceJBGItcSlpkQpsUmuEit+JTSqtyQUidCSXjUm8D9bWkYUm77qVSogAalt+rqJqMw0G8MsO7sk92OpchImCdOky9ITt/R9B0MKZdRc79bPXDwkPHJ/qvt6raECBnUoHxY4/0TjIeERY/SkwDrZGTBdrzFVKxtTbLEUS58cXcH0VjH0i9QnK1Cn5cCqb5K+5WHKVC0Q6lAEA57pcAj5xo8wmN2jiqIr6p4JhHcba7Ae0VMGLTbksEs7gGM6DZTqCKZdkt0hdxpD0u+71Z5vAeq1GFiiOkyWde1yt6bhzRaBxwVtBrboPP0ibfi2Wo6M0ZkO5RGE5Zr6XCWokKJ7PXe3hTDSX044BELj8dR3AAAAAElFTkSuQmCC\" width=\"40\" height=\"40\" class=\"img_ev3q\"> Networking &amp; Content Delivery<a class=\"hash-link\" href=\"#-networking--content-delivery\" title=\"Direct link to heading\">​</a></h2><table><thead><tr><th><img loading=\"lazy\" src=\"data:image/png;base64,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\" width=\"84\" height=\"50\" class=\"img_ev3q\"></th><th><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAAyCAYAAAAEA2g/AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAATZSURBVHjaYmSgMXjtYmYPpByA2ACIFaA0OvgAxBeA+AGU3iC659RDWroLIIAYaejZBCAOAGIBMo0BBcICEKZFIAAEECMNPNwAjWFqAlAANFAzAAACiJFKHpaHOs6BxjlnAjQAPlJqEEAAMVLB0/lQB9ELgLJAANDzFykxBCCAGCnwMD/UwwkMAwMSgJ5fSK5mgABiosDTBwbQ0wwLlUMXhNTun0+ufoAAYqTA0wYD6GmGE2Im8IJvTbNjIqlmAAQQOTG+YRB5GpzkgTFfT6o5AAHESGJs9wOpgkHkaWQQAIz5jcSaBRBAjCR42h6axAejp2GtPwWg54mq6gACiIWEfL2AQrdvgOIL6FURNFANoIWlARmeZoC2EEFuDCTGMQABxEikx+uhLTKat7rQW39EehoZOABj/SAhRQABxEhkbD8go839AdrQOEhOaAHtjV+qFDThiLg5qfYeAHrckZAigAAiplQvwOdpZrnvcIwEQD0sBXI9DQKgxgnQ0wZQs0iKcWApb09IEUAAERPj96HdSQYmsZ8MrGpfGViAnmSR+4FV/f8fTAz//zFcYOL6B0riG9hc3lLUsQB6gpwUR7BuBwggRgKe9gc5nkX1KwO76QecniWU9EB5FhgABynwPDk1igC+Eh4ggPAmdVaNLw7cUU8ZuINfkOtpBmghdeDXHuH9QCxPjgHQwmoBGfbiBAABhNPjQEfGcwW8TKDAw9gccgFkLpn6SW04gdryOO0CCCAmHJ7uh4awAAN1AbiuBZpfT0asfyQx1gWgnu/HJgkQQEw4PE3rZmkDOZ6HNoBITinYPA8QQEzoyZuObXGQ5/3JKCgZyPQ8SrIHCCAmJE/L03kk5QKpHoEm9wfkDlsBPQ8vXAECiAmtaSlAR087AKs4csbOHlBSvsA4AAHEBI1tewbaDxRSw9MU1yywVh1AAMFivIECwx5Ak+wDOnn6AaVlC4gACCBGaN4m1bAP0PJgAXKTFGpWAwP2sTiqxjQ05kAFcQAZ2hUAAgjkcVKHhz9APXART+PHH63MoFnyhpbWpLbqCgACiInEECPoaRAAym9EinWa5mlgSb+QjCrYASCAmBhIGzicQMjTaJ6fQI+CDOj5iSRWjQYAAcRCanePFAcBPVxIxxJ7AQk1kwJAAJEyvPyA0r41jQFJjSGAACLJ44PY06DkTlKkAAQQKR43GMweR26OEgMAAogUjwsAqyn9Qex3klqeAAHERGISLhjEHiel9fkAIICYGEgbxUygYASFlskc1LdXIKW/ABBATGT0cRcMJs8DPZ1PRl/jAEAAkdtWZzj3W+BAzidDUAPlwJnwNR/p7Fl+aIszgcxepQJAADFC29brSWm63vrDw5DzyYDhy39WijygcCV7IBLJBmDVFwgQQLBSfQK9PT2AAOxXgABigjYtQePWG0aApzfAJhQBAogJrar6MIw9/QG5OgYIICakDsVDHAMIw8HT4KoYuVkLEEBMePrRw83TKMtEAAKICUtXciHM88PI0xjr4QACiAlHP3rh/T9cCbmfDD4M8TwdgM3TIAAQQDg7Keoejxd+/s9qwEDetM2Al96g3iS+VVAAAUTUGhiTlSGUjGjSswED8vAEYtbAAAQQSevcgAEAayo6QDsFDgPs8QcMiKmoDaQMRgAEGADHTLziPW4o6AAAAABJRU5ErkJggg==\" width=\"62\" height=\"50\" class=\"img_ev3q\"></th></tr></thead><tbody><tr><td>Virtual Private Cloud (VPC) (Regional)</td><td>VPC Network (Global or Regional)</td></tr><tr><td>Subnet (Zonal)</td><td>Subnet (Regional)</td></tr><tr><td>Route Tables</td><td>Routes</td></tr><tr><td>Network ACLs (NACLS)</td><td>VPC Firewall Rules (ALLOW or DENY)</td></tr><tr><td>CloudFront</td><td>Cloud CDN</td></tr><tr><td>Route 53</td><td>Cloud DNS/Google Domains</td></tr><tr><td>Direct Connect</td><td>Dedicated (or Partner) Interconnect</td></tr><tr><td>Virtual Private Network (VPN)</td><td>Cloud VPN</td></tr><tr><td>AWS PrivateLink</td><td>Google Private Access</td></tr><tr><td>NAT Gateway</td><td>Cloud NAT</td></tr><tr><td>Elastic Load Balancer</td><td>Load Balancer</td></tr><tr><td>AWS WAF</td><td>Cloud Armour</td></tr><tr><td>VPC Peering Connection</td><td>VPC Network Peering</td></tr><tr><td>Amazon API Gateway</td><td>Apigee API Gateway</td></tr><tr><td>Amazon API Gateway</td><td>Cloud Endpoints</td></tr></tbody></table><a name=\"security\"></a><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"-security-identity--compliance\"><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAACOlBMVEUAAAAAAACAgIBVVVVAQIBmZmZVVVVJSW1gYGBVVXFNZmZdXV1VVWpOYmJVVWZQYGBaWmlVVWNRXl5ZWWZVVWFRXWhZWWRVYGBSXGZYWGJSW2RYWGFVXmZYWGhTWmJXV2ZVXGNTWmdXXmVVXGJTWWZRXWNVW2ZTWWRRXGJSXGZVWmRTXWJSW2VVWmNTXWZVWWJUXGVSW2NVWWZUXGRSWmNVWWVUXGRSWmJVXWRTWmVVXGRTWmRUW2VTWWNVXGVTXGNUWmRTXGVUWmNTXGVVW2RUWmVUWmVTW2RUXGRUXGRTW2NVWmRUXGNTW2VVWmRUXGNTW2VVWmRUW2VTW2RUW2VTWmRVXGVTWmNUW2RUWmNUW2NUWmVUW2NUXGRUWmVUXGRUXGRTW2VTW2RUW2VUXGNUW2VUXGVTWmNUXGVUW2RTWmNUW2RTWmVUW2NTXGRUW2RUW2VTXGRUW2NUWmRUW2VUWmRUWmRTW2VTW2RUW2RUXGNTW2RUW2RUW2RVWmNVWmVUW2NUW2RUW2VUW2RVW2RUW2VVW2RUWmRUW2RUXGRVW2RUW2RUXGNVW2RUW2RVW2RUW2RVW2RUW2RVW2RUXGRUXGRUW2VTW2RUW2RUW2RTWmRUW2NUW2RTXGRTW2NUW2RUW2RTW2RUW2RUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2RUW2RUW2RUW2RUW2RUW2VUW2RUW2RUW2RUW2RUW2RUWmRUW2RUW2RUW2RUW2RUW2RUW2RUW2T///824LZ9AAAAvHRSTlMAAQIDBAUGBwgJCgsMDQ8QERITFBUWFxgZGhwdHiAiIyQlJicoLC0uLzIzNDU2Nzk6Ozw9Pj9AQUJERUpMTU5QUlNVVldYW1xeYWJjZGVmZ2hpamttbm9xc3R2d3l6fH2AgYSGiImLjY6PkJGTlZaXmJmam52eoaKlpqeoqausr7GztLe4ubu9v8DBwsPExcfJyszNztHV1tfY2drb3N/g4eLj5ebn6Onq6+zt7u/w8fL09fb3+Pn6+/z9/lgc/UcAAAABYktHRL091dJ5AAACpElEQVQ4y93V6VtMYRjH8d/UpCjUVJaQMET2IiKyZQkjVMq+ZCcSskuIhrFUJClbESoS0jnfP86LGVPTHLz3vLvP9Xlxn+c61/dIA49z34vGfU794yQU1QFAbWHCn1XMpmoD2ssWLCxrB6PaFWOlYgs8Bnw4nhqi5CkKST3+AQxPQWygCsu80AU9lauj5MirhbqCeEWtruyBrguZYX425/RHMNy5Dtkzr/3w7thTsSxcjly3AR9PzfG68SbUFiVIqaUd0F2eARnlXfC5PMOmMUV1YI6XJKXQ7JRG7qgHPK7hEkjD1laZ8Lo4SXI2k+KDNYq++B3aS2ZK8kJJkw+1QO+tUarpB3PovbkqwrezD0qhiy9/Y30AdHGm7w78UFIprgGw9P+BOZy1hudY54fJPFE2l6zhFVbqCcmSpHE0az73rKGHNL1irPd75ZMSeWkNXzNOnQyXJNk+47B/NWOsYKzZZY+jwzc9JE13WWIFs7ijdDz+N9uiYg5bwWMcUB5lvmkjFZrFe3swtLcxXZXk+MZ4ozvS1khGMFxEg4Z+/+n4PT8iS7upCoZ32KkVPPBvUohbQ1vJGgiX0xKlB+T7YWQb6SrgWXggjHjOVi2kJaLvWvdyS4OecyQQnqA+TLfZ0z8mnSzT5K8U9odFfJmkFXRE909FLq2jtcY0XH1ws2FkK6GNDQFNCanCE6Ftprk/1AvtxZj5GvyQm7bA+ox4y9VQuXq5O1Egp5ufOQq9zpu4gTWb8I6qaKW38uMwHO2hZZ7i7tOaFNy9GW3UT1H8eRPAPBenqQ28m2ZVyKQGurcP0uxK07wxS+G7vvE00bq4kWegccMQJSYq0tWEWTLkj3GeVwPtJ1PTSjrg8dy/xT4k6743pO6ltn/9GKYebGoqTg56/Av5xFKu6XLLjwAAAABJRU5ErkJggg==\" width=\"40\" height=\"40\" class=\"img_ev3q\"> Security, Identity, &amp; Compliance<a class=\"hash-link\" href=\"#-security-identity--compliance\" title=\"Direct link to heading\">​</a></h2><table><thead><tr><th><img loading=\"lazy\" src=\"data:image/png;base64,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\" width=\"84\" height=\"50\" class=\"img_ev3q\"></th><th><img loading=\"lazy\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAAyCAYAAAAEA2g/AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAATZSURBVHjaYmSgMXjtYmYPpByA2ACIFaA0OvgAxBeA+AGU3iC659RDWroLIIAYaejZBCAOAGIBMo0BBcICEKZFIAAEECMNPNwAjWFqAlAANFAzAAACiJFKHpaHOs6BxjlnAjQAPlJqEEAAMVLB0/lQB9ELgLJAANDzFykxBCCAGCnwMD/UwwkMAwMSgJ5fSK5mgABiosDTBwbQ0wwLlUMXhNTun0+ufoAAYqTA0wYD6GmGE2Im8IJvTbNjIqlmAAQQOTG+YRB5GpzkgTFfT6o5AAHESGJs9wOpgkHkaWQQAIz5jcSaBRBAjCR42h6axAejp2GtPwWg54mq6gACiIWEfL2AQrdvgOIL6FURNFANoIWlARmeZoC2EEFuDCTGMQABxEikx+uhLTKat7rQW39EehoZOABj/SAhRQABxEhkbD8go839AdrQOEhOaAHtjV+qFDThiLg5qfYeAHrckZAigAAiplQvwOdpZrnvcIwEQD0sBXI9DQKgxgnQ0wZQs0iKcWApb09IEUAAERPj96HdSQYmsZ8MrGpfGViAnmSR+4FV/f8fTAz//zFcYOL6B0riG9hc3lLUsQB6gpwUR7BuBwggRgKe9gc5nkX1KwO76QecniWU9EB5FhgABynwPDk1igC+Eh4ggPAmdVaNLw7cUU8ZuINfkOtpBmghdeDXHuH9QCxPjgHQwmoBGfbiBAABhNPjQEfGcwW8TKDAw9gccgFkLpn6SW04gdryOO0CCCAmHJ7uh4awAAN1AbiuBZpfT0asfyQx1gWgnu/HJgkQQEw4PE3rZmkDOZ6HNoBITinYPA8QQEzoyZuObXGQ5/3JKCgZyPQ8SrIHCCAmJE/L03kk5QKpHoEm9wfkDlsBPQ8vXAECiAmtaSlAR087AKs4csbOHlBSvsA4AAHEBI1tewbaDxRSw9MU1yywVh1AAMFivIECwx5Ak+wDOnn6AaVlC4gACCBGaN4m1bAP0PJgAXKTFGpWAwP2sTiqxjQ05kAFcQAZ2hUAAgjkcVKHhz9APXART+PHH63MoFnyhpbWpLbqCgACiInEECPoaRAAym9EinWa5mlgSb+QjCrYASCAmBhIGzicQMjTaJ6fQI+CDOj5iSRWjQYAAcRCanePFAcBPVxIxxJ7AQk1kwJAAJEyvPyA0r41jQFJjSGAACLJ44PY06DkTlKkAAQQKR43GMweR26OEgMAAogUjwsAqyn9Qex3klqeAAHERGISLhjEHiel9fkAIICYGEgbxUygYASFlskc1LdXIKW/ABBATGT0cRcMJs8DPZ1PRl/jAEAAkdtWZzj3W+BAzidDUAPlwJnwNR/p7Fl+aIszgcxepQJAADFC29brSWm63vrDw5DzyYDhy39WijygcCV7IBLJBmDVFwgQQLBSfQK9PT2AAOxXgABigjYtQePWG0aApzfAJhQBAogJrar6MIw9/QG5OgYIICakDsVDHAMIw8HT4KoYuVkLEEBMePrRw83TKMtEAAKICUtXciHM88PI0xjr4QACiAlHP3rh/T9cCbmfDD4M8TwdgM3TIAAQQDg7Keoejxd+/s9qwEDetM2Al96g3iS+VVAAAUTUGhiTlSGUjGjSswED8vAEYtbAAAQQSevcgAEAayo6QDsFDgPs8QcMiKmoDaQMRgAEGADHTLziPW4o6AAAAABJRU5ErkJggg==\" width=\"62\" height=\"50\" class=\"img_ev3q\"></th></tr></thead><tbody><tr><td>Root Account</td><td>Super Admin</td></tr><tr><td>IAM User</td><td>Member</td></tr><tr><td>IAM Policy</td><td>Role (Collection of Permissions)</td></tr><tr><td>IAM Policy Attachment</td><td>IAM Role Binding (or IAM Binding)</td></tr><tr><td>Key Management Service (KMS)</td><td>Cloud KMS</td></tr><tr><td>CloudHSM</td><td>Cloud HSM</td></tr><tr><td>Amazon Inspector (agent based)</td><td>Cloud Security Scanner (scan based)</td></tr><tr><td>AWS Security Hub</td><td>Cloud Security Command Center (SCC)</td></tr><tr><td>Secrets Manager</td><td>Secret Manager</td></tr><tr><td>Amazon Macie</td><td>Cloud Data Loss Prevention (DLP)</td></tr><tr><td>AWS WAF</td><td>Cloud Armour</td></tr><tr><td>AWS Shield</td><td>Cloud Armour</td></tr></tbody></table><p>† No direct equivalent, this is the closest equivalent</p>",
            "url": "https://fullstackchronicles.io/ultimate-aws-to-gcp-thesaurus",
            "title": "The Ultimate AWS to GCP Thesaurus",
            "summary": "aws to gcp thesauraus",
            "date_modified": "2019-12-30T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "amazonwebservices",
                "aws",
                "gcp",
                "googlecloudplatform"
            ]
        },
        {
            "id": "google-cloud-storage-object-notifications-using-slack",
            "content_html": "<p>This article describes the steps to integrate Slack with Google Cloud Functions to get notified about object events within a specified Google Cloud Storage bucket.</p><p><a target=\"_blank\" href=\"/assets/files/Slack-GCS-6de5cb5ede305869300f0f933537e240.png\"><img loading=\"lazy\" alt=\"Google Cloud Storage Object Notifications using Slack\" src=\"/assets/images/Slack-GCS-6de5cb5ede305869300f0f933537e240.png\" width=\"560\" height=\"341\" class=\"img_ev3q\"></a></p><p>Events could include the creation of new objects, as well as delete, archive or metadata operations performed on a given bucket.</p><p>This pattern could be easily extended to other event sources supported by Cloud Functions including:</p><ul><li>Cloud Pub/Sub messages</li><li>Cloud Firestore and Firebase events</li><li>Stackdriver log entries</li></ul><p>More information can be found at <a href=\"https://cloud.google.com/functions/docs/concepts/events-triggers\" target=\"_blank\" rel=\"noopener noreferrer\">https://cloud.google.com/functions/docs/concepts/events-triggers</a>.</p><p>The prerequisite steps to configure Slack are provided here:</p><ol><li>First you will need to create a Slack app (assuming you have already set up an account and a workspace). The following screenshots demonstrate this process:</li></ol><figure><a href=\"/assets/images/slack-notifications-setup-1-4922d02dd437b80334c8b3b85d25a94b.png\"><img src=\"/assets/images/slack-notifications-setup-1-4922d02dd437b80334c8b3b85d25a94b.png\" alt=\"Create a Slack app\"></a><figcaption class=\"figure-caption\">Create a Slack app</figcaption></figure><figure><a href=\"/assets/images/slack-notifications-setup-2-82f83d053fab9830256ca8ecaaa8f33a.png\"><img src=\"/assets/images/slack-notifications-setup-2-82f83d053fab9830256ca8ecaaa8f33a.png\" alt=\"Give the app a name and associate it with an existing Slack workspace\"></a><figcaption class=\"figure-caption\">Give the app a name and associate it with an existing Slack workspace</figcaption></figure><ol start=\"2\"><li>Next you need to Enable and Activate Incoming Webhooks to your app and add this to your workspace. The following screenshots demonstrate this process:</li></ol><figure><a href=\"/assets/images/slack-notifications-setup-3-6dec01da96437a43cf7c4e4d948e0dd6.png\"><img src=\"/assets/images/slack-notifications-setup-3-6dec01da96437a43cf7c4e4d948e0dd6.png\" alt=\"Enable Incoming Web Hooks for the app\"></a><figcaption class=\"figure-caption\">Enable Incoming Web Hooks for the app</figcaption></figure><figure><a href=\"/assets/images/slack-notifications-setup-4-95fc759fc0221afdffaa694b14245feb.png\"><img src=\"/assets/images/slack-notifications-setup-4-95fc759fc0221afdffaa694b14245feb.png\" alt=\"Activate incoming webhooks\"></a><figcaption class=\"figure-caption\">Activate incoming webhooks</figcaption></figure><figure><a href=\"/assets/images/slack-notifications-setup-5-2b9b7c134f51bbd0393068a614b5469c.png\"><img src=\"/assets/images/slack-notifications-setup-5-2b9b7c134f51bbd0393068a614b5469c.png\" alt=\"Add the webhook to your workspace\"></a><figcaption class=\"figure-caption\">Add the webhook to your workspace</figcaption></figure><ol start=\"3\"><li>Next you need to specify a channel for notifications generated from object events.</li></ol><figure><a href=\"/assets/images/slack-notifications-setup-6-3b3d2000288499a7cdb60c2cf7af04c5.png\"><img src=\"/assets/images/slack-notifications-setup-6-3b3d2000288499a7cdb60c2cf7af04c5.png\" alt=\"Select a channel for the webhook\"></a><figcaption class=\"figure-caption\">Select a channel for the webhook</figcaption></figure><ol start=\"4\"><li>Now you need to copy the Webhook url provided, you will use this later in your Cloud Function.</li></ol><figure><a href=\"/assets/images/output-onlinepngtools-7bfe4ca076a72230bcf2aa722f6e61c0.png\"><img src=\"/assets/images/output-onlinepngtools-7bfe4ca076a72230bcf2aa722f6e61c0.png\" alt=\"Copy the webhook URL to the clipboard\"></a><figcaption class=\"figure-caption\">Copy the webhook URL to the clipboard</figcaption></figure><blockquote><p>Treat your webhook url as a secret, do not upload this to a public source code repository</p></blockquote><p>Next you need to create your Cloud Function, this example uses Python but you can use an alternative runtime including Node.js or Go.</p><p>This example templates the source code using the Terraform <code>template_file</code> data source. The function source code is shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-e248abd1af393e58de84e8776161c8cb\"></iframe><p>Within your Terraform code you need to render your Cloud Function code substituting the <code>slack_webhook_url</code> for it's value which you will supply as a Terraform variable. The rendered template file is then placed in a local directory along with a <code>requirements.txt</code> file and zipped up. The resulting Zip archive is uploaded to a specified bucket where it will be sourced to create the Cloud Function.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-e247d09d33a4aca9154de081f3063978\"></iframe><p>Now you need to create the Cloud Function, the following HCL snippet demonstrates this:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-87e2e83e5b2b800d685a8d239280ca13\"></iframe><p>The <code>event_trigger</code> block in particular specifies which GCS bucket to watch and what events will trigger invocation of the function. Bucket events include:</p><ul><li><code>google.storage.object.finalize</code> <em>(the creation of a new object)</em></li><li><code>google.storage.object.delete</code></li><li><code>google.storage.object.archive</code></li><li><code>google.storage.object.metadataUpdate</code></li></ul><p>You could add additional logic to the Cloud Function code to look for specific object names or naming patterns, but keep in mind the function will fire upon every event matching the <code>event_type</code> and <code>resource</code> criteria.</p><p>To deploy the function, you would simply run:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">terraform apply -var=\"slack_webhook_url=https://hooks.slack.com/services/XXXXXXXXX/XXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXX\"</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Now once you upload a file named <code>test-object.txt</code>, voilà!:</p><figure><a href=\"/assets/images/slack-notification-296ef71c70119965cb16d4fe536b1fbe.png\"><img src=\"/assets/images/slack-notification-296ef71c70119965cb16d4fe536b1fbe.png\" alt=\"Slack notification for a new object created\"></a><figcaption class=\"figure-caption\">Slack notification for a new object created</figcaption></figure><blockquote><p>Full source code is available at: <a href=\"https://github.com/gamma-data/gcs-object-notifications-using-slack\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/gamma-data/gcs-object-notifications-using-slack</a></p></blockquote>",
            "url": "https://fullstackchronicles.io/google-cloud-storage-object-notifications-using-slack",
            "title": "Google Cloud Storage Object Notifications using Slack",
            "summary": "This article describes the steps to integrate Slack with Google Cloud Functions to get notified about object events within a specified Google Cloud Storage bucket.",
            "date_modified": "2019-11-09T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "gcp",
                "googlecloudplatform",
                "slack",
                "terraform"
            ]
        },
        {
            "id": "map-reduce-is-dead-long-live-map-reduce",
            "content_html": "<p><img loading=\"lazy\" alt=\"Map Reduce is Dead\" src=\"/assets/images/image-37d5c469e52212a957fc248f57ef7b64.png\" width=\"1058\" height=\"262\" class=\"img_ev3q\"></p><p>Firstly, this is not another Hadoop obituary, there are enough of those out there already.</p><p>The generalized title of this article has been used as an expression to convey the idea that something old has been replaced by something new. In the case of the expression “the King is dead, long live the King” the inference is that although one monarch has passed, another monarch instantly succeeds him.</p><p>In the age of instant gratification and hype cycle driven ‘pump and dump’ investment we are very quick to discard technologies that don’t realise overzealous targets for sales or market share. In our continuous attempts to find the next big thing, we are quick to throw out the last big thing and everything associated with it.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-reports-of-my-death-have-been-greatly-exaggerated\">The Reports of My Death Have Been Greatly Exaggerated<a class=\"hash-link\" href=\"#the-reports-of-my-death-have-been-greatly-exaggerated\" title=\"Direct link to heading\">​</a></h2><p>A classic example of this is the notion that Map Reduce is dead. Largely proliferated by the Hadoop obituaries which seem to be growing exponentially with each day.</p><p>A common e-myth is that Google invented the Map Reduce pattern, which is completely incorrect. In 2004, Google described a framework distributed systems implementation of the Map Reduce pattern in a white paper named <em>“MapReduce: Simplified Data Processing on Large Clusters.”</em> – this would inspire the first-generation processing framework (MapReduce) in the Hadoop project. But neither Google nor Yahoo! nor contributors to the Hadoop project (which include the pure play vendors) created the Map Reduce algorithm or processing pattern and neither shall any one of these have the rights to kill it.</p><p>The origins of the Map Reduce pattern can be traced all the way back to the early foundations of functional programming beginning with Lambda Calculus in the 1930s to LISP in the 1960s. Map Reduce is an integral pattern in all of today’s functional and distributed systems programming. You only need to look at the support for <code>map()</code> and <code>reduce()</code> operators in some of the most popular languages today including Python, JavaScript, Scala, and many more languages that support functional programming.</p><p>As far as distributed processing frameworks go, the Map Reduce pattern and its <code>map()</code> and <code>reduce()</code> methods are very prominent as higher order functions in APIs such as Spark, Kafka Streams, Apache Samza and Apache Flink to name a few.</p><p>While the initial Hadoop adaptation of Map Reduce has been supplanted by superior approaches, the Map Reduce processing pattern is far from dead.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"on-the-fall-of-hadoop\">On the fall of Hadoop...<a class=\"hash-link\" href=\"#on-the-fall-of-hadoop\" title=\"Direct link to heading\">​</a></h2><p>There is so much hysteria around the fall of Hadoop, we need to be careful not to toss the baby out with the bath water. Hadoop served a significant role in bringing open source, distributed systems from search engine providers to academia all the way to the mainstream, and still serves an important purpose in many organizations data ecosystems today and will continue to do so for some time.</p><p>OK, it wasn’t the panacea to everything, but who said it was supposed to be? The Hadoop movement was hijacked by hysteria, hype, venture capital, over ambitious sales targets and financial engineering – this does not mean the technology was bad.</p><p>Hadoop spawned many significant related projects such as Spark, Kafka and Presto to name a few. These projects paved the way for cloud integration, which is now the dominant vector for data storage, processing, and analysis.</p><p>While the quest for world domination by the Hadoop pure play vendors may be over, the Hadoop movement (and the impact it has had on the enterprise data landscape) will live on.</p>",
            "url": "https://fullstackchronicles.io/map-reduce-is-dead-long-live-map-reduce",
            "title": "Map Reduce is Dead, Long Live Map Reduce",
            "summary": "Map Reduce is Dead",
            "date_modified": "2019-09-01T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "big-data",
                "hadoop",
                "map-reduce"
            ]
        },
        {
            "id": "ansible-tower-for-continuous-infrastructure",
            "content_html": "<p>As infrastructure and teams scale, effective and robust configuration management requires growing beyond manual processes and local conventions. Fortunately, <a href=\"https://www.ansible.com/products/tower\" target=\"_blank\" rel=\"noopener noreferrer\">Ansible Tower</a> (or the upstream Open Source project <a href=\"https://github.com/ansible/awx\" target=\"_blank\" rel=\"noopener noreferrer\">Ansible AWX</a>) provides a perfect platform for configuration management at scale.</p><p>The&nbsp;<a href=\"https://docs.ansible.com/ansible-tower/index.html\" target=\"_blank\" rel=\"noopener noreferrer\">Ansible Tower/AWX documentation</a>&nbsp;and tutorials provide comprehensive information about the individual components. &nbsp;However, assembling all the moving pieces into a whole working solution can involve some trial and error and reverse engineering in order to understand how the components relate to one another. &nbsp;Ansible Tower, like the core Ansible solution, offers flexibility in how features assembled to support different typed of workflows. The types of workflows can include once-off initial configurations, ad-hoc system maintenance, or continuous convergence.</p><p>Continuous convergence, also referred to as desired state, regularly re-applies the defined configuration to infrastructure. This tends to 'correct the drift' often encountered when only applying the configuration on infrastructure setup. For example, a continuous convergence approach to configuration management could apply the desired configuration on a recurring schedule of every 30 minutes. &nbsp;</p><p>Some continuous convergence workflow characteristics can include:</p><ul><li>Idempotent Ansible roles. If there are no required configuration deviations, run will report 0 changes.</li><li>A source code repository per Ansible role, similar to the Ansible Galaxy approach,</li><li>A source code repository for Ansible playbooks that include the individual Ansible roles,</li><li>A host configured to provide one unique service function only,</li><li>An Ansible playbook defined for each unique service function that gets applied to the host,</li><li>Playbooks applied to each host on a repeating schedule.</li></ul><p>One way to achieve a continuous convergence workflow combines the Ansible Tower components according to the following conceptual model.</p><p><a target=\"_blank\" href=\"/assets/files/Ansible-AWX-Continuous-Convergence-f3d3ad2b3baa64932ac1276077ace883.png\"><img loading=\"lazy\" src=\"/assets/images/Ansible-AWX-Continuous-Convergence-f3d3ad2b3baa64932ac1276077ace883.png\" width=\"1257\" height=\"616\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-workflow-components\">The Workflow Components<a class=\"hash-link\" href=\"#the-workflow-components\" title=\"Direct link to heading\">​</a></h2><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"playbook-and-role-source-code\">Playbook and Role Source Code<a class=\"hash-link\" href=\"#playbook-and-role-source-code\" title=\"Direct link to heading\">​</a></h3><p><strong>Ansible roles</strong> contain the individual tasks, handlers, and content&nbsp;with a role responsible for the installation and configuration of a particular software service.</p><p><strong>Ansible playbooks</strong>&nbsp;configure a host for a particular service function in the environment acting as a wrapper for the individual role based configurations. &nbsp;All the roles expected to be applied to a host must be defined in the playbook.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"source-code-repositories\">Source Code Repositories<a class=\"hash-link\" href=\"#source-code-repositories\" title=\"Direct link to heading\">​</a></h3><p><strong>Role git repositor</strong>ies contain the versioned definition of a role, e.g. one git repository per individual role. &nbsp;The roles are pulled into the playbooks using the git reference and tags, which pegs the role version used within a playbook.</p><p><strong>Project git repositories</strong>&nbsp;group the individual playbooks into single collection, e.g. one git repository per set of playbooks. &nbsp;As with roles, specific versions of project repositories are also identified by version tags.&nbsp;</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"ansible-tower-server\">Ansible Tower Server<a class=\"hash-link\" href=\"#ansible-tower-server\" title=\"Direct link to heading\">​</a></h3><p>Two foundational concepts in Ansible Tower are projects and inventories. Projects provide access to playbooks and roles. Inventories provide the connection to \"real\" infrastructure. &nbsp;Inventories and projects also provide authorisation scope for activities in Ansible Tower. For example, a given group can use the playbooks in Project X and apply jobs to hosts in Inventory Y.</p><p>Each&nbsp;<strong>Ansible Tower Project</strong>&nbsp;is backed by a project git repository. &nbsp;Each repository contains the playbooks and included roles that can be applied by a given job. &nbsp;The Project is the glue between the Ansible configuration tasks and the plays that apply the configuration.</p><p><strong>Ansible Tower Inventories</strong>&nbsp;are sets of hosts grouped for administration, similar to inventory sets used when applying playbooks manually. &nbsp;One option is to group hosts into Inventories by environment. &nbsp;For example, the hosts for development may be in one Inventory while the hosts for production may be in another Inventory. &nbsp;User authorisation controls are applied at the Inventory level.</p><p><strong>Ansible Tower&nbsp;Inventory Groups</strong>&nbsp;define sub-sets of hosts within the larger Inventory. &nbsp;These subsets can then be used to limit the scope of a playbook job. &nbsp;One option is to group hosts within an Inventory by function. &nbsp;For example, the hosts for web servers may be in one Inventory Group and the hosts for databases may be in another Inventory Group. &nbsp;This enables one playbook to target one inventory group. &nbsp;Inventory groups effectively provide metadata labels for hosts in the Inventory.</p><p>An&nbsp;<strong>Ansible Job Template</strong>&nbsp;determines the configuration to be applied to hosts. &nbsp;The Job Template&nbsp;links a playbook from a project to an inventory. &nbsp; The inventory scope can be optionally further limited by specifying inventory group limits. &nbsp;A Job Template can be invoked either on an ad-hoc basis or via a recurring schedule.</p><p><strong>Ansible Job Schedules</strong>&nbsp;define the time and frequency at which the configuration specified in the Job Template is applied. &nbsp;Each Job Template can be associated with one or more Job Schedules. &nbsp;A schedule supports either once-off execution, for example during a defined change window, or regularly recurring execution. &nbsp;A job schedule that applies the desired state configuration with a frequency of 30 minutes provides an example of a job schedule used for a continuous convergence workflow.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"real-infrastructure\">\"Real\" Infrastructure<a class=\"hash-link\" href=\"#real-infrastructure\" title=\"Direct link to heading\">​</a></h3><p>An&nbsp;<strong>Ansible Job Instance</strong>&nbsp;defines a single invocation of an Ansible Job Template, both for scheduled and ad-hoc invocations of the job template. &nbsp;Outside of Ansible Tower, the Job Instance is the equivalent of executing the&nbsp;<code>ansible-playbook</code>&nbsp;command using an inventory file.</p><p>A&nbsp;<strong>Host</strong>&nbsp;is the actual target infrastructure resources configured by the job instance, applying an ansible playbook of included roles.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"a-note-on-ansible-variables\">A note on Ansible Variables<a class=\"hash-link\" href=\"#a-note-on-ansible-variables\" title=\"Direct link to heading\">​</a></h2><p>As with other features of Ansible and Ansible Tower, variables also offer flexibility in defining parameters and context when applying a configuration. &nbsp;In addition to declaring and defining variables in roles and playbooks, variable definitions can also be defined in Ansible Tower job templates, inventory and inventory groups, and individual hosts. &nbsp;Given the plethora of options for variable definition locations, without a set of conventions for managing variable values, debugging runtime issues with roles and playbooks can become difficult. &nbsp;E.g. which value defined at which location was used when applying the role?</p><p>One example of variable definitions conventions could include:</p><ul><li>Variables shall be given default values in the role, .e.g. in the&nbsp;<code>../defaults/main.yml</code>&nbsp;file.</li><li>If the variable must have a 'real' value supplied when applying the playbook, the variable shall be defined with an obvious placeholder value which will fail if not overridden.</li><li>Variables shall be described in the role&nbsp;<code>README.md</code>&nbsp;documentation</li><li>Do not apply variables at the host inventory level as host inventory can be transient.</li><li>Variables that select specific capabilities within a role shall be defined at the Ansible Tower Inventory Group. &nbsp;For example, a role contains the configuration definition for both master and work nodes. &nbsp;The Inventory Group variables are used to indicate which hosts must have the master configuration and applied and which must have the worker configuration applied.</li><li>Variables that define the environment context for configuration shall be defined in the Ansible Tower Job Template.</li></ul><p>Following these conventions, each of the possible variable definition options serves a particular purpose. &nbsp;When an issue with variable definition does arise, the source is easily identified.</p>",
            "url": "https://fullstackchronicles.io/ansible-tower-for-continuous-infrastructure",
            "title": "Ansible Tower for Continuous Infrastructure",
            "summary": "As infrastructure and teams scale, effective and robust configuration management requires growing beyond manual processes and local conventions. Fortunately, Ansible Tower (or the upstream Open Source project Ansible AWX) provides a perfect platform for configuration management at scale.",
            "date_modified": "2019-08-29T00:00:00.000Z",
            "author": {
                "name": "Chris Ottinger",
                "url": "https://github.com/datwiz"
            },
            "tags": [
                "ansible",
                "ci-cd",
                "continuous-infrastructure"
            ]
        },
        {
            "id": "managing-secrets-in-cicd-pipelines",
            "content_html": "<p><img loading=\"lazy\" alt=\"Gitlab Vault\" src=\"/assets/images/Gitlab-Vault-c451dca4eb190e47c62f21989fc14d51.png\" width=\"271\" height=\"243\" class=\"img_ev3q\"></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"overview\">Overview<a class=\"hash-link\" href=\"#overview\" title=\"Direct link to heading\">​</a></h2><p>With the adoption automation for deploying and managing application environments, protecting privileged accounts and credential secrets in a consistent, secure, and scalable manner becomes critical. &nbsp;Secrets can include account usernames, account passwords and API tokens. &nbsp;Good credentials management and secrets automation practices reduce the risk of secrets escaping into the wild and being used either intentionally (hacked) or unintentionally (accident).</p><ul><li>Reduce the likelihood of passwords slipping into source code commits and getting pushed to code repositories, especially public repositories such as github.</li><li>Minimise the secrets exposure surface area by reducing the number of people who require knowledge of credentials. &nbsp;With an automated credentials management process that number can reach zero.</li><li>Limit the useful life of a secret by employing short expiry times and small time-to-live (TTL) values. &nbsp;Automation enables reliable low-effort secret re-issue and rotation.</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"objectives\">Objectives<a class=\"hash-link\" href=\"#objectives\" title=\"Direct link to heading\">​</a></h2><p>The following objectives have been considered in designing a secrets automation solution that can be integrated into an existing CICD environment.</p><ul><li>Integrate into an existing CICD environment without requiring an \"all or nothing\" implementation. &nbsp;Allow existing jobs to operate alongside jobs that have been converted to the new secrets automation solution.</li><li>A single design that can be applied across different toolchains and deployment models. &nbsp;For example, deployment to a Kubernetes environment can use the same secrets management process as an application installation on a virtual machine. &nbsp;Similarly, the design can be used with different CICD tools, such as <a href=\"https://about.gitlab.com\" target=\"_blank\" rel=\"noopener noreferrer\">GitLab-CI</a>, <a href=\"https://travis-ci.org\" target=\"_blank\" rel=\"noopener noreferrer\">Travis-CI</a>, or other build and deploy automation tool.</li><li>Multi-cloud capable by limiting coupling to a specific hosting environment or cloud services provider.</li><li>The use of secrets (or not) can be decided at any point in time, without requiring changes to the CICD job definition, similar to the use of feature flags in applications.</li><li>Enable changes to secrets, either due to rotation or revocation, to be maintained from a central service point. &nbsp;Avoid storing the same secret multiple times in different locations.</li><li>Secrets organised in predictable locations in a \"rest-ish\" fashion by treating secrets and credentials as attributes of entities.</li><li>Use environment variables as the standard interface between deployment orchestration and deployed application, following the 12 Factor App approach.</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"solution\">Solution<a class=\"hash-link\" href=\"#solution\" title=\"Direct link to heading\">​</a></h2><ul><li>Secrets stored centrally in Hashicorp Vault.</li><li>CICD jobs retrieve secrets from Vault and configure the application deployment environment.</li><li>Deployed applications use the secrets supplied by CICD job to access backend services.</li></ul><p><a target=\"_blank\" href=\"/assets/files/Screen-Shot-2019-07-16-at-17.03.47-d299ab2b399de970fe6ecdc17536fb1a.png\"><img loading=\"lazy\" alt=\"CICD Secrets with Vault\" src=\"/assets/images/Screen-Shot-2019-07-16-at-17.03.47-d299ab2b399de970fe6ecdc17536fb1a.png\" width=\"750\" height=\"434\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"storing-secrets\">Storing Secrets<a class=\"hash-link\" href=\"#storing-secrets\" title=\"Direct link to heading\">​</a></h2><p>Use&nbsp;<a href=\"https://www.vaultproject.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Vault by Hashicorp</a>&nbsp;as a centralised secrets storage service. &nbsp;The CICD service retrieves secrets information for integration and deployment jobs. &nbsp;Vault provides a flexible set of features to support numerous different workflows and available as either Vault Open Source or Vault Enterprise. &nbsp;The secrets management pattern described uses the Vault Open Source version. &nbsp;The workflow described here can be explored using Vault in the unsecured development mode, however, a properly configured and managed Vault service is required for production use.</p><p>Vault supports a number of secrets backends and access workflow models. &nbsp;This solution makes use of the&nbsp;<a href=\"https://www.vaultproject.io/docs/auth/approle.html\" target=\"_blank\" rel=\"noopener noreferrer\">Vault AppRole method</a>, which is designed to support machine-to-machine automated workflows. &nbsp;With the AppRole workflow model human access to secrets is minimised through the use of access controls and temporary credentials with short TTL's. &nbsp;Within Vault, secrets are organised using an entity centric \"rest-ish\" style approach ensuring a given secret for a given service is stored in a single predictable location.</p><p>The use of Vault satisfies several of the design objectives:</p><ul><li>enables single point management of secrets. The secrets content is stored in a single location referenced at CICD job runtime. &nbsp;On the next invocation, the CICD job retrieves the latest version of the secrets content.</li><li>enables storing secrets in predictable locations with file system directory style path location. &nbsp;The \"rest-ish\" approach to organising secret locations enables storing a given secret only once. &nbsp;Access policies provide the mechanism to limit CICD &nbsp;visibility to only those secrets required for the CICD job.</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"passing-secrets-to-applications\">Passing Secrets to Applications<a class=\"hash-link\" href=\"#passing-secrets-to-applications\" title=\"Direct link to heading\">​</a></h2><p>Use environment variables to pass secrets from the CICD service to the application environment. &nbsp;</p><p>There are existing utilities available for populating a child process environment with Vault sourced secrets, such as&nbsp;<a href=\"https://github.com/channable/vaultenv\" target=\"_blank\" rel=\"noopener noreferrer\">vaultenv</a>&nbsp;or&nbsp;<a href=\"https://github.com/hashicorp/envconsul\" target=\"_blank\" rel=\"noopener noreferrer\">envconsul</a>. &nbsp;This approach works well for running an application service. &nbsp;However, with CICD, often there are often sets of tasks that require access to secrets information as opposed to a single command. &nbsp;Using the child environment approach would require wrapping each command in a CICD job step with the env utility. &nbsp;This works against the objective of introducing a secrets automation solution into existing CICD jobs without requiring substantial refactoring. &nbsp;Similarly, some CICD solutions such as&nbsp;<a href=\"https://jenkins.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Jenkins</a>&nbsp;provide Vault integration plugins which pre-populate the environment with secrets content. &nbsp;This meets the objective of minimal CICD job refactoring, but closely couples the solution to a particular CICD service stack, reducing portability. &nbsp;</p><p>With a job script oriented CICD automation stack like GitLab-CI or Travis-CI, an alternative is to insert a job step at the beginning of a series of CICD tasks that will populated the required secret values into expected environment variables. &nbsp;Subsequent tasks in the job can then execute without requiring refactoring. &nbsp;The decision on whether to source a particular environment variable's content directly from the CICD job setup or from the Vault secrets store can be made by adding an optional prefix to environment variables to be sourced from the Vault secrets store. &nbsp;The prefixed instance of the environment variable contains the location or path to the required secret. &nbsp;Secret locations are identified using the convention&nbsp;<code>/&lt;vault-secret-path&gt;/&lt;secret-key&gt;</code></p><ul><li>enables progressive implementation due to transparency of secret sourcing. Subsequent steps continue to rely on expected environment vars</li><li>enables use in any toolchain that supports use of environment variables to pass information to application environment.&nbsp;</li><li>CICD job steps not tied to a specific secrets store. An alternative secrets storage service could be supported by only requiring modification of the secret getter utility.</li><li>control of whether to source application environment variables from the CICD job directly or from the secrets engine is managed at the CICD job setup level as opposed to requiring CICD job refactoring to switch the content source.</li><li>continues the 12 Factor App approach of using environment variables to pass context to application environments.</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"example-workflow\">Example Workflow<a class=\"hash-link\" href=\"#example-workflow\" title=\"Direct link to heading\">​</a></h2><p>An example workflow for a CICD job designed to use environment variables for configuring an application.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"assumptions\">Assumptions<a class=\"hash-link\" href=\"#assumptions\" title=\"Direct link to heading\">​</a></h3><p>The following are available in the CICD environment.</p><ul><li>A job script oriented CICD automation stack that executes job tasks as a series of shell commands, such as <a href=\"https://about.gitlab.com\" target=\"_blank\" rel=\"noopener noreferrer\">GitLab-CI</a> or <a href=\"https://jenkins.io/doc/book/pipeline/\" target=\"_blank\" rel=\"noopener noreferrer\">Jenkins Pipelines</a>.</li><li>A secrets storage engine with a python API, such as Hashicorp Vault.</li><li>CICD execution environment includes the&nbsp;<code>[get-vault-secrets-by-approle](https://github.com/datwiz/cicd-secrets-in-vault/blob/master/scripts/get-vault-secrets-by-approle)</code>&nbsp;utility script.</li></ul><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"workflow-steps\">Workflow Steps<a class=\"hash-link\" href=\"#workflow-steps\" title=\"Direct link to heading\">​</a></h3><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"add-a-vault-secret\">Add a Vault secret<a class=\"hash-link\" href=\"#add-a-vault-secret\" title=\"Direct link to heading\">​</a></h3><p>Add a secret to Vault at the location&nbsp;<code>secret/fake-app/users/fake-users</code>&nbsp;with a key/value entry of&nbsp;<code>password=fake-password</code></p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"add-a-vault-access-policy\">Add a Vault access policy<a class=\"hash-link\" href=\"#add-a-vault-access-policy\" title=\"Direct link to heading\">​</a></h3><p>Add a Vault policy for the CICD job (or set of CICD jobs) that includes 'read' access to the secret.</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\"># cicd-fake-app-policy </span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">path \"secret/data/fake-app/users/fake-user\" {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    capabilities = [\"read\"]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\" style=\"display:inline-block\"></span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">path \"secret/metadata/fake-app/users/fake-user\" {</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    capabilities = [\"list\"]</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">}</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"add-a-vault-approle\">Add a Vault appRole<a class=\"hash-link\" href=\"#add-a-vault-approle\" title=\"Direct link to heading\">​</a></h3><p>Add a Vault appRole linked to the new policy. &nbsp;This example specifies a new appRole with an secret-id TTL of 60 days and non-renewable access tokens with a TTL of 5 minutes. &nbsp;The CICD job uses the access token to read secrets.</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">vault write auth/approle/role/fake-role \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    secret_id_ttl=1440h \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    token_ttl=5m \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    token_max_ttl=5m \\</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">    policies=cicd-fake-app-policy</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"read-the-vault-approle-id\">Read the Vault approle-id<a class=\"hash-link\" href=\"#read-the-vault-approle-id\" title=\"Direct link to heading\">​</a></h3><p>Retrieve the approle-id of the new appRole taking note of the returned approle-id.</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">vault&nbsp;read auth/approle/role/fake-role</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"add-a-vault-approle-secret-id\">Add a Vault appRole secret-id<a class=\"hash-link\" href=\"#add-a-vault-approle-secret-id\" title=\"Direct link to heading\">​</a></h3><p>Add a secret-id for the appRole, taking note of the returned secret-id</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">vault write -f auth/approle/role/fake-role/secret-id</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"add-cicd-job-steps\">Add CICD Job Steps<a class=\"hash-link\" href=\"#add-cicd-job-steps\" title=\"Direct link to heading\">​</a></h3><p>In the CICD job definition insert job steps to retrieve secrets values a set variables in the job execution environment. These are the steps to add in a gitlab-ci.yml CICD job.</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">...</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">script:</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">- get-vault-secrets-by-approle &gt; ${VAULT_VAR_FILE}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">- source ${VAULT_VAR_FILE} &amp;&amp; rm ${VAULT_VAR_FILE}</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">...</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>The helper script <code>get-vault-secrets-by-approle</code> could be executed and sourced in a single step, e.g.&nbsp;<code>source $(get-vault-secrets-by-approle)</code>. &nbsp;However, when executed in&nbsp;a single statement all script output is processed by the&nbsp;<code>source</code>&nbsp;command and script&nbsp;error messages&nbsp;don't get printed and captured in the job logs. &nbsp;Splitting the read and environment var sourcing into 2 steps aids in troubleshooting.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"add-cicd-job-vars-for-vault-access\">Add CICD job vars for Vault access<a class=\"hash-link\" href=\"#add-cicd-job-vars-for-vault-access\" title=\"Direct link to heading\">​</a></h3><p>In the CICD job configuration add Vault access environment variables.</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">VAULT_ADDR=https://vault.example.com:8200</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">VAULT_ROLE_ID=db02de05-fa39-4855-059b-67221c5c2f63</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">VAULT_SECRET_ID=6a174c20-f6de-a53c-74d2-6018fcceff64</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">VAULT_VAR_FILE=/var/tmp/vault-vars.sh</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"add-cicd-job-vars-for-vault-secrets\">Add CICD job vars for Vault secrets<a class=\"hash-link\" href=\"#add-cicd-job-vars-for-vault-secrets\" title=\"Direct link to heading\">​</a></h3><p>In the CICD job configuration add environment variables for the items to be sourced from vault secrets. &nbsp;The secret path follows the convention of&nbsp;<code>&lt;secret-mount-path&gt;/&lt;secret-path&gt;/&lt;secret-key&gt;</code></p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">V_FAKE_PASSWORD=secret/fake-app/users/fake-user/password</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"remove-cicd-job-vars\">Remove CICD job vars<a class=\"hash-link\" href=\"#remove-cicd-job-vars\" title=\"Direct link to heading\">​</a></h3><p>In the CICD job configuration remove the previously used&nbsp;<code>FAKE_APP_PASSWORD</code>&nbsp;variable.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"execute-the-cicd-job\">Execute the CICD job<a class=\"hash-link\" href=\"#execute-the-cicd-job\" title=\"Direct link to heading\">​</a></h3><p>Kick off the CICD job. &nbsp;Any CICD job configuration variables prefixed with \"<code>V_</code>\" results in the addition of a corresponding environment variable in the job execution environment with content sourced from Vault.</p><blockquote><p>Full source code can be found at:</p><p><a href=\"https://github.com/datwiz/cicd-secrets-in-vault\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/datwiz/cicd-secrets-in-vault</a></p></blockquote>",
            "url": "https://fullstackchronicles.io/managing-secrets-in-cicd-pipelines",
            "title": "Managing Secrets in CICD Pipelines",
            "summary": "Gitlab Vault",
            "date_modified": "2019-07-16T00:00:00.000Z",
            "author": {
                "name": "Chris Ottinger",
                "url": "https://github.com/datwiz"
            },
            "tags": [
                "ci-cd",
                "gitlab-ci",
                "hashicorp-vault",
                "jenkins",
                "secrets-management"
            ]
        },
        {
            "id": "change-data-capture-at-scale-using-spark",
            "content_html": "<p><img loading=\"lazy\" alt=\"CDC using Spark\" src=\"/assets/images/CDC-using-Spark-38cb48e3545c719f89f4380b50711cf3.png\" width=\"256\" height=\"251\" class=\"img_ev3q\"></p><p>Change Data Capture (CDC) is one of the most challenging processing patterns to implement at scale. I personally have had several cracks at this using various different frameworks and approaches, the most recent of which was implemented using Spark – and I think I have finally found the best approach. Even though the code examples referenced use Spark, the pattern is language agnostic – the focus is on the approach not the specific implementation (as this could be applied to any framework or runtime).</p><div class=\"theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z\"></path></svg></span>Spark Training Courses</div><div class=\"admonitionContent_S0QG\"><p><a href=\"https://academy.alphazetta.ai/data-transformation-and-analysis-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Data Transformation and Analysis Using Apache Spark</a><br>\n<a href=\"https://academy.alphazetta.ai/stream-and-event-processing-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Stream and Event Processing using Apache Spark</a><br>\n<a href=\"https://academy.alphazetta.ai/advanced-analytics-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Advanced Analytics Using Apache Spark</a></p></div></div><p>The first challenge you are faced with, is to compare a very large dataset (representing the current state of an object) with another potentially very large dataset (representing new or incoming data). Ideally, you would like the process to be configuration driven and accommodate such things as composite primary keys, or operational columns which you would like to restrict from change detection. You may also want to implement a pattern to segregate sensitive attributes from non-sensitive attributes.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"overview\">Overview<a class=\"hash-link\" href=\"#overview\" title=\"Direct link to heading\">​</a></h2><p>This pattern (and all my other recent attempts) is fundamentally based upon calculating a deterministic hash of the key and non-key attribute(s), and then using this hash as the basis for comparison. The difference between this pattern and my other attempts is in the distillation and reconstitution of data during the process, as well as breaking the pattern into discrete stages (designed to minimize the impact to other applications). This pattern can be used to process delta or full datasets.</p><p>A high-level flowchart representing the basic pattern is shown here:</p><p><a target=\"_blank\" href=\"/assets/files/CDC-59f029c756f942661da9a4744801d227.png\"><img loading=\"lazy\" alt=\"CDC Flowchart\" src=\"/assets/images/CDC-59f029c756f942661da9a4744801d227.png\" width=\"382\" height=\"1118\" class=\"img_ev3q\"></a></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-example\">The Example<a class=\"hash-link\" href=\"#the-example\" title=\"Direct link to heading\">​</a></h2><p>The example provided uses the <a href=\"https://github.com/avensolutions/synthetic-cdc-data-generator\" target=\"_blank\" rel=\"noopener noreferrer\">Synthetic CDC Data Generator application</a>, configuring an incoming set with 5 uuid columns acting as a composite key, and 10 random number columns acting as non key values. The initial days payload consists of 10,000 records, the subsequent days payload consists of another 10,000 records. From the initial dataset, a <code>DELETE</code> operation was performed at the source system for 20% of records, an <code>UPDATE</code> was performed on 40% of the records and the remaining 40% of records were unchanged. In this case the 20% of records that were deleted at the source, were replaced by new <code>INSERT</code> operations creating new keys.</p><p>After creating the synthesized day 1 and day 2 datasets, the files are processed as follows:</p><p>$ spark-submit cdc.py config.yaml data/day1 2019-06-18<br>\n<!-- -->$ spark-submit cdc.py config.yaml data/day2 2019-06-19</p><p>Where <code>config.yaml</code> is the configuration for the dataset, data/day1 and data/day2 represent the different data files, and 2019-06-18 and 2019-06-19 represent a business effective date.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-results\">The Results<a class=\"hash-link\" href=\"#the-results\" title=\"Direct link to heading\">​</a></h2><p>You should see the following output from running the preceding commands for day 1 and day 2 respectively:</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"day-1\">Day 1:<a class=\"hash-link\" href=\"#day-1\" title=\"Direct link to heading\">​</a></h3><iframe width=\"100%\" frameborder=\"0\" id=\"gist-b75edc7825b46c12b328d78d47b4b902\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"day-2\">Day 2:<a class=\"hash-link\" href=\"#day-2\" title=\"Direct link to heading\">​</a></h3><iframe width=\"100%\" frameborder=\"0\" id=\"gist-ca92e132105fb5bb381bf9dfca562bf4\"></iframe><p>A summary analysis of the resultant dataset should show:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-ded1f98dc4fce13c9bb3d12a51a46b94\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"pattern-details\">Pattern Details<a class=\"hash-link\" href=\"#pattern-details\" title=\"Direct link to heading\">​</a></h2><p>Details about the pattern and its implementation follow.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"current-and-historical-datasets\">Current and Historical Datasets<a class=\"hash-link\" href=\"#current-and-historical-datasets\" title=\"Direct link to heading\">​</a></h3><p>The output of each operation will yield a current dataset (that is the current stateful representation of a give object) and a historical dataset partition (capturing the net changes from the previous state in an appended partition).</p><p>This is useful, because often consumers will primarily query the latest state of an object. The change sets (or historical dataset partitions) can be used for more advanced analysis by sophisticated users.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"type-2-scds-sort-of\">Type 2 SCDs (sort of)<a class=\"hash-link\" href=\"#type-2-scds-sort-of\" title=\"Direct link to heading\">​</a></h3><p>Two operational columns are added to each current and historical object:</p><ul><li><code>OPERATION</code> : Represents the last known operation to the record, valid values include :<ul><li><code>I</code> (<code>INSERT</code>)</li><li><code>U</code> (<code>UPDATE</code>)</li><li><code>D</code> (<code>DELETE</code> – hard <code>DELETE</code>s, applies to full datasets only)</li><li><code>X</code> (Not supplied, applies to delta processing only)</li><li><code>N</code> (No change)</li></ul></li><li><code>EFF_START_DATE</code></li></ul><p>Since data structures on most big data or cloud storage platforms are immutable, we only store the effective start date for each record, this is changed as needed with each coarse-grained operation on the current object. The effective end date is inferred by the presence of a new effective start date (or change in the <code>EFF_START_DATE</code> value for a given record).</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-configuration\">The Configuration<a class=\"hash-link\" href=\"#the-configuration\" title=\"Direct link to heading\">​</a></h3><p>I am using a YAML document to store the configuration for the pattern. Important attributes to include in your configuration are a list of keys and non keys and their datatype (this implementation does type casting as well). Other important attributes include the table names and file paths for the current and historical data structures.</p><p>The configuration is read at the beginning of a routine as an input along with the path of an incoming data file (a CSV file in this case) and a business effective date (which will be used as the <code>EFF_START_DATE</code> for new or updated records).</p><p>Processing is performed using the specified key and non key attributes and the output datasets (current and historical) are written to columnar storage files (parquet in this case). This is designed to make subsequent access and processing more efficient.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-algorithm\">The Algorithm<a class=\"hash-link\" href=\"#the-algorithm\" title=\"Direct link to heading\">​</a></h3><p>I have broken the process into stages as follows:</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"stage-1--type-cast-and-hash-incoming-data\">Stage 1 – Type Cast and Hash Incoming Data<a class=\"hash-link\" href=\"#stage-1--type-cast-and-hash-incoming-data\" title=\"Direct link to heading\">​</a></h4><p>The first step is to create deterministic hashes of the configured key and non key values for incoming data. The hashes are calculated based upon a list of elements representing the key and non key values using the MD5 algorithm. The hashes for each record are then stored with the respective record. Furthermore, the fields are casted their target datatype as specified in the configuration. Both of these operations can be performed in a single pass of each row using a <code>map()</code> operation.</p><p>Importantly we only calculate hashes once upon arrival of new data, as the hashes are persisted for the life of the data – and the data structures are immutable – the hashes should never change or be invalidated.</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"stage-2--determine-inserts\">Stage 2 – Determine INSERTs<a class=\"hash-link\" href=\"#stage-2--determine-inserts\" title=\"Direct link to heading\">​</a></h4><p>We now compare Incoming Hashes with previously calculated hash values for the (previous day’s) current object. If no current object exists for the dataset, then it can be assumed this is a first run. In this case every record is considered as an <code>INSERT</code> with an <code>EFF_START_DATE</code> of the business effective date supplied.</p><p>If there is a current object, then the key and non key hash values (only the hash values) are read from the current object. These are then compared to the respective hashes of the incoming data (which should still be in memory).</p><p>Given the full outer join:</p><p>incoming<!-- -->_<!-- -->data(keyhash, nonkeyhash)\nFULL OUTER JOIN<br>\n<!-- -->current<!-- -->_<!-- -->data(keyhash, nonkeyhash)\nON keyhash</p><p>Keys which exist in the left entity which do not exist in the right entity must be the results of an INSERT operation.</p><p>Tag these records with an operation of <code>I</code> with an <code>EFF_START_DATE</code> of the business effective date, then rejoin only these records with their full attribute payload from the incoming dataset. Finally, write out these records to the current and historical partition in <code>overwrite</code> mode.</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"stage-3---determine-deletes-or-missing-records\">Stage 3 - Determine DELETEs or Missing Records<a class=\"hash-link\" href=\"#stage-3---determine-deletes-or-missing-records\" title=\"Direct link to heading\">​</a></h4><p>Referring the previous full outer join operation, keys which exist in the right entity (current object) which do not appear in the left entity (incoming data) will be the result of a (hard) <code>DELETE</code> operation if you are processing full snapshots, otherwise if you are processing deltas these would be missing records (possibly because there were no changes at the source).</p><p>Tag these records as <code>D</code> or <code>X</code> respectively with an <code>EFF_START_DATE</code> of the business effective date, rejoin these records with their full attribute payload from the current dataset, then write out these records to the current and historical partition in <code>append</code> mode.</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"stage-4---determine-updates-or-unchanged-records\">Stage 4 - Determine UPDATEs or Unchanged Records<a class=\"hash-link\" href=\"#stage-4---determine-updates-or-unchanged-records\" title=\"Direct link to heading\">​</a></h4><p>Again, referring to the previous full outer join, keys which exist in both the incoming and current datasets must be either the result of an <code>UPDATE</code> or they could be unchanged. To determine which case they fall under, compare the non key hashes. If the non key hashes differ, it must have been a result of an <code>UPDATE</code> operation at the source, otherwise the record would be unchanged.</p><p>Tag these records as <code>U</code> or <code>N</code> respectively with an <code>EFF_START_DATE</code> of the business effective date (in the case of an update - otherwise maintain the current <code>EFF_START_DATE</code>), rejoin these records with their full attribute payload from the incoming dataset, then write out these records to the current and historical partition in <code>append</code> mode.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"key-callouts\">Key Callouts<a class=\"hash-link\" href=\"#key-callouts\" title=\"Direct link to heading\">​</a></h3><p>A summary of the key callouts from this pattern are:</p><ul><li>Use the RDD API for iterative record operations (such as type casting and hashing)</li><li>Persist hashes with the records</li><li>Use Dataframes for <code>JOIN</code> operations</li><li>Only perform <code>JOIN</code>s with the <code>keyhash</code> and <code>nonkeyhash</code> columns – this minimizes the amount of data shuffled across the network</li><li>Write output data in columnar (Parquet) format</li><li>Break the routine into stages, covering each operation, culminating with a <code>saveAsParquet()</code> action – this may seem expensive but for large datsets it is more efficient to break down DAGs for each operation</li><li>Use caching for objects which will be reused between actions</li></ul><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"metastore-integration\">Metastore Integration<a class=\"hash-link\" href=\"#metastore-integration\" title=\"Direct link to heading\">​</a></h4><p>Although I did not include this in my example, you could easily integrate this pattern with a metastore (such as a Hive metastore or AWS Glue Catalog), by using table objects and <code>ALTER TABLE</code> statements to add historical partitions.</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"further-optimisations\">Further optimisations<a class=\"hash-link\" href=\"#further-optimisations\" title=\"Direct link to heading\">​</a></h4><p>If the incoming data is known to be relatively small (in the case of delta processing for instance), you could consider a broadcast join where the smaller incoming data is distributed to all of the different Executors hosting partitions from the current dataset.</p><p>Also you could add a key to the column config to configure a column to be nullable or not.</p><p>Happy CDCing!</p><blockquote><p>Full source code for this article can be found at: <a href=\"https://github.com/avensolutions/cdc-at-scale-using-spark\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/avensolutions/cdc-at-scale-using-spark</a></p></blockquote>",
            "url": "https://fullstackchronicles.io/change-data-capture-at-scale-using-spark",
            "title": "Change Data Capture at Scale using Spark",
            "summary": "CDC using Spark",
            "date_modified": "2019-06-28T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "big-data",
                "cdc",
                "pyspark",
                "python",
                "spark"
            ]
        },
        {
            "id": "synthetic-cdc-data-generator",
            "content_html": "<p>This is a simple routine to generate random data with a configurable number or records, key fields and non key fields to be used to create synthetic data for source change data capture (CDC) processing. The output includes an initial directory containing CSV files representing an initial data load, and an incremental directory containing CSV files representing incremental data.</p><p>Spark Training Courses from the AlphaZetta Academy</p><p><a href=\"https://academy.alphazetta.ai/data-transformation-and-analysis-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Data Transformation and Analysis Using Apache Spark</a><br>\n<a href=\"https://academy.alphazetta.ai/stream-and-event-processing-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Stream and Event Processing using Apache Spark</a><br>\n<a href=\"https://academy.alphazetta.ai/advanced-analytics-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Advanced Analytics Using Apache Spark</a></p><p>Arguments (by position) include:</p><ul><li><code>no_init_recs</code> : the number of initial records to generate</li><li><code>no_incr_recs</code> : the number of incremental records on the second run - should be <code>&gt;= no_init_recs</code></li><li><code>no_keys</code> : number of key columns in the dataset – keys are generated as UUIDs</li><li><code>no_nonkeys</code> : number of non-key columns in the dataset – nonkey values are generated as random numbers</li><li><code>pct_del</code> : percentage of initial records deleted on the second run - between 0.0 and 1.0</li><li><code>pct_upd</code> : percentage of initial records updated on the second run - between 0.0 and 1.0</li><li><code>pct_unchanged</code> : percentage of records unchanged on the second run - between 0.0 and 1.0</li><li><code>initial_output</code> : folder for initial output in CSV format</li><li><code>incremental_output</code> : folder for incremental output in CSV format</li></ul><p>NOTE : <code>pct_del</code> + <code>pct_upd</code> + <code>pct_unchanged</code> must equal 1.0</p><p>Example usage:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">$ spark-submit synthetic-cdc-data-generator.py 100000 100000 2 3 0.2 0.4 0.4 data/day1 data/day2</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p>Example output from the <strong><em>day1</em></strong> run for the above configuration would look like this:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-befb034da2b4f25a1dbbc0e9b4b8eef6\"></iframe><p>Note that this routine can be run subsequent times producing different key and non key values each time, as the keys are UUIDs and the values are random numbers.</p><p>We will use this application to generate random input data to demonstrate CDC using Spark in a subsequent post, see you soon!</p><blockquote><p>Full source code can be found at: <a href=\"https://github.com/avensolutions/synthetic-cdc-data-generator\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/avensolutions/synthetic-cdc-data-generator</a></p></blockquote>",
            "url": "https://fullstackchronicles.io/synthetic-cdc-data-generator",
            "title": "Synthetic CDC Data Generator",
            "summary": "This is a simple routine to generate random data with a configurable number or records, key fields and non key fields to be used to create synthetic data for source change data capture (CDC) processing. The output includes an initial directory containing CSV files representing an initial data load, and an incremental directory containing CSV files representing incremental data.",
            "date_modified": "2019-06-28T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "cdc",
                "python",
                "spark"
            ]
        },
        {
            "id": "scalable-secure-application-load-balancing-with-vpc-native-gke-and-istio",
            "content_html": "<p><img loading=\"lazy\" alt=\"istio\" src=\"/assets/images/istio-blog-feature-image-bf7f8601d3739fbff4f1bb3a50f4f730.png\" width=\"352\" height=\"181\" class=\"img_ev3q\"></p><p>At the time of this writing, GCP does not have a generally available non-public facing Layer 7 load balancer. While this is sure to change in the future, this article outlines a design pattern which has been proven to provide scalable and extensible application load balancing services for multiple applications running in Kubernetes pods on GKE.</p><p>When you create a service of type LoadBalancer in GKE, Kubernetes hooks into the provider (GCP in this case) on your behalf to create a Google Load Balancer, while this may be specified as INTERNAL, there are two issues:</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"issue-1\">Issue #1:<a class=\"hash-link\" href=\"#issue-1\" title=\"Direct link to heading\">​</a></h3><p>The GCP load balancer created for you is a Layer 4 TCP load balancer.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"issue-2\">Issue #2:<a class=\"hash-link\" href=\"#issue-2\" title=\"Direct link to heading\">​</a></h3><p>The normal behaviour is for Google to enumerate all of the node pools in your GKE cluster and “automagically” create mapping GCE instance groups for each node pool for each zone the instances are deployed in. This means the entire surface area of your cluster is exposed to the external network – which may not be optimal for internal applications on a multi tenanted cluster.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-solution\">The Solution:<a class=\"hash-link\" href=\"#the-solution\" title=\"Direct link to heading\">​</a></h3><p>Using <a href=\"https://istio.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Istio</a> deployed on GKE along with the <a href=\"https://istio.io/docs/concepts/traffic-management/#ingress-and-egress\" target=\"_blank\" rel=\"noopener noreferrer\">Istio Ingress Gateway</a> along with an externally created load balancer, it is possible to get scalable HTTP load balancing along with all the normal ALB goodness (stickiness, path-based routing, host-based routing, health checks, TLS offload, etc.).</p><p>An abstract depiction of this architecture is shown here:</p><p><a target=\"_blank\" href=\"/assets/files/istio-ingress-blog-7f3d087a733de5cfabac40cf44b99bba.png\"><img loading=\"lazy\" alt=\"Istio Ingress Design Pattern for VPC Native GKE Clusters\" src=\"/assets/images/istio-ingress-blog-7f3d087a733de5cfabac40cf44b99bba.png\" width=\"942\" height=\"268\" class=\"img_ev3q\"></a></p><p>This can be deployed with a combination of <a href=\"https://www.terraform.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Terraform</a> and kubectl. The steps to deploy at a high level are:</p><ol><li>Create a GKE cluster with at least two node pools: ingress-nodepool and service-nodepool. Ideally create these node pools as multi-zonal for availability. You could create additional node pools for your Egress Gateway or an operations-nodepool to host Istio, etc as well.</li><li>Deploy Istio.</li><li>Deploy the Istio Ingress Gateway service on the ingress-nodepool using Service type NodePort.</li><li>Create an associated Certificate Gateway using server certificates and private keys for TLS offload.</li><li>Create a service in the service-nodepool.</li><li>Reserve an unallocated static IP address from the node network range.</li><li><a href=\"https://cloud.google.com/load-balancing/docs/internal/setting-up-internal\" target=\"_blank\" rel=\"noopener noreferrer\">Create an internal TCP load balancer</a>:<ol><li>Specify the frontend as the IP address reserved in step 6.</li><li>Specify the backend as the managed instance groups created during the node pool creation for the ingress-nodepool (ingress-nodepool-ig-a, ingress-nodepool-ig-b, ingress-nodepool-ig-c).</li><li>Specify ports 80 and 443.</li></ol></li><li>Create a GCP Firewall Rule to allow traffic from authorized sources (network tags or CIDR ranges) to a target of the ingress-nodepool network tag.</li><li>Create a Cloud DNS A Record for your managed zone as <!-- -->*<!-- -->.namespace.zone pointing to the IP Address assigned to the load balancer frontend in step 7.1.</li><li><a href=\"https://cloud.google.com/load-balancing/docs/health-checks#firewall_rules\" target=\"_blank\" rel=\"noopener noreferrer\">Enable Health Checks through the GCP firewall</a> to reach the ingress-nodepool network tag at a minimum – however there is no harm in allowing these to all node pools.</li></ol><p>The service should then be resolvable and routable from authorized internal networks (peered private VPCs or internal networks connected via VPN or Dedicated Interconnect) as:</p><blockquote><p>https://_service<strong>.</strong>namespace<strong>.</strong>zone<strong>/</strong>endpoint__</p></blockquote><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-advantages-of-this-design-pattern-are\">The advantages of this design pattern are...<a class=\"hash-link\" href=\"#the-advantages-of-this-design-pattern-are\" title=\"Direct link to heading\">​</a></h3><ol><li>The Ingress Gateway provides fully functional application load balancing services.</li><li>Istio provides service discovery and routing using names and namespaces.</li><li>The Ingress Gateway service and ingress gateway node pool can be scaled as required to meet demand.</li><li>The Ingress Gateway is multi zonal for greater availability</li></ol>",
            "url": "https://fullstackchronicles.io/scalable-secure-application-load-balancing-with-vpc-native-gke-and-istio",
            "title": "Scalable, Secure Application Load Balancing with VPC Native GKE and Istio",
            "summary": "istio",
            "date_modified": "2019-05-18T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "cloud",
                "gcp",
                "google-cloud-platform",
                "istio",
                "load-balancing",
                "vpc-native"
            ]
        },
        {
            "id": "aws-professional-and-speciality-exam-tips",
            "content_html": "<p><img loading=\"lazy\" alt=\"AWS pro and specialty certs\" src=\"/assets/images/aws-pro-and-specialty-certs-a59c918c0eca2166f45da74caa84df05.png\" width=\"359\" height=\"271\" class=\"img_ev3q\"></p><p>One you get beyond the Associate level AWS certification exams into the Professional or Speciality track exams the degree of difficulty rises significantly. As a veteran of the Certified Solutions Architect Professional and Big Data Specialty exams, I thought I would share my experiences which I believe are applicable to all the certification streams and tracks in the AWS certification program.</p><p>First off let me say that I am a self-professed certification addict, having sat more than thirty technical certification exams over my thirty plus year career in technology including certification and re-certification exams. I would put the AWS professional and specialty exams right up there in terms of their level of difficulty.</p><p>The AWS Professional and Specialty exams are specifically designed to be challenging. Although they have removed the pre-requisites for these exams (much to my dismay…), you really need to be prepared for these exams otherwise you are throwing your hard-earned money away.  </p><p>There are very few - if any - “easy” questions. All of the questions are scenario based and require you to design a solution to meet multiple requirements. The question and/or the correct answer will invariably involve the use of multiple AWS services (not just one). You will be tested on your reading comprehension, time management and ability to cope under pressure as well as being tested on your knowledge of the AWS platform.  </p><p>The following sections provide some general tips which will help you approach the exam and give you the best chance of success on the day. This is not a brain dump or a substitute for the hard work and dedication required to ensure success on your exam day.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"time-management\">Time Management<a class=\"hash-link\" href=\"#time-management\" title=\"Direct link to heading\">​</a></h2><p>Needless to say, your ability to manage time is critical, on average you will have approximately 2-3 minutes to answer each question. Reading the questions and answers carefully may take up 1-2 minutes on its own. If the answer is not apparent to you, you are best to mark the question and come back to it at the end of the exam.  </p><p>In many cases there may be subsequent questions and answer sets which jog your memory or help you deduce the correct answers to the questions you initial passed on. For instance, you may see references in future questions which put context around services you may not be completely familiar with, this may enable you to answer flagged questions with more confidence.  </p><p>Of course, you must answer all questions before completing the exam, there are no points for incomplete or unattempted answers.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"recommended-approach-to-each-question\">Recommended Approach to each Question<a class=\"hash-link\" href=\"#recommended-approach-to-each-question\" title=\"Direct link to heading\">​</a></h2><p>Most of the questions on the Professional or Specialty certification exams fall into one of three categories:</p><ul><li>Short-ish question, multiple long detailed answer options</li><li>Long-ish scenario question, multiple relatively short answer options</li><li>Long-ish question with multiple relatively long, detailed answers</li></ul><p>The latter scenario is thankfully less common. However, in all cases it is important to read the last sentence in the question first, this will provide indicators to help you read through the question in its entirety and all of the possible answers with a clear understanding of what is <em>“really”</em> being asked. For instance, the operative phrase may be <em>“highly available”</em> or <em>“most cost effective”</em>.</p><p>Try to eliminate answers based on what you know, for instance answers with erroneous instance families can be eliminated immediately. This will give you a much better statistical chance of success, even if you have to venture an educated guess in the end.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"the-most-complicated-solution-is-probably-not-the-correct-one\">The Most Complicated Solution is Probably Not the Correct One<a class=\"hash-link\" href=\"#the-most-complicated-solution-is-probably-not-the-correct-one\" title=\"Direct link to heading\">​</a></h2><p>In many answer sets to questions on the Professional or Specialty exams you will see some ridiculously complicated solution approaches, these are most often incorrect answers. Although there may be enough loosely relevant terminology or services to appear reasonable.</p><p>Note the following statement direct from the AWS Certified Solutions Architect Professional Exam Blueprint:</p><blockquote><p>“Distractors, or incorrect answers, are response options that an examinee with incomplete knowledge or skill would likely choose. However, they are generally plausible responses that fit in the content area defined by the test objective.”</p></blockquote><p>AWS wants professionals who design and implement solutions which are simple, sustainable, highly available, scalable and cost effective. One of the key Amazon Leadership Principles is <em>“Invent and Simplify”</em>, simplify is often the operative word.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"dont-spend-time-on-dumps-or-practice-exams-other-than-those-from-aws\">Don’t spend time on dumps or practice exams (other than those from AWS)<a class=\"hash-link\" href=\"#dont-spend-time-on-dumps-or-practice-exams-other-than-those-from-aws\" title=\"Direct link to heading\">​</a></h2><p>The question pools for AWS exams are enormous, the chances of you getting the same questions and answer sets as someone else are slim. Furthermore, non-AWS sources may not be trustworthy. There is no substitute to AWS white papers, how to’s, and real-life application of your learnings.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"dont-focus-on-service-limits-or-calculations\">Don’t focus on Service Limits or Calculations<a class=\"hash-link\" href=\"#dont-focus-on-service-limits-or-calculations\" title=\"Direct link to heading\">​</a></h2><p>In my experiences with AWS exams, they are not overly concerned with service limits, default values, formulas (e.g. the formula to calculate required partitions for a DynamoDB table) or syntax - so don’t waste time remembering them. You should however understand the 7 layer OSI model and be able to read and interpret CIDR notation.</p><p>Mainly, however, they want you to understand how services work together in an AWS solution to achieve an outcome for a customer.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"some-final-words-of-advice\">Some Final Words of Advice<a class=\"hash-link\" href=\"#some-final-words-of-advice\" title=\"Direct link to heading\">​</a></h2><p><strong>Always do what you think AWS would want you to do!</strong>&nbsp;</p><p>It is worthwhile having a quick look at the <a href=\"https://blog.aboutamazon.com.au/amazon-in-australia/our-leadership-principles\" target=\"_blank\" rel=\"noopener noreferrer\">AWS Leadership Principles</a> (I have already referenced one of these in this article) as these are applied religiously in every aspect of the AWS business.&nbsp; In particular, you should pay specific attention to the principals around simplicity and frugality.</p><p><strong>Good luck!</strong></p>",
            "url": "https://fullstackchronicles.io/aws-professional-and-speciality-exam-tips",
            "title": "AWS Professional and Speciality Exam Tips",
            "summary": "AWS pro and specialty certs",
            "date_modified": "2019-04-04T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "aws",
                "certification"
            ]
        },
        {
            "id": "gcp-networking-for-aws-professionals",
            "content_html": "<p><img loading=\"lazy\" alt=\"GCP AWS Networking\" src=\"/assets/images/gcp-aws-networking-128b44a70d9aac84888edf1df21b0e39.png\" width=\"686\" height=\"271\" class=\"img_ev3q\"></p><p>GCP and AWS share many similarities, they both provide similar services and both leverage containerization, virtualization and software defined networking.</p><p>There are some significant differences when it comes to their respective implementations, networking is a key example of this.</p><p>Before we compare and contrast the two different approaches to networking, it is worthwhile noting the genesis of the two major cloud providers.</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"google-was-born-to-be-global-amazon-became-global\"><em>Google was born to be global, Amazon became global</em><a class=\"hash-link\" href=\"#google-was-born-to-be-global-amazon-became-global\" title=\"Direct link to heading\">​</a></h4><p>By no means am I suggesting that Amazon didn't have designs on going global from it's beginnings, but AWS was driven (entirely at the beginning) by the needs of the Amazon eCommerce business. Amazon started in the US before expanding into other regions (such as Europe and Australia). In some cases the expansion took decades (Amazon only entered Australia as a retailer in 2018).</p><p>Google, by contrast, was providing application, search and marketing services worldwide from its very beginning. GCP which was used as the vector to deliver these services and applications was architected around this global model, even though their actual data centre expansion may not have been as rapid as AWS’s (for example GCP opened its Australia region 5 years after AWS).</p><p>Their respective networking implementations reflect how their respective companies evolved.</p><h4 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"aws-is-a-leader-in-iaas-gcp-is-a-leader-in-paas\"><em>AWS is a leader in IaaS, GCP is a leader in PaaS</em><a class=\"hash-link\" href=\"#aws-is-a-leader-in-iaas-gcp-is-a-leader-in-paas\" title=\"Direct link to heading\">​</a></h4><p>This is only an opinion and may be argued, however if you look at the chronology of the two platforms, consider this:</p><ul><li>The first services released by AWS (simultaneously for all intents and purposes) were S3, SQS and EC2</li><li>The first service released by Google was AppEngine (a pure PaaS offering)</li></ul><p>Google has launched and matured their IaaS offerings since as AWS has done similarly with their PaaS offerings, but they started from much different places.</p><p>With all of that said, here are the key differences when it comes to networking between the two major cloud providers:</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"gcp-vpcs-are-global-by-default-aws-vpcs-are-regional-only\">GCP VPCs are Global by default, AWS VPCs are Regional only<a class=\"hash-link\" href=\"#gcp-vpcs-are-global-by-default-aws-vpcs-are-regional-only\" title=\"Direct link to heading\">​</a></h3><p>This is the first fundamental difference between the two providers. Each GCP project is allocated one VPC network with Subnets in each of the 18 GCP Regions. Whereas each AWS Account is allocated one Default VPC in each AWS Region with a Subnet in each AWS Availability Zone for that Region, that is each account has 17 VPCs in each of the 17 Regions (excluding GovCloud regions).</p><p><a target=\"_blank\" href=\"/assets/files/gcp-default-network-bb8c3f62583663e872cc53948671005f.png\"><img loading=\"lazy\" alt=\"Default Global VPC Network in GCP\" src=\"/assets/images/gcp-default-network-bb8c3f62583663e872cc53948671005f.png\" width=\"1920\" height=\"1080\" class=\"img_ev3q\"></a></p><p>It is entirely possible to create VPCs in GCP which are Regional, but they are Global by default.</p><p>This global tenancy can be advantageous in many cases, but can be limiting in others, for instance there is a limit of 25 peering connections to any one VPC, the limit in AWS is 125.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"gcp-subnets-are-regional-aws-subnets-are-zonal\">GCP Subnets are Regional, AWS Subnets are Zonal<a class=\"hash-link\" href=\"#gcp-subnets-are-regional-aws-subnets-are-zonal\" title=\"Direct link to heading\">​</a></h3><p>Subnets in GCP automatically span all Zones in a Region, whereas AWS VPC Subnets are assigned to Availability Zones in a Region. This means you are abstracted from some of the networking and zonal complexity, but you have less control over specific network placement of instances and endpoints. You can infer from this design that Zones are replicated or synchronised within a Region, making them less of a direct consideration for High Availability (or at least as much or your concern as they otherwise would be).</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"all-gcp-firewall-rules-are-stateful\">All GCP Firewall Rules are Stateful<a class=\"hash-link\" href=\"#all-gcp-firewall-rules-are-stateful\" title=\"Direct link to heading\">​</a></h3><p>AWS Security Groups are stateful firewall rules – meaning they maintain connection state for inbound connections, AWS also has Network ACLs (NACLs) which are stateless firewall rules. GCP has no direct equivalent of NACLs, however GCP Firewall Rules are more configurable than their AWS counterparts. For instance, GCP Firewall Rules can include Deny actions which is not an option with AWS Security Group Rules.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"load-balancers-in-gcp-are-layer-4-tcpudp-unless-they-are-public-facing\">Load Balancers in GCP are layer 4 (TCP/UDP) unless they are public facing<a class=\"hash-link\" href=\"#load-balancers-in-gcp-are-layer-4-tcpudp-unless-they-are-public-facing\" title=\"Direct link to heading\">​</a></h3><p>AWS Application Load Balancers can be deployed in private VPCs with no external IPs attached to them. GCP has Application Load Balancers (Layer 7 load balancers) but only for public facing applications, internal facing load balancers in GCP are Network Load Balancers. This presents some challenges with application level load balancing functionality such as stickiness. There are potential workarounds however such as NGINX in GKE behind</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"firewall-rules-are-at-the-network-level-not-at-the-instance-or-service-level\">Firewall rules are at the Network Level not at the Instance or Service Level<a class=\"hash-link\" href=\"#firewall-rules-are-at-the-network-level-not-at-the-instance-or-service-level\" title=\"Direct link to heading\">​</a></h3><p>There are simple firewall settings available at the instance level, these are limited to allowing HTTP and HTTPS traffic to the instance only and don’t allow you to specify sources. Detailed Firewall Rules are set at the GCP VPC Network level and are not attached or associated with instances as they are in AWS.</p><p><em>Hopefully this is helpful for AWS engineers and architects being exposed to GCP for the first time!</em></p>",
            "url": "https://fullstackchronicles.io/gcp-networking-for-aws-professionals",
            "title": "GCP Networking for AWS Professionals",
            "summary": "A primer on GCP networking for AWS engineers and architects",
            "date_modified": "2019-02-21T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "aws",
                "cloud",
                "gcp",
                "google-cloud-platform",
                "networking"
            ]
        },
        {
            "id": "the-streaming-data-warehouse-kappa-architecture-and-data-warehousing-re-imagined",
            "content_html": "<h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"kappa-architecture-and-data-warehousing-re-imagined\">Kappa Architecture and Data Warehousing re-imagined<a class=\"hash-link\" href=\"#kappa-architecture-and-data-warehousing-re-imagined\" title=\"Direct link to heading\">​</a></h3><p><img loading=\"lazy\" alt=\"Streaming Data Warehouse\" src=\"/assets/images/sdw-be6a1908ddfd66e86e152b05da8c227b.png\" width=\"780\" height=\"401\" class=\"img_ev3q\"></p><p>The aspiration to extend data analysis (predictive, descriptive or otherwise) to streaming event data has been common across every enterprise scale program I have been involved with. Often, however, this aspiration goes unrealised as it tends to slide down the priority scale as we still grapple with legacy batch oriented integration patterns and processes.</p><p>Event processing is not a new concept, real time event and transaction processing has been a standard feature for security, digital and operations functions for some time, however in the Data Warehousing, BI and Advanced Analytics worlds it is often spoken about but rarely implemented, except for tech companies of course. In many cases personalization is still a batch oriented process, e.g. train a model from a feature set built from historical data, generate recommendations in batch, serve these recommendations upon the next visit - wash, rinse, and repeat.</p><p>Lambda has existed for several years now as a data-processing architecture pattern designed to incorporate both batch and stream-processing capabilities. Moreover, messaging platforms have existed for decades, from point-to-point messaging systems, to message-oriented-middleware systems, to distributed pub-sub messaging systems such as Apache Kafka.</p><p>Additionally, open source streaming data processing frameworks and tools have proliferated in recent years with projects such as Storm, Samza, Flink and Spark Streaming becoming established solutions.</p><p>Kafka in particular, with its focus on durability, resiliency, availability and consistency, has graduated into fully fledged data platform <strong>not simply a transient messaging system</strong>. In many cases Kafka is serving as a back end for operational processes, such as applications implementing the CQRS (Command Query Responsibility Segregation) design pattern.  </p><p>In other words, it is not the technology that holds us back, it's our lack of imagination.</p><p>Enter <a href=\"http://milinda.pathirage.org/kappa-architecture.com/\" target=\"_blank\" rel=\"noopener noreferrer\">Kappa Architecture</a> where we no longer have to attempt to integrate streaming data with batch processes…<strong>everything is a stream</strong>. The ultimate embodiment of Kappa Architecture is the <strong><em>Streaming Data Warehouse</em></strong>.</p><p>In the Streaming Data Warehouse, tables are represented by topics. Topics represent either:</p><ul><li>unbounded event or change streams; or</li><li>stateful representations of data (such as master, reference or summary data sets).</li></ul><p>This approach makes possible the enrichment and/or summarisation of transaction or event data with master or reference data. Furthermore many of the patterns used in data warehousing and master data management are inherent in Kafka as you can represent the current state of an object as well as the complete change history of that object (in other words change data capture and associated slowly changing dimensions from one inbound stream).</p><p>Data is acquired from source systems either in real time or as a scheduled extract process, <strong>in either case the data is presented to Kafka as a stream</strong>.</p><p>The Kafka Avro Schema Registry provides a systematic contract with source systems which also serves as a data dictionary for consumers supporting schema evolution with backward and forward compatibility. Data is retained on the Kafka platform for a designated period of time (days or weeks) where it is available for applications and processes to consume - these processes can include data summarisation or sliding window operations for reporting or notification, or data integration or datamart building processes which sink data to other systems - these could include relational or non-relational data stores.</p><p>Real time applications can be built using the KStreams API and emerging tools such as KSQL can be used to provide a well-known interface for sampling streaming data or performing windowed processing operations on streams. Structured Streaming in Spark or Spark Streaming in its original RDD/DStream implementation can be used to prepare and enrich data for machine learning operations using Spark ML or Spark MLlib.  </p><p>In addition, data sinks can operate concurrently to sink datasets to S3 or Google Cloud Storage or both (multi cloud - like real time analytics - is something which is talked about more than it’s implemented…).</p><p>In the Streaming Data Warehouse architecture Kafka is much more than a messaging platform it is a distributed data platform, which could easily replace major components of a legacy (or even a modern) data architecture.  </p><p>It just takes a little imagination…</p>",
            "url": "https://fullstackchronicles.io/the-streaming-data-warehouse-kappa-architecture-and-data-warehousing-re-imagined",
            "title": "The Streaming Data Warehouse",
            "summary": "Kappa Architecture and Data Warehousing re-imagined",
            "date_modified": "2019-02-14T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "data-warehousing",
                "kafka",
                "kappa-architecture",
                "stream-processing",
                "streaming-analytics"
            ]
        },
        {
            "id": "test-driven-infrastructure-and-test-automation-with-ansible-molecule-and-azure",
            "content_html": "<p><img loading=\"lazy\" alt=\"Molecule Ansible Azure\" src=\"/assets/images/molecule-ansible-azure-2437124ec0927c07c287635f016a6265.png\" width=\"524\" height=\"351\" class=\"img_ev3q\"></p><p>A few years back, before the rise of the hyper-scalers, I had my first infracode 'aha moment' with OpenStack. The second came with <a href=\"https://kitchen.ci/\" target=\"_blank\" rel=\"noopener noreferrer\">Kitchen</a>.</p><p>I had already been using test driven development for application code and configuration automation for infrastructure but Kitchen brought the two together. Kitchen made it possible to write tests, spin up infrastructure, and then tear everything down again - the Red/Green/Refactor cycle for infrastructure. What made this even better was that it wasn't a facsimile of a target environment, it was the same - same VM's, same OS, same network.</p><p>Coming from a Chef background for configuration automation, Kitchen is a great fit to the Ruby ecosystem. Kitchen works with Ansible and Azure, but a Ruby environment and at least a smattering of Ruby coding skills are required.</p><p><a href=\"https://molecule.readthedocs.io/\" target=\"_blank\" rel=\"noopener noreferrer\">Molecule</a> provides a similar red-green development cycle to Kitchen, but without the need to step outside of the familiar Python environment.</p><p>Out of the box, Molecule supports development of Ansible roles using either a Docker or Virtual Box infrastructure provider. Molecule also leverages the Ansible drivers for private and public cloud platforms.</p><p>Molecule can be configured to test an individual role or collections of roles in Ansible playbooks.</p><p>This tutorial demonstrates how to use Molecule with Azure to develop and test an individual Ansible role following the red/green/refactor infracode workflow, which can be generalised as:</p><ul><li><strong>Red</strong>-<!-- --> write a failing infrastructure test</li><li><strong>Green</strong> - write the Ansible tasks needed to pass the test</li><li>Refactor - repeat the process</li></ul><p>The steps required for this tutorial are as follows:</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"azure-setup\">Azure setup<a class=\"hash-link\" href=\"#azure-setup\" title=\"Direct link to heading\">​</a></h2><p>Ensure there is an existing Azure Resource Group that will be used for infracode development and testing. Within the resource group, ensure there is a single virtual network (vnet) with a single subnet. Ansible will use these for the default network setup.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"setup-a-working-environment\">Setup a working environment<a class=\"hash-link\" href=\"#setup-a-working-environment\" title=\"Direct link to heading\">​</a></h2><p>There are a number of options for setting up a Python environment for Ansible and Molecule, including Python virtualenv or a Docker container environment.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-a-docker-image-for-ansiblemoleculeazure\">Create a Docker image for Ansible+Molecule+Azure<a class=\"hash-link\" href=\"#create-a-docker-image-for-ansiblemoleculeazure\" title=\"Direct link to heading\">​</a></h2><p>This tutorial uses a Docker container environment. A <code>Dockerfile</code> for the image can be found in <code>./molecule-azure-image/Dockerfile</code>. The image sets up a sane Python3 environment with Ansible, Ansible<!-- -->[<!-- -->azure<!-- -->]<!-- -->, and Molecule <code>pip</code> modules installed.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-4bd0c2ccae06dcaedffc2d91e594145f\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-a-docker-workspace\">Create a Docker workspace<a class=\"hash-link\" href=\"#create-a-docker-workspace\" title=\"Direct link to heading\">​</a></h2><p>Setup a working environment using the Docker image with Ansible, Molecule, and the <code>azure-cli</code> installed.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-f80ef20a720914cfd4e02cf9783fec06\"></iframe><p>This example assumes the following:</p><ul><li>a resource group already exists with access rights to create virtual machines; and</li><li>the resource group contains a single vnet with a single subnet</li></ul><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"log-into-an-azure-subcription\">Log into an Azure subcription<a class=\"hash-link\" href=\"#log-into-an-azure-subcription\" title=\"Direct link to heading\">​</a></h2><p>Ansible supports a number of different methods for authenticating with Azure. This example uses the <code>azure-cli</code> to login interactively.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-fd8987e7f724de5393a411c24c74978b\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"create-an-empty-ansible-role-with-molecule\">Create an empty Ansible role with Molecule<a class=\"hash-link\" href=\"#create-an-empty-ansible-role-with-molecule\" title=\"Direct link to heading\">​</a></h2><p>Molecule provides an <code>init</code> function with defaults for various providers. The molecule-azure-role-template creates an empty role with scaffolding for Azure.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-f9b301d950a2254ab9af4806f2110544\"></iframe><p>Check that the environment is working by running the following code:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-d56c3cd1e25b51acc634e5adb8a0a256\"></iframe><p>The output should look be similar to…</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-a3f8aed99a7c910588a5651d8cabf0e8\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"spin-up-an-azure-vm\">Spin up an Azure VM<a class=\"hash-link\" href=\"#spin-up-an-azure-vm\" title=\"Direct link to heading\">​</a></h2><p>Spin up a fresh VM to be used for infra-code development.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-14a621ee65f9c2db583ed5ef94274c71\"></iframe><p>Molecule provides a handy option for logging into the new VM:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-456aa8a8860bf785b382e18ede204d33\"></iframe><p>There is now a fresh Ubuntu 18.04 virtual machine ready for infra-code development. For this example, a basic Nginx server will be installed and verified.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"write-a-failing-test\">Write a failing test<a class=\"hash-link\" href=\"#write-a-failing-test\" title=\"Direct link to heading\">​</a></h2><p><a href=\"https://testinfra.readthedocs.io/en/latest/\" target=\"_blank\" rel=\"noopener noreferrer\">Testinfra</a> provides a <code>pytest</code> based framework for verifying server and infrastructure configuration. Molecule then manages the execution of those <code>testinfra</code> tests. The Molecule template provides a starting point for crafting tests of your own. For this tutorial, installation of the <code>nginx</code> service is verified. Modify the tests file using <code>vi molecule/default/tests/test_default.py</code></p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-5b22b20a192aecbecb8cc229cb5f2a69\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"execute-the-failing-test\">Execute the failing test<a class=\"hash-link\" href=\"#execute-the-failing-test\" title=\"Direct link to heading\">​</a></h2><p>The Ansible task needed to install and enable <code>nginx</code> has not yet been written, so the test should fail:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-38eb4bb776a41db7aa68f5962a97af62\"></iframe><p>If the initial sample tests in <code>test_default.py</code> are kept, then 3 tests should fail and 2 tests should pass.</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"write-a-task-to-install-nginx\">Write a task to install <code>nginx</code><a class=\"hash-link\" href=\"#write-a-task-to-install-nginx\" title=\"Direct link to heading\">​</a></h2><p>Add a task to install the <code>nginx</code> service using <code>vi tasks/main.yml</code>:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-40d884f0c3a39fc4b3e921d451d60358\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"apply-the-role\">Apply the role<a class=\"hash-link\" href=\"#apply-the-role\" title=\"Direct link to heading\">​</a></h2><p>Apply the role to the instance created using Molecule.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-5787aee41e2e3e9373f656677567ae41\"></iframe><p>The <code>nginx</code> package should now be installed, both enabled and started, and listening on port 80. Note that the <code>nginx</code> instance will not be accessible from the Internet due to the Azure network security rules. The <code>nginx</code> instance can be confirmed manually by logging into the instance and using <code>curl</code> to make a request to the <code>nginx</code> service.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-fb02518e7129bf28e27822c42221f706\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"execute-the-passing-test\">Execute the passing test<a class=\"hash-link\" href=\"#execute-the-passing-test\" title=\"Direct link to heading\">​</a></h2><p>After applying the Ansible task to the instance, the <code>testinfra</code> tests should now pass.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-b6359519ca6068615f8f1473636f90ea\"></iframe><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"cleanup\">Cleanup<a class=\"hash-link\" href=\"#cleanup\" title=\"Direct link to heading\">​</a></h2><p>Now that the Ansible role works as defined in the test specification, the development environment can be cleaned up.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-150971a02b3f4b2c65d551cb09a203d0\"></iframe><p>Molecule removes the Azure resources created to develop and test the configuration role. Note that deletion may take a few minutes.</p><p>Finally, once you are done, exit the container environment. If the container was started with the <code>--rm</code> switch, the container will also be removed, leaving you with a clean workspace and newly minted Ansible role with automated test cases.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-4fbb00b116b1a389b0343f6424b19a1b\"></iframe>",
            "url": "https://fullstackchronicles.io/test-driven-infrastructure-and-test-automation-with-ansible-molecule-and-azure",
            "title": "Test Driven Infrastructure and Test Automation with Ansible, Molecule and Azure",
            "summary": "Molecule Ansible Azure",
            "date_modified": "2019-01-31T00:00:00.000Z",
            "author": {
                "name": "Chris Ottinger",
                "url": "https://github.com/datwiz"
            },
            "tags": [
                "ansible",
                "azure",
                "cloud",
                "infrastructure-code",
                "molecule",
                "python",
                "test-automation"
            ]
        },
        {
            "id": "when-life-gives-you-undrinkable-wine-make-cognac",
            "content_html": "<p><img loading=\"lazy\" alt=\"Make Cognac\" src=\"/assets/images/shutterstock_425848342-2d637d243e9723efcc27775d70ce4b6c.jpg\" width=\"1200\" height=\"627\" class=\"img_ev3q\"></p><p>Firstly, this is not another motivational talk or motherhood statement (there are plenty of those out there already), but a metaphor about resourcefulness.</p><p>We have all heard the adage “when life gives you lemons, make lemonade”. Allow me to present a slight twist (pardon the pun…) on this statement.</p><p>Cognac is a variety of brandy named after the town of Cognac, France. It is distilled from a white wine grown from grapes in the area. The wine used to make Cognac is characterised as \"virtually undrinkable\". However in its distilled form, Cognac is considered to be the world's most refined spirit. With bottles of high end Cognac fetching as much as $200,000.</p><p>The area surrounding the town of Cognac was a recognised wine-growing area dating back to the third century, however when it was evident that the grapes produced in the town of Cognac itself were unsuitable for wine making, local producers developed the practice of double distillation in copper pot stills and ageing in oak barrels for at least two years. The product yielded was the spirit we now know as Cognac.</p><p>Fast forward 15 centuries to Scotland in the 1800’s, where John Walker was a humble shopkeeper. Local whiskey producers would bring John different varieties of single malt whiskeys, many of them below an acceptable standard. Instead of on selling these varieties – he began blending them as made-to-order whiskies, blended to meet specific customer requirements. From this idea a product (and subsequently one of the most globally recognised brands) was created which would last over 200 years.</p><p><strong>Interesting, but what does this have to do with technology you might ask?</strong></p><p>Ingenuity and resourcefulness have existed for as long as man has, but in the realm of technology and in particular cloud computing and open source software it has never been more imperative. We are continually faced with challenges on each assignment or project, often technology not working as planned or as advertised, or finding dead ends when trying to solve problems. This is particularly evident now as software and technology are moving at such an accelerated rate.</p><p>To be successful in this era you need creativity and lateral thinking. You need an ability not just to solve problems to which there are no documented solutions, but to create new products from existing ones which are not necessarily suitable for your specific objective. In many cases, looking to add value in the process. That is not just making lemonade from lemons (which anyone could think of) but making Cognac from sub-standard grapes or premium blended whiskey from sub-standard single malt whiskies.</p><p>One of my favourite Amazon Leadership Principles is <strong><em>“Invent and Simplify”</em></strong>:</p><blockquote><p><em>Leaders expect and require innovation and invention from their teams and always find ways to simplify. They are externally aware, look for new ideas from everywhere, and are not limited by “not invented here\". As we do new things, we accept that we may be misunderstood for long periods of time.</em></p><p><a href=\"https://www.amazon.jobs/en/principles\" target=\"_blank\" rel=\"noopener noreferrer\"><em><strong>https:</strong></em><strong>//www.amazon.jobs/en/principles</strong></a>  </p></blockquote><p>The intent in this statement is not simply to “lift and shift” current on premise systems and processes to the cloud, but to look for ways to streamline, rationalise and simplify processes in doing so. This mandates a combination of practicality and creativity.</p><p>The take away is when you are presented with a challenge, be creative and inventive and not just solve the problem but look for ways to add value in the process.</p><p>Cheers!</p>",
            "url": "https://fullstackchronicles.io/when-life-gives-you-undrinkable-wine-make-cognac",
            "title": "When Life Gives you Undrinkable Wine – Make Cognac…",
            "summary": "Make Cognac",
            "date_modified": "2019-01-30T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "cloud",
                "creativity",
                "lateral-thinking",
                "open-source-software",
                "technology"
            ]
        },
        {
            "id": "s3-object-notifications-using-lambda-and-ses",
            "content_html": "<p><img loading=\"lazy\" alt=\"S3 object notifications using Lambda and SES with Terraform\" src=\"/assets/images/s3-object-notifications-using-Lambda-and-SES-with-Terraform-3caec5211828aa843515f4004a922eba.png\" width=\"353\" height=\"257\" class=\"img_ev3q\"></p><p>Following on from the previous post in the Really Simple Terraform series <a href=\"https://cloudywithachanceofbigdata.com/really-simple-terraform-infrastructure-automation-using-aws-lambda/\" target=\"_blank\" rel=\"noopener noreferrer\">simple-lambda-ec2-scheduler</a>, where we used Terraform to deploy a Lambda function including the packaging of the Python function into a ZIP archive and creation of all supporting objects (roles, policies, permissions, etc) – in this post we will take things a step further by using templating to update parameters in the Lambda function code before the packaging and creation of the Lambda function.</p><p>S3 event notifications can be published directly to an SNS topic which you could create an email subscription, this is quite straightforward. However the email notifications you get look something like this:</p><p><img loading=\"lazy\" alt=\"Email Notification sent via an SNS Topic Subscription\" src=\"/assets/images/sns-object-notification-email-173693c0618474107c4e13e72ea5e805.png\" width=\"1056\" height=\"593\" class=\"img_ev3q\"></p><p>There is very little you can do about this.</p><p>However if you take a slightly different approach by triggering a Lambda function to send an email via SES you have much more control over content and formatting. Using this approach you could get an email notification that looks like this:</p><p><img loading=\"lazy\" alt=\"Email Notification sent using Lambda and SES\" src=\"/assets/images/ses-object-notification-email-f2ec2abb7f361ac49d08d5b54ac369ad.png\" width=\"643\" height=\"714\" class=\"img_ev3q\"></p><p>Much easier on the eye!</p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"prerequisites\">Prerequisites<a class=\"hash-link\" href=\"#prerequisites\" title=\"Direct link to heading\">​</a></h2><p>You will need verified AWS SES (Simple Email Service) email addresses for the sender and recipient’s addresses used for your object notification emails. This can be done via the console as shown here:</p><p><img loading=\"lazy\" alt=\"SES Email Address Verification\" src=\"/assets/images/ses-verify-67af4f0a0493eddb21c1500407857016.png\" width=\"1126\" height=\"801\" class=\"img_ev3q\"></p><p><em>Note that SES is not available in every AWS region, pick one that is generally closest to your particular reason (but it really doesn't matter for this purpose).</em></p><h2 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"deployment\">Deployment<a class=\"hash-link\" href=\"#deployment\" title=\"Direct link to heading\">​</a></h2><p>The Terraform module creates an IAM Role and associated policy for the Lambda function as shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-023fab404c0df759d6d1d4bdb02ab4e8\"></iframe><p>Variables in the module are substituted into the function code template, the rendered template file is then packaged as a ZIP archive to be uploaded as the Lambda function source as shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-7d72d8c67114a9df0af1528a3b754d9e\"></iframe><p><em>As in the previous post, I will reiterate that although Terraform is technically not a build tool, it can be used for simple build operations such as this.</em></p><p>The Lambda function is deployed using the following code:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-5e7f2a238e8e0270cd55def40a389903\"></iframe><p>Finally the S3 object notification events are configured as shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-e7de65f20c79e0efb115024597864a75\"></iframe><p>Use the following commands to run this example (I have created a default credentials profile, but you could supply your API credentials directly, use STS, etc):</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">cd simple-notifications-with-lambda-and-ses</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">terraform init</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">terraform apply</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><blockquote><p><em>Full source code can be found at: <a href=\"https://github.com/avensolutions/simple-notifications-with-lambda-and-ses\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>https://github.com/avensolutions/simple-notifications-with-lambda-and-ses</strong></a></em></p></blockquote>",
            "url": "https://fullstackchronicles.io/s3-object-notifications-using-lambda-and-ses",
            "title": "S3 Object Notifications using Lambda and SES",
            "summary": "Simple pattern for formatted emails from S3 object notifications using AWS Lambda and SES, built with Terraform and Python",
            "date_modified": "2019-01-18T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "aws",
                "boto3",
                "lambda",
                "python",
                "s3",
                "ses",
                "terraform"
            ]
        },
        {
            "id": "infrastructure-automation-using-aws-lambda",
            "content_html": "<p><img loading=\"lazy\" alt=\"Automate infrastructure tasks using Lambda with Terraform\" src=\"/assets/images/automate-infrastructure-tasks-using-lambda-with-terraform-9e982eba53048591f885eb6fc5d1bad6.png\" width=\"364\" height=\"257\" class=\"img_ev3q\"></p><p>There are many other blog posts and examples available for either scheduling infrastructure tasks such as the starting or stopping of EC2 instances; or deploying a Lambda function using Terraform. However, I have found many of the other examples to be unnecessarily complicated, so I have put together a very simple example doing both.</p><p>The function itself could be easily adapted to take other actions including interacting with other AWS services using the boto3 library (the Python AWS SDK). The data payload could be modified to pass different data to the function as well.</p><p>The script only requires input variables for <strong><em>schedule<!-- -->_<!-- -->expression</em></strong> (cron schedule based upon GMT for triggering the function – could also be expressed as a rate, e.g. <strong><em>rate(5 minutes))</em></strong> and <strong><em>environment</em></strong> (value passed to the function on each invocation). In this example the Input data is the value for the “Environment” key for an EC2 instance tag – a user defined tag to associate the instance to a particular environment (e.g. Dev, Test. Prod). The key could be changed as required, for instance if you wanted to stop instances based upon their given name or part thereof you could change the tag key to be “Name”.</p><p>When triggered, the function will stop all running EC2 instances with the given Environment tag.</p><p>The Terraform script creates:</p><ul><li>an IAM Role and associated policy for the Lambda Function</li><li>the Lambda function</li><li>a Cloudwatch event rule and trigger</li></ul><p>The IAM role and policies required for the Lambda function are deployed as shown here:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-6b8ed7c149a60e823361ee282615b826\"></iframe><p>The function source code is packaged into a ZIP archive and deployed using Terraform as follows:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-ca6a26a62302ff809eae028bbfb28b41\"></iframe><p>Admittedly Terraform is an infrastructure automation tool and not a build/packaging tool (such as Jenkins, etc), but in this case the packaging only involves zipping up the function source code, so Terraform can be used as a ‘one stop shop’ to keep things simple.</p><p>The Cloudwatch schedule trigger is deployed as follows:</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-7920fda821eb4f03d8ba942da572180c\"></iframe><p>Use the following commands to run this example (I have created a default credentials profile, but you could supply your API credentials directly, use STS, etc):</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">cd simple-lambda-ec2-scheduler</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">terraform init</span><br></span><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">terraform apply</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><p><img loading=\"lazy\" alt=\"Terraform output\" src=\"/assets/images/terraform-screenshot-2f677526d3d3dc10870393e11e6e85b8.png\" width=\"1042\" height=\"683\" class=\"img_ev3q\"></p><blockquote><p><em>Full source code can be found at: <a href=\"https://github.com/avensolutions/simple-lambda-ec2-scheduler\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>https://github.com/avensolutions/simple-lambda-ec2-scheduler</strong></a></em></p></blockquote><p>Stay tuned for more simple Terraform deployment recipes in coming posts…</p>",
            "url": "https://fullstackchronicles.io/infrastructure-automation-using-aws-lambda",
            "title": "Infrastructure Automation using AWS Lambda",
            "summary": "Simple pattern for automating EC2 tasks using AWS Lambda and Terraform",
            "date_modified": "2019-01-15T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "aws",
                "automation",
                "boto3",
                "cloudwatch",
                "ec2",
                "lambda",
                "python",
                "scheduled-tasks",
                "terraform"
            ]
        },
        {
            "id": "multi-stage-etl-framework-using-spark-sql",
            "content_html": "<p><img loading=\"lazy\" alt=\"Spark SQL ETL Framework\" src=\"/assets/images/spark-sql-etl-framework-7491c174dee5cda2a37f00480d593b80.png\" width=\"451\" height=\"223\" class=\"img_ev3q\"></p><p>Most traditional data warehouse or datamart ETL routines consist of multi stage SQL transformations, often a series of CTAS (<code>CREATE TABLE AS SELECT</code>) statements usually creating transient or temporary tables – such as volatile tables in Teradata or Common Table Expressions (CTE’s).</p><div class=\"theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9\"><div class=\"admonitionHeading_tbUL\"><span class=\"admonitionIcon_kALy\"><svg viewBox=\"0 0 14 16\"><path fill-rule=\"evenodd\" d=\"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z\"></path></svg></span>Spark Training Courses</div><div class=\"admonitionContent_S0QG\"><p><a href=\"https://academy.alphazetta.ai/data-transformation-and-analysis-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Data Transformation and Analysis Using Apache Spark</a><br>\n<a href=\"https://academy.alphazetta.ai/stream-and-event-processing-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Stream and Event Processing using Apache Spark</a><br>\n<a href=\"https://academy.alphazetta.ai/advanced-analytics-using-apache-spark/\" target=\"_blank\" rel=\"noopener noreferrer\">Advanced Analytics Using Apache Spark</a></p></div></div><p>The initial challenge when moving from a SQL/MPP based ETL framework platformed on Oracle, Teradata, SQL Server, etc to a Spark based ETL framework is what to do with this…</p><p><img loading=\"lazy\" alt=\"Multi Stage SQL Based ETL\" src=\"/assets/images/multi-stage-sql-1b6298de71ac35e0ecde3af82a831be6.png\" width=\"736\" height=\"805\" class=\"img_ev3q\"></p><p>One approach is to use the lightweight, configuration driven, multi stage Spark SQL based ETL framework described in this post.</p><p>This framework is driven from a YAML configuration document. YAML was preferred over JSON as a document format as it allows for multi-line statements (SQL statements), as well as comments - which are very useful as SQL can sometimes be undecipherable even for the person that wrote it.</p><p>The YAML config document has three main sections: <strong><code>sources</code></strong>, <strong><code>transforms</code></strong> and <strong><code>targets</code></strong>.</p><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"sources\">Sources<a class=\"hash-link\" href=\"#sources\" title=\"Direct link to heading\">​</a></h3><p>The <strong><code>sources</code></strong> section is used to configure the input data source(s) including optional column and row filters. In this case the data sources are tables available in the Spark catalog (for instance the AWS Glue Catalog or a Hive Metastore), this could easily be extended to read from other datasources using the Spark DataFrameReader API.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-eaf03229466718ee125e0a6d23370f1b\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"transforms\">Transforms<a class=\"hash-link\" href=\"#transforms\" title=\"Direct link to heading\">​</a></h3><p>The <strong><code>transforms</code></strong> section contains the multiple SQL statements to be run in sequence where each statement creates a temporary view using objects created by preceding statements.</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-89ad7ac6b036e5f22b2d3dec43b1fe44\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"targets\">Targets<a class=\"hash-link\" href=\"#targets\" title=\"Direct link to heading\">​</a></h3><p>Finally the <strong><code>targets</code></strong> section writes out the final object or objects to a specified destination (S3, HDFS, etc).</p><iframe width=\"100%\" frameborder=\"0\" id=\"gist-5af780dd6b6e5ddd79a4cac8a59e6a69\"></iframe><h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"process-sql-statements\">Process SQL Statements<a class=\"hash-link\" href=\"#process-sql-statements\" title=\"Direct link to heading\">​</a></h3><p>The <strong><code>process_sql_statements.py</code></strong> script that is used to execute the framework is very simple (30 lines of code not including comments, etc). It loads the sources into Spark Dataframes and then creates temporary views to reference these datasets in the <strong><code>transforms</code></strong> section, then sequentially executes the SQL statements in the list of transforms. Lastly the script writes out the final view or views to the desired destination – in this case parquet files stored in S3 were used as the target.</p><p>You could implement an object naming convention such as prefixing object names with <code>sv_</code>, <code>iv_</code>, <code>fv_</code> (for source view, intermediate view and final view respectively) if this helps you differentiate between the different objects.</p><p>To use this framework you would simply use <strong><code>spark-submit</code></strong> as follows:</p><div class=\"codeBlockContainer_Ckt0 theme-code-block\" style=\"--prism-color:#393A34;--prism-background-color:#f6f8fa\"><div class=\"codeBlockContent_biex\"><pre tabindex=\"0\" class=\"prism-code language-text codeBlock_bY9V thin-scrollbar\"><code class=\"codeBlockLines_e6Vv\"><span class=\"token-line\" style=\"color:#393A34\"><span class=\"token plain\">spark-submit process_sql_statements.py config.yml</span><br></span></code></pre><div class=\"buttonGroup__atx\"><button type=\"button\" aria-label=\"Copy code to clipboard\" title=\"Copy\" class=\"clean-btn\"><span class=\"copyButtonIcons_eSgA\" aria-hidden=\"true\"><svg class=\"copyButtonIcon_y97N\" viewBox=\"0 0 24 24\"><path d=\"M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z\"></path></svg><svg class=\"copyButtonSuccessIcon_LjdS\" viewBox=\"0 0 24 24\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\"></path></svg></span></button></div></div></div><blockquote><p><em>Full source code can be found at: <a href=\"https://github.com/avensolutions/spark-sql-etl-framework\" target=\"_blank\" rel=\"noopener noreferrer\"><strong>https://github.com/avensolutions/spark-sql-etl-framework</strong></a></em></p></blockquote>",
            "url": "https://fullstackchronicles.io/multi-stage-etl-framework-using-spark-sql",
            "title": "Multi Stage ETL Framework using Spark SQL",
            "summary": "A simple configuration driven Spark SQL ETL framework",
            "date_modified": "2019-01-09T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "etl",
                "spark",
                "sql"
            ]
        },
        {
            "id": "cost-of-future-change",
            "content_html": "<h3 class=\"anchor anchorWithHideOnScrollNavbar_WYt5\" id=\"what-we-should-really-be-focused-on-but-no-one-is\">what we should really be focused on (but no one is…)<a class=\"hash-link\" href=\"#what-we-should-really-be-focused-on-but-no-one-is\" title=\"Direct link to heading\">​</a></h3><p><img loading=\"lazy\" alt=\"Cost of Future Change\" src=\"/assets/images/changes-ahead-3d37059d33dcbf66b5d0157808722f40.jpg\" width=\"800\" height=\"608\" class=\"img_ev3q\"></p><p>In my thirty year career in Technology I can’t think of a more profound period of change. It is not as if change never existed previously, it did. Innovation and Moore's law have been constant features in technology. However, for decades we had experienced a long period of relativity stability. That is, the rate of change was somewhat fixed. This was largely due to the fact that change, for the most part, was dictated almost entirely by a handful of large companies (such as Oracle, Microsoft, IBM, SAP, etc.). We, the technology community, were exclusively at the mercy of the product management teams at these companies dreaming up the next new feature, and we were subject to the tech giant’s product release cycle as to when we could use this feature. The rate of change was therefore artificially suppressed to a degree.</p><p>Then along came the open source software revolution. I can recall being fortunate enough to be in a meeting with Steve Ballmer along with a small group of Microsoft partners in Sydney, Australia around 2002. I can remember him as a larger than life figure with a booming voice and an intense presence. I can vividly remember him going on a long diatribe about Open Source Software, primarily focused around Linux. To put some historical context around it, Linux was a fringe technology at best at that point in time – nobody was taking it seriously in the enterprise. The Apache Software Foundation wasn’t a blip on the radar at the time, Software-as-a-Service was in its infancy, and Platform-as-a-Service and cloud were non-factors – so what was he worried about?</p><p>From the fear instilled in his rant, you would have thought this was going to be the end of humanity as we knew it. Well it was the beginning of the end, the end of the halcyon days of the software industry as we knew it. The early beginnings of the end of the monopoly on change held by a select few software vendors. The beginning of the democratisation of change.</p><p>Fast forward fifteen years, and now everyone is a (potential) software publisher. Real world problems are solved in real companies and in many cases software products are created, published and made (freely) available to other companies. We have seen countless examples of this pattern, Hadoop at Yahoo!, Kafka at LinkedIn, Airflow at Airbnb, to name a few. Then there are companies created with scant capital or investment, driven by a small group of smart people focused on solving a problem or streamlining a process that they have encountered in the real world. Many of these companies growing to be globally recognised names, such as Atlassian or Hashicorp.</p><p>The rate of change is no longer suppressed to the privileged few – in fact we have an explosion of change. No longer do we have a handful of technology options to achieve a desired outcome or solve a particular problem, we have a constellation of options.</p><p>Now the bad news, the force multiplier in change created by open source communities cuts both ways. When the community is behind a project it gets hyper-charged, conversely when the community drops off, functionality and stability drop off just as quickly.</p><p>This means there are components, projects, modules, services we are using today that won’t be around in the same format in 2-3 years’ time. There are products that don’t exist today that will be integral (and potentially critical) to our operations in 1-2 years’ time.</p><p>This brings me to my final point – the cost of future change. We as leaders and custodians of technology in this period should not only factor in current day run costs or the cost of change we know about (the cost of current change), but the hidden cost of future change. We need to think that whatever we are doing now is not what we will be doing in a years’ time – we will need to accommodate future change.</p><p>We need to be thinking about the cost of future change and what we can do to minimise this. This means not just swapping out one system for another, but thinking about how you will change this system or component again in the near future. We need to take the opportunity that is in front of us to replace monoliths with modular systems, move from tightly coupled to loosely coupled components, from proprietary systems to open systems, from rigid architectures to extensible architectures.</p><p>When you’re planning a change today, consider the cost of future change…</p>",
            "url": "https://fullstackchronicles.io/cost-of-future-change",
            "title": "The Cost of Future Change",
            "summary": "what we should really be focused on (but no one is…)",
            "date_modified": "2019-01-01T00:00:00.000Z",
            "author": {
                "name": "Jeffrey Aven",
                "url": "https://www.linkedin.com/in/jeffreyaven/"
            },
            "tags": [
                "change",
                "open-source-software",
                "technology"
            ]
        }
    ]
}