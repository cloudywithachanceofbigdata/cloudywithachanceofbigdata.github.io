<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Full Stack Chronicles Blog Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Full Stack Chronicles Blog Feed Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Full Stack Chronicles Blog Feed JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0FVDC1E8G6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0FVDC1E8G6",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Full Stack Chronicles" href="/opensearch.xml"><title data-rh="true">Full Stack Chronicles | Full Stack Chronicles</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://fullstackchronicles.io/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Full Stack Chronicles | Full Stack Chronicles"><meta data-rh="true" name="description" content="Full stack design patterns and random musings"><meta data-rh="true" property="og:description" content="Full stack design patterns and random musings"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://fullstackchronicles.io/"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/" hreflang="en"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://MZCGVO503N-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true">function maybeInsertBanner(){window.__DOCUSAURUS_INSERT_BASEURL_BANNER&&insertBanner()}function insertBanner(){var n=document.getElementById("docusaurus-base-url-issue-banner-container");if(n){n.innerHTML='\n<div id="docusaurus-base-url-issue-banner" style="border: thick solid red; background-color: rgb(255, 230, 179); margin: 20px; padding: 20px; font-size: 20px;">\n   <p style="font-weight: bold; font-size: 30px;">Your Docusaurus site did not load properly.</p>\n   <p>A very common reason is a wrong site <a href="https://docusaurus.io/docs/docusaurus.config.js/#baseurl" style="font-weight: bold;">baseUrl configuration</a>.</p>\n   <p>Current configured baseUrl = <span style="font-weight: bold; color: red;">/</span>  (default value)</p>\n   <p>We suggest trying baseUrl = <span id="docusaurus-base-url-issue-banner-suggestion-container" style="font-weight: bold; color: green;"></span></p>\n</div>\n';var e=document.getElementById("docusaurus-base-url-issue-banner-suggestion-container"),s=window.location.pathname,r="/"===s.substr(-1)?s:s+"/";e.innerHTML=r}}window.__DOCUSAURUS_INSERT_BASEURL_BANNER=!0,document.addEventListener("DOMContentLoaded",maybeInsertBanner)</script><link rel="stylesheet" href="/assets/css/styles.a53bcfee.css">
<link rel="preload" href="/assets/js/runtime~main.2d0570a6.js" as="script">
<link rel="preload" href="/assets/js/main.0bb50da2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div id="docusaurus-base-url-issue-banner-container"></div><div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" style="background-color:#A9BCD0;color:#1A4E82" role="banner"><div class="announcementBarContent_KsVm"><b>If you find our content useful, give it a ⭐️ on <a target="_blank" rel="noopener noreferrer" href="https://github.com/stackql/fullstackchronicles.io">GitHub</a>, if you want to contribute and become an author, submit a PR</b></div></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2 navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Full Stack Chronicles</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/tags">Topics</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/snowflake">Snowflake</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/simple-cli-pkce-auth-using-okta">Simple CLI Application to Login to Okta using PKCE</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/cloudy-with-a-chance-of-big-data-has-moved">Cloudy with a Chance of Big Data has Moved</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/scaling-up-prefect-with-gitstorage">Scaling up Prefect with GitStorage</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/implementing-a-serverless-sftp-gateway-using-the-aws-transfer-family">Implementing a Serverless SFTP Gateway using the AWS Transfer Family</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/simple-sso-with-an-external-idp-using-active-directory-and-okta">Simple SSO with an external IdP using Active Directory and Okta</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/converting-to-local-time-in-aws-lambda-using-nodejs">Converting to local time in AWS Lambda using Node.js</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/automating-snowflake-role-based-storage-integration-for-aws">Automating Snowflake Role Based Storage Integration for AWS</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/simplifying-large-cloudformation-templates-using-jsonnet">Simplifying Large CloudFormation Templates using Jsonnet</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/aws-deployments-with-cloudformation-and-gitlab-ci">Simplified AWS Deployments with CloudFormation and GitLab CI</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/from-wordpress-to-jamstack">From Wordpress to Jamstack</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/simple-cli-pkce-auth-using-okta">Simple CLI Application to Login to Okta using PKCE</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-04-17T00:00:00.000Z" itemprop="datePublished">April 17, 2022</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/okta-pkce-cli-blog-image.png"><div class="markdown" itemprop="articleBody"><p>This article demonstrates a simple command line utility to login to an authorization server (Okta in this case) using a PKCE (Proof Key for Code Exchange) flow.  This is the preferred flow for public clients (such as Single Page Applications).  </p><blockquote><p>The code for this article is available on <a href="https://github.com/stackql/okta-pkce-login" target="_blank" rel="noopener noreferrer"><strong>GitHub</strong></a></p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="example">Example<a class="hash-link" href="#example" title="Direct link to heading">​</a></h2><p><img loading="lazy" alt="Okta PKCE cli login example" src="/assets/images/okta-pkce-cli-login-984bdced01ccc0963b19556d1800450d.png" width="982" height="479" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">​</a></h2><p>This application can be used to illustrate the authorization/authentication flow discussed in <a href="https://fullstackchronicles.io/simple-sso-with-an-external-idp-using-active-directory-and-okta" target="_blank" rel="noopener noreferrer">Simple SSO with an external IdP using Active Directory and Okta</a>.  A flow which is pictured here:  </p><p><img loading="lazy" alt="PKCE Authorization to Okta using an AD IdP" src="/assets/images/seqdiagram-405ae2f7d8f54f113c5190e8d5799117.png" width="904" height="738" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="steps">Steps<a class="hash-link" href="#steps" title="Direct link to heading">​</a></h2><p>The steps involved in the implementation of a PKCE login flow are as follows:</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="generate-a-code_challenge">Generate a <code>code_challenge</code><a class="hash-link" href="#generate-a-code_challenge" title="Direct link to heading">​</a></h3><p>To implement a PKCE flow, you first need to generate a <em>Code Verifier</em> (which is a random value you create), the <em>Code Verifier</em> is then hashed using a SHA256 algorithm.  The hash is then used as the <em>Code Challenge</em>.  An example function to generate a code challenge is shown below:  </p><iframe width="100%" frameborder="0" id="gist-9a2a162813d77b83821d821b6a4a390a"></iframe><p>For more information see <a href="https://developer.okta.com/blog/2019/08/22/okta-authjs-pkce#:~:text=PKCE%20works%20by%20having%20the,is%20called%20the%20Code%20Challenge" target="_blank" rel="noopener noreferrer">Use PKCE to Make Your Apps More Secure</a>. </p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="build-the-authorize-url">Build the <code>authorize</code> url<a class="hash-link" href="#build-the-authorize-url" title="Direct link to heading">​</a></h3><p>The <code>authorize</code> url is used to initiate the authorization flow with the authorization server.  An example function to construct the <code>authorize</code> url is shown below:  </p><iframe width="100%" frameborder="0" id="gist-9e628b905a532e5bd59f022a4adca340"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="get-the-authorization-code-via-redirect-uri">Get the authorization code via redirect uri<a class="hash-link" href="#get-the-authorization-code-via-redirect-uri" title="Direct link to heading">​</a></h3><p>The <code>redirecturi</code> parameter supplied in the <code>authorize</code> url is used to retrieve the authorization code from the authorization server.  In order to get this code using a front end flow, you need to define a handler that will get the authorization code, call the token endpoint, and close the HTTP server, as shown here:  </p><iframe width="100%" frameborder="0" id="gist-617417bdcc54efcea9d37d27228f7f2a"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="exchange-the-code-for-an-access-token">Exchange the code for an access token<a class="hash-link" href="#exchange-the-code-for-an-access-token" title="Direct link to heading">​</a></h3><p>The access token is what you ultimatly want, as this is the token that will be used to access protected resources.  An example function to exchange the authorization code for an access token is shown below:  </p><iframe width="100%" frameborder="0" id="gist-0a990674d8bde2baffc0b0231f52ed52"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="optional-get-the-user-profile">(Optional) Get the user profile<a class="hash-link" href="#optional-get-the-user-profile" title="Direct link to heading">​</a></h3><p>The access token can be used to get the user profile, this is done by calling the <code>userinfo</code> endpoint using the token.  An example function to get the user profile is shown below:  </p><iframe width="100%" frameborder="0" id="gist-f04e8b018417a73986d3696c58f735cb"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="with-inspiration-from">with inspiration from...<a class="hash-link" href="#with-inspiration-from" title="Direct link to heading">​</a></h2><ul><li><a href="https://gist.github.com/ogazitt/f749dad9cca8d0ac6607f93a42adf322" target="_blank" rel="noopener noreferrer">Auth0 PKCE flow for a CLI built in golang</a></li><li><a href="https://community.auth0.com/t/golang-sample-for-a-cli-obtaining-an-access-token-using-the-pkce-flow/40922" target="_blank" rel="noopener noreferrer">Golang sample for a CLI obtaining an access token using the PKCE flow</a></li><li><a href="https://github.com/oktadev/okta-node-cli-example" target="_blank" rel="noopener noreferrer">oktadev/okta-node-cli-example</a></li><li><a href="https://developer.okta.com/blog/2019/06/18/command-line-app-with-nodejs" target="_blank" rel="noopener noreferrer">Build a Command Line Application with Node.js</a></li><li><a href="https://developer.okta.com/docs/guides/implement-grant-type/authcodepkce/main/#about-the-authorization-code-grant-with-pkce" target="_blank" rel="noopener noreferrer">About the Authorization Code grant with PKCE</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/okta">okta</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/oauth-2">oauth2</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cli">cli</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/golang">golang</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/pkce">pkce</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/cloudy-with-a-chance-of-big-data-has-moved">Cloudy with a Chance of Big Data has Moved</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-04-08T00:00:00.000Z" itemprop="datePublished">April 8, 2022</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/full-stack-chronicles-blog.png"><div class="markdown" itemprop="articleBody"><blockquote><p>Our blog has moved to <a href="https://fullstackchronicles.io/" target="_blank" rel="noopener noreferrer"><strong>fullstackchronicles.io</strong></a>, same content with a new home!  Much more content to come, enjoy!</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/blog">blog</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloudywithachanceofbigdata-com">cloudywithachanceofbigdata.com</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/fullstackchronicles-io">fullstackchronicles.io</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/scaling-up-prefect-with-gitstorage">Scaling up Prefect with GitStorage</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-02-28T00:00:00.000Z" itemprop="datePublished">February 28, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/datwiz" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="http://0.gravatar.com/avatar/f9af9c3fae755ac170c5798c53c5267d?s=80" alt="Chris Ottinger"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/datwiz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Chris Ottinger</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Technologist</small></div></div></div></div></header><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/scaling-up-prefect-with-gitstorage-featured-image.png"><div class="markdown" itemprop="articleBody"><p><a href="https://prefect.io" target="_blank" rel="noopener noreferrer">Prefect.io</a> is a python based Data Engineering toolbox for building and
operating Data Pipelines.  Out of the box, Prefect provides an initial workflow for managing data
pipelines that results in a container image per data pipeline job.</p><p>The one-to-one relationship between data pipeline jobs and container images enables data engineers to
craft pipelines that are loosely coupled and don&#x27;t require a shared runtime environment configuration.
However, as the number of data pipeline jobs grow the default container per job approach starts to
introduce workflow bottlenecks and lifecycle management overheads.  For example, in order
to update software components used by flows, such as upgrading the version of Prefect, all the data
pipeline job images have to be rebuilt and redeployed.  Additionally the container image per job workflow
introduces a wait time for data engineers to re-build data pipeline container images and test flows
centrally on Prefect Server or Prefect Cloud environment.</p><p>Fortunately, Prefect comes to its own rescue with the ability to open up the box, exposing the flexibility
in the underlying framework.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="out-of-the-box---prefect-dockerstorage">Out of the box - Prefect DockerStorage<a class="hash-link" href="#out-of-the-box---prefect-dockerstorage" title="Direct link to heading">​</a></h2><p>Out of the box, Prefect provides a simple workflow for defining and deploying data pipelines as container images.
After getting a first data pipeline running in a local environment, the attention turns to scaling up development
and deploying flows into a managed environment, using either the Prefect Cloud service or a Prefect Server.</p><p>Combining Prefect Cloud or Prefect Server with Kubernetes provides a flexible and scalable platform
solution for moving data pipelines into production.  There are a number of options for packaging
data pipeline flow code for execution on kubernetes clusters.  The Docker Storage option provides
the workflow for bundling the data pipeline job code into container images, enabling a common
controlled execution environment and well understood distribution mechanism.  The data pipeline runs as
a pod using the flow container image.</p><p>Prefect Docker Storage workflow steps for building and deploying data pipeline flows include:</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Steps</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">PlantUML</li></ul><div class="margin-vert--md"><div role="tabpanel"><p><a target="_blank" href="/assets/files/image1-3eb8a74efcfb6b3a329f69dd9b89ca34.png"><img loading="lazy" alt="Workflow Steps" src="/assets/images/image1-3eb8a74efcfb6b3a329f69dd9b89ca34.png" width="253" height="435" class="img_E7b_"></a> </p></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml &quot;docker-storage-workflow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(*) --&gt; &quot;package flow code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">into a container image&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;register Prefect flow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using image reference&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;push image to container registry&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;run flow in Prefect Server or Cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(new image pulled from registry)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; (*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><ul><li>packaging a flow (python code) as a serialised/pickled object into a container image</li><li>registering the flow using the container image name</li><li>pushing the container image to a container repository accessible from the kubernetes cluster</li><li>running the flow by running an instance of the named container image as a kubernetes pod</li></ul><p>This is relatively simple immutable workflow.  Each data pipeline flow version is effectively a unique and
self contained &#x27;point-in-time&#x27; container image.  This initial workflow can also be extended to package
multiple related flows into a single container image, reducing the number of resulting container images.
But, as the number of data pipeline jobs grow, there issues of container image explosion and data engineering
productivity remain.</p><p>Using Prefect GitStorage for flows addresses both container image proliferation as well as development
bottlenecks.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="prefect-git-storage">Prefect Git Storage<a class="hash-link" href="#prefect-git-storage" title="Direct link to heading">​</a></h2><p>Prefect <a href="https://docs.prefect.io/orchestration/flow_config/storage.html#git" target="_blank" rel="noopener noreferrer">Git Storage</a> provides a workflow for developing and deploying data pipelines directly from git repositories,
such as Gitlab or Github.  The data pipeline code (python) is pulled from the git repository on each invocation
with the ability to reference git branches and git tags.  This approach enables:</p><ul><li>reducing the number of container images to the number of different runtime configurations to be supported.</li><li>improving the data engineering development cycle time by removing the need to build and push container images
on each code change.</li><li>when combined with kubernetes Prefect Run Configs and Job templates, enables selection of specific runtime environment images</li></ul><p>Note that the GitStorage option does required access from the runtime kubernetes cluster to the central git storage
service, e.g. gitlab, github, etc.</p><p>Prefect Git Storage workflow steps for &#x27;building&#x27; and deploying data pipeline flows include:</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Steps</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">PlantUML</li></ul><div class="margin-vert--md"><div role="tabpanel"><p><a target="_blank" href="/assets/files/image2-d57463bea4147ef77047e87d3b7a49a7.png"><img loading="lazy" alt="Workflow Steps" src="/assets/images/image2-d57463bea4147ef77047e87d3b7a49a7.png" width="253" height="361" class="img_E7b_"></a> </p></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml &quot;git-storage-workflow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(*) --&gt; &quot;push commited flow code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changes to git service&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;register PrefectFlow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using branch or tag reference&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;run flow in Prefect Server or Cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(code pulled from git service)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; (*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><ul><li>pushing the committed code to the central git service</li><li>registering the flow using the git repository url and branch or tag reference</li><li>running the flow by pulling the reference code from the git service in a kubernetes pod</li></ul><p>The container image build and push steps are removed from the developer feedback cycle time.
Depending on network bandwidth and image build times, this can save remove 5 to 10 minutes from each deployment iteration.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="pushing-the-flow-code">Pushing the flow code<a class="hash-link" href="#pushing-the-flow-code" title="Direct link to heading">​</a></h3><p>Once a set of changes to the data pipeline code has been committed, push to the central git service.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> push</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="registering-the-flow">Registering the flow<a class="hash-link" href="#registering-the-flow" title="Direct link to heading">​</a></h3><p>The flow can be registered with Prefect using either a branch (HEAD or latest) or tag reference.  Assuming
a workflow with feature branches:</p><ul><li>feature branches: register the flow code using the feature branch.  This enables the latest version (HEAD)
of the pushed flow code to be used for execution.  It also enables skipping re-registration of the flow on new
changes as the HEAD of the branch is pulled on each flow run</li><li>main line branches: register pinned versions of the flow using git tags.  This enables the use of a
specific version of the flow code to be pulled on each flow run, regardless of future changes.</li></ul><p>Determining the which reference to use:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># using gitpython module to work with repo info</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> git </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># presidence for identifing where to find the flow code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># BUILD_TAG =&gt; GIT_BRANCH =&gt; active_branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build_tag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> branch_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build_tag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;BUILD_TAG&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> build_tag </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  branch_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;GIT_BRANCH&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> branch_name </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    branch_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Repo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getcwd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">active_branch</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Configuring Prefect Git storage:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> prefect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> my_flows</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hello_flow </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> flow </span><span class="token comment" style="color:#999988;font-style:italic"># assuming flow is defined in ./my_flows/flow.py</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># example using Gitlab</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># either branch_name or tag must be empty string &quot;&quot; or None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">storage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Git</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repo_host</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">git_hostname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repo</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">repo_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">flow</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">__name__</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">replace</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">,</span><span class="token string-interpolation interpolation string" style="color:#e3116c">&#x27;/&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.py&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    branch_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">branch_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tag</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">build_tag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git_token_secret_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">git_token_secret_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git_token_username</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">git_token_username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_flow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">regsiter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">build</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Once registered, the flow storage details can be viewed in the Prefect Server or Prefect Cloud UI.  In this example, Prefect will use the <code>HEAD</code> version of the <code>main</code> branch on each flow run.</p><p><a target="_blank" href="/assets/files/flow-storage-details-e2be96914a590e405cacb47ffc0eceaa.png"><img loading="lazy" alt="hello flow storage details" src="/assets/images/flow-storage-details-e2be96914a590e405cacb47ffc0eceaa.png" width="678" height="339" class="img_E7b_"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="next-steps---run-config">Next Steps - Run Config<a class="hash-link" href="#next-steps---run-config" title="Direct link to heading">​</a></h2><p>With Prefect Git Storage the runtime configuration and environment management is decoupled from the
data pipeline development workflow.  Unlike with Docker Storage, with Git Storage, the runtime
execution environment and data pipeline development workflows are defined and managed separately.
As an added benefit, the developer feedback loop cycle time is also reduced.</p><p>With the data engineering workflow addressed, the next step in scaling out the Prefect solution
turns to configuration and lifecycle management of the runtime environment for data pipelines.
Prefect Run Configs and Job templates provide the tools retaining the flexibility on container
image based runtime environments with improved manageability.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/prefect">prefect</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gitlab">gitlab</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/docker">docker</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/etl">etl</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/implementing-a-serverless-sftp-gateway-using-the-aws-transfer-family">Implementing a Serverless SFTP Gateway using the AWS Transfer Family</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-02-23T00:00:00.000Z" itemprop="datePublished">February 23, 2022</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/aws-transfer-for-sftp.png"><div class="markdown" itemprop="articleBody"><blockquote><p>When you want the SFTP service without the SFTP Server.  </p></blockquote><p>In implementing data platforms with external data providers, it is common to use a managed file transfer platform or an SFTP gateway as an entry point for providers to supply data to your system.  </p><p>Often in past implementations this would involve deploying a sever (typically a Linux VM) and provisioning and configuring an SFTP service.  If you wanted the data sent by clients to be copied to another storage medium (such as S3 or EFS) you would need to roll your own code or subscribe to a marketplace offering to do so.  </p><p>I recently trialled the <a href="https://docs.aws.amazon.com/transfer/index.html" target="_blank" rel="noopener noreferrer">AWS Transfer Family SFTP gateway</a> offering from AWS and sharing my adventures here.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="architecture">Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">​</a></h2><p>In this reference architecture, we are deploying an SFTP service which uses a path in an S3 bucket as a user’s home directory.  Objects in the bucket are encrypted with a customer managed KMS key.  The SFTP server front end address is mapped to a vanity URL using Route53.  The bucket and path are integrated with a <code>STORAGE INTEGRATION</code>, <code>STAGE</code> and <code>PIPE</code> definition in Snowflake.  The Snowflake bits are covered in more detail in this blog: <strong><a href="/automating-snowflake-role-based-storage-integration-for-aws">Automating Snowflake Role Based Storage Integration for AWS</a></strong>.  This article just details the AWS Transfer Family SFTP setup.</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Architecture</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">PlantUML</li></ul><div class="margin-vert--md"><div role="tabpanel"><p><a target="_blank" href="/assets/files/aws-transfer-sftp-architecture-7964e0e7ee271b7c690605e7cfa8a72d.png"><img loading="lazy" alt="AWS Transfer SFTP Architecture" src="/assets/images/aws-transfer-sftp-architecture-7964e0e7ee271b7c690605e7cfa8a72d.png" width="1014" height="725" class="img_E7b_"></a> </p></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skinparam rectangle&lt;&lt;boundary&gt;&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Shadowing false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StereotypeFontSize 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FontColor #444444</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BorderColor #444444</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BorderStyle dashed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skinparam defaultTextAlignment center</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!$imgroot = &quot;https://github.com/avensolutions/plantuml-cloud-image-library/raw/main/images&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $AwsS3($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;AWS S3&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/aws/Storage/S3.png&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $Kms($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;AWS KMS&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/aws/SecurityIdentityCompliance/kms.png{scale=0.80}&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $Route53($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;AWS Route53&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/aws/Networking/route53.png{scale=0.80}&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $AwsTransferFamily($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;AWS Transfer Family&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/aws/MigrationTransfer/TransferFamily.png&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $Data($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;Data&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/general/documents.png&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $Snowpipe($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;Snowpipe&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/snowflake/snowpipe.png{scale=0.60}&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $SnowflakeDb($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;Snowflake DB&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/snowflake/snowflakeDB.png{scale=0.70}&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Data(supplier, Data Supplier, External Client)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rectangle &quot;AWS Environment&quot; &lt;&lt;boundary&gt;&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $AwsTransferFamily(sftpgw, SFTP/FTPS Gateway, AWS Transfer Family)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $AwsS3(s3staging, Staging Bucket, AWS S3 Bucket)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $Kms(kms, KMS Key, Customer Managed Key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $Route53(r53, CNAME Record, Route53 Record)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rectangle &quot;Snowflake Environment&quot; &lt;&lt;boundary&gt;&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $Snowpipe(snowpipe, Snowpipe, Snowpipe)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $SnowflakeDb(db, Snowflake DB, Snowflake DB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r53 -[hidden]D- sftpgw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">supplier -&gt; r53 : resolves name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r53 -&gt; supplier : gets address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">supplier -RIGHT-&gt; sftpgw : SFTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sftpgw -DOWN-&gt; kms : uses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sftpgw -RIGHT-&gt; s3staging: writes to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s3staging -RIGHT-&gt; snowpipe: writes to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">snowpipe -DOWN-&gt; kms: uses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">snowpipe -RIGHT-&gt; db: writes to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="setup">Setup<a class="hash-link" href="#setup" title="Direct link to heading">​</a></h2><p>The steps to set up this pattern are detailed below.  </p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>This example uses the Jsonnet/CloudFormation pattern described in this article: <strong><a href="/simplifying-large-cloudformation-templates-using-jsonnet">Simplifying Large CloudFormation Templates using Jsonnet</a></strong>.  This is a useful pattern for breaking up a monolithic CloudFormation template at design time to more manageable resource scoped documents, then pre-processing these in a CI routine (GitLab CI, GitHub Actions, etc) to create a complete template.</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="setup-the-service">Setup the Service<a class="hash-link" href="#setup-the-service" title="Direct link to heading">​</a></h2><p>To setup the SFTP transfer service use the <code>AWS::Transfer::Server</code> resource type as shown below:  </p><iframe width="100%" frameborder="0" id="gist-c8b4ce8ab478715753aab73d478f4fcd"></iframe><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Use the <code>tags</code> shown to display the custom hostname (used as a vanity url) in the Transfer UI in the AWS console.</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="create-the-s3-bucket">Create the S3 Bucket<a class="hash-link" href="#create-the-s3-bucket" title="Direct link to heading">​</a></h2><p>Create a bucket which will be used to store incoming files sent via SFTP.  </p><iframe width="100%" frameborder="0" id="gist-82eb106bc13f1a888f823cc71a7ff933"></iframe><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>This example logs to a logging bucket, not shown for brevity.</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="create-a-customer-managed-kms-key">Create a Customer Managed KMS Key<a class="hash-link" href="#create-a-customer-managed-kms-key" title="Direct link to heading">​</a></h2><p>Create a customer managed KMS key which will be used to encrypt data stored in the S3 bucket created in the previous step.  </p><iframe width="100%" frameborder="0" id="gist-2c563411442c4541584815389de8a3b5"></iframe><h1>Create an IAM role to access the bucket</h1><p>Create an IAM role which will be assumed by the AWS Transfer Service to read and write to the S3 staging bucket.  </p><iframe width="100%" frameborder="0" id="gist-57e23a5c99c22f5550e99b086db5f9f1"></iframe><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>You must assign permissions to use the KMS key created previously, failure to do so will result in errors such as:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">remote readdir(): Permission denied</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="user-directory-mappings">User Directory Mappings<a class="hash-link" href="#user-directory-mappings" title="Direct link to heading">​</a></h2><p>An SFTP users home directory is mapped to a path in your S3 bucket.  It is recommended to use the <code>LOGICAL</code> <code>HomeDirectoryType</code>.  This will prevent SFTP users from:</p><ul><li>seeing or being able to access other users home directories</li><li>seeing the bucket name or paths in the bucket above their home directory</li></ul><p>There are some trade offs for this which can make deployment a little more challenging but we will cover off the steps from here.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="create-a-scoped-down-policy">Create a Scoped Down Policy<a class="hash-link" href="#create-a-scoped-down-policy" title="Direct link to heading">​</a></h3><p>A &quot;scoped down&quot; policy prevents users from seeing or accessing objects in other users home directories.  This is a text file that will be sourced as a string into the <code>Policy</code> parameter of each SFTP user you create.</p><iframe width="100%" frameborder="0" id="gist-5e876bbf95b1b36355fa8af868572a26"></iframe><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>Using the <code>LOGICAL</code> <code>HomeDirectoryType</code> you don&#x27;t have access to variables which represent the bucket, so this needs to be hard coded in the <code>policy.txt</code> document.  </p><p>Also if you are using a customer managed KMS key to encrypt the data in the bucket (which you should be), you need to add permissions to the key - which again cannot be represented by a variable.  </p><p>Failure to do so will result in errors when trying to <code>ls</code>, <code>put</code>, etc into the user&#x27;s home directory such as:  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Couldn&#x27;t read directory: Permission denied</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Couldn&#x27;t close file: Permission denied</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Since these properties are unlikely to change for the lifetime of your service this should not be an issue.  </p></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="create-a-user">Create a user<a class="hash-link" href="#create-a-user" title="Direct link to heading">​</a></h3><p>Users are identified by a username and an SSH key, providing the public key to the server.  A sample user is shown here:  </p><iframe width="100%" frameborder="0" id="gist-1b946b07374b78e0aca380317729bfa9"></iframe><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>As discussed previously, it is recommended to use <code>LOGICAL</code> home directory mappings, which prevents users from seeing information about the bucket or other directories on the SFTP server (including other users directories).</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="create-a-route-53-cname-record">Create a Route 53 CNAME record<a class="hash-link" href="#create-a-route-53-cname-record" title="Direct link to heading">​</a></h2><p>Ideally you want to use a vanity url for users to access your SFTP service, such as <code>sftp.yourcompany.com</code>.  This can be accomplished by using a Route 53 CNAME record as shown here:  </p><iframe width="100%" frameborder="0" id="gist-0098851edc8d60b45534f6b1134be8cd"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="create-some-shared-tags">Create some shared Tags<a class="hash-link" href="#create-some-shared-tags" title="Direct link to heading">​</a></h2><p>You would have noticed a shared <code>Tags</code> definition in many of the <code>libsonnet</code> files shown, an example <code>Tags</code> source file is shown here:  </p><iframe width="100%" frameborder="0" id="gist-8323d49f1045d2cd8c874d5a00e82a5e"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="pull-it-all-together">Pull it all together!<a class="hash-link" href="#pull-it-all-together" title="Direct link to heading">​</a></h2><p>Now that we have all of the input files, lets pull them all together in a <code>jsonnet</code> file, which will be preprocessed in a CI process to create a template we can deploy with AWS CloudFormation.  </p><iframe width="100%" frameborder="0" id="gist-f56065c075af9cc33853b0624f6ef636"></iframe><p>Your customers would now connect to your service using they private key which corresponds to the public key they supplied to you in one of the previous steps, for example:    </p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sftp</span><span class="token plain"> -i mysftpkey jeffrey_aven@sftp.yourdomain.com</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Add more users and enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aws">aws</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aws-transfer-family">aws transfer family</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/serverless">serverless</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/snowflake">snowflake</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/snowpipe">snowpipe</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/sftp">sftp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/managed-file-transfer">managed file transfer</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/simple-sso-with-an-external-idp-using-active-directory-and-okta">Simple SSO with an external IdP using Active Directory and Okta</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-02-04T00:00:00.000Z" itemprop="datePublished">February 4, 2022</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/okta-ad-sso-featured-image.png"><div class="markdown" itemprop="articleBody"><p>This article describes a simple SSO pattern for authenticating and authorizing users from an external AD and to your application without requiring federation.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="the-challenge">the Challenge<a class="hash-link" href="#the-challenge" title="Direct link to heading">​</a></h2><p>You need to authenticate external users to use your application, these users belong to an organization using Azure Active Directory with specific login policies (such as password strength and expiry, multi factor authentication, etc).  Your requirements (if you choose to accept them) are:</p><ol><li>You are required to provide SSO to these users using their home AD tenant and policies</li><li>The solution does not include SAML based federation between directories (yours and theirs)</li><li>The solution does not require any changes on the external AD tenant (no new AAD applications, client secrets, etc)</li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="the-solution">the Solution<a class="hash-link" href="#the-solution" title="Direct link to heading">​</a></h2><p>Using an IDAM/IDaaS platform (such as Okta in this case), along with an AAD application (in your AD tenant in your Azure subscription), you can create a local AD app using this magic property to accomplish all of the above requirements (requiring zero changes on the third-party AD).  </p><p><a target="_blank" href="/assets/files/azure-ad-app-registration-9857aa65a9e76e9710d04eb12cf875c2.png"><img loading="lazy" alt="Azure AD App Registration" src="/assets/images/azure-ad-app-registration-9857aa65a9e76e9710d04eb12cf875c2.png" width="849" height="900" class="img_E7b_"></a> </p><p>This is what it looks like using the <code>az</code> cli:</p><iframe width="100%" frameborder="0" id="gist-8b70fbe242da02ca844bf2fe53355743"></iframe><p>the <code>--available-to-other-tenants</code> property is Microsoft&#x27;s way of allowing you to implicitly trust other AAD/Office 365 tenants, meaning the authentication request is passed to the target AD tenant from your application.  </p><p>Here is a context diagram which explains the interactions in the context of a Jamstack application (using a library such as Auth.js).  </p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Overview</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">PlantUML</li></ul><div class="margin-vert--md"><div role="tabpanel"><p><a target="_blank" href="/assets/files/okta-ad-sso-context-diagram-080a3ead154d3ab5f7a1ebb43259f3ed.png"><img loading="lazy" alt="Okta AD SSO Context Diagram" src="/assets/images/okta-ad-sso-context-diagram-080a3ead154d3ab5f7a1ebb43259f3ed.png" width="662" height="571" class="img_E7b_"></a> </p></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT language-plantuml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-plantuml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!define C4Puml https://raw.githubusercontent.com/RicardoNiepel/C4-PlantUML/master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl C4Puml/C4_Context.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl C4Puml/C4_Component.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl C4Puml/C4_Container.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27;left to right direction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!define Rel_NoRank(e_from,e_to, e_label=&quot; &quot;) Rel_(e_from,e_to, e_label, &quot;-[norank]-&gt;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!$imgroot = &quot;https://github.com/avensolutions/plantuml-cloud-image-library/raw/main/images&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $AzureActiveDirectory($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;Azure Active Directory&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/azure/AzureActiveDirectory.png{scale=0.75}&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $Okta($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;Okta&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/okta/okta.png{scale=1}&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Person(user, User\n&lt;i&gt;UserAgent (Browser) )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Person(admin, Application Admin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">note right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Create users in the Okta org with the same email as the users email address in their AD (external AD)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end note</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rectangle &quot;Application Environment&quot; &lt;&lt;boundary&gt;&gt; as app{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $AzureActiveDirectory(localad, Local AD Tenant, Azure Active Directory)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $Okta(okta, Local Okta Org, Okta)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$AzureActiveDirectory(otherad, Azure AD Tenant\n&lt;i&gt;(External AD), Azure Active Directory)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lay_D(user, okta)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lay_R(okta, localad)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lay_R(localad, otherad)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Lay_D(okta, admin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel_U(okta, user, access code)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel_D(user, okta, authorize request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel_R(okta, localad, routes to)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel_R(localad, otherad, forwards to)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel_U(admin, okta, creates users)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="setup-and-configuration">Setup and Configuration<a class="hash-link" href="#setup-and-configuration" title="Direct link to heading">​</a></h2><p>The following flowchart explains the steps involved in setting this up.  The highlighted nodes are part of normal application lifecycle operations as users get created and deactivated.  </p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Flowchart</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">Mermaid</li></ul><div class="margin-vert--md"><div role="tabpanel"><p><a target="_blank" href="/assets/files/okta-ad-sso-setup-flowchart-ae59463b7d2de2881cb11b6b9520f198.svg"><img loading="lazy" alt="Okta AD SSO Setup Flowchart" src="/assets/images/okta-ad-sso-setup-flowchart-ae59463b7d2de2881cb11b6b9520f198.svg" width="749" height="810" class="img_E7b_"></a> </p></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT language-mermaid theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-mermaid codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">flowchart TD;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subgraph Local Azure AD;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a1(1. Create AD App);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subgraph Okta;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b1(2. Create IdP)--&gt;b2(3. Create Application);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b2--&gt;b3(4. Create IdP\nRouting Rule\nfor Application);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b3--&gt;b4(5. Create Group);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b4--&gt;b5(6. Assign Group\nto Application);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b5--&gt;c1(7. Create User);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c1--&gt;c2(8. Add User to Group);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    style c1 fill:#f9f,stroke:#333,stroke-width:4px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    style c2 fill:#f9f,stroke:#333,stroke-width:4px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subgraph Application;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    d1(9. Configure ISSUER\nand CLIENTID);      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  a1--&gt;Okta;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  b3--&gt;Application;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="authorisation-flow">Authorisation flow<a class="hash-link" href="#authorisation-flow" title="Direct link to heading">​</a></h2><p>The authorization flow for a public client (SPA) using PKCE (Proof Key for Code Exchange) is shown here:    </p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Sequence</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">Mermaid</li></ul><div class="margin-vert--md"><div role="tabpanel"><p><a target="_blank" href="/assets/files/okta-ad-sso-authorization-flow-760ab053c2fea594de308cd833cf8975.svg"><img loading="lazy" alt="Okta AD SSO Authorization Flow" src="/assets/images/okta-ad-sso-authorization-flow-760ab053c2fea594de308cd833cf8975.svg" width="1501" height="785" class="img_E7b_"></a></p></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT language-mermaid theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-mermaid codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sequenceDiagram;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%{init: {&#x27;theme&#x27;: &#x27;base&#x27;, &#x27;themeVariables&#x27;: { &#x27;primaryColor&#x27;: &#x27;#AACCFF&#x27;, &#x27;primaryBorderColor&#x27;: &#x27;#999000&#x27;, &#x27;actorLineColor&#x27;: &#x27;#000000&#x27; }}}%%;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant user as User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant spa as User Agent (SPA);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant be as Back End APIs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant okta as Okta;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participant msft as Microsoft Login;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user-&gt;&gt;spa: ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spa-&gt;&gt;okta: local.okta.com/../authorize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Note over spa,okta: includes client_id (okta), code_challenge (PKCE), redirect_uri (to app), response_type, scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  okta--&gt;&gt;spa: 302 REDIRECT; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spa-&gt;&gt;msft: login.microsoftonline.com/../authorize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Note over spa,msft: includes client_id (msft app id), state, redirect_uri (to okta), response_type, scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  msft-&gt;&gt;msft: authenticate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  msft--&gt;&gt;okta: local.okta.com/../authorize/callback;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  okta--&gt;&gt;msft:  302 REDIRECT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  msft--&gt;&gt;spa: app/callback?code=xxx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spa-&gt;&gt;okta: exchange code for an access token;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  okta-&gt;&gt;spa: token;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spa-&gt;&gt;be: present token to access resources;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="next-up">Next up<a class="hash-link" href="#next-up" title="Direct link to heading">​</a></h2><p><code>Code!</code>  Stay tuned...</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/okta">okta</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/azure">azure</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/active-directory">active directory</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/azure-active-directory">azure active directory</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/sso">sso</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/single-sign-on">single sign on</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/identity">identity</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/2"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a href="https://stackql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">StackQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.windrate.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">WindRate<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.2d0570a6.js"></script>
<script src="/assets/js/main.0bb50da2.js"></script>
</body>
</html>