<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">2 posts tagged with &quot;ha&quot; | Full Stack Chronicles</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://fullstackchronicles.io/img/fullstackchronicles-cover-image.png"><meta data-rh="true" name="twitter:image" content="https://fullstackchronicles.io/img/fullstackchronicles-cover-image.png"><meta data-rh="true" property="og:url" content="https://fullstackchronicles.io/tags/ha"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="robots" content="index,follow"><meta data-rh="true" name="twitter:site" content="@fschronicles1"><meta data-rh="true" name="twitter:creator" content="@fschronicles1"><meta data-rh="true" name="og:type" content="website"><meta data-rh="true" name="og:locale" content="en_US"><meta data-rh="true" name="og:site_name" content="Full Stack Chronicles"><meta data-rh="true" name="msapplication-TileColor" content="#2d89ef"><meta data-rh="true" name="theme-color" content="#ffffff"><meta data-rh="true" property="og:title" content="2 posts tagged with &quot;ha&quot; | Full Stack Chronicles"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://fullstackchronicles.io/tags/ha"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/tags/ha" hreflang="en"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/tags/ha" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://&lt;your algolia app id&gt;-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Full Stack Chronicles Blog Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Full Stack Chronicles Blog Feed Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Full Stack Chronicles Blog Feed JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0FVDC1E8G6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0FVDC1E8G6",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Full Stack Chronicles" href="/opensearch.xml">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0f4c81"><link rel="stylesheet" href="/assets/css/styles.b0c95f89.css">
<link rel="preload" href="/assets/js/runtime~main.e849b1f5.js" as="script">
<link rel="preload" href="/assets/js/main.ef636b07.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#A9BCD0;color:#1A4E82" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><b>If you find our content useful, follow us on <a target="_blank" rel="noopener noreferrer" href="https://github.com/stackql">GitHub</a>, if you have some content to share, reach out</b></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Full Stack Chronicles</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/tags">Topics</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/snowflake">Snowflake</a></li><li><a class="dropdown__link" href="/tags/okta">Okta</a></li><li><a class="dropdown__link" href="/tags/openapi">OpenAPI</a></li><li><a class="dropdown__link" href="/tags/spark">Spark</a></li><li><a class="dropdown__link" href="/tags/kafka">Kafka</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/databricks-in-five-minutes">Databricks in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/netlify-logging-to-sumologic-without-log-drains">Netlify logging to SumoLogic Without Log Drains</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/enhancing-dbt-snapshots-with-operational-metadata">Enhancing dbt Snapshots with Operational Metadata</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/json-ld-structured-data-for-docusaurus">Yoast (like) JSON-LD Structured Data for Docusaurus</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/gitver-an-alternative-versioning-scheme-to-semver-or-calver">Introducing GitVer - an alternative versioning scheme</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/use-deno-deploy-to-serve-non-traditional-artifacts">Use Deno Deploy to Serve Non-Traditional Artifacts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/apache-beam-in-five-minutes">Apache Beam in Five Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/aws-iam-vs-google-iam">AWS IAM vs Google IAM</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/create-and-use-custom-magic-commands-in-jupyter">Create and use Custom Magic Commands in Jupyter</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/deno-in-five-minutes">Deno in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/dbt-in-five-minutes">DBT in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/loading-parquet-files-into-snowflake">Loading Parquet Files into Snowflake</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/analyze-developer-activity-with-stackql-jupyter-bigquery">Analyze Developer Activity with StackQL, Jupyter and BigQuery</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/converting-google-discovery-docs-to-openapi3-specs">Converting Google Discovery Docs to OpenAPI3 Specs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/recurse-javascript-object-to-get-values-for-a-given-key-the-easy-way">Recurse JavaScript Object to Get Values for a Given Key the Easy Way</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>2 posts tagged with &quot;ha&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/images/cloudsql-featured-image.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/google-cloud-sql-availability-for-postgresql-read-replicas">Google Cloud SQL – Availability for PostgreSQL – Part II (Read Replicas)</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-01-24T00:00:00.000Z" itemprop="datePublished">January 24, 2020</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="CloudSQL HA" src="/assets/images/cloudsql-featured-image-896f0c764d7310d88c5cc9461f3feb6c.png" width="151" height="151" class="img_ev3q"></p><p>In this post we will look at read replicas as an additional method to achieve multi zone availability for Cloud SQL, which gives us - in turn - the ability to offload (potentially expensive) IO operations such as user created backups or read operations without adding load to the master instance.</p><p>In the previous post in this series we looked at Regional availability for PostgreSQL HA using Cloud SQL:</p><p><a href="https://cloudywithachanceofbigdata.com/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql-part-i/" target="_blank" rel="noopener noreferrer"><strong>Google Cloud SQL – Availability, Replication, Failover for PostgreSQL – Part I</strong></a></p><p>Recall that this option was simple to implement and worked relatively seamlessly and transparently with respect to zonal failover.</p><p>Now let&#x27;s look at read replicas in Cloud SQL as an additional measure for availability.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="deploying-read-replicas">Deploying Read Replica(s)<a href="#deploying-read-replicas" class="hash-link" aria-label="Direct link to Deploying Read Replica(s)" title="Direct link to Deploying Read Replica(s)">​</a></h2><p>Deploying read replicas is slightly more involved than simple regional (high) availability, as you will need to define each replica or replicas as a separate Cloud SQL instance which is a slave to the primary instance (the master instance).</p><p>An example using Terraform is provided here, starting by creating the master instance:</p><iframe width="100%" frameborder="0" id="gist-34371a3c7edab140e70208cd7710c25a"></iframe><p>Next you would specify one or more read replicas (typically in a zone other than the zone the master is in):</p><iframe width="100%" frameborder="0" id="gist-980f2d6461db0613b4090413041b5ec5"></iframe><p>Note that several of the options supplied are omitted when creating a read replica database instance, such as the backup and maintenance options - as these operations cannot be performed on a read replica as we will see later.</p><figure><a href="[object Object]"><img src="[object Object]" alt="Cloud SQL Instances - showing master and replica"></a><figcaption class="figure-caption">Cloud SQL Instances - showing master and replica</figcaption></figure><figure><a href="[object Object]"><img src="[object Object]" alt="Cloud SQL Master Instance"></a><figcaption class="figure-caption">Cloud SQL Master Instance</figcaption></figure><p>Voila! You have just set up a master instance (the primary instance your application and/or users will connect to) along with a read replica in a different zone which will be asynchronously updated as changes occur on the master instance.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="read-replicas-in-action">Read Replicas in Action<a href="#read-replicas-in-action" class="hash-link" aria-label="Direct link to Read Replicas in Action" title="Direct link to Read Replicas in Action">​</a></h2><p>Now that we have created a read replica, lets see it in action. After connecting to the read replica (like you would any other instance), attempt to access a table that has <strong><em>not</em></strong> been created on the master as shown here:</p><figure><a href="[object Object]"><img src="[object Object]" alt="SELECT operation from the replica instance"></a><figcaption class="figure-caption">SELECT operation from the replica instance</figcaption></figure><p>Now create the table and insert some data on the <strong><em>master</em></strong> instance:</p><figure><a href="[object Object]"><img src="[object Object]" alt="Create a table and insert a record on the master instance"></a><figcaption class="figure-caption">Create a table and insert a record on the master instance</figcaption></figure><p>Now try the select operation on the <strong><em>replica</em></strong> instance:</p><figure><a href="[object Object]"><img src="[object Object]" alt="SELECT operation from the replica instance (after changes have been made on the master)"></a><figcaption class="figure-caption">SELECT operation from the replica instance (after changes have been made on the master)</figcaption></figure><p>It works!</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="some-points-to-note-about-cloud-sql-read-replicas">Some Points to Note about Cloud SQL Read Replicas<a href="#some-points-to-note-about-cloud-sql-read-replicas" class="hash-link" aria-label="Direct link to Some Points to Note about Cloud SQL Read Replicas" title="Direct link to Some Points to Note about Cloud SQL Read Replicas">​</a></h2><ul><li>Users connect to a read replica as a normal database connection (as shown above)</li><li>Google managed backups (using the console or <code>gcloud sql backups create ..</code> ) can <strong><em>NOT</em></strong> be performed against replica instances</li><li>Read replicas can be used to offload IO intensive operations from the the master instance - such as user managed backup operations (e.g. <code>pg_dump</code>)</li></ul><figure><a href="[object Object]"><img src="[object Object]" alt="pg_dump operation against a replica instance"></a><figcaption class="figure-caption">pg_dump operation against a replica instance</figcaption></figure><ul><li><strong>BE CAREFUL</strong> Despite their name, read replicas are <strong>NOT</strong> read only, updates can be made which will NOT propagate back to the master instance - you could get yourself in an awful mess if you allow users to perform <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>CREATE</code> or <code>DROP</code> operations against replica instances.</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="promoting-a-read-replica">Promoting a Read Replica<a href="#promoting-a-read-replica" class="hash-link" aria-label="Direct link to Promoting a Read Replica" title="Direct link to Promoting a Read Replica">​</a></h2><p>If required a read replica can be promoted to a standalone Cloud SQL instance, which is another DR option. Keep in mind however as the read replica is updated in an asynchronous manner, promotion of a read replica may result in a loss of data (hopefully not much but a loss nonetheless). Your application RPO will dictate if this is acceptable or not.</p><p>Promotion of a read replica is reasonably straightforward as demonstrated here using the console:</p><figure><a href="[object Object]"><img src="[object Object]" alt="Promoting a read replica using the console"></a><figcaption class="figure-caption">Promoting a read replica using the console</figcaption></figure><p>You can also use the following <code>gcloud</code> command:</p><p> gcloud sql instances promote-replica  &lt;replica<!-- -->_<!-- -->instance<!-- -->_<!-- -->name&gt;</p><p>Once you click on the <em>Promote Replica</em> button you will see the following warning:</p><figure><a href="[object Object]"><img src="[object Object]" alt=""></a><figcaption class="figure-caption"></figcaption></figure><p><em>Promoting a read replica using the console</em></p><p>This simply states that once you promote the replica instance your instance will become an independent instance with no further relationship with the master instance. Once accepted and the promotion process is complete, you can see that you now have two independent Cloud SQL instances (as advertised!):</p><figure><a href="[object Object]"><img src="[object Object]" alt="Promoted Cloud SQL instance"></a><figcaption class="figure-caption">Promoted Cloud SQL instance</figcaption></figure><p>Some of the options you would normally configure with a master instance would need to be configured on the promoted replica instance - such as high availability, maintenance and scheduled backups - but in the event of a zonal failure you would be back up and running with virtually no data loss!</p><blockquote><p>Full source code for this article is available at: <a href="https://github.com/gamma-data/cloud-sql-postgres-availability-tutorial" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/cloud-sql-postgres-availability-tutorial</a></p></blockquote><blockquote><p>if you have enjoyed this post, please consider <a href="https://www.buymeacoffee.com/jeffreyaven" target="_blank" rel="noopener noreferrer"><strong>buying me a coffee ☕</strong></a> to help me keep writing!</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/cloudsql">cloudsql</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gcp">gcp</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ha">ha</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/highavailability">highavailability</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/postgresql">postgresql</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/images/cloudsql-featured-image.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql">Google Cloud SQL – Availability, Replication, Failover for PostgreSQL – Part I</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-01-17T00:00:00.000Z" itemprop="datePublished">January 17, 2020</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="CloudSQL HA" src="/assets/images/cloudsql-featured-image-896f0c764d7310d88c5cc9461f3feb6c.png" width="151" height="151" class="img_ev3q"></p><p>In this multi part blog we will explore the features available in Google Cloud SQL for High Availability, Backup and Recovery, Replication and Failover and Security (at rest and in transit) for the PostgreSQL DBMS engine. Some of these features are relatively hot of the press and in Beta – which still makes them available for general use.</p><p>We will start by looking at the High Availability (HA) options available to you when using the PostgreSQL engine in Google Cloud SQL.</p><p>Most of you would be familiar with the concepts of High Availability, Redundancy, Fault Tolerance, etc but let’s start with a definition of HA anyway:</p><blockquote><p>High availability (HA) is a characteristic of a system, which aims to ensure an agreed level of operational performance, usually uptime, for a higher than normal period.</p><p>Wikipedia</p></blockquote><p>Higher than a normal period is quite subjective, typically this is quantified by a percentage represented by a number of “9s”, that is 99.99% (which would be quoted as “four nines”), this would allot you 52.60 minutes of downtime over a one-year period.</p><p>Essentially the number of 9’s required will drive your bias towards the options available to you for Cloud SQL HA.</p><p>We will start with Cloud SQL HA in its simplest form, Regional Availability.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="regional-availability">Regional Availability<a href="#regional-availability" class="hash-link" aria-label="Direct link to Regional Availability" title="Direct link to Regional Availability">​</a></h2><p>Knowing what we know about the Google Cloud Platform, regional availability means that our application or service (in this case Cloud SQL) should be resilient to a failure of any one zone in our region. In fact, as all GCP regions have at least 3 zones – two zones could fail, and our application would still be available.</p><p>Regional availability for Cloud SQL (which Google refers to as High Availability), creates a standby instance in addition to the primary instance and uses a regional Persistent Disk resource to store the database instance data, transaction log and other state files, which is synchronously replicated to a Persistent Disk resource local to the zones that the primary and standby instances are located in.</p><p>A shared IP address (like a Virtual IP) is used to serve traffic to the healthy (normally primary) Cloud SQL instance.</p><p>An overview of Cloud SQL HA is shown here:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-9f997d42db7d02fc6391cb507e81bc6c.png"><img loading="lazy" alt="Cloud SQL High Availability" src="/assets/images/cloud-sql-ha-9f997d42db7d02fc6391cb507e81bc6c.png" width="716" height="541" class="img_ev3q"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="implementing-high-availability-for-cloud-sql">Implementing High Availability for Cloud SQL<a href="#implementing-high-availability-for-cloud-sql" class="hash-link" aria-label="Direct link to Implementing High Availability for Cloud SQL" title="Direct link to Implementing High Availability for Cloud SQL">​</a></h2><p>Implementing Regional Availability for Cloud SQL is dead simple, it is one argument:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">availability_type = &quot;REGIONAL&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Using the <code>gcloud</code> command line utility, this would be:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud sql instances create postgresql-instance-1234 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --availability-type=REGIONAL \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --database-version= POSTGRES_9_6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Using Terraform (with a complete set of options) it would look like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_sql_database_instance&quot; &quot;postgres_ha&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider = google-beta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project = var.project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;postgresql-instance-${random_id.instance_suffix.hex}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  database_version = &quot;POSTGRES_9_6&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  settings {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   tier = var.tier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_size = var.disk_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   activation_policy = &quot;ALWAYS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_autoresize = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_type = &quot;PD_SSD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   **availability_type = &quot;REGIONAL&quot;**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   backup_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     enabled = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     start_time = &quot;00:00&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ip_configuration  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ipv4_enabled = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     private_network = google_compute_network.private_network.self_link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   maintenance_window  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     day = 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     hour = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     update_track = &quot;stable&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> } </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once deployed you will notice a few different items in the console, first from the instance overview page you can see that the High Availability option is <code>ENABLED</code> for your instance.</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-1-12d875328c3d6743bab7c41038d7e382.png"><img loading="lazy" src="/assets/images/cloud-sql-ha-1-12d875328c3d6743bab7c41038d7e382.png" width="1310" height="446" class="img_ev3q"></a></p><p>Second, you will see a Failover button enabled on the detailed management view for this instance.</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-2-39a03f8c41a267780563cbb20bafd2d4.png"><img loading="lazy" src="/assets/images/cloud-sql-ha-2-39a03f8c41a267780563cbb20bafd2d4.png" width="1310" height="612" class="img_ev3q"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="failover">Failover<a href="#failover" class="hash-link" aria-label="Direct link to Failover" title="Direct link to Failover">​</a></h2><p>Failovers and failbacks can be initiated manually or automatically (should the primary be unresponsive). A manual failover can be invoked by executing the command:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud sql instances failover postgresql-instance-1234</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There is an <code>--async</code> option which will return immediately, invoking the failover operation asynchronously.</p><p>Failover can also be invoked from the Cloud Console using the Failover button shown previously. As an example I have created a connection to a regionally available Cloud SQL instance and started a command which runs a loop and prints out a counter:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-3-6710a724106c4048213b24a2082b64cb.png"><img loading="lazy" src="/assets/images/cloud-sql-ha-3-6710a724106c4048213b24a2082b64cb.png" width="1920" height="1040" class="img_ev3q"></a></p><p>Now using the <code>gcloud</code> command shown earlier, I have invoked a manual failover of the Cloud SQL instance.</p><p>Once the failover is initiated, the client connection is dropped (as the server is momentarily unavailable):</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-4-bb4bcf4f70179371b1b26d96a92a4dff.png"><img loading="lazy" src="/assets/images/cloud-sql-ha-4-bb4bcf4f70179371b1b26d96a92a4dff.png" width="1920" height="1040" class="img_ev3q"></a></p><p>The connection can be immediately re-established afterwards, the state of the running query is lost - <strong><em>importantly no data is lost</em></strong> however. If your application clients had retry logic in their code and they weren&#x27;t executing a long running query, chances are no one would notice! Once reconnecting normal database activities can be resumed:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-5-6f8c7134a54b7a38444f5ddbdbcf960e.png"><img loading="lazy" src="/assets/images/cloud-sql-ha-5-6f8c7134a54b7a38444f5ddbdbcf960e.png" width="1920" height="1040" class="img_ev3q"></a></p><p>A quick check of the instance logs will show that the failover event has occured:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-6-a4ab88ef121dbc8842347478cf0811d0.png"><img loading="lazy" src="/assets/images/cloud-sql-ha-6-a4ab88ef121dbc8842347478cf0811d0.png" width="1310" height="568" class="img_ev3q"></a></p><p>Now when you return to the instance page in the console you will see a Failback button, which indicates that your instance is being served by the standby:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-7-25ae1613611767eea9c101c3a24f0632.png"><img loading="lazy" src="/assets/images/cloud-sql-ha-7-25ae1613611767eea9c101c3a24f0632.png" width="1239" height="641" class="img_ev3q"></a></p><p>Note that there may be a slight delay in the availability of this option as the replica is still being synched.</p><p>It is worth noting that nothing comes for free! When you run in REGIONAL or High Availability mode - you are effectively paying double the costs as compared to running in ZONAL mode. However availability and cost have always been trade-offs against one another - you get what you pay for...</p><blockquote><p>More information can be found at: <a href="https://cloud.google.com/sql/docs/postgres/high-availability" target="_blank" rel="noopener noreferrer">https://cloud.google.com/sql/docs/postgres/high-availability</a></p></blockquote><p>Next up we will look at read replicas (and their ability to be promoted) as another high availability alternative in Cloud SQL.</p><blockquote><p>if you have enjoyed this post, please consider <a href="https://www.buymeacoffee.com/jeffreyaven" target="_blank" rel="noopener noreferrer"><strong>buying me a coffee ☕</strong></a> to help me keep writing!</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/cloudsql">cloudsql</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gcp">gcp</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ha">ha</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/highavailability">highavailability</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/postgresql">postgresql</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">StackQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.windrate.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">WindRate<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.e849b1f5.js"></script>
<script src="/assets/js/main.ef636b07.js"></script>
</body>
</html>