<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">One post tagged with &quot;microsoft&quot; | Full Stack Chronicles</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://fullstackchronicles.io/img/fullstackchronicles-cover-image.png"><meta data-rh="true" name="twitter:image" content="https://fullstackchronicles.io/img/fullstackchronicles-cover-image.png"><meta data-rh="true" property="og:url" content="https://fullstackchronicles.io/tags/microsoft"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="wot-verification" content="e7522390be4370727fac"><meta data-rh="true" property="og:title" content="One post tagged with &quot;microsoft&quot; | Full Stack Chronicles"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://fullstackchronicles.io/tags/microsoft"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/tags/microsoft" hreflang="en"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/tags/microsoft" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://MZCGVO503N-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Full Stack Chronicles Blog Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Full Stack Chronicles Blog Feed Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Full Stack Chronicles Blog Feed JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0FVDC1E8G6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0FVDC1E8G6",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Full Stack Chronicles" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.5ea58133.css">
<link rel="preload" href="/assets/js/runtime~main.5850473c.js" as="script">
<link rel="preload" href="/assets/js/main.b8fc3cd8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Full Stack Chronicles</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/tags">Topics</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/snowflake">Snowflake</a></li><li><a class="dropdown__link" href="/tags/okta">Okta</a></li><li><a class="dropdown__link" href="/tags/openapi">OpenAPI</a></li><li><a class="dropdown__link" href="/tags/spark">Spark</a></li><li><a class="dropdown__link" href="/tags/kafka">Kafka</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/apache-beam-in-five-minutes">Apache Beam in Five Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/aws-iam-vs-google-iam">AWS IAM vs Google IAM</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/create-and-use-custom-magic-commands-in-jupyter">Create and use Custom Magic Commands in Jupyter</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/deno-in-five-minutes">Deno in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/dbt-in-five-minutes">DBT in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/loading-parquet-files-into-snowflake">Loading Parquet Files into Snowflake</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/analyze-developer-activity-with-stackql-jupyter-bigquery">Analyze Developer Activity with StackQL, Jupyter and BigQuery</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/converting-google-discovery-docs-to-openapi3-specs">Converting Google Discovery Docs to OpenAPI3 Specs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/recurse-javascript-object-to-get-values-for-a-given-key-the-easy-way">Recurse JavaScript Object to Get Values for a Given Key the Easy Way</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/dataops-with-container-images-and-multi-stage-builds">DataOps with Container Images and Multi-Stage Builds</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;microsoft&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/images/azure_to_gcp_feature_image-1.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/creating-a-site-to-site-vpn-connection-between-gcp-and-azure-with-google-private-access">Creating a Site to Site VPN Connection Between GCP and Azure with Google Private Access</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-03-27T00:00:00.000Z" itemprop="datePublished">March 27, 2020</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This article demonstrates creating a site to site IPSEC VPN connection between a GCP VPC network and an Azure Virtual Network, enabling private RFC1918 network connectivity between virtual networks in both clouds. This is done using a single PowerShell script leveraging Azure PowerShell and gcloud commands in the Google SDK.</p><p>Additionally, we will use Azure Private DNS to enable private access between Azure hosts and GCP APIs (such as Cloud Storage or Big Query).</p><p>An overview of the solution is provided here:</p><p><a target="_blank" href="/assets/files/gcp-to-azure-vpn-design-f59e466042c5e6fdf12abc497dde73bd.png"><img loading="lazy" alt="Azure to GCP VPN Design" src="/assets/images/gcp-to-azure-vpn-design-f59e466042c5e6fdf12abc497dde73bd.png" width="3572" height="2407" class="img_ev3q"></a></p><p>One note before starting - site to site VPN connections between GCP and Azure currently do not support dynamic routing using BGP, however creating some simple routes on either end of the connection will be enough to get going.</p><p>Let’s go through this step by step:</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-1--authenticate-to-azure">Step 1 : Authenticate to Azure<a class="hash-link" href="#step-1--authenticate-to-azure" title="Direct link to heading">​</a></h2><p>Azure’s account equivalent is a subscription, the following command from Azure Powershell is used to authenticate a user to one or more subscriptions.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Connect-AzAccount</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This command will open a browser window prompting you for Microsoft credentials, once authenticated you will be returned to the command line.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-2--create-a-resource-group-azure">Step 2 : Create a Resource Group (Azure)<a class="hash-link" href="#step-2--create-a-resource-group-azure" title="Direct link to heading">​</a></h2><p>A resource group is roughly equivalent to a project in GCP. You will need to supply a Location (equivalent to a GCP region):</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">New-AzResourceGroup `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-3--create-a-virtual-network-with-subnets-and-routes-azure">Step 3 : Create a Virtual Network with Subnets and Routes (Azure)<a class="hash-link" href="#step-3--create-a-virtual-network-with-subnets-and-routes-azure" title="Direct link to heading">​</a></h2><p>An Azure Virtual Network is the equivalent of a VPC network in GCP (or AWS), you must define subnets before creating a Virtual Network. In this example we will create two subnets, one Gateway subnet (which needs to be named accordingly) where the VPN gateway will reside, and one subnet named ‘default’ where we will host VMs which will connect to GCP services over the private VPN connection.</p><p>Before defining the default subnet we must create and attach a Route Table (equivalent of a Route in GCP), this particular route will be used to route ‘private’ requests to services in GCP (such as Big Query).</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># define route table and route to GCP private access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azroutecfg = New-AzRouteConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;google-private&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;199.36.153.4/30&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -NextHopType &quot;VirtualNetworkGateway&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azrttbl = New-AzRouteTable `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;google-private&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Route $azroutecfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># define gateway subnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$gatewaySubnet = New-AzVirtualNetworkSubnetConfig  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;GatewaySubnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.2.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># define default subnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$defaultSubnet  = New-AzVirtualNetworkSubnetConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;default&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.1.0/24&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RouteTable $azrttbl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create virtual network and subnets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$vnet = New-AzVirtualNetwork  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;azure-to-gcp-vnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.0.0/16&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Subnet $gatewaySubnet,$defaultSubnet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-4--create-network-security-groups-azure">Step 4 : Create Network Security Groups (Azure)<a class="hash-link" href="#step-4--create-network-security-groups-azure" title="Direct link to heading">​</a></h2><p>Network Security Groups in Azure are stateful firewalls much like Firewall Rules in VPC networks in GCP. Like GCP, the lower priority overrides higher priority rules.</p><p>In the example we will create several rules to allow inbound ICMP, TCP and UDP traffic from our Google VPC and RDP traffic from the Internet (which we will use to logon to a VM in Azure to test private connectivity between the two clouds):</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create network security group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule1 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name rdp-rule `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow RDP&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Tcp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 100 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix Internet `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange 3389</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule2 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name icmp-rule `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow ICMP&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Icmp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 101 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule3 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name gcp-rule `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow GCP&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Tcp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 102 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix &quot;10.2.0.0/16&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$nsg = New-AzNetworkSecurityGroup `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;nsg-vm&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SecurityRules $rule1,$rule2,$rule3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-5--create-public-ip-addresses-azure">Step 5 : Create Public IP Addresses (Azure)<a class="hash-link" href="#step-5--create-public-ip-addresses-azure" title="Direct link to heading">​</a></h2><p>We need to create two Public IP Address (equivalent of an External IP in GCP) which will be used for our VPN gateway and for the VM we will create:</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create public IP address for VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$vmpip = New-AzPublicIpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vm-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AllocationMethod Dynamic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create public IP address for NW gateway </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ngwpip = New-AzPublicIpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AllocationMethod Dynamic</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-6--create-virtual-network-gateway-azure">Step 6 : Create Virtual Network Gateway (Azure)<a class="hash-link" href="#step-6--create-virtual-network-gateway-azure" title="Direct link to heading">​</a></h2><p>The Virtual Network Gateway in Azure is the VPN Gateway equivalent in Azure which will be used to create a VPN tunnel between Azure and a GCP VPN Gateway. This gateway will be placed in the Gateway subnet created previously and one of the Public IP addresses created in the previous step will be assigned to this gateway.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create virtual network gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ngwipconfig = New-AzVirtualNetworkGatewayIpConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ipconfig&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SubnetId $gatewaySubnet.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublicIpAddressId $ngwpip.Id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use the AsJob switch as this is a long running process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$job = New-AzVirtualNetworkGateway -Name &quot;vnet-gateway&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IpConfigurations $ngwipconfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewayType &quot;Vpn&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VpnType &quot;RouteBased&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewaySku &quot;VpnGw1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VpnGatewayGeneration &quot;Generation1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AsJob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$vnetgw = Get-AzVirtualNetworkGateway `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vnet-gateway&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-7--create-a-vpc-network-and-subnetworks-gcp">Step 7 : Create a VPC Network and Subnetwork(s) (GCP)<a class="hash-link" href="#step-7--create-a-vpc-network-and-subnetworks-gcp" title="Direct link to heading">​</a></h2><p>A VPC network and subnet need to be created in GCP, the subnet defines the VPC address space. This address space must not overlap with the Azure Virtual Network CIDR. For all GCP steps it is assumed that the project is set for client config (e.g. gcloud config set project <strong>your_project</strong>) so it does not need to be specified for each operation. Private Google access should be enabled on all subnets created.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># creating VPC network and subnets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks create &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --subnet-mode=custom `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --bgp-routing-mode=regional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks subnets create &quot;aus-subnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network  &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --range &quot;10.2.1.0/24&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-private-ip-google-access</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-8--create-an-external-ip-gcp">Step 8 : Create an External IP (GCP)<a class="hash-link" href="#step-8--create-an-external-ip-gcp" title="Direct link to heading">​</a></h2><p>An external IP address will need to be created in GCP which will be used for the external facing interface of the VPN Gateway.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># create external IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute addresses create </span><span class="token string" style="color:#e3116c">&quot;ext-gw-ip&quot;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">  --region </span><span class="token variable string" style="color:#e3116c">&quot;australia-southeast1&quot;</span><span class="token variable" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="display:inline-block;color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">$gcp_ipaddr_obj </span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa"> gcloud compute addresses describe </span><span class="token variable string" style="color:#e3116c">&quot;ext-gw-ip&quot;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region </span><span class="token string" style="color:#e3116c">&quot;australia-southeast1&quot;</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --format json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ConvertFrom-Json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$gcp_ipaddr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$gcp_ipaddr_obj</span><span class="token plain">.address</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-9--create-firewall-rules-gcp">Step 9 : Create Firewall Rules (GCP)<a class="hash-link" href="#step-9--create-firewall-rules-gcp" title="Direct link to heading">​</a></h2><p>VPC firewall rules will need to be created in GCP to allow VPN traffic as well as SSH traffic from the internet (which allows you to SSH into VM instances using Cloud Shell).</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create VPN firewall rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules create &quot;vpn-rule1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --allow tcp,udp,icmp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --source-ranges &quot;10.1.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules create &quot;ssh-rule1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --allow tcp:22</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-10--create-vpn-gateway-and-forwarding-rules-gcp">Step 10 : Create VPN Gateway and Forwarding Rules (GCP)<a class="hash-link" href="#step-10--create-vpn-gateway-and-forwarding-rules-gcp" title="Direct link to heading">​</a></h2><p>Create a VPN Gateway and Forwarding Rules in GCP which will be used to create a tunnel between GCP and Azure.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create cloud VPN </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute target-vpn-gateways create &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create forwarding rule ESP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-esp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol ESP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># creating forwarding rule UDP500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-udp500&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol UDP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ports 500 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># creating forwarding rule UDP4500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-udp4500&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol UDP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ports 4500 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-10--create-vpn-tunnel-gcp-side">Step 10 : Create VPN Tunnel (GCP Side)<a class="hash-link" href="#step-10--create-vpn-tunnel-gcp-side" title="Direct link to heading">​</a></h2><p>Now we will create the GCP side of our VPN tunnel using the Public IP Address of the Azure Virtual Network Gateway created in a previous step. As this example uses a route based VPN the traffic selector values need to be set at 0.0.0.0/0. A PSK (Pre Shared Key) needs to be supplied which will be the same key used when we configure a VPN Connection on the Azure side of the tunnel.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># get peer public IP address of Azure gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azpubip = Get-AzPublicIpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create VPN tunnel </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute vpn-tunnels create &quot;vpn-tunnel-to-azure&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-address $azpubip.IpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --local-traffic-selector &quot;0.0.0.0/0&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --remote-traffic-selector &quot;0.0.0.0/0&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ike-version 2 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --shared-secret &lt;&lt; Pre-Shared Key &gt;&gt; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region  &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-11--create-static-routes-gcp-side">Step 11 : Create Static Routes (GCP Side)<a class="hash-link" href="#step-11--create-static-routes-gcp-side" title="Direct link to heading">​</a></h2><p>As we are using static routing (as opposed to dynamic routing) we will need to define all of the specific routes on the GCP side. We will need to setup routes for both outgoing traffic to the Azure network as well as incoming traffic for the restricted Google API range (199.36.153.4/30).</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create static route (VPN)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute routes create &quot;route-to-azure&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --destination-range &quot;10.1.0.0/16&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-vpn-tunnel &quot;vpn-tunnel-to-azure&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-vpn-tunnel-region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create static route (Restricted APIs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute routes create apis `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network  &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --destination-range &quot;199.36.153.4/30&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-gateway default-internet-gateway `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-12--create-a-local-gateway-azure">Step 12 : Create a Local Gateway (Azure)<a class="hash-link" href="#step-12--create-a-local-gateway-azure" title="Direct link to heading">​</a></h2><p>A Local Gateway in Azure is an object that represents the remote gateway (GCP VPN gateway).</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create local gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azlocalgw = New-AzLocalNetworkGateway `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;local-gateway&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewayIpAddress $gcp_ipaddr `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.2.0.0/16&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-13--create-a-vpn-connection-azure">Step 13 : Create a VPN Connection (Azure)<a class="hash-link" href="#step-13--create-a-vpn-connection-azure" title="Direct link to heading">​</a></h2><p>Now we can setup the Azure side of the VPN Connection which is accomplished by associating the Azure Virtual Network Gateway with the Local Network Gateway. A PSK (Pre Shared Key) needs to be supplied which is the same key used for the GCP VPN Tunnel in step 10.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azvpnconn = New-AzVirtualNetworkGatewayConnection `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vpn-connection&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VirtualNetworkGateway1 $vnetgw `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -LocalNetworkGateway2 $azlocalgw `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ConnectionType IPsec `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SharedKey  &lt;&lt; Pre-Shared Key &gt;&gt;  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ConnectionProtocol &quot;IKEv2&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>VPN Tunnel Established!</p><p>At this stage we have created an end to end connection between the virtual networks in both clouds. You should see this reflected in the respective consoles in each provider.</p><figure><a href="/assets/images/gcp-vpn-to-azure-d627caa8febd797b530e1471bd5c9aff.png"><img src="/assets/images/gcp-vpn-to-azure-d627caa8febd797b530e1471bd5c9aff.png" alt="GCP VPN Tunnel to a Azure Virtual Network"></a><figcaption class="figure-caption">GCP VPN Tunnel to a Azure Virtual Network</figcaption></figure><figure><a href="/assets/images/azure-vpn-to-gcp-4716124e93f2cbc8a7e5ef5cd98d23df.png"><img src="/assets/images/azure-vpn-to-gcp-4716124e93f2cbc8a7e5ef5cd98d23df.png" alt="Azure VPN Connection to a GCP VPC Network"></a><figcaption class="figure-caption">Azure VPN Connection to a GCP VPC Network</figcaption></figure><p>Congratulations! You have just setup a multi cloud environment using private networking. Now let’s setup Google Private Access for Azure hosts and create VMs on each side to test our setup.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-14--create-a-private-dns-zone-for-googleapiscom-azure">Step 14 : Create a Private DNS Zone for googleapis.com (Azure)<a class="hash-link" href="#step-14--create-a-private-dns-zone-for-googleapiscom-azure" title="Direct link to heading">​</a></h2><p>We will now need to create a Private DNS zone in Azure for the googleapis.com domain which will host records to redirect Google API requests to the Restricted API range.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create private DNS zone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsZone `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;googleapis.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add A Records   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records = @()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsRecordSet `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;restricted&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RecordType A `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -TTL 300 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PrivateDnsRecords $Records</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add CNAME Records   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records = @()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Cname &quot;restricted.googleapis.com.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsRecordSet `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;*&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RecordType CNAME `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -TTL 300 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PrivateDnsRecords $Records</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Create VNet Link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsVirtualNetworkLink `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;dns-zone-link&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VirtualNetworkId $vnet.Id</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-15--create-a-virtual-machine-azure">Step 15 : Create a Virtual Machine (Azure)<a class="hash-link" href="#step-15--create-a-virtual-machine-azure" title="Direct link to heading">​</a></h2><p>We will create a VM in Azure which we can use to test the VPN tunnel as well as to test Private Google Access over our VPN tunnel.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$az_vmlocaladminpwd = ConvertTo-SecureString &lt;&lt; Password Param &gt;&gt; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AsPlainText -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Credential = New-Object System.Management.Automation.PSCredential  (&quot;LocalAdminUser&quot;, $az_vmlocaladminpwd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$nic = New-AzNetworkInterface `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vm-nic&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SubnetId $defaultSubnet.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -NetworkSecurityGroupId $nsg.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublicIpAddressId $vmpip.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -EnableAcceleratedNetworking `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = New-AzVMConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VMName &quot;windows-desktop&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VMSize &quot;Standard_D4_v3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Set-AzVMOperatingSystem `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Windows `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ComputerName  &quot;windows-desktop&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Credential $Credential `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ProvisionVMAgent `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -EnableAutoUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Add-AzVMNetworkInterface `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Id $nic.Id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Set-AzVMSourceImage `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublisherName &#x27;MicrosoftWindowsDesktop&#x27; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Offer &#x27;Windows-10&#x27; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Skus &#x27;rs5-pro&#x27; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Version latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzVM `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Verbose</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="step-16--create-a-vm-instance-gcp">Step 16 : Create a VM Instance (GCP)<a class="hash-link" href="#step-16--create-a-vm-instance-gcp" title="Direct link to heading">​</a></h2><p>We will create a Linux VM in GCP to test connectivity to hosts in Azure using the VPN tunnel we have established.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create VM instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute instances create &quot;gcp-instance&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --zone &quot;australia-southeast1-b&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --machine-type &quot;f1-micro&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --subnet &quot;aus-subnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network-tier PREMIUM `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --maintenance-policy MIGRATE `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --image=debian-9-stretch-v20200309 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --image-project=debian-cloud `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-size 10GB `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-type pd-standard `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-device-name instance-1 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --reservation-affinity any</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="test-connectivity">Test Connectivity<a class="hash-link" href="#test-connectivity" title="Direct link to heading">​</a></h2><p>Now we are ready to test connectivity from both sides of the tunnel.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="azure-to-gcp">Azure to GCP<a class="hash-link" href="#azure-to-gcp" title="Direct link to heading">​</a></h3><p>Establish a remote desktop (RDP) connection to the Azure VM created in Step 15. Ping the GCP VM instance using its private IP address.</p><p><a target="_blank" href="/assets/files/azure-ping-to-gcp-14a9b0e446b7c868ffa27ba3435460be.png"><img loading="lazy" alt="Test Private IP Connectivity from Azure to GCP" src="/assets/images/azure-ping-to-gcp-14a9b0e446b7c868ffa27ba3435460be.png" width="1635" height="967" class="img_ev3q"></a></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="gcp-to-azure">GCP to Azure<a class="hash-link" href="#gcp-to-azure" title="Direct link to heading">​</a></h3><p>Now SSH into the GCP Linux VM instance and ping the Azure host using its private IP address.</p><p><a target="_blank" href="/assets/files/gcp-ping-to-azure-94b9a33840b54870af540853cda825e9.png"><img loading="lazy" alt="Test Private IP Connectivity from GCP to Azure" src="/assets/images/gcp-ping-to-azure-94b9a33840b54870af540853cda825e9.png" width="902" height="710" class="img_ev3q"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="test-private-google-access-from-azure">Test Private Google Access from Azure<a class="hash-link" href="#test-private-google-access-from-azure" title="Direct link to heading">​</a></h2><p>Now that we have established bi-directional connectivity between the two clouds, we can test private access to Google APIs from our Azure host. Follow the steps below to test private access:</p><ol><li>RDP into the Azure VM</li><li>Install the Google Cloud SDK ( <a href="https://cloud.google.com/sdk/" target="_blank" rel="noopener noreferrer">https://cloud.google.com/sdk/</a>)</li><li>Perform an <code>nslookup</code> to ensure that calls to googleapis.com resolve to the restricted API range (e.g. <code>nslookup storage.googleapis.com</code>). You should see a response showing the A records from the googleapis.com Private DNS Zone created in step 14.</li><li>Now test connectivity to Google APIs, for example to test access to Google Cloud Storage using <code>gsutil</code>, or test access to Big Query using the <code>bq</code> command</li></ol><p>Congratulations! You are now a multi cloud ninja!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure">azure</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gcp">gcp</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/hybrid-cloud">hybrid-cloud</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/microsoft">microsoft</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/microsoft-azure">microsoft-azure</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/multi-cloud">multi-cloud</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/private-networking">private-networking</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/vpn">vpn</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">StackQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.windrate.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">WindRate<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.5850473c.js"></script>
<script src="/assets/js/main.b8fc3cd8.js"></script>
</body>
</html>