<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Cloudy with a chance of Big Data Blog Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Cloudy with a chance of Big Data Blog Feed Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Cloudy with a chance of Big Data Blog Feed JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4N6KSJ2G0P"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4N6KSJ2G0P",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloudy with a chance of Big Data" href="/opensearch.xml"><title data-react-helmet="true">15 posts tagged with &quot;googlecloudplatform&quot; | Cloudy with a chance of Big Data</title><meta data-react-helmet="true" property="og:title" content="15 posts tagged with &quot;googlecloudplatform&quot; | Cloudy with a chance of Big Data"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://cloudywithachanceofbigdata.com/tags/googlecloudplatform"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cloudywithachanceofbigdata.com/tags/googlecloudplatform"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.com/tags/googlecloudplatform" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.com/tags/googlecloudplatform" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.fe05d8b3.css">
<link rel="preload" href="/assets/js/runtime~main.514001fd.js" as="script">
<link rel="preload" href="/assets/js/main.731b638a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" style="background-color:#A9BCD0;color:#1A4E82" role="banner"><div class="announcementBarContent_KsVm"><b>If you find our content useful, give it a ‚≠êÔ∏è on <a target="_blank" rel="noopener noreferrer" href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io">GitHub</a>, if you want to contribute and become an author, submit a PR</b></div></div><nav class="navbar navbar--fixed-top navbarHideable_aKYr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title">Cloudy with a chance of Big Data</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/tags">Topics</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">üåú</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">üåû</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/simple-sso-with-an-external-idp-using-active-directory-and-okta">Simple SSO with an external IdP using Active Directory and Okta</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/converting-to-local-time-in-aws-lambda-using-nodejs">Converting to local time in AWS Lambda using Node.js</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/automating-snowflake-role-based-storage-integration-for-aws">Automating Snowflake Role Based Storage Integration for AWS</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/simplifying-large-cloudformation-templates-using-jsonnet">Simplifying Large CloudFormation Templates using Jsonnet</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/aws-deployments-with-cloudformation-and-gitlab-ci">Simplified AWS Deployments with CloudFormation and GitLab CI</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/from-wordpress-to-jamstack">From Wordpress to Jamstack</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/using-jsonnet-to-configure-multiple-environments">Using Jsonnet to Configure Multiple Environments</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/use-bigquery-to-trigger-cloud-run">Use BigQuery to trigger Cloud Run</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/azure-static-web-app-review">Azure Static Web App Review</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/introducing-the-metadata-hub-mdh">Introducing the Metadata Hub (MDH)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>15 posts tagged with &quot;googlecloudplatform&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/use-bigquery-to-trigger-cloud-run">Use BigQuery to trigger Cloud Run</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-06-19T00:00:00.000Z" itemprop="datePublished">June 19, 2021</time> ¬∑ <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="http://2.gravatar.com/avatar/58faa98ad68138dd1997f828f00a882e?s=80" alt="Tom Klimovski"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/tomklimovskigamma" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Tom Klimovski</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Cloud Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>So you&#x27;re using BigQuery (BQ). It&#x27;s all set up and humming perfectly. Maybe now, you want to run an ELT job whenever a new table partition is created, or maybe you want to retrain your ML model whenever new rows are inserted into the BQ table.</p><p>In my previous article on <a href="https://cloudywithachanceofbigdata.com/eventarc-the-state-of-eventing-in-google-cloud/" target="_blank" rel="noopener noreferrer">EventArc</a>, we went through how Logging can help us create eventing-type functionality in your application. Let&#x27;s take it a step further and walk through how we can couple BigQuery and Cloud Run.</p><p>In this article you will learn how to</p><ul><li>Tie together BigQuery and Cloud Run</li><li>Use BigQuery&#x27;s audit log to trigger Cloud Run</li><li>With those triggers, run your required code</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="lets-go">Let&#x27;s go!<a class="hash-link" href="#lets-go" title="Direct link to heading">‚Äã</a></h2><p>Let&#x27;s create a temporary dataset within BigQuery named <code>tmp_bq_to_cr</code>.</p><p>In that same dataset, let&#x27;s create a table in which we will insert some rows to test our BQ audit log. Let&#x27;s grab some rows from a BQ public dataset to create this table:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx sql"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> tmp_bq_to_cr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud_run_trigger </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> country_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> new_persons_vaccinated</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> population</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain">bigquery</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">covid19_open_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">covid19_open_data</span><span class="token punctuation" style="color:#393A34">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> country_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;Australia&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">date</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2021-05-31&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Following this, let&#x27;s run an insert query that will help us build our mock database trigger:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx sql"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> tmp_bq_to_cr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud_run_trigger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;2021-06-18&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Australia&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now, in another browser tab let&#x27;s navigate to <a href="https://console.cloud.google.com/logs/query;query=bigquery.v2?_ga=2.187390252.-505923201.1592376029" target="_blank" rel="noopener noreferrer">BQ Audit Events</a> and look for our <code>INSERT INTO</code> event:</p><p><a target="_blank" href="/assets/files/bq-insert-event-69f31456522fd0a5d613b44c3a7171a9.png"><img alt="BQ-insert-event" src="/assets/images/bq-insert-event-69f31456522fd0a5d613b44c3a7171a9.png" width="767" height="641"></a></p><p>There will be several audit logs for any given BQ action. Only after a query is parsed does BQ know which table we want to interact with, so the initial log will, for e.g., not have the table name.</p><p>We don&#x27;t want any old audit log, so we need to ensure we look for a unique set of attributes that clearly identify our action, such as in the diagram above.</p><p>In the case of inserting rows, the attributes are a combination of</p><ul><li>The method is <code>google.cloud.bigquery.v2.JobService.InsertJob</code></li><li>The name of the table being inserted to is the <code>protoPayload.resourceName</code></li><li>The dataset id is available as <code>resource.labels.dataset_id</code></li><li>The number of inserted rows is <code>protoPayload.metadata.tableDataChanged.insertedRowsCount</code></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="time-for-some-code">Time for some code<a class="hash-link" href="#time-for-some-code" title="Direct link to heading">‚Äã</a></h2><p>Now that we&#x27;ve identified the payload that we&#x27;re looking for, we can write the action for Cloud Run. We&#x27;ve picked Python and Flask to help us in this instance. (<a href="https://github.com/GoogleCloudPlatform/bigquery-oreilly-book/blob/master/blogs/cloud_run/main.py" target="_blank" rel="noopener noreferrer">full code is on GitHub</a>).</p><p>First, let&#x27;s filter out the noise and find the event we want to process</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Gets the Payload data from the Audit Log</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;resource&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;labels&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;dataset_id&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;resource&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;labels&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;project_id&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tbl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;protoPayload&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;resourceName&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rows </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;protoPayload&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;metadata&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;tableDataChange&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;insertedRowsCount&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ds </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;cloud_run_tmp&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           tbl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">endswith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;tables/cloud_run_trigger&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> rows </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> create_agg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;table created&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># if these fields are not in the JSON, ignore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ok&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now that we&#x27;ve found the event we want, let&#x27;s execute the action we need. In this example, we&#x27;ll aggregate and write out to a new table <code>created_by_trigger</code>:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">create_agg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bigquery</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    CREATE OR REPLACE TABLE tmp_bq_to_cr.created_by_trigger AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">      count_name, SUM(new_persons_vaccinated) AS n</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    FROM tmp_bq_to_cr.cloud_run_trigger</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> query</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The Dockerfile for the container is simply a basic Python container into which we install Flask and the BigQuery client library:</p><div class="codeBlockContainer_I0IT language-docker theme-code-block"><div class="codeBlockContent_wNvx docker"><pre tabindex="0" class="prism-code language-docker codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">FROM python:3.9-slim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install Flask==1.1.2 gunicorn==20.0.4 google-cloud-bigquery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV APP_HOME /app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR $APP_HOME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY *.py ./</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD exec gunicorn --bind :$PORT main:app</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="now-we-cloud-run">Now we Cloud Run<a class="hash-link" href="#now-we-cloud-run" title="Direct link to heading">‚Äã</a></h2><p>Build the container and deploy it using a couple of gcloud commands:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">SERVICE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bq-cloud-run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">PROJECT</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">gcloud config get-value project</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CONTAINER</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;gcr.io/</span><span class="token string variable" style="color:#36acaa">${PROJECT}</span><span class="token string" style="color:#e3116c">/</span><span class="token string variable" style="color:#36acaa">${SERVICE}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud builds submit --tag </span><span class="token variable" style="color:#36acaa">${CONTAINER}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud run deploy </span><span class="token variable" style="color:#36acaa">${SERVICE}</span><span class="token plain"> --image </span><span class="token variable" style="color:#36acaa">$CONTAINER</span><span class="token plain"> --platform managed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="i-always-forget-about-the-permissions">I always forget about the permissions<a class="hash-link" href="#i-always-forget-about-the-permissions" title="Direct link to heading">‚Äã</a></h2><p>In order for the trigger to work, the Cloud Run service account will need the following permissions:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud projects add-iam-policy-binding </span><span class="token variable" style="color:#36acaa">$PROJECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --member</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;serviceAccount:service-</span><span class="token string variable" style="color:#36acaa">${PROJECT_NO}</span><span class="token string" style="color:#e3116c">@gcp-sa-pubsub.iam.gserviceaccount.com&quot;</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --role</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;roles/iam.serviceAccountTokenCreator&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud projects add-iam-policy-binding </span><span class="token variable" style="color:#36acaa">$PROJECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --member</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">serviceAccount:</span><span class="token variable" style="color:#36acaa">${SVC_ACCOUNT}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --role</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;roles/eventarc.admin&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="finally-the-event-trigger">Finally, the event trigger<a class="hash-link" href="#finally-the-event-trigger" title="Direct link to heading">‚Äã</a></h3><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud eventarc triggers create </span><span class="token variable" style="color:#36acaa">${SERVICE}</span><span class="token plain">-trigger </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --location </span><span class="token variable" style="color:#36acaa">${REGION}</span><span class="token plain"> --service-account </span><span class="token variable" style="color:#36acaa">${SVC_ACCOUNT}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --destination-run-service </span><span class="token variable" style="color:#36acaa">${SERVICE}</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --event-filters </span><span class="token assign-left variable" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">google.cloud.audit.log.v1.written </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --event-filters </span><span class="token assign-left variable" style="color:#36acaa">methodName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">google.cloud.bigquery.v2.JobService.InsertJob </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --event-filters </span><span class="token assign-left variable" style="color:#36acaa">serviceName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bigquery.googleapis.com</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Important to note here is that we&#x27;re triggering on <em>any</em> Insert log created by BQ That&#x27;s why in this action we had to filter these events based on the payload.</p><h1>Take it for a spin</h1><p>Now, try out the BigQuery -&gt; Cloud Run trigger and action. Go to the BigQuery console and insert a row or two:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx sql"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> tmp_bq_to_cr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cloud_run_trigger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;2021-06-18&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Australia&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25000</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Watch as a new table called <code>created_by_trigger</code> gets created! You have successfully triggered a Cloud Run action on a database event in BigQuery.</p><p>Enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/big-query">big-query</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/bigquery">bigquery</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Use BigQuery to trigger Cloud Run" href="/use-bigquery-to-trigger-cloud-run"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/multi-cloud-diagramming-with-plantuml">Multi Cloud Diagramming with PlantUML</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-10-26T00:00:00.000Z" itemprop="datePublished">October 26, 2020</time> ¬∑ <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/multicloud.png"><div class="markdown" itemprop="articleBody"><p>Following on from the recent post <a href="https://cloudywithachanceofbigdata.com/gcp-templates-for-c4-diagrams-using-plantuml/" target="_blank" rel="noopener noreferrer">GCP Templates for C4 Diagrams using PlantUML</a>, cloud architects are often challenged with producing diagrams for architectures spanning multiple cloud providers, particularly as you elevate to enterprise level diagrams.</p><p>In this post, with the magic of <code>!includeurl</code> we have brought PlantUML template libraries together for AWS, Azure and GCP icon sets, allowing us to produce multi cloud C4 diagrams using PlantUML like this one:</p><p><a target="_blank" href="/assets/files/Example-Multi-Cloud-PlantUML-C4-Diagram-8695466addda79c4432fca63824ab2eb.png"><img alt="Multi Cloud Architecture Diagram using PlantUML" src="/assets/images/Example-Multi-Cloud-PlantUML-C4-Diagram-8695466addda79c4432fca63824ab2eb.png" width="1224" height="760"></a></p><p>Creating a multi cloud diagram is simple, start by adding the following <code>include</code> statements after the <code>@startuml</code> label in a new PlantUML C4 diagram:</p><iframe width="100%" frameborder="0" id="gist-5319b6b041f8b8f54c922a9a5b9b6e7c"></iframe><p>Then add references to the required services from different providers‚Ä¶</p><iframe width="100%" frameborder="0" id="gist-6ed55cd1b4e3b2e7027f8236af4aa112"></iframe><p>Then include the predefined resources from your different cloud providers in your diagram as shown here (describing a client server application over a cloud to cloud VPN between Azure and GCP)...</p><iframe width="100%" frameborder="0" id="gist-600aecff7094d7843771770b7048cb2c"></iframe><p>Happy multi-cloud diagramming!</p><blockquote><p>Full source code is available at:</p><p><a href="https://github.com/gamma-data/plantuml-multi-cloud-diagrams" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/plantuml-multi-cloud-diagrams</a></p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/amazonwebservices">amazonwebservices</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aws">aws</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/azure">azure</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/c-4-model">c4model</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/diagramming">diagramming</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/microsoft-azure">microsoft-azure</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/multi-cloud">multi-cloud</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/plantuml">plantuml</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/software-architecture">software-architecture</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Multi Cloud Diagramming with PlantUML" href="/multi-cloud-diagramming-with-plantuml"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/cloud-bigtable-primer-part-ii-row-key-selection-and-schema-design">Cloud Bigtable Primer Part II ‚Äì Row Key Selection and Schema Design</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-09-13T00:00:00.000Z" itemprop="datePublished">September 13, 2020</time> ¬∑ <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cbt-featured-image.png"><div class="markdown" itemprop="articleBody"><p>This is a follow up to the original Cloud Bigtable primer where we discussed the basics of Cloud Bigtable:</p><p><a href="https://cloudywithachanceofbigdata.com/cloud-bigtable-primer-part-i/" target="_blank" rel="noopener noreferrer"><strong>Cloud Bigtable Primer - Part I</strong></a></p><p>In this article we will cover schema design and row key selection in Bigtable ‚Äì arguably the most critical design decision to make when employing Bigtable in a cloud data architecture.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="quick-review">Quick Review<a class="hash-link" href="#quick-review" title="Direct link to heading">‚Äã</a></h2><p>Recall from the previous post where the Bigtable data model was introduced that tables in Bigtable are comprised of rows and columns - much like a table in any other RDBMS. Every row is uniquely identified by a rowkey ‚Äì again akin to a primary key in a table in an RDBMS. But this is where the similarities end.</p><p>Unlike a table in an RDBMS, columns only ever exist when they are inserted, and <code>NULLs</code> are not stored. See the illustration below:</p><p><a target="_blank" href="/assets/files/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png"><img src="/assets/images/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png" width="1024" height="297"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="row-key-selection">Row Key Selection<a class="hash-link" href="#row-key-selection" title="Direct link to heading">‚Äã</a></h2><p>Data in Bigtable is distributed by row keys. Row keys are physically stored in tablets in lexographic order. Recall that row keys are your ONLY indexes to data in Bigtable.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="selection-considerations">Selection Considerations<a class="hash-link" href="#selection-considerations" title="Direct link to heading">‚Äã</a></h3><p>As row keys are your only indexes to retrieve or update rows in Bigtable, row key design must take the access patterns for the data to be stored and served via Bigtable into consideration, specifically the following must be considered when designing a Bigtable application:</p><ul><li>Search patterns (returning data for a specific entity)</li><li>Scan patterns (returning batches of data)</li></ul><p>Queries that use the row key, a row prefix, or a row range are the most efficient. Queries that do not include a row key will typically scan GB or TB of data and would not be suitable for operational use cases.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="row-key-performance">Row Key Performance<a class="hash-link" href="#row-key-performance" title="Direct link to heading">‚Äã</a></h3><p>Row key performance will be biased towards your specific access patterns and application functional requirements. For example if you are performing sequential reads or scan operations then sequential keys will perform the best, however their write performance will not be optimal. Conversely, random keys (such as a <code>uuid</code>) will perform best for writes but poor for scan or sequential read operations.</p><p>Adding salts to keys (or additional data), similar to the use of salts in cryptography as well as promoting other field keys to be part of a composite row key can help achieve a ‚ÄúGoldilocks‚Äù scenario for both reads and writes, see the diagram below:</p><p><a target="_blank" href="/assets/files/keys-418e33748532e78f24865d6aad4c8ac4.png"><img src="/assets/images/keys-418e33748532e78f24865d6aad4c8ac4.png" width="684" height="551"></a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="using-reverse-timestamps">Using Reverse Timestamps<a class="hash-link" href="#using-reverse-timestamps" title="Direct link to heading">‚Äã</a></h3><p>Use reverse timestamps when your most common query is for the latest values. Typically you would append the reverse timestamp to the key, this will ensure that the same related records are grouped together, for instance if you are storing events for a customer using the customer id along with an appended reverse timestamp (for example <code>&lt;customer_id&gt;#&lt;reverse_ts&gt;</code>) would allow you to quickly serve the latest events for a customer in descending order as within each group (<code>customer_id</code>), rows will be sorted so most recent insert will be located at the top.<br>
<!-- -->A reverse timestamp can be generalised as:</p><p><code>Long.MAX_VALUE - System.currentTimeMillis()</code></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="schema-design-tips">Schema Design Tips<a class="hash-link" href="#schema-design-tips" title="Direct link to heading">‚Äã</a></h3><p>Some general tips for good schema design using Bigtable are summarised below:</p><ul><li>Group related data for more efficient reads using column families</li><li>Distribute data evenly for more efficient writes</li><li>Place identical values in the adjoining rows for more efficient compression using row keys</li></ul><p>Following these tips will give you the best possible performance using Bigtable.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="use-the-key-visualizer-to-profile-performance">Use the Key Visualizer to profile performance<a class="hash-link" href="#use-the-key-visualizer-to-profile-performance" title="Direct link to heading">‚Äã</a></h3><p>Google provides a neat tool to visualize your row key distribution in Cloud Bigtable. You need to have at least 30 GB of data in your table to enable this feature.</p><p>The Key Visualizer is shown here:</p><p><a target="_blank" href="/assets/files/image-d2e2037eaf05cfcfebc613b7821d624d.png"><img alt="Bigtable Key Visualizer" src="/assets/images/image-d2e2037eaf05cfcfebc613b7821d624d.png" width="733" height="403"></a></p><p>The Key Visualizer will help you find and prevent hotspots, find rows with too much data and show if your key schema is balanced.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">‚Äã</a></h3><p>Bigtable is one of the original and best (massively) distributed NoSQL platforms available. Schema and moreover row key design play a massive part in ensuring low latency and query performance. Go forth and conquer with Cloud Bigtable!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/bigtable">bigtable</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloud-bigtable">cloud-bigtable</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/nosql">nosql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Cloud Bigtable Primer Part II ‚Äì Row Key Selection and Schema Design" href="/cloud-bigtable-primer-part-ii-row-key-selection-and-schema-design"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/gcp-templates-for-c4-diagrams-using-plantuml">GCP Templates for C4 Diagrams using PlantUML</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-08-14T00:00:00.000Z" itemprop="datePublished">August 14, 2020</time> ¬∑ <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/gcp-c4.png"><div class="markdown" itemprop="articleBody"><p>I am a believer in the mantra of <em><strong>‚ÄúEverything-as-Code‚Äù</strong></em>, this includes diagrams and other architectural artefacts. Enter PlantUML‚Ä¶</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="plantuml">PlantUML<a class="hash-link" href="#plantuml" title="Direct link to heading">‚Äã</a></h2><p><a href="https://plantuml.com/" target="_blank" rel="noopener noreferrer">PlantUML</a> is an open-source tool which allows users to create UML diagrams from an intuitive DSL (Domain Specific Language). PlantUML is built on top of Graphviz and enables software architects and designers to use code to create Sequence Diagrams, Use Case Diagrams, Class Diagrams, State and Activity Diagrams and much more.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="c4-diagrams">C4 Diagrams<a class="hash-link" href="#c4-diagrams" title="Direct link to heading">‚Äã</a></h2><p>PlantUML can be extended to support the <a href="https://c4model.com/" target="_blank" rel="noopener noreferrer">C4 model</a> for visualising software architecture. Which describes software in different layers including Context, Container, Component and Code diagrams.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="gcp-architecture-diagramming-using-c4">GCP Architecture Diagramming using C4<a class="hash-link" href="#gcp-architecture-diagramming-using-c4" title="Direct link to heading">‚Äã</a></h2><p>PlantUML and C4 can be used to produce cloud architectures, there are official libraries available through PlantUML for Azure and AWS service icons, however these do not exist for GCP yet. There are several open source libraries available, however I have made an attempt to simplify the implementation.</p><p>The code below can be used to generate a C4 diagram describing a GCP architecture including official GCP service icons:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!define GCPPuml https://raw.githubusercontent.com/gamma-data/GCP-C4-PlantUML/master/templates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/C4\_Context.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/C4\_Component.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/C4\_Container.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/GCPC4Integration.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/GCPCommon.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Networking/CloudDNS.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Networking/CloudLoadBalancing.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Compute/ComputeEngine.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Storage/CloudStorage.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Databases/CloudSQL.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">title Sample C4 Diagram with GCP Icons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Person(publisher, &quot;Publisher&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System\_Ext(device, &quot;User&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Boundary(gcp,&quot;gcp-project&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CloudDNS(dns, &quot;Managed Zone&quot;, &quot;Cloud DNS&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CloudLoadBalancing(lb, &quot;L7 Load Balancer&quot;, &quot;Cloud Load Balancing&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CloudStorage(bucket, &quot;Static Content Bucket&quot;, &quot;Cloud Storage&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Boundary(region, &quot;gcp-region&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boundary(zonea, &quot;zone a&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ComputeEngine(gcea, &quot;Content Server&quot;, &quot;Compute Engine&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      CloudSQL(csqla, &quot;Dynamic Content&quot;, &quot;Cloud SQL&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boundary(zoneb, &quot;zone b&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ComputeEngine(gceb, &quot;Content Server&quot;, &quot;Compute Engine&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      CloudSQL(csqlb, &quot;Dynamic Content\\n(Read Replica)&quot;, &quot;Cloud SQL&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(device, dns, &quot;resolves name&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(device, lb, &quot;makes request&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(lb, gcea, &quot;routes request&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(lb, gceb, &quot;routes request&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(gcea, bucket, &quot;get static content&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(gceb, bucket, &quot;get static content&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(gcea, csqla, &quot;get dynamic content&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(gceb, csqla, &quot;get dynamic content&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(csqla, csqlb, &quot;replication&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rel(publisher,bucket,&quot;publish static content&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The preceding code generates the diagram below:</p><p><a target="_blank" href="/assets/files/Sample-C4-Diagram-with-GCP-Icons-291a0d7d898c0130b13e980e6752ec79.png"><img src="/assets/images/Sample-C4-Diagram-with-GCP-Icons-291a0d7d898c0130b13e980e6752ec79.png" width="662" height="1437"></a></p><p>Additional services can be added and used in your diagrams by adding them to your includes, such as:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/DataAnalytics/BigQuery.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/DataAnalytics/CloudDataflow.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/AIandMachineLearning/AIHub.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/AIandMachineLearning/CloudAutoML.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/DeveloperTools/CloudBuild.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/HybridandMultiCloud/Stackdriver.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/InternetofThings/CloudIoTCore.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Migration/TransferAppliance.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!includeurl GCPPuml/Security/CloudIAM.puml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&#x27; and more‚Ä¶</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><blockquote><p>The complete template library is available at:</p><p><a href="https://github.com/gamma-data/GCP-C4-PlantUML" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/GCP-C4-PlantUML</a></p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/c-4-model">c4model</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/diagramming">diagramming</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/plantuml">plantuml</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/software-architecture">software-architecture</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GCP Templates for C4 Diagrams using PlantUML" href="/gcp-templates-for-c4-diagrams-using-plantuml"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/cloud-bigtable-primer-part-i">Cloud Bigtable Primer - Part I</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-08-04T00:00:00.000Z" itemprop="datePublished">August 4, 2020</time> ¬∑ <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cbt-featured-image.png"><div class="markdown" itemprop="articleBody"><p>Bigtable is one of the foundational services in the Google Cloud Platform and to this day one of the greatest contributions to the big data ecosystem at large. It is also one of the least known services available, with all the headlines and attention going to more widely used services such as BigQuery.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="background">Background<a class="hash-link" href="#background" title="Direct link to heading">‚Äã</a></h2><p>In 2006 (pre Google Cloud Platform), Google released a white paper called <em><strong>‚ÄúBigtable: A Distributed Storage System for Structured Data‚Äù</strong></em>, this paper set out the reference architecture for what was to become Cloud Bigtable. This followed several other whitepapers including the GoogleFS and MapReduce whitepapers released in 2003 and 2004 which provided abstract reference architectures for the Google File System (now known as <strong><em>Colossus</em></strong>) and the MapReduce algorithm. These whitepapers inspired a generation of open source distributed processing systems including Hadoop. Google has long had a pattern of publicising a generalized overview of their approach to solving different storage and processing challenges at scale through white papers.</p><p><a target="_blank" href="/assets/files/bigtable-osdi06-16d141802d2310614e01534fb1c82a11.pdf"><img alt="Bigtable Whitepaper 2006" src="/assets/images/bigtable-whitepaper-09803ad0c30b5dc4fa560e006ce33021.png" width="699" height="903"></a></p><p>The Bigtable white paper inspired a wave of open source distributed key/value oriented NoSQL data stores including Apache HBase and Apache Cassandra.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="what-is-bigtable">What is Bigtable?<a class="hash-link" href="#what-is-bigtable" title="Direct link to heading">‚Äã</a></h2><p>Bigtable is a distributed, petabyte scale NoSQL database. More specifically, Bigtable is‚Ä¶</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="a-map">a map<a class="hash-link" href="#a-map" title="Direct link to heading">‚Äã</a></h3><p>At its core Bigtable is a distributed map or an associative array indexed by a row key, with values in columns which are created only when they are referenced. Each value is an uninterpreted byte array.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sorted">sorted<a class="hash-link" href="#sorted" title="Direct link to heading">‚Äã</a></h3><p>Row keys are stored in lexographic order akin to a clustered index in a relational database.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sparse">sparse<a class="hash-link" href="#sparse" title="Direct link to heading">‚Äã</a></h3><p>A given row can have any number of columns, not all columns must have values and NULLs are not stored. There may also be gaps between keys.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="multi-dimensional">multi-dimensional<a class="hash-link" href="#multi-dimensional" title="Direct link to heading">‚Äã</a></h3><p>All values are versioned with a timestamp (or configurable integer). Data is not updated in place, it is instead superseded with another version.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="when-and-when-not-to-use-bigtable">When (and when not) to use Bigtable<a class="hash-link" href="#when-and-when-not-to-use-bigtable" title="Direct link to heading">‚Äã</a></h2><ul><li>You need to do many thousands of operations per second on TB+ scale data</li><li>Your access patterns are well known and simple</li><li>You need to support random write or random read operations (or sequential reads) - each using a row key as the primary identifier</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="dont-use-bigtable-if">Don‚Äôt use Bigtable if‚Ä¶<a class="hash-link" href="#dont-use-bigtable-if" title="Direct link to heading">‚Äã</a></h3><ul><li>You need explicit JOIN capability, that is joining one or more tables</li><li>You need to do ad-hoc analytics</li><li>Your access patterns are unknown or not well defined</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bigtable-vs-relational-database-systems">Bigtable vs Relational Database Systems<a class="hash-link" href="#bigtable-vs-relational-database-systems" title="Direct link to heading">‚Äã</a></h3><p>The following table compares and contrasts Bigtable against relational databases (both transaction oriented and analytic oriented databases):</p><table><thead><tr><th>¬†</th><th>Bigtable</th><th>RDBMS (OLTP)</th><th>RDBMS (DSS/MPP)</th></tr></thead><tbody><tr><td>Data Layout</td><td>Column Family Oriented</td><td>Row Oriented</td><td>Column Oriented</td></tr><tr><td>Transaction Support</td><td>Single Row Only</td><td>Yes</td><td>Depends (but usually no)</td></tr><tr><td>Query DSL</td><td>get/put/scan/delete</td><td>SQL</td><td>SQL</td></tr><tr><td>Indexes</td><td>Row Key Only</td><td>Yes</td><td>Yes (typically PI based)</td></tr><tr><td>Max Data Size</td><td>PB+</td><td>&#x27;00s GB  to TB</td><td>TB+</td></tr><tr><td>Read/Write Throughput</td><td>&quot;&#x27;000</td><td>000s queries/s&quot;</td><td>&#x27;000s queries/s</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bigtable-data-model">Bigtable Data Model<a class="hash-link" href="#bigtable-data-model" title="Direct link to heading">‚Äã</a></h2><p><strong><em>Tables</em></strong> in Bigtable are comprised of rows and columns (sounds familiar so far..). Every row is uniquely identified by a <strong><em>rowkey</em></strong> (like a primary key..again sounds familiar so far).</p><p><strong><em>Columns</em></strong> belong to <strong><em>Column Families</em></strong> and only exist when inserted, NULLs are not stored - this is where it starts to differ from a traditional RDBMS. The following image demonstrates the data model for a fictitious table in Bigtable.</p><p><a target="_blank" href="/assets/files/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png"><img alt="Bigtable Data Model" src="/assets/images/bigtable-data-model-0e76eb10501530b624d8be2abe3a46df.png" width="1024" height="297"></a></p><p>In the previous example, we created two Column Families (<strong><em>cf1</em></strong> and <strong><em>cf2</em></strong>). These are created during table definition or update operations (akin to DDL operations in the relational world). In this case, we have chosen to store primary attributes, like name, etc in cf1 and features (or derived attributes) in cf2 like indicators.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cell-versioning">Cell versioning<a class="hash-link" href="#cell-versioning" title="Direct link to heading">‚Äã</a></h3><p>Each cell has a timestamp/version associated with it, multiple versions of a row can exist. Versions are naturally stored in descending order.</p><p>Properties such as the max age for a cell or the maximum number of versions to be stored for any given cell are set on the Column Family. Versions are compacted through a process called <strong><em>Garbage Collection</em></strong> - not to be confused with Java Garbage Collection (albeit same idea).</p><table><thead><tr><th>Row Key</th><th>Column</th><th>Value</th><th>Timestamp</th></tr></thead><tbody><tr><td>123</td><td>cf1:status</td><td>ACTIVE</td><td>2020-06-30T08.58.27.560</td></tr><tr><td>123</td><td>cf1:status</td><td>PENDING</td><td>2020-06-28T06.20.18.330</td></tr><tr><td>123</td><td>cf1:status</td><td>INACTIVE</td><td>2020-06-27T07.59.20.460</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bigtable-instances-clusters-nodes-and-tables">Bigtable Instances, Clusters, Nodes and Tables<a class="hash-link" href="#bigtable-instances-clusters-nodes-and-tables" title="Direct link to heading">‚Äã</a></h2><p>Bigtable is a &quot;no-ops&quot; service, meaning you do not need to configure machine types or details about the underlying infrastructure, save a few sizing or performance options - such as the number of nodes in a cluster or whether to use solid state hard drives (SSD) or the magnetic alternative (HDD). The following diagram shows the relationships and cardinality for Cloud Bigtable.</p><p><a target="_blank" href="/assets/files/bigtable-instances-and-nodes-b2d9e98ce7a8bf66600d284bafb5d3a9.png"><img alt="Bigtable Instances, Clusters and Nodes" src="/assets/images/bigtable-instances-and-nodes-b2d9e98ce7a8bf66600d284bafb5d3a9.png" width="964" height="487"></a></p><p><strong><em>Clusters</em></strong> and <strong><em>nodes</em></strong> are the physical compute layer for Bigtable, these are zonal assets, zonal and regional availability can be achieved through replication which we will discuss later in this article.</p><p><strong><em>Instances</em></strong> are a virtual abstraction for clusters, Tables belong to instances (not clusters). This is due to Bigtables underlying architecture which is based upon a separation of storage and compute as shown below.</p><p><a target="_blank" href="/assets/files/bigtable-storage-and-compute-b0c9a76792b16e425ee5d623d4339368.png"><img alt="Bigtable Separation of Storage and Compute" src="/assets/images/bigtable-storage-and-compute-b0c9a76792b16e425ee5d623d4339368.png" width="472" height="482"></a></p><p>Bigtables separation of storage and compute allow it to scale horizontally, as nodes are stateless they can be increased to increase query performance. The underlying storage system in inherently scalable.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="physical-storage--column-families">Physical Storage &amp; Column Families<a class="hash-link" href="#physical-storage--column-families" title="Direct link to heading">‚Äã</a></h3><p>Data (Columns) for Bigtable is stored in <strong><em>Tablets</em></strong> (as shown in the previous diagram), which store &quot;regions&quot; of row keys for a particular Column Family. Columns consist of a column family prefix and qualifier, for instance:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cf1:col1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A table can have one or more Column Families. Column families must be declared at schema definition time (could be a create or alter operation). A cell is an intersection of a row key and a version of a column within a column family.</p><p>Storage settings (such as the compaction/garbage collection properties mentioned before) can be specified for each Column Family - which can differ from other column families in the same table.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bigtable-availability-and-replication">Bigtable Availability and Replication<a class="hash-link" href="#bigtable-availability-and-replication" title="Direct link to heading">‚Äã</a></h3><p><strong><em>Replication</em></strong> is used to increase availability and durability for Cloud Bigtable ‚Äì this can also be used to segregate read and write operations for the same table.</p><p>Data and changes to tables are replicated across multiple regions or multiple zones within the same region, this replication can be blocking (single row transactions) or non blocking (eventually consistent). However all clusters within a Bigtable instance are considered primary (writable).</p><p>Requests are routed using <strong><em>Application Profiles</em></strong>, a <strong><em>single-cluster routing</em></strong> policy can be used for manual failover, whereas a <strong><em>multi-cluster routing</em></strong> is used for automatic failover.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="backup-and-export-options-for-bigtable">Backup and Export Options for Bigtable<a class="hash-link" href="#backup-and-export-options-for-bigtable" title="Direct link to heading">‚Äã</a></h3><p>Managed backups can be taken at a table level, new tables can be created from backups. The backups cannot be exported, however table level export and import operations are available via pre-baked Dataflow templates for data stored in GCS in the following formats:</p><ul><li>SequenceFiles</li><li>Avro Files</li><li>Parquet Files</li><li>CSV Files</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="accessing-bigtable">Accessing Bigtable<a class="hash-link" href="#accessing-bigtable" title="Direct link to heading">‚Äã</a></h2><p>Bigtable data and admin functions are available via:</p><ul><li><code>cbt</code> (optional component of the Google SDK)</li><li><code>hbase shell</code> (REPL shell)</li><li>Happybase API (Python API for Hbase)</li><li>SDK libraries for:<ul><li>Golang</li><li>Python</li><li>Java</li><li>Node.js</li><li>Ruby</li><li>C#, C++, PHP, and more</li></ul></li></ul><p>As Bigtable is not a cheap service, there is a local emulator available which is great for application development. This is part of the Cloud SDK, and can be started using the following command:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud beta emulators bigtable start</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In the next article in this series we will demonstrate admin and data functions as well as the local emulator.</p><blockquote><p>Next Up : Part II - Row Key Selection and Schema Design in Bigtable</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/bigtable">bigtable</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloud-bigtable">cloud-bigtable</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/nosql">nosql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Cloud Bigtable Primer - Part I" href="/cloud-bigtable-primer-part-i"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/automated-gcs-object-scanning-using-dlp-with-notifications-using-slack">Automated GCS Object Scanning Using DLP with Notifications Using Slack</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-06-01T00:00:00.000Z" itemprop="datePublished">June 1, 2020</time> ¬∑ <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/Slack-GCS-DLP-Image-e1591007165488.png"><div class="markdown" itemprop="articleBody"><p>This is a follow up to a previous blog, <a href="https://cloudywithachanceofbigdata.com/google-cloud-storage-object-notifications-using-slack/" target="_blank" rel="noopener noreferrer"><strong>Google Cloud Storage Object Notifications using Slack</strong></a> in which we used Slack to notify us of new objects being uploaded to GCS.</p><p>In this article we will take things a step further, where uploading an object to a GCS bucket will trigger a DLP inspection of the object and if any preconfigured info types (such as credit card numbers or API credentials) are present in the object, a Slack notification will be generated.</p><p>As DLP scans are ‚Äújobs‚Äù, meaning they run asynchronously, we will need to trigger scans and inspect results using two separate Cloud Functions (one for triggering a scan <!-- -->[<code>gcs-dlp-scan-trigger</code>]<!-- --> and one for inspecting the results of the scan <!-- -->[<code>gcs-dlp-evaluate-results</code>]<!-- -->) and a Cloud PubSub topic <!-- -->[<code>dlp-scan-topic</code>]<!-- --> which is used to hold the reference to the DLP job.</p><p>The process is described using the sequence diagram below:</p><p><a target="_blank" href="/assets/files/dlp-notifications-using-slack-d58f8548ccf305103d24c181be50ecda.png"><img src="/assets/images/dlp-notifications-using-slack-d58f8548ccf305103d24c181be50ecda.png" width="1584" height="597"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="the-code">The Code<a class="hash-link" href="#the-code" title="Direct link to heading">‚Äã</a></h2><p>The <code>gcs-dlp-scan-trigger</code> Cloud Function fires when a new object is created in a specified GCS bucket. This function configures the DLP scan to be executed, including the DLP info types (for instance <code>CREDIT_CARD_NUMBER</code>, <code>EMAIL_ADDRESS</code>, <code>ETHNIC_GROUP</code>, <code>PHONE_NUMBER</code>, etc) a and likelihood of that info type existing (for instance <code>LIKELY</code>). DLP scans determine the probability of an info type occurring in the data, they do not scan every object in its entirety as this would be too expensive.</p><p>The primary function executed in the <code>gcs-dlp-scan-trigger</code> Cloud Function is named <code>inspect_gcs_file</code>. This function configures and submits the DLP job, supplying a PubSub topic to which the DLP Job Name will be written, the code for the <code>inspect_gcs_file</code> is shown here:</p><iframe width="100%" frameborder="0" id="gist-913a4457f43bc7b80e4405dd01f7b64d"></iframe><p>At this stage the DLP job is created an running asynchronously, the next Cloud Function, <code>gcs-dlp-evaluate-results</code>, fires when a message is sent to the PubSub topic defined in the DLP job. The <code>gcs-dlp-evaluate-results</code> reads the DLP Job Name from the PubSub topic, connects to the DLP service and queries the job status, when the job is complete, this function checks the results of the scan, if the <code>min_likliehood</code> threshold is met for any of the specified info types, a Slack message is generated. The code for the main method in the <code>gcs-dlp-evaluate-results</code> function is shown here:</p><iframe width="100%" frameborder="0" id="gist-ab377f6c3e448ae7c623d057239e05ed"></iframe><p>Finally, a Slack webhook is used to send the message to a specified Slack channel in a workspace, this is done using the <code>send_slack_notification</code> function shown here:</p><iframe width="100%" frameborder="0" id="gist-15d9e7c0922c26b680bed81abfcbadff"></iframe><p>An example Slack message is shown here:</p><p><a target="_blank" href="/assets/files/gcs-dlp-results-slack-notification-b8be26df34031f7e12c152c85781f4b4.png"><img alt="Slack Notification for Sensitive Data Detected in a Newly Created GCS Object" src="/assets/images/gcs-dlp-results-slack-notification-b8be26df34031f7e12c152c85781f4b4.png" width="934" height="324"></a></p><blockquote><p>Full source code can be found at: <a href="https://github.com/gamma-data/automated-gcs-object-scanning-using-dlp-with-notifications-using-slack" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/automated-gcs-object-scanning-using-dlp-with-notifications-using-slack</a></p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloud-dlp">cloud-dlp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloud-functions">cloud-functions</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloud-storage">cloud-storage</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/dlp">dlp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcs">gcs</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/python">python</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/slack">slack</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Automated GCS Object Scanning Using DLP with Notifications Using Slack" href="/automated-gcs-object-scanning-using-dlp-with-notifications-using-slack"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/forseti-terraform-validator-enforcing-resource-policy-compliance-in-your-ci-pipeline">Forseti Terraform Validator: Enforcing resource policy compliance in your CI pipeline</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-04-18T00:00:00.000Z" itemprop="datePublished">April 18, 2020</time> ¬∑ <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/daniel-hussey/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="http://2.gravatar.com/avatar/b0daeaf079c3665ee65a250adba487ee?s=80" alt="Daniel Hussey"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/daniel-hussey/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Daniel Hussey</span></a></div><small class="avatar__subtitle" itemprop="description">Cloud Security Engineer</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/Forseti-Terraform-e1587291818418.png"><div class="markdown" itemprop="articleBody"><p>Terraform is a powerful tool for managing your Infrastructure as Code. Declare your resources once, define their variables per environment and sleep easy knowing your CI pipeline will take care of the rest.</p><p>But‚Ä¶ one night you wake up in a sweat. The details are fuzzy but you were browsing your favourite cloud provider‚Äôs console - probably GCP ;) - and thought you saw a bucket had been created outside of your allowed locations! Maybe it even had risky access controls.</p><p>You go brush it off and try to fall back to sleep, but you can‚Äôt quite push the thought from your mind that somewhere in all that Terraform code, someone <em>could</em> be declaring resources in unapproved locations, and your CICD pipeline would do nothing to stop it. Oh the regulatory implications.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="enter-terraform-validator-by-forseti">Enter Terraform Validator by Forseti<a class="hash-link" href="#enter-terraform-validator-by-forseti" title="Direct link to heading">‚Äã</a></h2><p>Terraform Validator by Forseti allows you to declare your Policy as Code, check compliance of your Terraform plans against said Policy, and automatically fail violating plans in a CI step. All without setting up servers or agents.</p><p>You‚Äôre going to learn how to enforce policy on GCP resources like BigQuery, IAM, networks, MySQL, Google Kubernetes Engine (GKE) and more. If you‚Äôre particularly crafty, you may be able to go beyond GCP.</p><p>Forseti‚Äôs suite of solutions are GCP focused and allow a wide range of live config validation, monitoring and more using the Policy Library we‚Äôre going to set up. These additional capabilities require additional infrastructure. But we‚Äôre going one step at a time, starting with enforcing policy during deployment.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="getting-started">Getting Started<a class="hash-link" href="#getting-started" title="Direct link to heading">‚Äã</a></h2><p>Let‚Äôs assume you already have an established CICD pipeline that uses Terraform, or that you are content to validate your Terraform plans locally for now. In that case, we need just two things:</p><ol><li>A Policy Library</li><li>Terraform Validator</li></ol><p>It‚Äôs that simple! No new servers, agents, firewall rules, extra service accounts or other nonsense. Just add Policy Library, the Validator tool and you can enforce policy on your Terraform deployments.</p><p>We‚Äôre going to tinker with some existing GCP-focused sample policies (aka Constraints) that Forseti makes available. These samples cover a wide range of resources and use cases, so it is easy to adjust what‚Äôs provided to define your own Constraints.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="policy-library">Policy Library<a class="hash-link" href="#policy-library" title="Direct link to heading">‚Äã</a></h2><p>First let&#x27;s open up some of Forseti&#x27;s pre-defined constraints. We‚Äôll copy them into our own Git repository and adjust to create policies that match our needs. Repeatable and configurable - that‚Äôs Policy as Code at work.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="concepts">Concepts<a class="hash-link" href="#concepts" title="Direct link to heading">‚Äã</a></h3><p>In the world of Forseti and in particular Terraform Validator, Policies are defined and understood via easy to read YAML files known as Constraints</p><p>There is just enough information in a Constraint file for to make clear its purpose and effect, and by tinkering lightly with a pre-written Constraint you can achieve a lot without looking too deeply into the inner workings . But there‚Äôs more happening than meets the eye.</p><p>Constraints are built on Templates - which are like forms with some extra bits waiting to be completed to make a Constraint. Except there‚Äôs a lot more hidden away that‚Äôs pretty cool if you want to understand it.</p><p>Think of a Template as a ‚ÄòClass‚Äô in the OOP sense, and of a Constraint as an instantiated Template with all the key attributes defined.</p><p>E.g. A generic Template for policy on bucket locations and a Constraint to specify which locations are relevant in a given instance. Again, buckets and locations are just the basic example - the potential applications are far greater.</p><p>Now the real magic is that just like a ‚ÄòClass‚Äô, a Template contains logic that makes everything abstracted away in the Constraint possible. Templates contain inline Rego (ray-go), borrowed lovingly by Forseti from the Open Policy Agent (OPA) team.</p><p>Learn more about Rego and OPA <a href="https://www.openpolicyagent.org/docs/latest/policy-language/" target="_blank" rel="noopener noreferrer">here</a> to understand the relationship to our Terraform Validator.</p><p>But let‚Äôs begin.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="set-up-your-policies">Set up your Policies<a class="hash-link" href="#set-up-your-policies" title="Direct link to heading">‚Äã</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="create-your-policy-library-repository">Create your Policy Library repository<a class="hash-link" href="#create-your-policy-library-repository" title="Direct link to heading">‚Äã</a></h4><p>Create your Policy Library repository by cloning <a href="https://github.com/forseti-security/policy-library" target="_blank" rel="noopener noreferrer">https://github.com/forseti-security/policy-library</a> into your own VCS.</p><p>This repo contains templates and sample constraints which will form the basis of your policies. So get it into your Git environment and clone it to local for the next step.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="customise-sample-constraints-to-fit-your-needs">Customise sample constraints to fit your needs<a class="hash-link" href="#customise-sample-constraints-to-fit-your-needs" title="Direct link to heading">‚Äã</a></h4><p>As discussed in Concepts, Constraints are defined Templates, which make use of Rego policy language. Nice. So let‚Äôs take a sample Constraint, put it in our Policy Library and set the values to what we need. It‚Äôs that easy - no need to write new templates or learn Rego if your use case is covered.</p><p>In a new branch‚Ä¶</p><ol><li>Copy the sample Constraint <code>storage_location.yaml</code> to your Constraints folder.  </li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> policy-library/samples/storage_location.yaml policy-library/policies/constraints/storage_location.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="2"><li>Replace the sample location (<code>asia-southeast1</code>) in <code>storage_location.yaml</code> with <code>australia-southeast1</code>.  </li></ol><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">severity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> high  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">target</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;organization/*&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;allowlist&quot;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">locations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> australia</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">southeast1  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">exemptions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="3"><li>Push back to your repo - not Forseti‚Äôs!  </li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> push https://github.com/</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">your-repository</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">/policy-library.git</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="policy-review">Policy review<a class="hash-link" href="#policy-review" title="Direct link to heading">‚Äã</a></h4><p>There you go - you‚Äôve customised a sample Constraint. Now you have your own instance of version controlled Policy-as-Code and are ready to apply the power of OPA‚Äôs Rego policy language that lies within the parent Template. Impressively easy right?</p><p>That‚Äôs a pretty simple example. You can browse the rest of Forseti‚Äôs Policy Library to view other sample Constraints, Templates and the Rego logic that makes all of this work. These can be adjusted to cover all kinds of use cases across GCP resources.</p><p>I suggest working with and editing the <a href="https://github.com/forseti-security/policy-library/tree/master/samples" target="_blank" rel="noopener noreferrer">sample Constraints</a> before making any changes to Templates.</p><p>If you were to write Rego and Templates from scratch, you might even be able to enforce Policy as Code against non-GCP Terraform code.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="terraform-validator">Terraform Validator<a class="hash-link" href="#terraform-validator" title="Direct link to heading">‚Äã</a></h2><p>Now, let‚Äôs set up the Terraform Validator tool and have it compare a sample piece of Terraform code against the Constraint we configured above. Keep in mind you‚Äôll want to translate what‚Äôs done here into steps in your CICD pipeline.</p><p>Once the tool is in place, we really just run <code>terraform plan</code> and feed the output into Terraform Validator. The Validator compares it to our Constraints, runs all the abstracted logic we don‚Äôt need to worry about and returns 0 or 2 when done for pass / fail respectively. Easy.</p><p>So using Terraform if I try to make a bucket in <code>australia-southeast1</code> it should pass, if I try to make one in the US it should fail. Let‚Äôs set up the tool, write some basic Terraform and see how we go.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="setup-terraform-validator">Setup Terraform Validator<a class="hash-link" href="#setup-terraform-validator" title="Direct link to heading">‚Äã</a></h3><p>Check for the latest version of <code>terraform-validator</code> from the official terraform-validator GCS bucket.</p><p>Very important when using tf version 0.12 or greater. This is the easy way - you can pull from the <a href="https://github.com/GoogleCloudPlatform/terraform-validator" target="_blank" rel="noopener noreferrer">Terraform Validator Github</a> and make it yourself too.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gsutil </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -r gs://terraform-validator/releases</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Copy the latest version to the working dir</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ gsutil </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> gs://terraform-validator/releases/2020-03-05/terraform-validator-linux-amd64 </span><span class="token builtin class-name">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Make it executable</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">755</span><span class="token plain"> terraform-validator-linux-amd64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Ready to go!</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="review-your-terraform-code">Review your Terraform code<a class="hash-link" href="#review-your-terraform-code" title="Direct link to heading">‚Äã</a></h3><p>We‚Äôre going to make a ridiculously simple piece of Terraform that tries to create one bucket in our project to keep things simple.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># main.tf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_storage_bucket&quot; &quot;tf-validator-demo-bucket&quot; {¬†¬†</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name¬† ¬† ¬† ¬† ¬† = &quot;tf-validator-demo-bucket&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">¬†¬†location¬† ¬† ¬† = &quot;US&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">¬†¬†force_destroy = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">¬†¬†lifecycle_rule {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">¬†¬†¬†¬†condition {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">¬†¬†¬†¬†¬†¬†age = &quot;3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">¬†¬†¬†¬†}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">¬†¬†¬†¬†action {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">¬†¬†¬†¬†¬†¬†type = &quot;Delete&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">¬†¬†¬†¬†}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">¬†¬†}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This is a pretty standard bit of Terraform for a GCS bucket, but made very simple with all the values defined directly in <code>main.tf</code>. Note the location of the bucket - it violates our Constraint that was set to the <code>australia-southeast1</code> region.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="make-the-terraform-plan">Make the Terraform plan<a class="hash-link" href="#make-the-terraform-plan" title="Direct link to heading">‚Äã</a></h3><p>Warm up Terraform.<br>
<!-- -->Double check your Terraform code if there are any hiccups.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform init</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Make the Terraform plan and store output to file.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform plan --out</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">terraform.tfplan</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Convert the plan to JSON</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ terraform show -json ./terraform.tfplan </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> ./terraform.tfplan.json</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="validate-the-non-compliant-terraform-plan-against-your-constraints-for-example">Validate the non-compliant Terraform plan against your Constraints, for example<a class="hash-link" href="#validate-the-non-compliant-terraform-plan-against-your-constraints-for-example" title="Direct link to heading">‚Äã</a></h3><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./terraform-validator-linux-amd64 validate ./tfplan.tfplan.json --policy-path</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/repos/policy-library/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>TA-DA!</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Found Violations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Constraint allow_some_storage_location on resource //storage.googleapis.com/tf-validator-demo-bucket: //storage.googleapis.com/tf-validator-demo-bucket is in a disallowed location.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="validate-the-compliant-terraform-plan-against-your-constraints">Validate the compliant Terraform plan against your Constraints<a class="hash-link" href="#validate-the-compliant-terraform-plan-against-your-constraints" title="Direct link to heading">‚Äã</a></h3><p>Let‚Äôs see what happens if we repeat the above, changing the location of our GCS bucket to <code>australia-southeast1</code>.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./terraform-validator-linux-amd64 validate ./tfplan.tfplan.json --policy-path</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/repos/policy-library/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Results in..</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">No violations found.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Success!!!</p><p>Now all that‚Äôs left to do for your Policy as Code CICD pipeline is to configure the rest of your Constraints and run this check before you go ahead and <code>terraform apply</code>. Be sure to make the <code>apply</code> step dependent on the outcome of the Validator.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="wrap-up">Wrap Up<a class="hash-link" href="#wrap-up" title="Direct link to heading">‚Äã</a></h2><p>We‚Äôve looked at how to apply Policy as Code to validate our Infrastructure as Code. Sounds pretty modern and DevOpsy doesn‚Äôt it.</p><p>To recap, we learned about Constraints, which are fully defined instances of Policy as Code. They‚Äôre based on YAML Templates that refer to the OPA policy language Rego, but we didn‚Äôt have to learn it :)</p><p>We created our own version controlled Policy Library.</p><p>Using the above learning and some handy pre-existing samples, we wrote policies (Constraints) for GCP infrastructure, specifying a whitelist for locations in which GCS buckets could be deployed.</p><p>As mentioned there are <a href="https://github.com/forseti-security/policy-library/tree/master/samples" target="_blank" rel="noopener noreferrer">dozens upon dozens of samples</a> across BigQuery, IAM, networks, MySQL, Google Kubernetes Engine (GKE) and more to work with.</p><p>Of course, we stored these configured Constraints in our version-controlled Policy Library.</p><ul><li>We looked at a simple set of Terraform code to define a GCS bucket, and stored the Terraform plan to a file before applying it.</li><li>We ran Forseti‚Äôs Terraform Validator against the Terraform plan file, and had the Validator compare the plan to our Policy Library.</li><li>We saw that the results matched our expectations! Compliance with the location specified in our Constraint passed the Validator‚Äôs checks, and non-compliance triggered a violation.</li></ul><p>Awesome. And the best part is that all this required no special permissions, no infrastructure for servers or agents and no networking.</p><p>All of that comes with the full Forseti suite of Inventory taking Config Validation of already deployed resources. We might get to that next time.</p><p>References:</p><p><a href="https://github.com/GoogleCloudPlatform/terraform-validator" target="_blank" rel="noopener noreferrer">https://github.com/GoogleCloudPlatform/terraform-validator</a> <a href="https://github.com/forseti-security/policy-library" target="_blank" rel="noopener noreferrer">https://github.com/forseti-security/policy-library</a> <a href="https://www.openpolicyagent.org/docs/latest/policy-language/" target="_blank" rel="noopener noreferrer">https://www.openpolicyagent.org/docs/latest/policy-language/</a> <a href="https://cloud.google.com/blog/products/identity-security/using-forseti-config-validator-with-terraform-validator" target="_blank" rel="noopener noreferrer">https://cloud.google.com/blog/products/identity-security/using-forseti-config-validator-with-terraform-validator</a> <a href="https://forsetisecurity.org/docs/latest/concepts/" target="_blank" rel="noopener noreferrer">https://forsetisecurity.org/docs/latest/concepts/</a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/devops">devops</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/forseti">forseti</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/policyascode">policyascode</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Forseti Terraform Validator: Enforcing resource policy compliance in your CI pipeline" href="/forseti-terraform-validator-enforcing-resource-policy-compliance-in-your-ci-pipeline"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/creating-a-site-to-site-vpn-connection-between-gcp-and-azure-with-google-private-access">Creating a Site to Site VPN Connection Between GCP and Azure with Google Private Access</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-03-27T00:00:00.000Z" itemprop="datePublished">March 27, 2020</time> ¬∑ <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/azure_to_gcp_feature_image-1.png"><div class="markdown" itemprop="articleBody"><p>This article demonstrates creating a site to site IPSEC VPN connection between a GCP VPC network and an Azure Virtual Network, enabling private RFC1918 network connectivity between virtual networks in both clouds. This is done using a single PowerShell script leveraging Azure PowerShell and gcloud commands in the Google SDK.</p><p>Additionally, we will use Azure Private DNS to enable private access between Azure hosts and GCP APIs (such as Cloud Storage or Big Query).</p><p>An overview of the solution is provided here:</p><p><a target="_blank" href="/assets/files/gcp-to-azure-vpn-design-f59e466042c5e6fdf12abc497dde73bd.png"><img alt="Azure to GCP VPN Design" src="/assets/images/gcp-to-azure-vpn-design-f59e466042c5e6fdf12abc497dde73bd.png" width="3572" height="2407"></a></p><p>One note before starting - site to site VPN connections between GCP and Azure currently do not support dynamic routing using BGP, however creating some simple routes on either end of the connection will be enough to get going.</p><p>Let‚Äôs go through this step by step:</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-1--authenticate-to-azure">Step 1 : Authenticate to Azure<a class="hash-link" href="#step-1--authenticate-to-azure" title="Direct link to heading">‚Äã</a></h2><p>Azure‚Äôs account equivalent is a subscription, the following command from Azure Powershell is used to authenticate a user to one or more subscriptions.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Connect-AzAccount</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This command will open a browser window prompting you for Microsoft credentials, once authenticated you will be returned to the command line.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-2--create-a-resource-group-azure">Step 2 : Create a Resource Group (Azure)<a class="hash-link" href="#step-2--create-a-resource-group-azure" title="Direct link to heading">‚Äã</a></h2><p>A resource group is roughly equivalent to a project in GCP. You will need to supply a Location (equivalent to a GCP region):</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">New-AzResourceGroup `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-3--create-a-virtual-network-with-subnets-and-routes-azure">Step 3 : Create a Virtual Network with Subnets and Routes (Azure)<a class="hash-link" href="#step-3--create-a-virtual-network-with-subnets-and-routes-azure" title="Direct link to heading">‚Äã</a></h2><p>An Azure Virtual Network is the equivalent of a VPC network in GCP (or AWS), you must define subnets before creating a Virtual Network. In this example we will create two subnets, one Gateway subnet (which needs to be named accordingly) where the VPN gateway will reside, and one subnet named ‚Äòdefault‚Äô where we will host VMs which will connect to GCP services over the private VPN connection.</p><p>Before defining the default subnet we must create and attach a Route Table (equivalent of a Route in GCP), this particular route will be used to route ‚Äòprivate‚Äô requests to services in GCP (such as Big Query).</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># define route table and route to GCP private access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azroutecfg = New-AzRouteConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;google-private&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;199.36.153.4/30&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -NextHopType &quot;VirtualNetworkGateway&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azrttbl = New-AzRouteTable `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;google-private&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Route $azroutecfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># define gateway subnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$gatewaySubnet = New-AzVirtualNetworkSubnetConfig  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;GatewaySubnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.2.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># define default subnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$defaultSubnet  = New-AzVirtualNetworkSubnetConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;default&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.1.0/24&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RouteTable $azrttbl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create virtual network and subnets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$vnet = New-AzVirtualNetwork  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;azure-to-gcp-vnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.0.0/16&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Subnet $gatewaySubnet,$defaultSubnet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-4--create-network-security-groups-azure">Step 4 : Create Network Security Groups (Azure)<a class="hash-link" href="#step-4--create-network-security-groups-azure" title="Direct link to heading">‚Äã</a></h2><p>Network Security Groups in Azure are stateful firewalls much like Firewall Rules in VPC networks in GCP. Like GCP, the lower priority overrides higher priority rules.</p><p>In the example we will create several rules to allow inbound ICMP, TCP and UDP traffic from our Google VPC and RDP traffic from the Internet (which we will use to logon to a VM in Azure to test private connectivity between the two clouds):</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># create network security group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule1 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name rdp-rule `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow RDP&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Tcp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 100 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix Internet `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange 3389</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule2 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name icmp-rule `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow ICMP&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Icmp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 101 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule3 = New-AzNetworkSecurityRuleConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name gcp-rule `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow GCP&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Tcp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 102 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix &quot;10.2.0.0/16&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$nsg = New-AzNetworkSecurityGroup `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;nsg-vm&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SecurityRules $rule1,$rule2,$rule3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-5--create-public-ip-addresses-azure">Step 5 : Create Public IP Addresses (Azure)<a class="hash-link" href="#step-5--create-public-ip-addresses-azure" title="Direct link to heading">‚Äã</a></h2><p>We need to create two Public IP Address (equivalent of an External IP in GCP) which will be used for our VPN gateway and for the VM we will create:</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># create public IP address for VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$vmpip = New-AzPublicIpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vm-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AllocationMethod Dynamic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create public IP address for NW gateway </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ngwpip = New-AzPublicIpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AllocationMethod Dynamic</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-6--create-virtual-network-gateway-azure">Step 6 : Create Virtual Network Gateway (Azure)<a class="hash-link" href="#step-6--create-virtual-network-gateway-azure" title="Direct link to heading">‚Äã</a></h2><p>The Virtual Network Gateway in Azure is the VPN Gateway equivalent in Azure which will be used to create a VPN tunnel between Azure and a GCP VPN Gateway. This gateway will be placed in the Gateway subnet created previously and one of the Public IP addresses created in the previous step will be assigned to this gateway.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># create virtual network gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ngwipconfig = New-AzVirtualNetworkGatewayIpConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ipconfig&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SubnetId $gatewaySubnet.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublicIpAddressId $ngwpip.Id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use the AsJob switch as this is a long running process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$job = New-AzVirtualNetworkGateway -Name &quot;vnet-gateway&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IpConfigurations $ngwipconfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewayType &quot;Vpn&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VpnType &quot;RouteBased&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewaySku &quot;VpnGw1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VpnGatewayGeneration &quot;Generation1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AsJob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$vnetgw = Get-AzVirtualNetworkGateway `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vnet-gateway&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-7--create-a-vpc-network-and-subnetworks-gcp">Step 7 : Create a VPC Network and Subnetwork(s) (GCP)<a class="hash-link" href="#step-7--create-a-vpc-network-and-subnetworks-gcp" title="Direct link to heading">‚Äã</a></h2><p>A VPC network and subnet need to be created in GCP, the subnet defines the VPC address space. This address space must not overlap with the Azure Virtual Network CIDR. For all GCP steps it is assumed that the project is set for client config (e.g. gcloud config set project <strong>your_project</strong>) so it does not need to be specified for each operation. Private Google access should be enabled on all subnets created.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># creating VPC network and subnets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks create &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --subnet-mode=custom `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --bgp-routing-mode=regional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks subnets create &quot;aus-subnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network  &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --range &quot;10.2.1.0/24&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-private-ip-google-access</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-8--create-an-external-ip-gcp">Step 8 : Create an External IP (GCP)<a class="hash-link" href="#step-8--create-an-external-ip-gcp" title="Direct link to heading">‚Äã</a></h2><p>An external IP address will need to be created in GCP which will be used for the external facing interface of the VPN Gateway.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># create external IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute addresses create </span><span class="token string" style="color:#e3116c">&quot;ext-gw-ip&quot;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">  --region </span><span class="token variable string" style="color:#e3116c">&quot;australia-southeast1&quot;</span><span class="token variable" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="display:inline-block;color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">$gcp_ipaddr_obj </span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa"> gcloud compute addresses describe </span><span class="token variable string" style="color:#e3116c">&quot;ext-gw-ip&quot;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region </span><span class="token string" style="color:#e3116c">&quot;australia-southeast1&quot;</span><span class="token plain"> `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --format json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ConvertFrom-Json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$gcp_ipaddr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$gcp_ipaddr_obj</span><span class="token plain">.address</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-9--create-firewall-rules-gcp">Step 9 : Create Firewall Rules (GCP)<a class="hash-link" href="#step-9--create-firewall-rules-gcp" title="Direct link to heading">‚Äã</a></h2><p>VPC firewall rules will need to be created in GCP to allow VPN traffic as well as SSH traffic from the internet (which allows you to SSH into VM instances using Cloud Shell).</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># create VPN firewall rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules create &quot;vpn-rule1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --allow tcp,udp,icmp `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --source-ranges &quot;10.1.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules create &quot;ssh-rule1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --allow tcp:22</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-10--create-vpn-gateway-and-forwarding-rules-gcp">Step 10 : Create VPN Gateway and Forwarding Rules (GCP)<a class="hash-link" href="#step-10--create-vpn-gateway-and-forwarding-rules-gcp" title="Direct link to heading">‚Äã</a></h2><p>Create a VPN Gateway and Forwarding Rules in GCP which will be used to create a tunnel between GCP and Azure.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># create cloud VPN </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute target-vpn-gateways create &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create forwarding rule ESP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-esp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol ESP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># creating forwarding rule UDP500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-udp500&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol UDP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ports 500 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># creating forwarding rule UDP4500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-udp4500&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol UDP `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ports 4500 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-10--create-vpn-tunnel-gcp-side">Step 10 : Create VPN Tunnel (GCP Side)<a class="hash-link" href="#step-10--create-vpn-tunnel-gcp-side" title="Direct link to heading">‚Äã</a></h2><p>Now we will create the GCP side of our VPN tunnel using the Public IP Address of the Azure Virtual Network Gateway created in a previous step. As this example uses a route based VPN the traffic selector values need to be set at 0.0.0.0/0. A PSK (Pre Shared Key) needs to be supplied which will be the same key used when we configure a VPN Connection on the Azure side of the tunnel.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># get peer public IP address of Azure gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azpubip = Get-AzPublicIpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ip&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create VPN tunnel </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute vpn-tunnels create &quot;vpn-tunnel-to-azure&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-address $azpubip.IpAddress `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --local-traffic-selector &quot;0.0.0.0/0&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --remote-traffic-selector &quot;0.0.0.0/0&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ike-version 2 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --shared-secret &lt;&lt; Pre-Shared Key &gt;&gt; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region  &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-11--create-static-routes-gcp-side">Step 11 : Create Static Routes (GCP Side)<a class="hash-link" href="#step-11--create-static-routes-gcp-side" title="Direct link to heading">‚Äã</a></h2><p>As we are using static routing (as opposed to dynamic routing) we will need to define all of the specific routes on the GCP side. We will need to setup routes for both outgoing traffic to the Azure network as well as incoming traffic for the restricted Google API range (199.36.153.4/30).</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># create static route (VPN)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute routes create &quot;route-to-azure&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --destination-range &quot;10.1.0.0/16&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-vpn-tunnel &quot;vpn-tunnel-to-azure&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-vpn-tunnel-region &quot;australia-southeast1&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create static route (Restricted APIs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute routes create apis `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network  &quot;azure-to-gcp-vpc&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --destination-range &quot;199.36.153.4/30&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-gateway default-internet-gateway `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-12--create-a-local-gateway-azure">Step 12 : Create a Local Gateway (Azure)<a class="hash-link" href="#step-12--create-a-local-gateway-azure" title="Direct link to heading">‚Äã</a></h2><p>A Local Gateway in Azure is an object that represents the remote gateway (GCP VPN gateway).</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># create local gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azlocalgw = New-AzLocalNetworkGateway `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;local-gateway&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewayIpAddress $gcp_ipaddr `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.2.0.0/16&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-13--create-a-vpn-connection-azure">Step 13 : Create a VPN Connection (Azure)<a class="hash-link" href="#step-13--create-a-vpn-connection-azure" title="Direct link to heading">‚Äã</a></h2><p>Now we can setup the Azure side of the VPN Connection which is accomplished by associating the Azure Virtual Network Gateway with the Local Network Gateway. A PSK (Pre Shared Key) needs to be supplied which is the same key used for the GCP VPN Tunnel in step 10.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># create connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$azvpnconn = New-AzVirtualNetworkGatewayConnection `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vpn-connection&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VirtualNetworkGateway1 $vnetgw `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -LocalNetworkGateway2 $azlocalgw `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ConnectionType IPsec `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SharedKey  &lt;&lt; Pre-Shared Key &gt;&gt;  `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ConnectionProtocol &quot;IKEv2&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>VPN Tunnel Established!</p><p>At this stage we have created an end to end connection between the virtual networks in both clouds. You should see this reflected in the respective consoles in each provider.</p><figure><a href="/assets/images/gcp-vpn-to-azure-d627caa8febd797b530e1471bd5c9aff.png"><img src="/assets/images/gcp-vpn-to-azure-d627caa8febd797b530e1471bd5c9aff.png" alt="GCP VPN Tunnel to a Azure Virtual Network"></a><figcaption class="figure-caption">GCP VPN Tunnel to a Azure Virtual Network</figcaption></figure><figure><a href="/assets/images/azure-vpn-to-gcp-4716124e93f2cbc8a7e5ef5cd98d23df.png"><img src="/assets/images/azure-vpn-to-gcp-4716124e93f2cbc8a7e5ef5cd98d23df.png" alt="Azure VPN Connection to a GCP VPC Network"></a><figcaption class="figure-caption">Azure VPN Connection to a GCP VPC Network</figcaption></figure><p>Congratulations! You have just setup a multi cloud environment using private networking. Now let‚Äôs setup Google Private Access for Azure hosts and create VMs on each side to test our setup.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-14--create-a-private-dns-zone-for-googleapiscom-azure">Step 14 : Create a Private DNS Zone for googleapis.com (Azure)<a class="hash-link" href="#step-14--create-a-private-dns-zone-for-googleapiscom-azure" title="Direct link to heading">‚Äã</a></h2><p>We will now need to create a Private DNS zone in Azure for the googleapis.com domain which will host records to redirect Google API requests to the Restricted API range.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># create private DNS zone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsZone `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;googleapis.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add A Records   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records = @()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsRecordSet `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;restricted&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RecordType A `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -TTL 300 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PrivateDnsRecords $Records</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add CNAME Records   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records = @()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Cname &quot;restricted.googleapis.com.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsRecordSet `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;*&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RecordType CNAME `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -TTL 300 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PrivateDnsRecords $Records</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Create VNet Link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsVirtualNetworkLink `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;dns-zone-link&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VirtualNetworkId $vnet.Id</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-15--create-a-virtual-machine-azure">Step 15 : Create a Virtual Machine (Azure)<a class="hash-link" href="#step-15--create-a-virtual-machine-azure" title="Direct link to heading">‚Äã</a></h2><p>We will create a VM in Azure which we can use to test the VPN tunnel as well as to test Private Google Access over our VPN tunnel.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># create VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$az_vmlocaladminpwd = ConvertTo-SecureString &lt;&lt; Password Param &gt;&gt; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AsPlainText -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Credential = New-Object System.Management.Automation.PSCredential  (&quot;LocalAdminUser&quot;, $az_vmlocaladminpwd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$nic = New-AzNetworkInterface `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vm-nic&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SubnetId $defaultSubnet.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -NetworkSecurityGroupId $nsg.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublicIpAddressId $vmpip.Id `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -EnableAcceleratedNetworking `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = New-AzVMConfig `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VMName &quot;windows-desktop&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VMSize &quot;Standard_D4_v3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Set-AzVMOperatingSystem `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Windows `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ComputerName  &quot;windows-desktop&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Credential $Credential `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ProvisionVMAgent `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -EnableAutoUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Add-AzVMNetworkInterface `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Id $nic.Id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Set-AzVMSourceImage `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublisherName &#x27;MicrosoftWindowsDesktop&#x27; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Offer &#x27;Windows-10&#x27; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Skus &#x27;rs5-pro&#x27; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Version latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzVM `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Verbose</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-16--create-a-vm-instance-gcp">Step 16 : Create a VM Instance (GCP)<a class="hash-link" href="#step-16--create-a-vm-instance-gcp" title="Direct link to heading">‚Äã</a></h2><p>We will create a Linux VM in GCP to test connectivity to hosts in Azure using the VPN tunnel we have established.</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># create VM instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute instances create &quot;gcp-instance&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --zone &quot;australia-southeast1-b&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --machine-type &quot;f1-micro&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --subnet &quot;aus-subnet&quot; `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network-tier PREMIUM `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --maintenance-policy MIGRATE `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --image=debian-9-stretch-v20200309 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --image-project=debian-cloud `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-size 10GB `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-type pd-standard `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-device-name instance-1 `</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --reservation-affinity any</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="test-connectivity">Test Connectivity<a class="hash-link" href="#test-connectivity" title="Direct link to heading">‚Äã</a></h2><p>Now we are ready to test connectivity from both sides of the tunnel.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="azure-to-gcp">Azure to GCP<a class="hash-link" href="#azure-to-gcp" title="Direct link to heading">‚Äã</a></h3><p>Establish a remote desktop (RDP) connection to the Azure VM created in Step 15. Ping the GCP VM instance using its private IP address.</p><p><a target="_blank" href="/assets/files/azure-ping-to-gcp-14a9b0e446b7c868ffa27ba3435460be.png"><img alt="Test Private IP Connectivity from Azure to GCP" src="/assets/images/azure-ping-to-gcp-14a9b0e446b7c868ffa27ba3435460be.png" width="1635" height="967"></a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="gcp-to-azure">GCP to Azure<a class="hash-link" href="#gcp-to-azure" title="Direct link to heading">‚Äã</a></h3><p>Now SSH into the GCP Linux VM instance and ping the Azure host using its private IP address.</p><p><a target="_blank" href="/assets/files/gcp-ping-to-azure-94b9a33840b54870af540853cda825e9.png"><img alt="Test Private IP Connectivity from GCP to Azure" src="/assets/images/gcp-ping-to-azure-94b9a33840b54870af540853cda825e9.png" width="902" height="710"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="test-private-google-access-from-azure">Test Private Google Access from Azure<a class="hash-link" href="#test-private-google-access-from-azure" title="Direct link to heading">‚Äã</a></h2><p>Now that we have established bi-directional connectivity between the two clouds, we can test private access to Google APIs from our Azure host. Follow the steps below to test private access:</p><ol><li>RDP into the Azure VM</li><li>Install the Google Cloud SDK ( <a href="https://cloud.google.com/sdk/" target="_blank" rel="noopener noreferrer">https://cloud.google.com/sdk/</a>)</li><li>Perform an <code>nslookup</code> to ensure that calls to googleapis.com resolve to the restricted API range (e.g. <code>nslookup storage.googleapis.com</code>). You should see a response showing the A records from the googleapis.com Private DNS Zone created in step 14.</li><li>Now test connectivity to Google APIs, for example to test access to Google Cloud Storage using <code>gsutil</code>, or test access to Big Query using the <code>bq</code> command</li></ol><p>Congratulations! You are now a multi cloud ninja!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/azure">azure</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/hybrid-cloud">hybrid-cloud</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/microsoft">microsoft</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/microsoft-azure">microsoft-azure</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/multi-cloud">multi-cloud</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/private-networking">private-networking</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/vpn">vpn</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Creating a Site to Site VPN Connection Between GCP and Azure with Google Private Access" href="/creating-a-site-to-site-vpn-connection-between-gcp-and-azure-with-google-private-access"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/spark-in-the-google-cloud-platform-part-2">Spark in the Google Cloud Platform Part 2</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-02-29T00:00:00.000Z" itemprop="datePublished">February 29, 2020</time> ¬∑ <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/spark-gcp-featured-image.png"><div class="markdown" itemprop="articleBody"><p>In the previous post in this series <a href="https://cloudywithachanceofbigdata.com/spark-in-the-google-cloud-platform-part-1/" target="_blank" rel="noopener noreferrer"><strong>Spark in the Google Cloud Platform Part 1</strong></a>, we started to explore the various ways in which we could deploy Apache Spark applications in GCP. The first option we looked at was deploying Spark using Cloud DataProc, a managed Hadoop cluster with various ecosystem components included.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Spark Training Courses</h5></div><div class="admonition-content"><p><a href="https://academy.alphazetta.ai/data-transformation-and-analysis-using-apache-spark/" target="_blank" rel="noopener noreferrer">Data Transformation and Analysis Using Apache Spark</a><br>
<a href="https://academy.alphazetta.ai/stream-and-event-processing-using-apache-spark/" target="_blank" rel="noopener noreferrer">Stream and Event Processing using Apache Spark</a><br>
<a href="https://academy.alphazetta.ai/advanced-analytics-using-apache-spark/" target="_blank" rel="noopener noreferrer">Advanced Analytics Using Apache Spark</a></p></div></div><p>In this post, we will look at another option for deploying Spark in GCP ‚Äì <em>a Spark Standalone cluster running on GKE</em>.</p><p>Spark Standalone refers to the in-built cluster manager provided with each Spark release. Standalone can be a bit of a misnomer as it sounds like a single instance ‚Äì which it is not, standalone simply refers to the fact that it is not dependent upon any other projects or components ‚Äì such as Apache YARN, Mesos, etc.</p><p>A Spark Standalone cluster consists of a Master node or instance and one of more Worker nodes. The Master node serves as both a master and a cluster manager in the Spark runtime architecture.</p><p>The Master process is responsible for marshalling resource requests on behalf of applications and monitoring cluster resources.</p><p>The Worker nodes host one or many Executor instances which are responsible for carrying out tasks.</p><p>Deploying a Spark Standalone cluster on GKE is reasonably straightforward. In the example provided in this post we will set up a private network (VPC), create a GKE cluster, and deploy a Spark Master pod and two Spark Worker pods (in a real scenario you would typically have many Worker pods).</p><p>Once the network and GKE cluster have been deployed, the first step is to create Docker images for both the Master and Workers.</p><p>The <code>Dockerfile</code> below can be used to create an image capable or running either the Worker or Master daemons:</p><iframe width="100%" frameborder="0" id="gist-a2828409021205b3f6587c824c59928d"></iframe><p>Note the shell scripts included in the <code>Dockerfile</code>: <code>spark-master</code> and <code>spark-worker</code>. These will be used later on by K8S deployments to start the relative Master and Worker daemon processes in each of the pods.</p><p>Next, we will use Cloud Build to build an image using the <code>Dockerfile</code> are store this in GCR (Google Container Registry), from the Cloud Build directory in our project we will run:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud builds submit --tag gcr.io/spark-demo-266309/spark-standalone</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Next, we will create Kubernetes deployments for our Master and Worker pods.</p><p>Firstly, we need to get cluster credentials for our GKE cluster named ‚Äòspark-cluster‚Äô:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud container clusters get-credentials spark-cluster --zone australia-southeast1-a --project spark-demo-266309</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now from within the <code>k8s-deployments\deploy</code> folder of our project we will use the <code>kubectl</code> command to deploy the Master pod, service and the Worker pods</p><p>Starting with the Master deployment, this will deploy our Spark Standalone image into a container running the Master daemon process:</p><iframe width="100%" frameborder="0" id="gist-31bca11627167e0cd963103e4c7f11d2"></iframe><p>To deploy the Master, run the following:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f spark-master-deployment.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The Master will expose a web UI on port 8080 and an RPC service on port 7077, we will need to deploy a K8S service for this, the YAML required to do this is shown here:</p><iframe width="100%" frameborder="0" id="gist-a72d3c38d7a3f94e88c7affd28a3034b"></iframe><p>To deploy the Master service, run the following:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f spark-master-service.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now that we have a Master pod and service up and running, we need to deploy our Workers which are preconfigured to communicate with the Master service.</p><p>The YAML required to deploy the two Worker pods is shown here:</p><iframe width="100%" frameborder="0" id="gist-97ceb93ed35959c41d80fb8c025a7ba1"></iframe><p>To deploy the Worker pods, run the following:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f spark-worker-deployment.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can now inspect the Spark processes running on your GKE cluster.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get deployments</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Shows...</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spark-master   1/1     1            1           7m45s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spark-worker   2/2     2            2           9s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Shows...</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                            READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spark-master-f69d7d9bc-7jgmj    1/1     Running   0          8m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spark-worker-55965f669c-rm59p   1/1     Running   0          24s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> spark-worker-55965f669c-wsb2f   1/1     Running   0          24s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Next, as we need to expose the Web UI for the Master process we will create a <em>LoadBalancer</em> resource. The YAML used to do this is provided here:</p><iframe width="100%" frameborder="0" id="gist-56ee86f50f329f99679ff243bb00fb07"></iframe><p>To deploy the LB, you would run the following:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create -f spark-ui-lb.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>NOTE</strong> This is just an example, for simplicity we are creating an external <em>LoadBalancer</em> with a public IP, this configuration is likely not be appropriate in most real scenarios, alternatives would include an internal <em>LoadBalancer</em>, retraction of Authorized Networks, a jump host, SSH tunnelling or IAP.</p><p>Now you‚Äôre up and running!</p><p>You can access the Master web UI from the Google Console link shown here:</p><p><a target="_blank" href="/assets/files/master-ui-link-c9d78a7032459c01291494b1c26e34ff.png"><img alt="Accessing the Spark Master UI from the Google Cloud Console" src="/assets/images/master-ui-link-c9d78a7032459c01291494b1c26e34ff.png" width="1070" height="611"></a></p><p>The Spark Master UI should look like this:</p><p><a target="_blank" href="/assets/files/spark-master-ui-fa6eecc91847995dea15601166516004.png"><img alt="Spark Master UI" src="/assets/images/spark-master-ui-fa6eecc91847995dea15601166516004.png" width="1070" height="668"></a></p><p>Next we will exec into a Worker pod, get a shell:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec -it spark-worker-55965f669c-rm59p -- sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now from within the shell environment of a Worker ‚Äì which includes all of the Spark client libraries, we will submit a simple Spark application:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spark-submit --class org.apache.spark.examples.SparkPi \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> --master spark://10.11.250.98:7077 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/spark/examples/jars/spark-examples*.jar 10000</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can see the results in the shell, as shown here:</p><p><a target="_blank" href="/assets/files/spark-application-example-0f11e071394077ac8c678ed7d3e93791.png"><img alt="Spark Pi Estimator Example" src="/assets/images/spark-application-example-0f11e071394077ac8c678ed7d3e93791.png" width="1022" height="932"></a></p><p>Additionally, as all of the container logs go to Stackdriver, you can view the application logs there as well:</p><p><a target="_blank" href="/assets/files/container-logs-in-stackdriver-350797a4dd5cceab0b4aa12445adeed4.png"><img alt="Container Logs in StackDriver" src="/assets/images/container-logs-in-stackdriver-350797a4dd5cceab0b4aa12445adeed4.png" width="1070" height="668"></a></p><p>This is a simple way to get a Spark cluster running, it is not without its downsides and shortcomings however, which include the limited security mechanisms available (SASL, network security, shared secrets).</p><p>In the final post in this series we will look at Spark on Kubernetes, using Kubernetes as the Spark cluster manager and interacting with Spark using the Kubernetes API and control plane, see you then.</p><blockquote><p>Full source code for this article is available at: <a href="https://github.com/gamma-data/spark-on-gcp" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/spark-on-gcp</a></p></blockquote><p>The infrastructure coding for this example uses Powershell and Terraform, and is deployed as follows:</p><div class="codeBlockContainer_I0IT language-powershell theme-code-block"><div class="codeBlockContent_wNvx powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">PS &gt; .\run.ps1 private-network apply &lt;gcp-project&gt; &lt;region&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS &gt; .\run.ps1 gke apply &lt;gcp-project&gt; &lt;region&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/apache-spark">apache-spark</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloud-dataproc">cloud-dataproc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/dataproc">dataproc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gke">gke</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/kubernetes">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/spark">spark</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Spark in the Google Cloud Platform Part 2" href="/spark-in-the-google-cloud-platform-part-2"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/spark-in-the-google-cloud-platform-part-1">Spark in the Google Cloud Platform Part 1</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-02-14T00:00:00.000Z" itemprop="datePublished">February 14, 2020</time> ¬∑ <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/spark-gcp-featured-image.png"><div class="markdown" itemprop="articleBody"><p>I have been an avid Spark enthusiast since 2014 (the early days..). Spark has featured heavily in every project I have been involved with from data warehousing, ETL, feature extraction, advanced analytics to event processing and IoT applications. I like to think of it as a Swiss army knife for distributed processing.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Spark Training Courses</h5></div><div class="admonition-content"><p><a href="https://academy.alphazetta.ai/data-transformation-and-analysis-using-apache-spark/" target="_blank" rel="noopener noreferrer">Data Transformation and Analysis Using Apache Spark</a><br>
<a href="https://academy.alphazetta.ai/stream-and-event-processing-using-apache-spark/" target="_blank" rel="noopener noreferrer">Stream and Event Processing using Apache Spark</a><br>
<a href="https://academy.alphazetta.ai/advanced-analytics-using-apache-spark/" target="_blank" rel="noopener noreferrer">Advanced Analytics Using Apache Spark</a></p></div></div><p>Curiously enough, the first project I had been involved with for some years that did not feature the Apache Spark project was a green field GCP project which got me thinking‚Ä¶ where does Spark fit into the GCP landscape?</p><p>Unlike the other major providers who use Spark as the backbone of their managed distributed ETL services with examples such as AWS Glue or the Spark integration runtime option in Azure Data Factory, Google‚Äôs managed ETL solution is Cloud DataFlow. Cloud DataFlow which is a managed Apache Beam service does not use a Spark runtime (there is a Spark Runner however this is not an option when using CDF). So where does this leave Spark?</p><p>My summation is that although Spark is not a first-class citizen in GCP (as far as managed ETL), it is not a second-class citizen either. This article will discuss the various ways Spark clusters and applications can be deployed within the GCP ecosystem.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="quick-primer-on-spark">Quick Primer on Spark<a class="hash-link" href="#quick-primer-on-spark" title="Direct link to heading">‚Äã</a></h2><p>Every Spark application contains several components regardless of deployment mode, the components in the Spark runtime architecture are:</p><ul><li>the Driver</li><li>the Master</li><li>the Cluster Manager</li><li>the Executor(s), which run on worker nodes or Workers</li></ul><p>Each component has a specific role in executing a Spark program and all of the Spark components run in Java virtual machines (JVMs).</p><p><a target="_blank" href="/assets/files/spark-runtime-0b55b3d8793bab097b517603866abe16.png"><img alt="Spark Runtime Architecture" src="/assets/images/spark-runtime-0b55b3d8793bab097b517603866abe16.png" width="752" height="420"></a></p><p>Cluster Managers schedule and manage distributed resources (compute and memory) across the nodes of the cluster. Cluster Managers available for Spark include:</p><ul><li>Standalone</li><li>YARN (Hadoop)</li><li>Mesos</li><li>Kubernetes</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="spark-on-dataproc">Spark on DataProc<a class="hash-link" href="#spark-on-dataproc" title="Direct link to heading">‚Äã</a></h2><p>This is perhaps the simplest and most integrated approach to using Spark in the GCP ecosystem.</p><p>DataProc is GCP‚Äôs managed Hadoop Service (akin to AWS EMR or HDInsight on Azure). DataProc uses Hadoop/YARN as the Cluster Manager. DataProc clusters can be deployed on a private network (VPC using RFC1918 address space), supports encryption at Rest using Google Managed or Customer Managed Keys in KMS, supports autoscaling and the use of Preemptible Workers, and can be deployed in a HA config.</p><p>Furthermore, DataProc clusters can enforce strong authentication using Kerberos which can be integrated into other directory services such as Active Directory through the use of cross realm trusts.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deployment">Deployment<a class="hash-link" href="#deployment" title="Direct link to heading">‚Äã</a></h3><p>DataProc clusters can be deployed using the <code>gcloud dataproc clusters create</code> command or using IaC solutions such as Terraform. For this article I have included an example in the source code using the <code>gcloud</code> command to deploy a DataProc cluster on a private network which was created using Terraform.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="integration">Integration<a class="hash-link" href="#integration" title="Direct link to heading">‚Äã</a></h3><p>The beauty of DataProc is its native integration into IAM and the GCP service plane. Having been a long-time user of AWS EMR, I have found that the usability and integration are in many ways superior in GCP DataProc. Let‚Äôs look at some examples...</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="iam-and-iap-tcp-forwarding">IAM and IAP (TCP Forwarding)<a class="hash-link" href="#iam-and-iap-tcp-forwarding" title="Direct link to heading">‚Äã</a></h4><p>DataProc is integrated into Cloud IAM using various coarse grained permissions use as <code>dataproc.clusters.use</code> and simplified IAM Roles such as <code>dataproc.editor</code> or <code>dataproc.admin</code>. Members with bindings to the these roles can perform tasks such as submitting jobs and creating workflow templates (which we will discuss shortly), as well as accessing instances such as the master node instance or instances in the cluster using IAP (TCP Forwarding) without requiring a public IP address or a bastion host.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="dataproc-jobs-and-workflows">DataProc Jobs and Workflows<a class="hash-link" href="#dataproc-jobs-and-workflows" title="Direct link to heading">‚Äã</a></h4><p>Spark jobs can be submitted using the console or via <code>gcloud dataproc jobs submit</code> as shown here:</p><p><a target="_blank" href="/assets/files/dataproc-spark-job-953a699ceef00b9e3b0f05068a844a56.png"><img alt="Submitting a Spark Job using gcloud dataproc jobs submit" src="/assets/images/dataproc-spark-job-953a699ceef00b9e3b0f05068a844a56.png" width="1097" height="499"></a></p><p>Cluster logs are natively available in StackDriver and standard out from the Spark Driver is visible from the console as well as via <code>gcloud</code> commands.</p><p>Complex Workflows can be created by adding Jobs as Steps in Workflow Templates using the following command:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud dataproc workflow-templates add-job spark</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="optional-components-and-the-component-gateway">Optional Components and the Component Gateway<a class="hash-link" href="#optional-components-and-the-component-gateway" title="Direct link to heading">‚Äã</a></h4><p>DataProc provides you with a Hadoop cluster including YARN and HDFS, a Spark runtine ‚Äì which includes Spark SQL and SparkR. DataProc also supports several optional components including Anaconda, Jupyter, Zeppelin, Druid, Presto, and more.</p><p>Web interfaces to some of these components as well as the management interfaces such as the Resource Manager UI or the Spark History Server UI can be accessed through the Component Gateway.</p><p>This is a Cloud IAM integrated gateway (much like IAP) which can allow access through an authenticated and authorized console session to web UIs in the cluster ‚Äì without the need for SSH tunnels, additional firewall rules, bastion hosts, or public IPs. Very cool.</p><p>Links to the component UIs as well as built in UIs like the YARN Resource Manager UI are available directly from through the console.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="jupyter">Jupyter<a class="hash-link" href="#jupyter" title="Direct link to heading">‚Äã</a></h4><p>Jupyter is a popular notebook application in the data science and analytics communities used for reproducible research. DataProc‚Äôs Jupyter component provides a ready-made Spark application vector using PySpark. If you have also installed the Anaconda component you will have access to the full complement of scientific and mathematic Python packages such as Pandas and NumPy which can be used in Jupyter notebooks as well. Using the Component Gateway, Jupyer notebooks can be accessed directly from the Google console as shown here:</p><p><a target="_blank" href="/assets/files/dataproc-jupyter-notebook-14d165b5563c903961beb68bef757a82.png"><img alt="Jupyter Notebooks using DataProc" src="/assets/images/dataproc-jupyter-notebook-14d165b5563c903961beb68bef757a82.png" width="1359" height="924"></a></p><p>From this example you can see that I accessed source data from a GCS bucket and used HDFS as local scratch space.</p><p>Furthermore, notebooks are automagically saved in your integrated Cloud Storage DataProc staging bucket and can be shared amongst analysts or accessed at a later time. These notebooks also persist beyond the lifespan of the cluster.</p><p>Next up we will look at deploying a Spark Standalone cluster on a GKE cluster, see you then!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/apache-spark">apache-spark</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/spark">spark</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Spark in the Google Cloud Platform Part 1" href="/spark-in-the-google-cloud-platform-part-1"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/query-cloud-sql-through-big-query">Query Cloud SQL through Big Query</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-02-08T00:00:00.000Z" itemprop="datePublished">February 8, 2020</time> ¬∑ <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cloud-sql-federated-queries.png"><div class="markdown" itemprop="articleBody"><p>This article demonstrates Cloud SQL federated queries for Big Query, a neat and simple to use feature.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="connecting-to-cloud-sql">Connecting to Cloud SQL<a class="hash-link" href="#connecting-to-cloud-sql" title="Direct link to heading">‚Äã</a></h2><p>One of the challenges presented when using Cloud SQL on a private network (VPC) is providing access to users. There are several ways to accomplish this which include:</p><ul><li>open the database port on the VPC Firewall (5432 for example for Postgres) and let users access the database using a command line or locally installed GUI tool <em>(may not be allowed in your environment)</em></li><li>provide a web based interface deployed on your VPC such as PGAdmin deployed on a GCE instance or GKE pod <em>(adds security and management overhead)</em></li><li>use the Cloud SQL proxy <em>(requires additional software to be installed and configured)</em></li></ul><p>In additional, all of the above solutions require direct IP connectivity to the instance which may not always be available. Furthermore each of these operations requires the user to present some form of authentication ‚Äì in many cases the database user and password which then must be managed at an individual level.</p><p>Enter Cloud SQL federated queries for Big Query‚Ä¶</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="big-query-federated-queries-for-cloud-sql">Big Query Federated Queries for Cloud SQL<a class="hash-link" href="#big-query-federated-queries-for-cloud-sql" title="Direct link to heading">‚Äã</a></h2><p>Big Query allows you to query tables and views in Cloud SQL (currently MySQL and Postgres) using the Federated Queries feature. The queries could be authorized views in Big Query datasets for example.</p><p>This has the following advantages:</p><ul><li>Allows users to authenticate and use the GCP console to query Cloud SQL</li><li>Does not require direct IP connectivity to the user or additional routes or firewall rules</li><li>Leverages Cloud IAM as the authorization mechanism ‚Äì rather that unmanaged db user accounts and object level permissions</li><li>External queries can be executed against a read replica of the Cloud SQL instance to offload query IO from the master instance</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="setting-it-up">Setting it up<a class="hash-link" href="#setting-it-up" title="Direct link to heading">‚Äã</a></h2><p>Setting up big query federated queries for Cloud SQL is exceptionally straightforward, a summary of the steps are provided below:</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-1-enable-a-public-ip-on-the-cloud-sql-instance">Step 1. Enable a Public IP on the Cloud SQL instance<a class="hash-link" href="#step-1-enable-a-public-ip-on-the-cloud-sql-instance" title="Direct link to heading">‚Äã</a></h3><p>This sounds bad, but it isn‚Äôt really that bad. You need to enable a public interface for Big Query to be able to establish a connection to Cloud SQL, however this is not accessed through the actual public internet ‚Äì rather it is accessed through the Google network using the back end of the front end if you will.</p><p>Furthermore, you configure an empty list of authorized networks which effectively shields the instance from the public network, this can be configured in Terraform as shown here:</p><iframe width="100%" frameborder="0" id="gist-81c57a80a7e588b98ea7d294dbaee242"></iframe><p>This configuration change can be made to a running instance as well as during the initial provisioning of the instance.</p><p>As shown below you will get a warning dialog in the console saying that you have no authorized networks - this is by design.</p><p><a target="_blank" href="/assets/files/cloud-sql-publicip-screenshot-53f21feadbfaf3be93f69de3ce771c2f.png"><img alt="Cloud SQL Public IP Enabled with No Authorized Networks" src="/assets/images/cloud-sql-publicip-screenshot-53f21feadbfaf3be93f69de3ce771c2f.png" width="1139" height="775"></a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-2-create-a-big-query-dataset-which-will-be-used-to-execute-the-queries-to-cloud-sql">Step 2. Create a Big Query dataset which will be used to execute the queries to Cloud SQL<a class="hash-link" href="#step-2-create-a-big-query-dataset-which-will-be-used-to-execute-the-queries-to-cloud-sql" title="Direct link to heading">‚Äã</a></h3><p>Connections to Cloud SQL are defined in a Big Query dataset, this can also be use to control access to Cloud SQL using authorized views controlled by IAM roles.</p><iframe width="100%" frameborder="0" id="gist-8a4beaab134a1c72613347b5822d1724"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-3-create-a-connection-to-cloud-sql">Step 3. Create a connection to Cloud SQL<a class="hash-link" href="#step-3-create-a-connection-to-cloud-sql" title="Direct link to heading">‚Äã</a></h3><p>To create a connection to Cloud SQL from Big Query you must first enable the BigQuery Connection API, this is done at a project level.</p><p>As this is a fairly recent feature there isn&#x27;t great coverage with either the <strong><code>bq</code></strong> tool or any of the Big Query client libraries to do this so we will need to use the console for now...</p><p>Under the <em><strong>Resources</strong></em> -&gt; <strong><em>Add Data</em></strong> link in the left hand panel of the Big Query console UI, select <strong><em>Create Connection</em></strong>. You will see a side info panel with a form to enter connection details for your Cloud SQL instance.</p><p>In this example I will setup a connection to a Cloud SQL read replica instance I have created:</p><p><a target="_blank" href="/assets/files/big-query-add-connection-67a0236996204c84c7608a8e6b8f4875.png"><img src="/assets/images/big-query-add-connection-67a0236996204c84c7608a8e6b8f4875.png" width="959" height="775"></a></p><p>Creating a Big Query Connection to Cloud SQL</p><p>More information on the Big Query Connections API can be found at: <a href="https://cloud.google.com/bigquery/docs/reference/bigqueryconnection/rest" target="_blank" rel="noopener noreferrer">https://cloud.google.com/bigquery/docs/reference/bigqueryconnection/rest</a></p><p>The following permissions are associated with connections in Big Query:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.create  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.get  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.list  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.use  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.update  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bigquery.connections.delete</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>These permissions are conveniently combined into the following predefined roles:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">roles/bigquery.connectionAdmin    (BigQuery Connection Admin)         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roles/bigquery.connectionUser     (BigQuery Connection User)          </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="step-4-query-away">Step 4. Query away!<a class="hash-link" href="#step-4-query-away" title="Direct link to heading">‚Äã</a></h3><p>Now the connection to Cloud SQL can be accessed using the <strong><code>EXTERNAL_QUERY</code></strong> function in Big Query, as shown here:</p><p><a target="_blank" href="/assets/files/cloud-sql-federated-queries-screenshot-34e49ac369753d8551095e92b7fc6264.png"><img alt="Querying Cloud SQL from Big Query" src="/assets/images/cloud-sql-federated-queries-screenshot-34e49ac369753d8551095e92b7fc6264.png" width="1373" height="730"></a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/big-query">big-query</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/bigquery">bigquery</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloudsql">cloudsql</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Query Cloud SQL through Big Query" href="/query-cloud-sql-through-big-query"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/google-cloud-sql-availability-for-postgresql-read-replicas">Google Cloud SQL ‚Äì Availability for PostgreSQL ‚Äì Part II (Read Replicas)</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-24T00:00:00.000Z" itemprop="datePublished">January 24, 2020</time> ¬∑ <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cloudsql-featured-image.png"><div class="markdown" itemprop="articleBody"><p>In this post we will look at read replicas as an additional method to achieve multi zone availability for Cloud SQL, which gives us - in turn - the ability to offload (potentially expensive) IO operations such as user created backups or read operations without adding load to the master instance.</p><p>In the previous post in this series we looked at Regional availability for PostgreSQL HA using Cloud SQL:</p><p><a href="https://cloudywithachanceofbigdata.com/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql-part-i/" target="_blank" rel="noopener noreferrer"><strong>Google Cloud SQL ‚Äì Availability, Replication, Failover for PostgreSQL ‚Äì Part I</strong></a></p><p>Recall that this option was simple to implement and worked relatively seamlessly and transparently with respect to zonal failover.</p><p>Now let&#x27;s look at read replicas in Cloud SQL as an additional measure for availability.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="deploying-read-replicas">Deploying Read Replica(s)<a class="hash-link" href="#deploying-read-replicas" title="Direct link to heading">‚Äã</a></h2><p>Deploying read replicas is slightly more involved than simple regional (high) availability, as you will need to define each replica or replicas as a separate Cloud SQL instance which is a slave to the primary instance (the master instance).</p><p>An example using Terraform is provided here, starting by creating the master instance:</p><iframe width="100%" frameborder="0" id="gist-34371a3c7edab140e70208cd7710c25a"></iframe><p>Next you would specify one or more read replicas (typically in a zone other than the zone the master is in):</p><iframe width="100%" frameborder="0" id="gist-980f2d6461db0613b4090413041b5ec5"></iframe><p>Note that several of the options supplied are omitted when creating a read replica database instance, such as the backup and maintenance options - as these operations cannot be performed on a read replica as we will see later.</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-1-212da608bf5ba2aa73198627a0cfe3e1.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-1-212da608bf5ba2aa73198627a0cfe3e1.png" alt="Cloud SQL Instances - showing master and replica"></a><figcaption class="figure-caption">Cloud SQL Instances - showing master and replica</figcaption></figure><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-2-ec13f6b5f93493f369db3f4c11987507.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-2-ec13f6b5f93493f369db3f4c11987507.png" alt="Cloud SQL Master Instance"></a><figcaption class="figure-caption">Cloud SQL Master Instance</figcaption></figure><p>Voila! You have just set up a master instance (the primary instance your application and/or users will connect to) along with a read replica in a different zone which will be asynchronously updated as changes occur on the master instance.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="read-replicas-in-action">Read Replicas in Action<a class="hash-link" href="#read-replicas-in-action" title="Direct link to heading">‚Äã</a></h2><p>Now that we have created a read replica, lets see it in action. After connecting to the read replica (like you would any other instance), attempt to access a table that has <strong><em>not</em></strong> been created on the master as shown here:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-3-8d16fdd58297948424c733b59cb58ff5.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-3-8d16fdd58297948424c733b59cb58ff5.png" alt="SELECT operation from the replica instance"></a><figcaption class="figure-caption">SELECT operation from the replica instance</figcaption></figure><p>Now create the table and insert some data on the <strong><em>master</em></strong> instance:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-4-c207e904d4880b5f799bcfdabf7de36a.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-4-c207e904d4880b5f799bcfdabf7de36a.png" alt="Create a table and insert a record on the master instance"></a><figcaption class="figure-caption">Create a table and insert a record on the master instance</figcaption></figure><p>Now try the select operation on the <strong><em>replica</em></strong> instance:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-5-a9412ef5afba9855221998e5551cb19e.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-5-a9412ef5afba9855221998e5551cb19e.png" alt="SELECT operation from the replica instance (after changes have been made on the master)"></a><figcaption class="figure-caption">SELECT operation from the replica instance (after changes have been made on the master)</figcaption></figure><p>It works!</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="some-points-to-note-about-cloud-sql-read-replicas">Some Points to Note about Cloud SQL Read Replicas<a class="hash-link" href="#some-points-to-note-about-cloud-sql-read-replicas" title="Direct link to heading">‚Äã</a></h2><ul><li>Users connect to a read replica as a normal database connection (as shown above)</li><li>Google managed backups (using the console or <code>gcloud sql backups create ..</code> ) can <strong><em>NOT</em></strong> be performed against replica instances</li><li>Read replicas can be used to offload IO intensive operations from the the master instance - such as user managed backup operations (e.g. <code>pg_dump</code>)</li></ul><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-6-c367a62c5d3e480fa25ea4d0ea2669cf.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-6-c367a62c5d3e480fa25ea4d0ea2669cf.png" alt="pg_dump operation against a replica instance"></a><figcaption class="figure-caption">pg_dump operation against a replica instance</figcaption></figure><ul><li><strong>BE CAREFUL</strong> Despite their name, read replicas are <strong>NOT</strong> read only, updates can be made which will NOT propagate back to the master instance - you could get yourself in an awful mess if you allow users to perform <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>CREATE</code> or <code>DROP</code> operations against replica instances.</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="promoting-a-read-replica">Promoting a Read Replica<a class="hash-link" href="#promoting-a-read-replica" title="Direct link to heading">‚Äã</a></h2><p>If required a read replica can be promoted to a standalone Cloud SQL instance, which is another DR option. Keep in mind however as the read replica is updated in an asynchronous manner, promotion of a read replica may result in a loss of data (hopefully not much but a loss nonetheless). Your application RPO will dictate if this is acceptable or not.</p><p>Promotion of a read replica is reasonably straightforward as demonstrated here using the console:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-7-a4ec8a31ed6601a9e7253ce408893a90.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-7-a4ec8a31ed6601a9e7253ce408893a90.png" alt="Promoting a read replica using the console"></a><figcaption class="figure-caption">Promoting a read replica using the console</figcaption></figure><p>You can also use the following <code>gcloud</code> command:</p><p> gcloud sql instances promote-replica  &lt;replica<!-- -->_<!-- -->instance<!-- -->_<!-- -->name&gt;</p><p>Once you click on the <em>Promote Replica</em> button you will see the following warning:</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-8-310006339cb5a3d3c491dfb00fc86c88.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-8-310006339cb5a3d3c491dfb00fc86c88.png" alt=""></a><figcaption class="figure-caption"></figcaption></figure><p><em>Promoting a read replica using the console</em></p><p>This simply states that once you promote the replica instance your instance will become an independent instance with no further relationship with the master instance. Once accepted and the promotion process is complete, you can see that you now have two independent Cloud SQL instances (as advertised!):</p><figure><a href="/assets/images/cloud-sql-postgres-read-replicas-9-5cbdcea2c489b064bbbc1bad3617fbce.png"><img src="/assets/images/cloud-sql-postgres-read-replicas-9-5cbdcea2c489b064bbbc1bad3617fbce.png" alt="Promoted Cloud SQL instance"></a><figcaption class="figure-caption">Promoted Cloud SQL instance</figcaption></figure><p>Some of the options you would normally configure with a master instance would need to be configured on the promoted replica instance - such as high availability, maintenance and scheduled backups - but in the event of a zonal failure you would be back up and running with virtually no data loss!</p><blockquote><p>Full source code for this article is available at: <a href="https://github.com/gamma-data/cloud-sql-postgres-availability-tutorial" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/cloud-sql-postgres-availability-tutorial</a></p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloudsql">cloudsql</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ha">ha</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/highavailability">highavailability</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/postgresql">postgresql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Google Cloud SQL ‚Äì Availability for PostgreSQL ‚Äì Part II (Read Replicas)" href="/google-cloud-sql-availability-for-postgresql-read-replicas"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql">Google Cloud SQL ‚Äì Availability, Replication, Failover for PostgreSQL ‚Äì Part I</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-17T00:00:00.000Z" itemprop="datePublished">January 17, 2020</time> ¬∑ <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/cloudsql-featured-image.png"><div class="markdown" itemprop="articleBody"><p>In this multi part blog we will explore the features available in Google Cloud SQL for High Availability, Backup and Recovery, Replication and Failover and Security (at rest and in transit) for the PostgreSQL DBMS engine. Some of these features are relatively hot of the press and in Beta ‚Äì which still makes them available for general use.</p><p>We will start by looking at the High Availability (HA) options available to you when using the PostgreSQL engine in Google Cloud SQL.</p><p>Most of you would be familiar with the concepts of High Availability, Redundancy, Fault Tolerance, etc but let‚Äôs start with a definition of HA anyway:</p><blockquote><p>High availability (HA) is a characteristic of a system, which aims to ensure an agreed level of operational performance, usually uptime, for a higher than normal period.</p><p>Wikipedia</p></blockquote><p>Higher than a normal period is quite subjective, typically this is quantified by a percentage represented by a number of ‚Äú9s‚Äù, that is 99.99% (which would be quoted as ‚Äúfour nines‚Äù), this would allot you 52.60 minutes of downtime over a one-year period.</p><p>Essentially the number of 9‚Äôs required will drive your bias towards the options available to you for Cloud SQL HA.</p><p>We will start with Cloud SQL HA in its simplest form, Regional Availability.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="regional-availability">Regional Availability<a class="hash-link" href="#regional-availability" title="Direct link to heading">‚Äã</a></h2><p>Knowing what we know about the Google Cloud Platform, regional availability means that our application or service (in this case Cloud SQL) should be resilient to a failure of any one zone in our region. In fact, as all GCP regions have at least 3 zones ‚Äì two zones could fail, and our application would still be available.</p><p>Regional availability for Cloud SQL (which Google refers to as High Availability), creates a standby instance in addition to the primary instance and uses a regional Persistent Disk resource to store the database instance data, transaction log and other state files, which is synchronously replicated to a Persistent Disk resource local to the zones that the primary and standby instances are located in.</p><p>A shared IP address (like a Virtual IP) is used to serve traffic to the healthy (normally primary) Cloud SQL instance.</p><p>An overview of Cloud SQL HA is shown here:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-9f997d42db7d02fc6391cb507e81bc6c.png"><img alt="Cloud SQL High Availability" src="/assets/images/cloud-sql-ha-9f997d42db7d02fc6391cb507e81bc6c.png" width="716" height="541"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="implementing-high-availability-for-cloud-sql">Implementing High Availability for Cloud SQL<a class="hash-link" href="#implementing-high-availability-for-cloud-sql" title="Direct link to heading">‚Äã</a></h2><p>Implementing Regional Availability for Cloud SQL is dead simple, it is one argument:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">availability_type = &quot;REGIONAL&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Using the <code>gcloud</code> command line utility, this would be:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud sql instances create postgresql-instance-1234 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --availability-type=REGIONAL \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --database-version= POSTGRES_9_6</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Using Terraform (with a complete set of options) it would look like:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;google_sql_database_instance&quot; &quot;postgres_ha&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  provider = google-beta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  region = var.region</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project = var.project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name = &quot;postgresql-instance-${random_id.instance_suffix.hex}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  database_version = &quot;POSTGRES_9_6&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  settings {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   tier = var.tier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_size = var.disk_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   activation_policy = &quot;ALWAYS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_autoresize = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disk_type = &quot;PD_SSD&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   **availability_type = &quot;REGIONAL&quot;**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   backup_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     enabled = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     start_time = &quot;00:00&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ip_configuration  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ipv4_enabled = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     private_network = google_compute_network.private_network.self_link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   maintenance_window  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     day = 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     hour = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     update_track = &quot;stable&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> } </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Once deployed you will notice a few different items in the console, first from the instance overview page you can see that the High Availability option is <code>ENABLED</code> for your instance.</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-1-12d875328c3d6743bab7c41038d7e382.png"><img src="/assets/images/cloud-sql-ha-1-12d875328c3d6743bab7c41038d7e382.png" width="1310" height="446"></a></p><p>Second, you will see a Failover button enabled on the detailed management view for this instance.</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-2-39a03f8c41a267780563cbb20bafd2d4.png"><img src="/assets/images/cloud-sql-ha-2-39a03f8c41a267780563cbb20bafd2d4.png" width="1310" height="612"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="failover">Failover<a class="hash-link" href="#failover" title="Direct link to heading">‚Äã</a></h2><p>Failovers and failbacks can be initiated manually or automatically (should the primary be unresponsive). A manual failover can be invoked by executing the command:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcloud sql instances failover postgresql-instance-1234</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There is an <code>--async</code> option which will return immediately, invoking the failover operation asynchronously.</p><p>Failover can also be invoked from the Cloud Console using the Failover button shown previously. As an example I have created a connection to a regionally available Cloud SQL instance and started a command which runs a loop and prints out a counter:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-3-6710a724106c4048213b24a2082b64cb.png"><img src="/assets/images/cloud-sql-ha-3-6710a724106c4048213b24a2082b64cb.png" width="1920" height="1040"></a></p><p>Now using the <code>gcloud</code> command shown earlier, I have invoked a manual failover of the Cloud SQL instance.</p><p>Once the failover is initiated, the client connection is dropped (as the server is momentarily unavailable):</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-4-bb4bcf4f70179371b1b26d96a92a4dff.png"><img src="/assets/images/cloud-sql-ha-4-bb4bcf4f70179371b1b26d96a92a4dff.png" width="1920" height="1040"></a></p><p>The connection can be immediately re-established afterwards, the state of the running query is lost - <strong><em>importantly no data is lost</em></strong> however. If your application clients had retry logic in their code and they weren&#x27;t executing a long running query, chances are no one would notice! Once reconnecting normal database activities can be resumed:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-5-6f8c7134a54b7a38444f5ddbdbcf960e.png"><img src="/assets/images/cloud-sql-ha-5-6f8c7134a54b7a38444f5ddbdbcf960e.png" width="1920" height="1040"></a></p><p>A quick check of the instance logs will show that the failover event has occured:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-6-a4ab88ef121dbc8842347478cf0811d0.png"><img src="/assets/images/cloud-sql-ha-6-a4ab88ef121dbc8842347478cf0811d0.png" width="1310" height="568"></a></p><p>Now when you return to the instance page in the console you will see a Failback button, which indicates that your instance is being served by the standby:</p><p><a target="_blank" href="/assets/files/cloud-sql-ha-7-25ae1613611767eea9c101c3a24f0632.png"><img src="/assets/images/cloud-sql-ha-7-25ae1613611767eea9c101c3a24f0632.png" width="1239" height="641"></a></p><p>Note that there may be a slight delay in the availability of this option as the replica is still being synched.</p><p>It is worth noting that nothing comes for free! When you run in REGIONAL or High Availability mode - you are effectively paying double the costs as compared to running in ZONAL mode. However availability and cost have always been trade-offs against one another - you get what you pay for...</p><blockquote><p>More information can be found at: <a href="https://cloud.google.com/sql/docs/postgres/high-availability" target="_blank" rel="noopener noreferrer">https://cloud.google.com/sql/docs/postgres/high-availability</a></p></blockquote><p>Next up we will look at read replicas (and their ability to be promoted) as another high availability alternative in Cloud SQL.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloudsql">cloudsql</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ha">ha</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/highavailability">highavailability</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/postgresql">postgresql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Google Cloud SQL ‚Äì Availability, Replication, Failover for PostgreSQL ‚Äì Part I" href="/google-cloud-sql-ha-backup-and-recovery-replication-failover-and-security-for-postgresql"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/ultimate-aws-to-gcp-thesaurus">The Ultimate AWS to GCP Thesaurus</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-12-30T00:00:00.000Z" itemprop="datePublished">December 30, 2019</time> ¬∑ <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/aws-to-gcp-thesauraus.png"><div class="markdown" itemprop="articleBody"><p>There are many posts available which map analogous services between the different cloud providers, but this post attempts to go a step further and map additional concepts, terms, and configuration options to be the definitive thesaurus for cloud practitioners familiar with AWS looking to fast track their familiarisation with GCP.</p><p>It should be noted that AWS and GCP are fundamentally different platforms, nowhere is this more apparent than in the way networking is implemented between the two providers, see: <a href="https://cloudywithachanceofbigdata.com/gcp-networking-for-aws-professionals/" target="_blank" rel="noopener noreferrer"><strong>GCP Networking for AWS Professionals</strong></a></p><p>This post is focused on the core infrastructure, networking and security services offered by the two major cloud providers, I will do a future post on higher level services such as the ML/AI offerings from the respective providers.</p><p>Furthermore this will be a living post which I will continue to update, I encourage comments from readers on additional mappings which I will incorporate into the post as well.</p><p>I have broken this down into sections based upon the layout of the AWS Console.</p><ul><li><a href="#compute"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAVFBMVEUAAACAgIBVVVVmZmZZWWZVWmNVWWZSWmNVXWRTW2NUWmRUW2VTW2RUXGNUW2RUXGVUW2VUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2RUW2RUW2T///8m/aZOAAAAGnRSTlMAAgMFFDY8PkJfhYaHiI+qtMLg5Obo6uv5/jprlmMAAAABYktHRBsCYNSkAAAAp0lEQVQ4y92U2w6CMBBEKyggKspF1Pn/D/VBKGWnuzGGpInzwENzEnZOunXuE8D6BtkabGGkO+UTtm9eMFNP4A3Px/WYOSUVej/fYeeMzNOCmhEI4Hsw5ir669/ANuqPQPJZK62FT++PWkufy7loLUvReSpwVUYDqbUF/mvrO4qQKzEorS/KmtKM+XkMsVG9uBvtTNq9Fv5kvE/2pz17wp+M95nqsX8DRM8xpWml3B0AAAAASUVORK5CYII=" width="40" height="40"> <strong>Compute</strong></a></li><li><a href="#storage"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAn1BMVEUAAACAgIBmZmZJSW1OYmJbW1taWmlRXWhVXmZTWmdSW2VTXWZTWWNVW2VUWmRUWmNUXGRTW2NTW2VVWmRTWmRUW2RTWmNUWmVUWmVUXGRUXGNUXGVVXGRUW2RVXGRUXGRUW2RUW2RUW2RUXGRTWmRUW2RUW2RUW2RUW2VUW2RUW2RUW2RUWmRUW2RVW2RUW2RUW2RUW2RUWmRUW2T///9nDNUkAAAAMnRSTlMAAgUHDQ4RFh4lNTdNUVJVYWJlaW5wcXd8fYiOsrO1vcLFxtHZ5+7w8fL19/j5+vv8/cnWIDMAAAABYktHRDSpsen9AAAA8ElEQVQ4y+2SVxOCMBCEUewdFXsvWLHt//9vEg+UkFxwfHafMpdvkt2btaxQ9ZGihqVR4QRVrsq1jsF8M+zHdXtoyC2mbjkx074JqL8A7TsGGlCKU3/NVFKAh3iOPc0UUgxr8SS10E4P6KZ7FB7muKSBfmQjLUxoRQWTYbSf6cKwIKNfwCAFrUKr4KpT4hsma1dlGpbQBCumYQnZOJtzyIEkMNd0KULonwMza9k/CxZwGsf9s2DWv9p0yuNg9LjEjDxOsDCCFS/y6FWMoFV0yKNTNK/n6z3+wZ9BH3YaRw1/94AXNeTTA17UkKgHvERDnvUIWGgOKx/VAAAAAElFTkSuQmCC" width="40" height="40"> <strong>Storage</strong></a></li><li><a href="#database"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAgVBMVEUAAABNZmZdXV1VVWZQYGBVVWNRXl5VWWVUXGRVXWRTWmVTWmVUW2VVXGNTXGNVXGVUW2RTWmNVXGRUWmVVW2RUW2NUXGRUWmRUW2NTW2RUWmRVW2VUW2RVW2RUW2RUXGNUW2RUW2VUW2RUW2RUW2RUW2RUW2RUW2RUW2RUW2T////mzGsFAAAAKXRSTlMACgsPEBITP0BCREdJS1BvcHF1d3h5eoKDhL2+v8HCw+7x8vP3+fr9/kFW+eoAAAABYktHRCpTvtSeAAAAqklEQVQ4y+2VRw7CMBBFH6H3FmpwCKR57n9BFiESIHkCEt7lb+zF8zR9jcGLJiYRpxKzqLmDFV2nihvbIuy40wXLohwCYGSrV7aXCIBUesDl7AT7cgNABOBq3CEroj74J9gsAOJmLv6IreX1An5Ro/mtax8DRzfFO9iaojXFC5hKVzfFQO4ARLLWM2+eS2oueRgoa2+Vy6y67kp9NvZYPxrFmRvLzNTPh/AAAUNTBbU39TMAAAAASUVORK5CYII=" width="40" height="40"> <strong>Database</strong></a></li><li><a href="#networking"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAACK1BMVEUAAAAAAACAgIBVVVVAQIBVVVVJSW1gYGBVVXFdXV1VVWpOYmJbW1tQYGBaWmlVVWNRXl5ZWWZVVWFRXWhZWWRVYGBSXGZYWGJVXmhYWGFVXmZSWmNYWGhVXWRXV2ZVXGNTWmdXXmVVXGJTWWZXXWRVW2FRXWNVW2ZVWmVSXGZVWmRTXWJSW2VSW2RSWmNVWWVUXGRSWmJVXWRTWmVVXGRUW2JTWmVVXGNTWmRTWWNTXGNVW2VTXGVVW2RUWmVTXGRVW2NTW2RVWmNUXGRTW2NVWmVUXGRTW2NUXGNTW2VVWmRUXGNVWmRUW2VTW2RUW2VTWmRVXGVTWmNVXGVUW2RVW2RUWmRUXGRUW2NTW2RUWmRUW2VTW2RUXGVUW2RTWmNUXGVTWmNUW2RTWmVUW2RUW2NTXGRTXGRUW2NTXGRTW2NUW2RUWmRTW2VUXGRUW2RUXGNTW2RUXGVUW2RUW2RUW2RVWmVUW2RUW2NVXGRUW2NUWmRVW2RUW2RUWmRVW2VUW2RUXGNVW2RUW2NUW2RVW2RUWmRUW2RTW2VVW2RUXGRUW2RVW2VUXGRUW2RTW2RVW2NVW2RTW2RUW2RUW2RTWmRUW2RTXGRUW2RUW2RTW2RUW2RUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2RUW2RUW2RUW2RUW2VUW2RUW2RUW2RUW2RUW2RUW2RVW2RUWmRUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2T////+WQQnAAAAt3RSTlMAAQIDBAYHCAkLDA0OEBESExQVFhcYGRobHR4fICEjJCUmJygpKiwtMDIzNDU4Pj9AQUJERUZHSEpNUFFTV1hZWlxdXl9gYWJkZWZnaWprbW5vcXJze3+Ag4SFhoqLjI2OkJGTlJWWmZqcn6ChoqSmp6iqq62ur7Cxsra6u7y9vsLDx8jJysvMzc3Oz9DR0tPT09bX2Nnb3ODh4uPk5efo6err7O7v8PHy8/T19vf3+Pn6+/z9/f4Rdgt0AAAAAWJLR0S4Tb8m9gAAAlRJREFUGBmFwQdDjAEAx+HfddknDaOUQkSRsioNq8hOVvamZJYIpZLRsGcZJ5yMlOM67//rebvWyY3n4R+pRxs+fv7cUb8njkDi6jXIVR6GX4mf9OHQsmlhYbFZZ5x6OQU/xrXrRjgDZrToJn7s1p0xDIl4r/TkwpwY/vdWi/CyT78luc6OZYRZslvwkiu1nbvqVI2Ff61UJd4mlBdaIf6NsvBmnX9cJ/GhWKUMSyj9ImkPPmSriiFbe2Q8qiyLxofdup0+in4bpfMz8OOipHcb6DO1S9vxa87eU6+kA5j2qpqALGtdRjLQqqUEcVBlwBdNJIj5egE4NZogxqsLeK14ghinLqBCxQSRoufACtnDCeykTgCWW7o9mUAKen8lYprWrs6j2QtTfJo3d32DVIxHZJWhQDoLGZS8v6ZpQHOHTB3NTf3aWi5tseFD0kM5JaceJBGItcSlpkQpsUmuEit+JTSqtyQUidCSXjUm8D9bWkYUm77qVSogAalt+rqJqMw0G8MsO7sk92OpchImCdOky9ITt/R9B0MKZdRc79bPXDwkPHJ/qvt6raECBnUoHxY4/0TjIeERY/SkwDrZGTBdrzFVKxtTbLEUS58cXcH0VjH0i9QnK1Cn5cCqb5K+5WHKVC0Q6lAEA57pcAj5xo8wmN2jiqIr6p4JhHcba7Ae0VMGLTbksEs7gGM6DZTqCKZdkt0hdxpD0u+71Z5vAeq1GFiiOkyWde1yt6bhzRaBxwVtBrboPP0ibfi2Wo6M0ZkO5RGE5Zr6XCWokKJ7PXe3hTDSX044BELj8dR3AAAAAElFTkSuQmCC" width="40" height="40"> <strong>Networking &amp; Content Delivery</strong></a></li><li><a href="#security"><img src="data:image/png;base64,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" width="40" height="40"> <strong>Security, Identity, &amp; Compliance</strong></a></li></ul><a name="compute"></a><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="-compute"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAVFBMVEUAAACAgIBVVVVmZmZZWWZVWmNVWWZSWmNVXWRTW2NUWmRUW2VTW2RUXGNUW2RUXGVUW2VUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2RUW2RUW2T///8m/aZOAAAAGnRSTlMAAgMFFDY8PkJfhYaHiI+qtMLg5Obo6uv5/jprlmMAAAABYktHRBsCYNSkAAAAp0lEQVQ4y92U2w6CMBBEKyggKspF1Pn/D/VBKGWnuzGGpInzwENzEnZOunXuE8D6BtkabGGkO+UTtm9eMFNP4A3Px/WYOSUVej/fYeeMzNOCmhEI4Hsw5ir669/ANuqPQPJZK62FT++PWkufy7loLUvReSpwVUYDqbUF/mvrO4qQKzEorS/KmtKM+XkMsVG9uBvtTNq9Fv5kvE/2pz17wp+M95nqsX8DRM8xpWml3B0AAAAASUVORK5CYII=" width="40" height="40"> Compute<a class="hash-link" href="#-compute" title="Direct link to heading">‚Äã</a></h2><table><thead><tr><th><img src="data:image/png;base64,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" width="84" height="50"></th><th><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAAyCAYAAAAEA2g/AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAATZSURBVHjaYmSgMXjtYmYPpByA2ACIFaA0OvgAxBeA+AGU3iC659RDWroLIIAYaejZBCAOAGIBMo0BBcICEKZFIAAEECMNPNwAjWFqAlAANFAzAAACiJFKHpaHOs6BxjlnAjQAPlJqEEAAMVLB0/lQB9ELgLJAANDzFykxBCCAGCnwMD/UwwkMAwMSgJ5fSK5mgABiosDTBwbQ0wwLlUMXhNTun0+ufoAAYqTA0wYD6GmGE2Im8IJvTbNjIqlmAAQQOTG+YRB5GpzkgTFfT6o5AAHESGJs9wOpgkHkaWQQAIz5jcSaBRBAjCR42h6axAejp2GtPwWg54mq6gACiIWEfL2AQrdvgOIL6FURNFANoIWlARmeZoC2EEFuDCTGMQABxEikx+uhLTKat7rQW39EehoZOABj/SAhRQABxEhkbD8go839AdrQOEhOaAHtjV+qFDThiLg5qfYeAHrckZAigAAiplQvwOdpZrnvcIwEQD0sBXI9DQKgxgnQ0wZQs0iKcWApb09IEUAAERPj96HdSQYmsZ8MrGpfGViAnmSR+4FV/f8fTAz//zFcYOL6B0riG9hc3lLUsQB6gpwUR7BuBwggRgKe9gc5nkX1KwO76QecniWU9EB5FhgABynwPDk1igC+Eh4ggPAmdVaNLw7cUU8ZuINfkOtpBmghdeDXHuH9QCxPjgHQwmoBGfbiBAABhNPjQEfGcwW8TKDAw9gccgFkLpn6SW04gdryOO0CCCAmHJ7uh4awAAN1AbiuBZpfT0asfyQx1gWgnu/HJgkQQEw4PE3rZmkDOZ6HNoBITinYPA8QQEzoyZuObXGQ5/3JKCgZyPQ8SrIHCCAmJE/L03kk5QKpHoEm9wfkDlsBPQ8vXAECiAmtaSlAR087AKs4csbOHlBSvsA4AAHEBI1tewbaDxRSw9MU1yywVh1AAMFivIECwx5Ak+wDOnn6AaVlC4gACCBGaN4m1bAP0PJgAXKTFGpWAwP2sTiqxjQ05kAFcQAZ2hUAAgjkcVKHhz9APXART+PHH63MoFnyhpbWpLbqCgACiInEECPoaRAAym9EinWa5mlgSb+QjCrYASCAmBhIGzicQMjTaJ6fQI+CDOj5iSRWjQYAAcRCanePFAcBPVxIxxJ7AQk1kwJAAJEyvPyA0r41jQFJjSGAACLJ44PY06DkTlKkAAQQKR43GMweR26OEgMAAogUjwsAqyn9Qex3klqeAAHERGISLhjEHiel9fkAIICYGEgbxUygYASFlskc1LdXIKW/ABBATGT0cRcMJs8DPZ1PRl/jAEAAkdtWZzj3W+BAzidDUAPlwJnwNR/p7Fl+aIszgcxepQJAADFC29brSWm63vrDw5DzyYDhy39WijygcCV7IBLJBmDVFwgQQLBSfQK9PT2AAOxXgABigjYtQePWG0aApzfAJhQBAogJrar6MIw9/QG5OgYIICakDsVDHAMIw8HT4KoYuVkLEEBMePrRw83TKMtEAAKICUtXciHM88PI0xjr4QACiAlHP3rh/T9cCbmfDD4M8TwdgM3TIAAQQDg7Keoejxd+/s9qwEDetM2Al96g3iS+VVAAAUTUGhiTlSGUjGjSswED8vAEYtbAAAQQSevcgAEAayo6QDsFDgPs8QcMiKmoDaQMRgAEGADHTLziPW4o6AAAAABJRU5ErkJggg==" width="62" height="50"></th></tr></thead><tbody><tr><td>EC2 (Elastic Compute Cloud)</td><td>GCE (Google Compute Engine)</td></tr><tr><td>Availability Zone</td><td>Zone</td></tr><tr><td>Instance</td><td>VM Instance</td></tr><tr><td>Instance Family</td><td>Machine Family</td></tr><tr><td>Instance Type</td><td>Machine Type</td></tr><tr><td>Amazon Machine Image (AMI)</td><td>Image</td></tr><tr><td>IAM Role (for an EC2 Instance)</td><td>Service Account</td></tr><tr><td>Security Groups</td><td>VPC Firewall Rules (ALLOW)</td></tr><tr><td>Tag</td><td>Label</td></tr><tr><td>Termination Protection</td><td>Deletion Protection</td></tr><tr><td>Reserved Instances</td><td>Committed Use Discounts</td></tr><tr><td>Capacity Reservation</td><td>Reservation</td></tr><tr><td>User Data</td><td>Startup Script</td></tr><tr><td>Spot Instances</td><td>Preemptible VMs</td></tr><tr><td>Dedicated Instances</td><td>Sole Tenancy</td></tr><tr><td>EBS Volume</td><td>Persistent Disk</td></tr><tr><td>Auto Scaling Group</td><td>Managed Instance Group</td></tr><tr><td>Launch Configuration</td><td>Instance Template</td></tr><tr><td>ELB Listener</td><td>URL Map (Load Balancer)</td></tr><tr><td>ELB Target Group</td><td>Backend/ Instance Group</td></tr><tr><td>Instance Storage (ephemeral)</td><td>Local SSDs</td></tr><tr><td>EBS Snapshots</td><td>Snapshots</td></tr><tr><td>Keypair</td><td>SSH Keys</td></tr><tr><td>Elastic IP</td><td>External IP</td></tr><tr><td>Lambda</td><td>Google Cloud Functions</td></tr><tr><td>Elastic Beanstalk</td><td>Google App Engine</td></tr><tr><td>Elastic Container Registry (ECR)</td><td>Google Container Registry (GCR)</td></tr><tr><td>Elastic Container Service (ECS)</td><td>Google Kubernetes Engine (GKE)</td></tr><tr><td>Elastic Kubernetes Service (EKS)</td><td>Google Kubernetes Engine (GKE)</td></tr><tr><td>AWS Fargate</td><td>Cloud Run</td></tr><tr><td>AWS Service Quotas</td><td>Allocation Quotas</td></tr><tr><td>Account (within an Organisation)<!-- -->‚Ä†</td><td>Project</td></tr><tr><td>Region</td><td>Region</td></tr><tr><td>AWS Cloud‚ÄãFormation</td><td>Cloud Deployment Manager</td></tr></tbody></table><a name="storage"></a><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="-storage"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAn1BMVEUAAACAgIBmZmZJSW1OYmJbW1taWmlRXWhVXmZTWmdSW2VTXWZTWWNVW2VUWmRUWmNUXGRTW2NTW2VVWmRTWmRUW2RTWmNUWmVUWmVUXGRUXGNUXGVVXGRUW2RVXGRUXGRUW2RUW2RUW2RUXGRTWmRUW2RUW2RUW2RUW2VUW2RUW2RUW2RUWmRUW2RVW2RUW2RUW2RUW2RUWmRUW2T///9nDNUkAAAAMnRSTlMAAgUHDQ4RFh4lNTdNUVJVYWJlaW5wcXd8fYiOsrO1vcLFxtHZ5+7w8fL19/j5+vv8/cnWIDMAAAABYktHRDSpsen9AAAA8ElEQVQ4y+2SVxOCMBCEUewdFXsvWLHt//9vEg+UkFxwfHafMpdvkt2btaxQ9ZGihqVR4QRVrsq1jsF8M+zHdXtoyC2mbjkx074JqL8A7TsGGlCKU3/NVFKAh3iOPc0UUgxr8SS10E4P6KZ7FB7muKSBfmQjLUxoRQWTYbSf6cKwIKNfwCAFrUKr4KpT4hsma1dlGpbQBCumYQnZOJtzyIEkMNd0KULonwMza9k/CxZwGsf9s2DWv9p0yuNg9LjEjDxOsDCCFS/y6FWMoFV0yKNTNK/n6z3+wZ9BH3YaRw1/94AXNeTTA17UkKgHvERDnvUIWGgOKx/VAAAAAElFTkSuQmCC" width="40" height="40"> Storage<a class="hash-link" href="#-storage" title="Direct link to heading">‚Äã</a></h2><table><thead><tr><th><img src="data:image/png;base64,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" width="84" height="50"></th><th><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAAyCAYAAAAEA2g/AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAATZSURBVHjaYmSgMXjtYmYPpByA2ACIFaA0OvgAxBeA+AGU3iC659RDWroLIIAYaejZBCAOAGIBMo0BBcICEKZFIAAEECMNPNwAjWFqAlAANFAzAAACiJFKHpaHOs6BxjlnAjQAPlJqEEAAMVLB0/lQB9ELgLJAANDzFykxBCCAGCnwMD/UwwkMAwMSgJ5fSK5mgABiosDTBwbQ0wwLlUMXhNTun0+ufoAAYqTA0wYD6GmGE2Im8IJvTbNjIqlmAAQQOTG+YRB5GpzkgTFfT6o5AAHESGJs9wOpgkHkaWQQAIz5jcSaBRBAjCR42h6axAejp2GtPwWg54mq6gACiIWEfL2AQrdvgOIL6FURNFANoIWlARmeZoC2EEFuDCTGMQABxEikx+uhLTKat7rQW39EehoZOABj/SAhRQABxEhkbD8go839AdrQOEhOaAHtjV+qFDThiLg5qfYeAHrckZAigAAiplQvwOdpZrnvcIwEQD0sBXI9DQKgxgnQ0wZQs0iKcWApb09IEUAAERPj96HdSQYmsZ8MrGpfGViAnmSR+4FV/f8fTAz//zFcYOL6B0riG9hc3lLUsQB6gpwUR7BuBwggRgKe9gc5nkX1KwO76QecniWU9EB5FhgABynwPDk1igC+Eh4ggPAmdVaNLw7cUU8ZuINfkOtpBmghdeDXHuH9QCxPjgHQwmoBGfbiBAABhNPjQEfGcwW8TKDAw9gccgFkLpn6SW04gdryOO0CCCAmHJ7uh4awAAN1AbiuBZpfT0asfyQx1gWgnu/HJgkQQEw4PE3rZmkDOZ6HNoBITinYPA8QQEzoyZuObXGQ5/3JKCgZyPQ8SrIHCCAmJE/L03kk5QKpHoEm9wfkDlsBPQ8vXAECiAmtaSlAR087AKs4csbOHlBSvsA4AAHEBI1tewbaDxRSw9MU1yywVh1AAMFivIECwx5Ak+wDOnn6AaVlC4gACCBGaN4m1bAP0PJgAXKTFGpWAwP2sTiqxjQ05kAFcQAZ2hUAAgjkcVKHhz9APXART+PHH63MoFnyhpbWpLbqCgACiInEECPoaRAAym9EinWa5mlgSb+QjCrYASCAmBhIGzicQMjTaJ6fQI+CDOj5iSRWjQYAAcRCanePFAcBPVxIxxJ7AQk1kwJAAJEyvPyA0r41jQFJjSGAACLJ44PY06DkTlKkAAQQKR43GMweR26OEgMAAogUjwsAqyn9Qex3klqeAAHERGISLhjEHiel9fkAIICYGEgbxUygYASFlskc1LdXIKW/ABBATGT0cRcMJs8DPZ1PRl/jAEAAkdtWZzj3W+BAzidDUAPlwJnwNR/p7Fl+aIszgcxepQJAADFC29brSWm63vrDw5DzyYDhy39WijygcCV7IBLJBmDVFwgQQLBSfQK9PT2AAOxXgABigjYtQePWG0aApzfAJhQBAogJrar6MIw9/QG5OgYIICakDsVDHAMIw8HT4KoYuVkLEEBMePrRw83TKMtEAAKICUtXciHM88PI0xjr4QACiAlHP3rh/T9cCbmfDD4M8TwdgM3TIAAQQDg7Keoejxd+/s9qwEDetM2Al96g3iS+VVAAAUTUGhiTlSGUjGjSswED8vAEYtbAAAQQSevcgAEAayo6QDsFDgPs8QcMiKmoDaQMRgAEGADHTLziPW4o6AAAAABJRU5ErkJggg==" width="62" height="50"></th></tr></thead><tbody><tr><td>Simple Storage Service (S3)</td><td>Google Cloud Storage (GCS)</td></tr><tr><td>Standard Storage Class</td><td>Standard Storage Class</td></tr><tr><td>Infrequent Access Storage Class</td><td>Nearline Storage Class</td></tr><tr><td>Amazon Glacier</td><td>Coldline Storage Class</td></tr><tr><td>Lifecycle Policy</td><td>Retention Policy</td></tr><tr><td>Tags</td><td>Labels</td></tr><tr><td>Snowball</td><td>Transfer Appliance</td></tr><tr><td>Requester Pays</td><td>Requester Pays</td></tr><tr><td>Region</td><td>Location Type/Location</td></tr><tr><td>Object Lock</td><td>Hold</td></tr><tr><td>Vault Lock (Glacier)</td><td>Bucket Lock</td></tr><tr><td>Multi Part Upload</td><td>Parallel Composite Transfer</td></tr><tr><td>Cross-Origin Resource Sharing (CORS)</td><td>Cross-Origin Resource Sharing (CORS)</td></tr><tr><td>Static Website Hosting</td><td>Bucket Website Configuration</td></tr><tr><td>S3 Access Points</td><td>VPC Service Controls</td></tr><tr><td>Object Notifications</td><td>Pub/Sub Notifications for Cloud Storage</td></tr><tr><td>Presigned URL</td><td>Signed URL</td></tr><tr><td>Transfer Acceleration</td><td>Storage Transfer Service</td></tr><tr><td>Elastic File System (EFS)</td><td>Cloud Filestore</td></tr><tr><td>AWS DataSync</td><td>Transfer Service for on-premises data</td></tr><tr><td>ETag</td><td>ETag</td></tr><tr><td>Bucket</td><td>Bucket</td></tr><tr><td><code>aws s3</code></td><td><code>gsutil</code></td></tr></tbody></table><a name="database"></a><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="-database"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAgVBMVEUAAABNZmZdXV1VVWZQYGBVVWNRXl5VWWVUXGRVXWRTWmVTWmVUW2VVXGNTXGNVXGVUW2RTWmNVXGRUWmVVW2RUW2NUXGRUWmRUW2NTW2RUWmRVW2VUW2RVW2RUW2RUXGNUW2RUW2VUW2RUW2RUW2RUW2RUW2RUW2RUW2RUW2T////mzGsFAAAAKXRSTlMACgsPEBITP0BCREdJS1BvcHF1d3h5eoKDhL2+v8HCw+7x8vP3+fr9/kFW+eoAAAABYktHRCpTvtSeAAAAqklEQVQ4y+2VRw7CMBBFH6H3FmpwCKR57n9BFiESIHkCEt7lb+zF8zR9jcGLJiYRpxKzqLmDFV2nihvbIuy40wXLohwCYGSrV7aXCIBUesDl7AT7cgNABOBq3CEroj74J9gsAOJmLv6IreX1An5Ro/mtax8DRzfFO9iaojXFC5hKVzfFQO4ARLLWM2+eS2oueRgoa2+Vy6y67kp9NvZYPxrFmRvLzNTPh/AAAUNTBbU39TMAAAAASUVORK5CYII=" width="40" height="40"> Database<a class="hash-link" href="#-database" title="Direct link to heading">‚Äã</a></h2><table><thead><tr><th><img src="data:image/png;base64,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" width="84" height="50"></th><th><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAAyCAYAAAAEA2g/AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAATZSURBVHjaYmSgMXjtYmYPpByA2ACIFaA0OvgAxBeA+AGU3iC659RDWroLIIAYaejZBCAOAGIBMo0BBcICEKZFIAAEECMNPNwAjWFqAlAANFAzAAACiJFKHpaHOs6BxjlnAjQAPlJqEEAAMVLB0/lQB9ELgLJAANDzFykxBCCAGCnwMD/UwwkMAwMSgJ5fSK5mgABiosDTBwbQ0wwLlUMXhNTun0+ufoAAYqTA0wYD6GmGE2Im8IJvTbNjIqlmAAQQOTG+YRB5GpzkgTFfT6o5AAHESGJs9wOpgkHkaWQQAIz5jcSaBRBAjCR42h6axAejp2GtPwWg54mq6gACiIWEfL2AQrdvgOIL6FURNFANoIWlARmeZoC2EEFuDCTGMQABxEikx+uhLTKat7rQW39EehoZOABj/SAhRQABxEhkbD8go839AdrQOEhOaAHtjV+qFDThiLg5qfYeAHrckZAigAAiplQvwOdpZrnvcIwEQD0sBXI9DQKgxgnQ0wZQs0iKcWApb09IEUAAERPj96HdSQYmsZ8MrGpfGViAnmSR+4FV/f8fTAz//zFcYOL6B0riG9hc3lLUsQB6gpwUR7BuBwggRgKe9gc5nkX1KwO76QecniWU9EB5FhgABynwPDk1igC+Eh4ggPAmdVaNLw7cUU8ZuINfkOtpBmghdeDXHuH9QCxPjgHQwmoBGfbiBAABhNPjQEfGcwW8TKDAw9gccgFkLpn6SW04gdryOO0CCCAmHJ7uh4awAAN1AbiuBZpfT0asfyQx1gWgnu/HJgkQQEw4PE3rZmkDOZ6HNoBITinYPA8QQEzoyZuObXGQ5/3JKCgZyPQ8SrIHCCAmJE/L03kk5QKpHoEm9wfkDlsBPQ8vXAECiAmtaSlAR087AKs4csbOHlBSvsA4AAHEBI1tewbaDxRSw9MU1yywVh1AAMFivIECwx5Ak+wDOnn6AaVlC4gACCBGaN4m1bAP0PJgAXKTFGpWAwP2sTiqxjQ05kAFcQAZ2hUAAgjkcVKHhz9APXART+PHH63MoFnyhpbWpLbqCgACiInEECPoaRAAym9EinWa5mlgSb+QjCrYASCAmBhIGzicQMjTaJ6fQI+CDOj5iSRWjQYAAcRCanePFAcBPVxIxxJ7AQk1kwJAAJEyvPyA0r41jQFJjSGAACLJ44PY06DkTlKkAAQQKR43GMweR26OEgMAAogUjwsAqyn9Qex3klqeAAHERGISLhjEHiel9fkAIICYGEgbxUygYASFlskc1LdXIKW/ABBATGT0cRcMJs8DPZ1PRl/jAEAAkdtWZzj3W+BAzidDUAPlwJnwNR/p7Fl+aIszgcxepQJAADFC29brSWm63vrDw5DzyYDhy39WijygcCV7IBLJBmDVFwgQQLBSfQK9PT2AAOxXgABigjYtQePWG0aApzfAJhQBAogJrar6MIw9/QG5OgYIICakDsVDHAMIw8HT4KoYuVkLEEBMePrRw83TKMtEAAKICUtXciHM88PI0xjr4QACiAlHP3rh/T9cCbmfDD4M8TwdgM3TIAAQQDg7Keoejxd+/s9qwEDetM2Al96g3iS+VVAAAUTUGhiTlSGUjGjSswED8vAEYtbAAAQQSevcgAEAayo6QDsFDgPs8QcMiKmoDaQMRgAEGADHTLziPW4o6AAAAABJRU5ErkJggg==" width="62" height="50"></th></tr></thead><tbody><tr><td>Relational Database Service (RDS)</td><td>Cloud SQL</td></tr><tr><td>DynamoDB</td><td>Cloud Datastore</td></tr><tr><td>ElastiCache</td><td>Cloud Memorystore</td></tr><tr><td>Table (DynamoDB)</td><td>Kind (Cloud Datastore)</td></tr><tr><td>Item (DynamoDB)</td><td>Entity (Cloud Datastore)</td></tr><tr><td>Partition Key (DynamoDB)</td><td>Key (Cloud Datastore)</td></tr><tr><td>Attributes (DynamoDB)</td><td>Properties (Cloud Datastore)</td></tr><tr><td>Local Secondary Index (DynamoDB)</td><td>Composite Index (Cloud Datastore)</td></tr><tr><td>Elastic Map Reduce (EMR)</td><td>Cloud DataProc</td></tr><tr><td>Athena</td><td>Big Query</td></tr><tr><td>AWS Glue</td><td>Cloud DataFlow</td></tr><tr><td>Glue Catalog</td><td>Data Catalog</td></tr><tr><td>Amazon Simple Notification Service (SNS)</td><td>Cloud PubSub (push subscription)</td></tr><tr><td>Amazon Kinesis</td><td>Cloud PubSub</td></tr><tr><td>Amazon Simple Queue Service (SQS)</td><td>Cloud PubSub (poll and pull mode)</td></tr></tbody></table><a name="networking"></a><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="-networking--content-delivery"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAACK1BMVEUAAAAAAACAgIBVVVVAQIBVVVVJSW1gYGBVVXFdXV1VVWpOYmJbW1tQYGBaWmlVVWNRXl5ZWWZVVWFRXWhZWWRVYGBSXGZYWGJVXmhYWGFVXmZSWmNYWGhVXWRXV2ZVXGNTWmdXXmVVXGJTWWZXXWRVW2FRXWNVW2ZVWmVSXGZVWmRTXWJSW2VSW2RSWmNVWWVUXGRSWmJVXWRTWmVVXGRUW2JTWmVVXGNTWmRTWWNTXGNVW2VTXGVVW2RUWmVTXGRVW2NTW2RVWmNUXGRTW2NVWmVUXGRTW2NUXGNTW2VVWmRUXGNVWmRUW2VTW2RUW2VTWmRVXGVTWmNVXGVUW2RVW2RUWmRUXGRUW2NTW2RUWmRUW2VTW2RUXGVUW2RTWmNUXGVTWmNUW2RTWmVUW2RUW2NTXGRTXGRUW2NTXGRTW2NUW2RUWmRTW2VUXGRUW2RUXGNTW2RUXGVUW2RUW2RUW2RVWmVUW2RUW2NVXGRUW2NUWmRVW2RUW2RUWmRVW2VUW2RUXGNVW2RUW2NUW2RVW2RUWmRUW2RTW2VVW2RUXGRUW2RVW2VUXGRUW2RTW2RVW2NVW2RTW2RUW2RUW2RTWmRUW2RTXGRUW2RUW2RTW2RUW2RUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2RUW2RUW2RUW2RUW2VUW2RUW2RUW2RUW2RUW2RUW2RVW2RUWmRUW2RUW2RUW2RUW2RUW2RUXGRUW2RUW2T////+WQQnAAAAt3RSTlMAAQIDBAYHCAkLDA0OEBESExQVFhcYGRobHR4fICEjJCUmJygpKiwtMDIzNDU4Pj9AQUJERUZHSEpNUFFTV1hZWlxdXl9gYWJkZWZnaWprbW5vcXJze3+Ag4SFhoqLjI2OkJGTlJWWmZqcn6ChoqSmp6iqq62ur7Cxsra6u7y9vsLDx8jJysvMzc3Oz9DR0tPT09bX2Nnb3ODh4uPk5efo6err7O7v8PHy8/T19vf3+Pn6+/z9/f4Rdgt0AAAAAWJLR0S4Tb8m9gAAAlRJREFUGBmFwQdDjAEAx+HfddknDaOUQkSRsioNq8hOVvamZJYIpZLRsGcZJ5yMlOM67//rebvWyY3n4R+pRxs+fv7cUb8njkDi6jXIVR6GX4mf9OHQsmlhYbFZZ5x6OQU/xrXrRjgDZrToJn7s1p0xDIl4r/TkwpwY/vdWi/CyT78luc6OZYRZslvwkiu1nbvqVI2Ff61UJd4mlBdaIf6NsvBmnX9cJ/GhWKUMSyj9ImkPPmSriiFbe2Q8qiyLxofdup0+in4bpfMz8OOipHcb6DO1S9vxa87eU6+kA5j2qpqALGtdRjLQqqUEcVBlwBdNJIj5egE4NZogxqsLeK14ghinLqBCxQSRoufACtnDCeykTgCWW7o9mUAKen8lYprWrs6j2QtTfJo3d32DVIxHZJWhQDoLGZS8v6ZpQHOHTB3NTf3aWi5tseFD0kM5JaceJBGItcSlpkQpsUmuEit+JTSqtyQUidCSXjUm8D9bWkYUm77qVSogAalt+rqJqMw0G8MsO7sk92OpchImCdOky9ITt/R9B0MKZdRc79bPXDwkPHJ/qvt6raECBnUoHxY4/0TjIeERY/SkwDrZGTBdrzFVKxtTbLEUS58cXcH0VjH0i9QnK1Cn5cCqb5K+5WHKVC0Q6lAEA57pcAj5xo8wmN2jiqIr6p4JhHcba7Ae0VMGLTbksEs7gGM6DZTqCKZdkt0hdxpD0u+71Z5vAeq1GFiiOkyWde1yt6bhzRaBxwVtBrboPP0ibfi2Wo6M0ZkO5RGE5Zr6XCWokKJ7PXe3hTDSX044BELj8dR3AAAAAElFTkSuQmCC" width="40" height="40"> Networking &amp; Content Delivery<a class="hash-link" href="#-networking--content-delivery" title="Direct link to heading">‚Äã</a></h2><table><thead><tr><th><img src="data:image/png;base64,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" width="84" height="50"></th><th><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAAyCAYAAAAEA2g/AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAATZSURBVHjaYmSgMXjtYmYPpByA2ACIFaA0OvgAxBeA+AGU3iC659RDWroLIIAYaejZBCAOAGIBMo0BBcICEKZFIAAEECMNPNwAjWFqAlAANFAzAAACiJFKHpaHOs6BxjlnAjQAPlJqEEAAMVLB0/lQB9ELgLJAANDzFykxBCCAGCnwMD/UwwkMAwMSgJ5fSK5mgABiosDTBwbQ0wwLlUMXhNTun0+ufoAAYqTA0wYD6GmGE2Im8IJvTbNjIqlmAAQQOTG+YRB5GpzkgTFfT6o5AAHESGJs9wOpgkHkaWQQAIz5jcSaBRBAjCR42h6axAejp2GtPwWg54mq6gACiIWEfL2AQrdvgOIL6FURNFANoIWlARmeZoC2EEFuDCTGMQABxEikx+uhLTKat7rQW39EehoZOABj/SAhRQABxEhkbD8go839AdrQOEhOaAHtjV+qFDThiLg5qfYeAHrckZAigAAiplQvwOdpZrnvcIwEQD0sBXI9DQKgxgnQ0wZQs0iKcWApb09IEUAAERPj96HdSQYmsZ8MrGpfGViAnmSR+4FV/f8fTAz//zFcYOL6B0riG9hc3lLUsQB6gpwUR7BuBwggRgKe9gc5nkX1KwO76QecniWU9EB5FhgABynwPDk1igC+Eh4ggPAmdVaNLw7cUU8ZuINfkOtpBmghdeDXHuH9QCxPjgHQwmoBGfbiBAABhNPjQEfGcwW8TKDAw9gccgFkLpn6SW04gdryOO0CCCAmHJ7uh4awAAN1AbiuBZpfT0asfyQx1gWgnu/HJgkQQEw4PE3rZmkDOZ6HNoBITinYPA8QQEzoyZuObXGQ5/3JKCgZyPQ8SrIHCCAmJE/L03kk5QKpHoEm9wfkDlsBPQ8vXAECiAmtaSlAR087AKs4csbOHlBSvsA4AAHEBI1tewbaDxRSw9MU1yywVh1AAMFivIECwx5Ak+wDOnn6AaVlC4gACCBGaN4m1bAP0PJgAXKTFGpWAwP2sTiqxjQ05kAFcQAZ2hUAAgjkcVKHhz9APXART+PHH63MoFnyhpbWpLbqCgACiInEECPoaRAAym9EinWa5mlgSb+QjCrYASCAmBhIGzicQMjTaJ6fQI+CDOj5iSRWjQYAAcRCanePFAcBPVxIxxJ7AQk1kwJAAJEyvPyA0r41jQFJjSGAACLJ44PY06DkTlKkAAQQKR43GMweR26OEgMAAogUjwsAqyn9Qex3klqeAAHERGISLhjEHiel9fkAIICYGEgbxUygYASFlskc1LdXIKW/ABBATGT0cRcMJs8DPZ1PRl/jAEAAkdtWZzj3W+BAzidDUAPlwJnwNR/p7Fl+aIszgcxepQJAADFC29brSWm63vrDw5DzyYDhy39WijygcCV7IBLJBmDVFwgQQLBSfQK9PT2AAOxXgABigjYtQePWG0aApzfAJhQBAogJrar6MIw9/QG5OgYIICakDsVDHAMIw8HT4KoYuVkLEEBMePrRw83TKMtEAAKICUtXciHM88PI0xjr4QACiAlHP3rh/T9cCbmfDD4M8TwdgM3TIAAQQDg7Keoejxd+/s9qwEDetM2Al96g3iS+VVAAAUTUGhiTlSGUjGjSswED8vAEYtbAAAQQSevcgAEAayo6QDsFDgPs8QcMiKmoDaQMRgAEGADHTLziPW4o6AAAAABJRU5ErkJggg==" width="62" height="50"></th></tr></thead><tbody><tr><td>Virtual Private Cloud (VPC) (Regional)</td><td>VPC Network (Global or Regional)</td></tr><tr><td>Subnet (Zonal)</td><td>Subnet (Regional)</td></tr><tr><td>Route Tables</td><td>Routes</td></tr><tr><td>Network ACLs (NACLS)</td><td>VPC Firewall Rules (ALLOW or DENY)</td></tr><tr><td>CloudFront</td><td>Cloud CDN</td></tr><tr><td>Route 53</td><td>Cloud DNS/Google Domains</td></tr><tr><td>Direct Connect</td><td>Dedicated (or Partner) Interconnect</td></tr><tr><td>Virtual Private Network (VPN)</td><td>Cloud VPN</td></tr><tr><td>AWS PrivateLink</td><td>Google Private Access</td></tr><tr><td>NAT Gateway</td><td>Cloud NAT</td></tr><tr><td>Elastic Load Balancer</td><td>Load Balancer</td></tr><tr><td>AWS WAF</td><td>Cloud Armour</td></tr><tr><td>VPC Peering Connection</td><td>VPC Network Peering</td></tr><tr><td>Amazon API Gateway</td><td>Apigee API Gateway</td></tr><tr><td>Amazon API Gateway</td><td>Cloud Endpoints</td></tr></tbody></table><a name="security"></a><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="-security-identity--compliance"><img src="data:image/png;base64,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" width="40" height="40"> Security, Identity, &amp; Compliance<a class="hash-link" href="#-security-identity--compliance" title="Direct link to heading">‚Äã</a></h2><table><thead><tr><th><img src="data:image/png;base64,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" width="84" height="50"></th><th><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD4AAAAyCAYAAAAEA2g/AAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAATZSURBVHjaYmSgMXjtYmYPpByA2ACIFaA0OvgAxBeA+AGU3iC659RDWroLIIAYaejZBCAOAGIBMo0BBcICEKZFIAAEECMNPNwAjWFqAlAANFAzAAACiJFKHpaHOs6BxjlnAjQAPlJqEEAAMVLB0/lQB9ELgLJAANDzFykxBCCAGCnwMD/UwwkMAwMSgJ5fSK5mgABiosDTBwbQ0wwLlUMXhNTun0+ufoAAYqTA0wYD6GmGE2Im8IJvTbNjIqlmAAQQOTG+YRB5GpzkgTFfT6o5AAHESGJs9wOpgkHkaWQQAIz5jcSaBRBAjCR42h6axAejp2GtPwWg54mq6gACiIWEfL2AQrdvgOIL6FURNFANoIWlARmeZoC2EEFuDCTGMQABxEikx+uhLTKat7rQW39EehoZOABj/SAhRQABxEhkbD8go839AdrQOEhOaAHtjV+qFDThiLg5qfYeAHrckZAigAAiplQvwOdpZrnvcIwEQD0sBXI9DQKgxgnQ0wZQs0iKcWApb09IEUAAERPj96HdSQYmsZ8MrGpfGViAnmSR+4FV/f8fTAz//zFcYOL6B0riG9hc3lLUsQB6gpwUR7BuBwggRgKe9gc5nkX1KwO76QecniWU9EB5FhgABynwPDk1igC+Eh4ggPAmdVaNLw7cUU8ZuINfkOtpBmghdeDXHuH9QCxPjgHQwmoBGfbiBAABhNPjQEfGcwW8TKDAw9gccgFkLpn6SW04gdryOO0CCCAmHJ7uh4awAAN1AbiuBZpfT0asfyQx1gWgnu/HJgkQQEw4PE3rZmkDOZ6HNoBITinYPA8QQEzoyZuObXGQ5/3JKCgZyPQ8SrIHCCAmJE/L03kk5QKpHoEm9wfkDlsBPQ8vXAECiAmtaSlAR087AKs4csbOHlBSvsA4AAHEBI1tewbaDxRSw9MU1yywVh1AAMFivIECwx5Ak+wDOnn6AaVlC4gACCBGaN4m1bAP0PJgAXKTFGpWAwP2sTiqxjQ05kAFcQAZ2hUAAgjkcVKHhz9APXART+PHH63MoFnyhpbWpLbqCgACiInEECPoaRAAym9EinWa5mlgSb+QjCrYASCAmBhIGzicQMjTaJ6fQI+CDOj5iSRWjQYAAcRCanePFAcBPVxIxxJ7AQk1kwJAAJEyvPyA0r41jQFJjSGAACLJ44PY06DkTlKkAAQQKR43GMweR26OEgMAAogUjwsAqyn9Qex3klqeAAHERGISLhjEHiel9fkAIICYGEgbxUygYASFlskc1LdXIKW/ABBATGT0cRcMJs8DPZ1PRl/jAEAAkdtWZzj3W+BAzidDUAPlwJnwNR/p7Fl+aIszgcxepQJAADFC29brSWm63vrDw5DzyYDhy39WijygcCV7IBLJBmDVFwgQQLBSfQK9PT2AAOxXgABigjYtQePWG0aApzfAJhQBAogJrar6MIw9/QG5OgYIICakDsVDHAMIw8HT4KoYuVkLEEBMePrRw83TKMtEAAKICUtXciHM88PI0xjr4QACiAlHP3rh/T9cCbmfDD4M8TwdgM3TIAAQQDg7Keoejxd+/s9qwEDetM2Al96g3iS+VVAAAUTUGhiTlSGUjGjSswED8vAEYtbAAAQQSevcgAEAayo6QDsFDgPs8QcMiKmoDaQMRgAEGADHTLziPW4o6AAAAABJRU5ErkJggg==" width="62" height="50"></th></tr></thead><tbody><tr><td>Root Account</td><td>Super Admin</td></tr><tr><td>IAM User</td><td>Member</td></tr><tr><td>IAM Policy</td><td>Role (Collection of Permissions)</td></tr><tr><td>IAM Policy Attachment</td><td>IAM Role Binding (or IAM Binding)</td></tr><tr><td>Key Management Service (KMS)</td><td>Cloud KMS</td></tr><tr><td>CloudHSM</td><td>Cloud HSM</td></tr><tr><td>Amazon Inspector (agent based)</td><td>Cloud Security Scanner (scan based)</td></tr><tr><td>AWS Security Hub</td><td>Cloud Security Command Center (SCC)</td></tr><tr><td>Secrets Manager</td><td>Secret Manager</td></tr><tr><td>Amazon Macie</td><td>Cloud Data Loss Prevention (DLP)</td></tr><tr><td>AWS WAF</td><td>Cloud Armour</td></tr><tr><td>AWS Shield</td><td>Cloud Armour</td></tr></tbody></table><p>‚Ä† No direct equivalent, this is the closest equivalent</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/amazonwebservices">amazonwebservices</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/aws">aws</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about The Ultimate AWS to GCP Thesaurus" href="/ultimate-aws-to-gcp-thesaurus"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/google-cloud-storage-object-notifications-using-slack">Google Cloud Storage Object Notifications using Slack</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-11-09T00:00:00.000Z" itemprop="datePublished">November 9, 2019</time> ¬∑ <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/Slack-GCS-Image.png"><div class="markdown" itemprop="articleBody"><p>This article describes the steps to integrate Slack with Google Cloud Functions to get notified about object events within a specified Google Cloud Storage bucket.</p><p><a target="_blank" href="/assets/files/Slack-GCS-6de5cb5ede305869300f0f933537e240.png"><img alt="Google Cloud Storage Object Notifications using Slack" src="/assets/images/Slack-GCS-6de5cb5ede305869300f0f933537e240.png" width="560" height="341"></a></p><p>Events could include the creation of new objects, as well as delete, archive or metadata operations performed on a given bucket.</p><p>This pattern could be easily extended to other event sources supported by Cloud Functions including:</p><ul><li>Cloud Pub/Sub messages</li><li>Cloud Firestore and Firebase events</li><li>Stackdriver log entries</li></ul><p>More information can be found at <a href="https://cloud.google.com/functions/docs/concepts/events-triggers" target="_blank" rel="noopener noreferrer">https://cloud.google.com/functions/docs/concepts/events-triggers</a>.</p><p>The prerequisite steps to configure Slack are provided here:</p><ol><li>First you will need to create a Slack app (assuming you have already set up an account and a workspace). The following screenshots demonstrate this process:</li></ol><figure><a href="/assets/images/slack-notifications-setup-1-4922d02dd437b80334c8b3b85d25a94b.png"><img src="/assets/images/slack-notifications-setup-1-4922d02dd437b80334c8b3b85d25a94b.png" alt="Create a Slack app"></a><figcaption class="figure-caption">Create a Slack app</figcaption></figure><figure><a href="/assets/images/slack-notifications-setup-2-82f83d053fab9830256ca8ecaaa8f33a.png"><img src="/assets/images/slack-notifications-setup-2-82f83d053fab9830256ca8ecaaa8f33a.png" alt="Give the app a name and associate it with an existing Slack workspace"></a><figcaption class="figure-caption">Give the app a name and associate it with an existing Slack workspace</figcaption></figure><ol start="2"><li>Next you need to Enable and Activate Incoming Webhooks to your app and add this to your workspace. The following screenshots demonstrate this process:</li></ol><figure><a href="/assets/images/slack-notifications-setup-3-6dec01da96437a43cf7c4e4d948e0dd6.png"><img src="/assets/images/slack-notifications-setup-3-6dec01da96437a43cf7c4e4d948e0dd6.png" alt="Enable Incoming Web Hooks for the app"></a><figcaption class="figure-caption">Enable Incoming Web Hooks for the app</figcaption></figure><figure><a href="/assets/images/slack-notifications-setup-4-95fc759fc0221afdffaa694b14245feb.png"><img src="/assets/images/slack-notifications-setup-4-95fc759fc0221afdffaa694b14245feb.png" alt="Activate incoming webhooks"></a><figcaption class="figure-caption">Activate incoming webhooks</figcaption></figure><figure><a href="/assets/images/slack-notifications-setup-5-2b9b7c134f51bbd0393068a614b5469c.png"><img src="/assets/images/slack-notifications-setup-5-2b9b7c134f51bbd0393068a614b5469c.png" alt="Add the webhook to your workspace"></a><figcaption class="figure-caption">Add the webhook to your workspace</figcaption></figure><ol start="3"><li>Next you need to specify a channel for notifications generated from object events.</li></ol><figure><a href="/assets/images/slack-notifications-setup-6-3b3d2000288499a7cdb60c2cf7af04c5.png"><img src="/assets/images/slack-notifications-setup-6-3b3d2000288499a7cdb60c2cf7af04c5.png" alt="Select a channel for the webhook"></a><figcaption class="figure-caption">Select a channel for the webhook</figcaption></figure><ol start="4"><li>Now you need to copy the Webhook url provided, you will use this later in your Cloud Function.</li></ol><figure><a href="/assets/images/output-onlinepngtools-7bfe4ca076a72230bcf2aa722f6e61c0.png"><img src="/assets/images/output-onlinepngtools-7bfe4ca076a72230bcf2aa722f6e61c0.png" alt="Copy the webhook URL to the clipboard"></a><figcaption class="figure-caption">Copy the webhook URL to the clipboard</figcaption></figure><blockquote><p>Treat your webhook url as a secret, do not upload this to a public source code repository</p></blockquote><p>Next you need to create your Cloud Function, this example uses Python but you can use an alternative runtime including Node.js or Go.</p><p>This example templates the source code using the Terraform <code>template_file</code> data source. The function source code is shown here:</p><iframe width="100%" frameborder="0" id="gist-e248abd1af393e58de84e8776161c8cb"></iframe><p>Within your Terraform code you need to render your Cloud Function code substituting the <code>slack_webhook_url</code> for it&#x27;s value which you will supply as a Terraform variable. The rendered template file is then placed in a local directory along with a <code>requirements.txt</code> file and zipped up. The resulting Zip archive is uploaded to a specified bucket where it will be sourced to create the Cloud Function.</p><iframe width="100%" frameborder="0" id="gist-e247d09d33a4aca9154de081f3063978"></iframe><p>Now you need to create the Cloud Function, the following HCL snippet demonstrates this:</p><iframe width="100%" frameborder="0" id="gist-87e2e83e5b2b800d685a8d239280ca13"></iframe><p>The <code>event_trigger</code> block in particular specifies which GCS bucket to watch and what events will trigger invocation of the function. Bucket events include:</p><ul><li><code>google.storage.object.finalize</code> <em>(the creation of a new object)</em></li><li><code>google.storage.object.delete</code></li><li><code>google.storage.object.archive</code></li><li><code>google.storage.object.metadataUpdate</code></li></ul><p>You could add additional logic to the Cloud Function code to look for specific object names or naming patterns, but keep in mind the function will fire upon every event matching the <code>event_type</code> and <code>resource</code> criteria.</p><p>To deploy the function, you would simply run:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">terraform apply -var=&quot;slack_webhook_url=https://hooks.slack.com/services/XXXXXXXXX/XXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now once you upload a file named <code>test-object.txt</code>, voil√†!:</p><figure><a href="/assets/images/slack-notification-296ef71c70119965cb16d4fe536b1fbe.png"><img src="/assets/images/slack-notification-296ef71c70119965cb16d4fe536b1fbe.png" alt="Slack notification for a new object created"></a><figcaption class="figure-caption">Slack notification for a new object created</figcaption></figure><blockquote><p>Full source code is available at: <a href="https://github.com/gamma-data/gcs-object-notifications-using-slack" target="_blank" rel="noopener noreferrer">https://github.com/gamma-data/gcs-object-notifications-using-slack</a></p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gcp">gcp</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/slack">slack</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/terraform">terraform</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Google Cloud Storage Object Notifications using Slack" href="/google-cloud-storage-object-notifications-using-slack"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a href="https://stackql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>StackQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.windrate.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>WindRate<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"></div></div></footer></div>
<script src="/assets/js/runtime~main.514001fd.js"></script>
<script src="/assets/js/main.731b638a.js"></script>
</body>
</html>