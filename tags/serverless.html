<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">2 posts tagged with &quot;serverless&quot; | Full Stack Chronicles</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://fullstackchronicles.io/img/fullstackchronicles-cover-image.png"><meta data-rh="true" name="twitter:image" content="https://fullstackchronicles.io/img/fullstackchronicles-cover-image.png"><meta data-rh="true" property="og:url" content="https://fullstackchronicles.io/tags/serverless"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="wot-verification" content="e7522390be4370727fac"><meta data-rh="true" property="og:title" content="2 posts tagged with &quot;serverless&quot; | Full Stack Chronicles"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://fullstackchronicles.io/tags/serverless"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/tags/serverless" hreflang="en"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/tags/serverless" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://MZCGVO503N-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Full Stack Chronicles Blog Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Full Stack Chronicles Blog Feed Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Full Stack Chronicles Blog Feed JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0FVDC1E8G6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0FVDC1E8G6",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Full Stack Chronicles" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.e97cb5a8.css">
<link rel="preload" href="/assets/js/runtime~main.52f4ef37.js" as="script">
<link rel="preload" href="/assets/js/main.cd73ca56.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Full Stack Chronicles</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/tags">Topics</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/snowflake">Snowflake</a></li><li><a class="dropdown__link" href="/tags/okta">Okta</a></li><li><a class="dropdown__link" href="/tags/openapi">OpenAPI</a></li><li><a class="dropdown__link" href="/tags/spark">Spark</a></li><li><a class="dropdown__link" href="/tags/kafka">Kafka</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/create-and-use-custom-magic-commands-in-jupyter">Create and use Custom Magic Commands in Jupyter</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/deno-in-five-minutes">Deno in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/dbt-in-five-minutes">DBT in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/loading-parquet-files-into-snowflake">Loading Parquet Files into Snowflake</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/analyze-developer-activity-with-stackql-jupyter-bigquery">Analyze Developer Activity with StackQL, Jupyter and BigQuery</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/converting-google-discovery-docs-to-openapi3-specs">Converting Google Discovery Docs to OpenAPI3 Specs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/recurse-javascript-object-to-get-values-for-a-given-key-the-easy-way">Recurse JavaScript Object to Get Values for a Given Key the Easy Way</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/dataops-with-container-images-and-multi-stage-builds">DataOps with Container Images and Multi-Stage Builds</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/using-the-snowflake-sql-api-with-typescript">Using the Snowflake SQL API with TypeScript</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/split-a-large-swagger-openapi-specification-into-smaller-documents">Split a large Open API or Swagger Specification into smaller documents</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>2 posts tagged with &quot;serverless&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/aws-transfer-for-sftp.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/implementing-a-serverless-sftp-gateway-using-the-aws-transfer-family">Implementing a Serverless SFTP Gateway using the AWS Transfer Family</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-02-23T00:00:00.000Z" itemprop="datePublished">February 23, 2022</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><blockquote><p>When you want the SFTP service without the SFTP Server.  </p></blockquote><p>In implementing data platforms with external data providers, it is common to use a managed file transfer platform or an SFTP gateway as an entry point for providers to supply data to your system.  </p><p>Often in past implementations this would involve deploying a sever (typically a Linux VM) and provisioning and configuring an SFTP service.  If you wanted the data sent by clients to be copied to another storage medium (such as S3 or EFS) you would need to roll your own code or subscribe to a marketplace offering to do so.  </p><p>I recently trialled the <a href="https://docs.aws.amazon.com/transfer/index.html" target="_blank" rel="noopener noreferrer">AWS Transfer Family SFTP gateway</a> offering from AWS and sharing my adventures here.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="architecture">Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">​</a></h2><p>In this reference architecture, we are deploying an SFTP service which uses a path in an S3 bucket as a user’s home directory.  Objects in the bucket are encrypted with a customer managed KMS key.  The SFTP server front end address is mapped to a vanity URL using Route53.  The bucket and path are integrated with a <code>STORAGE INTEGRATION</code>, <code>STAGE</code> and <code>PIPE</code> definition in Snowflake.  The Snowflake bits are covered in more detail in this blog: <strong><a href="/tags/automating-snowflake-role-based-storage-integration-for-aws">Automating Snowflake Role Based Storage Integration for AWS</a></strong>.  This article just details the AWS Transfer Family SFTP setup.</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Architecture</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PlantUML</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p><a target="_blank" href="/assets/files/aws-transfer-sftp-architecture-7964e0e7ee271b7c690605e7cfa8a72d.png"><img loading="lazy" alt="AWS Transfer SFTP Architecture" src="/assets/images/aws-transfer-sftp-architecture-7964e0e7ee271b7c690605e7cfa8a72d.png" width="1014" height="725" class="img_ev3q"></a> </p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skinparam rectangle&lt;&lt;boundary&gt;&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Shadowing false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StereotypeFontSize 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FontColor #444444</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BorderColor #444444</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BorderStyle dashed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skinparam defaultTextAlignment center</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!$imgroot = &quot;https://github.com/avensolutions/plantuml-cloud-image-library/raw/main/images&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $AwsS3($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;AWS S3&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/aws/Storage/S3.png&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $Kms($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;AWS KMS&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/aws/SecurityIdentityCompliance/kms.png{scale=0.80}&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $Route53($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;AWS Route53&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/aws/Networking/route53.png{scale=0.80}&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $AwsTransferFamily($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;AWS Transfer Family&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/aws/MigrationTransfer/TransferFamily.png&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $Data($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;Data&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/general/documents.png&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $Snowpipe($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;Snowpipe&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/snowflake/snowpipe.png{scale=0.60}&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!unquoted procedure $SnowflakeDb($alias, $label, $techn, $descr=&quot;&quot;, $stereo=&quot;Snowflake DB&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rectangle &quot;==$label\n\n&lt;img:$imgroot/snowflake/snowflakeDB.png{scale=0.70}&gt;\n//&lt;size:12&gt;[$techn]&lt;/size&gt;//&quot; &lt;&lt;$stereo&gt;&gt; as $alias #white</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">!endprocedure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Data(supplier, Data Supplier, External Client)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rectangle &quot;AWS Environment&quot; &lt;&lt;boundary&gt;&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $AwsTransferFamily(sftpgw, SFTP/FTPS Gateway, AWS Transfer Family)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $AwsS3(s3staging, Staging Bucket, AWS S3 Bucket)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $Kms(kms, KMS Key, Customer Managed Key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $Route53(r53, CNAME Record, Route53 Record)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rectangle &quot;Snowflake Environment&quot; &lt;&lt;boundary&gt;&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $Snowpipe(snowpipe, Snowpipe, Snowpipe)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $SnowflakeDb(db, Snowflake DB, Snowflake DB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r53 -[hidden]D- sftpgw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">supplier -&gt; r53 : resolves name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">r53 -&gt; supplier : gets address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">supplier -RIGHT-&gt; sftpgw : SFTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sftpgw -DOWN-&gt; kms : uses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sftpgw -RIGHT-&gt; s3staging: writes to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s3staging -RIGHT-&gt; snowpipe: writes to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">snowpipe -DOWN-&gt; kms: uses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">snowpipe -RIGHT-&gt; db: writes to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="setup">Setup<a class="hash-link" href="#setup" title="Direct link to heading">​</a></h2><p>The steps to set up this pattern are detailed below.  </p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>This example uses the Jsonnet/CloudFormation pattern described in this article: <strong><a href="/tags/simplifying-large-cloudformation-templates-using-jsonnet">Simplifying Large CloudFormation Templates using Jsonnet</a></strong>.  This is a useful pattern for breaking up a monolithic CloudFormation template at design time to more manageable resource scoped documents, then pre-processing these in a CI routine (GitLab CI, GitHub Actions, etc) to create a complete template.</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="setup-the-service">Setup the Service<a class="hash-link" href="#setup-the-service" title="Direct link to heading">​</a></h2><p>To setup the SFTP transfer service use the <code>AWS::Transfer::Server</code> resource type as shown below:  </p><iframe width="100%" frameborder="0" id="gist-c8b4ce8ab478715753aab73d478f4fcd"></iframe><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>Use the <code>tags</code> shown to display the custom hostname (used as a vanity url) in the Transfer UI in the AWS console.</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="create-the-s3-bucket">Create the S3 Bucket<a class="hash-link" href="#create-the-s3-bucket" title="Direct link to heading">​</a></h2><p>Create a bucket which will be used to store incoming files sent via SFTP.  </p><iframe width="100%" frameborder="0" id="gist-82eb106bc13f1a888f823cc71a7ff933"></iframe><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>This example logs to a logging bucket, not shown for brevity.</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="create-a-customer-managed-kms-key">Create a Customer Managed KMS Key<a class="hash-link" href="#create-a-customer-managed-kms-key" title="Direct link to heading">​</a></h2><p>Create a customer managed KMS key which will be used to encrypt data stored in the S3 bucket created in the previous step.  </p><iframe width="100%" frameborder="0" id="gist-2c563411442c4541584815389de8a3b5"></iframe><h1>Create an IAM role to access the bucket</h1><p>Create an IAM role which will be assumed by the AWS Transfer Service to read and write to the S3 staging bucket.  </p><iframe width="100%" frameborder="0" id="gist-57e23a5c99c22f5550e99b086db5f9f1"></iframe><div class="theme-admonition theme-admonition-important alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>You must assign permissions to use the KMS key created previously, failure to do so will result in errors such as:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">remote readdir(): Permission denied</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="user-directory-mappings">User Directory Mappings<a class="hash-link" href="#user-directory-mappings" title="Direct link to heading">​</a></h2><p>An SFTP users home directory is mapped to a path in your S3 bucket.  It is recommended to use the <code>LOGICAL</code> <code>HomeDirectoryType</code>.  This will prevent SFTP users from:</p><ul><li>seeing or being able to access other users home directories</li><li>seeing the bucket name or paths in the bucket above their home directory</li></ul><p>There are some trade offs for this which can make deployment a little more challenging but we will cover off the steps from here.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="create-a-scoped-down-policy">Create a Scoped Down Policy<a class="hash-link" href="#create-a-scoped-down-policy" title="Direct link to heading">​</a></h3><p>A &quot;scoped down&quot; policy prevents users from seeing or accessing objects in other users home directories.  This is a text file that will be sourced as a string into the <code>Policy</code> parameter of each SFTP user you create.</p><iframe width="100%" frameborder="0" id="gist-5e876bbf95b1b36355fa8af868572a26"></iframe><div class="theme-admonition theme-admonition-important alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Using the <code>LOGICAL</code> <code>HomeDirectoryType</code> you don&#x27;t have access to variables which represent the bucket, so this needs to be hard coded in the <code>policy.txt</code> document.  </p><p>Also if you are using a customer managed KMS key to encrypt the data in the bucket (which you should be), you need to add permissions to the key - which again cannot be represented by a variable.  </p><p>Failure to do so will result in errors when trying to <code>ls</code>, <code>put</code>, etc into the user&#x27;s home directory such as:  </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Couldn&#x27;t read directory: Permission denied</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Couldn&#x27;t close file: Permission denied</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since these properties are unlikely to change for the lifetime of your service this should not be an issue.  </p></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="create-a-user">Create a user<a class="hash-link" href="#create-a-user" title="Direct link to heading">​</a></h3><p>Users are identified by a username and an SSH key, providing the public key to the server.  A sample user is shown here:  </p><iframe width="100%" frameborder="0" id="gist-1b946b07374b78e0aca380317729bfa9"></iframe><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>As discussed previously, it is recommended to use <code>LOGICAL</code> home directory mappings, which prevents users from seeing information about the bucket or other directories on the SFTP server (including other users directories).</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="create-a-route-53-cname-record">Create a Route 53 CNAME record<a class="hash-link" href="#create-a-route-53-cname-record" title="Direct link to heading">​</a></h2><p>Ideally you want to use a vanity url for users to access your SFTP service, such as <code>sftp.yourcompany.com</code>.  This can be accomplished by using a Route 53 CNAME record as shown here:  </p><iframe width="100%" frameborder="0" id="gist-0098851edc8d60b45534f6b1134be8cd"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="create-some-shared-tags">Create some shared Tags<a class="hash-link" href="#create-some-shared-tags" title="Direct link to heading">​</a></h2><p>You would have noticed a shared <code>Tags</code> definition in many of the <code>libsonnet</code> files shown, an example <code>Tags</code> source file is shown here:  </p><iframe width="100%" frameborder="0" id="gist-8323d49f1045d2cd8c874d5a00e82a5e"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="pull-it-all-together">Pull it all together!<a class="hash-link" href="#pull-it-all-together" title="Direct link to heading">​</a></h2><p>Now that we have all of the input files, lets pull them all together in a <code>jsonnet</code> file, which will be preprocessed in a CI process to create a template we can deploy with AWS CloudFormation.  </p><iframe width="100%" frameborder="0" id="gist-f56065c075af9cc33853b0624f6ef636"></iframe><p>Your customers would now connect to your service using they private key which corresponds to the public key they supplied to you in one of the previous steps, for example:    </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sftp</span><span class="token plain"> -i mysftpkey jeffrey_aven@sftp.yourdomain.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Add more users and enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/aws">aws</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/aws-transfer-family">aws transfer family</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/serverless">serverless</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/snowflake">snowflake</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/snowpipe">snowpipe</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/sftp">sftp</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/managed-file-transfer">managed file transfer</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/images/api-management-function-app.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/using-the-azure-cli-to-create-an-api-using-a-function-app-within-api-management">Using the Azure CLI to Create an API using a Function App within API Management</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-01-06T00:00:00.000Z" itemprop="datePublished">January 6, 2021</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="API Management Function App" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGUAAABzCAYAAACB88xJAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAaiklEQVR4Xu1deXxU1b3//s6dJOxSJWHRPheWCYrLR1GSCSBBQQgTtVYgwQ23BJdn+2y1VesTW6V20ba0QoJWrUsmgM8WSHBp3wMrWUBQgkWSoIKKQCuQCZBAMvfe3/ucyWS4M5mZe2fJQurvv+T+zjm/8/vOWX/LIfy7EjPNLau/gMCZIJpAwLkATgPoVIC/BeAogBaA9jH4U2KuB6jSlqxUvnLVqH91ptqoMyvviXXfuOqTUZqi3QTgZgBnxSCjDqCSGMs9fWyvrJw2sjGGOiIW+bcBJe/NHWeRJhYByAOQqH4fBvAcGE+5cu0HEgVOooRLlDwJr2f2iu3Jtr62x0H4LwApCW+grcJDAB51zRqzFEQcbxu9GpR55R+fyawsBzAhgqLk2vE+GBtZ0EeC8S9AawDzYRANYqJUsBhNzJcyYSqA08PVRYw3PYq4ZWXO6K/jAabXgpK/ZmcmSC8DcGoIBWkA3gLxyyn9Ula/lH32cUtKZKb8NfVZRChg8k6DScHlGNglWLuqJPfcnZbqDMHUK0HJK68dT0x/A3BKxz7T2zrUHy53nvuPWJUmy920uvZsVdDTAL7ToR7vaMPlrlx7bSxt9DpQ5pbVjxXgDR1HCDUQ6beWzEpfFYuiwpXJL6/PB3MRgEFBPLsVm+Z4dca5+6Jtr1eBMnPtzpTBul4N4KIgRdQQ6LoS55jPolWQFf4bynecr7N4s8N6Q/yu2mS/YuUcktOlZepVoOSX1f0awA8Cek/YltKafPlL3znbbVkrMTD6zj9yhA4NKM542JVr/3k0VfYaUPJX1V4AhT4EINoVIBddm03LimUKiUaJ7bx55fUTiPnvAJLb/0fgZo+eNHbl1SO/sFpn7wGlrH4FwLMNHdeF4Mmv5aRXWFVGIvjyy+sfAPMvg0bry65Z9lus1n/SgHLD2p2DNF0dR6BzCKKfzsyKoH26RrtY0foS00bjKAGwxOW032NVEYnim7JunW1404gPAJxvqNPDqjKy9NpRX1ppp0eDcsPanWewrt/MoOsAlou3YqVTAJpSPMlndPY6EnZHtqbuWhD+HPidn3Q5039iRf4eCYoEQ9f1JwDMC3VAM+0Y43lXrv1OU77OYpCHzPKddQCPNqxvn5Q67f6/IzXd40DJK6+fR8zLAPSPVWdMfGnprPTNsZZPRLm88rrHiLHQWJcO7Xwrh9YeA4qci4c1nf4EgX8Up1I+dzntsVzJx9lsYHHfrcL7xv8S+O4SZ/pSs4Z6BCgFmzcnHfnnwBVgXBtG4EZirNbBqwn0j746f3Wkxd6M/h+nJrE4XWc6m4S4FIwcBq8vddr/06zjnf199gpWbP3qGwAMNLT1J5fTPt+s7R4Byrzy2qXMtCCEsMdBtJj4+FMlzgtkB01Jjrj12dmqKWMXMOSX1cmRMt6wrlSUOu0TzZrudlDyy2vngElerwfTPmJcW5Jr32TWiZ76Pa+s7n8IuM4g316X0x726r+dr1tBmf3XT0+xtah1Ha4mgP1EWkbJrHM/76kKtyJXflndSwCMh8Yml9M+wKxst4KSV17/E2L+WZCQrQw9u9Q5ttJM+J7+Pb+s/lWAbzDIyfbNY2wLF5K084elbgPFd/KV90HDjdIR8JsSp/3+nq5wK/Lll9X9FcCVRl7XrDHCzGTcbaDkl9fOAJO87jZSky1JOaezXXisKDQRPPll9fXGAyQAt8tpl+5LEakbQal7GoygEUGvu5xjjJeKZvJH/X32ii/7pgw6MlhXbX1trVrjy9eNPRh1JRYK3PzGjtM8yULa6o063gvwj2xJtnci/fC6D5SyuncBTA7q33yX0/4nC322zDJ37c6Riq7PBWMiA5eAkBY8OgFsB9F66PQXV+7oKsuVR2C8obzeqTOvCcPiAWiFoomFr14z6pNgnu4EZW/weqKzuGR57mh5wxo3zSuvn8xtm4hg4M3qrgXTL/cN+OqVeM47+WV1iwGYHWKPAfywy5n+26B11UzGzvmeX1bXDKCvsXbW+PTSa9IlWHHR7NWf/odNqNKbxG9sirpCwjZBovC1nNHSvBw1hVhPItWxxDVrzL3tG4DuHCmtwTfASa36kETN8flldY8D+O+otRlYQAXzI67c9ECjlUmlftMwYy8E7wHTfgaSCBgL4LJQHpoEPFLitEsPzoS5b0bd9/yyOrnABvhkWb1FtdKYz4lCmoelIox0DMA+gDQwnxJijelQPREXleTY7zbbylqRa155/UUM/hMYFwTxq9DFRa6rR2/vtpEyr6x2C4MuDpi+wNeUOtNXW+mcFZ4b1tZm6TpJm/n7THjFpipvj/pw5GfGw5v3dvrosIkklJnQeX44kBj0i1LnmB9badeMx3eTIafF9EBeWulyjpnTbaDkldW9SEDQjSkXu5zpoS4mzfoZ9vsNa3ee+1rO6I+tVHDbqtqBzYp4wGc+6LAeMaOgNNf+nJW6zHjmldVfyWB5uAwYxS6nvV/3gVJedxMxXg4Sar9biLPezBndYtapzvzuG2HlITwsm2w6n//K1em74m7fa52sl456AS5JLqedug0U3xCWQgXuwAj3l86y/ybuToeoYMHIh8dBo6lE+rcZohWsf6GQeOvZXU92uPj0banfCfbUJ+J3SmalX5UI+fLL6qSzh1z4/dStoEgp8srqigkoCOrgQZVx4cpc+1eJ6Lis4+6Rjzh0naXfb0aYOlcxiQeKP3siwCk7r200y8NswI+XGBMSYVLIL6vbDeDMHgXK7PLtw2xsqw+yzkkZN6vN/SavnPNtuVOKixac9VAhiP4AwGZSUaOAPmfJrqfk6PDTvDW1rzGRdODwEzGXlOSmG29/o5bRuwtjlrtDI7W6nPaUbpu+2iXJL6t/BGDpuRJM65Ja9dnxnFsKz3noOmJaGeQPFlaBBDQRY+KS3Yu2tjP5DqLSe94/zUqvxwHDjg5eNn68J2o0AHjN3/sHyqiA4NuGdS6nfWq3g+ITcG3wFbevs5+BaIFr1pjgXYqpLu4+b+EAvdmzE+BhpsyBDJuKdi2S05w/IiuEXQS6jsuWX20PcIyw0s6Nb308XFO9gUyTgvmJ+caS3PTXuh0UKdj8P+8a3JLUKo1awQe9drn/yszLtGPaWyvnnCcjr0zprrMfvocBOW1FTyyyi3Y/sb69YN6auu8Q4Y3Aiuh1gh6VGxODZERZTpgwvx1q85jzpYd+jwBFdtY3TciD44URtCgjrnYSYw8TRQSn/6/WTLJ9cTDaUeJtmsDPLN31c7/3fv6qz4ZC8eyPHl3LJVp0Fo72y9geA4oUP3fN3n4D6MgffRG8lnsUinHg429AHDgSax2ri3Ytuqa98MKFLOrG18tNR+wXnOElaWFGfmmu3e/m2qNA8crNTPPK6+cy6KdBVruoFDzw0dch3E1RlTEwv120a9EMY+H8sjoZkn1arBWGKVcvBN8WHBnQ80DxSS83AIf3DZxP5L2KkXOxVedubw0DnnkTyq7YEkMQ6I9Ldz15R7sifZsROXX6Y1/iAEdjwgfQ+YU+A1JeChUE22NBMXZ69tqdqTZdzyHmi3UZCkEk3XSMnocddNT39U0jkt/9OMApw7IiGflFuxeVtvP7gk6DQ/MeI+jyKsYyaSzUZgzcuSZ3hLQlhaWTAhTLvTYw3j3yx6N0XWyPfh2g/U3NLaNe+eev/XNffnl9oS/Y1N+Czrhoea69JhbZzMr0WlBkxwvPefgpYkTlME7ATUt3LXo1aD2R8fizDP87PnDYkUGxHh7/rUGZjdnKqeeMfl26v5opwvud6ami3U8+ZOSdu2bnxYJ0eUg0xlK+Ueq0f9dSnTEw9eqRIvUhgTntnNGPgvFg8I20QV8HQXiw6LNFLwSsZStYUfrVv0tAlvH/RHxtouPxA+qPAciTssgdox48w6YrN4JxBUCnM7MuiD7Tid7qqyeV/Hb3wsCQbmbKK69fTMC9gQrjLwYMOzqqs6Yu2VavHymx/ILatsCDigC+Lbg8M/JKc+2hogRiaSpkmW4DRatJvY9BvzPtSasOarR4GUv4QExtHE904jJR3hKYbUGNMkjPRjVZLGfIERVExO+6cuzZiXCgiNTvbgNFrUnrYHULJSi5PYAnopN6WzFCi+gjxlNWgz8RztzyHWMEiyomLCYdz0ZKlCbdWW39mu8G8HCYzEd7WOMJifBLM/shdgsovD11lKaSNG5Fbl9j0CHpHmaBiB5XrnCfCPyUNvC1devAdLmvtMwH+TYIG4jxKYDDAA/RCcNJ2jUY0yIEvx5lISaX5owONkpZECx6lm4BxVOTtpCAx8zEpSMqcNw81wwJ+gcdcF9Ec+BnDnXgM2sv9HdqEELP7crMFd0FSh0BYyIqSZejxCMvKM106REpSZk06cCWdsa8VbUjSCHpVhQi35dZdSe+M0l/MZG/PGe0HFldRl0OSmvN0AwBNvdsb9JAzRbiSYX4uTK1Qa4DfpK7p6P7B8hMFTLDQyzh218D9LN9/b9aGo+Td6wodjko6tahvwdxwN4/5AJ/sBXQTUYJ0cdCuC+kbIRET3o/jmgePotZ3AbwdAB9IihKA/EGYlFyhAe8Gs2OLVblhyvXpaDwOti0U9P2hAg8DZTvuAbvehKZPBrZJiZfcdBS9PD8dbv6tBxRJ7DCFwpdT2USAwj6fgbtZ8aefjpveuGa9JitYmbCRvO9S0FRPxwyC0LIy72I5N1xaZFHiVDoacp2/9CsrpPxe9eCUpNWAiA/oqKsHBaJPhEt7nGUI9Oe9z7qMlC4Zmh/DSydDyLGkXtP760RDosETbfR1KTL3dKbvldSQkFxFFdM10mkHhk8aOX2OecFnPrUrWk3gTo4dAcqVWVQg8lh0Ua/V6a472sveEnx5qRkbr2eBbmrCzKDo41PStASBkpmcaWMdnrAqwXCy1UFjoD0fGpN2lsAIjpGmx0WSdCnRIPHUfZuf3LnjKKqZUTsze3FoMXVBRnf7+y7qc5GOn5QmClzWZUMujRucz+tKnSMaheea4amaWDpsB3en9fssCinLYWmJU1xrzMqJbO4Upp85TMbXmKm56r3ZyyASVaHzlZsPPXHB8pCFo7hlcUM8nt+QJ4uiG6uLsh8rV0wrWbo9xkcObzB5LDICopt2Y0dAoocRRXXM5F0cjB6u7xyxrf23LpyzhzzO5p4tNdJZWMGZfaKFcqehjOk45xxmpKA3F5dkCkTxfhJrRn6PsD+FEsd+sJou3gMd1gk+kKc0m8sjd8b0gsks7hSJkSQPwJ/7nkCrz6lpXHOm/flnHQ7tJhA8S6u1FoCxvUGBcsJ6LbqwsyA5AT8YepoTXhvhMPTMQ10NPRhkeVSYROzbFMaIi7ijuKKWQx63XhqZ6K1fZKOf3f9rdnWHhjopF9+tNVGDcp5K7YnD2polJY3ozOCvGS/PRgQKYxnW9pPifFoJMGowQOoobfBLOhF21R3BwtgqPoyiypnoM0R+0R0GGF9iqcld/092ZYcw6NVYGfwRwXKJcWb+yWjVfq8ynsk/5IBxm1VCxzB8Yve756atHoCwmcZjXRYJNojRNJYyv7askIzl1VeDoa8NThxHmK8p7cK58b7MuTLQD2eLINywcs1/fs3N61G28MufkCIeX7lgqwAP6n2j56P0hykI2IG7XCHRe+0pYirbdkNptcywVrOem7DJF0X0nvR6EW5GQquqrrDIV8F6tFkCZQpL64b3NKaIgN7Mq0CIvnUmrRnZchhWA3Iw6K71RCec4KThXjNNrXhxli1l1W0YbxO4u0g0+6HrUievqVwfMLez4pVvojTuVmlE5e89y1NUWTnLjUCwkS3GLe9wfXwZiRpSWkyz8qQcG2EPSwSNCjiF75n/cxEDPguBMppcsM2+c+M4qqLCSxjGI3e8juETb+y4vaJceeAiUqwKJgjjpQJz1UPFbouQ9uMedvl3v/mqkKHvFwMPwi2DnWCwqZW8o4OOiCvVEwti5a7w4TPFZE8zrgGOZZVXMRMEphUQ0V1uhBXbrwzQ5oRehyFBWVS8d+Hq7DJYEn/aVmu29JHrXpBZlCoWcd+qTWpLoDku1WhKcI2OEYtefR+ypQkx6EOuScznqsaSzrLvoww1P05ga+oLMzqUlOvlb6FBMXxfMWZrNH/AhhpqMQDwtyqAkdQYv2OzXDtkIFai5A3wv1CCmF2WLQieTCPojyhZB8Ku/XOWrLBritC9smfgpbAX2qsXLFxQUbMj5rFIqpZmQ6gXLZs4xiFNSn8GYbCcp6ZW1Xo+ItZhfK7WpN6C0ABp/qActYsi1aa8vKQwCbKbswwOuGFKpyxtOosEvx/AM42fP8ngGlVhY6PLDfYyYwBoGQt23CezkIOc2MAZyszXV+9IDNc6r0OIqpb094Bef2oQlOzBlLlptdkPZGfjSya3mEJYuCw4qELaaZbZm8wJR8w8kd3joH5a4W1aRsWTOqUeBNToYIY/KBkFlfKNEfyV2SMfmplotnVBZmW0z3x5iHDtSQhH2+JKhzOVPAwh0xW6FZbtjv8qAxR8aXPbhpms6kSGON66Sbi6ZUFWVHHxpvKHiWDFxTfQigBCRwhUQIi69K2pt3PBJkHJaHkNX7J0WUgVsRKW3bDnFgaCrOzdEPHVVV3OSw5Y8TSrpUyNLHovQt1En9jkPE8cZyJrovFkqfVpG1hICC5mhVBIvKEWoOIvhIC4yjbHfOrdI6lFWksSG75jVnqGgTr0ysWTIwqcUHcfTRUQJnFlXIeDUidR+DHKwuzAh5ksdIobzstXWNlhxVeyzyhdmpEqg7lqqQrDsrRHRdNKKoeLUgPuMUmcH1lYZY9rorjKCxBke+pB77mybijaoFD2kqiIk9N6hMEeiSqQmbMoYxfiviFkt2QkNSBvktW6e9lDMc+XlXoCMhDZiZmIr9TRnHVgwSWVxpG2gEFE6O9vOPtqcOgidBnExIpHvaE/CZYyKdjOz5hEcpELLBFZDdOIHkVkwDKLK58BvA+i26kh6oKHU8loPqYqvAu9I5lFYuZKTix8VbNo1y56d4JnZJ2vF3alo/SLlB0hNyKBt+NMVGTkmy7mCYdiGw0s6iKjGVVPyPmwBflCI9VFTh+arGKTmHzguIz7a5A4AMs8lOnA+OpSX2SQAEO2t6ehrpBVsRdSnaDfDw5bnIUVzzJge3Krd39VYWOgGzacTcUQwUnzinPVPal/vwOg4KfJ/oQCq6MdiqzKou6NW0nCH7Pl/ZywRFcZKM3xBR3/GHSbd43csr6vkFGCch9VYWO2FJRWe2sRb6AE33m85WnkoZ3vIn6A+n9lOSW6etvzY55+xlKntatwy4TpMswu0Bq0UGHDXGORHtFMo+jSY2W3uUK2/fQ7lBhTdkWdZhwtg53X1OeXTegRUlZFWRhlA1/AAXTEjliPNvSnqbg5zrkFlgeFNsdvKW/l7DNSMo+KK9/YqcwgEQyZcfeWHwlQ94Sh7HFe4FRNO3KDXdPiu8X63Wag9C2pcnUs8aLTyD4Sl/QM8pUd+Bz5tH2mZkyiqv/QMRGK6gWyZQdbROJ5A9rT/F5rbiCF38CtghNmxYvMJ5tqZOJSb6hcoKCDopEVEPCPT5cUJAlRSxkkTG8+nkC32rg18wsp5bq7iSmiJbHMA53MqQ3bmDUmrQlAO4K6FeTCmpuO354t79ku4SmHpCv28VEYeS3bKiLqdEEFDJ3nGAmx3OVvwtxjqnSW8SMWNx2fBFd0rf4xKs/crmV/l/t1/mKuFfJbpCOFzGRFxD3GS+AcbOhgqjsQjE1nIBC5qB4f7ZMGcuqf0Xg4Lk9JmA8W9OuIoL0wvcTHVaBFt8oUWiNLdt9daz9k4B82fDtlwhs9IZpJeY5lQuy5O1BjyZroPi64Ciq+BETBV8/VAqbPqPi9omW4wXVrUNfABnmeI/P1cg7bWG/4uHzaMbhmPyzfFOWdAw0Zt1uYabZ0RjquhO1qECRgmYWV8qQBxn6YCxrGRjefl6ypn4tHx7wP2jjd8jzRmkpOUmXHwpIbW5VQV4fZ7RKD3zj07AtIFxfVeCI2qnParuJ5osaFCmAo7iygAH5hPeJm1VChVD0mWYjRt029Bown7D1Gw+KNlqsTHF/L5ZOhvFxbmaia6oLMuM748QiUBxlYgLFO2KKKvNB3hcT/OEHsACMagxGlVtg6SEpLYoKfSTgvjiW7a8E5JQG90oGGdehZhKcW3lnVtw2lzj0G1PRmEHxArOs0gmGTPDvTxpA4A3JauvMUF7uvHlEPy1Jld4jbc7X0oGiSQWIjom+NIEcDVF7lMxcvDbFnTJYypBr0ECTgJ5bUTgxIOorJg11Q6G4QGmbyiqmM0j6gp2wlTDerirMnBkce6huHToXxG2pZeUokVkl5BZY0PeUqW65TkVNmcsq/wKGP9u2zE7EOuVU35UZ0bE86oa6sEDcoEhZfV7uciH1WzBV1fYf799zmfRq8ZO6Ne3PoLa4Fm+Q0DENLOhvtqnu8O5IEZThs7HLkddOjULoMyrunBjT24xdqPeITSUEFC8wRRvGM9GbPgeMT1uRPHZL4Yn3Rbj61EFaX5tUYJ82W4m8BeavRR9tHGUdjSnVtm/7K5OuSfeoQ9Axs7s9URIBbMJAkcJc9oeNpyk27dKUlJbq4Gt+dVvqfDC96B0lhz3gFp2RlHSt7fIDln3KQnV4wuLqQSJZd9iS1S3v3TZZPqB80lNCQYmkDbUmTcYszpCpB+UoYRuW2KY03nPSa7ATOtAloPDmEUO0JHUvGEnyoEgaaul4w0W9NbdKvDh1CSja1rQFTFiKtoPicZFCGTTJ3SP8duNVYGeU7xJQ1G2pMsHmFO8WWOAHyhS3tJF/Q2E00Omg+B2+j2kKjmnrbNluYyDrN8CE0ECng+JNAaLrv6FDngOif/I4yviX8VzxDSjdAYpak1ZFR9XL2EPX26YcNI0C+wYls2TNcWqIPxh+pgZ1Fw6rz9umNAQ/Rxtn7b23eKdOX1pN6kM4ot0oPIMuMebo6r3qTEzPOhUUddOQTUqjWkjT3F2SjjwxKun+WjoNFP7otLH6EZ6uOA6Zv/zQ/XroURJ0GiitG4eMT55woNuioXqUlqMUptNAiVKOb9gNGvh/zkwsCpjpSJIAAAAASUVORK5CYII=" width="101" height="115" class="img_ev3q"></p><p>Function Apps, Logic Apps and App Services can be used to expose APIs within Azure API Management which is an easy way to deploy serverless microservices. You can see this capability in the Azure portal below within API Management:</p><p><a target="_blank" href="/assets/files/apimamanagement-add-fnapp-a479fd5e902fc785cebfdce4e32d60d8.png"><img loading="lazy" alt="Add a new API using a Function App as a back end" src="/assets/images/apimamanagement-add-fnapp-a479fd5e902fc785cebfdce4e32d60d8.png" width="1920" height="1040" class="img_ev3q"></a></p><p>Like most readers, I like to script everything, so I was initially frustrated when I couldn’t replicate this operation in the Azure cli, REST, PowerShell, or any of the other SDKs or IaC tools. Others shared my frustration as seen <a href="https://feedback.azure.com/forums/248703-api-management/suggestions/36832033-programmatically-import-azure-function-into-apim" target="_blank" rel="noopener noreferrer">here</a>.</p><p>I was nearly resigned to using click ops in the portal (arrrgh) before I worked out this workaround.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="the-solution">The Solution<a class="hash-link" href="#the-solution" title="Direct link to heading">​</a></h2><p>There is a bit more prep work required to automate this process, but it is well worth it.</p><ol><li>Create an OpenApi (or Swagger spec or WADL) specification document, as seen below (use the absolute URL for your Function App in the <code>url</code> parameter):</li></ol><iframe width="100%" frameborder="0" id="gist-077e8f313e6f44393df71057c8af7850"></iframe><ol start="2"><li>Use the <code>az apim api import</code> function (not the <code>az apim api create</code> function), as shown here:</li></ol><iframe width="100%" frameborder="0" id="gist-1f5eec542bd5ec01dbb9a06472e8e59b"></iframe><ol start="3"><li>Associate the API with a product (which is how you can rate limit APIs)</li></ol><iframe width="100%" frameborder="0" id="gist-4ad9c81b97ee97fb2cb6f794c2ae820f"></iframe><p>That’s it! You can now access your function via the API gateway using the gateway url or via the developer portal as seen below:</p><p><a target="_blank" href="/assets/files/apimamanagement-test-api-52e41024ea9942790e112d030d65965f.png"><img loading="lazy" alt="Function App API in API Management in the Azure Portal" src="/assets/images/apimamanagement-test-api-52e41024ea9942790e112d030d65965f.png" width="1920" height="1040" class="img_ev3q"></a></p><p><a target="_blank" href="/assets/files/apimamanagement-dev-portal-5cb59bd69af224f871a17852fcffb30e.png"><img loading="lazy" alt="Function App API in the Dev Portal" src="/assets/images/apimamanagement-dev-portal-5cb59bd69af224f871a17852fcffb30e.png" width="1920" height="1040" class="img_ev3q"></a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/api-management">api-management</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/apis">apis</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/azure">azure</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/function-app">function-app</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/microservices">microservices</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/microsoft-azure">microsoft-azure</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/serverless">serverless</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">StackQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.windrate.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">WindRate<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.52f4ef37.js"></script>
<script src="/assets/js/main.cd73ca56.js"></script>
</body>
</html>