<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/cloudywithachanceofbigdata.github.io/rss.xml" title="Cloudy with a chance of Big Data Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/cloudywithachanceofbigdata.github.io/atom.xml" title="Cloudy with a chance of Big Data Blog Atom Feed"><title data-react-helmet="true">One post tagged with &quot;private-networking&quot; | Cloudy with a chance of Big Data</title><meta data-react-helmet="true" property="og:title" content="One post tagged with &quot;private-networking&quot; | Cloudy with a chance of Big Data"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://cloudywithachanceofbigdata.github.io/cloudywithachanceofbigdata.github.io/tags/private-networking"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/cloudywithachanceofbigdata.github.io/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cloudywithachanceofbigdata.github.io/cloudywithachanceofbigdata.github.io/tags/private-networking"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.github.io/cloudywithachanceofbigdata.github.io/tags/private-networking" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.github.io/cloudywithachanceofbigdata.github.io/tags/private-networking" hreflang="x-default"><link rel="stylesheet" href="/cloudywithachanceofbigdata.github.io/assets/css/styles.3f66b476.css">
<link rel="preload" href="/cloudywithachanceofbigdata.github.io/assets/js/runtime~main.ed07d66e.js" as="script">
<link rel="preload" href="/cloudywithachanceofbigdata.github.io/assets/js/main.1007c58c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cloudywithachanceofbigdata.github.io/"><b class="navbar__title">Cloudy with a chance of Big Data</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloudywithachanceofbigdata.github.io/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/cloudywithachanceofbigdata.github.io/tags">Topics</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/cloudywithachanceofbigdata.github.io/tags">All Topics</a></li><li><a class="dropdown__link" href="/cloudywithachanceofbigdata.github.io/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/cloudywithachanceofbigdata.github.io/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/cloudywithachanceofbigdata.github.io/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/cloudywithachanceofbigdata.github.io/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/cloudywithachanceofbigdata.github.io/archive">Archive</a><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/cloudywithachanceofbigdata.github.io/using-jsonnet-to-configure-multiple-environments">Using Jsonnet to Configure Multiple Environments</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/cloudywithachanceofbigdata.github.io/use-bigquery-to-trigger-cloud-run">Use BigQuery to trigger Cloud Run</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/cloudywithachanceofbigdata.github.io/azure-static-web-app-review">Azure Static Web App Review</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/cloudywithachanceofbigdata.github.io/introducing-the-metadata-hub-mdh">Introducing the Metadata Hub (MDH)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/cloudywithachanceofbigdata.github.io/masking-private-keys-in-ci-cd-pipelines-in-gitlab">Masking Private Keys in CI/CD Pipelines in GitLab</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/cloudywithachanceofbigdata.github.io/simple-tasker-configuration-driven-orchestration">Simple Tasker: Configuration driven orchestration</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/cloudywithachanceofbigdata.github.io/okta-admin-command-line-interface">Okta Admin Command Line Interface</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/cloudywithachanceofbigdata.github.io/enumerating-all-roles-for-a-user-in-snowflake">Enumerating all roles for a user in Snowflake</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/cloudywithachanceofbigdata.github.io/eventarc-the-state-of-eventing-in-google-cloud">EventArc: The state of eventing in Google Cloud</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/cloudywithachanceofbigdata.github.io/microservices-concepts-orchestration-versus-choreography">Microservices Concepts: Orchestration versus Choreography</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;private-networking&quot;</h1><a href="/cloudywithachanceofbigdata.github.io/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/cloudywithachanceofbigdata.github.io/creating-a-site-to-site-vpn-connection-between-gcp-and-azure-with-google-private-access">Creating a Site to Site VPN Connection Between GCP and Azure with Google Private Access</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-03-27T00:00:00.000Z" itemprop="datePublished">March 27, 2020</time> Â· 12 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.github.io/cloudywithachanceofbigdata.github.io/images/azure_to_gcp_feature_image-1.png"><div class="markdown" itemprop="articleBody"><p>This article demonstrates creating a site to site IPSEC VPN connection between a GCP VPC network and an Azure Virtual Network, enabling private RFC1918 network connectivity between virtual networks in both clouds. This is done using a single PowerShell script leveraging Azure PowerShell and gcloud commands in the Google SDK.</p><p>Additionally, we will use Azure Private DNS to enable private access between Azure hosts and GCP APIs (such as Cloud Storage or Big Query).</p><p>An overview of the solution is provided here:</p><p><a target="_blank" href="/cloudywithachanceofbigdata.github.io/assets/files/gcp-to-azure-vpn-design-f59e466042c5e6fdf12abc497dde73bd.png"><img alt="Azure to GCP VPN Design" src="/cloudywithachanceofbigdata.github.io/assets/images/gcp-to-azure-vpn-design-f59e466042c5e6fdf12abc497dde73bd.png"></a></p><p>One note before starting - site to site VPN connections between GCP and Azure currently do not support dynamic routing using BGP, however creating some simple routes on either end of the connection will be enough to get going.</p><p>Letâ€™s go through this step by step:</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-1--authenticate-to-azure"></a>Step 1 : Authenticate to Azure<a class="hash-link" href="#step-1--authenticate-to-azure" title="Direct link to heading">#</a></h2><p>Azureâ€™s account equivalent is a subscription, the following command from Azure Powershell is used to authenticate a user to one or more subscriptions.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Connect-AzAccount</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This command will open a browser window prompting you for Microsoft credentials, once authenticated you will be returned to the command line.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-2--create-a-resource-group-azure"></a>Step 2 : Create a Resource Group (Azure)<a class="hash-link" href="#step-2--create-a-resource-group-azure" title="Direct link to heading">#</a></h2><p>A resource group is roughly equivalent to a project in GCP. You will need to supply a Location (equivalent to a GCP region):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">New-AzResourceGroup `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-3--create-a-virtual-network-with-subnets-and-routes-azure"></a>Step 3 : Create a Virtual Network with Subnets and Routes (Azure)<a class="hash-link" href="#step-3--create-a-virtual-network-with-subnets-and-routes-azure" title="Direct link to heading">#</a></h2><p>An Azure Virtual Network is the equivalent of a VPC network in GCP (or AWS), you must define subnets before creating a Virtual Network. In this example we will create two subnets, one Gateway subnet (which needs to be named accordingly) where the VPN gateway will reside, and one subnet named â€˜defaultâ€™ where we will host VMs which will connect to GCP services over the private VPN connection.</p><p>Before defining the default subnet we must create and attach a Route Table (equivalent of a Route in GCP), this particular route will be used to route â€˜privateâ€™ requests to services in GCP (such as Big Query).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># define route table and route to GCP private access</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$azroutecfg = New-AzRouteConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;google-private&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;199.36.153.4/30&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -NextHopType &quot;VirtualNetworkGateway&quot; </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$azrttbl = New-AzRouteTable `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;google-private&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Route $azroutecfg</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># define gateway subnet</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$gatewaySubnet = New-AzVirtualNetworkSubnetConfig  `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;GatewaySubnet&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.2.0/24&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># define default subnet</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$defaultSubnet  = New-AzVirtualNetworkSubnetConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;default&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.1.0/24&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RouteTable $azrttbl</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># create virtual network and subnets</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$vnet = New-AzVirtualNetwork  `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;azure-to-gcp-vnet&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.1.0.0/16&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Subnet $gatewaySubnet,$defaultSubnet</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-4--create-network-security-groups-azure"></a>Step 4 : Create Network Security Groups (Azure)<a class="hash-link" href="#step-4--create-network-security-groups-azure" title="Direct link to heading">#</a></h2><p>Network Security Groups in Azure are stateful firewalls much like Firewall Rules in VPC networks in GCP. Like GCP, the lower priority overrides higher priority rules.</p><p>In the example we will create several rules to allow inbound ICMP, TCP and UDP traffic from our Google VPC and RDP traffic from the Internet (which we will use to logon to a VM in Azure to test private connectivity between the two clouds):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create network security group</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule1 = New-AzNetworkSecurityRuleConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name rdp-rule `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow RDP&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Tcp `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 100 `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix Internet `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange 3389</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule2 = New-AzNetworkSecurityRuleConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name icmp-rule `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow ICMP&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Icmp `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 101 `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix * `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange *</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$rule3 = New-AzNetworkSecurityRuleConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name gcp-rule `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Description &quot;Allow GCP&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Access Allow `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Protocol Tcp `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Direction Inbound `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Priority 102 `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourceAddressPrefix &quot;10.2.0.0/16&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SourcePortRange * `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationAddressPrefix * `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -DestinationPortRange *</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$nsg = New-AzNetworkSecurityGroup `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;nsg-vm&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SecurityRules $rule1,$rule2,$rule3</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-5--create-public-ip-addresses-azure"></a>Step 5 : Create Public IP Addresses (Azure)<a class="hash-link" href="#step-5--create-public-ip-addresses-azure" title="Direct link to heading">#</a></h2><p>We need to create two Public IP Address (equivalent of an External IP in GCP) which will be used for our VPN gateway and for the VM we will create:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create public IP address for VM</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$vmpip = New-AzPublicIpAddress `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vm-ip&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AllocationMethod Dynamic</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># create public IP address for NW gateway </span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ngwpip = New-AzPublicIpAddress `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ip&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AllocationMethod Dynamic</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-6--create-virtual-network-gateway-azure"></a>Step 6 : Create Virtual Network Gateway (Azure)<a class="hash-link" href="#step-6--create-virtual-network-gateway-azure" title="Direct link to heading">#</a></h2><p>The Virtual Network Gateway in Azure is the VPN Gateway equivalent in Azure which will be used to create a VPN tunnel between Azure and a GCP VPN Gateway. This gateway will be placed in the Gateway subnet created previously and one of the Public IP addresses created in the previous step will be assigned to this gateway.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create virtual network gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ngwipconfig = New-AzVirtualNetworkGatewayIpConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ipconfig&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SubnetId $gatewaySubnet.Id `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublicIpAddressId $ngwpip.Id</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># use the AsJob switch as this is a long running process</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$job = New-AzVirtualNetworkGateway -Name &quot;vnet-gateway&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IpConfigurations $ngwipconfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewayType &quot;Vpn&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VpnType &quot;RouteBased&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewaySku &quot;VpnGw1&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VpnGatewayGeneration &quot;Generation1&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AsJob</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$vnetgw = Get-AzVirtualNetworkGateway `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vnet-gateway&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-7--create-a-vpc-network-and-subnetworks-gcp"></a>Step 7 : Create a VPC Network and Subnetwork(s) (GCP)<a class="hash-link" href="#step-7--create-a-vpc-network-and-subnetworks-gcp" title="Direct link to heading">#</a></h2><p>A VPC network and subnet need to be created in GCP, the subnet defines the VPC address space. This address space must not overlap with the Azure Virtual Network CIDR. For all GCP steps it is assumed that the project is set for client config (e.g. gcloud config set project <strong>your_project</strong>) so it does not need to be specified for each operation. Private Google access should be enabled on all subnets created.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># creating VPC network and subnets</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks create &quot;azure-to-gcp-vpc&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --subnet-mode=custom `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --bgp-routing-mode=regional</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute networks subnets create &quot;aus-subnet&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network  &quot;azure-to-gcp-vpc&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --range &quot;10.2.1.0/24&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-private-ip-google-access</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-8--create-an-external-ip-gcp"></a>Step 8 : Create an External IP (GCP)<a class="hash-link" href="#step-8--create-an-external-ip-gcp" title="Direct link to heading">#</a></h2><p>An external IP address will need to be created in GCP which will be used for the external facing interface of the VPN Gateway.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># create external IP</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute addresses create </span><span class="token string" style="color:#e3116c">&quot;ext-gw-ip&quot;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa"></span></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">  --region </span><span class="token variable string" style="color:#e3116c">&quot;australia-southeast1&quot;</span><span class="token variable" style="color:#36acaa"></span></span><span class="token-line" style="color:#393A34"><span class="token variable" style="display:inline-block;color:#36acaa">
</span></span><span class="token-line" style="color:#393A34"><span class="token variable" style="color:#36acaa">$gcp_ipaddr_obj </span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa"> gcloud compute addresses describe </span><span class="token variable string" style="color:#e3116c">&quot;ext-gw-ip&quot;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region </span><span class="token string" style="color:#e3116c">&quot;australia-southeast1&quot;</span><span class="token plain"> `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --format json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ConvertFrom-Json</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$gcp_ipaddr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$gcp_ipaddr_obj</span><span class="token plain">.address</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-9--create-firewall-rules-gcp"></a>Step 9 : Create Firewall Rules (GCP)<a class="hash-link" href="#step-9--create-firewall-rules-gcp" title="Direct link to heading">#</a></h2><p>VPC firewall rules will need to be created in GCP to allow VPN traffic as well as SSH traffic from the internet (which allows you to SSH into VM instances using Cloud Shell).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create VPN firewall rules</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules create &quot;vpn-rule1&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --allow tcp,udp,icmp `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --source-ranges &quot;10.1.0.0/16&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute firewall-rules create &quot;ssh-rule1&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --allow tcp:22</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-10--create-vpn-gateway-and-forwarding-rules-gcp"></a>Step 10 : Create VPN Gateway and Forwarding Rules (GCP)<a class="hash-link" href="#step-10--create-vpn-gateway-and-forwarding-rules-gcp" title="Direct link to heading">#</a></h2><p>Create a VPN Gateway and Forwarding Rules in GCP which will be used to create a tunnel between GCP and Azure.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create cloud VPN </span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute target-vpn-gateways create &quot;vpn-gw&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># create forwarding rule ESP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-esp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol ESP `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># creating forwarding rule UDP500</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-udp500&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol UDP `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ports 500 `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># creating forwarding rule UDP4500</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute forwarding-rules create &quot;fr-gw-name-udp4500&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ip-protocol UDP `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ports 4500 `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --address &quot;ext-gw-ip&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region &quot;australia-southeast1&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-10--create-vpn-tunnel-gcp-side"></a>Step 10 : Create VPN Tunnel (GCP Side)<a class="hash-link" href="#step-10--create-vpn-tunnel-gcp-side" title="Direct link to heading">#</a></h2><p>Now we will create the GCP side of our VPN tunnel using the Public IP Address of the Azure Virtual Network Gateway created in a previous step. As this example uses a route based VPN the traffic selector values need to be set at 0.0.0.0/0. A PSK (Pre Shared Key) needs to be supplied which will be the same key used when we configure a VPN Connection on the Azure side of the tunnel.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># get peer public IP address of Azure gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$azpubip = Get-AzPublicIpAddress `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;ngw-ip&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># create VPN tunnel </span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute vpn-tunnels create &quot;vpn-tunnel-to-azure&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-address $azpubip.IpAddress `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --local-traffic-selector &quot;0.0.0.0/0&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --remote-traffic-selector &quot;0.0.0.0/0&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --ike-version 2 `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --shared-secret &lt;&lt; Pre-Shared Key &gt;&gt; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --target-vpn-gateway &quot;vpn-gw&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region  &quot;australia-southeast1&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-11--create-static-routes-gcp-side"></a>Step 11 : Create Static Routes (GCP Side)<a class="hash-link" href="#step-11--create-static-routes-gcp-side" title="Direct link to heading">#</a></h2><p>As we are using static routing (as opposed to dynamic routing) we will need to define all of the specific routes on the GCP side. We will need to setup routes for both outgoing traffic to the Azure network as well as incoming traffic for the restricted Google API range (199.36.153.4/30).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create static route (VPN)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute routes create &quot;route-to-azure&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --destination-range &quot;10.1.0.0/16&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-vpn-tunnel &quot;vpn-tunnel-to-azure&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network &quot;azure-to-gcp-vpc&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-vpn-tunnel-region &quot;australia-southeast1&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># create static route (Restricted APIs)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute routes create apis `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network  &quot;azure-to-gcp-vpc&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --destination-range &quot;199.36.153.4/30&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --next-hop-gateway default-internet-gateway `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --project &quot;azure-to-gcp-project&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-12--create-a-local-gateway-azure"></a>Step 12 : Create a Local Gateway (Azure)<a class="hash-link" href="#step-12--create-a-local-gateway-azure" title="Direct link to heading">#</a></h2><p>A Local Gateway in Azure is an object that represents the remote gateway (GCP VPN gateway).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create local gateway</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$azlocalgw = New-AzLocalNetworkGateway `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;local-gateway&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -GatewayIpAddress $gcp_ipaddr `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AddressPrefix &quot;10.2.0.0/16&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-13--create-a-vpn-connection-azure"></a>Step 13 : Create a VPN Connection (Azure)<a class="hash-link" href="#step-13--create-a-vpn-connection-azure" title="Direct link to heading">#</a></h2><p>Now we can setup the Azure side of the VPN Connection which is accomplished by associating the Azure Virtual Network Gateway with the Local Network Gateway. A PSK (Pre Shared Key) needs to be supplied which is the same key used for the GCP VPN Tunnel in step 10.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create connection</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$azvpnconn = New-AzVirtualNetworkGatewayConnection `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vpn-connection&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VirtualNetworkGateway1 $vnetgw `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -LocalNetworkGateway2 $azlocalgw `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ConnectionType IPsec `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SharedKey  &lt;&lt; Pre-Shared Key &gt;&gt;  `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ConnectionProtocol &quot;IKEv2&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>VPN Tunnel Established!</p><p>At this stage we have created an end to end connection between the virtual networks in both clouds. You should see this reflected in the respective consoles in each provider.</p><figure><a href="/cloudywithachanceofbigdata.github.io/assets/images/gcp-vpn-to-azure-d627caa8febd797b530e1471bd5c9aff.png"><img src="/cloudywithachanceofbigdata.github.io/assets/images/gcp-vpn-to-azure-d627caa8febd797b530e1471bd5c9aff.png" alt="GCP VPN Tunnel to a Azure Virtual Network"></a><figcaption class="figure-caption">GCP VPN Tunnel to a Azure Virtual Network</figcaption></figure><figure><a href="/cloudywithachanceofbigdata.github.io/assets/images/azure-vpn-to-gcp-4716124e93f2cbc8a7e5ef5cd98d23df.png"><img src="/cloudywithachanceofbigdata.github.io/assets/images/azure-vpn-to-gcp-4716124e93f2cbc8a7e5ef5cd98d23df.png" alt="Azure VPN Connection to a GCP VPC Network"></a><figcaption class="figure-caption">Azure VPN Connection to a GCP VPC Network</figcaption></figure><p>Congratulations! You have just setup a multi cloud environment using private networking. Now letâ€™s setup Google Private Access for Azure hosts and create VMs on each side to test our setup.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-14--create-a-private-dns-zone-for-googleapiscom-azure"></a>Step 14 : Create a Private DNS Zone for googleapis.com (Azure)<a class="hash-link" href="#step-14--create-a-private-dns-zone-for-googleapiscom-azure" title="Direct link to heading">#</a></h2><p>We will now need to create a Private DNS zone in Azure for the googleapis.com domain which will host records to redirect Google API requests to the Restricted API range.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create private DNS zone</span></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsZone `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;googleapis.com&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add A Records   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records = @()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.4</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.5</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.6</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -IPv4Address 199.36.153.7</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsRecordSet `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;restricted&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RecordType A `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -TTL 300 `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PrivateDnsRecords $Records</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add CNAME Records   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records = @()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$Records += New-AzPrivateDnsRecordConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Cname &quot;restricted.googleapis.com.&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsRecordSet `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;*&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -RecordType CNAME `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -TTL 300 `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PrivateDnsRecords $Records</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># Create VNet Link</span></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzPrivateDnsVirtualNetworkLink `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ZoneName &quot;googleapis.com&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;dns-zone-link&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VirtualNetworkId $vnet.Id</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-15--create-a-virtual-machine-azure"></a>Step 15 : Create a Virtual Machine (Azure)<a class="hash-link" href="#step-15--create-a-virtual-machine-azure" title="Direct link to heading">#</a></h2><p>We will create a VM in Azure which we can use to test the VPN tunnel as well as to test Private Google Access over our VPN tunnel.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create VM</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$az_vmlocaladminpwd = ConvertTo-SecureString &lt;&lt; Password Param &gt;&gt; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -AsPlainText -Force</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$Credential = New-Object System.Management.Automation.PSCredential  (&quot;LocalAdminUser&quot;, $az_vmlocaladminpwd);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$nic = New-AzNetworkInterface `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Name &quot;vm-nic&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -SubnetId $defaultSubnet.Id `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -NetworkSecurityGroupId $nsg.Id `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublicIpAddressId $vmpip.Id `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -EnableAcceleratedNetworking `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Force</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = New-AzVMConfig `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VMName &quot;windows-desktop&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VMSize &quot;Standard_D4_v3&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Set-AzVMOperatingSystem `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Windows `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ComputerName  &quot;windows-desktop&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Credential $Credential `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ProvisionVMAgent `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -EnableAutoUpdate</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Add-AzVMNetworkInterface `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Id $nic.Id</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$VirtualMachine = Set-AzVMSourceImage `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -PublisherName &#x27;MicrosoftWindowsDesktop&#x27; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Offer &#x27;Windows-10&#x27; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Skus &#x27;rs5-pro&#x27; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Version latest</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">New-AzVM `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -ResourceGroupName &quot;azure-to-gcp&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Location &quot;Australia Southeast&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -VM $VirtualMachine `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Verbose</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="step-16--create-a-vm-instance-gcp"></a>Step 16 : Create a VM Instance (GCP)<a class="hash-link" href="#step-16--create-a-vm-instance-gcp" title="Direct link to heading">#</a></h2><p>We will create a Linux VM in GCP to test connectivity to hosts in Azure using the VPN tunnel we have established.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly powershell"><pre tabindex="0" class="prism-code language-powershell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># create VM instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gcloud compute instances create &quot;gcp-instance&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --zone &quot;australia-southeast1-b&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --machine-type &quot;f1-micro&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --subnet &quot;aus-subnet&quot; `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --network-tier PREMIUM `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --maintenance-policy MIGRATE `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --image=debian-9-stretch-v20200309 `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --image-project=debian-cloud `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-size 10GB `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-type pd-standard `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --boot-disk-device-name instance-1 `</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  --reservation-affinity any</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="test-connectivity"></a>Test Connectivity<a class="hash-link" href="#test-connectivity" title="Direct link to heading">#</a></h2><p>Now we are ready to test connectivity from both sides of the tunnel.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="azure-to-gcp"></a>Azure to GCP<a class="hash-link" href="#azure-to-gcp" title="Direct link to heading">#</a></h3><p>Establish a remote desktop (RDP) connection to the Azure VM created in Step 15. Ping the GCP VM instance using its private IP address.</p><p><a target="_blank" href="/cloudywithachanceofbigdata.github.io/assets/files/azure-ping-to-gcp-14a9b0e446b7c868ffa27ba3435460be.png"><img alt="Test Private IP Connectivity from Azure to GCP" src="/cloudywithachanceofbigdata.github.io/assets/images/azure-ping-to-gcp-14a9b0e446b7c868ffa27ba3435460be.png"></a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="gcp-to-azure"></a>GCP to Azure<a class="hash-link" href="#gcp-to-azure" title="Direct link to heading">#</a></h3><p>Now SSH into the GCP Linux VM instance and ping the Azure host using its private IP address.</p><p><a target="_blank" href="/cloudywithachanceofbigdata.github.io/assets/files/gcp-ping-to-azure-94b9a33840b54870af540853cda825e9.png"><img alt="Test Private IP Connectivity from GCP to Azure" src="/cloudywithachanceofbigdata.github.io/assets/images/gcp-ping-to-azure-94b9a33840b54870af540853cda825e9.png"></a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="test-private-google-access-from-azure"></a>Test Private Google Access from Azure<a class="hash-link" href="#test-private-google-access-from-azure" title="Direct link to heading">#</a></h2><p>Now that we have established bi-directional connectivity between the two clouds, we can test private access to Google APIs from our Azure host. Follow the steps below to test private access:</p><ol><li>RDP into the Azure VM</li><li>Install the Google Cloud SDK ( <a href="https://cloud.google.com/sdk/" target="_blank" rel="noopener noreferrer">https://cloud.google.com/sdk/</a>)</li><li>Perform an <code>nslookup</code> to ensure that calls to googleapis.com resolve to the restricted API range (e.g. <code>nslookup storage.googleapis.com</code>). You should see a response showing the A records from the googleapis.com Private DNS Zone created in step 14.</li><li>Now test connectivity to Google APIs, for example to test access to Google Cloud Storage using <code>gsutil</code>, or test access to Big Query using the <code>bq</code> command</li></ol><p>Congratulations! You are now a multi cloud ninja!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/cloudywithachanceofbigdata.github.io/tags/azure">azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/cloudywithachanceofbigdata.github.io/tags/gcp">gcp</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/cloudywithachanceofbigdata.github.io/tags/google-cloud-platform">google-cloud-platform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/cloudywithachanceofbigdata.github.io/tags/googlecloudplatform">googlecloudplatform</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/cloudywithachanceofbigdata.github.io/tags/hybrid-cloud">hybrid-cloud</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/cloudywithachanceofbigdata.github.io/tags/microsoft">microsoft</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/cloudywithachanceofbigdata.github.io/tags/microsoft-azure">microsoft-azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/cloudywithachanceofbigdata.github.io/tags/multi-cloud">multi-cloud</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/cloudywithachanceofbigdata.github.io/tags/private-networking">private-networking</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/cloudywithachanceofbigdata.github.io/tags/vpn">vpn</a></li></ul></div><div class="col col--3 text--right"><a aria-label="Read more about Creating a Site to Site VPN Connection Between GCP and Azure with Google Private Access" href="/cloudywithachanceofbigdata.github.io/creating-a-site-to-site-vpn-connection-between-gcp-and-azure-with-google-private-access"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cloudywithachanceofbigdata.github.io/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/cloudywithachanceofbigdata.github.io/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/cloudywithachanceofbigdata.github.io/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a href="https://infraql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>InfraQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"></div></div></footer></div>
<script src="/cloudywithachanceofbigdata.github.io/assets/js/runtime~main.ed07d66e.js"></script>
<script src="/cloudywithachanceofbigdata.github.io/assets/js/main.1007c58c.js"></script>
</body>
</html>