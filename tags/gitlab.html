<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.0">
<title data-rh="true">5 posts tagged with &quot;gitlab&quot; | Full Stack Chronicles</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://fullstackchronicles.io/img/fullstackchronicles-cover-image.png"><meta data-rh="true" name="twitter:image" content="https://fullstackchronicles.io/img/fullstackchronicles-cover-image.png"><meta data-rh="true" property="og:url" content="https://fullstackchronicles.io/tags/gitlab"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="robots" content="index,follow"><meta data-rh="true" name="twitter:site" content="@fschronicles1"><meta data-rh="true" name="twitter:creator" content="@fschronicles1"><meta data-rh="true" name="og:type" content="website"><meta data-rh="true" name="og:locale" content="en_US"><meta data-rh="true" name="og:site_name" content="Full Stack Chronicles"><meta data-rh="true" name="msapplication-TileColor" content="#2d89ef"><meta data-rh="true" name="theme-color" content="#ffffff"><meta data-rh="true" property="og:title" content="5 posts tagged with &quot;gitlab&quot; | Full Stack Chronicles"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://fullstackchronicles.io/tags/gitlab"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/tags/gitlab" hreflang="en"><link data-rh="true" rel="alternate" href="https://fullstackchronicles.io/tags/gitlab" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://MZCGVO503N-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Full Stack Chronicles Blog Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Full Stack Chronicles Blog Feed Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Full Stack Chronicles Blog Feed JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0FVDC1E8G6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0FVDC1E8G6",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Full Stack Chronicles" href="/opensearch.xml">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0f4c81"><link rel="stylesheet" href="/assets/css/styles.308152d6.css">
<link rel="preload" href="/assets/js/runtime~main.dc0e16b9.js" as="script">
<link rel="preload" href="/assets/js/main.18332222.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#A9BCD0;color:#1A4E82" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><b>If you find our content useful, follow us on <a target="_blank" rel="noopener noreferrer" href="https://github.com/stackql">GitHub</a>, if you have some content to share, reach out</b></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/full-stack-logo-transparent.svg" alt="Full Stack Chronicles" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Full Stack Chronicles</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/tags">Topics</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/snowflake">Snowflake</a></li><li><a class="dropdown__link" href="/tags/okta">Okta</a></li><li><a class="dropdown__link" href="/tags/openapi">OpenAPI</a></li><li><a class="dropdown__link" href="/tags/spark">Spark</a></li><li><a class="dropdown__link" href="/tags/kafka">Kafka</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/enhancing-dbt-snapshots-with-operational-metadata">Enhancing dbt Snapshots with Operational Metadata</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/json-ld-structured-data-for-docusaurus">Yoast (like) JSON-LD Structured Data for Docusaurus</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/gitver-an-alternative-versioning-scheme-to-semver-or-calver">Introducing GitVer - an alternative versioning scheme</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/use-deno-deploy-to-serve-non-traditional-artifacts">Use Deno Deploy to Serve Non-Traditional Artifacts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/apache-beam-in-five-minutes">Apache Beam in Five Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/aws-iam-vs-google-iam">AWS IAM vs Google IAM</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/create-and-use-custom-magic-commands-in-jupyter">Create and use Custom Magic Commands in Jupyter</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/deno-in-five-minutes">Deno in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/dbt-in-five-minutes">DBT in 5 Minutes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/loading-parquet-files-into-snowflake">Loading Parquet Files into Snowflake</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/analyze-developer-activity-with-stackql-jupyter-bigquery">Analyze Developer Activity with StackQL, Jupyter and BigQuery</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/converting-google-discovery-docs-to-openapi3-specs">Converting Google Discovery Docs to OpenAPI3 Specs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/recurse-javascript-object-to-get-values-for-a-given-key-the-easy-way">Recurse JavaScript Object to Get Values for a Given Key the Easy Way</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/dataops-with-container-images-and-multi-stage-builds">DataOps with Container Images and Multi-Stage Builds</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/using-the-snowflake-sql-api-with-typescript">Using the Snowflake SQL API with TypeScript</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>5 posts tagged with &quot;gitlab&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/gitver-an-alternative-versioning-scheme-to-semver-or-calver.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/gitver-an-alternative-versioning-scheme-to-semver-or-calver">Introducing GitVer - an alternative versioning scheme</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-01-18T00:00:00.000Z" itemprop="datePublished">January 18, 2023</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>With our StackQL Provider Registry, we had an interesting challenge:  </p><ol><li>Maintain different versions for one or more different documents in the same repo(which were decoupled from releases)</li><li>Provide dynamic versioning (with no user input required and not dictated by tags)</li><li>Maintain some traceability to the source repo (pull requests, commit shas, etc)</li></ol><p><a href="https://semver.org/" target="_blank" rel="noopener noreferrer">SemVer</a> required users to make arbitrary decisions on major, minor, and build numbers.  </p><p>Although <a href="https://calver.org/" target="_blank" rel="noopener noreferrer">CalVer</a> required less user discretion for the major and minor components, the micro-component was still an arbitrary number.  This was not ideal for our use case.  </p><p>As our document versioning was not related to tags, and we have implemented GitFlow (specifically based upon PRs to dev or main) as our release path, we created a new variant scheme... <strong>GitVer</strong>.  </p><blockquote><p>This is completely different from <a href="https://github.com/GitTools/GitVersion" target="_blank" rel="noopener noreferrer">GitVersion</a>, which is a tool to determine the version of a project based on Git history.  </p></blockquote><p>This scheme is implemented using GitHub as the remote but could easily be adapted to GitLab, Bitbucket, etc.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="how-it-works">How it works<a href="#how-it-works" class="hash-link" aria-label="Direct link to How it works" title="Direct link to How it works">​</a></h2><p>Each pull request is assigned a version based on the date the PR was raised or merged, and the PR number.   This version (the GitVer) can then be used to version artifacts (which could be pushed to releases if desired).  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="workflow-example-code">Workflow Example Code<a href="#workflow-example-code" class="hash-link" aria-label="Direct link to Workflow Example Code" title="Direct link to Workflow Example Code">​</a></h2><p>This is an example using GitHub actions.  The version is determined automatically within the workflow.  </p><p><code>main.yml</code> example:  </p><iframe width="100%" frameborder="0" id="gist-94bcf43ba5deaf088a271d54d2a9c33e"></iframe><p>The code used to get the relevant PR info is here (<code>setup-job.js</code>), the tricky bit is that the PR number presents differently for a pull request open or sync (pushing changes to an open PR) and a merge commit (which is simply a push to a protetcted branch).  See the code below:</p><iframe width="100%" frameborder="0" id="gist-bec7982143a9637f866b7239e8c18130"></iframe><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>you can export some other metadata while you are here like the commit sha, source and target branch, (PR) action, etc.</p></div></div><p>The code to generate the GitVer for the PR is here (<code>get-version.js</code>):  </p><iframe width="100%" frameborder="0" id="gist-659b56d2474ed1fb8944e1c816b28f49"></iframe><p>You can see it at work here <a href="https://github.com/stackql/stackql-provider-registry/blob/dev/.github/workflows/main.yml" target="_blank" rel="noopener noreferrer">stackql/stackql-provider-registry</a> which builds and deploys <a href="https://registry.stackql.io/" target="_blank" rel="noopener noreferrer">providers for StackQL</a>.   </p><p>Thoughts?</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitver">gitver</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/semver">semver</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/calver">calver</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitops">gitops</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/versioning">versioning</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/git">git</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/github">github</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitlab">gitlab</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/bitbucket">bitbucket</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitflow">gitflow</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/scaling-up-prefect-with-gitstorage-featured-image.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/scaling-up-prefect-with-gitstorage">Scaling up Prefect with GitStorage</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-02-28T00:00:00.000Z" itemprop="datePublished">February 28, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/datwiz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="http://0.gravatar.com/avatar/f9af9c3fae755ac170c5798c53c5267d?s=80" alt="Chris Ottinger"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/datwiz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Chris Ottinger</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Technologist</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://prefect.io" target="_blank" rel="noopener noreferrer">Prefect.io</a> is a python based Data Engineering toolbox for building and
operating Data Pipelines.  Out of the box, Prefect provides an initial workflow for managing data
pipelines that results in a container image per data pipeline job.</p><p>The one-to-one relationship between data pipeline jobs and container images enables data engineers to
craft pipelines that are loosely coupled and don&#x27;t require a shared runtime environment configuration.
However, as the number of data pipeline jobs grow the default container per job approach starts to
introduce workflow bottlenecks and lifecycle management overheads.  For example, in order
to update software components used by flows, such as upgrading the version of Prefect, all the data
pipeline job images have to be rebuilt and redeployed.  Additionally the container image per job workflow
introduces a wait time for data engineers to re-build data pipeline container images and test flows
centrally on Prefect Server or Prefect Cloud environment.</p><p>Fortunately, Prefect comes to its own rescue with the ability to open up the box, exposing the flexibility
in the underlying framework.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="out-of-the-box---prefect-dockerstorage">Out of the box - Prefect DockerStorage<a href="#out-of-the-box---prefect-dockerstorage" class="hash-link" aria-label="Direct link to Out of the box - Prefect DockerStorage" title="Direct link to Out of the box - Prefect DockerStorage">​</a></h2><p>Out of the box, Prefect provides a simple workflow for defining and deploying data pipelines as container images.
After getting a first data pipeline running in a local environment, the attention turns to scaling up development
and deploying flows into a managed environment, using either the Prefect Cloud service or a Prefect Server.</p><p>Combining Prefect Cloud or Prefect Server with Kubernetes provides a flexible and scalable platform
solution for moving data pipelines into production.  There are a number of options for packaging
data pipeline flow code for execution on kubernetes clusters.  The Docker Storage option provides
the workflow for bundling the data pipeline job code into container images, enabling a common
controlled execution environment and well understood distribution mechanism.  The data pipeline runs as
a pod using the flow container image.</p><p>Prefect Docker Storage workflow steps for building and deploying data pipeline flows include:</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Steps</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PlantUML</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p><a target="_blank" href="/assets/files/image1-3eb8a74efcfb6b3a329f69dd9b89ca34.png"><img loading="lazy" alt="Workflow Steps" src="/assets/images/image1-3eb8a74efcfb6b3a329f69dd9b89ca34.png" width="253" height="435" class="img_ev3q"></a> </p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml &quot;docker-storage-workflow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(*) --&gt; &quot;package flow code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">into a container image&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;register Prefect flow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using image reference&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;push image to container registry&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;run flow in Prefect Server or Cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(new image pulled from registry)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; (*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div><ul><li>packaging a flow (python code) as a serialised/pickled object into a container image</li><li>registering the flow using the container image name</li><li>pushing the container image to a container repository accessible from the kubernetes cluster</li><li>running the flow by running an instance of the named container image as a kubernetes pod</li></ul><p>This is relatively simple immutable workflow.  Each data pipeline flow version is effectively a unique and
self contained &#x27;point-in-time&#x27; container image.  This initial workflow can also be extended to package
multiple related flows into a single container image, reducing the number of resulting container images.
But, as the number of data pipeline jobs grow, there issues of container image explosion and data engineering
productivity remain.</p><p>Using Prefect GitStorage for flows addresses both container image proliferation as well as development
bottlenecks.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="prefect-git-storage">Prefect Git Storage<a href="#prefect-git-storage" class="hash-link" aria-label="Direct link to Prefect Git Storage" title="Direct link to Prefect Git Storage">​</a></h2><p>Prefect <a href="https://docs.prefect.io/orchestration/flow_config/storage.html#git" target="_blank" rel="noopener noreferrer">Git Storage</a> provides a workflow for developing and deploying data pipelines directly from git repositories,
such as Gitlab or Github.  The data pipeline code (python) is pulled from the git repository on each invocation
with the ability to reference git branches and git tags.  This approach enables:</p><ul><li>reducing the number of container images to the number of different runtime configurations to be supported.</li><li>improving the data engineering development cycle time by removing the need to build and push container images
on each code change.</li><li>when combined with kubernetes Prefect Run Configs and Job templates, enables selection of specific runtime environment images</li></ul><p>Note that the GitStorage option does required access from the runtime kubernetes cluster to the central git storage
service, e.g. gitlab, github, etc.</p><p>Prefect Git Storage workflow steps for &#x27;building&#x27; and deploying data pipeline flows include:</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Steps</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PlantUML</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p><a target="_blank" href="/assets/files/image2-d57463bea4147ef77047e87d3b7a49a7.png"><img loading="lazy" alt="Workflow Steps" src="/assets/images/image2-d57463bea4147ef77047e87d3b7a49a7.png" width="253" height="361" class="img_ev3q"></a> </p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml &quot;git-storage-workflow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(*) --&gt; &quot;push commited flow code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">changes to git service&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;register PrefectFlow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using branch or tag reference&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; &quot;run flow in Prefect Server or Cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(code pulled from git service)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt; (*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div><ul><li>pushing the committed code to the central git service</li><li>registering the flow using the git repository url and branch or tag reference</li><li>running the flow by pulling the reference code from the git service in a kubernetes pod</li></ul><p>The container image build and push steps are removed from the developer feedback cycle time.
Depending on network bandwidth and image build times, this can save remove 5 to 10 minutes from each deployment iteration.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="pushing-the-flow-code">Pushing the flow code<a href="#pushing-the-flow-code" class="hash-link" aria-label="Direct link to Pushing the flow code" title="Direct link to Pushing the flow code">​</a></h3><p>Once a set of changes to the data pipeline code has been committed, push to the central git service.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> push</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="registering-the-flow">Registering the flow<a href="#registering-the-flow" class="hash-link" aria-label="Direct link to Registering the flow" title="Direct link to Registering the flow">​</a></h3><p>The flow can be registered with Prefect using either a branch (HEAD or latest) or tag reference.  Assuming
a workflow with feature branches:</p><ul><li>feature branches: register the flow code using the feature branch.  This enables the latest version (HEAD)
of the pushed flow code to be used for execution.  It also enables skipping re-registration of the flow on new
changes as the HEAD of the branch is pulled on each flow run</li><li>main line branches: register pinned versions of the flow using git tags.  This enables the use of a
specific version of the flow code to be pulled on each flow run, regardless of future changes.</li></ul><p>Determining the which reference to use:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># using gitpython module to work with repo info</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> git </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># presidence for identifing where to find the flow code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># BUILD_TAG =&gt; GIT_BRANCH =&gt; active_branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build_tag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> branch_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">build_tag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;BUILD_TAG&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> build_tag </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  branch_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;GIT_BRANCH&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> branch_name </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    branch_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Repo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getcwd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">active_branch</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Configuring Prefect Git storage:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> prefect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> my_flows</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hello_flow </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> flow </span><span class="token comment" style="color:#999988;font-style:italic"># assuming flow is defined in ./my_flows/flow.py</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># example using Gitlab</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># either branch_name or tag must be empty string &quot;&quot; or None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">storage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Git</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repo_host</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">git_hostname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repo</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">repo_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">flow</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">__name__</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">replace</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">,</span><span class="token string-interpolation interpolation string" style="color:#e3116c">&#x27;/&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.py&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flow_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    branch_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">branch_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tag</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">build_tag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git_token_secret_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">git_token_secret_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git_token_username</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">git_token_username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_flow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">regsiter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">build</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once registered, the flow storage details can be viewed in the Prefect Server or Prefect Cloud UI.  In this example, Prefect will use the <code>HEAD</code> version of the <code>main</code> branch on each flow run.</p><p><a target="_blank" href="/assets/files/flow-storage-details-e2be96914a590e405cacb47ffc0eceaa.png"><img loading="lazy" alt="hello flow storage details" src="/assets/images/flow-storage-details-e2be96914a590e405cacb47ffc0eceaa.png" width="678" height="339" class="img_ev3q"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="next-steps---run-config">Next Steps - Run Config<a href="#next-steps---run-config" class="hash-link" aria-label="Direct link to Next Steps - Run Config" title="Direct link to Next Steps - Run Config">​</a></h2><p>With Prefect Git Storage the runtime configuration and environment management is decoupled from the
data pipeline development workflow.  Unlike with Docker Storage, with Git Storage, the runtime
execution environment and data pipeline development workflows are defined and managed separately.
As an added benefit, the developer feedback loop cycle time is also reduced.</p><p>With the data engineering workflow addressed, the next step in scaling out the Prefect solution
turns to configuration and lifecycle management of the runtime environment for data pipelines.
Prefect Run Configs and Job templates provide the tools retaining the flexibility on container
image based runtime environments with improved manageability.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/prefect">prefect</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitlab">gitlab</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/docker">docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/etl">etl</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/cloudformation-jsonnet-featured-image.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/simplifying-large-cloudformation-templates-using-jsonnet">Simplifying Large CloudFormation Templates using Jsonnet</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-11-21T00:00:00.000Z" itemprop="datePublished">November 21, 2021</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>CloudFormation templates in large environments can grow beyond a manageable point.  This article provides one approach to breaking up CloudFormation templates into modules which can be imported and used to create a larger template to deploy a complex AWS stack – using Jsonnet.  </p><p>Jsonnet is a json pre-processing and templating library which includes features including user defined and built-in functions, objects, and inheritance amongst others.  If you are not familiar with Jsonnet, here are some good resources to start with:  </p><ul><li><a href="https://jsonnet.org/" target="_blank" rel="noopener noreferrer">Jsonnet</a></li><li><a href="https://cloudywithachanceofbigdata.com/using-jsonnet-to-configure-multiple-environments" target="_blank" rel="noopener noreferrer">Blog Article: Using Jsonnet to Configure Multiple Environments</a></li><li><a href="https://docs.infraql.io/blog/using-the-jsonnet-map-function" target="_blank" rel="noopener noreferrer">Blog Article: Using the Jsonnet Map Function</a></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="advantages">Advantages<a href="#advantages" class="hash-link" aria-label="Direct link to Advantages" title="Direct link to Advantages">​</a></h2><p>Using Jsonnet you can use imports to break up large stacks into smaller files scoped for each resource.  This approach makes CloudFormation template easier to read and write and allows you to apply the DRY (Do Not Repeat Yourself) coding principle (not possible with native CloudFormation templates.  </p><p>Additionally, although as the template fragments are in Jsonnet format, you can add annotations or comments to your code similar to YAML (not possible with a JSON template alone), although the rendered template is in legal CloudFormation Json format.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="process-overview">Process Overview<a href="#process-overview" class="hash-link" aria-label="Direct link to Process Overview" title="Direct link to Process Overview">​</a></h2><p>The process is summarised here: </p><p><a target="_blank" href="/assets/files/cloudformation-jsonnet-851900d3fb0edfa2930e846dd92c0b31.png"><img loading="lazy" alt="CloudFormation and Jsonnet" src="/assets/images/cloudformation-jsonnet-851900d3fb0edfa2930e846dd92c0b31.png" width="919" height="439" class="img_ev3q"></a> </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="code">Code<a href="#code" class="hash-link" aria-label="Direct link to Code" title="Direct link to Code">​</a></h2><p>This example will deploy a stack with a VPC and an S3 bucket with logging.  The project directory structure would look like this:  </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">templates/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─ includes/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ vpc.libsonnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ s3landingbucket.libsonnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ s3loggingbucket.libsonnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ tags.libsonnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─ template.jsonnet</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Lets look at all of the constituent files:  </p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="templatejsonnet"><code>template.jsonnet</code><a href="#templatejsonnet" class="hash-link" aria-label="Direct link to templatejsonnet" title="Direct link to templatejsonnet">​</a></h3><p>This is the root document which will be processed by Jsonnet to render a legal CloudFormation JSON template.  It will import the other files in the includes directory.  </p><iframe width="100%" frameborder="0" id="gist-8f2cc0c464de762f73b3f81c75a13832"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="includestagslibsonnet"><code>includes/tags.libsonnet</code><a href="#includestagslibsonnet" class="hash-link" aria-label="Direct link to includestagslibsonnet" title="Direct link to includestagslibsonnet">​</a></h3><p>This code module is used to generate re-usable tags for other resources (DRY).  </p><iframe width="100%" frameborder="0" id="gist-82e21743e845355ba0ef7240f1f7327a"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="includesvpclibsonnet"><code>includes/vpc.libsonnet</code><a href="#includesvpclibsonnet" class="hash-link" aria-label="Direct link to includesvpclibsonnet" title="Direct link to includesvpclibsonnet">​</a></h3><p>This code module defines a VPC resource to be created with CloudFormation.  </p><iframe width="100%" frameborder="0" id="gist-e79189bbc1cfb8b72bd860c6381f6130"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="includess3loggingbucketlibsonnet"><code>includes/s3loggingbucket.libsonnet</code><a href="#includess3loggingbucketlibsonnet" class="hash-link" aria-label="Direct link to includess3loggingbucketlibsonnet" title="Direct link to includess3loggingbucketlibsonnet">​</a></h3><p>This code module defines an S3 bucket resource to be created in the stack which will be used for logging for other buckets.  </p><iframe width="100%" frameborder="0" id="gist-187c97deca224617b064c4028ebbbee2"></iframe><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="includess3landingbucketlibsonnet"><code>includes/s3landingbucket.libsonnet</code><a href="#includess3landingbucketlibsonnet" class="hash-link" aria-label="Direct link to includess3landingbucketlibsonnet" title="Direct link to includess3landingbucketlibsonnet">​</a></h3><p>This code module defines an S3 landing bucket resource to be created in the stack.  </p><iframe width="100%" frameborder="0" id="gist-c0dc5d868809f98ef672aca738bb1e5e"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="testing">Testing<a href="#testing" class="hash-link" aria-label="Direct link to Testing" title="Direct link to Testing">​</a></h2><p>To test the pre-processing, you will need a Jsonnet binary/executable for your environment.  You can find Docker images which include this for you, or you could build it yourself.  </p><p>Once you have a compiled binary, you can run the following to generate a rendered CloudFormation template.  </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jsonnet template.jsonnet -o template.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can validate this template using the AWS CLI as shown here:  </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws cloudformation validate-template --template-body file://template.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="deployment">Deployment<a href="#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment">​</a></h2><p>In a previous article, <a href="https://cloudywithachanceofbigdata.com/aws-deployments-with-cloudformation-and-gitlab-ci" target="_blank" rel="noopener noreferrer">Simplified AWS Deployments with CloudFormation and GitLab CI</a>, I demonstrated an end-to-end deployment pipeline using GitLab CI.  Jsonnet pre-processing can be added to this pipeline as an initial ‘preprocess’ stage and job.  A snippet from the <code>.gitlab-ci.yml</code> file is included here:  </p><iframe width="100%" frameborder="0" id="gist-14c4c2fdccb27884c69c31f7b3a17a99"></iframe><p>Enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/aws">aws</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/awscloudformation">awscloudformation</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/jsonnet">jsonnet</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitlab">gitlab</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitlabci">gitlabci</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/infrastructureascode">infrastructureascode</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/iac">iac</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/cloudautomation">cloudautomation</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/img/blog/gitlabci-cloudformation-featured-image.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/aws-deployments-with-cloudformation-and-gitlab-ci">Simplified AWS Deployments with CloudFormation and GitLab CI</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-11-11T00:00:00.000Z" itemprop="datePublished">November 11, 2021</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Managing cloud deployments and IaC pipelines can be challenging.  I’ve put together a simple pattern for deploying stacks in AWS using CloudFormation templates using GitLab CI.  </p><p>This deployment framework enables you to target different environments based upon refs (branches or tags) for instance deploy to a dev environment for a push or merge into develop and deploy to prod on a push or merge into main, otherwise just lint/validate (e.g., for a push to a non-protected feature branch).  Templates are uploaded to a designated S3 bucket and staged for use in the pipeline and can be retained as an additional audit trail (in addition to the GitLab project history).  </p><p>Furthermore, you can review changes (by inspecting change set contents) before deploying, saving you from fat finger deployments 😊.  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="how-it-works">How it works<a href="#how-it-works" class="hash-link" aria-label="Direct link to How it works" title="Direct link to How it works">​</a></h2><p>The logic is described here:  </p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Flow</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">PlantUML</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p><a target="_blank" href="/assets/files/gitlabci-cloudformation-flow-27282ec6781a04b2c32d1ac1d5fa01a5.png"><img loading="lazy" alt="GitLab CI" src="/assets/images/gitlabci-cloudformation-flow-27282ec6781a04b2c32d1ac1d5fa01a5.png" width="449" height="774" class="img_ev3q"></a> </p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-plantuml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plantuml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@startuml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partition prepare {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (*) --&gt; === S1 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  === S1 === --&gt; &quot;Validate Template&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; === S2 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  === S1 === --&gt; &quot;Check Stack State&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; === S2 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partition publish {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; &quot;Publish Template to S3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partition plan {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; &quot;Stack Exists?&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; === S3 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  === S3 === --&gt; [Yes] &quot;Create Change Set&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  === S3 === --&gt; [No] === S4 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Create Change Set&quot; --&gt; === S4 ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partition deploy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; &quot;MANUAL: Review Changes&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --&gt; &quot;Deploy Change Set&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--&gt;(*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@enduml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div><p>The pipleline looks like this in GitLab:  </p><p><a target="_blank" href="/assets/files/gitlab-ci-0f1e6af130941985838f49a568c723d4.png"><img loading="lazy" alt="GitLab CI" src="/assets/images/gitlab-ci-0f1e6af130941985838f49a568c723d4.png" width="1264" height="859" class="img_ev3q"></a>  </p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h2><p>You will need to set up GitLab CI variables for <code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code> and optionally <code>AWS_DEFAULT_REGION</code>.  You can do this via <strong>Settings -&gt; CI/CD -&gt; Variables</strong> in your GitLab project.   As <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> are secrets, they should be configured as <code>protected</code> (as they are only required for protected branches) and <code>masked</code> so they are not printed in job logs.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="gitlab-ciyml-code"><code>.gitlab-ci.yml</code> code<a href="#gitlab-ciyml-code" class="hash-link" aria-label="Direct link to gitlab-ciyml-code" title="Direct link to gitlab-ciyml-code">​</a></h2><p>The GitLab CI code is shown here:  </p><iframe width="100%" frameborder="0" id="gist-d561e9f002048b4e4be4043cf185d1bd"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="reviewing-change-sets-plans-and-applying">Reviewing change sets (plans) and applying<a href="#reviewing-change-sets-plans-and-applying" class="hash-link" aria-label="Direct link to Reviewing change sets (plans) and applying" title="Direct link to Reviewing change sets (plans) and applying">​</a></h2><p>Once a pipeline is triggered for an existing stack it will run hands off until a change set (plan) is created.  You can inspect the plan by clicking on the Plan GitLab CI job where you would see output like this:  </p><p><a target="_blank" href="/assets/files/gitlab-ci-cloudformation-plan-fab980e936956a28a98a13ec4f20d48d.png"><img loading="lazy" alt="Change Set" src="/assets/images/gitlab-ci-cloudformation-plan-fab980e936956a28a98a13ec4f20d48d.png" width="1264" height="879" class="img_ev3q"></a>  </p><p>If you are OK with the changes proposed, you can simply hit the play button on the last stage of the pipeline (Deploy).  Voilà, stack deployed, enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitlab">gitlab</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitlabci">gitlabci</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/aws">aws</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/awscloudformation">awscloudformation</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/infrastructureascode">infrastructureascode</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/iac">iac</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/cloudautomation">cloudautomation</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://fullstackchronicles.io/img/fullstackchronicles-cover-image.png"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/masking-private-keys-in-ci-cd-pipelines-in-gitlab">Masking Private Keys in CI/CD Pipelines in GitLab</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-06-15T00:00:00.000Z" itemprop="datePublished">June 15, 2021</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://s.gravatar.com/avatar/f96573d092470c74be233e1dded5376f?s=80" alt="Jeffrey Aven"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jeffreyaven/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey Aven</span></a></div><small class="avatar__subtitle" itemprop="description">Technologist and Cloud Consultant</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Big fan of GitLab (and GitLab CI in particular). I had a recent requirement to push changes to a wiki repo associated with a GitLab project through a GitLab CI pipeline (using the SaaS version of GitLab) and ran into a conundrum…</p><p>Using the GitLab SaaS version - deploy tokens can’t have write api access, so the next best solution is to use deploy keys, adding your public key as a deploy key and granting this key write access to repositories is relatively straightforward.</p><p>This issue is when you attempt to create a masked GitLab CI variable using the private key from your keypair, you get this…</p><p><a target="_blank" href="/assets/files/masked-variable-a71bee3c260fb07842a2cf68e9f8b37e.png"><img loading="lazy" src="/assets/images/masked-variable-a71bee3c260fb07842a2cf68e9f8b37e.png" width="1920" height="1040" class="img_ev3q"></a></p><p>I was a bit astonished to see this to be honest… Looks like it has been raised as an issue several times over the last few years but never resolved (the root cause of which is something to do with newline characters or base64 encoding or the overall length of the string).</p><p>I came up with a solution! Not pretty but effective, masks the variable so that it cannot be printed in CI logs as shown here:</p><p><a target="_blank" href="/assets/files/ci-ssh-key-21fa947e5812357fc909715776d842dd.png"><img loading="lazy" src="data:image/png;base64,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" width="402" height="189" class="img_ev3q"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="setup">Setup<a href="#setup" class="hash-link" aria-label="Direct link to Setup" title="Direct link to Setup">​</a></h2><p>Add a masked and protected GitLab variable for each line in the private key, for example:</p><p><a target="_blank" href="/assets/files/masked-vars-ab75ab02f93f5937aaffe559407d3cff.png"><img loading="lazy" src="/assets/images/masked-vars-ab75ab02f93f5937aaffe559407d3cff.png" width="1920" height="1040" class="img_ev3q"></a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="the-code">The Code<a href="#the-code" class="hash-link" aria-label="Direct link to The Code" title="Direct link to The Code">​</a></h2><p>Add the following block to your <code>.gitlab-ci.yml</code> file:</p><iframe width="100%" frameborder="0" id="gist-b5260f14ecc0bf0d080c80297d0b475c"></iframe><p>now within Jobs in your pipeline you can simply do this to clone, push or pull from a remote GitLab repo:</p><iframe width="100%" frameborder="0" id="gist-c96e211544f7cb4ef3ca4e90dc8e36e3"></iframe><p>as mentioned not pretty, but effective and no other cleaner options as I could see…</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ci">ci</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitlab">gitlab</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gitlab-ci">gitlab-ci</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/private-keys">private-keys</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/secrets">secrets</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">StackQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.windrate.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">WindRate<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/stackql/fullstackchronicles.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.dc0e16b9.js"></script>
<script src="/assets/js/main.18332222.js"></script>
</body>
</html>