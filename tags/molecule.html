<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Cloudy with a chance of Big Data Blog Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Cloudy with a chance of Big Data Blog Feed Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4N6KSJ2G0P"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4N6KSJ2G0P",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Cloudy with a chance of Big Data" href="/opensearch.xml"><title data-react-helmet="true">One post tagged with &quot;molecule&quot; | Cloudy with a chance of Big Data</title><meta data-react-helmet="true" property="og:title" content="One post tagged with &quot;molecule&quot; | Cloudy with a chance of Big Data"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://cloudywithachanceofbigdata.com/tags/molecule"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cloudywithachanceofbigdata.com/tags/molecule"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.com/tags/molecule" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://cloudywithachanceofbigdata.com/tags/molecule" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.d8b73325.css">
<link rel="preload" href="/assets/js/runtime~main.e8bf8f37.js" as="script">
<link rel="preload" href="/assets/js/main.6b4a7196.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title">Cloudy with a chance of Big Data</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/tags">Topics</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tags">All Topics</a></li><li><a class="dropdown__link" href="/tags/gcp">Google Cloud Platform</a></li><li><a class="dropdown__link" href="/tags/aws">AWS</a></li><li><a class="dropdown__link" href="/tags/azure">Azure</a></li><li><a class="dropdown__link" href="/tags/ci-cd">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/archive">Archive</a><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent Posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/automating-snowflake-role-based-storage-integration-for-aws">Automating Snowflake Role Based Storage Integration for AWS</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/simplifying-large-cloudformation-templates-using-jsonnet">Simplifying Large CloudFormation Templates using Jsonnet</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/aws-deployments-with-cloudformation-and-gitlab-ci">Simplified AWS Deployments with CloudFormation and GitLab CI</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/from-wordpress-to-jamstack">From Wordpress to Jamstack</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/using-jsonnet-to-configure-multiple-environments">Using Jsonnet to Configure Multiple Environments</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/use-bigquery-to-trigger-cloud-run">Use BigQuery to trigger Cloud Run</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/azure-static-web-app-review">Azure Static Web App Review</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/introducing-the-metadata-hub-mdh">Introducing the Metadata Hub (MDH)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/masking-private-keys-in-ci-cd-pipelines-in-gitlab">Masking Private Keys in CI/CD Pipelines in GitLab</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/simple-tasker-configuration-driven-orchestration">Simple Tasker: Configuration driven orchestration</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;molecule&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/test-driven-infrastructure-and-test-automation-with-ansible-molecule-and-azure">Test Driven Infrastructure and Test Automation with Ansible, Molecule and Azure</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2019-01-31T00:00:00.000Z" itemprop="datePublished">January 31, 2019</time> Â· <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/datwiz" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="http://0.gravatar.com/avatar/f9af9c3fae755ac170c5798c53c5267d?s=80" alt="Chris Ottinger"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/datwiz" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Chris Ottinger</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Technologist</small></div></div></div></div></header><meta itemprop="image" content="https://cloudywithachanceofbigdata.com/images/molecule-ansible-azure.png"><div class="markdown" itemprop="articleBody"><p>A few years back, before the rise of the hyper-scalers, I had my first infracode &#x27;aha moment&#x27; with OpenStack. The second came with <a href="https://kitchen.ci/" target="_blank" rel="noopener noreferrer">Kitchen</a>.</p><p>I had already been using test driven development for application code and configuration automation for infrastructure but Kitchen brought the two together. Kitchen made it possible to write tests, spin up infrastructure, and then tear everything down again - the Red/Green/Refactor cycle for infrastructure. What made this even better was that it wasn&#x27;t a facsimile of a target environment, it was the same - same VM&#x27;s, same OS, same network.</p><p>Coming from a Chef background for configuration automation, Kitchen is a great fit to the Ruby ecosystem. Kitchen works with Ansible and Azure, but a Ruby environment and at least a smattering of Ruby coding skills are required.</p><p><a href="https://molecule.readthedocs.io/" target="_blank" rel="noopener noreferrer">Molecule</a> provides a similar red-green development cycle to Kitchen, but without the need to step outside of the familiar Python environment.</p><p>Out of the box, Molecule supports development of Ansible roles using either a Docker or Virtual Box infrastructure provider. Molecule also leverages the Ansible drivers for private and public cloud platforms.</p><p>Molecule can be configured to test an individual role or collections of roles in Ansible playbooks.</p><p>This tutorial demonstrates how to use Molecule with Azure to develop and test an individual Ansible role following the red/green/refactor infracode workflow, which can be generalised as:</p><ul><li><strong>Red</strong>-<!-- --> write a failing infrastructure test</li><li><strong>Green</strong> - write the Ansible tasks needed to pass the test</li><li>Refactor - repeat the process</li></ul><p>The steps required for this tutorial are as follows:</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="azure-setup">Azure setup<a aria-hidden="true" class="hash-link" href="#azure-setup" title="Direct link to heading">â€‹</a></h2><p>Ensure there is an existing Azure Resource Group that will be used for infracode development and testing. Within the resource group, ensure there is a single virtual network (vnet) with a single subnet. Ansible will use these for the default network setup.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="setup-a-working-environment">Setup a working environment<a aria-hidden="true" class="hash-link" href="#setup-a-working-environment" title="Direct link to heading">â€‹</a></h2><p>There are a number of options for setting up a Python environment for Ansible and Molecule, including Python virtualenv or a Docker container environment.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="create-a-docker-image-for-ansiblemoleculeazure">Create a Docker image for Ansible+Molecule+Azure<a aria-hidden="true" class="hash-link" href="#create-a-docker-image-for-ansiblemoleculeazure" title="Direct link to heading">â€‹</a></h2><p>This tutorial uses a Docker container environment. A <code>Dockerfile</code> for the image can be found in <code>./molecule-azure-image/Dockerfile</code>. The image sets up a sane Python3 environment with Ansible, Ansible<!-- -->[<!-- -->azure<!-- -->]<!-- -->, and Molecule <code>pip</code> modules installed.</p><iframe width="100%" frameborder="0" id="gist-4bd0c2ccae06dcaedffc2d91e594145f"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="create-a-docker-workspace">Create a Docker workspace<a aria-hidden="true" class="hash-link" href="#create-a-docker-workspace" title="Direct link to heading">â€‹</a></h2><p>Setup a working environment using the Docker image with Ansible, Molecule, and the <code>azure-cli</code> installed.</p><iframe width="100%" frameborder="0" id="gist-f80ef20a720914cfd4e02cf9783fec06"></iframe><p>This example assumes the following:</p><ul><li>a resource group already exists with access rights to create virtual machines; and</li><li>the resource group contains a single vnet with a single subnet</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="log-into-an-azure-subcription">Log into an Azure subcription<a aria-hidden="true" class="hash-link" href="#log-into-an-azure-subcription" title="Direct link to heading">â€‹</a></h2><p>Ansible supports a number of different methods for authenticating with Azure. This example uses the <code>azure-cli</code> to login interactively.</p><iframe width="100%" frameborder="0" id="gist-fd8987e7f724de5393a411c24c74978b"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="create-an-empty-ansible-role-with-molecule">Create an empty Ansible role with Molecule<a aria-hidden="true" class="hash-link" href="#create-an-empty-ansible-role-with-molecule" title="Direct link to heading">â€‹</a></h2><p>Molecule provides an <code>init</code> function with defaults for various providers. The molecule-azure-role-template creates an empty role with scaffolding for Azure.</p><iframe width="100%" frameborder="0" id="gist-f9b301d950a2254ab9af4806f2110544"></iframe><p>Check that the environment is working by running the following code:</p><iframe width="100%" frameborder="0" id="gist-d56c3cd1e25b51acc634e5adb8a0a256"></iframe><p>The output should look be similar toâ€¦</p><iframe width="100%" frameborder="0" id="gist-a3f8aed99a7c910588a5651d8cabf0e8"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="spin-up-an-azure-vm">Spin up an Azure VM<a aria-hidden="true" class="hash-link" href="#spin-up-an-azure-vm" title="Direct link to heading">â€‹</a></h2><p>Spin up a fresh VM to be used for infra-code development.</p><iframe width="100%" frameborder="0" id="gist-14a621ee65f9c2db583ed5ef94274c71"></iframe><p>Molecule provides a handy option for logging into the new VM:</p><iframe width="100%" frameborder="0" id="gist-456aa8a8860bf785b382e18ede204d33"></iframe><p>There is now a fresh Ubuntu 18.04 virtual machine ready for infra-code development. For this example, a basic Nginx server will be installed and verified.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="write-a-failing-test">Write a failing test<a aria-hidden="true" class="hash-link" href="#write-a-failing-test" title="Direct link to heading">â€‹</a></h2><p><a href="https://testinfra.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">Testinfra</a> provides a <code>pytest</code> based framework for verifying server and infrastructure configuration. Molecule then manages the execution of those <code>testinfra</code> tests. The Molecule template provides a starting point for crafting tests of your own. For this tutorial, installation of the <code>nginx</code> service is verified. Modify the tests file using <code>vi molecule/default/tests/test_default.py</code></p><iframe width="100%" frameborder="0" id="gist-5b22b20a192aecbecb8cc229cb5f2a69"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="execute-the-failing-test">Execute the failing test<a aria-hidden="true" class="hash-link" href="#execute-the-failing-test" title="Direct link to heading">â€‹</a></h2><p>The Ansible task needed to install and enable <code>nginx</code> has not yet been written, so the test should fail:</p><iframe width="100%" frameborder="0" id="gist-38eb4bb776a41db7aa68f5962a97af62"></iframe><p>If the initial sample tests in <code>test_default.py</code> are kept, then 3 tests should fail and 2 tests should pass.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="write-a-task-to-install-nginx">Write a task to install <code>nginx</code><a aria-hidden="true" class="hash-link" href="#write-a-task-to-install-nginx" title="Direct link to heading">â€‹</a></h2><p>Add a task to install the <code>nginx</code> service using <code>vi tasks/main.yml</code>:</p><iframe width="100%" frameborder="0" id="gist-40d884f0c3a39fc4b3e921d451d60358"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="apply-the-role">Apply the role<a aria-hidden="true" class="hash-link" href="#apply-the-role" title="Direct link to heading">â€‹</a></h2><p>Apply the role to the instance created using Molecule.</p><iframe width="100%" frameborder="0" id="gist-5787aee41e2e3e9373f656677567ae41"></iframe><p>The <code>nginx</code> package should now be installed, both enabled and started, and listening on port 80. Note that the <code>nginx</code> instance will not be accessible from the Internet due to the Azure network security rules. The <code>nginx</code> instance can be confirmed manually by logging into the instance and using <code>curl</code> to make a request to the <code>nginx</code> service.</p><iframe width="100%" frameborder="0" id="gist-fb02518e7129bf28e27822c42221f706"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="execute-the-passing-test">Execute the passing test<a aria-hidden="true" class="hash-link" href="#execute-the-passing-test" title="Direct link to heading">â€‹</a></h2><p>After applying the Ansible task to the instance, the <code>testinfra</code> tests should now pass.</p><iframe width="100%" frameborder="0" id="gist-b6359519ca6068615f8f1473636f90ea"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_3R7-" id="cleanup">Cleanup<a aria-hidden="true" class="hash-link" href="#cleanup" title="Direct link to heading">â€‹</a></h2><p>Now that the Ansible role works as defined in the test specification, the development environment can be cleaned up.</p><iframe width="100%" frameborder="0" id="gist-150971a02b3f4b2c65d551cb09a203d0"></iframe><p>Molecule removes the Azure resources created to develop and test the configuration role. Note that deletion may take a few minutes.</p><p>Finally, once you are done, exit the container environment. If the container was started with the <code>--rm</code> switch, the container will also be removed, leaving you with a clean workspace and newly minted Ansible role with automated test cases.</p><iframe width="100%" frameborder="0" id="gist-4fbb00b116b1a389b0343f6424b19a1b"></iframe></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/ansible">ansible</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure">azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cloud">cloud</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/infrastructure-code">infrastructure-code</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/molecule">molecule</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/python">python</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/test-automation">test-automation</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Test Driven Infrastructure and Test Automation with Ansible, Molecule and Azure" href="/test-driven-infrastructure-and-test-automation-with-ansible-molecule-and-azure"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">Tags</a></li></ul></div><div class="col footer__col"><div class="footer__title">Sponsors</div><ul class="footer__items"><li class="footer__item"><a href="https://infraql.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>InfraQL<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gammadata.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gamma Data<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/cloudywithachanceofbigdata/cloudywithachanceofbigdata.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"></div></div></footer></div>
<script src="/assets/js/runtime~main.e8bf8f37.js"></script>
<script src="/assets/js/main.6b4a7196.js"></script>
</body>
</html>